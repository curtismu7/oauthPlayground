/**
 * @file SMSFlowV8.tsx
 * @module v8/flows/types
 * @description SMS-specific MFA flow component (Refactored with Controller Pattern)
 * @version 8.2.0
 */

import React, { useCallback, useEffect, useMemo, useState } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { CountryCodePickerV8 } from '@/v8/components/CountryCodePickerV8';
import { MFAInfoButtonV8 } from '@/v8/components/MFAInfoButtonV8';
import { SuperSimpleApiDisplayV8 } from '@/v8/components/SuperSimpleApiDisplayV8';
import { apiDisplayServiceV8 } from '@/v8/services/apiDisplayServiceV8';
import { WorkerTokenStatusServiceV8 } from '@/v8/services/workerTokenStatusServiceV8';
import { toastV8 } from '@/v8/utils/toastNotificationsV8';
import { MFAFlowBaseV8, type MFAFlowBaseRenderProps } from '../shared/MFAFlowBaseV8';
import type { DeviceType, MFACredentials } from '../shared/MFATypes';
import { getFullPhoneNumber } from '../controllers/SMSFlowController';
import { MFAFlowControllerFactory } from '../factories/MFAFlowControllerFactory';
import { MFADeviceSelector, type Device } from '../components/MFADeviceSelector';
import { MFAOTPInput } from '../components/MFAOTPInput';
import { useStepNavigationV8 } from '@/v8/hooks/useStepNavigationV8';
import { FiShield, FiX, FiMail } from 'react-icons/fi';

const MODULE_TAG = '[üì± SMS-FLOW-V8]';

type DeviceSelectionState = {
	existingDevices: Record<string, unknown>[];
	loadingDevices: boolean;
	selectedExistingDevice: string;
	showRegisterForm: boolean;
};

type OTPState = {
	otpSent: boolean;
	sendError: string | null;
	sendRetryCount: number;
};

type ValidationState = {
	validationAttempts: number;
	lastValidationError: string | null;
};

interface DeviceSelectionStepProps extends MFAFlowBaseRenderProps {
	controller: ReturnType<typeof MFAFlowControllerFactory.create>;
	deviceSelection: DeviceSelectionState;
	setDeviceSelection: React.Dispatch<React.SetStateAction<DeviceSelectionState>>;
	updateOtpState: (update: Partial<OTPState> | ((prev: OTPState) => Partial<OTPState>)) => void;
}

const SMSDeviceSelectionStep: React.FC<DeviceSelectionStepProps & { isConfigured?: boolean }> = ({
	controller,
	deviceSelection,
	setDeviceSelection,
	updateOtpState,
	credentials,
	setCredentials,
	mfaState,
	setMfaState,
	nav,
	setIsLoading,
	tokenStatus,
	isConfigured = false,
}) => {
	const lastLookupRef = React.useRef<{ environmentId: string; username: string } | null>(null);

	const environmentId = credentials.environmentId?.trim();
	const username = credentials.username?.trim();

	React.useEffect(() => {
		// Skip device loading during registration flow (when coming from config page)
		if (isConfigured) {
			setDeviceSelection({
				existingDevices: [],
				loadingDevices: false,
				selectedExistingDevice: 'new',
				showRegisterForm: true,
			});
			// Skip to registration step immediately
			if (nav.currentStep === 1) {
				nav.goToStep(2);
			}
			return;
		}

		if (nav.currentStep !== 1) {
			return;
		}
		if (!environmentId || !username || !tokenStatus.isValid) {
			return;
		}

		const alreadyLoaded =
			lastLookupRef.current &&
			lastLookupRef.current.environmentId === environmentId &&
			lastLookupRef.current.username === username &&
			deviceSelection.existingDevices.length > 0;

		if (alreadyLoaded) {
			return;
		}

		let cancelled = false;
		setDeviceSelection((prev) => ({ ...prev, loadingDevices: true }));

		const fetchDevices = async () => {
			try {
				const devices = await controller.loadExistingDevices(credentials, tokenStatus);
				if (cancelled) {
					return;
				}
				lastLookupRef.current = { environmentId, username };
				setDeviceSelection({
					existingDevices: devices,
					loadingDevices: false,
					selectedExistingDevice: devices.length === 0 ? 'new' : '',
					showRegisterForm: devices.length === 0,
				});
			} catch (error) {
				if (cancelled) {
					return;
				}
				console.error(`${MODULE_TAG} Failed to load devices`, error);
				setDeviceSelection((prev) => ({
					...prev,
					loadingDevices: false,
					selectedExistingDevice: 'new',
					showRegisterForm: true,
				}));
			}
		};

		void fetchDevices();

		return () => {
			cancelled = true;
		};
	}, [
		controller,
		deviceSelection.existingDevices.length,
		environmentId,
		isConfigured,
		nav,
		setDeviceSelection,
		tokenStatus.isValid,
		username,
	]);

	const authenticateExistingDevice = async (deviceId: string) => {
		setIsLoading(true);
		try {
			const authResult = await controller.initializeDeviceAuthentication(credentials, deviceId);
			const nextStep = authResult.nextStep ?? authResult.status;

			setMfaState((prev) => ({
				...prev,
				deviceId,
				authenticationId: authResult.authenticationId,
				deviceAuthId: authResult.authenticationId,
				environmentId: credentials.environmentId,
				...(nextStep ? { nextStep } : {}),
			}));

			switch (nextStep) {
				case 'COMPLETED':
					nav.markStepComplete();
					nav.goToStep(4);
					toastV8.success('Authentication successful!');
					break;
				case 'OTP_REQUIRED':
					updateOtpState({ otpSent: true, sendRetryCount: 0, sendError: null });
					nav.markStepComplete();
					nav.goToStep(3);
					toastV8.success('OTP sent to your device. Proceed to validate the code.');
					break;
				case 'SELECTION_REQUIRED':
					nav.setValidationErrors([
						'Multiple devices require selection. Please choose the specific device to authenticate.',
					]);
					toastV8.warning('Please select a specific device');
					break;
				default:
					updateOtpState({ otpSent: nextStep === 'OTP_REQUIRED', sendRetryCount: 0, sendError: null });
					nav.markStepComplete();
					nav.goToStep(3);
					toastV8.success('Device selected for authentication. Follow the next step to continue.');
			}
		} catch (error) {
			const message = error instanceof Error ? error.message : 'Unknown error';
			console.error(`${MODULE_TAG} Failed to initialize authentication:`, error);
			nav.setValidationErrors([`Failed to authenticate: ${message}`]);
			toastV8.error(`Authentication failed: ${message}`);
			updateOtpState({ otpSent: false });
		} finally {
			setIsLoading(false);
		}
	};

	const handleSelectExistingDevice = (deviceId: string) => {
		setDeviceSelection((prev) => ({
			...prev,
			selectedExistingDevice: deviceId,
			showRegisterForm: false,
		}));
		updateOtpState({ otpSent: false, sendError: null });
		const device = deviceSelection.existingDevices.find((d) => d.id === deviceId);
		if (device) {
			setMfaState({
				...mfaState,
				deviceId,
				deviceStatus: (device.status as string) || 'ACTIVE',
				nickname: (device.nickname as string) || (device.name as string) || '',
			});
			void authenticateExistingDevice(deviceId);
		}
	};

	const handleSelectNewDevice = () => {
		setDeviceSelection((prev) => ({
			...prev,
			selectedExistingDevice: 'new',
			showRegisterForm: false,
		}));
		setMfaState({
			...mfaState,
			deviceId: '',
			deviceStatus: '',
		});
		setCredentials({
			...credentials,
			deviceName: credentials.deviceType || 'SMS',
		});
		nav.goToStep(2);
	};

	return (
		<div className="step-content">
			<h2>Select SMS Device</h2>
			<p>Choose an existing device or register a new one</p>

			<MFADeviceSelector
				devices={deviceSelection.existingDevices.map((d) => {
					const mappedDevice: Device = {
						id: String(d.id ?? ''),
						type: typeof d.type === 'string' ? (d.type as string) : 'SMS',
					};

					if (typeof d.nickname === 'string') {
						mappedDevice.nickname = d.nickname as string;
					}
					if (typeof d.name === 'string') {
						mappedDevice.name = d.name as string;
					}
					if (typeof d.phone === 'string') {
						mappedDevice.phone = d.phone as string;
					}
					if (typeof d.status === 'string') {
						mappedDevice.status = d.status as string;
					}

					return mappedDevice;
				})}
				loading={deviceSelection.loadingDevices}
				selectedDeviceId={deviceSelection.selectedExistingDevice}
				deviceType="SMS"
				onSelectDevice={handleSelectExistingDevice}
				onSelectNew={handleSelectNewDevice}
				renderDeviceInfo={(device) => (
					<>
						{device.phone && `Phone: ${device.phone}`}
						{device.status && ` ‚Ä¢ Status: ${device.status}`}
					</>
				)}
			/>

			{mfaState.deviceId && (
				<div className="success-box" style={{ marginTop: '10px' }}>
					<h3>‚úÖ Device Ready</h3>
					<p>
						<strong>Device ID:</strong> {mfaState.deviceId}
					</p>
					<p>
						<strong>Status:</strong> {mfaState.deviceStatus}
					</p>
				</div>
			)}
		</div>
	);
};

interface SMSConfigureStepProps extends MFAFlowBaseRenderProps {
	registrationFlowType?: 'admin' | 'user';
	setRegistrationFlowType?: (type: 'admin' | 'user') => void;
}

const SMSConfigureStep: React.FC<SMSConfigureStepProps> = (props) => {
	const { credentials, setCredentials, tokenStatus, registrationFlowType = 'user', setRegistrationFlowType } = props;
	const [isClearingToken, setIsClearingToken] = React.useState(false);

	const handleTokenButtonClick = async () => {
		if (!tokenStatus.isValid) {
			props.setShowWorkerTokenModal(true);
			return;
		}

		setIsClearingToken(true);
		try {
			const { workerTokenServiceV8 } = await import('@/v8/services/workerTokenServiceV8');
			await workerTokenServiceV8.clearToken();
			window.dispatchEvent(new Event('workerTokenUpdated'));
			WorkerTokenStatusServiceV8.checkWorkerTokenStatus();
			toastV8.success('Worker token removed');
		} catch (error) {
			console.error(`${MODULE_TAG} Failed to remove worker token`, error);
			toastV8.error('Failed to remove worker token. Please try again.');
		} finally {
			setIsClearingToken(false);
		}
	};

	return (
		<div className="step-content">
			<h2>
				Configure MFA Settings
				<MFAInfoButtonV8 contentKey="device.enrollment" displayMode="modal" />
			</h2>
			<p>Enter your PingOne environment details and user information</p>

			{/* Worker Token Status */}
			<div style={{ marginBottom: '10px' }}>
				<div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '6px' }}>
					<button
						type="button"
						onClick={handleTokenButtonClick}
						disabled={isClearingToken}
						className="token-button"
						style={{
							padding: '6px 12px',
							background: tokenStatus.isValid ? '#10b981' : '#ef4444',
							color: 'white',
							border: 'none',
							borderRadius: '4px',
							fontSize: '12px',
							fontWeight: '600',
							cursor: isClearingToken ? 'not-allowed' : 'pointer',
							display: 'flex',
							alignItems: 'center',
							gap: '6px',
							minWidth: '130px',
							justifyContent: 'center',
						}}
					>
						<span>{isClearingToken ? '‚è≥' : 'üîë'}</span>
						<span>{tokenStatus.isValid ? (isClearingToken ? 'Removing‚Ä¶' : 'Remove Token') : 'Add Token'}</span>
					</button>

					<button
						type="button"
						onClick={() => props.setShowSettingsModal(true)}
						className="token-button"
						style={{
							padding: '6px 12px',
							background:
								!tokenStatus.isValid || !credentials.environmentId ? '#e5e7eb' : '#6366f1',
							color: !tokenStatus.isValid || !credentials.environmentId ? '#9ca3af' : 'white',
							border: 'none',
							borderRadius: '4px',
							fontSize: '12px',
							fontWeight: '600',
							cursor:
								!tokenStatus.isValid || !credentials.environmentId ? 'not-allowed' : 'pointer',
							display: 'flex',
							alignItems: 'center',
							gap: '6px',
						}}
						disabled={!credentials.environmentId || !tokenStatus.isValid}
					>
						<span>‚öôÔ∏è</span>
						<span>MFA Settings</span>
					</button>

					<div
						style={{
							flex: 1,
							padding: '10px 12px',
							background: tokenStatus.isValid
								? tokenStatus.status === 'expiring-soon'
									? '#fef3c7'
									: '#d1fae5'
								: '#fee2e2',
							border: `1px solid ${WorkerTokenStatusServiceV8.getStatusColor(tokenStatus.status)}`,
							borderRadius: '4px',
							fontSize: '12px',
							fontWeight: '500',
							color: tokenStatus.isValid
								? tokenStatus.status === 'expiring-soon'
									? '#92400e'
									: '#065f46'
								: '#991b1b',
						}}
					>
						<span>{WorkerTokenStatusServiceV8.getStatusIcon(tokenStatus.status)}</span>
						<span style={{ marginLeft: '6px' }}>{tokenStatus.message}</span>
					</div>
				</div>

				{!tokenStatus.isValid && (
					<div className="info-box" style={{ marginBottom: '0' }}>
						<p>
							<strong>‚ö†Ô∏è Worker Token Required:</strong> This flow uses a worker token to look up
							users and manage MFA devices. Please click "Add Token" to configure your worker token
							credentials.
						</p>
					</div>
				)}
			</div>

			{/* Registration Flow Type Selection - Ask early so API request is correct */}
			<div style={{ marginBottom: '24px' }}>
				<label
					style={{
						display: 'block',
						fontSize: '14px',
						fontWeight: '600',
						color: '#374151',
						marginBottom: '12px',
					}}
				>
					Registration Flow Type <span style={{ color: '#ef4444' }}>*</span>
				</label>
				<div style={{ display: 'flex', gap: '12px' }}>
					<label
						style={{
							flex: 1,
							padding: '14px 16px',
							border: `2px solid ${registrationFlowType === 'admin' ? '#3b82f6' : '#d1d5db'}`,
							borderRadius: '8px',
							background: registrationFlowType === 'admin' ? '#eff6ff' : 'white',
							cursor: 'pointer',
							transition: 'all 0.2s ease',
						}}
						onClick={() => setRegistrationFlowType('admin')}
					>
						<div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '6px' }}>
							<input
								type="radio"
								name="registration-flow-type"
								value="admin"
								checked={registrationFlowType === 'admin'}
								onChange={() => setRegistrationFlowType('admin')}
								style={{ margin: 0, cursor: 'pointer', width: '16px', height: '16px' }}
							/>
							<span style={{ fontSize: '14px', fontWeight: '600', color: '#1f2937' }}>Admin Flow</span>
						</div>
						<div style={{ fontSize: '12px', color: '#6b7280', marginLeft: '24px', lineHeight: '1.4' }}>
							<strong>ACTIVE</strong> - Device created as ready to use, no activation needed
						</div>
					</label>
					<label
						style={{
							flex: 1,
							padding: '14px 16px',
							border: `2px solid ${registrationFlowType === 'user' ? '#3b82f6' : '#d1d5db'}`,
							borderRadius: '8px',
							background: registrationFlowType === 'user' ? '#eff6ff' : 'white',
							cursor: 'pointer',
							transition: 'all 0.2s ease',
						}}
						onClick={() => setRegistrationFlowType('user')}
					>
						<div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '6px' }}>
							<input
								type="radio"
								name="registration-flow-type"
								value="user"
								checked={registrationFlowType === 'user'}
								onChange={() => setRegistrationFlowType('user')}
								style={{ margin: 0, cursor: 'pointer', width: '16px', height: '16px' }}
							/>
							<span style={{ fontSize: '14px', fontWeight: '600', color: '#1f2937' }}>User Flow</span>
						</div>
						<div style={{ fontSize: '12px', color: '#6b7280', marginLeft: '24px', lineHeight: '1.4' }}>
							<strong>ACTIVATION_REQUIRED</strong> - OTP will be sent for device activation
						</div>
					</label>
				</div>
				<small style={{ display: 'block', marginTop: '8px', color: '#6b7280' }}>
					This determines the device status when registering. User Flow requires OTP activation.
				</small>
			</div>

			<div className="credentials-grid">
				<div className="form-group">
					<label htmlFor="mfa-env-id">
						Environment ID <span className="required">*</span>
					</label>
					<input
						id="mfa-env-id"
						type="text"
						value={credentials.environmentId}
						onChange={(e) => setCredentials({ ...credentials, environmentId: e.target.value })}
						placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
					/>
					<small>PingOne environment ID</small>
				</div>

				<div className="form-group">
					<label htmlFor="mfa-username">
						Username <span className="required">*</span>
					</label>
					<input
						id="mfa-username"
						type="text"
						value={credentials.username}
						onChange={(e) => setCredentials({ ...credentials, username: e.target.value })}
						placeholder="john.doe"
					/>
					<small>PingOne username to register MFA device for</small>
				</div>
			</div>
		</div>
	);
};

// Device selection state management wrapper
const SMSFlowV8WithDeviceSelection: React.FC = () => {
	const location = useLocation();
	const navigate = useNavigate();
	const isConfigured = (location.state as { configured?: boolean })?.configured === true;
	
	// Initialize controller using factory - will be updated dynamically based on selected device type
	const [controllerDeviceType, setControllerDeviceType] = useState<'SMS' | 'EMAIL'>('SMS');
	const controller = useMemo(() => 
		MFAFlowControllerFactory.create({ deviceType: controllerDeviceType }), 
		[controllerDeviceType]
	);

	// Device selection state
	const [deviceSelection, setDeviceSelection] = useState<DeviceSelectionState>({
		existingDevices: [],
		loadingDevices: false,
		selectedExistingDevice: '',
		showRegisterForm: false,
	});

	// OTP state
	const [otpState, setOtpState] = useState<OTPState>({
		otpSent: false,
		sendError: null,
		sendRetryCount: 0,
	});

	// Validation state
	const [validationState, setValidationState] = useState<ValidationState>({
		validationAttempts: 0,
		lastValidationError: null,
	});

	// Modal state for step 2 registration
	const [showModal, setShowModal] = useState(true);
	
	// Modal state for step 4 OTP validation
	const [showValidationModal, setShowValidationModal] = useState(true);
	
	// Device registration flow type: 'admin' (ACTIVE) or 'user' (ACTIVATION_REQUIRED)
	const [registrationFlowType, setRegistrationFlowType] = useState<'admin' | 'user'>('user');

	const updateOtpState = useCallback(
		(update: Partial<OTPState> | ((prev: OTPState) => Partial<OTPState>)) => {
			setOtpState((prev) => {
				const patch = typeof update === 'function' ? update(prev) : update;
				return { ...prev, ...patch };
			});
		},
		[]
	);

	const updateValidationState = useCallback(
		(update: Partial<ValidationState> | ((prev: ValidationState) => Partial<ValidationState>)) => {
			setValidationState((prev) => {
				const patch = typeof update === 'function' ? update(prev) : update;
				return { ...prev, ...patch };
			});
		},
		[]
	);

	// Track if we've updated credentials from location.state
	const credentialsUpdatedRef = React.useRef(false);
	
	// Step 0: Configure Credentials - skip if coming from config page
	const renderStep0 = useMemo(() => {
		return (props: MFAFlowBaseRenderProps) => {
			const { nav, credentials, setCredentials } = props;
			const locationState = location.state as { 
				configured?: boolean; 
				deviceAuthenticationPolicyId?: string;
				policyName?: string;
			} | null;
			
			// Update credentials with policy ID from location.state if available (only once)
			if (!credentialsUpdatedRef.current && locationState?.deviceAuthenticationPolicyId && 
				credentials.deviceAuthenticationPolicyId !== locationState.deviceAuthenticationPolicyId) {
				console.log(`${MODULE_TAG} Updating credentials with policy ID from config page:`, locationState.deviceAuthenticationPolicyId);
				setCredentials({
					...credentials,
					deviceAuthenticationPolicyId: locationState.deviceAuthenticationPolicyId,
				});
				credentialsUpdatedRef.current = true;
			}
			
			// If coming from config page, skip step 0 and go to step 1
			if (isConfigured && nav.currentStep === 0) {
				setTimeout(() => {
					console.log(`${MODULE_TAG} Skipping step 0, coming from config page`);
					nav.goToStep(1);
				}, 0);
				return null;
			}
			
			return <SMSConfigureStep {...props} registrationFlowType={registrationFlowType} setRegistrationFlowType={setRegistrationFlowType} />;
		};
	}, [isConfigured, location, registrationFlowType]);

	// Step 1: Device Selection/Registration (using controller)
	const renderStep1WithSelection = (props: MFAFlowBaseRenderProps) => (
		<SMSDeviceSelectionStep
			controller={controller}
			deviceSelection={deviceSelection}
			setDeviceSelection={setDeviceSelection}
			updateOtpState={updateOtpState}
			isConfigured={isConfigured}
			{...props}
		/>
	);

	// Ping Identity Logo Component
	const PingIdentityLogo: React.FC<{ size?: number }> = ({ size = 40 }) => (
		<div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
			<div
				style={{
					display: 'inline-flex',
					alignItems: 'center',
					justifyContent: 'center',
					width: size,
					height: size,
					borderRadius: '8px',
					background: '#E31837',
					boxShadow: '0 2px 8px rgba(0,0,0,0.15)',
					marginRight: '12px',
				}}
			>
				<svg
					width={Math.round(size * 0.75)}
					height={Math.round(size * 0.75)}
					viewBox="0 0 24 24"
					fill="none"
					xmlns="http://www.w3.org/2000/svg"
					aria-hidden="true"
				>
					<path d="M12 2l7 3v5c0 5.25-3.5 9.75-7 11-3.5-1.25-7-5.75-7-11V5l7-3z" fill="#ffffff" />
					<path d="M12 5l4 1.7V10.5c0 3.2-2.1 6.1-4 7-1.9-.9-4-3.8-4-7V6.7L12 5z" fill="#E31837" />
				</svg>
			</div>
			<div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-start' }}>
				<span style={{ fontSize: '20px', fontWeight: '700', color: '#E31837', lineHeight: '1.2' }}>Ping</span>
				<span style={{ fontSize: '12px', fontWeight: '400', color: '#6b7280', lineHeight: '1.2' }}>Identity.</span>
			</div>
		</div>
	);

	// Step 2: Register Device (using controller) - Now as a Modal
	const renderStep2Register = (props: MFAFlowBaseRenderProps) => {
		const { credentials, setCredentials, mfaState, setMfaState, nav, setIsLoading, isLoading, setShowDeviceLimitModal, tokenStatus, setShowWorkerTokenModal } = props;

		// Ensure deviceType is set correctly - default to SMS for SMS flow, but allow EMAIL if selected
		// This ensures the button text and validation match what the user selected
		const currentDeviceType = (credentials.deviceType === 'SMS' || credentials.deviceType === 'EMAIL') 
			? credentials.deviceType 
			: 'SMS';

		// Handle device registration
		const handleRegisterDevice = async () => {
			// Get the actual device type from credentials (most up-to-date value)
			// This ensures we validate based on what's actually selected in the dropdown
			const actualDeviceType = (credentials.deviceType === 'SMS' || credentials.deviceType === 'EMAIL') 
				? credentials.deviceType 
				: 'SMS';
			
			// Validate based on device type (use actualDeviceType to match what user selected)
			if (actualDeviceType === 'SMS') {
				if (!credentials.phoneNumber?.trim()) {
					nav.setValidationErrors(['Phone number is required. Please enter a valid phone number.']);
					return;
				}
				const cleanedPhone = credentials.phoneNumber.replace(/[^\d]/g, '');
				if (credentials.countryCode === '+1') {
					if (cleanedPhone.length !== 10) {
						nav.setValidationErrors([
							`US/Canada phone numbers must be exactly 10 digits (you have ${cleanedPhone.length})`
						]);
						return;
					}
				} else {
					if (cleanedPhone.length < 6) {
						nav.setValidationErrors(['Phone number is too short (minimum 6 digits)']);
						return;
					} else if (cleanedPhone.length > 15) {
						nav.setValidationErrors(['Phone number is too long (maximum 15 digits)']);
						return;
					}
				}
			} else if (actualDeviceType === 'EMAIL') {
				if (!credentials.email?.trim()) {
					nav.setValidationErrors(['Email address is required. Please enter a valid email address.']);
					return;
				}
				if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(credentials.email)) {
					nav.setValidationErrors(['Please enter a valid email address format.']);
					return;
				}
			}
			// Use the device name exactly as entered by the user
			const userEnteredDeviceName = credentials.deviceName?.trim();
			if (!userEnteredDeviceName) {
				nav.setValidationErrors(['Device name is required. Please enter a name for this device.']);
				return;
			}

			setIsLoading(true);
			try {
				// Update controller device type if it changed
				if (controllerDeviceType !== actualDeviceType) {
					setControllerDeviceType(actualDeviceType);
				}
				
				// Get the correct controller for the device type
				const correctController = MFAFlowControllerFactory.create({ deviceType: actualDeviceType });
				
				// Use the device name exactly as entered by the user, and ensure deviceType is correct
				const registrationCredentials = {
					...credentials,
					deviceName: userEnteredDeviceName,
					deviceType: actualDeviceType, // Ensure deviceType matches what user selected
				};
				// Determine device status based on selected flow type
				const deviceStatus: 'ACTIVE' | 'ACTIVATION_REQUIRED' = registrationFlowType === 'admin' ? 'ACTIVE' : 'ACTIVATION_REQUIRED';
				
				const result = await correctController.registerDevice(
					registrationCredentials, 
					correctController.getDeviceRegistrationParams(registrationCredentials, deviceStatus)
				);
				
				// Use the actual status returned from the API, not the requested status
				const actualDeviceStatus = result.status || deviceStatus;
				
				console.log(`${MODULE_TAG} Device registration result:`, {
					requestedStatus: deviceStatus,
					actualStatus: result.status,
					usingStatus: actualDeviceStatus,
					registrationFlowType,
					deviceId: result.deviceId,
				});
				
				setMfaState({
					...mfaState,
					deviceId: result.deviceId,
					deviceStatus: actualDeviceStatus,
				});

				// Refresh device list
				const devices = await correctController.loadExistingDevices(registrationCredentials, tokenStatus);
				setDeviceSelection((prev) => ({
					...prev,
					existingDevices: devices,
				}));

				// Only send OTP automatically if device status is ACTIVATION_REQUIRED (User flow)
				// Check the actual status returned from the API
				if (actualDeviceStatus === 'ACTIVATION_REQUIRED') {
					console.log(`${MODULE_TAG} Device registered with ACTIVATION_REQUIRED status, automatically sending OTP...`);
					try {
						await correctController.sendOTP(
							registrationCredentials,
							result.deviceId,
							otpState,
							updateOtpState,
							nav,
							setIsLoading
						);
						// OTP sent successfully, navigate to Send OTP step (Step 3) so user can see status and resend if needed
						nav.markStepComplete();
						nav.goToStep(3); // Go to Send OTP step (Step 3) instead of skipping to validation
						toastV8.success(`${actualDeviceType === 'EMAIL' ? 'Email' : 'SMS'} device registered and OTP sent successfully!`);
					} catch (otpError) {
						// Device registered but OTP send failed - still navigate to Send OTP step
						console.error(`${MODULE_TAG} Device registered but OTP send failed:`, otpError);
						nav.markStepComplete();
						nav.goToStep(3); // Go to Send OTP step (Step 3) so user can retry
						toastV8.success(`${actualDeviceType === 'EMAIL' ? 'Email' : 'SMS'} device registered successfully!`);
						toastV8.warning('OTP could not be sent automatically. Please send it manually on the next step.');
					}
				} else if (actualDeviceStatus === 'ACTIVE') {
					// Admin flow: Device is ACTIVE, no OTP needed - skip OTP steps entirely
					console.log(`${MODULE_TAG} Device registered with ACTIVE status, skipping OTP steps and going back to device selection...`);
					nav.markStepComplete();
					// Skip steps 3 (Send OTP) and 4 (Validate OTP) - go directly back to device selection
					// Close the registration modal and return to step 1
					setShowModal(false);
					nav.goToStep(1);
					toastV8.success(`${actualDeviceType === 'EMAIL' ? 'Email' : 'SMS'} device registered successfully! Device is ready to use (ACTIVE status).`);
				} else {
					// Unknown status - default behavior
					console.warn(`${MODULE_TAG} Device registered with unknown status: ${actualDeviceStatus}, defaulting to OTP flow`);
					nav.markStepComplete();
					nav.goToStep(3);
					toastV8.success(`${actualDeviceType === 'EMAIL' ? 'Email' : 'SMS'} device registered successfully!`);
				}
			} catch (error) {
				const errorMessage = error instanceof Error ? error.message : 'Unknown error';
				const isDeviceLimitError =
					errorMessage.toLowerCase().includes('exceed') ||
					errorMessage.toLowerCase().includes('limit') ||
					errorMessage.toLowerCase().includes('maximum');
				
				const isWorkerTokenError =
					errorMessage.includes('Worker token') ||
					errorMessage.includes('worker token') ||
					errorMessage.includes('token is not available') ||
					errorMessage.includes('token has expired');

				if (isDeviceLimitError) {
					setShowDeviceLimitModal(true);
					nav.setValidationErrors([`Device registration failed: ${errorMessage}`]);
					toastV8.error('Device limit exceeded. Please delete an existing device first.');
				} else if (isWorkerTokenError) {
					// Show worker token modal for token errors
					setShowWorkerTokenModal(true);
					nav.setValidationErrors([`Registration failed: ${errorMessage}`]);
					toastV8.error(`Registration failed: ${errorMessage}`);
				} else {
					nav.setValidationErrors([`Failed to register device: ${errorMessage}`]);
					toastV8.error(`Registration failed: ${errorMessage}`);
				}
			} finally {
				setIsLoading(false);
			}
		};

		// Use the currentDeviceType already declared above (line 590)
		const isSMS = currentDeviceType === 'SMS';
		const isEMAIL = currentDeviceType === 'EMAIL';
		const isValidPhone = credentials.phoneNumber?.trim() && 
			(credentials.countryCode === '+1' 
				? credentials.phoneNumber.replace(/[^\d]/g, '').length === 10
				: credentials.phoneNumber.replace(/[^\d]/g, '').length >= 6 && credentials.phoneNumber.replace(/[^\d]/g, '').length <= 15);
		const isValidEmail = credentials.email?.trim() && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(credentials.email);
		const isValidForm = credentials.deviceName?.trim() && ((isSMS && isValidPhone) || (isEMAIL && isValidEmail));

		if (!showModal) {
			return null;
		}

		return (
			<div
				style={{
					position: 'fixed',
					top: 0,
					left: 0,
					right: 0,
					bottom: 0,
					background: 'rgba(0, 0, 0, 0.5)',
					display: 'flex',
					alignItems: 'center',
					justifyContent: 'center',
					zIndex: 1000,
				}}
				onClick={() => {
					// Don't close on backdrop click - require explicit cancel
				}}
			>
				<div
					style={{
						background: 'white',
						borderRadius: '16px',
						padding: '0',
						maxWidth: '550px',
						width: '90%',
						boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
						overflow: 'hidden',
					}}
					onClick={(e) => e.stopPropagation()}
				>
					{/* Header with Logo */}
					<div
						style={{
							background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
							padding: '20px 24px 16px 24px',
							textAlign: 'center',
							position: 'relative',
						}}
					>
						<button
							type="button"
							onClick={() => {
								setShowModal(false);
								nav.goToPrevious();
							}}
							style={{
								position: 'absolute',
								top: '16px',
								right: '16px',
								background: 'rgba(255, 255, 255, 0.2)',
								border: 'none',
								borderRadius: '50%',
								width: '32px',
								height: '32px',
								display: 'flex',
								alignItems: 'center',
								justifyContent: 'center',
								cursor: 'pointer',
								color: 'white',
							}}
						>
							<FiX size={18} />
						</button>
						<PingIdentityLogo size={36} />
						<h3
							style={{
								margin: '6px 0 0 0',
								fontSize: '18px',
								fontWeight: '600',
								color: 'white',
								textAlign: 'center',
							}}
						>
							Register MFA Device
						</h3>
						<p
							style={{
								margin: '4px 0 0 0',
								fontSize: '12px',
								color: 'rgba(255, 255, 255, 0.9)',
								textAlign: 'center',
							}}
						>
							Add a new device for multi-factor authentication
						</p>
					</div>

					{/* Modal Body */}
					<div style={{ padding: '24px' }}>
						{/* Username Display */}
						<div
							style={{
								marginBottom: '16px',
								padding: '10px 12px',
								background: '#f3f4f6',
								borderRadius: '6px',
								border: '1px solid #e5e7eb',
							}}
						>
							<div style={{ fontSize: '11px', color: '#6b7280', marginBottom: '2px' }}>Username</div>
							<div style={{ fontSize: '14px', fontWeight: '600', color: '#1f2937' }}>{credentials.username}</div>
						</div>

						{/* Device Type Selector */}
						<div style={{ marginBottom: '16px' }}>
							<label
								htmlFor="mfa-device-type-register"
								style={{
									display: 'block',
									fontSize: '13px',
									fontWeight: '600',
									color: '#374151',
									marginBottom: '6px',
								}}
							>
								Device Type <span style={{ color: '#ef4444' }}>*</span>
							</label>
							<select
								id="mfa-device-type-register"
								value={credentials.deviceType || 'SMS'}
								onChange={(e) => {
									const newDeviceType = e.target.value as DeviceType;
									const oldDeviceType = credentials.deviceType || 'SMS';
									
									// Update device name if:
									// 1. It's empty
									// 2. It matches the old device type (e.g., "SMS" when switching from SMS)
									// 3. It's exactly "SMS" or "EMAIL" (generic device type names)
									const currentDeviceName = credentials.deviceName?.trim() || '';
									const shouldUpdateDeviceName = 
										!currentDeviceName || 
										currentDeviceName === oldDeviceType ||
										currentDeviceName === 'SMS' ||
										currentDeviceName === 'EMAIL';
									
									// Determine the new device name
									const newDeviceName = shouldUpdateDeviceName ? newDeviceType : credentials.deviceName;
									
									// Update credentials with new device type and clear appropriate fields
									setCredentials({
										...credentials,
										deviceType: newDeviceType,
										deviceName: newDeviceName,
										// Clear phone/email when switching types to avoid validation errors
										phoneNumber: newDeviceType === 'SMS' ? credentials.phoneNumber : '',
										email: newDeviceType === 'EMAIL' ? credentials.email : '',
									});
									// Update controller device type when user changes selection
									if (newDeviceType === 'SMS' || newDeviceType === 'EMAIL') {
										setControllerDeviceType(newDeviceType);
									}
								}}
								style={{
									padding: '12px 16px',
									border: '1px solid #d1d5db',
									borderRadius: '8px',
									fontSize: '15px',
									color: '#1f2937',
									background: 'white',
									width: '100%',
									cursor: 'pointer',
								}}
							>
								<option value="SMS">üì± SMS (Text Message)</option>
								<option value="EMAIL">üìß Email</option>
							</select>
							<small style={{ display: 'block', marginTop: '4px', fontSize: '11px', color: '#6b7280' }}>
								Select the type of MFA device you want to register
							</small>
						</div>

						{/* Phone Number Field (for SMS) */}
						{isSMS && (
							<div style={{ marginBottom: '16px' }}>
								<label
									htmlFor="mfa-phone-register"
									style={{
										display: 'block',
										fontSize: '14px',
										fontWeight: '600',
										color: '#374151',
										marginBottom: '8px',
									}}
								>
									Phone Number <span style={{ color: '#ef4444' }}>*</span>
								</label>
								<div style={{ display: 'flex', gap: '0' }}>
									<CountryCodePickerV8
										value={credentials.countryCode}
										onChange={(code) => setCredentials({ ...credentials, countryCode: code })}
									/>
									<input
										id="mfa-phone-register"
										type="tel"
										value={credentials.phoneNumber || ''}
										onChange={(e) => {
											const cleaned = e.target.value.replace(/[^\d\s-]/g, '');
											setCredentials({ ...credentials, phoneNumber: cleaned });
										}}
										placeholder={credentials.countryCode === '+1' ? '5125201234' : '234567890'}
										style={{
											flex: 1,
											padding: '12px 16px',
											border: `1px solid ${
												credentials.phoneNumber
													? isValidPhone
														? '#10b981'
														: '#ef4444'
													: '#ef4444'
											}`,
											boxShadow:
												credentials.phoneNumber && isValidPhone
													? 'none'
													: '0 0 0 3px rgba(239, 68, 68, 0.25)',
											outline: 'none',
											borderRadius: '0 8px 8px 0',
											fontSize: '15px',
											fontFamily: 'monospace',
											color: '#1f2937',
											background: 'white',
										}}
									/>
								</div>
								<small style={{ display: 'block', marginTop: '6px', fontSize: '12px', color: '#6b7280' }}>
									{credentials.countryCode === '+1' 
										? 'US/Canada: Enter 10-digit number (area code + number)'
										: 'International: Enter phone number with country code'}
								</small>
								{credentials.phoneNumber && (
									<div
										style={{
											marginTop: '8px',
											padding: '8px 10px',
											background: '#fef3c7',
											border: '1px solid #fbbf24',
											borderRadius: '6px',
										}}
									>
										<div style={{ fontSize: '11px', fontWeight: '600', color: '#92400e', marginBottom: '2px' }}>
											üìã Phone Number Preview:
										</div>
										<div style={{ fontSize: '12px', fontFamily: 'monospace', color: '#1f2937' }}>
											<strong>Will send to:</strong> {getFullPhoneNumber(credentials)}
										</div>
									</div>
								)}
							</div>
						)}

						{/* Email Field (for EMAIL) */}
						{isEMAIL && (
							<div style={{ marginBottom: '24px' }}>
								<label
									htmlFor="mfa-email-register"
									style={{
										display: 'block',
										fontSize: '14px',
										fontWeight: '600',
										color: '#374151',
										marginBottom: '8px',
									}}
								>
									Email Address <span style={{ color: '#ef4444' }}>*</span>
								</label>
								<div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
									<FiMail size={20} style={{ color: '#6b7280' }} />
									<input
										id="mfa-email-register"
										type="email"
										value={credentials.email || ''}
										onChange={(e) => {
											setCredentials({ ...credentials, email: e.target.value });
										}}
										placeholder="user@example.com"
										style={{
											flex: 1,
											padding: '12px 16px',
											border: `1px solid ${
												credentials.email?.trim()
													? (isValidEmail ? '#10b981' : '#ef4444')
													: '#d1d5db'
											}`,
											boxShadow:
												credentials.email?.trim() && isValidEmail
													? 'none'
													: '0 0 0 3px rgba(239, 68, 68, 0.25)',
											outline: 'none',
											borderRadius: '8px',
											fontSize: '15px',
											color: '#1f2937',
											background: 'white',
										}}
									/>
								</div>
								<small style={{ display: 'block', marginTop: '4px', fontSize: '11px', color: '#6b7280' }}>
									Enter the email address where you'll receive verification codes
								</small>
								{credentials.email && isValidEmail && (
									<div
										style={{
											marginTop: '8px',
											padding: '8px 10px',
											background: '#fef3c7',
											border: '1px solid #fbbf24',
											borderRadius: '6px',
										}}
									>
										<div style={{ fontSize: '11px', fontWeight: '600', color: '#92400e', marginBottom: '2px' }}>
											üìß Email Preview:
										</div>
										<div style={{ fontSize: '12px', fontFamily: 'monospace', color: '#1f2937' }}>
											<strong>Will send to:</strong> {credentials.email}
										</div>
									</div>
								)}
							</div>
						)}

						{/* Device Name Field */}
						<div style={{ marginBottom: '16px' }}>
							<label
								htmlFor="mfa-device-name-register"
								style={{
									display: 'block',
									fontSize: '13px',
									fontWeight: '600',
									color: '#374151',
									marginBottom: '6px',
								}}
							>
								Device Name <span style={{ color: '#ef4444' }}>*</span>
							</label>
							<input
								id="mfa-device-name-register"
								type="text"
								value={credentials.deviceName || ''}
								onChange={(e) => {
									setCredentials({ ...credentials, deviceName: e.target.value });
								}}
								onFocus={(e) => {
									const currentName = credentials.deviceName?.trim() || '';
									if (!currentName || currentName === currentDeviceType || currentName === 'SMS' || currentName === 'EMAIL') {
										e.target.select();
									}
									if (!credentials.deviceName) {
										e.target.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.25)';
									}
								}}
								onBlur={(e) => {
									if (!credentials.deviceName) {
										e.target.style.boxShadow = 'none';
									}
								}}
								placeholder={currentDeviceType || 'Device Name'}
								style={{
									padding: '12px 16px',
									border: `1px solid ${
										credentials.deviceName?.trim() ? '#10b981' : '#ef4444'
									}`,
									boxShadow:
										credentials.deviceName?.trim()
											? 'none'
											: '0 0 0 3px rgba(239, 68, 68, 0.25)',
									outline: 'none',
									borderRadius: '8px',
									fontSize: '15px',
									color: '#1f2937',
									background: 'white',
									width: '100%',
								}}
							/>
							<small style={{ display: 'block', marginTop: '4px', fontSize: '11px', color: '#6b7280' }}>
								Enter a friendly name to identify this device (e.g., "My Work Phone", "Personal Email")
							</small>
						</div>

						{/* Worker Token Status */}
						<div style={{ marginBottom: '16px', padding: '10px 12px', background: tokenStatus.isValid ? '#d1fae5' : '#fee2e2', border: `1px solid ${tokenStatus.isValid ? '#10b981' : '#ef4444'}`, borderRadius: '6px' }}>
							<div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '12px' }}>
								<div style={{ display: 'flex', alignItems: 'center', gap: '8px', flex: 1 }}>
									<span style={{ fontSize: '16px' }}>{tokenStatus.isValid ? '‚úÖ' : '‚ö†Ô∏è'}</span>
									<span style={{ fontSize: '14px', color: tokenStatus.isValid ? '#065f46' : '#991b1b', fontWeight: '500' }}>
										{tokenStatus.isValid ? tokenStatus.message || 'Worker token valid' : tokenStatus.message || 'Worker token required'}
									</span>
								</div>
								<button
									type="button"
									onClick={() => {
										setShowWorkerTokenModal(true);
									}}
									style={{
										padding: '8px 16px',
										background: tokenStatus.isValid ? '#10b981' : '#ef4444',
										color: 'white',
										border: 'none',
										borderRadius: '6px',
										fontSize: '13px',
										fontWeight: '600',
										cursor: 'pointer',
										display: 'flex',
										alignItems: 'center',
										gap: '6px',
									}}
								>
									<span>üîë</span>
									<span>{tokenStatus.isValid ? 'Manage Token' : 'Get Token'}</span>
								</button>
							</div>
						</div>

						{/* Action Buttons */}
						<div style={{ display: 'flex', gap: '12px', marginTop: '20px' }}>
							<button
								type="button"
								onClick={() => {
									setShowModal(false);
									nav.goToPrevious();
								}}
								style={{
									flex: 1,
									padding: '14px 24px',
									background: '#f3f4f6',
									color: '#374151',
									border: '1px solid #d1d5db',
									borderRadius: '8px',
									fontSize: '15px',
									fontWeight: '600',
									cursor: 'pointer',
								}}
							>
								Cancel
							</button>
							<button
								type="button"
								disabled={isLoading || !isValidForm || !tokenStatus.isValid}
								onClick={handleRegisterDevice}
								style={{
									flex: 2,
									padding: '14px 24px',
									background: isValidForm && !isLoading && tokenStatus.isValid ? '#10b981' : '#d1d5db',
									color: 'white',
									border: 'none',
									borderRadius: '8px',
									fontSize: '15px',
									fontWeight: '600',
									cursor: isValidForm && !isLoading && tokenStatus.isValid ? 'pointer' : 'not-allowed',
									boxShadow: isValidForm && !isLoading && tokenStatus.isValid ? '0 4px 12px rgba(16, 185, 129, 0.3)' : 'none',
									transition: 'all 0.2s ease',
								}}
								onMouseEnter={(e) => {
									if (isValidForm && !isLoading && tokenStatus.isValid) {
										e.currentTarget.style.background = '#059669';
										e.currentTarget.style.boxShadow = '0 6px 16px rgba(5, 150, 105, 0.4)';
									}
								}}
								onMouseLeave={(e) => {
									if (isValidForm && !isLoading && tokenStatus.isValid) {
										e.currentTarget.style.background = '#10b981';
										e.currentTarget.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.3)';
									}
								}}
							>
							{isLoading ? (
								<>üîÑ Registering...</>
							) : (
								<>Register {currentDeviceType === 'SMS' ? 'SMS' : 'Email'} Device ‚Üí</>
							)}
							</button>
						</div>
					</div>
				</div>
			</div>
		);
	};

	// Step 3: Send OTP (using controller)
	const createRenderStep3 = () => {
		return (props: MFAFlowBaseRenderProps) => {
			const { credentials, mfaState, nav, setIsLoading, isLoading } = props;
			// navigate is available from component level (line 451)

			const handleSendOTP = async () => {
				await controller.sendOTP(
					credentials,
					mfaState.deviceId,
					otpState,
					updateOtpState,
					nav,
					setIsLoading
				);
			};

			const handleViewDeviceAuthentication = () => {
				if (!mfaState.authenticationId) {
					return;
				}

				const params = new URLSearchParams({
					environmentId: credentials.environmentId?.trim() || '',
					authenticationId: mfaState.authenticationId,
				});

				if (credentials.deviceAuthenticationPolicyId?.trim()) {
					params.set('policyId', credentials.deviceAuthenticationPolicyId.trim());
				}

				if (credentials.username?.trim()) {
					params.set('username', credentials.username.trim());
				}

				if (mfaState.deviceId) {
					params.set('deviceId', mfaState.deviceId);
				}

				navigate(`/v8/mfa/device-authentication-details?${params.toString()}`, {
					state: { autoFetch: true },
				});
			};

			return (
				<div className="step-content">
					<h2>
						Send OTP Code
						<MFAInfoButtonV8 contentKey="factor.sms" displayMode="modal" />
					</h2>
					<p>Send a one-time password to the registered device</p>

					<div className="info-box">
						<p>
							<strong>Device ID:</strong> {mfaState.deviceId}
						</p>
						<p>
							<strong>Phone Number:</strong> {getFullPhoneNumber(credentials)}
						</p>
						{otpState.sendRetryCount > 0 && (
							<p style={{ marginTop: '8px', fontSize: '13px', color: '#92400e' }}>
								‚ö†Ô∏è Attempt {otpState.sendRetryCount + 1} - If you continue to have issues, check your phone number and try again.
							</p>
						)}
					</div>

					{mfaState.authenticationId && (
						<div
							style={{
								marginTop: '16px',
								padding: '14px 16px',
								background: '#f0f9ff',
								border: '1px solid #bae6fd',
								borderRadius: '10px',
								display: 'flex',
								flexDirection: 'column',
								gap: '8px',
							}}
						>
							<div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '8px' }}>
								<div>
									<p style={{ margin: 0, fontSize: '14px', color: '#0c4a6e', fontWeight: 600 }}>Device Authentication ID</p>
									<p style={{ margin: '2px 0 0', fontFamily: 'monospace', color: '#1f2937' }}>{mfaState.authenticationId}</p>
								</div>
								<button
									type="button"
									onClick={handleViewDeviceAuthentication}
									style={{
										display: 'inline-flex',
										alignItems: 'center',
										gap: '6px',
										padding: '8px 12px',
										borderRadius: '8px',
										border: '1px solid #3b82f6',
										background: '#ffffff',
										color: '#1d4ed8',
										fontWeight: 600,
										cursor: 'pointer',
									}}
								>
									<FiShield />
									View Session Details
								</button>
							</div>
							<p style={{ margin: 0, fontSize: '13px', color: '#0c4a6e' }}>
								Open the Device Authentication Details page to inspect the real-time status returned by PingOne after
								initialization.
							</p>
						</div>
					)}

					<div style={{ display: 'flex', gap: '8px', marginBottom: '10px' }}>
						<button
							type="button"
							className="btn btn-primary"
							onClick={handleSendOTP}
							disabled={isLoading}
						>
							{isLoading ? 'üîÑ Sending...' : otpState.otpSent ? 'üîÑ Resend OTP Code' : 'Send OTP Code'}
						</button>

						{otpState.otpSent && (
							<button
								type="button"
								className="btn"
								onClick={() => {
									updateOtpState({
										otpSent: false,
										sendRetryCount: 0,
										sendError: null,
									});
								}}
								style={{
									background: '#f3f4f6',
									color: '#374151',
									border: '1px solid #d1d5db',
								}}
							>
								Clear Status
							</button>
						)}
					</div>

					{otpState.sendError && (
						<div
							className="info-box"
							style={{
								background: '#fef2f2',
								border: '1px solid #fecaca',
								color: '#991b1b',
								marginTop: '8px',
							}}
						>
							<h4 style={{ margin: '0 0 8px 0', fontSize: '15px' }}>‚ö†Ô∏è Error Sending OTP</h4>
							<p style={{ margin: '0 0 8px 0', fontSize: '14px' }}>{otpState.sendError}</p>
							<div style={{ marginTop: '12px', fontSize: '13px' }}>
								<strong>Recovery Options:</strong>
								<ul style={{ margin: '8px 0 0 20px', padding: 0 }}>
									<li>Verify your phone number is correct</li>
									<li>Check that your worker token is valid</li>
									<li>Wait a few minutes and try again (rate limiting)</li>
									<li>Go back and select a different device</li>
								</ul>
							</div>
						</div>
					)}

					{otpState.otpSent && !otpState.sendError && (
						<div className="success-box" style={{ marginTop: '10px' }}>
							<h3>‚úÖ OTP Sent</h3>
							<p>Check your phone for the verification code</p>
							<p style={{ marginTop: '12px', fontSize: '14px' }}>
								After receiving the code, proceed to the next step to validate it.
							</p>
							<p style={{ marginTop: '8px', fontSize: '13px', color: '#6b7280' }}>
								üí° <strong>Tip:</strong> OTP codes typically expire after 5-10 minutes. If you don't receive the code, click "Resend OTP Code" above.
							</p>
						</div>
					)}
				</div>
			);
		};
	};

	// Step 4: Validate OTP (using controller)
	const createRenderStep4 = () => {
		return (props: MFAFlowBaseRenderProps) => {
			const { credentials, mfaState, setMfaState, nav, setIsLoading, isLoading } = props;

			// Only show validation modal for ACTIVATION_REQUIRED devices
			// If device is ACTIVE, skip validation entirely
			if (mfaState.deviceStatus === 'ACTIVE') {
				// Device is already active, no validation needed
				// Navigate back to device selection
				if (nav.currentStep === 4) {
					setTimeout(() => {
						nav.goToStep(1);
					}, 0);
				}
				return (
					<div className="step-content">
						<div className="success-box">
							<h3>‚úÖ Device Ready</h3>
							<p>Your device is already active and ready to use. No OTP validation is required.</p>
							<p>
								<strong>Device ID:</strong> {mfaState.deviceId}
							</p>
							<p>
								<strong>Status:</strong> {mfaState.deviceStatus}
							</p>
						</div>
					</div>
				);
			}

			// If validation is complete, show success screen
			if (mfaState.verificationResult && mfaState.verificationResult.status === 'COMPLETED') {
				return (
					<div className="step-content">
						<h2>MFA Verification Complete</h2>
						<p>Your SMS device has been successfully verified</p>

						<div className="success-box">
							<h3>‚úÖ Verification Successful</h3>
							<p>
								<strong>Device ID:</strong> {mfaState.deviceId}
							</p>
							{mfaState.nickname && (
								<p>
									<strong>Nickname:</strong> {mfaState.nickname}
								</p>
							)}
							<p>
								<strong>Phone Number:</strong> {getFullPhoneNumber(credentials)}
							</p>
							<p>
								<strong>Status:</strong>{' '}
								{mfaState.verificationResult?.status || mfaState.deviceStatus || 'Verified'}
							</p>
							{mfaState.verificationResult?.message && (
								<p>
									<strong>Message:</strong> {mfaState.verificationResult.message}
								</p>
							)}
							{mfaState.environmentId && (
								<p>
									<strong>Environment ID:</strong> {mfaState.environmentId}
								</p>
							)}
							{mfaState.userId && (
								<p>
									<strong>User ID:</strong> {mfaState.userId}
								</p>
							)}
							{mfaState.createdAt && (
								<p>
									<strong>Created At:</strong> {new Date(mfaState.createdAt).toLocaleString()}
								</p>
							)}
							{mfaState.updatedAt && (
								<p>
									<strong>Updated At:</strong> {new Date(mfaState.updatedAt).toLocaleString()}
								</p>
							)}
						</div>

						<div className="info-box">
							<h4>What's Next?</h4>
							<ul>
								<li>This device can now be used for MFA challenges</li>
								<li>Users will receive OTP codes during authentication</li>
								<li>You can test MFA in your authentication flows</li>
							</ul>
						</div>
					</div>
				);
			}

			// Show validation UI as modal
			if (!showValidationModal) {
				return null;
			}

			return (
				<div
					style={{
						position: 'fixed',
						top: 0,
						left: 0,
						right: 0,
						bottom: 0,
						background: 'rgba(0, 0, 0, 0.5)',
						display: 'flex',
						alignItems: 'center',
						justifyContent: 'center',
						zIndex: 1000,
					}}
					onClick={() => {
						// Don't close on backdrop click - require explicit action
					}}
				>
					<div
						style={{
							background: 'white',
							borderRadius: '16px',
							padding: '0',
							maxWidth: '500px',
							width: '90%',
							boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
							overflow: 'hidden',
						}}
						onClick={(e) => e.stopPropagation()}
					>
						{/* Header with Logo */}
						<div
							style={{
								background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
								padding: '20px 24px 16px 24px',
								textAlign: 'center',
								position: 'relative',
							}}
						>
							<button
								type="button"
								onClick={() => {
									setShowValidationModal(false);
									nav.goToPrevious();
								}}
								style={{
									position: 'absolute',
									top: '16px',
									right: '16px',
									background: 'rgba(255, 255, 255, 0.2)',
									border: 'none',
									borderRadius: '50%',
									width: '32px',
									height: '32px',
									display: 'flex',
									alignItems: 'center',
									justifyContent: 'center',
									cursor: 'pointer',
									color: 'white',
								}}
							>
								<FiX size={18} />
							</button>
							<PingIdentityLogo size={36} />
							<h3
								style={{
									margin: '6px 0 0 0',
									fontSize: '18px',
									fontWeight: '600',
									color: 'white',
									textAlign: 'center',
								}}
							>
								Validate OTP Code
							</h3>
							<p
								style={{
									margin: '4px 0 0 0',
									fontSize: '12px',
									color: 'rgba(255, 255, 255, 0.9)',
									textAlign: 'center',
								}}
							>
								Enter the verification code sent to your phone
							</p>
						</div>

						{/* Modal Body */}
						<div style={{ padding: '24px' }}>
							{/* Device Info */}
							<div
								style={{
									marginBottom: '16px',
									padding: '10px 12px',
									background: '#eff6ff',
									border: '1px solid #bfdbfe',
									borderRadius: '6px',
								}}
							>
								<p style={{ margin: '0 0 4px 0', fontSize: '12px', color: '#1e40af', fontWeight: '600' }}>
									Device ID:
								</p>
								<p style={{ margin: '0 0 8px 0', fontSize: '11px', fontFamily: 'monospace', color: '#1f2937', wordBreak: 'break-all' }}>
									{mfaState.deviceId}
								</p>
								<p style={{ margin: '0 0 4px 0', fontSize: '12px', color: '#1e40af', fontWeight: '600' }}>
									Phone Number:
								</p>
								<p style={{ margin: '0', fontSize: '11px', fontFamily: 'monospace', color: '#1f2937' }}>
									{getFullPhoneNumber(credentials)}
								</p>
							</div>

							{/* OTP Input */}
							<div style={{ marginBottom: '16px' }}>
								<label
									style={{
										display: 'block',
										fontSize: '13px',
										fontWeight: '600',
										color: '#374151',
										marginBottom: '8px',
									}}
								>
									OTP Code <span style={{ color: '#ef4444' }}>*</span>
									<MFAInfoButtonV8 contentKey="otp.validation" displayMode="modal" />
								</label>
								<MFAOTPInput
									value={mfaState.otpCode}
									onChange={(value) => setMfaState({ ...mfaState, otpCode: value })}
									disabled={isLoading}
									placeholder="123456"
								/>
							</div>

							{/* Action Buttons */}
							<div style={{ display: 'flex', gap: '8px', marginBottom: '12px' }}>
								<button
									type="button"
									disabled={isLoading || mfaState.otpCode.length !== 6}
									onClick={async () => {
										await controller.validateOTP(
											credentials,
											mfaState.deviceId,
											mfaState.otpCode,
											mfaState,
											setMfaState,
											validationState,
											updateValidationState,
											nav,
											setIsLoading
										);
									}}
									style={{
										flex: 1,
										padding: '12px 20px',
										background: isLoading || mfaState.otpCode.length !== 6 ? '#d1d5db' : '#3b82f6',
										color: 'white',
										border: 'none',
										borderRadius: '8px',
										fontSize: '14px',
										fontWeight: '600',
										cursor: isLoading || mfaState.otpCode.length !== 6 ? 'not-allowed' : 'pointer',
										transition: 'all 0.2s ease',
									}}
								>
									{isLoading ? 'üîÑ Validating...' : 'Validate OTP'}
								</button>

								<button
									type="button"
									disabled={isLoading}
									onClick={async () => {
										setIsLoading(true);
										try {
											await controller.sendOTP(
												credentials,
												mfaState.deviceId,
												otpState,
												updateOtpState,
												nav,
												setIsLoading
											);
											toastV8.success('OTP code resent successfully!');
										} catch (error) {
											const errorMessage = error instanceof Error ? error.message : 'Unknown error';
											toastV8.error(`Failed to resend OTP: ${errorMessage}`);
										} finally {
											setIsLoading(false);
										}
									}}
									style={{
										flex: 1,
										padding: '12px 20px',
										background: '#f3f4f6',
										color: '#374151',
										border: '1px solid #d1d5db',
										borderRadius: '8px',
										fontSize: '14px',
										fontWeight: '600',
										cursor: isLoading ? 'not-allowed' : 'pointer',
										display: 'flex',
										alignItems: 'center',
										justifyContent: 'center',
										gap: '6px',
									}}
								>
									<span>üîÑ</span>
									<span>{isLoading ? 'Sending...' : 'Resend OTP Code'}</span>
								</button>
							</div>

							{/* Validation Error Messages */}
							{validationState.validationAttempts > 0 && (
								<div
									style={{
										marginTop: '12px',
										padding: '10px 12px',
										background: validationState.validationAttempts >= 3 ? '#fef2f2' : '#fffbeb',
										border: `1px solid ${validationState.validationAttempts >= 3 ? '#fecaca' : '#fed7aa'}`,
										borderRadius: '6px',
									}}
								>
									<p style={{ margin: '0 0 4px 0', fontSize: '12px', fontWeight: '600', color: validationState.validationAttempts >= 3 ? '#991b1b' : '#92400e' }}>
										{validationState.validationAttempts >= 3 ? '‚ö†Ô∏è Multiple Failed Attempts' : '‚ö†Ô∏è Validation Failed'}
									</p>
									<p style={{ margin: '0', fontSize: '11px', color: validationState.validationAttempts >= 3 ? '#991b1b' : '#92400e' }}>
										{validationState.lastValidationError || 'Invalid OTP code entered'}
									</p>
									{validationState.validationAttempts >= 3 && (
										<div style={{ marginTop: '8px', fontSize: '11px', color: '#991b1b' }}>
											<strong>Recovery Options:</strong>
											<ul style={{ margin: '4px 0 0 16px', padding: 0, lineHeight: '1.5' }}>
												<li>Click "Resend OTP Code" to get a fresh code</li>
												<li>Verify you're entering the code from the most recent SMS</li>
												<li>Check that the code hasn't expired (typically 5-10 minutes)</li>
											</ul>
										</div>
									)}
								</div>
							)}
						</div>
					</div>
				</div>
			);
		};
	};

	// Validation function for Step 0 (using controller)
	const validateStep0 = (
		credentials: MFACredentials,
		tokenStatus: ReturnType<typeof WorkerTokenStatusServiceV8.checkWorkerTokenStatus>,
		nav: ReturnType<typeof useStepNavigationV8>
	): boolean => {
		return controller.validateCredentials(credentials, tokenStatus, nav);
	};

	// Track API display visibility for dynamic padding
	const [isApiDisplayVisible, setIsApiDisplayVisible] = useState(false);

	useEffect(() => {
		const checkVisibility = () => {
			setIsApiDisplayVisible(apiDisplayServiceV8.isVisible());
		};

		// Check initial state
		checkVisibility();

		// Subscribe to visibility changes
		const unsubscribe = apiDisplayServiceV8.subscribe(checkVisibility);

		return () => unsubscribe();
	}, []);

	return (
		<div style={{ 
			minHeight: '100vh',
			paddingBottom: isApiDisplayVisible ? '450px' : '0',
			transition: 'padding-bottom 0.3s ease',
		}}>
			<MFAFlowBaseV8
				deviceType="SMS"
				renderStep0={renderStep0}
				renderStep1={renderStep1WithSelection}
				renderStep2={renderStep2Register}
				renderStep3={createRenderStep3()}
				renderStep4={createRenderStep4()}
				validateStep0={validateStep0}
				stepLabels={['Configure', 'Select Device', 'Register Device', 'Send OTP', 'Validate']}
			/>
			
			<SuperSimpleApiDisplayV8 flowFilter="mfa" />
			
		</div>
	);
};

// Main SMS Flow Component
export const SMSFlowV8: React.FC = () => {
	return <SMSFlowV8WithDeviceSelection />;
};
