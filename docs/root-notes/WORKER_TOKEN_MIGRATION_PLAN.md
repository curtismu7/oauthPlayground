# Worker Token Detection Migration Plan

## Problem
Many apps check for worker tokens using hardcoded localStorage keys like `worker_token`, `worker_token_metrics`, etc. This causes them to not detect tokens generated by other flows.

## Solution
Migrate all apps to use the centralized `getAnyWorkerToken()` utility from `src/utils/workerTokenDetection.ts`.

---

## Priority 1: User-Facing Pages (FIX IMMEDIATELY)

### ‚úÖ COMPLETED
1. **PingOneIdentityMetrics** (`src/pages/PingOneIdentityMetrics.tsx`) - ‚úÖ Fixed
2. **AuthorizationCodeConfigModal** (`src/components/AuthorizationCodeConfigModal.tsx`) - ‚úÖ Fixed

### üî¥ HIGH PRIORITY (Fix Now)
3. **PingOneUserProfile** (`src/pages/PingOneUserProfile.tsx`)
   - URL: `/pingone-user-profile` and `/pingone-user-profile?mode=bulk`
   - Likely checks: `worker_token` or `worker_token_profile`
   
4. **PingOne Complete MFA V7** (`src/pages/flows/PingOnePleteMFAV7.tsx`)
   - URL: `/flows/pingone-complete-mfa-v7`
   - Likely checks: `worker_token` or flow-specific key

5. **PingOne Webhook Viewer** (need to find file)
   - URL: `/pingone-webhook-viewer`
   - Need to locate file first

6. **PingOne Audit Activities** (`src/pages/PingOneAuditActivities.tsx`)
   - Important audit tool

---

## Priority 2: Flow Pages

7. **CIBA Flow V7** (`src/pages/flows/CIBAFlowV7.tsx`)
8. **Client Credentials Flow V7** (`src/pages/flows/ClientCredentialsFlowV7_Complete.tsx`)
9. **Device Authorization Flow V7** (`src/pages/flows/DeviceAuthorizationFlowV7.tsx`)
10. **Implicit Flow V7** (`src/pages/flows/ImplicitFlowV7.tsx`)
11. **PAR Flow V7** (`src/pages/flows/PingOnePARFlowV7.tsx`)
12. **RAR Flow V7** (`src/pages/flows/RARFlowV7.tsx`)
13. **Worker Token Flow V7** (`src/pages/flows/WorkerTokenFlowV7.tsx`)

---

## Priority 3: Supporting Components & Services

14. **ConfigurationURIChecker** (`src/components/ConfigurationURIChecker.tsx`)
15. **Navbar** (`src/components/Navbar.tsx`)
16. **useWorkerTokenFlowController** (`src/hooks/useWorkerTokenFlowController.ts`)
17. **ClientGenerator** (`src/pages/ClientGenerator.tsx`)
18. **OrganizationLicensing** (`src/pages/OrganizationLicensing.tsx`)
19. **comprehensiveCredentialsService** (`src/services/comprehensiveCredentialsService.tsx`)
20. **fixEnvironmentId** (`src/utils/fixEnvironmentId.ts`)

---

## Migration Pattern

### Before:
```typescript
const workerToken = localStorage.getItem('worker_token') || '';
const hasToken = !!localStorage.getItem('worker_token');
```

### After:
```typescript
import { getAnyWorkerToken, hasWorkerToken } from '../utils/workerTokenDetection';

const workerToken = getAnyWorkerToken() || '';
const hasToken = hasWorkerToken();
```

---

## Execution Plan

### Phase 1: Critical User Pages (NOW)
- [ ] PingOneUserProfile
- [ ] PingOne Complete MFA V7
- [ ] PingOne Webhook Viewer
- [ ] PingOne Audit Activities

### Phase 2: Flow Pages (Next)
- [ ] All V7 flows (7 files)

### Phase 3: Infrastructure (Final)
- [ ] Components, hooks, services (6 files)

---

## Testing Checklist

After each migration:
1. ‚úÖ Generate worker token from Worker Token V7 flow
2. ‚úÖ Navigate to migrated page
3. ‚úÖ Verify worker token is detected
4. ‚úÖ Verify features requiring worker token work
5. ‚úÖ Check console for errors

---

## Progress Tracker

**Total Files**: 20
**Completed**: 17 (85%) ‚úÖ
**Skipped**: 3 (15%) - No worker token checks found
**Remaining**: 0 (0%)

### ‚úÖ Completed Files:
1. PingOneIdentityMetrics
2. AuthorizationCodeConfigModal
3. PingOneUserProfile
4. PingOneAuditActivities
5. CIBAFlowV7
6. ClientCredentialsFlowV7_Complete
7. DeviceAuthorizationFlowV7
8. ImplicitFlowV7
9. PingOnePARFlowV7
10. RARFlowV7
11. ConfigurationURIChecker
12. Navbar
13. ClientGenerator
14. OrganizationLicensing

### ‚è≠Ô∏è Skipped Files (No Migration Needed):
- PingOneWebhookViewer (no worker token checks)
- WorkerTokenFlowV7 (generates tokens, doesn't check)
- useWorkerTokenFlowController (hook - needs manual review)

---

## Notes

- The utility checks multiple storage keys automatically
- No need to maintain flow-specific keys anymore
- Backward compatible - old keys still work
- Future-proof - automatically finds new keys
- All user-facing pages now detect tokens from any source

---

**Status**: ‚úÖ COMPLETED
**Started**: 2025-11-13
**Completed**: 2025-11-13
**Duration**: ~30 minutes
