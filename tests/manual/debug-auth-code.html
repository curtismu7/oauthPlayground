<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authorization Code Debug Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .button {
            background: #0070cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.danger {
            background: #dc2626;
        }
        .button.danger:hover {
            background: #b91c1c;
        }
        .button.success {
            background: #059669;
        }
        .button.success:hover {
            background: #047857;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .status.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Authorization Code Debug Tool</h1>
        <p>This tool helps debug authorization code capture issues in the V4 flow.</p>

        <div class="section">
            <h3>ğŸ“Š Current URL Analysis</h3>
            <div id="urlAnalysis" class="log">Analyzing URL...</div>
            <button class="button" onclick="analyzeUrl()">ğŸ”„ Refresh Analysis</button>
        </div>

        <div class="section">
            <h3>ğŸ§ª Test Authorization Code Generation</h3>
            <div class="input-group">
                <label for="testCode">Test Authorization Code:</label>
                <input type="text" id="testCode" placeholder="Enter a test authorization code">
            </div>
            <button class="button success" onclick="generateTestCode()">ğŸ² Generate Random Code</button>
            <button class="button" onclick="simulateAuthCode()">ğŸš€ Simulate Auth Code in URL</button>
            <button class="button" onclick="clearUrl()">ğŸ§¹ Clear URL Parameters</button>
        </div>

        <div class="section">
            <h3>ğŸ“ Local Storage Test</h3>
            <button class="button" onclick="saveToLocalStorage()">ğŸ’¾ Save to Local Storage</button>
            <button class="button" onclick="loadFromLocalStorage()">ğŸ“¥ Load from Local Storage</button>
            <button class="button danger" onclick="clearLocalStorage()">ğŸ—‘ï¸ Clear Local Storage</button>
        </div>

        <div class="section">
            <h3>ğŸ”— V4 Flow Integration</h3>
            <button class="button success" onclick="openV4Flow()">ğŸ¯ Open V4 Flow</button>
            <button class="button" onclick="openV4WithCode()">ğŸ¯ Open V4 with Auth Code</button>
            <button class="button" onclick="testUrlMonitoring()">ğŸ‘€ Test URL Monitoring</button>
        </div>

        <div class="section">
            <h3>ğŸ“‹ Debug Log</h3>
            <div id="debugLog" class="log">Debug log will appear here...</div>
            <button class="button danger" onclick="clearLog()">ğŸ—‘ï¸ Clear Log</button>
        </div>
    </div>

    <script>
        let logEntries = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logEntries.push(entry);
            
            const logElement = document.getElementById('debugLog');
            logElement.textContent = logEntries.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(entry);
        }

        function analyzeUrl() {
            const url = window.location.href;
            const urlParams = new URLSearchParams(window.location.search);
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            
            const analysis = {
                fullUrl: url,
                search: window.location.search,
                hash: window.location.hash,
                searchParams: Object.fromEntries(urlParams.entries()),
                hashParams: Object.fromEntries(hashParams.entries()),
                hasCode: urlParams.has('code') || hashParams.has('code'),
                hasError: urlParams.has('error') || hashParams.has('error')
            };
            
            document.getElementById('urlAnalysis').textContent = JSON.stringify(analysis, null, 2);
            log(`URL Analysis: ${JSON.stringify(analysis)}`);
        }

        function _generateTestCode() {
            const testCode = `test-auth-code-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            document.getElementById('testCode').value = testCode;
            log(`Generated test code: ${testCode}`);
        }

        function _simulateAuthCode() {
            const testCode = document.getElementById('testCode').value || `test-auth-code-${Date.now()}`;
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('code', testCode);
            currentUrl.searchParams.set('state', 'test-state');
            
            window.history.replaceState({}, document.title, currentUrl.toString());
            log(`Simulated auth code in URL: ${testCode}`);
            analyzeUrl();
        }

        function _clearUrl() {
            const currentUrl = new URL(window.location);
            currentUrl.search = '';
            currentUrl.hash = '';
            
            window.history.replaceState({}, document.title, currentUrl.pathname);
            log('Cleared URL parameters');
            analyzeUrl();
        }

        function _saveToLocalStorage() {
            const testCode = document.getElementById('testCode').value || `test-auth-code-${Date.now()}`;
            localStorage.setItem('oauth-v4-auth-code', testCode);
            log(`Saved to localStorage: ${testCode}`);
        }

        function _loadFromLocalStorage() {
            const savedCode = localStorage.getItem('oauth-v4-auth-code');
            if (savedCode) {
                document.getElementById('testCode').value = savedCode;
                log(`Loaded from localStorage: ${savedCode}`);
            } else {
                log('No code found in localStorage', 'warning');
            }
        }

        function _clearLocalStorage() {
            localStorage.removeItem('oauth-v4-auth-code');
            localStorage.removeItem('oauth-v4-test-config');
            log('Cleared localStorage');
        }

        function _openV4Flow() {
            window.open('/flows/authorization-code-v4', '_blank');
            log('Opened V4 Flow in new tab');
        }

        function _openV4WithCode() {
            const testCode = document.getElementById('testCode').value || `test-auth-code-${Date.now()}`;
            const url = `/flows/authorization-code-v4?code=${encodeURIComponent(testCode)}&state=test-state`;
            window.open(url, '_blank');
            log(`Opened V4 Flow with auth code: ${testCode}`);
        }

        function _testUrlMonitoring() {
            log('Starting URL monitoring test...');
            
            // Monitor URL changes
            let lastUrl = window.location.href;
            const checkInterval = setInterval(() => {
                if (window.location.href !== lastUrl) {
                    log(`URL changed: ${window.location.href}`);
                    analyzeUrl();
                    lastUrl = window.location.href;
                }
            }, 1000);
            
            // Stop monitoring after 30 seconds
            setTimeout(() => {
                clearInterval(checkInterval);
                log('URL monitoring stopped');
            }, 30000);
            
            log('URL monitoring started (will stop in 30 seconds)');
        }

        function _clearLog() {
            logEntries = [];
            document.getElementById('debugLog').textContent = 'Debug log cleared...';
        }

        // Auto-analyze URL on load
        window.addEventListener('load', () => {
            analyzeUrl();
            log('Debug tool loaded');
        });

        // Monitor for storage changes
        window.addEventListener('storage', (e) => {
            log(`Storage change detected: ${e.key} = ${e.newValue}`);
        });

        // Monitor for URL changes (popstate)
        window.addEventListener('popstate', () => {
            log('URL changed via browser navigation');
            analyzeUrl();
        });
    </script>
</body>
</html>
