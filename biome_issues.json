{"summary":{"changed":0,"unchanged":23,"matches":0,"duration":{"secs":0,"nanos":52873959},"scannerDuration":{"secs":0,"nanos":4199292},"errors":28,"warnings":41,"infos":0,"skipped":0,"suggestedFixesSkipped":0,"diagnosticsNotPrinted":0},"diagnostics":[{"category":"lint/correctness/useExhaustiveDependencies","severity":"warning","description":"This hook does not specify its dependency on performRegistrationWithToken.","message":[{"elements":[],"content":"This hook "},{"elements":["Emphasis"],"content":"does not specify"},{"elements":[],"content":" its dependency on "},{"elements":["Emphasis"],"content":"performRegistrationWithToken"},{"elements":[],"content":"."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"This dependency is being used here, but is not specified in the hook dependency list."}]]},{"frame":{"path":null,"span":[80176,80204],"sourceCode":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\n * @description Unified MFA Registration Flow - Single component for all 6 device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Replace 6 device-specific flow components (SMS, Email, Mobile, WhatsApp, TOTP, FIDO2)\n * with a single configurable component using deviceFlowConfigs for device-specific behavior.\n *\n * Architecture:\n * - Configuration-driven using deviceFlowConfigs.ts\n * - Dynamic form rendering for simple devices (SMS, Email, WhatsApp)\n * - Custom components for complex devices (TOTP, FIDO2, Mobile)\n * - Integrates with MFACredentialContext and useWorkerToken hook\n * - Uses existing MFAFlowBaseV8 for 5-step framework\n *\n * @example\n * <UnifiedMFARegistrationFlowV8\n *   deviceType=\"SMS\"\n *   onSuccess={(result) => console.log('Device registered:', result.deviceId)}\n * />\n */\n\nimport * as React from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { FiChevronDown, FiChevronUp } from 'react-icons/fi';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { MFAHeaderV8 } from '@/v8/components/MFAHeaderV8';\nimport type { SearchableDropdownOption } from '@/v8/components/SearchableDropdownV8';\nimport { SearchableDropdownV8 } from '@/v8/components/SearchableDropdownV8';\nimport { SQLiteStatsDisplayV8 } from '@/v8/components/SQLiteStatsDisplayV8';\nimport { SuperSimpleApiDisplayV8 } from '@/v8/components/SuperSimpleApiDisplayV8';\nimport { UserLoginModalV8 } from '@/v8/components/UserLoginModalV8';\nimport { getDeviceConfig } from '@/v8/config/deviceFlowConfigs';\nimport type { DeviceConfigKey, DeviceRegistrationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport { PING_IDENTITY_COLORS } from '@/v8/constants/pingIdentityColors';\nimport { GlobalMFAProvider } from '@/v8/contexts/GlobalMFAContext';\nimport { MFACredentialProvider } from '@/v8/contexts/MFACredentialContext';\nimport { APIDocsStepV8 } from '@/v8/flows/shared/APIDocsStepV8';\nimport { SuccessStepV8 } from '@/v8/flows/shared/SuccessStepV8';\nimport { UserLoginStepV8 } from '@/v8/flows/shared/UserLoginStepV8';\nimport { useMFAPolicies } from '@/v8/hooks/useMFAPolicies';\nimport { useStepNavigationV8 } from '@/v8/hooks/useStepNavigationV8';\nimport { useUserSearch } from '@/v8/hooks/useUserSearch';\nimport { useWorkerToken } from '@/v8/hooks/useWorkerToken';\nimport { CredentialsServiceV8 } from '@/v8/services/credentialsServiceV8';\nimport { globalEnvironmentService } from '@/v8/services/globalEnvironmentService';\nimport { MfaAuthenticationServiceV8 } from '@/v8/services/mfaAuthenticationServiceV8';\nimport { type MFAFeatureFlag, MFAFeatureFlagsV8 } from '@/v8/services/mfaFeatureFlagsV8';\nimport MFAServiceV8_Legacy, { type RegisterDeviceParams } from '@/v8/services/mfaServiceV8_Legacy';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport type { TokenStatusInfo } from '@/v8/services/workerTokenStatusServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { ReturnTargetServiceV8U } from '@/v8u/services/returnTargetServiceV8U';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type MFAFlowBaseRenderProps, MFAFlowBaseV8 } from '../shared/MFAFlowBaseV8';\nimport type { DeviceAuthenticationPolicy, MFACredentials, MFAState } from '../shared/MFATypes';\nimport { UnifiedActivationStep } from './components/UnifiedActivationStep';\nimport { UnifiedDeviceRegistrationForm } from './components/UnifiedDeviceRegistrationForm';\nimport { UnifiedDeviceSelectionModal } from './components/UnifiedDeviceSelectionModal';\nimport { UnifiedSuccessStep } from './components/UnifiedSuccessStep';\nimport './UnifiedMFAFlow.css';\n\nconst MODULE_TAG = '[üîÑ UNIFIED-MFA-FLOW-V8]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedMFARegistrationFlowV8Props {\n\t/** Device type to render (optional - can be provided via navigation state) */\n\tdeviceType?: DeviceConfigKey;\n\n\t/** Optional initial credentials (for pre-filled forms) */\n\tinitialCredentials?: Partial<MFACredentials>;\n\n\t/** Optional callback when registration succeeds */\n\tonSuccess?: (result: DeviceRegistrationResult) => void;\n\n\t/** Optional callback when user cancels flow */\n\tonCancel?: () => void;\n\n\t/** Optional initial step (defaults to 0) */\n\tinitialStep?: number;\n\n\t/** Optional: Skip configuration step if already configured */\n\tskipConfiguration?: boolean;\n\n\t/** Optional: Force specific registration flow type */\n\tregistrationFlowType?: 'admin-active' | 'admin-activation' | 'user';\n}\n\n// ============================================================================\n// MFA FLOW SELECTION SCREEN\n// ============================================================================\n\ntype FlowMode = 'registration' | 'authentication';\n\n/** Map device types to their feature flags */\nconst DEVICE_FLAG_MAP: Record<DeviceConfigKey, MFAFeatureFlag> = {\n\tSMS: 'mfa_unified_sms',\n\tEMAIL: 'mfa_unified_email',\n\tMOBILE: 'mfa_unified_mobile',\n\tWHATSAPP: 'mfa_unified_whatsapp',\n\tTOTP: 'mfa_unified_totp',\n\tFIDO2: 'mfa_unified_fido2',\n};\n\nconst DEVICE_TYPES: { key: DeviceConfigKey; icon: string; name: string; description: string }[] = [\n\t{ key: 'SMS', icon: 'üì±', name: 'SMS', description: 'Receive OTP codes via text message' },\n\t{ key: 'EMAIL', icon: '‚úâÔ∏è', name: 'Email', description: 'Receive OTP codes via email' },\n\t{\n\t\tkey: 'TOTP',\n\t\ticon: 'üîê',\n\t\tname: 'Authenticator App (TOTP)',\n\t\tdescription: 'Use Google Authenticator, Authy, or similar',\n\t},\n\t{\n\t\tkey: 'MOBILE',\n\t\ticon: 'üì≤',\n\t\tname: 'Mobile Push',\n\t\tdescription: 'Receive push notifications on your phone',\n\t},\n\t{ key: 'WHATSAPP', icon: 'üí¨', name: 'WhatsApp', description: 'Receive OTP codes via WhatsApp' },\n\t{\n\t\tkey: 'FIDO2',\n\t\ticon: 'üîë',\n\t\tname: 'Security Key (FIDO2)',\n\t\tdescription: 'Use a hardware security key or passkey',\n\t},\n];\n\n/** Check if a device type is enabled via feature flags */\nconst isDeviceEnabled = (deviceKey: DeviceConfigKey): boolean => {\n\tconst flag = DEVICE_FLAG_MAP[deviceKey];\n\treturn MFAFeatureFlagsV8.isEnabled(flag);\n};\n\ninterface DeviceTypeSelectionScreenProps {\n\tonSelectDeviceType: (deviceType: DeviceConfigKey) => void;\n\tuserToken?: string | null;\n\tsetUserToken: (token: string | null) => void;\n}\n\nconst DeviceTypeSelectionScreen: React.FC<DeviceTypeSelectionScreenProps> = ({\n\tonSelectDeviceType,\n\tuserToken,\n\tsetUserToken,\n}) => {\n\tconst [flowMode, setFlowMode] = useState<FlowMode | null>(null);\n\tconst [environmentId, setEnvironmentId] = useState('');\n\tconst [username, setUsername] = useState('');\n\tconst [showDeviceSelectionModal, setShowDeviceSelectionModal] = useState(false);\n\tconst [showOTPModal, setShowOTPModal] = useState(false);\n\tconst [otpCode, setOtpCode] = useState('');\n\tconst [authenticationId, setAuthenticationId] = useState<string | null>(null);\n\tconst [selectedAuthDevice, setSelectedAuthDevice] = useState<{\n\t\tid: string;\n\t\ttype: string;\n\t\tnickname?: string;\n\t} | null>(null);\n\tconst [customLogoUrl, setCustomLogoUrl] = useState<string>('');\n\tconst [showAuthLoginModal, setShowAuthLoginModal] = useState(false);\n\tconst authEnvIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Load uploaded logo from localStorage on mount\n\tuseEffect(() => {\n\t\ttry {\n\t\t\tconst savedUpload = localStorage.getItem('custom-logo-upload');\n\t\t\tif (savedUpload) {\n\t\t\t\tconst uploadData = JSON.parse(savedUpload);\n\t\t\t\t// Handle both old format (objectUrl) and new format (base64Url)\n\t\t\t\tif (uploadData.base64Url) {\n\t\t\t\t\tsetCustomLogoUrl(uploadData.base64Url);\n\t\t\t\t} else if (uploadData.objectUrl) {\n\t\t\t\t\t// Old format - try to convert if possible, otherwise clear it\n\t\t\t\t\tconsole.warn('Old logo format detected - please re-upload your logo');\n\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load uploaded logo from localStorage:', error);\n\t\t\t// Clear corrupted data\n\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t}\n\t}, []);\n\n\t// Use worker token hook for token management\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Extract environment ID from worker token when available\n\tuseEffect(() => {\n\t\tconst extractEnvironmentId = async () => {\n\t\t\ttry {\n\t\t\t\tconst token = await workerTokenServiceV8.getToken();\n\t\t\t\tif (token && !environmentId) {\n\t\t\t\t\tconst parts = token.split('.');\n\t\t\t\t\tif (parts.length === 3) {\n\t\t\t\t\t\tconst payload = JSON.parse(atob(parts[1]));\n\t\t\t\t\t\tif (payload.environmentId) {\n\t\t\t\t\t\t\tsetEnvironmentId(payload.environmentId);\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`${MODULE_TAG} Environment ID extracted from worker token:`,\n\t\t\t\t\t\t\t\tpayload.environmentId\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Failed to extract environment ID from worker token:`, error);\n\t\t\t}\n\t\t};\n\n\t\textractEnvironmentId();\n\t}, [environmentId]);\n\n\tconst hasWorkerToken = workerToken.tokenStatus.isValid;\n\n\t// Use user search hook for user fetching and search\n\tconst {\n\t\tusers,\n\t\tisLoading: isLoadingUsers,\n\t\tsetSearchQuery,\n\t} = useUserSearch({\n\t\tenvironmentId,\n\t\ttokenValid: workerToken.tokenStatus.isValid,\n\t\tmaxPages: 100,\n\t\tuseCache: true,\n\t});\n\tconst tokenStatus = workerToken.tokenStatus;\n\n\t// Debug: Log users type to understand the issue\n\tuseEffect(() => {\n\t\tconsole.log(`${MODULE_TAG} users type check:`, {\n\t\t\tusers,\n\t\t\tisArray: Array.isArray(users),\n\t\t\ttype: typeof users,\n\t\t\tconstructor: users?.constructor?.name,\n\t\t});\n\t}, [users]);\n\n\t// Load Environment ID and username from global services on mount\n\tuseEffect(() => {\n\t\t// Initialize the service first to load from localStorage\n\t\tglobalEnvironmentService.initialize();\n\t\tconst savedEnvId = globalEnvironmentService.getEnvironmentId();\n\t\tif (savedEnvId) {\n\t\t\tsetEnvironmentId(savedEnvId);\n\t\t}\n\n\t\t// Load username from localStorage\n\t\tconst savedUsername = localStorage.getItem('mfa_unified_username');\n\t\tif (savedUsername) {\n\t\t\tsetUsername(savedUsername);\n\t\t}\n\t}, []);\n\n\t// Use MFA policies hook\n\tconst {\n\t\tpolicies,\n\t\tselectedPolicy,\n\t\tisLoading: isPoliciesLoading,\n\t\terror: policiesError,\n\t\tselectPolicy,\n\t\tdefaultPolicy,\n\t} = useMFAPolicies({\n\t\tenvironmentId,\n\t\ttokenIsValid: tokenStatus.isValid,\n\t\tautoLoad: true,\n\t\tautoSelectSingle: true,\n\t});\n\n\tconst selectedPolicyRef = useRef<DeviceAuthenticationPolicy | null>(null);\n\tuseEffect(() => {\n\t\tselectedPolicyRef.current = selectedPolicy ?? null;\n\t}, [selectedPolicy]);\n\n\tconst isPolicyDeviceEnabled = useCallback(\n\t\t(policy: DeviceAuthenticationPolicy | null, key: string) => {\n\t\t\tconst deviceConfig = policy?.[key] as { enabled?: boolean } | undefined;\n\t\t\treturn !!deviceConfig?.enabled;\n\t\t},\n\t\t[]\n\t);\n\n\tconst policyOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tpolicies.map((policy) => ({\n\t\t\t\tvalue: policy.id,\n\t\t\t\tlabel: policy.name,\n\t\t\t\t...(policy.default ? { secondaryLabel: '(Default)' } : {}),\n\t\t\t})),\n\t\t[policies]\n\t);\n\n\tconst userOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tArray.from(\n\t\t\t\tnew Map(\n\t\t\t\t\t(Array.isArray(users) ? users : []).map((user) => [\n\t\t\t\t\t\tuser.username,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvalue: user.username,\n\t\t\t\t\t\t\tlabel: user.username,\n\t\t\t\t\t\t\t...(user.email ? { secondaryLabel: user.email } : {}),\n\t\t\t\t\t\t} as SearchableDropdownOption,\n\t\t\t\t\t])\n\t\t\t\t).values()\n\t\t\t),\n\t\t[users]\n\t);\n\n\t// Auto-select default policy when policies load\n\tuseEffect(() => {\n\t\tif (defaultPolicy && !selectedPolicy) {\n\t\t\tselectPolicy(defaultPolicy.id);\n\t\t}\n\t}, [defaultPolicy, selectedPolicy, selectPolicy]);\n\n\t// Sync environment ID to global service and CredentialsServiceV8 when it changes\n\tuseEffect(() => {\n\t\tif (environmentId) {\n\t\t\tglobalEnvironmentService.setEnvironmentId(environmentId);\n\t\t\tlocalStorage.setItem('mfa_environmentId', environmentId);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tenvironmentId,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId, username: currentCreds.username }\n\t\t\t}));\n\t\t}\n\t}, [environmentId]);\n\n\t// Save username to localStorage and CredentialsServiceV8 when it changes\n\t// This ensures MFAFlowBase can read the username from its expected storage location\n\tuseEffect(() => {\n\t\tif (username) {\n\t\t\tlocalStorage.setItem('mfa_unified_username', username);\n\t\t\tlocalStorage.setItem('mfa_username', username);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tusername,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId: currentCreds.environmentId, username }\n\t\t\t}));\n\t\t}\n\t}, [username]);\n\n\t// Handle device selection for authentication\n\tconst handleDeviceSelectForAuthentication = async (device: {\n\t\tid: string;\n\t\ttype: string;\n\t\tdeviceName?: string;\n\t\tnickname?: string;\n\t}) => {\n\t\tconsole.log(`${MODULE_TAG} Selected device for authentication:`, device);\n\t\tsetShowDeviceSelectionModal(false);\n\t\tsetSelectedAuthDevice(device);\n\n\t\tconst policyId = selectedPolicy?.id;\n\t\tif (!policyId) {\n\t\t\ttoastV8.error('Please select an MFA Policy first');\n\t\t\treturn;\n\t\t}\n\n\t\t// Determine flow type and token\n\t\t// Admin flows should use worker tokens, not require user tokens\n\t\tconst flowType = userToken ? 'user' : 'admin';\n\t\tconst effectiveUserToken = flowType === 'user' ? userToken : undefined;\n\n\t\t// For admin flow, check if we have a valid worker token before proceeding\n\t\tif (flowType === 'admin' && !hasWorkerToken) {\n\t\t\ttoastV8.error('Admin flow requires a valid worker token. Please generate a worker token first.');\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\t// Initialize authentication with appropriate token\n\t\t\tconst response = await MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\tenvironmentId,\n\t\t\t\tusername: username.trim(),\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t\tdeviceId: device.id,\n\t\t\t\tregion: 'na',\n\t\t\t\ttokenType: flowType,\n\t\t\t\t...(effectiveUserToken && { userToken: effectiveUserToken }),\n\t\t\t});\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth initialized - full response:`, response);\n\t\t\tsetAuthenticationId(response.id);\n\n\t\t\tconst status = (response.status || '').toUpperCase();\n\t\t\tconst nextStep = (response.nextStep || '').toUpperCase();\n\t\t\tconst links = response._links as Record<string, { href?: string }> | undefined;\n\t\t\tconst hasOtpLink = !!(\n\t\t\t\tlinks &&\n\t\t\t\t(links.otp || links['otp.check'] || (links as Record<string, unknown>)['checkOtp'])\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth status:`, {\n\t\t\t\tstatus,\n\t\t\t\tnextStep,\n\t\t\t\thasOtpLink,\n\t\t\t\tdeviceType: device.type,\n\t\t\t});\n\n\t\t\t// Show appropriate UI based on response (normalize status/nextStep for PingOne variants)\n\t\t\tif (status === 'OTP_REQUIRED' || nextStep === 'OTP_REQUIRED' || hasOtpLink) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Opening OTP modal for device:`, device.type);\n\t\t\t\tsetShowOTPModal(true);\n\t\t\t\ttoastV8.success(`Verification code sent to your ${device.type} device`);\n\t\t\t} else if (status === 'ASSERTION_REQUIRED' || nextStep === 'ASSERTION_REQUIRED') {\n\t\t\t\tconsole.log(`${MODULE_TAG} FIDO2 assertion required`);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'FIDO2 authentication required. Please use /v8/mfa-config for FIDO2 authentication.'\n\t\t\t\t);\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'PUSH_CONFIRMATION_REQUIRED' ||\n\t\t\t\tnextStep === 'PUSH_CONFIRMATION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Push confirmation required`);\n\t\t\t\ttoastV8.success('Push notification sent! Please approve on your mobile device.');\n\t\t\t\ttoastV8.info('Complete authentication at /v8/mfa-config for push polling.');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (status === 'COMPLETED') {\n\t\t\t\ttoastV8.success('Authentication completed successfully!');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'DEVICE_SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'DEVICE_SELECTION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Device selection required - showing modal again`);\n\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t} else {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Unexpected authentication status:`, {\n\t\t\t\t\tstatus,\n\t\t\t\t\tnextStep,\n\t\t\t\t\tresponse,\n\t\t\t\t});\n\t\t\t\ttoastV8.info(`Authentication status: ${status || nextStep || 'UNKNOWN'}`);\n\t\t\t\t// Stay in authentication flow so user can try another device\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to initialize authentication:`, error);\n\n\t\t\t// Enhanced error handling for NO_USABLE_DEVICES\n\t\t\tlet errorMessage = 'Authentication failed: ';\n\t\t\tif (error instanceof Error) {\n\t\t\t\tconst errorStr = error.message.toLowerCase();\n\n\t\t\t\t// Check for NO_USABLE_DEVICES or device availability errors\n\t\t\t\tif (\n\t\t\t\t\terrorStr.includes('no usable devices') ||\n\t\t\t\t\terrorStr.includes('too many') ||\n\t\t\t\t\terrorStr.includes('cooldown') ||\n\t\t\t\t\terrorStr.includes('blocked')\n\t\t\t\t) {\n\t\t\t\t\terrorMessage = '‚ö†Ô∏è Device Temporarily Unavailable\\n\\n';\n\n\t\t\t\t\tif (errorStr.includes('cooldown') || errorStr.includes('too many')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Too many notifications have been sent to this device. It is temporarily in cooldown. ';\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Please wait a few minutes and try again, or select a different device.';\n\t\t\t\t\t} else if (errorStr.includes('blocked')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'This device has been blocked. Please contact your administrator or use a different device.';\n\t\t\t\t\t} else {\n\t\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terrorMessage += 'Unknown error';\n\t\t\t}\n\n\t\t\ttoastV8.error(errorMessage, { duration: 8000 });\n\t\t\t// Do NOT set flowMode(null) - keep user in authentication flow so they can retry or select another device\n\t\t}\n\t};\n\n\t// Handle OTP verification\n\tconst handleVerifyOTP = async () => {\n\t\tif (!authenticationId || !selectedAuthDevice) {\n\t\t\ttoastV8.error('Authentication session not found');\n\t\t\treturn;\n\t\t}\n\n\t\tif (otpCode.length !== 6) {\n\t\t\ttoastV8.error('Please enter a 6-digit code');\n\t\t\treturn;\n\t\t}\n\n\t\t// Get worker token for API call\n\t\tconst workerTokenForOTP = await workerTokenServiceV8.getToken();\n\n\t\tconsole.log(`${MODULE_TAG} OTP verification debug:`, {\n\t\t\tenvironmentId,\n\t\t\tusername: username.trim(),\n\t\t\tauthenticationId,\n\t\t\totpCode,\n\t\t\thasEnvironmentId: !!environmentId,\n\t\t\tenvIdLength: environmentId?.length,\n\t\t\thasWorkerToken: !!workerTokenForOTP,\n\t\t\tworkerTokenLength: workerTokenForOTP?.length,\n\t\t});\n\n\t\ttry {\n\t\t\t// Use backend proxy to avoid CORS issues\n\t\t\tconst response = await fetch('/api/pingone/mfa/validate-otp-for-device', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tenvironmentId,\n\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\tdeviceAuthId: authenticationId,\n\t\t\t\t\totp: otpCode,\n\t\t\t\t\tregion: 'na',\n\t\t\t\t\tworkerToken: workerTokenForOTP,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\n\t\t\t\tthrow new Error(errorData.error || errorData.message || `HTTP ${response.status}`);\n\t\t\t}\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.status === 'COMPLETED' || result.status === 'completed') {\n\t\t\t\ttoastV8.success('‚úÖ Authentication completed successfully!');\n\t\t\t\tsetShowOTPModal(false);\n\t\t\t\tsetFlowMode(null);\n\t\t\t\tsetOtpCode('');\n\t\t\t} else {\n\t\t\t\ttoastV8.error('Invalid code. Please try again.');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} OTP verification failed:`, error);\n\t\t\ttoastV8.error(\n\t\t\t\t`Verification failed: ${error instanceof Error ? error.message : 'Unknown error'}`\n\t\t\t);\n\t\t}\n\t};\n\n\t// Step 1: Choose Registration or Authentication\n\tif (!flowMode) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '12px' }}>\n\t\t\t\t\t{/* Header */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tboxShadow: '0 4px 12px rgba(239, 68, 68, 0.2)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h1\n\t\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîê MFA Unified Flow\n\t\t\t\t\t\t</h1>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tChoose what you want to do with MFA devices.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Configuration Section */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 12px 0',\n\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfiguration\n\t\t\t\t\t\t</h2>\n\n\t\t\t\t\t\t{/* Custom Logo URL */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-url\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[800],\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüé® Custom Logo URL (Optional)\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tDisplay a custom logo in the OTP verification modal\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t{/* URL Input */}\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tid=\"custom-logo-url\"\n\t\t\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\t\t\tvalue={customLogoUrl}\n\t\t\t\t\t\t\t\tonChange={(e) => setCustomLogoUrl(e.target.value)}\n\t\t\t\t\t\t\t\tplaceholder=\"https://example.com/logo.png\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\tpadding: '10px 14px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[900],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = `0 0 0 3px ${PING_IDENTITY_COLORS.primary[200]}`;\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.neutral[300];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* File Upload Section */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '13px', color: PING_IDENTITY_COLORS.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\tOR\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"file\"\n\t\t\t\t\t\t\t\t\tid=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\taccept=\"image/*\"\n\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\tconst file = e.target.files?.[0];\n\t\t\t\t\t\t\t\t\t\tif (!file) return;\n\n\t\t\t\t\t\t\t\t\t\t// Validate file type (images only)\n\t\t\t\t\t\t\t\t\t\tif (!file.type.startsWith('image/')) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Please select a logo file (JPG, PNG, etc.)');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Validate file size (max 5MB)\n\t\t\t\t\t\t\t\t\t\tif (file.size > 5 * 1024 * 1024) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('File size must be less than 5MB');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Convert file to base64 for persistence\n\t\t\t\t\t\t\t\t\t\tconst reader = new FileReader();\n\t\t\t\t\t\t\t\t\t\treader.onload = (event) => {\n\t\t\t\t\t\t\t\t\t\t\tconst base64Url = event.target?.result as string;\n\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl(base64Url);\n\n\t\t\t\t\t\t\t\t\t\t\t// Store base64 data for persistence\n\t\t\t\t\t\t\t\t\t\t\tconst uploadData = {\n\t\t\t\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\t\t\t\tbase64Url: base64Url,\n\t\t\t\t\t\t\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\t\t\t// Save to localStorage for persistence\n\t\t\t\t\t\t\t\t\t\t\tlocalStorage.setItem('custom-logo-upload', JSON.stringify(uploadData));\n\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.success(`Logo uploaded: ${file.name}`);\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.onerror = () => {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to read uploaded file');\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.readAsDataURL(file);\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'none' }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.primary[500],\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.primary[600]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '500',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[700];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìÅ Upload Logo File\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[500],\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tJPG, PNG, GIF (max 5MB)\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{customLogoUrl && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.neutral[50],\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tLogo Preview:\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\talt=\"Custom logo\"\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonError={() => {\n\t\t\t\t\t\t\t\t\t\t\t// Handle broken image URLs\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Failed to load custom logo URL');\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl('');\n\t\t\t\t\t\t\t\t\t\t\t\t// Clear uploaded file from localStorage\n\t\t\t\t\t\t\t\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.accent.pingRed[500],\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.accent.pingRed[600]}`,\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[600];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[500];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRemove Logo\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Environment ID - Hide when worker token is available */}\n\t\t\t\t\t\t{!hasWorkerToken && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"env-id\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tEnvironment ID\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"env-id\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setEnvironmentId(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* SQLite Database Stats */}\n\t\t\t\t\t\t{environmentId && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<SQLiteStatsDisplayV8\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tcompact={false}\n\t\t\t\t\t\t\t\t\trefreshInterval={30}\n\t\t\t\t\t\t\t\t\tshowRefreshButton={true}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Username */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUsername\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{environmentId && tokenStatus.isValid ? (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\toptions={userOptions}\n\t\t\t\t\t\t\t\t\tonChange={setUsername}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Type to search across 16,000+ users...\"\n\t\t\t\t\t\t\t\t\tisLoading={isLoadingUsers}\n\t\t\t\t\t\t\t\t\tonSearchChange={setSearchQuery}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setUsername(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* MFA Policy Dropdown */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"mfa-policy\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tMFA Policy\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{isPoliciesLoading ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tLoading policies...\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policiesError ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#ef4444', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tError loading policies: {policiesError}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policies.length === 0 ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tNo MFA policies found. Please check your environment ID and worker token.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"mfa-policy\"\n\t\t\t\t\t\t\t\t\tvalue={selectedPolicy?.id || ''}\n\t\t\t\t\t\t\t\t\toptions={policyOptions}\n\t\t\t\t\t\t\t\t\tonChange={selectPolicy}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Select an MFA policy...\"\n\t\t\t\t\t\t\t\t\tisLoading={isPoliciesLoading}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tSelect the MFA policy to use for device registration\n\t\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t\t{/* Policy Summary - Collapsible */}\n\t\t\t\t\t\t\t{selectedPolicy && (\n\t\t\t\t\t\t\t\t<details\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<summary\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\tuserSelect: 'none',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüìã Policy Details\n\t\t\t\t\t\t\t\t\t</summary>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '12px', fontSize: '13px', color: '#4b5563' }}>\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Policy Name:</strong> {String(selectedPolicy.name)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedPolicy.default && (\n\t\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px', color: '#059669' }}>\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>‚úì Default Policy</strong>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Enabled Devices:</strong>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '6px' }}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'sms') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì± SMS\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'email') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t‚úâÔ∏è Email\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'totp') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîê TOTP\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'fido2') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîë FIDO2\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'mobile') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì≤ Mobile\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'voice') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüìû Voice\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</details>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Worker Token Status */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t\tpaddingRight: '16px',\n\t\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={setEnvironmentId}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* User Token Status */}\n\t\t\t\t\t\t\t{userToken && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\t'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05))',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #10b981',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '20px' }}>üë§</span>\n\t\t\t\t\t\t\t\t\t\t<strong style={{ color: '#047857', fontSize: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t\tUser Token Active\n\t\t\t\t\t\t\t\t\t\t</strong>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: '14px', color: '#059669', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t\t‚úì User authentication token available\n\t\t\t\t\t\t\t\t\t\t<br />‚úì Ready for User Flow device registration\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Flow Mode Selection */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',\n\t\t\t\t\t\t\tgap: '16px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Registration Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => setFlowMode('registration')}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>‚ûï</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#047857',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Registration\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tRegister a new MFA device for a user. Create SMS, Email, TOTP, Mobile Push,\n\t\t\t\t\t\t\t\t\t\tWhatsApp, or FIDO2 devices.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t{/* Authentication Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tif (!userToken) {\n\t\t\t\t\t\t\t\t\tsetShowAuthLoginModal(true);\n\t\t\t\t\t\t\t\t\ttoastV8.info('üîê Please complete user login before device authentication.', {\n\t\t\t\t\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-4px)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 8px 24px rgba(59, 130, 246, 0.2)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>üîì</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#1d4ed8',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Authentication\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tAuthenticate using an existing MFA device. Verify user identity with OTP, push\n\t\t\t\t\t\t\t\t\t\tnotification, or security key.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{showAuthLoginModal && (\n\t\t\t\t\t<UserLoginModalV8\n\t\t\t\t\t\tisOpen={showAuthLoginModal}\n\t\t\t\t\t\tonClose={() => setShowAuthLoginModal(false)}\n\t\t\t\t\t\tonTokenReceived={(token) => {\n\t\t\t\t\t\t\tsetUserToken(token);\n\t\t\t\t\t\t\tsetShowAuthLoginModal(false);\n\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tenvironmentId={authEnvIdForModal}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</>\n\t\t);\n\t}\n\n\t// Authentication flow - dedicated view (device selection + OTP modals only; no registration grid)\n\tif (flowMode === 'authentication') {\n\t\treturn (\n\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\tsetSelectedAuthDevice(null);\n\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t‚Üê Back\n\t\t\t\t\t</button>\n\t\t\t\t\t<h1\n\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t>\n\t\t\t\t\t\tüîì Device Authentication\n\t\t\t\t\t</h1>\n\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\t{selectedAuthDevice && !showOTPModal\n\t\t\t\t\t\t\t? `Authenticating with ${selectedAuthDevice.type} ‚Äî enter the code when prompted.`\n\t\t\t\t\t\t\t: `Select an MFA device to authenticate for ${username || 'the user'}`}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t\t{!showDeviceSelectionModal && !showOTPModal && (\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowDeviceSelectionModal(true)}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tSelect MFA device\n\t\t\t\t\t</button>\n\t\t\t\t)}\n\t\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\t\tonClose={() => {\n\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t// Keep flowMode so user stays in auth flow; only clear if they click Back\n\t\t\t\t\t}}\n\t\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\t\tusername={username}\n\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t/>\n\t\t\t\t{showOTPModal && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.6)',\n\t\t\t\t\t\t\tbackdropFilter: 'blur(4px)',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t\t\tanimation: 'fadeIn 0.2s ease-out',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t{`\n\t\t\t\t\t\t\t@keyframes fadeIn {\n\t\t\t\t\t\t\t\tfrom { opacity: 0; }\n\t\t\t\t\t\t\t\tto { opacity: 1; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes slideUp {\n\t\t\t\t\t\t\t\tfrom { \n\t\t\t\t\t\t\t\t\topacity: 0;\n\t\t\t\t\t\t\t\t\ttransform: translateY(20px); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tto { \n\t\t\t\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t\t\t\t\ttransform: translateY(0); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes pulse {\n\t\t\t\t\t\t\t\t0%, 100% { opacity: 1; }\n\t\t\t\t\t\t\t\t50% { opacity: 0.5; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`}\n\t\t\t\t\t\t</style>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\tborderRadius: '24px',\n\t\t\t\t\t\t\t\tpadding: '48px 40px',\n\t\t\t\t\t\t\t\tmaxWidth: '480px',\n\t\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\t\tboxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',\n\t\t\t\t\t\t\t\tanimation: 'slideUp 0.3s ease-out',\n\t\t\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Logo Area */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '32px' }}>\n\t\t\t\t\t\t\t\t{customLogoUrl ? (\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\t\talt=\"Organization logo\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '120px',\n\t\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonError={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\t// Fallback to default icon if image fails to load\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.display = 'none';\n\t\t\t\t\t\t\t\t\t\t\t\tconst fallback = document.createElement('div');\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.style.cssText = `\n\t\t\t\t\t\t\t\t\t\t\t\twidth: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\theight: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: 0 auto 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: center;\n\t\t\t\t\t\t\t\t\t\t\t\tjustifyContent: center;\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: 36px;\n\t\t\t\t\t\t\t\t\t\t\t\tboxShadow: 0 10px 25px rgba(102, 126, 234, 0.3);\n\t\t\t\t\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.textContent = 'üîê';\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.parentElement!.appendChild(fallback);\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\theight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto 20px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '20px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '36px',\n\t\t\t\t\t\t\t\t\t\t\tboxShadow: '0 10px 25px rgba(102, 126, 234, 0.3)',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüîê\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tVerification Code\n\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\tEnter the 6-digit code sent to your <strong>{selectedAuthDevice?.type}</strong>{' '}\n\t\t\t\t\t\t\t\t\tdevice\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* OTP Input */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\t\t\tplaceholder=\"‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢\"\n\t\t\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tletterSpacing: '12px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow: otpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{otpCode.length > 0 && otpCode.length < 6 && (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\t\tanimation: 'pulse 2s ease-in-out infinite',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{6 - otpCode.length} more digit{6 - otpCode.length !== 1 ? 's' : ''} needed\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Resend Code Button */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={async () => {\n\t\t\t\t\t\t\t\t\t\tif (!selectedAuthDevice || !authenticationId) return;\n\t\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.info('Resending verification code...');\n\t\t\t\t\t\t\t\t\t\t\t// Re-initialize authentication to resend code\n\t\t\t\t\t\t\t\t\t\t\tconst response =\n\t\t\t\t\t\t\t\t\t\t\t\tawait MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\t\t\t\t\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\t\t\t\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicy?.id || '',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceId: selectedAuthDevice.id,\n\t\t\t\t\t\t\t\t\t\t\t\t\tregion: 'na',\n\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tif (response.status?.toUpperCase() === 'OTP_REQUIRED') {\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('New code sent to your device!');\n\t\t\t\t\t\t\t\t\t\t\t\tsetAuthenticationId(response.id);\n\t\t\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to resend code');\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Resend error:', error);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tcolor: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'transparent';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚Üª Resend Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Action Buttons */}\n\t\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#d1d5db';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f9fafb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'white';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6\n\t\t\t\t\t\t\t\t\t\t\t\t? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '#d1d5db',\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (otpCode.length === 6) {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚úì Verify Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Help Text */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<strong style={{ color: '#111827' }}>Didn't receive the code?</strong>\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\tCheck your spam folder or click \"Resend Code\" above\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t);\n\t}\n\n\t// Registration flow - show device type selection cards\n\treturn (\n\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t{/* Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #10b981 0%, #047857 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => setFlowMode(null)}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t‚Üê Back\n\t\t\t\t</button>\n\t\t\t\t<h1 style={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}>\n\t\t\t\t\t‚ûï Register MFA Device\n\t\t\t\t</h1>\n\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\tSelect a device type to register for {username || 'the user'}\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Device Type Cards */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',\n\t\t\t\t\tgap: '16px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t{DEVICE_TYPES.map((device) => {\n\t\t\t\t\tconst enabled = isDeviceEnabled(device.key);\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tkey={device.key}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => enabled && onSelectDeviceType(device.key)}\n\t\t\t\t\t\t\tdisabled={!enabled}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tbackground: enabled ? '#ffffff' : '#f9fafb',\n\t\t\t\t\t\t\t\tborder: `2px solid ${enabled ? '#e5e7eb' : '#f3f4f6'}`,\n\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\tcursor: enabled ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\topacity: enabled ? 1 : 0.5,\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#10b981';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ecfdf5';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>{device.icon}</span>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{device.name}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280' }}>{device.description}</p>\n\t\t\t\t\t\t\t{!enabled && (\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '12px', color: '#9ca3af' }}>\n\t\t\t\t\t\t\t\t\t(Not enabled)\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</div>\n\n\t\t\t{/* Device Selection Modal for Authentication */}\n\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t}}\n\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\tusername={username}\n\t\t\t\tenvironmentId={environmentId}\n\t\t\t/>\n\n\t\t\t{/* OTP Modal for Authentication */}\n\t\t\t{showOTPModal && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '400px',\n\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\tboxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '600' }}>\n\t\t\t\t\t\t\tEnter Verification Code\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '0 0 20px 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tCheck your {selectedAuthDevice?.type} device for the code\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\tplaceholder=\"000000\"\n\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 16px',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\tletterSpacing: '8px',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tmarginBottom: '20px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: otpCode.length === 6 ? '#3b82f6' : '#9ca3af',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tVerify\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Wrapper Component\n *\n * Wraps the content with MFACredentialProvider to provide global credential state\n */\nexport const UnifiedMFARegistrationFlowV8: React.FC<UnifiedMFARegistrationFlowV8Props> = (\n\tprops\n) => {\n\tconst location = useLocation();\n\n\t// Get device type from props or location state (can be undefined)\n\tconst initialDeviceType =\n\t\tprops.deviceType || (location.state as { deviceType?: DeviceConfigKey })?.deviceType;\n\n\t// State for selected device type (allows user to select if not provided)\n\tconst [selectedDeviceType, setSelectedDeviceType] = useState<DeviceConfigKey | undefined>(\n\t\tinitialDeviceType\n\t);\n\n\t// User token state for OAuth authentication (User Flow)\n\tconst [userToken, setUserToken] = useState<string | null>(() => {\n\t\t// Check if we already have a user token from previous OAuth flow\n\t\tconst savedCreds = CredentialsServiceV8.loadCredentials('user-login-v8', {\n\t\t\tflowKey: 'user-login-v8',\n\t\t\tflowType: 'oauth',\n\t\t\tincludeClientSecret: false,\n\t\t\tincludeRedirectUri: false,\n\t\t\tincludeLogoutUri: false,\n\t\t\tincludeScopes: false,\n\t\t});\n\t\treturn savedCreds?.accessToken || null;\n\t});\n\n\t// If no device type selected, show device type selection screen\n\tif (!selectedDeviceType) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<MFAHeaderV8\n\t\t\t\t\ttitle=\"MFA Unified Flow\"\n\t\t\t\t\tdescription=\"Register or authenticate MFA devices\"\n\t\t\t\t\tversionTag=\"V8\"\n\t\t\t\t\tcurrentPage=\"registration\"\n\t\t\t\t\tshowBackToMain={true}\n\t\t\t\t\theaderColor=\"pingRed\"\n\t\t\t\t/>\n\t\t\t\t<GlobalMFAProvider>\n\t\t\t\t\t<MFACredentialProvider>\n\t\t\t\t\t\t<DeviceTypeSelectionScreen\n\t\t\t\t\t\t\tonSelectDeviceType={setSelectedDeviceType}\n\t\t\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</MFACredentialProvider>\n\t\t\t\t</GlobalMFAProvider>\n\t\t\t\t{/* API display (bottom of page) */}\n\t\t\t\t<div style={{ marginTop: '24px' }}>\n\t\t\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\t\t\t\t</div>\n\t\t\t</>\n\t\t);\n\t}\n\n\treturn (\n\t\t<GlobalMFAProvider>\n\t\t\t<MFACredentialProvider>\n\t\t\t\t<UnifiedMFARegistrationFlowContent\n\t\t\t\t\t{...props}\n\t\t\t\t\tdeviceType={selectedDeviceType}\n\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t/>\n\t\t\t</MFACredentialProvider>\n\t\t</GlobalMFAProvider>\n\t);\n};\n\n// ============================================================================\n// CONTENT COMPONENT (MAIN LOGIC)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Content Component\n *\n * Contains the actual flow logic and integrates with:\n * - MFACredentialContext (global credential state)\n * - useWorkerToken hook (token status and auto-refresh)\n * - deviceFlowConfigs (device-specific configuration)\n * - MFAFlowBaseV8 (5-step framework)\n */\nconst UnifiedMFARegistrationFlowContent: React.FC<\n\tRequired<Pick<UnifiedMFARegistrationFlowV8Props, 'deviceType'>> &\n\t\tOmit<UnifiedMFARegistrationFlowV8Props, 'deviceType'> & {\n\t\t\tuserToken: string | null;\n\t\t\tsetUserToken: (token: string | null) => void;\n\t\t}\n> = ({ deviceType, onCancel, userToken, setUserToken }) => {\n\t// ========================================================================\n\t// CONFIGURATION\n\t// ========================================================================\n\n\t// React Router navigation\n\tconst navigate = useNavigate();\n\n\t// Load device-specific configuration\n\tconst config = useMemo(() => {\n\t\treturn getDeviceConfig(deviceType);\n\t}, [deviceType]);\n\n\t// ========================================================================\n\t// USER FLOW OAUTH STATE\n\t// ========================================================================\n\n\t// State for User Login Modal (OAuth authentication for User Flow)\n\tconst [showUserLoginModal, setShowUserLoginModal] = useState(false);\n\tconst [showUserTokenSuccess, setShowUserTokenSuccess] = useState(false);\n\tconst [userTokenForDisplay, setUserTokenForDisplay] = useState<string>('');\n\tconst [usernameFromToken, setUsernameFromToken] = useState<string>('');\n\tconst [showUsernameDropdown, setShowUsernameDropdown] = useState(false);\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\tconst envIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Pending registration data while waiting for OAuth (use ref to avoid stale closure)\n\tconst pendingRegistrationRef = useRef<{\n\t\tdeviceType: DeviceConfigKey;\n\t\tfields: Record<string, string>;\n\t\tflowType: string;\n\t\tprops: MFAFlowBaseRenderProps;\n\t} | null>(null);\n\n\t// Worker token state for validation in registration flow\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Detect OAuth callback and re-open modal if needed\n\tuseEffect(() => {\n\t\tconst urlParams = new URLSearchParams(window.location.search);\n\t\tconst code = urlParams.get('code');\n\t\tconst hasStoredState = sessionStorage.getItem('user_login_state_v8');\n\n\t\t// If we have OAuth callback params and stored state, re-open the modal to process callback\n\t\t// But only if we don't already have a user token (to prevent reopening after silent auth)\n\t\tif (code && hasStoredState && !showUserLoginModal && !userToken) {\n\t\t\tconsole.log('[UNIFIED-FLOW] OAuth callback detected - re-opening modal to process');\n\t\t\tsetShowUserLoginModal(true);\n\t\t}\n\t}, [showUserLoginModal, userToken]);\n\n\t// ========================================================================\n\t// STEP VALIDATION\n\t// ========================================================================\n\n\t/**\n\t * Validate Step 0 (Configuration)\n\t */\n\tconst validateStep0 = useCallback(\n\t\t(\n\t\t\tcredentials: MFACredentials,\n\t\t\ttoken: TokenStatusInfo,\n\t\t\tnavigation: ReturnType<typeof useStepNavigationV8>\n\t\t) => {\n\t\t\t// Always check for valid worker token (required for MFA device operations)\n\t\t\tif (!token.isValid) {\n\t\t\t\tnavigation.setValidationErrors(['Invalid or expired worker token']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Check required configuration\n\t\t\tif (!credentials.environmentId || !credentials.username) {\n\t\t\t\tnavigation.setValidationErrors(['Environment ID and Username are required']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\t\t[]\n\t);\n\n\t// ========================================================================\n\t// STEP RENDERERS\n\t// ========================================================================\n\n\t/**\n\t * Perform device registration API call (with token already available)\n\t */\n\tconst performRegistrationWithToken = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string,\n\t\t\ttoken?: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== PERFORM REGISTRATION WITH TOKEN =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Token:', token ? `Present (${token.length} chars)` : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setIsLoading available:', typeof props.setIsLoading);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setCredentials available:', typeof props.setCredentials);\n\n\t\t\ttry {\n\t\t\t\tprops.setIsLoading(true);\n\n\t\t\t\t// Update credentials with device fields and user token if provided\n\t\t\t\tprops.setCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tflowType, // Store flowType so activation step knows if OTP is required\n\t\t\t\t\t...fields,\n\t\t\t\t\t...(flowType === 'user' && token\n\t\t\t\t\t\t? { userToken: token, tokenType: 'user' }\n\t\t\t\t\t\t: flowType !== 'user'\n\t\t\t\t\t\t\t? { tokenType: 'worker' }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t}));\n\n\t\t\t\t// Register the device using proper API call\n\t\t\t\t// CRITICAL: Flow-specific device status\n\t\t\t\t// - Admin flow: ACTIVE (no OTP sent, device ready immediately)\n\t\t\t\t// - Admin ACTIVATION_REQUIRED: ACTIVATION_REQUIRED (sends OTP for admin to activate)\n\t\t\t\t// - User flow: ACTIVATION_REQUIRED (sends OTP for user to activate)\n\t\t\t\t// - FIDO2: ACTIVE (WebAuthn verification happens during registration)\n\t\t\t\tlet deviceStatus: 'ACTIVE' | 'ACTIVATION_REQUIRED' | undefined;\n\n\t\t\t\t// Determine device status based on flow type (applies to all device types including FIDO2)\n\t\t\t\tif (flowType === 'admin-active') {\n\t\t\t\t\tdeviceStatus = 'ACTIVE';\n\t\t\t\t} else if (flowType === 'admin-activation') {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED';\n\t\t\t\t} else {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED'; // user flow\n\t\t\t\t}\n\n\t\t\t\t// Special note for FIDO2: WebAuthn verification proves device works,\n\t\t\t\t// but we still respect the flow type for status determination\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t'[UNIFIED-FLOW] FIDO2 device - status determined by flow type:',\n\t\t\t\t\t\tdeviceStatus\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device status determined:', {\n\t\t\t\t\tflowType,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tdeviceStatus,\n\t\t\t\t\totpWillBeSent: deviceStatus === 'ACTIVATION_REQUIRED',\n\t\t\t\t\treason:\n\t\t\t\t\t\tselectedDeviceType === 'FIDO2'\n\t\t\t\t\t\t\t? 'FIDO2 - ACTIVE after WebAuthn verification'\n\t\t\t\t\t\t\t: 'User flow - OTP required for activation',\n\t\t\t\t});\n\n\t\t\t\t// Use same parameter construction as working MFA flows\n\t\t\t\ttype RegisterDeviceParamsWithToken = RegisterDeviceParams & {\n\t\t\t\t\ttokenType?: 'worker' | 'user';\n\t\t\t\t\tuserToken?: string | undefined;\n\t\t\t\t};\n\t\t\t\tlet baseParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\tenvironmentId: props.credentials.environmentId,\n\t\t\t\t\tusername: props.credentials.username,\n\t\t\t\t\ttype: selectedDeviceType,\n\t\t\t\t};\n\t\t\t\t// Per rightTOTP.md: Pass token type and user token if available\n\t\t\t\tif (flowType === 'user' && token) {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'user',\n\t\t\t\t\t\tuserToken: token,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'worker',\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Always include status for all device types\n\t\t\t\t// FIDO2: Set to ACTIVE since WebAuthn verification proves device works\n\t\t\t\t// Other devices: Set based on flow type (admin-active = ACTIVE, others = ACTIVATION_REQUIRED)\n\t\t\t\tif (deviceStatus !== undefined) {\n\t\t\t\t\tbaseParams.status = deviceStatus;\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registration base params:', {\n\t\t\t\t\tenvironmentId: baseParams.environmentId,\n\t\t\t\t\tusername: baseParams.username,\n\t\t\t\t\ttype: baseParams.type,\n\t\t\t\t\ttokenType: baseParams.tokenType,\n\t\t\t\t\tstatus: baseParams.status,\n\t\t\t\t\tflowType,\n\t\t\t\t});\n\n\t\t\t\t// Map form field names to API field names\n\t\t\t\t// Form uses 'deviceName' but API expects 'nickname' or 'name'\n\t\t\t\tconst mappedFields: Record<string, string> = { ...fields };\n\t\t\t\tif (mappedFields.deviceName) {\n\t\t\t\t\tmappedFields.nickname = mappedFields.deviceName;\n\t\t\t\t\tmappedFields.name = mappedFields.deviceName;\n\t\t\t\t\tdelete mappedFields.deviceName;\n\t\t\t\t}\n\n\t\t\t\t// Format phone number for SMS/WhatsApp devices\n\t\t\t\t// Form sends: { phoneNumber: '9725231586', countryCode: '+1' }\n\t\t\t\t// API expects: { phone: '+1.9725231586' }\n\t\t\t\tif (mappedFields.phoneNumber && mappedFields.countryCode) {\n\t\t\t\t\tconst countryCode = mappedFields.countryCode.replace('+', ''); // Remove + for formatting\n\t\t\t\t\tconst phoneNumber = mappedFields.phoneNumber.replace(/\\D/g, ''); // Remove non-digits\n\t\t\t\t\tmappedFields.phone = `+${countryCode}.${phoneNumber}`;\n\t\t\t\t\tconsole.log('[UNIFIED-FLOW] Formatted phone:', mappedFields.phone);\n\t\t\t\t\tdelete mappedFields.phoneNumber;\n\t\t\t\t\tdelete mappedFields.countryCode;\n\t\t\t\t}\n\n\t\t\t\t// Include device-specific fields (phone, email, etc.)\n\t\t\t\tconst deviceParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\t...baseParams,\n\t\t\t\t\t...mappedFields,\n\t\t\t\t\t// Include policy for TOTP devices (required for secret and keyUri to be returned)\n\t\t\t\t\t...(selectedDeviceType === 'TOTP' && selectedPolicyRef.current\n\t\t\t\t\t\t? { policy: selectedPolicyRef.current.id }\n\t\t\t\t\t\t: {}),\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registering device with params:', deviceParams);\n\n\t\t\t\tconst result = await MFAServiceV8_Legacy.registerDevice(deviceParams);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device registered:', result);\n\n\t\t\t\t// Update MFA state with device info\n\t\t\t\tconst registrationResult = result as unknown as Record<string, unknown>;\n\n\t\t\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result for TOTP:', {\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\tqrCode: registrationResult.qrCode,\n\t\t\t\t\t\tqrCodeUrl: registrationResult.qrCodeUrl,\n\t\t\t\t\t\tsecret: registrationResult.secret,\n\t\t\t\t\t\ttotpSecret: registrationResult.totpSecret,\n\t\t\t\t\t\tfullResult: result,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// ===============================================\n\n\t\t\t\t// Clear stored registration data after successful use\n\t\t\t\tlocalStorage.removeItem('mfa_registration_flow_type');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_fields');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_device_type');\n\n\t\t\t\tprops.setMfaState((prev) => {\n\t\t\t\t\t// TOTP: QR code will be rendered by QRCodeSVG component in UnifiedActivationStep\n\t\t\t\t\t// No need to generate QR code data URL here - just pass the keyUri\n\t\t\t\t\tconst newState: MFAState = {\n\t\t\t\t\t\t...prev,\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tdeviceStatus: result.status,\n\t\t\t\t\t\t...(registrationResult.deviceActivateUri\n\t\t\t\t\t\t\t? { deviceActivateUri: String(registrationResult.deviceActivateUri) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'TOTP'\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\ttotpSecret: String(registrationResult.secret || ''),\n\t\t\t\t\t\t\t\t\tkeyUri: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tqrCodeUrl: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tshowQr: !!(registrationResult.secret || registrationResult.keyUri),\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'FIDO2' &&\n\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tpublicKeyCredentialCreationOptions:\n\t\t\t\t\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions,\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'MOBILE' && registrationResult.pairingKey\n\t\t\t\t\t\t\t? { pairingKey: String(registrationResult.pairingKey) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t};\n\n\t\t\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\t\t\tfullState: newState,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t// ================================================\n\n\t\t\t\t\treturn newState;\n\t\t\t\t});\n\n\t\t\t\t// FIDO2: Check if we already have credential data (from WebAuthn modal)\n\t\t\t\t// If credentialId and publicKey are present, registration is complete\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tif (fields.credentialId && fields.publicKey) {\n\t\t\t\t\t\t// WebAuthn already completed via modal - device fully registered\n\n\t\t\t\t\t\t// Admin Flow: Show QR but skip OTP validation - device ready immediately\n\t\t\t\t\t\t// Admin ACTIVATION_REQUIRED & User Flow: Show QR and require OTP validation\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tflowType === 'admin-active' ||\n\t\t\t\t\t\t\tflowType === 'admin-activation' ||\n\t\t\t\t\t\t\tresult.status === 'ACTIVE'\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t'[UNIFIED-FLOW] Admin flow or ACTIVE status - proceeding to show QR without OTP requirement'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered successfully!${flowType === 'admin-active' || flowType === 'admin-activation' ? ' Device is ready to use.' : ''}`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t// For Admin Flow, go to API docs page instead of OTP page\n\t\t\t\t\t\t\t// For User Flow, go to User Login step (Step 1)\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (result.status === 'ACTIVATION_REQUIRED') {\n\t\t\t\t\t\t\t// Device requires activation - PingOne automatically sends OTP\n\t\t\t\t\t\t\t// This applies to both admin_activation_required and user flow\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered! OTP has been sent automatically.`\n\t\t\t\t\t\t\t);\n  // DO NOT auto-advance for OTP-required devices\n\t\t\t\t\t\t\t// User should manually click Next after receiving OTP\n\t\t\t\t\t\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation - waiting for user to proceed manually`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Unknown status, proceed with flow-specific navigation\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} // End of FIDO2 section\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Registration failed:', error);\n\t\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Device registration failed';\n\n\t\t\t\t// Check if error is due to too many devices\n\t\t\t\tif (errorMessage.includes('Too many devices')) {\n\t\t\t\t\ttoastV8.error(\n\t\t\t\t\t\t`${errorMessage}\\n\\n‚ÑπÔ∏è You can manage your devices at:\\nhttps://localhost:3000/v8/delete-all-devices`,\n\t\t\t\t\t\t{ duration: 8000 }\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\ttoastV8.error(errorMessage);\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tprops.setIsLoading(false);\n\t\t\t}\n\t\t},\n\t\t[config.displayName, toastV8]\n\t);\n\n\t/**\n\t * Handle user token received from OAuth flow\n\t */\n\tconst handleUserTokenReceived = useCallback(\n\t\t(token: string) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== USER TOKEN RECEIVED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Token length:', token.length);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current pending registration:', pendingRegistrationRef.current);\n\n\t\t\tsetUserToken(token);\n\t\t\tsetUserTokenForDisplay(token);\n\n\t\t\t// Decode JWT to extract username\n\t\t\ttry {\n\t\t\t\tconst base64Url = token.split('.')[1];\n\t\t\t\tconst base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n\t\t\t\tconst jsonPayload = decodeURIComponent(\n\t\t\t\t\tatob(base64)\n\t\t\t\t\t\t.split('')\n\t\t\t\t\t\t.map((c) => `%${`00${c.charCodeAt(0).toString(16)}`.slice(-2)}`)\n\t\t\t\t\t\t.join('')\n\t\t\t\t);\n\t\t\t\tconst payload = JSON.parse(jsonPayload);\n\t\t\t\tconst username =\n\t\t\t\t\tpayload.username || payload.preferred_username || payload.sub || 'Unknown User';\n\t\t\t\tsetUsernameFromToken(username);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Extracted username:', username);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Failed to decode JWT:', error);\n\t\t\t\tsetUsernameFromToken('Unknown User');\n\t\t\t}\n\n\t\t\t// If we have pending registration, show success page first\n\t\t\tconst pending = pendingRegistrationRef.current;\n\t\t\tif (pending) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Found pending registration, showing success page first...');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending data:', {\n\t\t\t\t\tdeviceType: pending.deviceType,\n\t\t\t\t\tflowType: pending.flowType,\n\t\t\t\t\thasProps: !!pending.props,\n\t\t\t\t\thasFields: !!pending.fields,\n\t\t\t\t});\n\n\t\t\t\ttoastV8.success('‚úÖ Authentication successful! Your user token is ready.', {\n\t\t\t\t\tduration: 4000,\n\t\t\t\t});\n\n\t\t\t\t// Close login modal and show success page\n\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\tsetShowUserTokenSuccess(true);\n\t\t\t} else {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] WARNING: No pending registration found after OAuth!');\n\t\t\t}\n\t\t},\n\t\t[setUserToken]\n\t);\n\n\t/**\n\t * Handle continue from user token success page\n\t */\n\tconst handleContinueAfterUserLogin = useCallback(() => {\n\t\tconsole.log(\n\t\t\t'[UNIFIED-FLOW] User clicked continue after login, proceeding with registration...'\n\t\t);\n\n\t\tconst pending = pendingRegistrationRef.current;\n\t\tif (pending && userToken) {\n\t\t\tconst { deviceType: pendingDeviceType, fields, flowType, props } = pending;\n\t\t\tpendingRegistrationRef.current = null;\n\n\t\t\t// Hide success page\n\t\t\tsetShowUserTokenSuccess(false);\n\n\t\t\t// Continue with registration\n\t\t\tsetTimeout(() => {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Now executing performRegistrationWithToken...');\n\t\t\t\tperformRegistrationWithToken(props, pendingDeviceType, fields, flowType, userToken);\n\t\t\t}, 100);\n\t\t}\n\t}, [userToken, performRegistrationWithToken]);\n\n\t/**\n\t * Perform device registration API call\n\t * Checks if User Flow needs OAuth first, otherwise proceeds with registration\n\t */\n\tconst performRegistration = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== DEVICE REGISTRATION SUBMITTED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current userToken:', userToken ? 'Present' : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\n\t\t\t// CRITICAL: Validate worker token before allowing any registration\n\t\t\tif (!workerToken.tokenStatus.isValid) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Cannot proceed - no valid worker token');\n\t\t\t\ttoastV8.error(\n\t\t\t\t\t'‚ùå Worker token required for device registration. Please configure worker token credentials first.',\n\t\t\t\t\t{\n\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// For User Flow, check if we need OAuth authentication first\n\t\t\tif (flowType === 'user' && !userToken) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] User flow selected but no token - showing OAuth modal');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Storing pending registration...');\n\n\t\t\t\t// Store pending registration data\n\t\t\t\tpendingRegistrationRef.current = {\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tfields,\n\t\t\t\t\tflowType,\n\t\t\t\t\tprops,\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending registration stored:', pendingRegistrationRef.current);\n\n\t\t\t\t// Set return target for device registration flow\n\t\t\t\tReturnTargetServiceV8U.setReturnTarget(\n\t\t\t\t\t'mfa_device_registration',\n\t\t\t\t\t'/v8/unified-mfa',  // Return to unified MFA flow\n\t\t\t\t\t2  // Step 2: Device Selection\n\t\t\t\t);\n\n\t\t\t\t// Show the user login modal\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'üîê User Flow requires PingOne authentication. Please complete the login to continue with device registration.',\n\t\t\t\t\t{ duration: 6000 }\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t'[UNIFIED-FLOW] Proceeding directly with registration (token exists or admin flow)'\n\t\t\t);\n\t\t\t// Proceed with registration (using existing token for user flow)\n\t\t\tawait performRegistrationWithToken(\n\t\t\t\tprops,\n\t\t\t\tselectedDeviceType,\n\t\t\t\tfields,\n\t\t\t\tflowType,\n\t\t\t\tuserToken || undefined\n\t\t\t);\n\t\t},\n\t\t[workerToken.tokenStatus.isValid, userToken]\n\t);\n\n\t/**\n\t * Render Step 0: Configuration (environment, user, policy)\n\t */\n\tconst renderStep0 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn (\n\t\t\t\t<UnifiedDeviceRegistrationForm\n\t\t\t\t\tinitialDeviceType={deviceType}\n\t\t\t\t\tonSubmit={async (selectedDeviceType, fields, flowType) => {\n\t\t\t\t\t\tawait performRegistration(props, selectedDeviceType, fields, flowType);\n\t\t\t\t\t}}\n\t\t\t\t\tonCancel={() => {\n\t\t\t\t\t\tif (onCancel) onCancel();\n\t\t\t\t\t}}\n\t\t\t\t\ttokenStatus={props.tokenStatus}\n\t\t\t\t\tusername={props.credentials.username}\n\t\t\t\t/>\n\t\t\t);\n\t\t},\n\t\t[deviceType, onCancel, performRegistration]\n\t);\n\n\t/**\n\t * Render Step 1: User Login using Authorization Code Flow with PKCE\n\t */\n\tconst renderStep1 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <UserLoginStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 2: Device Selection (option to call registration if want new device, or have no devices)\n\t */\n\tconst renderStep2 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 3: Device-Specific Actions (OTP/QR Generation, FIDO, Mobile Push)\n\t */\n\tconst renderStep3 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific based on the device type\n\t\t\t// For now, return the activation step which handles device-specific logic\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 4: OTP Validation / Confirmation\n\t */\n\tconst renderStep4 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific validation\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 5: API Documentation\n\t */\n\tconst renderStep5 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <APIDocsStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 6: Success screen with all user data and other valuable options\n\t */\n\tconst renderStep6 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <SuccessStepV8 renderProps={props} />;\n\t}, []);\n\n\t// Step labels for device authentication flow\n\tconst stepLabels = useMemo(() => {\n\t\tif (deviceType === 'FIDO2') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Start FIDO in Browser',\n\t\t\t\t'Passkey confirmation',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else if (deviceType === 'MOBILE') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Push to Mobile App',\n\t\t\t\t'User Confirms on Mobile',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else {\n\t\t\t// SMS, Email, TOTP, WhatsApp\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Generate OTP/QR',\n\t\t\t\t'Validate OTP',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t}\n\t}, [deviceType]);\n\n\tconst shouldHideNextButton = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\tif (props.nav.currentStep === 0) {\n\t\t\treturn true; // Hide Next button on configuration step, use form submit\n\t\t}\n\t\tif (props.nav.currentStep === 1) {\n\t\t\treturn true; // Hide Next button on user login step, use authentication button\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\treturn (\n\t\t<>\n\t\t\t<MFAFlowBaseV8\n\t\t\t\tdeviceType={deviceType}\n\t\t\t\trenderStep0={renderStep0}\n\t\t\t\trenderStep1={renderStep1}\n\t\t\t\trenderStep2={renderStep2}\n\t\t\t\trenderStep3={renderStep3}\n\t\t\t\trenderStep4={renderStep4}\n\t\t\t\trenderStep5={renderStep5}\n\t\t\t\trenderStep6={renderStep6}\n\t\t\t\tvalidateStep0={validateStep0}\n\t\t\t\tstepLabels={stepLabels}\n\t\t\t\tshouldHideNextButton={shouldHideNextButton}\n\t\t\t\tflowType=\"device-auth\"\n\t\t\t/>\n\t\t\t<div style={{ height: '300px' }} />\n\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\n\t\t\t{/* User Login Modal for User Flow OAuth */}\n\t\t\t<UserLoginModalV8\n\t\t\t\tisOpen={showUserLoginModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\t\tpendingRegistrationRef.current = null;\n\t\t\t\t}}\n\t\t\t\tonTokenReceived={handleUserTokenReceived}\n\t\t\t\tenvironmentId={envIdForModal}\n\t\t\t/>\n\n\t\t\t{/* User Token Success Page - Show token after OAuth login */}\n\t\t\t{showUserTokenSuccess && userTokenForDisplay && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 10000,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\t\t\tboxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Success Header */}\n\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\twidth: '64px',\n\t\t\t\t\t\t\t\t\theight: '64px',\n\t\t\t\t\t\t\t\t\tborderRadius: '50%',\n\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>‚úÖ</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<h2 style={{ margin: '0 0 8px 0', fontSize: '24px', color: '#1f2937' }}>\n\t\t\t\t\t\t\t\tAuthentication Successful!\n\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\tYour user token has been obtained and is ready to use.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Username Dropdown */}\n\t\t\t\t\t\t{usernameFromToken && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUsernameDropdown(!showUsernameDropdown)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tpadding: 0,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: showUsernameDropdown ? '12px' : 0,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '16px', color: '#374151' }}>Username</h3>\n\t\t\t\t\t\t\t\t\t{showUsernameDropdown ? (\n\t\t\t\t\t\t\t\t\t\t<FiChevronUp size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t<FiChevronDown size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{showUsernameDropdown && (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{usernameFromToken}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(usernameFromToken);\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('Username copied to clipboard!');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüìã Copy Username\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Token Display */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<h3 style={{ margin: '0 0 12px 0', fontSize: '16px', color: '#374151' }}>\n\t\t\t\t\t\t\t\tUser Access Token\n\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{userTokenForDisplay}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(userTokenForDisplay);\n\t\t\t\t\t\t\t\t\ttoastV8.success('Token copied to clipboard!');\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüìã Copy Token\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Next Steps Info */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#eff6ff',\n\t\t\t\t\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#1e40af', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t<strong>Next:</strong> Click \"Continue with Registration\" to proceed with your{' '}\n\t\t\t\t\t\t\t\t{config.displayName} device registration using this user token.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Continue Button */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleContinueAfterUserLogin}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\tbackground: '#10b981',\n\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tboxShadow: '0 2px 8px rgba(16, 185, 129, 0.3)',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tContinue with Registration ‚Üí\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</>\n\t);\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default UnifiedMFARegistrationFlowV8;\n"}},{"log":["info",[{"elements":[],"content":"React relies on hook dependencies to determine when to re-compute Effects.\nFailing to specify dependencies can result in Effects "},{"elements":["Emphasis"],"content":"not updating correctly"},{"elements":[],"content":" when state changes.\nThese \"stale closures\" are a common source of surprising bugs."}]]},{"log":["info",[{"elements":[],"content":"Unsafe fix: Add the missing dependency to the list."}]]},{"diff":{"dictionary":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\t\t\t\tuserToken || undefined\n\t\t\t);\n\t\t},\n\t\t[workerToken.tokenStatus.isValid, userToken, performRegistrationWithToken]\n\t);\n\nexport default UnifiedMFARegistrationFlowV8;\n","ops":[{"diffOp":{"equal":{"range":[0,73]}}},{"equalLines":{"line_count":2485}},{"diffOp":{"equal":{"range":[73,110]}}},{"diffOp":{"equal":{"range":[110,156]}}},{"diffOp":{"insert":{"range":[156,186]}}},{"diffOp":{"equal":{"range":[186,187]}}},{"diffOp":{"equal":{"range":[187,192]}}},{"equalLines":{"line_count":370}},{"diffOp":{"equal":{"range":[192,238]}}}]}}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/UnifiedMFARegistrationFlowV8_Legacy.tsx"},"span":[78109,78120],"sourceCode":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\n * @description Unified MFA Registration Flow - Single component for all 6 device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Replace 6 device-specific flow components (SMS, Email, Mobile, WhatsApp, TOTP, FIDO2)\n * with a single configurable component using deviceFlowConfigs for device-specific behavior.\n *\n * Architecture:\n * - Configuration-driven using deviceFlowConfigs.ts\n * - Dynamic form rendering for simple devices (SMS, Email, WhatsApp)\n * - Custom components for complex devices (TOTP, FIDO2, Mobile)\n * - Integrates with MFACredentialContext and useWorkerToken hook\n * - Uses existing MFAFlowBaseV8 for 5-step framework\n *\n * @example\n * <UnifiedMFARegistrationFlowV8\n *   deviceType=\"SMS\"\n *   onSuccess={(result) => console.log('Device registered:', result.deviceId)}\n * />\n */\n\nimport * as React from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { FiChevronDown, FiChevronUp } from 'react-icons/fi';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { MFAHeaderV8 } from '@/v8/components/MFAHeaderV8';\nimport type { SearchableDropdownOption } from '@/v8/components/SearchableDropdownV8';\nimport { SearchableDropdownV8 } from '@/v8/components/SearchableDropdownV8';\nimport { SQLiteStatsDisplayV8 } from '@/v8/components/SQLiteStatsDisplayV8';\nimport { SuperSimpleApiDisplayV8 } from '@/v8/components/SuperSimpleApiDisplayV8';\nimport { UserLoginModalV8 } from '@/v8/components/UserLoginModalV8';\nimport { getDeviceConfig } from '@/v8/config/deviceFlowConfigs';\nimport type { DeviceConfigKey, DeviceRegistrationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport { PING_IDENTITY_COLORS } from '@/v8/constants/pingIdentityColors';\nimport { GlobalMFAProvider } from '@/v8/contexts/GlobalMFAContext';\nimport { MFACredentialProvider } from '@/v8/contexts/MFACredentialContext';\nimport { APIDocsStepV8 } from '@/v8/flows/shared/APIDocsStepV8';\nimport { SuccessStepV8 } from '@/v8/flows/shared/SuccessStepV8';\nimport { UserLoginStepV8 } from '@/v8/flows/shared/UserLoginStepV8';\nimport { useMFAPolicies } from '@/v8/hooks/useMFAPolicies';\nimport { useStepNavigationV8 } from '@/v8/hooks/useStepNavigationV8';\nimport { useUserSearch } from '@/v8/hooks/useUserSearch';\nimport { useWorkerToken } from '@/v8/hooks/useWorkerToken';\nimport { CredentialsServiceV8 } from '@/v8/services/credentialsServiceV8';\nimport { globalEnvironmentService } from '@/v8/services/globalEnvironmentService';\nimport { MfaAuthenticationServiceV8 } from '@/v8/services/mfaAuthenticationServiceV8';\nimport { type MFAFeatureFlag, MFAFeatureFlagsV8 } from '@/v8/services/mfaFeatureFlagsV8';\nimport MFAServiceV8_Legacy, { type RegisterDeviceParams } from '@/v8/services/mfaServiceV8_Legacy';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport type { TokenStatusInfo } from '@/v8/services/workerTokenStatusServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { ReturnTargetServiceV8U } from '@/v8u/services/returnTargetServiceV8U';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type MFAFlowBaseRenderProps, MFAFlowBaseV8 } from '../shared/MFAFlowBaseV8';\nimport type { DeviceAuthenticationPolicy, MFACredentials, MFAState } from '../shared/MFATypes';\nimport { UnifiedActivationStep } from './components/UnifiedActivationStep';\nimport { UnifiedDeviceRegistrationForm } from './components/UnifiedDeviceRegistrationForm';\nimport { UnifiedDeviceSelectionModal } from './components/UnifiedDeviceSelectionModal';\nimport { UnifiedSuccessStep } from './components/UnifiedSuccessStep';\nimport './UnifiedMFAFlow.css';\n\nconst MODULE_TAG = '[üîÑ UNIFIED-MFA-FLOW-V8]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedMFARegistrationFlowV8Props {\n\t/** Device type to render (optional - can be provided via navigation state) */\n\tdeviceType?: DeviceConfigKey;\n\n\t/** Optional initial credentials (for pre-filled forms) */\n\tinitialCredentials?: Partial<MFACredentials>;\n\n\t/** Optional callback when registration succeeds */\n\tonSuccess?: (result: DeviceRegistrationResult) => void;\n\n\t/** Optional callback when user cancels flow */\n\tonCancel?: () => void;\n\n\t/** Optional initial step (defaults to 0) */\n\tinitialStep?: number;\n\n\t/** Optional: Skip configuration step if already configured */\n\tskipConfiguration?: boolean;\n\n\t/** Optional: Force specific registration flow type */\n\tregistrationFlowType?: 'admin-active' | 'admin-activation' | 'user';\n}\n\n// ============================================================================\n// MFA FLOW SELECTION SCREEN\n// ============================================================================\n\ntype FlowMode = 'registration' | 'authentication';\n\n/** Map device types to their feature flags */\nconst DEVICE_FLAG_MAP: Record<DeviceConfigKey, MFAFeatureFlag> = {\n\tSMS: 'mfa_unified_sms',\n\tEMAIL: 'mfa_unified_email',\n\tMOBILE: 'mfa_unified_mobile',\n\tWHATSAPP: 'mfa_unified_whatsapp',\n\tTOTP: 'mfa_unified_totp',\n\tFIDO2: 'mfa_unified_fido2',\n};\n\nconst DEVICE_TYPES: { key: DeviceConfigKey; icon: string; name: string; description: string }[] = [\n\t{ key: 'SMS', icon: 'üì±', name: 'SMS', description: 'Receive OTP codes via text message' },\n\t{ key: 'EMAIL', icon: '‚úâÔ∏è', name: 'Email', description: 'Receive OTP codes via email' },\n\t{\n\t\tkey: 'TOTP',\n\t\ticon: 'üîê',\n\t\tname: 'Authenticator App (TOTP)',\n\t\tdescription: 'Use Google Authenticator, Authy, or similar',\n\t},\n\t{\n\t\tkey: 'MOBILE',\n\t\ticon: 'üì≤',\n\t\tname: 'Mobile Push',\n\t\tdescription: 'Receive push notifications on your phone',\n\t},\n\t{ key: 'WHATSAPP', icon: 'üí¨', name: 'WhatsApp', description: 'Receive OTP codes via WhatsApp' },\n\t{\n\t\tkey: 'FIDO2',\n\t\ticon: 'üîë',\n\t\tname: 'Security Key (FIDO2)',\n\t\tdescription: 'Use a hardware security key or passkey',\n\t},\n];\n\n/** Check if a device type is enabled via feature flags */\nconst isDeviceEnabled = (deviceKey: DeviceConfigKey): boolean => {\n\tconst flag = DEVICE_FLAG_MAP[deviceKey];\n\treturn MFAFeatureFlagsV8.isEnabled(flag);\n};\n\ninterface DeviceTypeSelectionScreenProps {\n\tonSelectDeviceType: (deviceType: DeviceConfigKey) => void;\n\tuserToken?: string | null;\n\tsetUserToken: (token: string | null) => void;\n}\n\nconst DeviceTypeSelectionScreen: React.FC<DeviceTypeSelectionScreenProps> = ({\n\tonSelectDeviceType,\n\tuserToken,\n\tsetUserToken,\n}) => {\n\tconst [flowMode, setFlowMode] = useState<FlowMode | null>(null);\n\tconst [environmentId, setEnvironmentId] = useState('');\n\tconst [username, setUsername] = useState('');\n\tconst [showDeviceSelectionModal, setShowDeviceSelectionModal] = useState(false);\n\tconst [showOTPModal, setShowOTPModal] = useState(false);\n\tconst [otpCode, setOtpCode] = useState('');\n\tconst [authenticationId, setAuthenticationId] = useState<string | null>(null);\n\tconst [selectedAuthDevice, setSelectedAuthDevice] = useState<{\n\t\tid: string;\n\t\ttype: string;\n\t\tnickname?: string;\n\t} | null>(null);\n\tconst [customLogoUrl, setCustomLogoUrl] = useState<string>('');\n\tconst [showAuthLoginModal, setShowAuthLoginModal] = useState(false);\n\tconst authEnvIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Load uploaded logo from localStorage on mount\n\tuseEffect(() => {\n\t\ttry {\n\t\t\tconst savedUpload = localStorage.getItem('custom-logo-upload');\n\t\t\tif (savedUpload) {\n\t\t\t\tconst uploadData = JSON.parse(savedUpload);\n\t\t\t\t// Handle both old format (objectUrl) and new format (base64Url)\n\t\t\t\tif (uploadData.base64Url) {\n\t\t\t\t\tsetCustomLogoUrl(uploadData.base64Url);\n\t\t\t\t} else if (uploadData.objectUrl) {\n\t\t\t\t\t// Old format - try to convert if possible, otherwise clear it\n\t\t\t\t\tconsole.warn('Old logo format detected - please re-upload your logo');\n\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load uploaded logo from localStorage:', error);\n\t\t\t// Clear corrupted data\n\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t}\n\t}, []);\n\n\t// Use worker token hook for token management\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Extract environment ID from worker token when available\n\tuseEffect(() => {\n\t\tconst extractEnvironmentId = async () => {\n\t\t\ttry {\n\t\t\t\tconst token = await workerTokenServiceV8.getToken();\n\t\t\t\tif (token && !environmentId) {\n\t\t\t\t\tconst parts = token.split('.');\n\t\t\t\t\tif (parts.length === 3) {\n\t\t\t\t\t\tconst payload = JSON.parse(atob(parts[1]));\n\t\t\t\t\t\tif (payload.environmentId) {\n\t\t\t\t\t\t\tsetEnvironmentId(payload.environmentId);\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`${MODULE_TAG} Environment ID extracted from worker token:`,\n\t\t\t\t\t\t\t\tpayload.environmentId\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Failed to extract environment ID from worker token:`, error);\n\t\t\t}\n\t\t};\n\n\t\textractEnvironmentId();\n\t}, [environmentId]);\n\n\tconst hasWorkerToken = workerToken.tokenStatus.isValid;\n\n\t// Use user search hook for user fetching and search\n\tconst {\n\t\tusers,\n\t\tisLoading: isLoadingUsers,\n\t\tsetSearchQuery,\n\t} = useUserSearch({\n\t\tenvironmentId,\n\t\ttokenValid: workerToken.tokenStatus.isValid,\n\t\tmaxPages: 100,\n\t\tuseCache: true,\n\t});\n\tconst tokenStatus = workerToken.tokenStatus;\n\n\t// Debug: Log users type to understand the issue\n\tuseEffect(() => {\n\t\tconsole.log(`${MODULE_TAG} users type check:`, {\n\t\t\tusers,\n\t\t\tisArray: Array.isArray(users),\n\t\t\ttype: typeof users,\n\t\t\tconstructor: users?.constructor?.name,\n\t\t});\n\t}, [users]);\n\n\t// Load Environment ID and username from global services on mount\n\tuseEffect(() => {\n\t\t// Initialize the service first to load from localStorage\n\t\tglobalEnvironmentService.initialize();\n\t\tconst savedEnvId = globalEnvironmentService.getEnvironmentId();\n\t\tif (savedEnvId) {\n\t\t\tsetEnvironmentId(savedEnvId);\n\t\t}\n\n\t\t// Load username from localStorage\n\t\tconst savedUsername = localStorage.getItem('mfa_unified_username');\n\t\tif (savedUsername) {\n\t\t\tsetUsername(savedUsername);\n\t\t}\n\t}, []);\n\n\t// Use MFA policies hook\n\tconst {\n\t\tpolicies,\n\t\tselectedPolicy,\n\t\tisLoading: isPoliciesLoading,\n\t\terror: policiesError,\n\t\tselectPolicy,\n\t\tdefaultPolicy,\n\t} = useMFAPolicies({\n\t\tenvironmentId,\n\t\ttokenIsValid: tokenStatus.isValid,\n\t\tautoLoad: true,\n\t\tautoSelectSingle: true,\n\t});\n\n\tconst selectedPolicyRef = useRef<DeviceAuthenticationPolicy | null>(null);\n\tuseEffect(() => {\n\t\tselectedPolicyRef.current = selectedPolicy ?? null;\n\t}, [selectedPolicy]);\n\n\tconst isPolicyDeviceEnabled = useCallback(\n\t\t(policy: DeviceAuthenticationPolicy | null, key: string) => {\n\t\t\tconst deviceConfig = policy?.[key] as { enabled?: boolean } | undefined;\n\t\t\treturn !!deviceConfig?.enabled;\n\t\t},\n\t\t[]\n\t);\n\n\tconst policyOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tpolicies.map((policy) => ({\n\t\t\t\tvalue: policy.id,\n\t\t\t\tlabel: policy.name,\n\t\t\t\t...(policy.default ? { secondaryLabel: '(Default)' } : {}),\n\t\t\t})),\n\t\t[policies]\n\t);\n\n\tconst userOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tArray.from(\n\t\t\t\tnew Map(\n\t\t\t\t\t(Array.isArray(users) ? users : []).map((user) => [\n\t\t\t\t\t\tuser.username,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvalue: user.username,\n\t\t\t\t\t\t\tlabel: user.username,\n\t\t\t\t\t\t\t...(user.email ? { secondaryLabel: user.email } : {}),\n\t\t\t\t\t\t} as SearchableDropdownOption,\n\t\t\t\t\t])\n\t\t\t\t).values()\n\t\t\t),\n\t\t[users]\n\t);\n\n\t// Auto-select default policy when policies load\n\tuseEffect(() => {\n\t\tif (defaultPolicy && !selectedPolicy) {\n\t\t\tselectPolicy(defaultPolicy.id);\n\t\t}\n\t}, [defaultPolicy, selectedPolicy, selectPolicy]);\n\n\t// Sync environment ID to global service and CredentialsServiceV8 when it changes\n\tuseEffect(() => {\n\t\tif (environmentId) {\n\t\t\tglobalEnvironmentService.setEnvironmentId(environmentId);\n\t\t\tlocalStorage.setItem('mfa_environmentId', environmentId);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tenvironmentId,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId, username: currentCreds.username }\n\t\t\t}));\n\t\t}\n\t}, [environmentId]);\n\n\t// Save username to localStorage and CredentialsServiceV8 when it changes\n\t// This ensures MFAFlowBase can read the username from its expected storage location\n\tuseEffect(() => {\n\t\tif (username) {\n\t\t\tlocalStorage.setItem('mfa_unified_username', username);\n\t\t\tlocalStorage.setItem('mfa_username', username);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tusername,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId: currentCreds.environmentId, username }\n\t\t\t}));\n\t\t}\n\t}, [username]);\n\n\t// Handle device selection for authentication\n\tconst handleDeviceSelectForAuthentication = async (device: {\n\t\tid: string;\n\t\ttype: string;\n\t\tdeviceName?: string;\n\t\tnickname?: string;\n\t}) => {\n\t\tconsole.log(`${MODULE_TAG} Selected device for authentication:`, device);\n\t\tsetShowDeviceSelectionModal(false);\n\t\tsetSelectedAuthDevice(device);\n\n\t\tconst policyId = selectedPolicy?.id;\n\t\tif (!policyId) {\n\t\t\ttoastV8.error('Please select an MFA Policy first');\n\t\t\treturn;\n\t\t}\n\n\t\t// Determine flow type and token\n\t\t// Admin flows should use worker tokens, not require user tokens\n\t\tconst flowType = userToken ? 'user' : 'admin';\n\t\tconst effectiveUserToken = flowType === 'user' ? userToken : undefined;\n\n\t\t// For admin flow, check if we have a valid worker token before proceeding\n\t\tif (flowType === 'admin' && !hasWorkerToken) {\n\t\t\ttoastV8.error('Admin flow requires a valid worker token. Please generate a worker token first.');\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\t// Initialize authentication with appropriate token\n\t\t\tconst response = await MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\tenvironmentId,\n\t\t\t\tusername: username.trim(),\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t\tdeviceId: device.id,\n\t\t\t\tregion: 'na',\n\t\t\t\ttokenType: flowType,\n\t\t\t\t...(effectiveUserToken && { userToken: effectiveUserToken }),\n\t\t\t});\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth initialized - full response:`, response);\n\t\t\tsetAuthenticationId(response.id);\n\n\t\t\tconst status = (response.status || '').toUpperCase();\n\t\t\tconst nextStep = (response.nextStep || '').toUpperCase();\n\t\t\tconst links = response._links as Record<string, { href?: string }> | undefined;\n\t\t\tconst hasOtpLink = !!(\n\t\t\t\tlinks &&\n\t\t\t\t(links.otp || links['otp.check'] || (links as Record<string, unknown>)['checkOtp'])\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth status:`, {\n\t\t\t\tstatus,\n\t\t\t\tnextStep,\n\t\t\t\thasOtpLink,\n\t\t\t\tdeviceType: device.type,\n\t\t\t});\n\n\t\t\t// Show appropriate UI based on response (normalize status/nextStep for PingOne variants)\n\t\t\tif (status === 'OTP_REQUIRED' || nextStep === 'OTP_REQUIRED' || hasOtpLink) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Opening OTP modal for device:`, device.type);\n\t\t\t\tsetShowOTPModal(true);\n\t\t\t\ttoastV8.success(`Verification code sent to your ${device.type} device`);\n\t\t\t} else if (status === 'ASSERTION_REQUIRED' || nextStep === 'ASSERTION_REQUIRED') {\n\t\t\t\tconsole.log(`${MODULE_TAG} FIDO2 assertion required`);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'FIDO2 authentication required. Please use /v8/mfa-config for FIDO2 authentication.'\n\t\t\t\t);\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'PUSH_CONFIRMATION_REQUIRED' ||\n\t\t\t\tnextStep === 'PUSH_CONFIRMATION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Push confirmation required`);\n\t\t\t\ttoastV8.success('Push notification sent! Please approve on your mobile device.');\n\t\t\t\ttoastV8.info('Complete authentication at /v8/mfa-config for push polling.');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (status === 'COMPLETED') {\n\t\t\t\ttoastV8.success('Authentication completed successfully!');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'DEVICE_SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'DEVICE_SELECTION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Device selection required - showing modal again`);\n\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t} else {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Unexpected authentication status:`, {\n\t\t\t\t\tstatus,\n\t\t\t\t\tnextStep,\n\t\t\t\t\tresponse,\n\t\t\t\t});\n\t\t\t\ttoastV8.info(`Authentication status: ${status || nextStep || 'UNKNOWN'}`);\n\t\t\t\t// Stay in authentication flow so user can try another device\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to initialize authentication:`, error);\n\n\t\t\t// Enhanced error handling for NO_USABLE_DEVICES\n\t\t\tlet errorMessage = 'Authentication failed: ';\n\t\t\tif (error instanceof Error) {\n\t\t\t\tconst errorStr = error.message.toLowerCase();\n\n\t\t\t\t// Check for NO_USABLE_DEVICES or device availability errors\n\t\t\t\tif (\n\t\t\t\t\terrorStr.includes('no usable devices') ||\n\t\t\t\t\terrorStr.includes('too many') ||\n\t\t\t\t\terrorStr.includes('cooldown') ||\n\t\t\t\t\terrorStr.includes('blocked')\n\t\t\t\t) {\n\t\t\t\t\terrorMessage = '‚ö†Ô∏è Device Temporarily Unavailable\\n\\n';\n\n\t\t\t\t\tif (errorStr.includes('cooldown') || errorStr.includes('too many')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Too many notifications have been sent to this device. It is temporarily in cooldown. ';\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Please wait a few minutes and try again, or select a different device.';\n\t\t\t\t\t} else if (errorStr.includes('blocked')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'This device has been blocked. Please contact your administrator or use a different device.';\n\t\t\t\t\t} else {\n\t\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terrorMessage += 'Unknown error';\n\t\t\t}\n\n\t\t\ttoastV8.error(errorMessage, { duration: 8000 });\n\t\t\t// Do NOT set flowMode(null) - keep user in authentication flow so they can retry or select another device\n\t\t}\n\t};\n\n\t// Handle OTP verification\n\tconst handleVerifyOTP = async () => {\n\t\tif (!authenticationId || !selectedAuthDevice) {\n\t\t\ttoastV8.error('Authentication session not found');\n\t\t\treturn;\n\t\t}\n\n\t\tif (otpCode.length !== 6) {\n\t\t\ttoastV8.error('Please enter a 6-digit code');\n\t\t\treturn;\n\t\t}\n\n\t\t// Get worker token for API call\n\t\tconst workerTokenForOTP = await workerTokenServiceV8.getToken();\n\n\t\tconsole.log(`${MODULE_TAG} OTP verification debug:`, {\n\t\t\tenvironmentId,\n\t\t\tusername: username.trim(),\n\t\t\tauthenticationId,\n\t\t\totpCode,\n\t\t\thasEnvironmentId: !!environmentId,\n\t\t\tenvIdLength: environmentId?.length,\n\t\t\thasWorkerToken: !!workerTokenForOTP,\n\t\t\tworkerTokenLength: workerTokenForOTP?.length,\n\t\t});\n\n\t\ttry {\n\t\t\t// Use backend proxy to avoid CORS issues\n\t\t\tconst response = await fetch('/api/pingone/mfa/validate-otp-for-device', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tenvironmentId,\n\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\tdeviceAuthId: authenticationId,\n\t\t\t\t\totp: otpCode,\n\t\t\t\t\tregion: 'na',\n\t\t\t\t\tworkerToken: workerTokenForOTP,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\n\t\t\t\tthrow new Error(errorData.error || errorData.message || `HTTP ${response.status}`);\n\t\t\t}\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.status === 'COMPLETED' || result.status === 'completed') {\n\t\t\t\ttoastV8.success('‚úÖ Authentication completed successfully!');\n\t\t\t\tsetShowOTPModal(false);\n\t\t\t\tsetFlowMode(null);\n\t\t\t\tsetOtpCode('');\n\t\t\t} else {\n\t\t\t\ttoastV8.error('Invalid code. Please try again.');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} OTP verification failed:`, error);\n\t\t\ttoastV8.error(\n\t\t\t\t`Verification failed: ${error instanceof Error ? error.message : 'Unknown error'}`\n\t\t\t);\n\t\t}\n\t};\n\n\t// Step 1: Choose Registration or Authentication\n\tif (!flowMode) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '12px' }}>\n\t\t\t\t\t{/* Header */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tboxShadow: '0 4px 12px rgba(239, 68, 68, 0.2)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h1\n\t\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîê MFA Unified Flow\n\t\t\t\t\t\t</h1>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tChoose what you want to do with MFA devices.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Configuration Section */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 12px 0',\n\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfiguration\n\t\t\t\t\t\t</h2>\n\n\t\t\t\t\t\t{/* Custom Logo URL */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-url\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[800],\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüé® Custom Logo URL (Optional)\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tDisplay a custom logo in the OTP verification modal\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t{/* URL Input */}\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tid=\"custom-logo-url\"\n\t\t\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\t\t\tvalue={customLogoUrl}\n\t\t\t\t\t\t\t\tonChange={(e) => setCustomLogoUrl(e.target.value)}\n\t\t\t\t\t\t\t\tplaceholder=\"https://example.com/logo.png\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\tpadding: '10px 14px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[900],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = `0 0 0 3px ${PING_IDENTITY_COLORS.primary[200]}`;\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.neutral[300];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* File Upload Section */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '13px', color: PING_IDENTITY_COLORS.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\tOR\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"file\"\n\t\t\t\t\t\t\t\t\tid=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\taccept=\"image/*\"\n\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\tconst file = e.target.files?.[0];\n\t\t\t\t\t\t\t\t\t\tif (!file) return;\n\n\t\t\t\t\t\t\t\t\t\t// Validate file type (images only)\n\t\t\t\t\t\t\t\t\t\tif (!file.type.startsWith('image/')) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Please select a logo file (JPG, PNG, etc.)');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Validate file size (max 5MB)\n\t\t\t\t\t\t\t\t\t\tif (file.size > 5 * 1024 * 1024) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('File size must be less than 5MB');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Convert file to base64 for persistence\n\t\t\t\t\t\t\t\t\t\tconst reader = new FileReader();\n\t\t\t\t\t\t\t\t\t\treader.onload = (event) => {\n\t\t\t\t\t\t\t\t\t\t\tconst base64Url = event.target?.result as string;\n\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl(base64Url);\n\n\t\t\t\t\t\t\t\t\t\t\t// Store base64 data for persistence\n\t\t\t\t\t\t\t\t\t\t\tconst uploadData = {\n\t\t\t\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\t\t\t\tbase64Url: base64Url,\n\t\t\t\t\t\t\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\t\t\t// Save to localStorage for persistence\n\t\t\t\t\t\t\t\t\t\t\tlocalStorage.setItem('custom-logo-upload', JSON.stringify(uploadData));\n\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.success(`Logo uploaded: ${file.name}`);\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.onerror = () => {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to read uploaded file');\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.readAsDataURL(file);\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'none' }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.primary[500],\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.primary[600]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '500',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[700];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìÅ Upload Logo File\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[500],\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tJPG, PNG, GIF (max 5MB)\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{customLogoUrl && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.neutral[50],\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tLogo Preview:\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\talt=\"Custom logo\"\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonError={() => {\n\t\t\t\t\t\t\t\t\t\t\t// Handle broken image URLs\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Failed to load custom logo URL');\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl('');\n\t\t\t\t\t\t\t\t\t\t\t\t// Clear uploaded file from localStorage\n\t\t\t\t\t\t\t\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.accent.pingRed[500],\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.accent.pingRed[600]}`,\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[600];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[500];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRemove Logo\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Environment ID - Hide when worker token is available */}\n\t\t\t\t\t\t{!hasWorkerToken && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"env-id\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tEnvironment ID\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"env-id\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setEnvironmentId(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* SQLite Database Stats */}\n\t\t\t\t\t\t{environmentId && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<SQLiteStatsDisplayV8\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tcompact={false}\n\t\t\t\t\t\t\t\t\trefreshInterval={30}\n\t\t\t\t\t\t\t\t\tshowRefreshButton={true}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Username */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUsername\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{environmentId && tokenStatus.isValid ? (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\toptions={userOptions}\n\t\t\t\t\t\t\t\t\tonChange={setUsername}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Type to search across 16,000+ users...\"\n\t\t\t\t\t\t\t\t\tisLoading={isLoadingUsers}\n\t\t\t\t\t\t\t\t\tonSearchChange={setSearchQuery}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setUsername(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* MFA Policy Dropdown */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"mfa-policy\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tMFA Policy\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{isPoliciesLoading ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tLoading policies...\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policiesError ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#ef4444', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tError loading policies: {policiesError}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policies.length === 0 ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tNo MFA policies found. Please check your environment ID and worker token.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"mfa-policy\"\n\t\t\t\t\t\t\t\t\tvalue={selectedPolicy?.id || ''}\n\t\t\t\t\t\t\t\t\toptions={policyOptions}\n\t\t\t\t\t\t\t\t\tonChange={selectPolicy}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Select an MFA policy...\"\n\t\t\t\t\t\t\t\t\tisLoading={isPoliciesLoading}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tSelect the MFA policy to use for device registration\n\t\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t\t{/* Policy Summary - Collapsible */}\n\t\t\t\t\t\t\t{selectedPolicy && (\n\t\t\t\t\t\t\t\t<details\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<summary\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\tuserSelect: 'none',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüìã Policy Details\n\t\t\t\t\t\t\t\t\t</summary>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '12px', fontSize: '13px', color: '#4b5563' }}>\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Policy Name:</strong> {String(selectedPolicy.name)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedPolicy.default && (\n\t\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px', color: '#059669' }}>\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>‚úì Default Policy</strong>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Enabled Devices:</strong>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '6px' }}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'sms') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì± SMS\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'email') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t‚úâÔ∏è Email\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'totp') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîê TOTP\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'fido2') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîë FIDO2\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'mobile') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì≤ Mobile\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'voice') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüìû Voice\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</details>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Worker Token Status */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t\tpaddingRight: '16px',\n\t\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={setEnvironmentId}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* User Token Status */}\n\t\t\t\t\t\t\t{userToken && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\t'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05))',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #10b981',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '20px' }}>üë§</span>\n\t\t\t\t\t\t\t\t\t\t<strong style={{ color: '#047857', fontSize: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t\tUser Token Active\n\t\t\t\t\t\t\t\t\t\t</strong>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: '14px', color: '#059669', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t\t‚úì User authentication token available\n\t\t\t\t\t\t\t\t\t\t<br />‚úì Ready for User Flow device registration\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Flow Mode Selection */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',\n\t\t\t\t\t\t\tgap: '16px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Registration Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => setFlowMode('registration')}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>‚ûï</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#047857',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Registration\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tRegister a new MFA device for a user. Create SMS, Email, TOTP, Mobile Push,\n\t\t\t\t\t\t\t\t\t\tWhatsApp, or FIDO2 devices.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t{/* Authentication Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tif (!userToken) {\n\t\t\t\t\t\t\t\t\tsetShowAuthLoginModal(true);\n\t\t\t\t\t\t\t\t\ttoastV8.info('üîê Please complete user login before device authentication.', {\n\t\t\t\t\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-4px)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 8px 24px rgba(59, 130, 246, 0.2)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>üîì</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#1d4ed8',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Authentication\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tAuthenticate using an existing MFA device. Verify user identity with OTP, push\n\t\t\t\t\t\t\t\t\t\tnotification, or security key.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{showAuthLoginModal && (\n\t\t\t\t\t<UserLoginModalV8\n\t\t\t\t\t\tisOpen={showAuthLoginModal}\n\t\t\t\t\t\tonClose={() => setShowAuthLoginModal(false)}\n\t\t\t\t\t\tonTokenReceived={(token) => {\n\t\t\t\t\t\t\tsetUserToken(token);\n\t\t\t\t\t\t\tsetShowAuthLoginModal(false);\n\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tenvironmentId={authEnvIdForModal}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</>\n\t\t);\n\t}\n\n\t// Authentication flow - dedicated view (device selection + OTP modals only; no registration grid)\n\tif (flowMode === 'authentication') {\n\t\treturn (\n\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\tsetSelectedAuthDevice(null);\n\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t‚Üê Back\n\t\t\t\t\t</button>\n\t\t\t\t\t<h1\n\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t>\n\t\t\t\t\t\tüîì Device Authentication\n\t\t\t\t\t</h1>\n\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\t{selectedAuthDevice && !showOTPModal\n\t\t\t\t\t\t\t? `Authenticating with ${selectedAuthDevice.type} ‚Äî enter the code when prompted.`\n\t\t\t\t\t\t\t: `Select an MFA device to authenticate for ${username || 'the user'}`}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t\t{!showDeviceSelectionModal && !showOTPModal && (\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowDeviceSelectionModal(true)}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tSelect MFA device\n\t\t\t\t\t</button>\n\t\t\t\t)}\n\t\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\t\tonClose={() => {\n\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t// Keep flowMode so user stays in auth flow; only clear if they click Back\n\t\t\t\t\t}}\n\t\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\t\tusername={username}\n\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t/>\n\t\t\t\t{showOTPModal && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.6)',\n\t\t\t\t\t\t\tbackdropFilter: 'blur(4px)',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t\t\tanimation: 'fadeIn 0.2s ease-out',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t{`\n\t\t\t\t\t\t\t@keyframes fadeIn {\n\t\t\t\t\t\t\t\tfrom { opacity: 0; }\n\t\t\t\t\t\t\t\tto { opacity: 1; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes slideUp {\n\t\t\t\t\t\t\t\tfrom { \n\t\t\t\t\t\t\t\t\topacity: 0;\n\t\t\t\t\t\t\t\t\ttransform: translateY(20px); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tto { \n\t\t\t\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t\t\t\t\ttransform: translateY(0); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes pulse {\n\t\t\t\t\t\t\t\t0%, 100% { opacity: 1; }\n\t\t\t\t\t\t\t\t50% { opacity: 0.5; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`}\n\t\t\t\t\t\t</style>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\tborderRadius: '24px',\n\t\t\t\t\t\t\t\tpadding: '48px 40px',\n\t\t\t\t\t\t\t\tmaxWidth: '480px',\n\t\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\t\tboxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',\n\t\t\t\t\t\t\t\tanimation: 'slideUp 0.3s ease-out',\n\t\t\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Logo Area */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '32px' }}>\n\t\t\t\t\t\t\t\t{customLogoUrl ? (\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\t\talt=\"Organization logo\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '120px',\n\t\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonError={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\t// Fallback to default icon if image fails to load\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.display = 'none';\n\t\t\t\t\t\t\t\t\t\t\t\tconst fallback = document.createElement('div');\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.style.cssText = `\n\t\t\t\t\t\t\t\t\t\t\t\twidth: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\theight: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: 0 auto 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: center;\n\t\t\t\t\t\t\t\t\t\t\t\tjustifyContent: center;\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: 36px;\n\t\t\t\t\t\t\t\t\t\t\t\tboxShadow: 0 10px 25px rgba(102, 126, 234, 0.3);\n\t\t\t\t\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.textContent = 'üîê';\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.parentElement!.appendChild(fallback);\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\theight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto 20px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '20px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '36px',\n\t\t\t\t\t\t\t\t\t\t\tboxShadow: '0 10px 25px rgba(102, 126, 234, 0.3)',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüîê\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tVerification Code\n\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\tEnter the 6-digit code sent to your <strong>{selectedAuthDevice?.type}</strong>{' '}\n\t\t\t\t\t\t\t\t\tdevice\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* OTP Input */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\t\t\tplaceholder=\"‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢\"\n\t\t\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tletterSpacing: '12px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow: otpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{otpCode.length > 0 && otpCode.length < 6 && (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\t\tanimation: 'pulse 2s ease-in-out infinite',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{6 - otpCode.length} more digit{6 - otpCode.length !== 1 ? 's' : ''} needed\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Resend Code Button */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={async () => {\n\t\t\t\t\t\t\t\t\t\tif (!selectedAuthDevice || !authenticationId) return;\n\t\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.info('Resending verification code...');\n\t\t\t\t\t\t\t\t\t\t\t// Re-initialize authentication to resend code\n\t\t\t\t\t\t\t\t\t\t\tconst response =\n\t\t\t\t\t\t\t\t\t\t\t\tawait MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\t\t\t\t\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\t\t\t\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicy?.id || '',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceId: selectedAuthDevice.id,\n\t\t\t\t\t\t\t\t\t\t\t\t\tregion: 'na',\n\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tif (response.status?.toUpperCase() === 'OTP_REQUIRED') {\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('New code sent to your device!');\n\t\t\t\t\t\t\t\t\t\t\t\tsetAuthenticationId(response.id);\n\t\t\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to resend code');\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Resend error:', error);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tcolor: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'transparent';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚Üª Resend Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Action Buttons */}\n\t\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#d1d5db';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f9fafb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'white';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6\n\t\t\t\t\t\t\t\t\t\t\t\t? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '#d1d5db',\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (otpCode.length === 6) {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚úì Verify Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Help Text */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<strong style={{ color: '#111827' }}>Didn't receive the code?</strong>\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\tCheck your spam folder or click \"Resend Code\" above\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t);\n\t}\n\n\t// Registration flow - show device type selection cards\n\treturn (\n\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t{/* Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #10b981 0%, #047857 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => setFlowMode(null)}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t‚Üê Back\n\t\t\t\t</button>\n\t\t\t\t<h1 style={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}>\n\t\t\t\t\t‚ûï Register MFA Device\n\t\t\t\t</h1>\n\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\tSelect a device type to register for {username || 'the user'}\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Device Type Cards */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',\n\t\t\t\t\tgap: '16px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t{DEVICE_TYPES.map((device) => {\n\t\t\t\t\tconst enabled = isDeviceEnabled(device.key);\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tkey={device.key}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => enabled && onSelectDeviceType(device.key)}\n\t\t\t\t\t\t\tdisabled={!enabled}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tbackground: enabled ? '#ffffff' : '#f9fafb',\n\t\t\t\t\t\t\t\tborder: `2px solid ${enabled ? '#e5e7eb' : '#f3f4f6'}`,\n\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\tcursor: enabled ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\topacity: enabled ? 1 : 0.5,\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#10b981';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ecfdf5';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>{device.icon}</span>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{device.name}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280' }}>{device.description}</p>\n\t\t\t\t\t\t\t{!enabled && (\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '12px', color: '#9ca3af' }}>\n\t\t\t\t\t\t\t\t\t(Not enabled)\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</div>\n\n\t\t\t{/* Device Selection Modal for Authentication */}\n\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t}}\n\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\tusername={username}\n\t\t\t\tenvironmentId={environmentId}\n\t\t\t/>\n\n\t\t\t{/* OTP Modal for Authentication */}\n\t\t\t{showOTPModal && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '400px',\n\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\tboxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '600' }}>\n\t\t\t\t\t\t\tEnter Verification Code\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '0 0 20px 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tCheck your {selectedAuthDevice?.type} device for the code\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\tplaceholder=\"000000\"\n\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 16px',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\tletterSpacing: '8px',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tmarginBottom: '20px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: otpCode.length === 6 ? '#3b82f6' : '#9ca3af',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tVerify\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Wrapper Component\n *\n * Wraps the content with MFACredentialProvider to provide global credential state\n */\nexport const UnifiedMFARegistrationFlowV8: React.FC<UnifiedMFARegistrationFlowV8Props> = (\n\tprops\n) => {\n\tconst location = useLocation();\n\n\t// Get device type from props or location state (can be undefined)\n\tconst initialDeviceType =\n\t\tprops.deviceType || (location.state as { deviceType?: DeviceConfigKey })?.deviceType;\n\n\t// State for selected device type (allows user to select if not provided)\n\tconst [selectedDeviceType, setSelectedDeviceType] = useState<DeviceConfigKey | undefined>(\n\t\tinitialDeviceType\n\t);\n\n\t// User token state for OAuth authentication (User Flow)\n\tconst [userToken, setUserToken] = useState<string | null>(() => {\n\t\t// Check if we already have a user token from previous OAuth flow\n\t\tconst savedCreds = CredentialsServiceV8.loadCredentials('user-login-v8', {\n\t\t\tflowKey: 'user-login-v8',\n\t\t\tflowType: 'oauth',\n\t\t\tincludeClientSecret: false,\n\t\t\tincludeRedirectUri: false,\n\t\t\tincludeLogoutUri: false,\n\t\t\tincludeScopes: false,\n\t\t});\n\t\treturn savedCreds?.accessToken || null;\n\t});\n\n\t// If no device type selected, show device type selection screen\n\tif (!selectedDeviceType) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<MFAHeaderV8\n\t\t\t\t\ttitle=\"MFA Unified Flow\"\n\t\t\t\t\tdescription=\"Register or authenticate MFA devices\"\n\t\t\t\t\tversionTag=\"V8\"\n\t\t\t\t\tcurrentPage=\"registration\"\n\t\t\t\t\tshowBackToMain={true}\n\t\t\t\t\theaderColor=\"pingRed\"\n\t\t\t\t/>\n\t\t\t\t<GlobalMFAProvider>\n\t\t\t\t\t<MFACredentialProvider>\n\t\t\t\t\t\t<DeviceTypeSelectionScreen\n\t\t\t\t\t\t\tonSelectDeviceType={setSelectedDeviceType}\n\t\t\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</MFACredentialProvider>\n\t\t\t\t</GlobalMFAProvider>\n\t\t\t\t{/* API display (bottom of page) */}\n\t\t\t\t<div style={{ marginTop: '24px' }}>\n\t\t\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\t\t\t\t</div>\n\t\t\t</>\n\t\t);\n\t}\n\n\treturn (\n\t\t<GlobalMFAProvider>\n\t\t\t<MFACredentialProvider>\n\t\t\t\t<UnifiedMFARegistrationFlowContent\n\t\t\t\t\t{...props}\n\t\t\t\t\tdeviceType={selectedDeviceType}\n\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t/>\n\t\t\t</MFACredentialProvider>\n\t\t</GlobalMFAProvider>\n\t);\n};\n\n// ============================================================================\n// CONTENT COMPONENT (MAIN LOGIC)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Content Component\n *\n * Contains the actual flow logic and integrates with:\n * - MFACredentialContext (global credential state)\n * - useWorkerToken hook (token status and auto-refresh)\n * - deviceFlowConfigs (device-specific configuration)\n * - MFAFlowBaseV8 (5-step framework)\n */\nconst UnifiedMFARegistrationFlowContent: React.FC<\n\tRequired<Pick<UnifiedMFARegistrationFlowV8Props, 'deviceType'>> &\n\t\tOmit<UnifiedMFARegistrationFlowV8Props, 'deviceType'> & {\n\t\t\tuserToken: string | null;\n\t\t\tsetUserToken: (token: string | null) => void;\n\t\t}\n> = ({ deviceType, onCancel, userToken, setUserToken }) => {\n\t// ========================================================================\n\t// CONFIGURATION\n\t// ========================================================================\n\n\t// React Router navigation\n\tconst navigate = useNavigate();\n\n\t// Load device-specific configuration\n\tconst config = useMemo(() => {\n\t\treturn getDeviceConfig(deviceType);\n\t}, [deviceType]);\n\n\t// ========================================================================\n\t// USER FLOW OAUTH STATE\n\t// ========================================================================\n\n\t// State for User Login Modal (OAuth authentication for User Flow)\n\tconst [showUserLoginModal, setShowUserLoginModal] = useState(false);\n\tconst [showUserTokenSuccess, setShowUserTokenSuccess] = useState(false);\n\tconst [userTokenForDisplay, setUserTokenForDisplay] = useState<string>('');\n\tconst [usernameFromToken, setUsernameFromToken] = useState<string>('');\n\tconst [showUsernameDropdown, setShowUsernameDropdown] = useState(false);\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\tconst envIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Pending registration data while waiting for OAuth (use ref to avoid stale closure)\n\tconst pendingRegistrationRef = useRef<{\n\t\tdeviceType: DeviceConfigKey;\n\t\tfields: Record<string, string>;\n\t\tflowType: string;\n\t\tprops: MFAFlowBaseRenderProps;\n\t} | null>(null);\n\n\t// Worker token state for validation in registration flow\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Detect OAuth callback and re-open modal if needed\n\tuseEffect(() => {\n\t\tconst urlParams = new URLSearchParams(window.location.search);\n\t\tconst code = urlParams.get('code');\n\t\tconst hasStoredState = sessionStorage.getItem('user_login_state_v8');\n\n\t\t// If we have OAuth callback params and stored state, re-open the modal to process callback\n\t\t// But only if we don't already have a user token (to prevent reopening after silent auth)\n\t\tif (code && hasStoredState && !showUserLoginModal && !userToken) {\n\t\t\tconsole.log('[UNIFIED-FLOW] OAuth callback detected - re-opening modal to process');\n\t\t\tsetShowUserLoginModal(true);\n\t\t}\n\t}, [showUserLoginModal, userToken]);\n\n\t// ========================================================================\n\t// STEP VALIDATION\n\t// ========================================================================\n\n\t/**\n\t * Validate Step 0 (Configuration)\n\t */\n\tconst validateStep0 = useCallback(\n\t\t(\n\t\t\tcredentials: MFACredentials,\n\t\t\ttoken: TokenStatusInfo,\n\t\t\tnavigation: ReturnType<typeof useStepNavigationV8>\n\t\t) => {\n\t\t\t// Always check for valid worker token (required for MFA device operations)\n\t\t\tif (!token.isValid) {\n\t\t\t\tnavigation.setValidationErrors(['Invalid or expired worker token']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Check required configuration\n\t\t\tif (!credentials.environmentId || !credentials.username) {\n\t\t\t\tnavigation.setValidationErrors(['Environment ID and Username are required']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\t\t[]\n\t);\n\n\t// ========================================================================\n\t// STEP RENDERERS\n\t// ========================================================================\n\n\t/**\n\t * Perform device registration API call (with token already available)\n\t */\n\tconst performRegistrationWithToken = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string,\n\t\t\ttoken?: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== PERFORM REGISTRATION WITH TOKEN =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Token:', token ? `Present (${token.length} chars)` : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setIsLoading available:', typeof props.setIsLoading);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setCredentials available:', typeof props.setCredentials);\n\n\t\t\ttry {\n\t\t\t\tprops.setIsLoading(true);\n\n\t\t\t\t// Update credentials with device fields and user token if provided\n\t\t\t\tprops.setCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tflowType, // Store flowType so activation step knows if OTP is required\n\t\t\t\t\t...fields,\n\t\t\t\t\t...(flowType === 'user' && token\n\t\t\t\t\t\t? { userToken: token, tokenType: 'user' }\n\t\t\t\t\t\t: flowType !== 'user'\n\t\t\t\t\t\t\t? { tokenType: 'worker' }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t}));\n\n\t\t\t\t// Register the device using proper API call\n\t\t\t\t// CRITICAL: Flow-specific device status\n\t\t\t\t// - Admin flow: ACTIVE (no OTP sent, device ready immediately)\n\t\t\t\t// - Admin ACTIVATION_REQUIRED: ACTIVATION_REQUIRED (sends OTP for admin to activate)\n\t\t\t\t// - User flow: ACTIVATION_REQUIRED (sends OTP for user to activate)\n\t\t\t\t// - FIDO2: ACTIVE (WebAuthn verification happens during registration)\n\t\t\t\tlet deviceStatus: 'ACTIVE' | 'ACTIVATION_REQUIRED' | undefined;\n\n\t\t\t\t// Determine device status based on flow type (applies to all device types including FIDO2)\n\t\t\t\tif (flowType === 'admin-active') {\n\t\t\t\t\tdeviceStatus = 'ACTIVE';\n\t\t\t\t} else if (flowType === 'admin-activation') {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED';\n\t\t\t\t} else {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED'; // user flow\n\t\t\t\t}\n\n\t\t\t\t// Special note for FIDO2: WebAuthn verification proves device works,\n\t\t\t\t// but we still respect the flow type for status determination\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t'[UNIFIED-FLOW] FIDO2 device - status determined by flow type:',\n\t\t\t\t\t\tdeviceStatus\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device status determined:', {\n\t\t\t\t\tflowType,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tdeviceStatus,\n\t\t\t\t\totpWillBeSent: deviceStatus === 'ACTIVATION_REQUIRED',\n\t\t\t\t\treason:\n\t\t\t\t\t\tselectedDeviceType === 'FIDO2'\n\t\t\t\t\t\t\t? 'FIDO2 - ACTIVE after WebAuthn verification'\n\t\t\t\t\t\t\t: 'User flow - OTP required for activation',\n\t\t\t\t});\n\n\t\t\t\t// Use same parameter construction as working MFA flows\n\t\t\t\ttype RegisterDeviceParamsWithToken = RegisterDeviceParams & {\n\t\t\t\t\ttokenType?: 'worker' | 'user';\n\t\t\t\t\tuserToken?: string | undefined;\n\t\t\t\t};\n\t\t\t\tlet baseParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\tenvironmentId: props.credentials.environmentId,\n\t\t\t\t\tusername: props.credentials.username,\n\t\t\t\t\ttype: selectedDeviceType,\n\t\t\t\t};\n\t\t\t\t// Per rightTOTP.md: Pass token type and user token if available\n\t\t\t\tif (flowType === 'user' && token) {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'user',\n\t\t\t\t\t\tuserToken: token,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'worker',\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Always include status for all device types\n\t\t\t\t// FIDO2: Set to ACTIVE since WebAuthn verification proves device works\n\t\t\t\t// Other devices: Set based on flow type (admin-active = ACTIVE, others = ACTIVATION_REQUIRED)\n\t\t\t\tif (deviceStatus !== undefined) {\n\t\t\t\t\tbaseParams.status = deviceStatus;\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registration base params:', {\n\t\t\t\t\tenvironmentId: baseParams.environmentId,\n\t\t\t\t\tusername: baseParams.username,\n\t\t\t\t\ttype: baseParams.type,\n\t\t\t\t\ttokenType: baseParams.tokenType,\n\t\t\t\t\tstatus: baseParams.status,\n\t\t\t\t\tflowType,\n\t\t\t\t});\n\n\t\t\t\t// Map form field names to API field names\n\t\t\t\t// Form uses 'deviceName' but API expects 'nickname' or 'name'\n\t\t\t\tconst mappedFields: Record<string, string> = { ...fields };\n\t\t\t\tif (mappedFields.deviceName) {\n\t\t\t\t\tmappedFields.nickname = mappedFields.deviceName;\n\t\t\t\t\tmappedFields.name = mappedFields.deviceName;\n\t\t\t\t\tdelete mappedFields.deviceName;\n\t\t\t\t}\n\n\t\t\t\t// Format phone number for SMS/WhatsApp devices\n\t\t\t\t// Form sends: { phoneNumber: '9725231586', countryCode: '+1' }\n\t\t\t\t// API expects: { phone: '+1.9725231586' }\n\t\t\t\tif (mappedFields.phoneNumber && mappedFields.countryCode) {\n\t\t\t\t\tconst countryCode = mappedFields.countryCode.replace('+', ''); // Remove + for formatting\n\t\t\t\t\tconst phoneNumber = mappedFields.phoneNumber.replace(/\\D/g, ''); // Remove non-digits\n\t\t\t\t\tmappedFields.phone = `+${countryCode}.${phoneNumber}`;\n\t\t\t\t\tconsole.log('[UNIFIED-FLOW] Formatted phone:', mappedFields.phone);\n\t\t\t\t\tdelete mappedFields.phoneNumber;\n\t\t\t\t\tdelete mappedFields.countryCode;\n\t\t\t\t}\n\n\t\t\t\t// Include device-specific fields (phone, email, etc.)\n\t\t\t\tconst deviceParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\t...baseParams,\n\t\t\t\t\t...mappedFields,\n\t\t\t\t\t// Include policy for TOTP devices (required for secret and keyUri to be returned)\n\t\t\t\t\t...(selectedDeviceType === 'TOTP' && selectedPolicyRef.current\n\t\t\t\t\t\t? { policy: selectedPolicyRef.current.id }\n\t\t\t\t\t\t: {}),\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registering device with params:', deviceParams);\n\n\t\t\t\tconst result = await MFAServiceV8_Legacy.registerDevice(deviceParams);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device registered:', result);\n\n\t\t\t\t// Update MFA state with device info\n\t\t\t\tconst registrationResult = result as unknown as Record<string, unknown>;\n\n\t\t\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result for TOTP:', {\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\tqrCode: registrationResult.qrCode,\n\t\t\t\t\t\tqrCodeUrl: registrationResult.qrCodeUrl,\n\t\t\t\t\t\tsecret: registrationResult.secret,\n\t\t\t\t\t\ttotpSecret: registrationResult.totpSecret,\n\t\t\t\t\t\tfullResult: result,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// ===============================================\n\n\t\t\t\t// Clear stored registration data after successful use\n\t\t\t\tlocalStorage.removeItem('mfa_registration_flow_type');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_fields');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_device_type');\n\n\t\t\t\tprops.setMfaState((prev) => {\n\t\t\t\t\t// TOTP: QR code will be rendered by QRCodeSVG component in UnifiedActivationStep\n\t\t\t\t\t// No need to generate QR code data URL here - just pass the keyUri\n\t\t\t\t\tconst newState: MFAState = {\n\t\t\t\t\t\t...prev,\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tdeviceStatus: result.status,\n\t\t\t\t\t\t...(registrationResult.deviceActivateUri\n\t\t\t\t\t\t\t? { deviceActivateUri: String(registrationResult.deviceActivateUri) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'TOTP'\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\ttotpSecret: String(registrationResult.secret || ''),\n\t\t\t\t\t\t\t\t\tkeyUri: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tqrCodeUrl: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tshowQr: !!(registrationResult.secret || registrationResult.keyUri),\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'FIDO2' &&\n\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tpublicKeyCredentialCreationOptions:\n\t\t\t\t\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions,\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'MOBILE' && registrationResult.pairingKey\n\t\t\t\t\t\t\t? { pairingKey: String(registrationResult.pairingKey) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t};\n\n\t\t\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\t\t\tfullState: newState,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t// ================================================\n\n\t\t\t\t\treturn newState;\n\t\t\t\t});\n\n\t\t\t\t// FIDO2: Check if we already have credential data (from WebAuthn modal)\n\t\t\t\t// If credentialId and publicKey are present, registration is complete\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tif (fields.credentialId && fields.publicKey) {\n\t\t\t\t\t\t// WebAuthn already completed via modal - device fully registered\n\n\t\t\t\t\t\t// Admin Flow: Show QR but skip OTP validation - device ready immediately\n\t\t\t\t\t\t// Admin ACTIVATION_REQUIRED & User Flow: Show QR and require OTP validation\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tflowType === 'admin-active' ||\n\t\t\t\t\t\t\tflowType === 'admin-activation' ||\n\t\t\t\t\t\t\tresult.status === 'ACTIVE'\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t'[UNIFIED-FLOW] Admin flow or ACTIVE status - proceeding to show QR without OTP requirement'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered successfully!${flowType === 'admin-active' || flowType === 'admin-activation' ? ' Device is ready to use.' : ''}`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t// For Admin Flow, go to API docs page instead of OTP page\n\t\t\t\t\t\t\t// For User Flow, go to User Login step (Step 1)\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (result.status === 'ACTIVATION_REQUIRED') {\n\t\t\t\t\t\t\t// Device requires activation - PingOne automatically sends OTP\n\t\t\t\t\t\t\t// This applies to both admin_activation_required and user flow\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered! OTP has been sent automatically.`\n\t\t\t\t\t\t\t);\n  // DO NOT auto-advance for OTP-required devices\n\t\t\t\t\t\t\t// User should manually click Next after receiving OTP\n\t\t\t\t\t\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation - waiting for user to proceed manually`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Unknown status, proceed with flow-specific navigation\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} // End of FIDO2 section\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Registration failed:', error);\n\t\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Device registration failed';\n\n\t\t\t\t// Check if error is due to too many devices\n\t\t\t\tif (errorMessage.includes('Too many devices')) {\n\t\t\t\t\ttoastV8.error(\n\t\t\t\t\t\t`${errorMessage}\\n\\n‚ÑπÔ∏è You can manage your devices at:\\nhttps://localhost:3000/v8/delete-all-devices`,\n\t\t\t\t\t\t{ duration: 8000 }\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\ttoastV8.error(errorMessage);\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tprops.setIsLoading(false);\n\t\t\t}\n\t\t},\n\t\t[config.displayName, toastV8]\n\t);\n\n\t/**\n\t * Handle user token received from OAuth flow\n\t */\n\tconst handleUserTokenReceived = useCallback(\n\t\t(token: string) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== USER TOKEN RECEIVED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Token length:', token.length);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current pending registration:', pendingRegistrationRef.current);\n\n\t\t\tsetUserToken(token);\n\t\t\tsetUserTokenForDisplay(token);\n\n\t\t\t// Decode JWT to extract username\n\t\t\ttry {\n\t\t\t\tconst base64Url = token.split('.')[1];\n\t\t\t\tconst base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n\t\t\t\tconst jsonPayload = decodeURIComponent(\n\t\t\t\t\tatob(base64)\n\t\t\t\t\t\t.split('')\n\t\t\t\t\t\t.map((c) => `%${`00${c.charCodeAt(0).toString(16)}`.slice(-2)}`)\n\t\t\t\t\t\t.join('')\n\t\t\t\t);\n\t\t\t\tconst payload = JSON.parse(jsonPayload);\n\t\t\t\tconst username =\n\t\t\t\t\tpayload.username || payload.preferred_username || payload.sub || 'Unknown User';\n\t\t\t\tsetUsernameFromToken(username);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Extracted username:', username);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Failed to decode JWT:', error);\n\t\t\t\tsetUsernameFromToken('Unknown User');\n\t\t\t}\n\n\t\t\t// If we have pending registration, show success page first\n\t\t\tconst pending = pendingRegistrationRef.current;\n\t\t\tif (pending) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Found pending registration, showing success page first...');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending data:', {\n\t\t\t\t\tdeviceType: pending.deviceType,\n\t\t\t\t\tflowType: pending.flowType,\n\t\t\t\t\thasProps: !!pending.props,\n\t\t\t\t\thasFields: !!pending.fields,\n\t\t\t\t});\n\n\t\t\t\ttoastV8.success('‚úÖ Authentication successful! Your user token is ready.', {\n\t\t\t\t\tduration: 4000,\n\t\t\t\t});\n\n\t\t\t\t// Close login modal and show success page\n\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\tsetShowUserTokenSuccess(true);\n\t\t\t} else {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] WARNING: No pending registration found after OAuth!');\n\t\t\t}\n\t\t},\n\t\t[setUserToken]\n\t);\n\n\t/**\n\t * Handle continue from user token success page\n\t */\n\tconst handleContinueAfterUserLogin = useCallback(() => {\n\t\tconsole.log(\n\t\t\t'[UNIFIED-FLOW] User clicked continue after login, proceeding with registration...'\n\t\t);\n\n\t\tconst pending = pendingRegistrationRef.current;\n\t\tif (pending && userToken) {\n\t\t\tconst { deviceType: pendingDeviceType, fields, flowType, props } = pending;\n\t\t\tpendingRegistrationRef.current = null;\n\n\t\t\t// Hide success page\n\t\t\tsetShowUserTokenSuccess(false);\n\n\t\t\t// Continue with registration\n\t\t\tsetTimeout(() => {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Now executing performRegistrationWithToken...');\n\t\t\t\tperformRegistrationWithToken(props, pendingDeviceType, fields, flowType, userToken);\n\t\t\t}, 100);\n\t\t}\n\t}, [userToken, performRegistrationWithToken]);\n\n\t/**\n\t * Perform device registration API call\n\t * Checks if User Flow needs OAuth first, otherwise proceeds with registration\n\t */\n\tconst performRegistration = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== DEVICE REGISTRATION SUBMITTED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current userToken:', userToken ? 'Present' : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\n\t\t\t// CRITICAL: Validate worker token before allowing any registration\n\t\t\tif (!workerToken.tokenStatus.isValid) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Cannot proceed - no valid worker token');\n\t\t\t\ttoastV8.error(\n\t\t\t\t\t'‚ùå Worker token required for device registration. Please configure worker token credentials first.',\n\t\t\t\t\t{\n\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// For User Flow, check if we need OAuth authentication first\n\t\t\tif (flowType === 'user' && !userToken) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] User flow selected but no token - showing OAuth modal');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Storing pending registration...');\n\n\t\t\t\t// Store pending registration data\n\t\t\t\tpendingRegistrationRef.current = {\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tfields,\n\t\t\t\t\tflowType,\n\t\t\t\t\tprops,\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending registration stored:', pendingRegistrationRef.current);\n\n\t\t\t\t// Set return target for device registration flow\n\t\t\t\tReturnTargetServiceV8U.setReturnTarget(\n\t\t\t\t\t'mfa_device_registration',\n\t\t\t\t\t'/v8/unified-mfa',  // Return to unified MFA flow\n\t\t\t\t\t2  // Step 2: Device Selection\n\t\t\t\t);\n\n\t\t\t\t// Show the user login modal\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'üîê User Flow requires PingOne authentication. Please complete the login to continue with device registration.',\n\t\t\t\t\t{ duration: 6000 }\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t'[UNIFIED-FLOW] Proceeding directly with registration (token exists or admin flow)'\n\t\t\t);\n\t\t\t// Proceed with registration (using existing token for user flow)\n\t\t\tawait performRegistrationWithToken(\n\t\t\t\tprops,\n\t\t\t\tselectedDeviceType,\n\t\t\t\tfields,\n\t\t\t\tflowType,\n\t\t\t\tuserToken || undefined\n\t\t\t);\n\t\t},\n\t\t[workerToken.tokenStatus.isValid, userToken]\n\t);\n\n\t/**\n\t * Render Step 0: Configuration (environment, user, policy)\n\t */\n\tconst renderStep0 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn (\n\t\t\t\t<UnifiedDeviceRegistrationForm\n\t\t\t\t\tinitialDeviceType={deviceType}\n\t\t\t\t\tonSubmit={async (selectedDeviceType, fields, flowType) => {\n\t\t\t\t\t\tawait performRegistration(props, selectedDeviceType, fields, flowType);\n\t\t\t\t\t}}\n\t\t\t\t\tonCancel={() => {\n\t\t\t\t\t\tif (onCancel) onCancel();\n\t\t\t\t\t}}\n\t\t\t\t\ttokenStatus={props.tokenStatus}\n\t\t\t\t\tusername={props.credentials.username}\n\t\t\t\t/>\n\t\t\t);\n\t\t},\n\t\t[deviceType, onCancel, performRegistration]\n\t);\n\n\t/**\n\t * Render Step 1: User Login using Authorization Code Flow with PKCE\n\t */\n\tconst renderStep1 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <UserLoginStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 2: Device Selection (option to call registration if want new device, or have no devices)\n\t */\n\tconst renderStep2 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 3: Device-Specific Actions (OTP/QR Generation, FIDO, Mobile Push)\n\t */\n\tconst renderStep3 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific based on the device type\n\t\t\t// For now, return the activation step which handles device-specific logic\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 4: OTP Validation / Confirmation\n\t */\n\tconst renderStep4 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific validation\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 5: API Documentation\n\t */\n\tconst renderStep5 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <APIDocsStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 6: Success screen with all user data and other valuable options\n\t */\n\tconst renderStep6 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <SuccessStepV8 renderProps={props} />;\n\t}, []);\n\n\t// Step labels for device authentication flow\n\tconst stepLabels = useMemo(() => {\n\t\tif (deviceType === 'FIDO2') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Start FIDO in Browser',\n\t\t\t\t'Passkey confirmation',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else if (deviceType === 'MOBILE') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Push to Mobile App',\n\t\t\t\t'User Confirms on Mobile',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else {\n\t\t\t// SMS, Email, TOTP, WhatsApp\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Generate OTP/QR',\n\t\t\t\t'Validate OTP',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t}\n\t}, [deviceType]);\n\n\tconst shouldHideNextButton = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\tif (props.nav.currentStep === 0) {\n\t\t\treturn true; // Hide Next button on configuration step, use form submit\n\t\t}\n\t\tif (props.nav.currentStep === 1) {\n\t\t\treturn true; // Hide Next button on user login step, use authentication button\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\treturn (\n\t\t<>\n\t\t\t<MFAFlowBaseV8\n\t\t\t\tdeviceType={deviceType}\n\t\t\t\trenderStep0={renderStep0}\n\t\t\t\trenderStep1={renderStep1}\n\t\t\t\trenderStep2={renderStep2}\n\t\t\t\trenderStep3={renderStep3}\n\t\t\t\trenderStep4={renderStep4}\n\t\t\t\trenderStep5={renderStep5}\n\t\t\t\trenderStep6={renderStep6}\n\t\t\t\tvalidateStep0={validateStep0}\n\t\t\t\tstepLabels={stepLabels}\n\t\t\t\tshouldHideNextButton={shouldHideNextButton}\n\t\t\t\tflowType=\"device-auth\"\n\t\t\t/>\n\t\t\t<div style={{ height: '300px' }} />\n\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\n\t\t\t{/* User Login Modal for User Flow OAuth */}\n\t\t\t<UserLoginModalV8\n\t\t\t\tisOpen={showUserLoginModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\t\tpendingRegistrationRef.current = null;\n\t\t\t\t}}\n\t\t\t\tonTokenReceived={handleUserTokenReceived}\n\t\t\t\tenvironmentId={envIdForModal}\n\t\t\t/>\n\n\t\t\t{/* User Token Success Page - Show token after OAuth login */}\n\t\t\t{showUserTokenSuccess && userTokenForDisplay && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 10000,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\t\t\tboxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Success Header */}\n\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\twidth: '64px',\n\t\t\t\t\t\t\t\t\theight: '64px',\n\t\t\t\t\t\t\t\t\tborderRadius: '50%',\n\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>‚úÖ</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<h2 style={{ margin: '0 0 8px 0', fontSize: '24px', color: '#1f2937' }}>\n\t\t\t\t\t\t\t\tAuthentication Successful!\n\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\tYour user token has been obtained and is ready to use.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Username Dropdown */}\n\t\t\t\t\t\t{usernameFromToken && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUsernameDropdown(!showUsernameDropdown)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tpadding: 0,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: showUsernameDropdown ? '12px' : 0,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '16px', color: '#374151' }}>Username</h3>\n\t\t\t\t\t\t\t\t\t{showUsernameDropdown ? (\n\t\t\t\t\t\t\t\t\t\t<FiChevronUp size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t<FiChevronDown size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{showUsernameDropdown && (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{usernameFromToken}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(usernameFromToken);\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('Username copied to clipboard!');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüìã Copy Username\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Token Display */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<h3 style={{ margin: '0 0 12px 0', fontSize: '16px', color: '#374151' }}>\n\t\t\t\t\t\t\t\tUser Access Token\n\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{userTokenForDisplay}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(userTokenForDisplay);\n\t\t\t\t\t\t\t\t\ttoastV8.success('Token copied to clipboard!');\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüìã Copy Token\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Next Steps Info */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#eff6ff',\n\t\t\t\t\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#1e40af', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t<strong>Next:</strong> Click \"Continue with Registration\" to proceed with your{' '}\n\t\t\t\t\t\t\t\t{config.displayName} device registration using this user token.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Continue Button */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleContinueAfterUserLogin}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\tbackground: '#10b981',\n\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tboxShadow: '0 2px 8px rgba(16, 185, 129, 0.3)',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tContinue with Registration ‚Üí\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</>\n\t);\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default UnifiedMFARegistrationFlowV8;\n"},"tags":["fixable"],"source":null},{"category":"lint/correctness/noUnusedImports","severity":"warning","description":"This import is unused.","message":[{"elements":[],"content":"This "},{"elements":["Emphasis"],"content":"import"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused imports might be the result of an incomplete refactoring."}]]},{"log":["info",[{"elements":[],"content":"Unsafe fix: Remove the unused imports."}]]},{"diff":{"dictionary":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unifiedimport { UnifiedActivationStep } from './components/UnifiedActivationStep';\nimport { UnifiedDeviceRegistrationForm } from './components/UnifiedDeviceRegistrationForm';\nimport { UnifiedDeviceSelectionModal } from './components/UnifiedDeviceSelectionModal';\nimport { UnifiedSuccessStep } from './components/UnifiedSuccessStep';\nimport './UnifiedMFAFlow.css';\n\nexport default UnifiedMFARegistrationFlowV8;\n","ops":[{"diffOp":{"equal":{"range":[0,73]}}},{"equalLines":{"line_count":55}},{"diffOp":{"equal":{"range":[73,328]}}},{"diffOp":{"delete":{"range":[328,398]}}},{"diffOp":{"equal":{"range":[398,430]}}},{"equalLines":{"line_count":2800}},{"diffOp":{"equal":{"range":[430,476]}}}]}}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/UnifiedMFARegistrationFlowV8_Legacy.tsx"},"span":[3649,3671],"sourceCode":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\n * @description Unified MFA Registration Flow - Single component for all 6 device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Replace 6 device-specific flow components (SMS, Email, Mobile, WhatsApp, TOTP, FIDO2)\n * with a single configurable component using deviceFlowConfigs for device-specific behavior.\n *\n * Architecture:\n * - Configuration-driven using deviceFlowConfigs.ts\n * - Dynamic form rendering for simple devices (SMS, Email, WhatsApp)\n * - Custom components for complex devices (TOTP, FIDO2, Mobile)\n * - Integrates with MFACredentialContext and useWorkerToken hook\n * - Uses existing MFAFlowBaseV8 for 5-step framework\n *\n * @example\n * <UnifiedMFARegistrationFlowV8\n *   deviceType=\"SMS\"\n *   onSuccess={(result) => console.log('Device registered:', result.deviceId)}\n * />\n */\n\nimport * as React from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { FiChevronDown, FiChevronUp } from 'react-icons/fi';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { MFAHeaderV8 } from '@/v8/components/MFAHeaderV8';\nimport type { SearchableDropdownOption } from '@/v8/components/SearchableDropdownV8';\nimport { SearchableDropdownV8 } from '@/v8/components/SearchableDropdownV8';\nimport { SQLiteStatsDisplayV8 } from '@/v8/components/SQLiteStatsDisplayV8';\nimport { SuperSimpleApiDisplayV8 } from '@/v8/components/SuperSimpleApiDisplayV8';\nimport { UserLoginModalV8 } from '@/v8/components/UserLoginModalV8';\nimport { getDeviceConfig } from '@/v8/config/deviceFlowConfigs';\nimport type { DeviceConfigKey, DeviceRegistrationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport { PING_IDENTITY_COLORS } from '@/v8/constants/pingIdentityColors';\nimport { GlobalMFAProvider } from '@/v8/contexts/GlobalMFAContext';\nimport { MFACredentialProvider } from '@/v8/contexts/MFACredentialContext';\nimport { APIDocsStepV8 } from '@/v8/flows/shared/APIDocsStepV8';\nimport { SuccessStepV8 } from '@/v8/flows/shared/SuccessStepV8';\nimport { UserLoginStepV8 } from '@/v8/flows/shared/UserLoginStepV8';\nimport { useMFAPolicies } from '@/v8/hooks/useMFAPolicies';\nimport { useStepNavigationV8 } from '@/v8/hooks/useStepNavigationV8';\nimport { useUserSearch } from '@/v8/hooks/useUserSearch';\nimport { useWorkerToken } from '@/v8/hooks/useWorkerToken';\nimport { CredentialsServiceV8 } from '@/v8/services/credentialsServiceV8';\nimport { globalEnvironmentService } from '@/v8/services/globalEnvironmentService';\nimport { MfaAuthenticationServiceV8 } from '@/v8/services/mfaAuthenticationServiceV8';\nimport { type MFAFeatureFlag, MFAFeatureFlagsV8 } from '@/v8/services/mfaFeatureFlagsV8';\nimport MFAServiceV8_Legacy, { type RegisterDeviceParams } from '@/v8/services/mfaServiceV8_Legacy';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport type { TokenStatusInfo } from '@/v8/services/workerTokenStatusServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { ReturnTargetServiceV8U } from '@/v8u/services/returnTargetServiceV8U';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type MFAFlowBaseRenderProps, MFAFlowBaseV8 } from '../shared/MFAFlowBaseV8';\nimport type { DeviceAuthenticationPolicy, MFACredentials, MFAState } from '../shared/MFATypes';\nimport { UnifiedActivationStep } from './components/UnifiedActivationStep';\nimport { UnifiedDeviceRegistrationForm } from './components/UnifiedDeviceRegistrationForm';\nimport { UnifiedDeviceSelectionModal } from './components/UnifiedDeviceSelectionModal';\nimport { UnifiedSuccessStep } from './components/UnifiedSuccessStep';\nimport './UnifiedMFAFlow.css';\n\nconst MODULE_TAG = '[üîÑ UNIFIED-MFA-FLOW-V8]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedMFARegistrationFlowV8Props {\n\t/** Device type to render (optional - can be provided via navigation state) */\n\tdeviceType?: DeviceConfigKey;\n\n\t/** Optional initial credentials (for pre-filled forms) */\n\tinitialCredentials?: Partial<MFACredentials>;\n\n\t/** Optional callback when registration succeeds */\n\tonSuccess?: (result: DeviceRegistrationResult) => void;\n\n\t/** Optional callback when user cancels flow */\n\tonCancel?: () => void;\n\n\t/** Optional initial step (defaults to 0) */\n\tinitialStep?: number;\n\n\t/** Optional: Skip configuration step if already configured */\n\tskipConfiguration?: boolean;\n\n\t/** Optional: Force specific registration flow type */\n\tregistrationFlowType?: 'admin-active' | 'admin-activation' | 'user';\n}\n\n// ============================================================================\n// MFA FLOW SELECTION SCREEN\n// ============================================================================\n\ntype FlowMode = 'registration' | 'authentication';\n\n/** Map device types to their feature flags */\nconst DEVICE_FLAG_MAP: Record<DeviceConfigKey, MFAFeatureFlag> = {\n\tSMS: 'mfa_unified_sms',\n\tEMAIL: 'mfa_unified_email',\n\tMOBILE: 'mfa_unified_mobile',\n\tWHATSAPP: 'mfa_unified_whatsapp',\n\tTOTP: 'mfa_unified_totp',\n\tFIDO2: 'mfa_unified_fido2',\n};\n\nconst DEVICE_TYPES: { key: DeviceConfigKey; icon: string; name: string; description: string }[] = [\n\t{ key: 'SMS', icon: 'üì±', name: 'SMS', description: 'Receive OTP codes via text message' },\n\t{ key: 'EMAIL', icon: '‚úâÔ∏è', name: 'Email', description: 'Receive OTP codes via email' },\n\t{\n\t\tkey: 'TOTP',\n\t\ticon: 'üîê',\n\t\tname: 'Authenticator App (TOTP)',\n\t\tdescription: 'Use Google Authenticator, Authy, or similar',\n\t},\n\t{\n\t\tkey: 'MOBILE',\n\t\ticon: 'üì≤',\n\t\tname: 'Mobile Push',\n\t\tdescription: 'Receive push notifications on your phone',\n\t},\n\t{ key: 'WHATSAPP', icon: 'üí¨', name: 'WhatsApp', description: 'Receive OTP codes via WhatsApp' },\n\t{\n\t\tkey: 'FIDO2',\n\t\ticon: 'üîë',\n\t\tname: 'Security Key (FIDO2)',\n\t\tdescription: 'Use a hardware security key or passkey',\n\t},\n];\n\n/** Check if a device type is enabled via feature flags */\nconst isDeviceEnabled = (deviceKey: DeviceConfigKey): boolean => {\n\tconst flag = DEVICE_FLAG_MAP[deviceKey];\n\treturn MFAFeatureFlagsV8.isEnabled(flag);\n};\n\ninterface DeviceTypeSelectionScreenProps {\n\tonSelectDeviceType: (deviceType: DeviceConfigKey) => void;\n\tuserToken?: string | null;\n\tsetUserToken: (token: string | null) => void;\n}\n\nconst DeviceTypeSelectionScreen: React.FC<DeviceTypeSelectionScreenProps> = ({\n\tonSelectDeviceType,\n\tuserToken,\n\tsetUserToken,\n}) => {\n\tconst [flowMode, setFlowMode] = useState<FlowMode | null>(null);\n\tconst [environmentId, setEnvironmentId] = useState('');\n\tconst [username, setUsername] = useState('');\n\tconst [showDeviceSelectionModal, setShowDeviceSelectionModal] = useState(false);\n\tconst [showOTPModal, setShowOTPModal] = useState(false);\n\tconst [otpCode, setOtpCode] = useState('');\n\tconst [authenticationId, setAuthenticationId] = useState<string | null>(null);\n\tconst [selectedAuthDevice, setSelectedAuthDevice] = useState<{\n\t\tid: string;\n\t\ttype: string;\n\t\tnickname?: string;\n\t} | null>(null);\n\tconst [customLogoUrl, setCustomLogoUrl] = useState<string>('');\n\tconst [showAuthLoginModal, setShowAuthLoginModal] = useState(false);\n\tconst authEnvIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Load uploaded logo from localStorage on mount\n\tuseEffect(() => {\n\t\ttry {\n\t\t\tconst savedUpload = localStorage.getItem('custom-logo-upload');\n\t\t\tif (savedUpload) {\n\t\t\t\tconst uploadData = JSON.parse(savedUpload);\n\t\t\t\t// Handle both old format (objectUrl) and new format (base64Url)\n\t\t\t\tif (uploadData.base64Url) {\n\t\t\t\t\tsetCustomLogoUrl(uploadData.base64Url);\n\t\t\t\t} else if (uploadData.objectUrl) {\n\t\t\t\t\t// Old format - try to convert if possible, otherwise clear it\n\t\t\t\t\tconsole.warn('Old logo format detected - please re-upload your logo');\n\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load uploaded logo from localStorage:', error);\n\t\t\t// Clear corrupted data\n\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t}\n\t}, []);\n\n\t// Use worker token hook for token management\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Extract environment ID from worker token when available\n\tuseEffect(() => {\n\t\tconst extractEnvironmentId = async () => {\n\t\t\ttry {\n\t\t\t\tconst token = await workerTokenServiceV8.getToken();\n\t\t\t\tif (token && !environmentId) {\n\t\t\t\t\tconst parts = token.split('.');\n\t\t\t\t\tif (parts.length === 3) {\n\t\t\t\t\t\tconst payload = JSON.parse(atob(parts[1]));\n\t\t\t\t\t\tif (payload.environmentId) {\n\t\t\t\t\t\t\tsetEnvironmentId(payload.environmentId);\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`${MODULE_TAG} Environment ID extracted from worker token:`,\n\t\t\t\t\t\t\t\tpayload.environmentId\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Failed to extract environment ID from worker token:`, error);\n\t\t\t}\n\t\t};\n\n\t\textractEnvironmentId();\n\t}, [environmentId]);\n\n\tconst hasWorkerToken = workerToken.tokenStatus.isValid;\n\n\t// Use user search hook for user fetching and search\n\tconst {\n\t\tusers,\n\t\tisLoading: isLoadingUsers,\n\t\tsetSearchQuery,\n\t} = useUserSearch({\n\t\tenvironmentId,\n\t\ttokenValid: workerToken.tokenStatus.isValid,\n\t\tmaxPages: 100,\n\t\tuseCache: true,\n\t});\n\tconst tokenStatus = workerToken.tokenStatus;\n\n\t// Debug: Log users type to understand the issue\n\tuseEffect(() => {\n\t\tconsole.log(`${MODULE_TAG} users type check:`, {\n\t\t\tusers,\n\t\t\tisArray: Array.isArray(users),\n\t\t\ttype: typeof users,\n\t\t\tconstructor: users?.constructor?.name,\n\t\t});\n\t}, [users]);\n\n\t// Load Environment ID and username from global services on mount\n\tuseEffect(() => {\n\t\t// Initialize the service first to load from localStorage\n\t\tglobalEnvironmentService.initialize();\n\t\tconst savedEnvId = globalEnvironmentService.getEnvironmentId();\n\t\tif (savedEnvId) {\n\t\t\tsetEnvironmentId(savedEnvId);\n\t\t}\n\n\t\t// Load username from localStorage\n\t\tconst savedUsername = localStorage.getItem('mfa_unified_username');\n\t\tif (savedUsername) {\n\t\t\tsetUsername(savedUsername);\n\t\t}\n\t}, []);\n\n\t// Use MFA policies hook\n\tconst {\n\t\tpolicies,\n\t\tselectedPolicy,\n\t\tisLoading: isPoliciesLoading,\n\t\terror: policiesError,\n\t\tselectPolicy,\n\t\tdefaultPolicy,\n\t} = useMFAPolicies({\n\t\tenvironmentId,\n\t\ttokenIsValid: tokenStatus.isValid,\n\t\tautoLoad: true,\n\t\tautoSelectSingle: true,\n\t});\n\n\tconst selectedPolicyRef = useRef<DeviceAuthenticationPolicy | null>(null);\n\tuseEffect(() => {\n\t\tselectedPolicyRef.current = selectedPolicy ?? null;\n\t}, [selectedPolicy]);\n\n\tconst isPolicyDeviceEnabled = useCallback(\n\t\t(policy: DeviceAuthenticationPolicy | null, key: string) => {\n\t\t\tconst deviceConfig = policy?.[key] as { enabled?: boolean } | undefined;\n\t\t\treturn !!deviceConfig?.enabled;\n\t\t},\n\t\t[]\n\t);\n\n\tconst policyOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tpolicies.map((policy) => ({\n\t\t\t\tvalue: policy.id,\n\t\t\t\tlabel: policy.name,\n\t\t\t\t...(policy.default ? { secondaryLabel: '(Default)' } : {}),\n\t\t\t})),\n\t\t[policies]\n\t);\n\n\tconst userOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tArray.from(\n\t\t\t\tnew Map(\n\t\t\t\t\t(Array.isArray(users) ? users : []).map((user) => [\n\t\t\t\t\t\tuser.username,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvalue: user.username,\n\t\t\t\t\t\t\tlabel: user.username,\n\t\t\t\t\t\t\t...(user.email ? { secondaryLabel: user.email } : {}),\n\t\t\t\t\t\t} as SearchableDropdownOption,\n\t\t\t\t\t])\n\t\t\t\t).values()\n\t\t\t),\n\t\t[users]\n\t);\n\n\t// Auto-select default policy when policies load\n\tuseEffect(() => {\n\t\tif (defaultPolicy && !selectedPolicy) {\n\t\t\tselectPolicy(defaultPolicy.id);\n\t\t}\n\t}, [defaultPolicy, selectedPolicy, selectPolicy]);\n\n\t// Sync environment ID to global service and CredentialsServiceV8 when it changes\n\tuseEffect(() => {\n\t\tif (environmentId) {\n\t\t\tglobalEnvironmentService.setEnvironmentId(environmentId);\n\t\t\tlocalStorage.setItem('mfa_environmentId', environmentId);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tenvironmentId,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId, username: currentCreds.username }\n\t\t\t}));\n\t\t}\n\t}, [environmentId]);\n\n\t// Save username to localStorage and CredentialsServiceV8 when it changes\n\t// This ensures MFAFlowBase can read the username from its expected storage location\n\tuseEffect(() => {\n\t\tif (username) {\n\t\t\tlocalStorage.setItem('mfa_unified_username', username);\n\t\t\tlocalStorage.setItem('mfa_username', username);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tusername,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId: currentCreds.environmentId, username }\n\t\t\t}));\n\t\t}\n\t}, [username]);\n\n\t// Handle device selection for authentication\n\tconst handleDeviceSelectForAuthentication = async (device: {\n\t\tid: string;\n\t\ttype: string;\n\t\tdeviceName?: string;\n\t\tnickname?: string;\n\t}) => {\n\t\tconsole.log(`${MODULE_TAG} Selected device for authentication:`, device);\n\t\tsetShowDeviceSelectionModal(false);\n\t\tsetSelectedAuthDevice(device);\n\n\t\tconst policyId = selectedPolicy?.id;\n\t\tif (!policyId) {\n\t\t\ttoastV8.error('Please select an MFA Policy first');\n\t\t\treturn;\n\t\t}\n\n\t\t// Determine flow type and token\n\t\t// Admin flows should use worker tokens, not require user tokens\n\t\tconst flowType = userToken ? 'user' : 'admin';\n\t\tconst effectiveUserToken = flowType === 'user' ? userToken : undefined;\n\n\t\t// For admin flow, check if we have a valid worker token before proceeding\n\t\tif (flowType === 'admin' && !hasWorkerToken) {\n\t\t\ttoastV8.error('Admin flow requires a valid worker token. Please generate a worker token first.');\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\t// Initialize authentication with appropriate token\n\t\t\tconst response = await MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\tenvironmentId,\n\t\t\t\tusername: username.trim(),\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t\tdeviceId: device.id,\n\t\t\t\tregion: 'na',\n\t\t\t\ttokenType: flowType,\n\t\t\t\t...(effectiveUserToken && { userToken: effectiveUserToken }),\n\t\t\t});\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth initialized - full response:`, response);\n\t\t\tsetAuthenticationId(response.id);\n\n\t\t\tconst status = (response.status || '').toUpperCase();\n\t\t\tconst nextStep = (response.nextStep || '').toUpperCase();\n\t\t\tconst links = response._links as Record<string, { href?: string }> | undefined;\n\t\t\tconst hasOtpLink = !!(\n\t\t\t\tlinks &&\n\t\t\t\t(links.otp || links['otp.check'] || (links as Record<string, unknown>)['checkOtp'])\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth status:`, {\n\t\t\t\tstatus,\n\t\t\t\tnextStep,\n\t\t\t\thasOtpLink,\n\t\t\t\tdeviceType: device.type,\n\t\t\t});\n\n\t\t\t// Show appropriate UI based on response (normalize status/nextStep for PingOne variants)\n\t\t\tif (status === 'OTP_REQUIRED' || nextStep === 'OTP_REQUIRED' || hasOtpLink) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Opening OTP modal for device:`, device.type);\n\t\t\t\tsetShowOTPModal(true);\n\t\t\t\ttoastV8.success(`Verification code sent to your ${device.type} device`);\n\t\t\t} else if (status === 'ASSERTION_REQUIRED' || nextStep === 'ASSERTION_REQUIRED') {\n\t\t\t\tconsole.log(`${MODULE_TAG} FIDO2 assertion required`);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'FIDO2 authentication required. Please use /v8/mfa-config for FIDO2 authentication.'\n\t\t\t\t);\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'PUSH_CONFIRMATION_REQUIRED' ||\n\t\t\t\tnextStep === 'PUSH_CONFIRMATION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Push confirmation required`);\n\t\t\t\ttoastV8.success('Push notification sent! Please approve on your mobile device.');\n\t\t\t\ttoastV8.info('Complete authentication at /v8/mfa-config for push polling.');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (status === 'COMPLETED') {\n\t\t\t\ttoastV8.success('Authentication completed successfully!');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'DEVICE_SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'DEVICE_SELECTION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Device selection required - showing modal again`);\n\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t} else {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Unexpected authentication status:`, {\n\t\t\t\t\tstatus,\n\t\t\t\t\tnextStep,\n\t\t\t\t\tresponse,\n\t\t\t\t});\n\t\t\t\ttoastV8.info(`Authentication status: ${status || nextStep || 'UNKNOWN'}`);\n\t\t\t\t// Stay in authentication flow so user can try another device\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to initialize authentication:`, error);\n\n\t\t\t// Enhanced error handling for NO_USABLE_DEVICES\n\t\t\tlet errorMessage = 'Authentication failed: ';\n\t\t\tif (error instanceof Error) {\n\t\t\t\tconst errorStr = error.message.toLowerCase();\n\n\t\t\t\t// Check for NO_USABLE_DEVICES or device availability errors\n\t\t\t\tif (\n\t\t\t\t\terrorStr.includes('no usable devices') ||\n\t\t\t\t\terrorStr.includes('too many') ||\n\t\t\t\t\terrorStr.includes('cooldown') ||\n\t\t\t\t\terrorStr.includes('blocked')\n\t\t\t\t) {\n\t\t\t\t\terrorMessage = '‚ö†Ô∏è Device Temporarily Unavailable\\n\\n';\n\n\t\t\t\t\tif (errorStr.includes('cooldown') || errorStr.includes('too many')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Too many notifications have been sent to this device. It is temporarily in cooldown. ';\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Please wait a few minutes and try again, or select a different device.';\n\t\t\t\t\t} else if (errorStr.includes('blocked')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'This device has been blocked. Please contact your administrator or use a different device.';\n\t\t\t\t\t} else {\n\t\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terrorMessage += 'Unknown error';\n\t\t\t}\n\n\t\t\ttoastV8.error(errorMessage, { duration: 8000 });\n\t\t\t// Do NOT set flowMode(null) - keep user in authentication flow so they can retry or select another device\n\t\t}\n\t};\n\n\t// Handle OTP verification\n\tconst handleVerifyOTP = async () => {\n\t\tif (!authenticationId || !selectedAuthDevice) {\n\t\t\ttoastV8.error('Authentication session not found');\n\t\t\treturn;\n\t\t}\n\n\t\tif (otpCode.length !== 6) {\n\t\t\ttoastV8.error('Please enter a 6-digit code');\n\t\t\treturn;\n\t\t}\n\n\t\t// Get worker token for API call\n\t\tconst workerTokenForOTP = await workerTokenServiceV8.getToken();\n\n\t\tconsole.log(`${MODULE_TAG} OTP verification debug:`, {\n\t\t\tenvironmentId,\n\t\t\tusername: username.trim(),\n\t\t\tauthenticationId,\n\t\t\totpCode,\n\t\t\thasEnvironmentId: !!environmentId,\n\t\t\tenvIdLength: environmentId?.length,\n\t\t\thasWorkerToken: !!workerTokenForOTP,\n\t\t\tworkerTokenLength: workerTokenForOTP?.length,\n\t\t});\n\n\t\ttry {\n\t\t\t// Use backend proxy to avoid CORS issues\n\t\t\tconst response = await fetch('/api/pingone/mfa/validate-otp-for-device', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tenvironmentId,\n\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\tdeviceAuthId: authenticationId,\n\t\t\t\t\totp: otpCode,\n\t\t\t\t\tregion: 'na',\n\t\t\t\t\tworkerToken: workerTokenForOTP,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\n\t\t\t\tthrow new Error(errorData.error || errorData.message || `HTTP ${response.status}`);\n\t\t\t}\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.status === 'COMPLETED' || result.status === 'completed') {\n\t\t\t\ttoastV8.success('‚úÖ Authentication completed successfully!');\n\t\t\t\tsetShowOTPModal(false);\n\t\t\t\tsetFlowMode(null);\n\t\t\t\tsetOtpCode('');\n\t\t\t} else {\n\t\t\t\ttoastV8.error('Invalid code. Please try again.');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} OTP verification failed:`, error);\n\t\t\ttoastV8.error(\n\t\t\t\t`Verification failed: ${error instanceof Error ? error.message : 'Unknown error'}`\n\t\t\t);\n\t\t}\n\t};\n\n\t// Step 1: Choose Registration or Authentication\n\tif (!flowMode) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '12px' }}>\n\t\t\t\t\t{/* Header */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tboxShadow: '0 4px 12px rgba(239, 68, 68, 0.2)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h1\n\t\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîê MFA Unified Flow\n\t\t\t\t\t\t</h1>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tChoose what you want to do with MFA devices.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Configuration Section */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 12px 0',\n\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfiguration\n\t\t\t\t\t\t</h2>\n\n\t\t\t\t\t\t{/* Custom Logo URL */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-url\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[800],\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüé® Custom Logo URL (Optional)\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tDisplay a custom logo in the OTP verification modal\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t{/* URL Input */}\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tid=\"custom-logo-url\"\n\t\t\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\t\t\tvalue={customLogoUrl}\n\t\t\t\t\t\t\t\tonChange={(e) => setCustomLogoUrl(e.target.value)}\n\t\t\t\t\t\t\t\tplaceholder=\"https://example.com/logo.png\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\tpadding: '10px 14px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[900],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = `0 0 0 3px ${PING_IDENTITY_COLORS.primary[200]}`;\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.neutral[300];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* File Upload Section */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '13px', color: PING_IDENTITY_COLORS.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\tOR\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"file\"\n\t\t\t\t\t\t\t\t\tid=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\taccept=\"image/*\"\n\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\tconst file = e.target.files?.[0];\n\t\t\t\t\t\t\t\t\t\tif (!file) return;\n\n\t\t\t\t\t\t\t\t\t\t// Validate file type (images only)\n\t\t\t\t\t\t\t\t\t\tif (!file.type.startsWith('image/')) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Please select a logo file (JPG, PNG, etc.)');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Validate file size (max 5MB)\n\t\t\t\t\t\t\t\t\t\tif (file.size > 5 * 1024 * 1024) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('File size must be less than 5MB');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Convert file to base64 for persistence\n\t\t\t\t\t\t\t\t\t\tconst reader = new FileReader();\n\t\t\t\t\t\t\t\t\t\treader.onload = (event) => {\n\t\t\t\t\t\t\t\t\t\t\tconst base64Url = event.target?.result as string;\n\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl(base64Url);\n\n\t\t\t\t\t\t\t\t\t\t\t// Store base64 data for persistence\n\t\t\t\t\t\t\t\t\t\t\tconst uploadData = {\n\t\t\t\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\t\t\t\tbase64Url: base64Url,\n\t\t\t\t\t\t\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\t\t\t// Save to localStorage for persistence\n\t\t\t\t\t\t\t\t\t\t\tlocalStorage.setItem('custom-logo-upload', JSON.stringify(uploadData));\n\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.success(`Logo uploaded: ${file.name}`);\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.onerror = () => {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to read uploaded file');\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.readAsDataURL(file);\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'none' }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.primary[500],\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.primary[600]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '500',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[700];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìÅ Upload Logo File\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[500],\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tJPG, PNG, GIF (max 5MB)\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{customLogoUrl && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.neutral[50],\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tLogo Preview:\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\talt=\"Custom logo\"\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonError={() => {\n\t\t\t\t\t\t\t\t\t\t\t// Handle broken image URLs\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Failed to load custom logo URL');\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl('');\n\t\t\t\t\t\t\t\t\t\t\t\t// Clear uploaded file from localStorage\n\t\t\t\t\t\t\t\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.accent.pingRed[500],\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.accent.pingRed[600]}`,\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[600];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[500];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRemove Logo\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Environment ID - Hide when worker token is available */}\n\t\t\t\t\t\t{!hasWorkerToken && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"env-id\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tEnvironment ID\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"env-id\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setEnvironmentId(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* SQLite Database Stats */}\n\t\t\t\t\t\t{environmentId && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<SQLiteStatsDisplayV8\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tcompact={false}\n\t\t\t\t\t\t\t\t\trefreshInterval={30}\n\t\t\t\t\t\t\t\t\tshowRefreshButton={true}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Username */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUsername\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{environmentId && tokenStatus.isValid ? (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\toptions={userOptions}\n\t\t\t\t\t\t\t\t\tonChange={setUsername}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Type to search across 16,000+ users...\"\n\t\t\t\t\t\t\t\t\tisLoading={isLoadingUsers}\n\t\t\t\t\t\t\t\t\tonSearchChange={setSearchQuery}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setUsername(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* MFA Policy Dropdown */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"mfa-policy\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tMFA Policy\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{isPoliciesLoading ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tLoading policies...\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policiesError ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#ef4444', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tError loading policies: {policiesError}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policies.length === 0 ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tNo MFA policies found. Please check your environment ID and worker token.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"mfa-policy\"\n\t\t\t\t\t\t\t\t\tvalue={selectedPolicy?.id || ''}\n\t\t\t\t\t\t\t\t\toptions={policyOptions}\n\t\t\t\t\t\t\t\t\tonChange={selectPolicy}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Select an MFA policy...\"\n\t\t\t\t\t\t\t\t\tisLoading={isPoliciesLoading}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tSelect the MFA policy to use for device registration\n\t\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t\t{/* Policy Summary - Collapsible */}\n\t\t\t\t\t\t\t{selectedPolicy && (\n\t\t\t\t\t\t\t\t<details\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<summary\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\tuserSelect: 'none',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüìã Policy Details\n\t\t\t\t\t\t\t\t\t</summary>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '12px', fontSize: '13px', color: '#4b5563' }}>\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Policy Name:</strong> {String(selectedPolicy.name)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedPolicy.default && (\n\t\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px', color: '#059669' }}>\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>‚úì Default Policy</strong>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Enabled Devices:</strong>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '6px' }}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'sms') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì± SMS\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'email') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t‚úâÔ∏è Email\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'totp') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîê TOTP\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'fido2') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîë FIDO2\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'mobile') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì≤ Mobile\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'voice') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüìû Voice\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</details>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Worker Token Status */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t\tpaddingRight: '16px',\n\t\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={setEnvironmentId}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* User Token Status */}\n\t\t\t\t\t\t\t{userToken && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\t'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05))',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #10b981',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '20px' }}>üë§</span>\n\t\t\t\t\t\t\t\t\t\t<strong style={{ color: '#047857', fontSize: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t\tUser Token Active\n\t\t\t\t\t\t\t\t\t\t</strong>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: '14px', color: '#059669', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t\t‚úì User authentication token available\n\t\t\t\t\t\t\t\t\t\t<br />‚úì Ready for User Flow device registration\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Flow Mode Selection */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',\n\t\t\t\t\t\t\tgap: '16px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Registration Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => setFlowMode('registration')}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>‚ûï</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#047857',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Registration\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tRegister a new MFA device for a user. Create SMS, Email, TOTP, Mobile Push,\n\t\t\t\t\t\t\t\t\t\tWhatsApp, or FIDO2 devices.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t{/* Authentication Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tif (!userToken) {\n\t\t\t\t\t\t\t\t\tsetShowAuthLoginModal(true);\n\t\t\t\t\t\t\t\t\ttoastV8.info('üîê Please complete user login before device authentication.', {\n\t\t\t\t\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-4px)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 8px 24px rgba(59, 130, 246, 0.2)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>üîì</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#1d4ed8',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Authentication\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tAuthenticate using an existing MFA device. Verify user identity with OTP, push\n\t\t\t\t\t\t\t\t\t\tnotification, or security key.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{showAuthLoginModal && (\n\t\t\t\t\t<UserLoginModalV8\n\t\t\t\t\t\tisOpen={showAuthLoginModal}\n\t\t\t\t\t\tonClose={() => setShowAuthLoginModal(false)}\n\t\t\t\t\t\tonTokenReceived={(token) => {\n\t\t\t\t\t\t\tsetUserToken(token);\n\t\t\t\t\t\t\tsetShowAuthLoginModal(false);\n\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tenvironmentId={authEnvIdForModal}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</>\n\t\t);\n\t}\n\n\t// Authentication flow - dedicated view (device selection + OTP modals only; no registration grid)\n\tif (flowMode === 'authentication') {\n\t\treturn (\n\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\tsetSelectedAuthDevice(null);\n\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t‚Üê Back\n\t\t\t\t\t</button>\n\t\t\t\t\t<h1\n\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t>\n\t\t\t\t\t\tüîì Device Authentication\n\t\t\t\t\t</h1>\n\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\t{selectedAuthDevice && !showOTPModal\n\t\t\t\t\t\t\t? `Authenticating with ${selectedAuthDevice.type} ‚Äî enter the code when prompted.`\n\t\t\t\t\t\t\t: `Select an MFA device to authenticate for ${username || 'the user'}`}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t\t{!showDeviceSelectionModal && !showOTPModal && (\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowDeviceSelectionModal(true)}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tSelect MFA device\n\t\t\t\t\t</button>\n\t\t\t\t)}\n\t\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\t\tonClose={() => {\n\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t// Keep flowMode so user stays in auth flow; only clear if they click Back\n\t\t\t\t\t}}\n\t\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\t\tusername={username}\n\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t/>\n\t\t\t\t{showOTPModal && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.6)',\n\t\t\t\t\t\t\tbackdropFilter: 'blur(4px)',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t\t\tanimation: 'fadeIn 0.2s ease-out',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t{`\n\t\t\t\t\t\t\t@keyframes fadeIn {\n\t\t\t\t\t\t\t\tfrom { opacity: 0; }\n\t\t\t\t\t\t\t\tto { opacity: 1; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes slideUp {\n\t\t\t\t\t\t\t\tfrom { \n\t\t\t\t\t\t\t\t\topacity: 0;\n\t\t\t\t\t\t\t\t\ttransform: translateY(20px); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tto { \n\t\t\t\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t\t\t\t\ttransform: translateY(0); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes pulse {\n\t\t\t\t\t\t\t\t0%, 100% { opacity: 1; }\n\t\t\t\t\t\t\t\t50% { opacity: 0.5; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`}\n\t\t\t\t\t\t</style>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\tborderRadius: '24px',\n\t\t\t\t\t\t\t\tpadding: '48px 40px',\n\t\t\t\t\t\t\t\tmaxWidth: '480px',\n\t\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\t\tboxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',\n\t\t\t\t\t\t\t\tanimation: 'slideUp 0.3s ease-out',\n\t\t\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Logo Area */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '32px' }}>\n\t\t\t\t\t\t\t\t{customLogoUrl ? (\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\t\talt=\"Organization logo\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '120px',\n\t\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonError={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\t// Fallback to default icon if image fails to load\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.display = 'none';\n\t\t\t\t\t\t\t\t\t\t\t\tconst fallback = document.createElement('div');\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.style.cssText = `\n\t\t\t\t\t\t\t\t\t\t\t\twidth: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\theight: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: 0 auto 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: center;\n\t\t\t\t\t\t\t\t\t\t\t\tjustifyContent: center;\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: 36px;\n\t\t\t\t\t\t\t\t\t\t\t\tboxShadow: 0 10px 25px rgba(102, 126, 234, 0.3);\n\t\t\t\t\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.textContent = 'üîê';\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.parentElement!.appendChild(fallback);\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\theight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto 20px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '20px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '36px',\n\t\t\t\t\t\t\t\t\t\t\tboxShadow: '0 10px 25px rgba(102, 126, 234, 0.3)',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüîê\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tVerification Code\n\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\tEnter the 6-digit code sent to your <strong>{selectedAuthDevice?.type}</strong>{' '}\n\t\t\t\t\t\t\t\t\tdevice\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* OTP Input */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\t\t\tplaceholder=\"‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢\"\n\t\t\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tletterSpacing: '12px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow: otpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{otpCode.length > 0 && otpCode.length < 6 && (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\t\tanimation: 'pulse 2s ease-in-out infinite',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{6 - otpCode.length} more digit{6 - otpCode.length !== 1 ? 's' : ''} needed\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Resend Code Button */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={async () => {\n\t\t\t\t\t\t\t\t\t\tif (!selectedAuthDevice || !authenticationId) return;\n\t\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.info('Resending verification code...');\n\t\t\t\t\t\t\t\t\t\t\t// Re-initialize authentication to resend code\n\t\t\t\t\t\t\t\t\t\t\tconst response =\n\t\t\t\t\t\t\t\t\t\t\t\tawait MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\t\t\t\t\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\t\t\t\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicy?.id || '',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceId: selectedAuthDevice.id,\n\t\t\t\t\t\t\t\t\t\t\t\t\tregion: 'na',\n\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tif (response.status?.toUpperCase() === 'OTP_REQUIRED') {\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('New code sent to your device!');\n\t\t\t\t\t\t\t\t\t\t\t\tsetAuthenticationId(response.id);\n\t\t\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to resend code');\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Resend error:', error);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tcolor: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'transparent';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚Üª Resend Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Action Buttons */}\n\t\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#d1d5db';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f9fafb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'white';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6\n\t\t\t\t\t\t\t\t\t\t\t\t? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '#d1d5db',\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (otpCode.length === 6) {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚úì Verify Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Help Text */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<strong style={{ color: '#111827' }}>Didn't receive the code?</strong>\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\tCheck your spam folder or click \"Resend Code\" above\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t);\n\t}\n\n\t// Registration flow - show device type selection cards\n\treturn (\n\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t{/* Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #10b981 0%, #047857 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => setFlowMode(null)}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t‚Üê Back\n\t\t\t\t</button>\n\t\t\t\t<h1 style={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}>\n\t\t\t\t\t‚ûï Register MFA Device\n\t\t\t\t</h1>\n\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\tSelect a device type to register for {username || 'the user'}\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Device Type Cards */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',\n\t\t\t\t\tgap: '16px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t{DEVICE_TYPES.map((device) => {\n\t\t\t\t\tconst enabled = isDeviceEnabled(device.key);\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tkey={device.key}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => enabled && onSelectDeviceType(device.key)}\n\t\t\t\t\t\t\tdisabled={!enabled}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tbackground: enabled ? '#ffffff' : '#f9fafb',\n\t\t\t\t\t\t\t\tborder: `2px solid ${enabled ? '#e5e7eb' : '#f3f4f6'}`,\n\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\tcursor: enabled ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\topacity: enabled ? 1 : 0.5,\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#10b981';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ecfdf5';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>{device.icon}</span>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{device.name}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280' }}>{device.description}</p>\n\t\t\t\t\t\t\t{!enabled && (\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '12px', color: '#9ca3af' }}>\n\t\t\t\t\t\t\t\t\t(Not enabled)\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</div>\n\n\t\t\t{/* Device Selection Modal for Authentication */}\n\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t}}\n\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\tusername={username}\n\t\t\t\tenvironmentId={environmentId}\n\t\t\t/>\n\n\t\t\t{/* OTP Modal for Authentication */}\n\t\t\t{showOTPModal && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '400px',\n\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\tboxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '600' }}>\n\t\t\t\t\t\t\tEnter Verification Code\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '0 0 20px 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tCheck your {selectedAuthDevice?.type} device for the code\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\tplaceholder=\"000000\"\n\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 16px',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\tletterSpacing: '8px',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tmarginBottom: '20px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: otpCode.length === 6 ? '#3b82f6' : '#9ca3af',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tVerify\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Wrapper Component\n *\n * Wraps the content with MFACredentialProvider to provide global credential state\n */\nexport const UnifiedMFARegistrationFlowV8: React.FC<UnifiedMFARegistrationFlowV8Props> = (\n\tprops\n) => {\n\tconst location = useLocation();\n\n\t// Get device type from props or location state (can be undefined)\n\tconst initialDeviceType =\n\t\tprops.deviceType || (location.state as { deviceType?: DeviceConfigKey })?.deviceType;\n\n\t// State for selected device type (allows user to select if not provided)\n\tconst [selectedDeviceType, setSelectedDeviceType] = useState<DeviceConfigKey | undefined>(\n\t\tinitialDeviceType\n\t);\n\n\t// User token state for OAuth authentication (User Flow)\n\tconst [userToken, setUserToken] = useState<string | null>(() => {\n\t\t// Check if we already have a user token from previous OAuth flow\n\t\tconst savedCreds = CredentialsServiceV8.loadCredentials('user-login-v8', {\n\t\t\tflowKey: 'user-login-v8',\n\t\t\tflowType: 'oauth',\n\t\t\tincludeClientSecret: false,\n\t\t\tincludeRedirectUri: false,\n\t\t\tincludeLogoutUri: false,\n\t\t\tincludeScopes: false,\n\t\t});\n\t\treturn savedCreds?.accessToken || null;\n\t});\n\n\t// If no device type selected, show device type selection screen\n\tif (!selectedDeviceType) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<MFAHeaderV8\n\t\t\t\t\ttitle=\"MFA Unified Flow\"\n\t\t\t\t\tdescription=\"Register or authenticate MFA devices\"\n\t\t\t\t\tversionTag=\"V8\"\n\t\t\t\t\tcurrentPage=\"registration\"\n\t\t\t\t\tshowBackToMain={true}\n\t\t\t\t\theaderColor=\"pingRed\"\n\t\t\t\t/>\n\t\t\t\t<GlobalMFAProvider>\n\t\t\t\t\t<MFACredentialProvider>\n\t\t\t\t\t\t<DeviceTypeSelectionScreen\n\t\t\t\t\t\t\tonSelectDeviceType={setSelectedDeviceType}\n\t\t\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</MFACredentialProvider>\n\t\t\t\t</GlobalMFAProvider>\n\t\t\t\t{/* API display (bottom of page) */}\n\t\t\t\t<div style={{ marginTop: '24px' }}>\n\t\t\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\t\t\t\t</div>\n\t\t\t</>\n\t\t);\n\t}\n\n\treturn (\n\t\t<GlobalMFAProvider>\n\t\t\t<MFACredentialProvider>\n\t\t\t\t<UnifiedMFARegistrationFlowContent\n\t\t\t\t\t{...props}\n\t\t\t\t\tdeviceType={selectedDeviceType}\n\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t/>\n\t\t\t</MFACredentialProvider>\n\t\t</GlobalMFAProvider>\n\t);\n};\n\n// ============================================================================\n// CONTENT COMPONENT (MAIN LOGIC)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Content Component\n *\n * Contains the actual flow logic and integrates with:\n * - MFACredentialContext (global credential state)\n * - useWorkerToken hook (token status and auto-refresh)\n * - deviceFlowConfigs (device-specific configuration)\n * - MFAFlowBaseV8 (5-step framework)\n */\nconst UnifiedMFARegistrationFlowContent: React.FC<\n\tRequired<Pick<UnifiedMFARegistrationFlowV8Props, 'deviceType'>> &\n\t\tOmit<UnifiedMFARegistrationFlowV8Props, 'deviceType'> & {\n\t\t\tuserToken: string | null;\n\t\t\tsetUserToken: (token: string | null) => void;\n\t\t}\n> = ({ deviceType, onCancel, userToken, setUserToken }) => {\n\t// ========================================================================\n\t// CONFIGURATION\n\t// ========================================================================\n\n\t// React Router navigation\n\tconst navigate = useNavigate();\n\n\t// Load device-specific configuration\n\tconst config = useMemo(() => {\n\t\treturn getDeviceConfig(deviceType);\n\t}, [deviceType]);\n\n\t// ========================================================================\n\t// USER FLOW OAUTH STATE\n\t// ========================================================================\n\n\t// State for User Login Modal (OAuth authentication for User Flow)\n\tconst [showUserLoginModal, setShowUserLoginModal] = useState(false);\n\tconst [showUserTokenSuccess, setShowUserTokenSuccess] = useState(false);\n\tconst [userTokenForDisplay, setUserTokenForDisplay] = useState<string>('');\n\tconst [usernameFromToken, setUsernameFromToken] = useState<string>('');\n\tconst [showUsernameDropdown, setShowUsernameDropdown] = useState(false);\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\tconst envIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Pending registration data while waiting for OAuth (use ref to avoid stale closure)\n\tconst pendingRegistrationRef = useRef<{\n\t\tdeviceType: DeviceConfigKey;\n\t\tfields: Record<string, string>;\n\t\tflowType: string;\n\t\tprops: MFAFlowBaseRenderProps;\n\t} | null>(null);\n\n\t// Worker token state for validation in registration flow\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Detect OAuth callback and re-open modal if needed\n\tuseEffect(() => {\n\t\tconst urlParams = new URLSearchParams(window.location.search);\n\t\tconst code = urlParams.get('code');\n\t\tconst hasStoredState = sessionStorage.getItem('user_login_state_v8');\n\n\t\t// If we have OAuth callback params and stored state, re-open the modal to process callback\n\t\t// But only if we don't already have a user token (to prevent reopening after silent auth)\n\t\tif (code && hasStoredState && !showUserLoginModal && !userToken) {\n\t\t\tconsole.log('[UNIFIED-FLOW] OAuth callback detected - re-opening modal to process');\n\t\t\tsetShowUserLoginModal(true);\n\t\t}\n\t}, [showUserLoginModal, userToken]);\n\n\t// ========================================================================\n\t// STEP VALIDATION\n\t// ========================================================================\n\n\t/**\n\t * Validate Step 0 (Configuration)\n\t */\n\tconst validateStep0 = useCallback(\n\t\t(\n\t\t\tcredentials: MFACredentials,\n\t\t\ttoken: TokenStatusInfo,\n\t\t\tnavigation: ReturnType<typeof useStepNavigationV8>\n\t\t) => {\n\t\t\t// Always check for valid worker token (required for MFA device operations)\n\t\t\tif (!token.isValid) {\n\t\t\t\tnavigation.setValidationErrors(['Invalid or expired worker token']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Check required configuration\n\t\t\tif (!credentials.environmentId || !credentials.username) {\n\t\t\t\tnavigation.setValidationErrors(['Environment ID and Username are required']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\t\t[]\n\t);\n\n\t// ========================================================================\n\t// STEP RENDERERS\n\t// ========================================================================\n\n\t/**\n\t * Perform device registration API call (with token already available)\n\t */\n\tconst performRegistrationWithToken = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string,\n\t\t\ttoken?: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== PERFORM REGISTRATION WITH TOKEN =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Token:', token ? `Present (${token.length} chars)` : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setIsLoading available:', typeof props.setIsLoading);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setCredentials available:', typeof props.setCredentials);\n\n\t\t\ttry {\n\t\t\t\tprops.setIsLoading(true);\n\n\t\t\t\t// Update credentials with device fields and user token if provided\n\t\t\t\tprops.setCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tflowType, // Store flowType so activation step knows if OTP is required\n\t\t\t\t\t...fields,\n\t\t\t\t\t...(flowType === 'user' && token\n\t\t\t\t\t\t? { userToken: token, tokenType: 'user' }\n\t\t\t\t\t\t: flowType !== 'user'\n\t\t\t\t\t\t\t? { tokenType: 'worker' }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t}));\n\n\t\t\t\t// Register the device using proper API call\n\t\t\t\t// CRITICAL: Flow-specific device status\n\t\t\t\t// - Admin flow: ACTIVE (no OTP sent, device ready immediately)\n\t\t\t\t// - Admin ACTIVATION_REQUIRED: ACTIVATION_REQUIRED (sends OTP for admin to activate)\n\t\t\t\t// - User flow: ACTIVATION_REQUIRED (sends OTP for user to activate)\n\t\t\t\t// - FIDO2: ACTIVE (WebAuthn verification happens during registration)\n\t\t\t\tlet deviceStatus: 'ACTIVE' | 'ACTIVATION_REQUIRED' | undefined;\n\n\t\t\t\t// Determine device status based on flow type (applies to all device types including FIDO2)\n\t\t\t\tif (flowType === 'admin-active') {\n\t\t\t\t\tdeviceStatus = 'ACTIVE';\n\t\t\t\t} else if (flowType === 'admin-activation') {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED';\n\t\t\t\t} else {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED'; // user flow\n\t\t\t\t}\n\n\t\t\t\t// Special note for FIDO2: WebAuthn verification proves device works,\n\t\t\t\t// but we still respect the flow type for status determination\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t'[UNIFIED-FLOW] FIDO2 device - status determined by flow type:',\n\t\t\t\t\t\tdeviceStatus\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device status determined:', {\n\t\t\t\t\tflowType,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tdeviceStatus,\n\t\t\t\t\totpWillBeSent: deviceStatus === 'ACTIVATION_REQUIRED',\n\t\t\t\t\treason:\n\t\t\t\t\t\tselectedDeviceType === 'FIDO2'\n\t\t\t\t\t\t\t? 'FIDO2 - ACTIVE after WebAuthn verification'\n\t\t\t\t\t\t\t: 'User flow - OTP required for activation',\n\t\t\t\t});\n\n\t\t\t\t// Use same parameter construction as working MFA flows\n\t\t\t\ttype RegisterDeviceParamsWithToken = RegisterDeviceParams & {\n\t\t\t\t\ttokenType?: 'worker' | 'user';\n\t\t\t\t\tuserToken?: string | undefined;\n\t\t\t\t};\n\t\t\t\tlet baseParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\tenvironmentId: props.credentials.environmentId,\n\t\t\t\t\tusername: props.credentials.username,\n\t\t\t\t\ttype: selectedDeviceType,\n\t\t\t\t};\n\t\t\t\t// Per rightTOTP.md: Pass token type and user token if available\n\t\t\t\tif (flowType === 'user' && token) {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'user',\n\t\t\t\t\t\tuserToken: token,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'worker',\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Always include status for all device types\n\t\t\t\t// FIDO2: Set to ACTIVE since WebAuthn verification proves device works\n\t\t\t\t// Other devices: Set based on flow type (admin-active = ACTIVE, others = ACTIVATION_REQUIRED)\n\t\t\t\tif (deviceStatus !== undefined) {\n\t\t\t\t\tbaseParams.status = deviceStatus;\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registration base params:', {\n\t\t\t\t\tenvironmentId: baseParams.environmentId,\n\t\t\t\t\tusername: baseParams.username,\n\t\t\t\t\ttype: baseParams.type,\n\t\t\t\t\ttokenType: baseParams.tokenType,\n\t\t\t\t\tstatus: baseParams.status,\n\t\t\t\t\tflowType,\n\t\t\t\t});\n\n\t\t\t\t// Map form field names to API field names\n\t\t\t\t// Form uses 'deviceName' but API expects 'nickname' or 'name'\n\t\t\t\tconst mappedFields: Record<string, string> = { ...fields };\n\t\t\t\tif (mappedFields.deviceName) {\n\t\t\t\t\tmappedFields.nickname = mappedFields.deviceName;\n\t\t\t\t\tmappedFields.name = mappedFields.deviceName;\n\t\t\t\t\tdelete mappedFields.deviceName;\n\t\t\t\t}\n\n\t\t\t\t// Format phone number for SMS/WhatsApp devices\n\t\t\t\t// Form sends: { phoneNumber: '9725231586', countryCode: '+1' }\n\t\t\t\t// API expects: { phone: '+1.9725231586' }\n\t\t\t\tif (mappedFields.phoneNumber && mappedFields.countryCode) {\n\t\t\t\t\tconst countryCode = mappedFields.countryCode.replace('+', ''); // Remove + for formatting\n\t\t\t\t\tconst phoneNumber = mappedFields.phoneNumber.replace(/\\D/g, ''); // Remove non-digits\n\t\t\t\t\tmappedFields.phone = `+${countryCode}.${phoneNumber}`;\n\t\t\t\t\tconsole.log('[UNIFIED-FLOW] Formatted phone:', mappedFields.phone);\n\t\t\t\t\tdelete mappedFields.phoneNumber;\n\t\t\t\t\tdelete mappedFields.countryCode;\n\t\t\t\t}\n\n\t\t\t\t// Include device-specific fields (phone, email, etc.)\n\t\t\t\tconst deviceParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\t...baseParams,\n\t\t\t\t\t...mappedFields,\n\t\t\t\t\t// Include policy for TOTP devices (required for secret and keyUri to be returned)\n\t\t\t\t\t...(selectedDeviceType === 'TOTP' && selectedPolicyRef.current\n\t\t\t\t\t\t? { policy: selectedPolicyRef.current.id }\n\t\t\t\t\t\t: {}),\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registering device with params:', deviceParams);\n\n\t\t\t\tconst result = await MFAServiceV8_Legacy.registerDevice(deviceParams);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device registered:', result);\n\n\t\t\t\t// Update MFA state with device info\n\t\t\t\tconst registrationResult = result as unknown as Record<string, unknown>;\n\n\t\t\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result for TOTP:', {\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\tqrCode: registrationResult.qrCode,\n\t\t\t\t\t\tqrCodeUrl: registrationResult.qrCodeUrl,\n\t\t\t\t\t\tsecret: registrationResult.secret,\n\t\t\t\t\t\ttotpSecret: registrationResult.totpSecret,\n\t\t\t\t\t\tfullResult: result,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// ===============================================\n\n\t\t\t\t// Clear stored registration data after successful use\n\t\t\t\tlocalStorage.removeItem('mfa_registration_flow_type');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_fields');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_device_type');\n\n\t\t\t\tprops.setMfaState((prev) => {\n\t\t\t\t\t// TOTP: QR code will be rendered by QRCodeSVG component in UnifiedActivationStep\n\t\t\t\t\t// No need to generate QR code data URL here - just pass the keyUri\n\t\t\t\t\tconst newState: MFAState = {\n\t\t\t\t\t\t...prev,\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tdeviceStatus: result.status,\n\t\t\t\t\t\t...(registrationResult.deviceActivateUri\n\t\t\t\t\t\t\t? { deviceActivateUri: String(registrationResult.deviceActivateUri) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'TOTP'\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\ttotpSecret: String(registrationResult.secret || ''),\n\t\t\t\t\t\t\t\t\tkeyUri: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tqrCodeUrl: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tshowQr: !!(registrationResult.secret || registrationResult.keyUri),\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'FIDO2' &&\n\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tpublicKeyCredentialCreationOptions:\n\t\t\t\t\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions,\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'MOBILE' && registrationResult.pairingKey\n\t\t\t\t\t\t\t? { pairingKey: String(registrationResult.pairingKey) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t};\n\n\t\t\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\t\t\tfullState: newState,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t// ================================================\n\n\t\t\t\t\treturn newState;\n\t\t\t\t});\n\n\t\t\t\t// FIDO2: Check if we already have credential data (from WebAuthn modal)\n\t\t\t\t// If credentialId and publicKey are present, registration is complete\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tif (fields.credentialId && fields.publicKey) {\n\t\t\t\t\t\t// WebAuthn already completed via modal - device fully registered\n\n\t\t\t\t\t\t// Admin Flow: Show QR but skip OTP validation - device ready immediately\n\t\t\t\t\t\t// Admin ACTIVATION_REQUIRED & User Flow: Show QR and require OTP validation\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tflowType === 'admin-active' ||\n\t\t\t\t\t\t\tflowType === 'admin-activation' ||\n\t\t\t\t\t\t\tresult.status === 'ACTIVE'\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t'[UNIFIED-FLOW] Admin flow or ACTIVE status - proceeding to show QR without OTP requirement'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered successfully!${flowType === 'admin-active' || flowType === 'admin-activation' ? ' Device is ready to use.' : ''}`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t// For Admin Flow, go to API docs page instead of OTP page\n\t\t\t\t\t\t\t// For User Flow, go to User Login step (Step 1)\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (result.status === 'ACTIVATION_REQUIRED') {\n\t\t\t\t\t\t\t// Device requires activation - PingOne automatically sends OTP\n\t\t\t\t\t\t\t// This applies to both admin_activation_required and user flow\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered! OTP has been sent automatically.`\n\t\t\t\t\t\t\t);\n  // DO NOT auto-advance for OTP-required devices\n\t\t\t\t\t\t\t// User should manually click Next after receiving OTP\n\t\t\t\t\t\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation - waiting for user to proceed manually`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Unknown status, proceed with flow-specific navigation\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} // End of FIDO2 section\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Registration failed:', error);\n\t\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Device registration failed';\n\n\t\t\t\t// Check if error is due to too many devices\n\t\t\t\tif (errorMessage.includes('Too many devices')) {\n\t\t\t\t\ttoastV8.error(\n\t\t\t\t\t\t`${errorMessage}\\n\\n‚ÑπÔ∏è You can manage your devices at:\\nhttps://localhost:3000/v8/delete-all-devices`,\n\t\t\t\t\t\t{ duration: 8000 }\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\ttoastV8.error(errorMessage);\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tprops.setIsLoading(false);\n\t\t\t}\n\t\t},\n\t\t[config.displayName, toastV8]\n\t);\n\n\t/**\n\t * Handle user token received from OAuth flow\n\t */\n\tconst handleUserTokenReceived = useCallback(\n\t\t(token: string) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== USER TOKEN RECEIVED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Token length:', token.length);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current pending registration:', pendingRegistrationRef.current);\n\n\t\t\tsetUserToken(token);\n\t\t\tsetUserTokenForDisplay(token);\n\n\t\t\t// Decode JWT to extract username\n\t\t\ttry {\n\t\t\t\tconst base64Url = token.split('.')[1];\n\t\t\t\tconst base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n\t\t\t\tconst jsonPayload = decodeURIComponent(\n\t\t\t\t\tatob(base64)\n\t\t\t\t\t\t.split('')\n\t\t\t\t\t\t.map((c) => `%${`00${c.charCodeAt(0).toString(16)}`.slice(-2)}`)\n\t\t\t\t\t\t.join('')\n\t\t\t\t);\n\t\t\t\tconst payload = JSON.parse(jsonPayload);\n\t\t\t\tconst username =\n\t\t\t\t\tpayload.username || payload.preferred_username || payload.sub || 'Unknown User';\n\t\t\t\tsetUsernameFromToken(username);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Extracted username:', username);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Failed to decode JWT:', error);\n\t\t\t\tsetUsernameFromToken('Unknown User');\n\t\t\t}\n\n\t\t\t// If we have pending registration, show success page first\n\t\t\tconst pending = pendingRegistrationRef.current;\n\t\t\tif (pending) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Found pending registration, showing success page first...');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending data:', {\n\t\t\t\t\tdeviceType: pending.deviceType,\n\t\t\t\t\tflowType: pending.flowType,\n\t\t\t\t\thasProps: !!pending.props,\n\t\t\t\t\thasFields: !!pending.fields,\n\t\t\t\t});\n\n\t\t\t\ttoastV8.success('‚úÖ Authentication successful! Your user token is ready.', {\n\t\t\t\t\tduration: 4000,\n\t\t\t\t});\n\n\t\t\t\t// Close login modal and show success page\n\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\tsetShowUserTokenSuccess(true);\n\t\t\t} else {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] WARNING: No pending registration found after OAuth!');\n\t\t\t}\n\t\t},\n\t\t[setUserToken]\n\t);\n\n\t/**\n\t * Handle continue from user token success page\n\t */\n\tconst handleContinueAfterUserLogin = useCallback(() => {\n\t\tconsole.log(\n\t\t\t'[UNIFIED-FLOW] User clicked continue after login, proceeding with registration...'\n\t\t);\n\n\t\tconst pending = pendingRegistrationRef.current;\n\t\tif (pending && userToken) {\n\t\t\tconst { deviceType: pendingDeviceType, fields, flowType, props } = pending;\n\t\t\tpendingRegistrationRef.current = null;\n\n\t\t\t// Hide success page\n\t\t\tsetShowUserTokenSuccess(false);\n\n\t\t\t// Continue with registration\n\t\t\tsetTimeout(() => {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Now executing performRegistrationWithToken...');\n\t\t\t\tperformRegistrationWithToken(props, pendingDeviceType, fields, flowType, userToken);\n\t\t\t}, 100);\n\t\t}\n\t}, [userToken, performRegistrationWithToken]);\n\n\t/**\n\t * Perform device registration API call\n\t * Checks if User Flow needs OAuth first, otherwise proceeds with registration\n\t */\n\tconst performRegistration = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== DEVICE REGISTRATION SUBMITTED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current userToken:', userToken ? 'Present' : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\n\t\t\t// CRITICAL: Validate worker token before allowing any registration\n\t\t\tif (!workerToken.tokenStatus.isValid) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Cannot proceed - no valid worker token');\n\t\t\t\ttoastV8.error(\n\t\t\t\t\t'‚ùå Worker token required for device registration. Please configure worker token credentials first.',\n\t\t\t\t\t{\n\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// For User Flow, check if we need OAuth authentication first\n\t\t\tif (flowType === 'user' && !userToken) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] User flow selected but no token - showing OAuth modal');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Storing pending registration...');\n\n\t\t\t\t// Store pending registration data\n\t\t\t\tpendingRegistrationRef.current = {\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tfields,\n\t\t\t\t\tflowType,\n\t\t\t\t\tprops,\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending registration stored:', pendingRegistrationRef.current);\n\n\t\t\t\t// Set return target for device registration flow\n\t\t\t\tReturnTargetServiceV8U.setReturnTarget(\n\t\t\t\t\t'mfa_device_registration',\n\t\t\t\t\t'/v8/unified-mfa',  // Return to unified MFA flow\n\t\t\t\t\t2  // Step 2: Device Selection\n\t\t\t\t);\n\n\t\t\t\t// Show the user login modal\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'üîê User Flow requires PingOne authentication. Please complete the login to continue with device registration.',\n\t\t\t\t\t{ duration: 6000 }\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t'[UNIFIED-FLOW] Proceeding directly with registration (token exists or admin flow)'\n\t\t\t);\n\t\t\t// Proceed with registration (using existing token for user flow)\n\t\t\tawait performRegistrationWithToken(\n\t\t\t\tprops,\n\t\t\t\tselectedDeviceType,\n\t\t\t\tfields,\n\t\t\t\tflowType,\n\t\t\t\tuserToken || undefined\n\t\t\t);\n\t\t},\n\t\t[workerToken.tokenStatus.isValid, userToken]\n\t);\n\n\t/**\n\t * Render Step 0: Configuration (environment, user, policy)\n\t */\n\tconst renderStep0 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn (\n\t\t\t\t<UnifiedDeviceRegistrationForm\n\t\t\t\t\tinitialDeviceType={deviceType}\n\t\t\t\t\tonSubmit={async (selectedDeviceType, fields, flowType) => {\n\t\t\t\t\t\tawait performRegistration(props, selectedDeviceType, fields, flowType);\n\t\t\t\t\t}}\n\t\t\t\t\tonCancel={() => {\n\t\t\t\t\t\tif (onCancel) onCancel();\n\t\t\t\t\t}}\n\t\t\t\t\ttokenStatus={props.tokenStatus}\n\t\t\t\t\tusername={props.credentials.username}\n\t\t\t\t/>\n\t\t\t);\n\t\t},\n\t\t[deviceType, onCancel, performRegistration]\n\t);\n\n\t/**\n\t * Render Step 1: User Login using Authorization Code Flow with PKCE\n\t */\n\tconst renderStep1 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <UserLoginStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 2: Device Selection (option to call registration if want new device, or have no devices)\n\t */\n\tconst renderStep2 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 3: Device-Specific Actions (OTP/QR Generation, FIDO, Mobile Push)\n\t */\n\tconst renderStep3 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific based on the device type\n\t\t\t// For now, return the activation step which handles device-specific logic\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 4: OTP Validation / Confirmation\n\t */\n\tconst renderStep4 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific validation\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 5: API Documentation\n\t */\n\tconst renderStep5 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <APIDocsStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 6: Success screen with all user data and other valuable options\n\t */\n\tconst renderStep6 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <SuccessStepV8 renderProps={props} />;\n\t}, []);\n\n\t// Step labels for device authentication flow\n\tconst stepLabels = useMemo(() => {\n\t\tif (deviceType === 'FIDO2') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Start FIDO in Browser',\n\t\t\t\t'Passkey confirmation',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else if (deviceType === 'MOBILE') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Push to Mobile App',\n\t\t\t\t'User Confirms on Mobile',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else {\n\t\t\t// SMS, Email, TOTP, WhatsApp\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Generate OTP/QR',\n\t\t\t\t'Validate OTP',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t}\n\t}, [deviceType]);\n\n\tconst shouldHideNextButton = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\tif (props.nav.currentStep === 0) {\n\t\t\treturn true; // Hide Next button on configuration step, use form submit\n\t\t}\n\t\tif (props.nav.currentStep === 1) {\n\t\t\treturn true; // Hide Next button on user login step, use authentication button\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\treturn (\n\t\t<>\n\t\t\t<MFAFlowBaseV8\n\t\t\t\tdeviceType={deviceType}\n\t\t\t\trenderStep0={renderStep0}\n\t\t\t\trenderStep1={renderStep1}\n\t\t\t\trenderStep2={renderStep2}\n\t\t\t\trenderStep3={renderStep3}\n\t\t\t\trenderStep4={renderStep4}\n\t\t\t\trenderStep5={renderStep5}\n\t\t\t\trenderStep6={renderStep6}\n\t\t\t\tvalidateStep0={validateStep0}\n\t\t\t\tstepLabels={stepLabels}\n\t\t\t\tshouldHideNextButton={shouldHideNextButton}\n\t\t\t\tflowType=\"device-auth\"\n\t\t\t/>\n\t\t\t<div style={{ height: '300px' }} />\n\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\n\t\t\t{/* User Login Modal for User Flow OAuth */}\n\t\t\t<UserLoginModalV8\n\t\t\t\tisOpen={showUserLoginModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\t\tpendingRegistrationRef.current = null;\n\t\t\t\t}}\n\t\t\t\tonTokenReceived={handleUserTokenReceived}\n\t\t\t\tenvironmentId={envIdForModal}\n\t\t\t/>\n\n\t\t\t{/* User Token Success Page - Show token after OAuth login */}\n\t\t\t{showUserTokenSuccess && userTokenForDisplay && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 10000,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\t\t\tboxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Success Header */}\n\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\twidth: '64px',\n\t\t\t\t\t\t\t\t\theight: '64px',\n\t\t\t\t\t\t\t\t\tborderRadius: '50%',\n\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>‚úÖ</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<h2 style={{ margin: '0 0 8px 0', fontSize: '24px', color: '#1f2937' }}>\n\t\t\t\t\t\t\t\tAuthentication Successful!\n\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\tYour user token has been obtained and is ready to use.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Username Dropdown */}\n\t\t\t\t\t\t{usernameFromToken && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUsernameDropdown(!showUsernameDropdown)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tpadding: 0,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: showUsernameDropdown ? '12px' : 0,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '16px', color: '#374151' }}>Username</h3>\n\t\t\t\t\t\t\t\t\t{showUsernameDropdown ? (\n\t\t\t\t\t\t\t\t\t\t<FiChevronUp size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t<FiChevronDown size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{showUsernameDropdown && (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{usernameFromToken}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(usernameFromToken);\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('Username copied to clipboard!');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüìã Copy Username\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Token Display */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<h3 style={{ margin: '0 0 12px 0', fontSize: '16px', color: '#374151' }}>\n\t\t\t\t\t\t\t\tUser Access Token\n\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{userTokenForDisplay}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(userTokenForDisplay);\n\t\t\t\t\t\t\t\t\ttoastV8.success('Token copied to clipboard!');\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüìã Copy Token\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Next Steps Info */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#eff6ff',\n\t\t\t\t\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#1e40af', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t<strong>Next:</strong> Click \"Continue with Registration\" to proceed with your{' '}\n\t\t\t\t\t\t\t\t{config.displayName} device registration using this user token.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Continue Button */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleContinueAfterUserLogin}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\tbackground: '#10b981',\n\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tboxShadow: '0 2px 8px rgba(16, 185, 129, 0.3)',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tContinue with Registration ‚Üí\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</>\n\t);\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default UnifiedMFARegistrationFlowV8;\n"},"tags":["fixable"],"source":null},{"category":"lint/correctness/noUnusedVariables","severity":"warning","description":"This variable navigate is unused.","message":[{"elements":[],"content":"This variable "},{"elements":["Emphasis"],"content":"navigate"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused variables are often the result of typos, incomplete refactors, or other sources of bugs."}]]},{"log":["info",[{"elements":[],"content":"Unsafe fix: If this is intentional, prepend "},{"elements":["Emphasis"],"content":"navigate"},{"elements":[],"content":" with an underscore."}]]},{"diff":{"dictionary":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\n\t// React Router navigation\n\tconst navigate_navigate = useNavigate();\n\n\t// Load device-specific configuration\nexport default UnifiedMFARegistrationFlowV8;\n","ops":[{"diffOp":{"equal":{"range":[0,73]}}},{"equalLines":{"line_count":1967}},{"diffOp":{"equal":{"range":[73,109]}}},{"diffOp":{"delete":{"range":[109,117]}}},{"diffOp":{"insert":{"range":[117,126]}}},{"diffOp":{"equal":{"range":[126,127]}}},{"diffOp":{"equal":{"range":[127,183]}}},{"equalLines":{"line_count":889}},{"diffOp":{"equal":{"range":[183,229]}}}]}}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/UnifiedMFARegistrationFlowV8_Legacy.tsx"},"span":[61123,61131],"sourceCode":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\n * @description Unified MFA Registration Flow - Single component for all 6 device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Replace 6 device-specific flow components (SMS, Email, Mobile, WhatsApp, TOTP, FIDO2)\n * with a single configurable component using deviceFlowConfigs for device-specific behavior.\n *\n * Architecture:\n * - Configuration-driven using deviceFlowConfigs.ts\n * - Dynamic form rendering for simple devices (SMS, Email, WhatsApp)\n * - Custom components for complex devices (TOTP, FIDO2, Mobile)\n * - Integrates with MFACredentialContext and useWorkerToken hook\n * - Uses existing MFAFlowBaseV8 for 5-step framework\n *\n * @example\n * <UnifiedMFARegistrationFlowV8\n *   deviceType=\"SMS\"\n *   onSuccess={(result) => console.log('Device registered:', result.deviceId)}\n * />\n */\n\nimport * as React from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { FiChevronDown, FiChevronUp } from 'react-icons/fi';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { MFAHeaderV8 } from '@/v8/components/MFAHeaderV8';\nimport type { SearchableDropdownOption } from '@/v8/components/SearchableDropdownV8';\nimport { SearchableDropdownV8 } from '@/v8/components/SearchableDropdownV8';\nimport { SQLiteStatsDisplayV8 } from '@/v8/components/SQLiteStatsDisplayV8';\nimport { SuperSimpleApiDisplayV8 } from '@/v8/components/SuperSimpleApiDisplayV8';\nimport { UserLoginModalV8 } from '@/v8/components/UserLoginModalV8';\nimport { getDeviceConfig } from '@/v8/config/deviceFlowConfigs';\nimport type { DeviceConfigKey, DeviceRegistrationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport { PING_IDENTITY_COLORS } from '@/v8/constants/pingIdentityColors';\nimport { GlobalMFAProvider } from '@/v8/contexts/GlobalMFAContext';\nimport { MFACredentialProvider } from '@/v8/contexts/MFACredentialContext';\nimport { APIDocsStepV8 } from '@/v8/flows/shared/APIDocsStepV8';\nimport { SuccessStepV8 } from '@/v8/flows/shared/SuccessStepV8';\nimport { UserLoginStepV8 } from '@/v8/flows/shared/UserLoginStepV8';\nimport { useMFAPolicies } from '@/v8/hooks/useMFAPolicies';\nimport { useStepNavigationV8 } from '@/v8/hooks/useStepNavigationV8';\nimport { useUserSearch } from '@/v8/hooks/useUserSearch';\nimport { useWorkerToken } from '@/v8/hooks/useWorkerToken';\nimport { CredentialsServiceV8 } from '@/v8/services/credentialsServiceV8';\nimport { globalEnvironmentService } from '@/v8/services/globalEnvironmentService';\nimport { MfaAuthenticationServiceV8 } from '@/v8/services/mfaAuthenticationServiceV8';\nimport { type MFAFeatureFlag, MFAFeatureFlagsV8 } from '@/v8/services/mfaFeatureFlagsV8';\nimport MFAServiceV8_Legacy, { type RegisterDeviceParams } from '@/v8/services/mfaServiceV8_Legacy';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport type { TokenStatusInfo } from '@/v8/services/workerTokenStatusServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { ReturnTargetServiceV8U } from '@/v8u/services/returnTargetServiceV8U';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type MFAFlowBaseRenderProps, MFAFlowBaseV8 } from '../shared/MFAFlowBaseV8';\nimport type { DeviceAuthenticationPolicy, MFACredentials, MFAState } from '../shared/MFATypes';\nimport { UnifiedActivationStep } from './components/UnifiedActivationStep';\nimport { UnifiedDeviceRegistrationForm } from './components/UnifiedDeviceRegistrationForm';\nimport { UnifiedDeviceSelectionModal } from './components/UnifiedDeviceSelectionModal';\nimport { UnifiedSuccessStep } from './components/UnifiedSuccessStep';\nimport './UnifiedMFAFlow.css';\n\nconst MODULE_TAG = '[üîÑ UNIFIED-MFA-FLOW-V8]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedMFARegistrationFlowV8Props {\n\t/** Device type to render (optional - can be provided via navigation state) */\n\tdeviceType?: DeviceConfigKey;\n\n\t/** Optional initial credentials (for pre-filled forms) */\n\tinitialCredentials?: Partial<MFACredentials>;\n\n\t/** Optional callback when registration succeeds */\n\tonSuccess?: (result: DeviceRegistrationResult) => void;\n\n\t/** Optional callback when user cancels flow */\n\tonCancel?: () => void;\n\n\t/** Optional initial step (defaults to 0) */\n\tinitialStep?: number;\n\n\t/** Optional: Skip configuration step if already configured */\n\tskipConfiguration?: boolean;\n\n\t/** Optional: Force specific registration flow type */\n\tregistrationFlowType?: 'admin-active' | 'admin-activation' | 'user';\n}\n\n// ============================================================================\n// MFA FLOW SELECTION SCREEN\n// ============================================================================\n\ntype FlowMode = 'registration' | 'authentication';\n\n/** Map device types to their feature flags */\nconst DEVICE_FLAG_MAP: Record<DeviceConfigKey, MFAFeatureFlag> = {\n\tSMS: 'mfa_unified_sms',\n\tEMAIL: 'mfa_unified_email',\n\tMOBILE: 'mfa_unified_mobile',\n\tWHATSAPP: 'mfa_unified_whatsapp',\n\tTOTP: 'mfa_unified_totp',\n\tFIDO2: 'mfa_unified_fido2',\n};\n\nconst DEVICE_TYPES: { key: DeviceConfigKey; icon: string; name: string; description: string }[] = [\n\t{ key: 'SMS', icon: 'üì±', name: 'SMS', description: 'Receive OTP codes via text message' },\n\t{ key: 'EMAIL', icon: '‚úâÔ∏è', name: 'Email', description: 'Receive OTP codes via email' },\n\t{\n\t\tkey: 'TOTP',\n\t\ticon: 'üîê',\n\t\tname: 'Authenticator App (TOTP)',\n\t\tdescription: 'Use Google Authenticator, Authy, or similar',\n\t},\n\t{\n\t\tkey: 'MOBILE',\n\t\ticon: 'üì≤',\n\t\tname: 'Mobile Push',\n\t\tdescription: 'Receive push notifications on your phone',\n\t},\n\t{ key: 'WHATSAPP', icon: 'üí¨', name: 'WhatsApp', description: 'Receive OTP codes via WhatsApp' },\n\t{\n\t\tkey: 'FIDO2',\n\t\ticon: 'üîë',\n\t\tname: 'Security Key (FIDO2)',\n\t\tdescription: 'Use a hardware security key or passkey',\n\t},\n];\n\n/** Check if a device type is enabled via feature flags */\nconst isDeviceEnabled = (deviceKey: DeviceConfigKey): boolean => {\n\tconst flag = DEVICE_FLAG_MAP[deviceKey];\n\treturn MFAFeatureFlagsV8.isEnabled(flag);\n};\n\ninterface DeviceTypeSelectionScreenProps {\n\tonSelectDeviceType: (deviceType: DeviceConfigKey) => void;\n\tuserToken?: string | null;\n\tsetUserToken: (token: string | null) => void;\n}\n\nconst DeviceTypeSelectionScreen: React.FC<DeviceTypeSelectionScreenProps> = ({\n\tonSelectDeviceType,\n\tuserToken,\n\tsetUserToken,\n}) => {\n\tconst [flowMode, setFlowMode] = useState<FlowMode | null>(null);\n\tconst [environmentId, setEnvironmentId] = useState('');\n\tconst [username, setUsername] = useState('');\n\tconst [showDeviceSelectionModal, setShowDeviceSelectionModal] = useState(false);\n\tconst [showOTPModal, setShowOTPModal] = useState(false);\n\tconst [otpCode, setOtpCode] = useState('');\n\tconst [authenticationId, setAuthenticationId] = useState<string | null>(null);\n\tconst [selectedAuthDevice, setSelectedAuthDevice] = useState<{\n\t\tid: string;\n\t\ttype: string;\n\t\tnickname?: string;\n\t} | null>(null);\n\tconst [customLogoUrl, setCustomLogoUrl] = useState<string>('');\n\tconst [showAuthLoginModal, setShowAuthLoginModal] = useState(false);\n\tconst authEnvIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Load uploaded logo from localStorage on mount\n\tuseEffect(() => {\n\t\ttry {\n\t\t\tconst savedUpload = localStorage.getItem('custom-logo-upload');\n\t\t\tif (savedUpload) {\n\t\t\t\tconst uploadData = JSON.parse(savedUpload);\n\t\t\t\t// Handle both old format (objectUrl) and new format (base64Url)\n\t\t\t\tif (uploadData.base64Url) {\n\t\t\t\t\tsetCustomLogoUrl(uploadData.base64Url);\n\t\t\t\t} else if (uploadData.objectUrl) {\n\t\t\t\t\t// Old format - try to convert if possible, otherwise clear it\n\t\t\t\t\tconsole.warn('Old logo format detected - please re-upload your logo');\n\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load uploaded logo from localStorage:', error);\n\t\t\t// Clear corrupted data\n\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t}\n\t}, []);\n\n\t// Use worker token hook for token management\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Extract environment ID from worker token when available\n\tuseEffect(() => {\n\t\tconst extractEnvironmentId = async () => {\n\t\t\ttry {\n\t\t\t\tconst token = await workerTokenServiceV8.getToken();\n\t\t\t\tif (token && !environmentId) {\n\t\t\t\t\tconst parts = token.split('.');\n\t\t\t\t\tif (parts.length === 3) {\n\t\t\t\t\t\tconst payload = JSON.parse(atob(parts[1]));\n\t\t\t\t\t\tif (payload.environmentId) {\n\t\t\t\t\t\t\tsetEnvironmentId(payload.environmentId);\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`${MODULE_TAG} Environment ID extracted from worker token:`,\n\t\t\t\t\t\t\t\tpayload.environmentId\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Failed to extract environment ID from worker token:`, error);\n\t\t\t}\n\t\t};\n\n\t\textractEnvironmentId();\n\t}, [environmentId]);\n\n\tconst hasWorkerToken = workerToken.tokenStatus.isValid;\n\n\t// Use user search hook for user fetching and search\n\tconst {\n\t\tusers,\n\t\tisLoading: isLoadingUsers,\n\t\tsetSearchQuery,\n\t} = useUserSearch({\n\t\tenvironmentId,\n\t\ttokenValid: workerToken.tokenStatus.isValid,\n\t\tmaxPages: 100,\n\t\tuseCache: true,\n\t});\n\tconst tokenStatus = workerToken.tokenStatus;\n\n\t// Debug: Log users type to understand the issue\n\tuseEffect(() => {\n\t\tconsole.log(`${MODULE_TAG} users type check:`, {\n\t\t\tusers,\n\t\t\tisArray: Array.isArray(users),\n\t\t\ttype: typeof users,\n\t\t\tconstructor: users?.constructor?.name,\n\t\t});\n\t}, [users]);\n\n\t// Load Environment ID and username from global services on mount\n\tuseEffect(() => {\n\t\t// Initialize the service first to load from localStorage\n\t\tglobalEnvironmentService.initialize();\n\t\tconst savedEnvId = globalEnvironmentService.getEnvironmentId();\n\t\tif (savedEnvId) {\n\t\t\tsetEnvironmentId(savedEnvId);\n\t\t}\n\n\t\t// Load username from localStorage\n\t\tconst savedUsername = localStorage.getItem('mfa_unified_username');\n\t\tif (savedUsername) {\n\t\t\tsetUsername(savedUsername);\n\t\t}\n\t}, []);\n\n\t// Use MFA policies hook\n\tconst {\n\t\tpolicies,\n\t\tselectedPolicy,\n\t\tisLoading: isPoliciesLoading,\n\t\terror: policiesError,\n\t\tselectPolicy,\n\t\tdefaultPolicy,\n\t} = useMFAPolicies({\n\t\tenvironmentId,\n\t\ttokenIsValid: tokenStatus.isValid,\n\t\tautoLoad: true,\n\t\tautoSelectSingle: true,\n\t});\n\n\tconst selectedPolicyRef = useRef<DeviceAuthenticationPolicy | null>(null);\n\tuseEffect(() => {\n\t\tselectedPolicyRef.current = selectedPolicy ?? null;\n\t}, [selectedPolicy]);\n\n\tconst isPolicyDeviceEnabled = useCallback(\n\t\t(policy: DeviceAuthenticationPolicy | null, key: string) => {\n\t\t\tconst deviceConfig = policy?.[key] as { enabled?: boolean } | undefined;\n\t\t\treturn !!deviceConfig?.enabled;\n\t\t},\n\t\t[]\n\t);\n\n\tconst policyOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tpolicies.map((policy) => ({\n\t\t\t\tvalue: policy.id,\n\t\t\t\tlabel: policy.name,\n\t\t\t\t...(policy.default ? { secondaryLabel: '(Default)' } : {}),\n\t\t\t})),\n\t\t[policies]\n\t);\n\n\tconst userOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tArray.from(\n\t\t\t\tnew Map(\n\t\t\t\t\t(Array.isArray(users) ? users : []).map((user) => [\n\t\t\t\t\t\tuser.username,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvalue: user.username,\n\t\t\t\t\t\t\tlabel: user.username,\n\t\t\t\t\t\t\t...(user.email ? { secondaryLabel: user.email } : {}),\n\t\t\t\t\t\t} as SearchableDropdownOption,\n\t\t\t\t\t])\n\t\t\t\t).values()\n\t\t\t),\n\t\t[users]\n\t);\n\n\t// Auto-select default policy when policies load\n\tuseEffect(() => {\n\t\tif (defaultPolicy && !selectedPolicy) {\n\t\t\tselectPolicy(defaultPolicy.id);\n\t\t}\n\t}, [defaultPolicy, selectedPolicy, selectPolicy]);\n\n\t// Sync environment ID to global service and CredentialsServiceV8 when it changes\n\tuseEffect(() => {\n\t\tif (environmentId) {\n\t\t\tglobalEnvironmentService.setEnvironmentId(environmentId);\n\t\t\tlocalStorage.setItem('mfa_environmentId', environmentId);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tenvironmentId,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId, username: currentCreds.username }\n\t\t\t}));\n\t\t}\n\t}, [environmentId]);\n\n\t// Save username to localStorage and CredentialsServiceV8 when it changes\n\t// This ensures MFAFlowBase can read the username from its expected storage location\n\tuseEffect(() => {\n\t\tif (username) {\n\t\t\tlocalStorage.setItem('mfa_unified_username', username);\n\t\t\tlocalStorage.setItem('mfa_username', username);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tusername,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId: currentCreds.environmentId, username }\n\t\t\t}));\n\t\t}\n\t}, [username]);\n\n\t// Handle device selection for authentication\n\tconst handleDeviceSelectForAuthentication = async (device: {\n\t\tid: string;\n\t\ttype: string;\n\t\tdeviceName?: string;\n\t\tnickname?: string;\n\t}) => {\n\t\tconsole.log(`${MODULE_TAG} Selected device for authentication:`, device);\n\t\tsetShowDeviceSelectionModal(false);\n\t\tsetSelectedAuthDevice(device);\n\n\t\tconst policyId = selectedPolicy?.id;\n\t\tif (!policyId) {\n\t\t\ttoastV8.error('Please select an MFA Policy first');\n\t\t\treturn;\n\t\t}\n\n\t\t// Determine flow type and token\n\t\t// Admin flows should use worker tokens, not require user tokens\n\t\tconst flowType = userToken ? 'user' : 'admin';\n\t\tconst effectiveUserToken = flowType === 'user' ? userToken : undefined;\n\n\t\t// For admin flow, check if we have a valid worker token before proceeding\n\t\tif (flowType === 'admin' && !hasWorkerToken) {\n\t\t\ttoastV8.error('Admin flow requires a valid worker token. Please generate a worker token first.');\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\t// Initialize authentication with appropriate token\n\t\t\tconst response = await MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\tenvironmentId,\n\t\t\t\tusername: username.trim(),\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t\tdeviceId: device.id,\n\t\t\t\tregion: 'na',\n\t\t\t\ttokenType: flowType,\n\t\t\t\t...(effectiveUserToken && { userToken: effectiveUserToken }),\n\t\t\t});\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth initialized - full response:`, response);\n\t\t\tsetAuthenticationId(response.id);\n\n\t\t\tconst status = (response.status || '').toUpperCase();\n\t\t\tconst nextStep = (response.nextStep || '').toUpperCase();\n\t\t\tconst links = response._links as Record<string, { href?: string }> | undefined;\n\t\t\tconst hasOtpLink = !!(\n\t\t\t\tlinks &&\n\t\t\t\t(links.otp || links['otp.check'] || (links as Record<string, unknown>)['checkOtp'])\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth status:`, {\n\t\t\t\tstatus,\n\t\t\t\tnextStep,\n\t\t\t\thasOtpLink,\n\t\t\t\tdeviceType: device.type,\n\t\t\t});\n\n\t\t\t// Show appropriate UI based on response (normalize status/nextStep for PingOne variants)\n\t\t\tif (status === 'OTP_REQUIRED' || nextStep === 'OTP_REQUIRED' || hasOtpLink) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Opening OTP modal for device:`, device.type);\n\t\t\t\tsetShowOTPModal(true);\n\t\t\t\ttoastV8.success(`Verification code sent to your ${device.type} device`);\n\t\t\t} else if (status === 'ASSERTION_REQUIRED' || nextStep === 'ASSERTION_REQUIRED') {\n\t\t\t\tconsole.log(`${MODULE_TAG} FIDO2 assertion required`);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'FIDO2 authentication required. Please use /v8/mfa-config for FIDO2 authentication.'\n\t\t\t\t);\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'PUSH_CONFIRMATION_REQUIRED' ||\n\t\t\t\tnextStep === 'PUSH_CONFIRMATION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Push confirmation required`);\n\t\t\t\ttoastV8.success('Push notification sent! Please approve on your mobile device.');\n\t\t\t\ttoastV8.info('Complete authentication at /v8/mfa-config for push polling.');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (status === 'COMPLETED') {\n\t\t\t\ttoastV8.success('Authentication completed successfully!');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'DEVICE_SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'DEVICE_SELECTION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Device selection required - showing modal again`);\n\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t} else {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Unexpected authentication status:`, {\n\t\t\t\t\tstatus,\n\t\t\t\t\tnextStep,\n\t\t\t\t\tresponse,\n\t\t\t\t});\n\t\t\t\ttoastV8.info(`Authentication status: ${status || nextStep || 'UNKNOWN'}`);\n\t\t\t\t// Stay in authentication flow so user can try another device\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to initialize authentication:`, error);\n\n\t\t\t// Enhanced error handling for NO_USABLE_DEVICES\n\t\t\tlet errorMessage = 'Authentication failed: ';\n\t\t\tif (error instanceof Error) {\n\t\t\t\tconst errorStr = error.message.toLowerCase();\n\n\t\t\t\t// Check for NO_USABLE_DEVICES or device availability errors\n\t\t\t\tif (\n\t\t\t\t\terrorStr.includes('no usable devices') ||\n\t\t\t\t\terrorStr.includes('too many') ||\n\t\t\t\t\terrorStr.includes('cooldown') ||\n\t\t\t\t\terrorStr.includes('blocked')\n\t\t\t\t) {\n\t\t\t\t\terrorMessage = '‚ö†Ô∏è Device Temporarily Unavailable\\n\\n';\n\n\t\t\t\t\tif (errorStr.includes('cooldown') || errorStr.includes('too many')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Too many notifications have been sent to this device. It is temporarily in cooldown. ';\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Please wait a few minutes and try again, or select a different device.';\n\t\t\t\t\t} else if (errorStr.includes('blocked')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'This device has been blocked. Please contact your administrator or use a different device.';\n\t\t\t\t\t} else {\n\t\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terrorMessage += 'Unknown error';\n\t\t\t}\n\n\t\t\ttoastV8.error(errorMessage, { duration: 8000 });\n\t\t\t// Do NOT set flowMode(null) - keep user in authentication flow so they can retry or select another device\n\t\t}\n\t};\n\n\t// Handle OTP verification\n\tconst handleVerifyOTP = async () => {\n\t\tif (!authenticationId || !selectedAuthDevice) {\n\t\t\ttoastV8.error('Authentication session not found');\n\t\t\treturn;\n\t\t}\n\n\t\tif (otpCode.length !== 6) {\n\t\t\ttoastV8.error('Please enter a 6-digit code');\n\t\t\treturn;\n\t\t}\n\n\t\t// Get worker token for API call\n\t\tconst workerTokenForOTP = await workerTokenServiceV8.getToken();\n\n\t\tconsole.log(`${MODULE_TAG} OTP verification debug:`, {\n\t\t\tenvironmentId,\n\t\t\tusername: username.trim(),\n\t\t\tauthenticationId,\n\t\t\totpCode,\n\t\t\thasEnvironmentId: !!environmentId,\n\t\t\tenvIdLength: environmentId?.length,\n\t\t\thasWorkerToken: !!workerTokenForOTP,\n\t\t\tworkerTokenLength: workerTokenForOTP?.length,\n\t\t});\n\n\t\ttry {\n\t\t\t// Use backend proxy to avoid CORS issues\n\t\t\tconst response = await fetch('/api/pingone/mfa/validate-otp-for-device', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tenvironmentId,\n\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\tdeviceAuthId: authenticationId,\n\t\t\t\t\totp: otpCode,\n\t\t\t\t\tregion: 'na',\n\t\t\t\t\tworkerToken: workerTokenForOTP,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\n\t\t\t\tthrow new Error(errorData.error || errorData.message || `HTTP ${response.status}`);\n\t\t\t}\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.status === 'COMPLETED' || result.status === 'completed') {\n\t\t\t\ttoastV8.success('‚úÖ Authentication completed successfully!');\n\t\t\t\tsetShowOTPModal(false);\n\t\t\t\tsetFlowMode(null);\n\t\t\t\tsetOtpCode('');\n\t\t\t} else {\n\t\t\t\ttoastV8.error('Invalid code. Please try again.');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} OTP verification failed:`, error);\n\t\t\ttoastV8.error(\n\t\t\t\t`Verification failed: ${error instanceof Error ? error.message : 'Unknown error'}`\n\t\t\t);\n\t\t}\n\t};\n\n\t// Step 1: Choose Registration or Authentication\n\tif (!flowMode) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '12px' }}>\n\t\t\t\t\t{/* Header */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tboxShadow: '0 4px 12px rgba(239, 68, 68, 0.2)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h1\n\t\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîê MFA Unified Flow\n\t\t\t\t\t\t</h1>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tChoose what you want to do with MFA devices.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Configuration Section */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 12px 0',\n\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfiguration\n\t\t\t\t\t\t</h2>\n\n\t\t\t\t\t\t{/* Custom Logo URL */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-url\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[800],\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüé® Custom Logo URL (Optional)\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tDisplay a custom logo in the OTP verification modal\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t{/* URL Input */}\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tid=\"custom-logo-url\"\n\t\t\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\t\t\tvalue={customLogoUrl}\n\t\t\t\t\t\t\t\tonChange={(e) => setCustomLogoUrl(e.target.value)}\n\t\t\t\t\t\t\t\tplaceholder=\"https://example.com/logo.png\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\tpadding: '10px 14px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[900],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = `0 0 0 3px ${PING_IDENTITY_COLORS.primary[200]}`;\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.neutral[300];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* File Upload Section */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '13px', color: PING_IDENTITY_COLORS.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\tOR\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"file\"\n\t\t\t\t\t\t\t\t\tid=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\taccept=\"image/*\"\n\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\tconst file = e.target.files?.[0];\n\t\t\t\t\t\t\t\t\t\tif (!file) return;\n\n\t\t\t\t\t\t\t\t\t\t// Validate file type (images only)\n\t\t\t\t\t\t\t\t\t\tif (!file.type.startsWith('image/')) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Please select a logo file (JPG, PNG, etc.)');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Validate file size (max 5MB)\n\t\t\t\t\t\t\t\t\t\tif (file.size > 5 * 1024 * 1024) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('File size must be less than 5MB');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Convert file to base64 for persistence\n\t\t\t\t\t\t\t\t\t\tconst reader = new FileReader();\n\t\t\t\t\t\t\t\t\t\treader.onload = (event) => {\n\t\t\t\t\t\t\t\t\t\t\tconst base64Url = event.target?.result as string;\n\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl(base64Url);\n\n\t\t\t\t\t\t\t\t\t\t\t// Store base64 data for persistence\n\t\t\t\t\t\t\t\t\t\t\tconst uploadData = {\n\t\t\t\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\t\t\t\tbase64Url: base64Url,\n\t\t\t\t\t\t\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\t\t\t// Save to localStorage for persistence\n\t\t\t\t\t\t\t\t\t\t\tlocalStorage.setItem('custom-logo-upload', JSON.stringify(uploadData));\n\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.success(`Logo uploaded: ${file.name}`);\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.onerror = () => {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to read uploaded file');\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.readAsDataURL(file);\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'none' }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.primary[500],\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.primary[600]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '500',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[700];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìÅ Upload Logo File\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[500],\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tJPG, PNG, GIF (max 5MB)\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{customLogoUrl && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.neutral[50],\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tLogo Preview:\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\talt=\"Custom logo\"\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonError={() => {\n\t\t\t\t\t\t\t\t\t\t\t// Handle broken image URLs\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Failed to load custom logo URL');\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl('');\n\t\t\t\t\t\t\t\t\t\t\t\t// Clear uploaded file from localStorage\n\t\t\t\t\t\t\t\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.accent.pingRed[500],\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.accent.pingRed[600]}`,\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[600];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[500];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRemove Logo\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Environment ID - Hide when worker token is available */}\n\t\t\t\t\t\t{!hasWorkerToken && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"env-id\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tEnvironment ID\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"env-id\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setEnvironmentId(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* SQLite Database Stats */}\n\t\t\t\t\t\t{environmentId && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<SQLiteStatsDisplayV8\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tcompact={false}\n\t\t\t\t\t\t\t\t\trefreshInterval={30}\n\t\t\t\t\t\t\t\t\tshowRefreshButton={true}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Username */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUsername\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{environmentId && tokenStatus.isValid ? (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\toptions={userOptions}\n\t\t\t\t\t\t\t\t\tonChange={setUsername}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Type to search across 16,000+ users...\"\n\t\t\t\t\t\t\t\t\tisLoading={isLoadingUsers}\n\t\t\t\t\t\t\t\t\tonSearchChange={setSearchQuery}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setUsername(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* MFA Policy Dropdown */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"mfa-policy\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tMFA Policy\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{isPoliciesLoading ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tLoading policies...\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policiesError ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#ef4444', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tError loading policies: {policiesError}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policies.length === 0 ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tNo MFA policies found. Please check your environment ID and worker token.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"mfa-policy\"\n\t\t\t\t\t\t\t\t\tvalue={selectedPolicy?.id || ''}\n\t\t\t\t\t\t\t\t\toptions={policyOptions}\n\t\t\t\t\t\t\t\t\tonChange={selectPolicy}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Select an MFA policy...\"\n\t\t\t\t\t\t\t\t\tisLoading={isPoliciesLoading}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tSelect the MFA policy to use for device registration\n\t\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t\t{/* Policy Summary - Collapsible */}\n\t\t\t\t\t\t\t{selectedPolicy && (\n\t\t\t\t\t\t\t\t<details\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<summary\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\tuserSelect: 'none',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüìã Policy Details\n\t\t\t\t\t\t\t\t\t</summary>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '12px', fontSize: '13px', color: '#4b5563' }}>\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Policy Name:</strong> {String(selectedPolicy.name)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedPolicy.default && (\n\t\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px', color: '#059669' }}>\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>‚úì Default Policy</strong>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Enabled Devices:</strong>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '6px' }}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'sms') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì± SMS\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'email') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t‚úâÔ∏è Email\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'totp') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîê TOTP\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'fido2') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîë FIDO2\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'mobile') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì≤ Mobile\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'voice') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüìû Voice\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</details>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Worker Token Status */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t\tpaddingRight: '16px',\n\t\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={setEnvironmentId}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* User Token Status */}\n\t\t\t\t\t\t\t{userToken && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\t'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05))',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #10b981',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '20px' }}>üë§</span>\n\t\t\t\t\t\t\t\t\t\t<strong style={{ color: '#047857', fontSize: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t\tUser Token Active\n\t\t\t\t\t\t\t\t\t\t</strong>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: '14px', color: '#059669', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t\t‚úì User authentication token available\n\t\t\t\t\t\t\t\t\t\t<br />‚úì Ready for User Flow device registration\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Flow Mode Selection */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',\n\t\t\t\t\t\t\tgap: '16px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Registration Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => setFlowMode('registration')}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>‚ûï</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#047857',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Registration\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tRegister a new MFA device for a user. Create SMS, Email, TOTP, Mobile Push,\n\t\t\t\t\t\t\t\t\t\tWhatsApp, or FIDO2 devices.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t{/* Authentication Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tif (!userToken) {\n\t\t\t\t\t\t\t\t\tsetShowAuthLoginModal(true);\n\t\t\t\t\t\t\t\t\ttoastV8.info('üîê Please complete user login before device authentication.', {\n\t\t\t\t\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-4px)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 8px 24px rgba(59, 130, 246, 0.2)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>üîì</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#1d4ed8',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Authentication\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tAuthenticate using an existing MFA device. Verify user identity with OTP, push\n\t\t\t\t\t\t\t\t\t\tnotification, or security key.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{showAuthLoginModal && (\n\t\t\t\t\t<UserLoginModalV8\n\t\t\t\t\t\tisOpen={showAuthLoginModal}\n\t\t\t\t\t\tonClose={() => setShowAuthLoginModal(false)}\n\t\t\t\t\t\tonTokenReceived={(token) => {\n\t\t\t\t\t\t\tsetUserToken(token);\n\t\t\t\t\t\t\tsetShowAuthLoginModal(false);\n\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tenvironmentId={authEnvIdForModal}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</>\n\t\t);\n\t}\n\n\t// Authentication flow - dedicated view (device selection + OTP modals only; no registration grid)\n\tif (flowMode === 'authentication') {\n\t\treturn (\n\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\tsetSelectedAuthDevice(null);\n\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t‚Üê Back\n\t\t\t\t\t</button>\n\t\t\t\t\t<h1\n\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t>\n\t\t\t\t\t\tüîì Device Authentication\n\t\t\t\t\t</h1>\n\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\t{selectedAuthDevice && !showOTPModal\n\t\t\t\t\t\t\t? `Authenticating with ${selectedAuthDevice.type} ‚Äî enter the code when prompted.`\n\t\t\t\t\t\t\t: `Select an MFA device to authenticate for ${username || 'the user'}`}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t\t{!showDeviceSelectionModal && !showOTPModal && (\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowDeviceSelectionModal(true)}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tSelect MFA device\n\t\t\t\t\t</button>\n\t\t\t\t)}\n\t\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\t\tonClose={() => {\n\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t// Keep flowMode so user stays in auth flow; only clear if they click Back\n\t\t\t\t\t}}\n\t\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\t\tusername={username}\n\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t/>\n\t\t\t\t{showOTPModal && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.6)',\n\t\t\t\t\t\t\tbackdropFilter: 'blur(4px)',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t\t\tanimation: 'fadeIn 0.2s ease-out',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t{`\n\t\t\t\t\t\t\t@keyframes fadeIn {\n\t\t\t\t\t\t\t\tfrom { opacity: 0; }\n\t\t\t\t\t\t\t\tto { opacity: 1; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes slideUp {\n\t\t\t\t\t\t\t\tfrom { \n\t\t\t\t\t\t\t\t\topacity: 0;\n\t\t\t\t\t\t\t\t\ttransform: translateY(20px); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tto { \n\t\t\t\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t\t\t\t\ttransform: translateY(0); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes pulse {\n\t\t\t\t\t\t\t\t0%, 100% { opacity: 1; }\n\t\t\t\t\t\t\t\t50% { opacity: 0.5; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`}\n\t\t\t\t\t\t</style>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\tborderRadius: '24px',\n\t\t\t\t\t\t\t\tpadding: '48px 40px',\n\t\t\t\t\t\t\t\tmaxWidth: '480px',\n\t\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\t\tboxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',\n\t\t\t\t\t\t\t\tanimation: 'slideUp 0.3s ease-out',\n\t\t\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Logo Area */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '32px' }}>\n\t\t\t\t\t\t\t\t{customLogoUrl ? (\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\t\talt=\"Organization logo\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '120px',\n\t\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonError={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\t// Fallback to default icon if image fails to load\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.display = 'none';\n\t\t\t\t\t\t\t\t\t\t\t\tconst fallback = document.createElement('div');\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.style.cssText = `\n\t\t\t\t\t\t\t\t\t\t\t\twidth: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\theight: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: 0 auto 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: center;\n\t\t\t\t\t\t\t\t\t\t\t\tjustifyContent: center;\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: 36px;\n\t\t\t\t\t\t\t\t\t\t\t\tboxShadow: 0 10px 25px rgba(102, 126, 234, 0.3);\n\t\t\t\t\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.textContent = 'üîê';\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.parentElement!.appendChild(fallback);\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\theight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto 20px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '20px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '36px',\n\t\t\t\t\t\t\t\t\t\t\tboxShadow: '0 10px 25px rgba(102, 126, 234, 0.3)',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüîê\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tVerification Code\n\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\tEnter the 6-digit code sent to your <strong>{selectedAuthDevice?.type}</strong>{' '}\n\t\t\t\t\t\t\t\t\tdevice\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* OTP Input */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\t\t\tplaceholder=\"‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢\"\n\t\t\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tletterSpacing: '12px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow: otpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{otpCode.length > 0 && otpCode.length < 6 && (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\t\tanimation: 'pulse 2s ease-in-out infinite',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{6 - otpCode.length} more digit{6 - otpCode.length !== 1 ? 's' : ''} needed\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Resend Code Button */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={async () => {\n\t\t\t\t\t\t\t\t\t\tif (!selectedAuthDevice || !authenticationId) return;\n\t\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.info('Resending verification code...');\n\t\t\t\t\t\t\t\t\t\t\t// Re-initialize authentication to resend code\n\t\t\t\t\t\t\t\t\t\t\tconst response =\n\t\t\t\t\t\t\t\t\t\t\t\tawait MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\t\t\t\t\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\t\t\t\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicy?.id || '',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceId: selectedAuthDevice.id,\n\t\t\t\t\t\t\t\t\t\t\t\t\tregion: 'na',\n\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tif (response.status?.toUpperCase() === 'OTP_REQUIRED') {\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('New code sent to your device!');\n\t\t\t\t\t\t\t\t\t\t\t\tsetAuthenticationId(response.id);\n\t\t\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to resend code');\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Resend error:', error);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tcolor: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'transparent';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚Üª Resend Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Action Buttons */}\n\t\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#d1d5db';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f9fafb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'white';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6\n\t\t\t\t\t\t\t\t\t\t\t\t? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '#d1d5db',\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (otpCode.length === 6) {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚úì Verify Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Help Text */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<strong style={{ color: '#111827' }}>Didn't receive the code?</strong>\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\tCheck your spam folder or click \"Resend Code\" above\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t);\n\t}\n\n\t// Registration flow - show device type selection cards\n\treturn (\n\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t{/* Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #10b981 0%, #047857 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => setFlowMode(null)}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t‚Üê Back\n\t\t\t\t</button>\n\t\t\t\t<h1 style={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}>\n\t\t\t\t\t‚ûï Register MFA Device\n\t\t\t\t</h1>\n\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\tSelect a device type to register for {username || 'the user'}\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Device Type Cards */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',\n\t\t\t\t\tgap: '16px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t{DEVICE_TYPES.map((device) => {\n\t\t\t\t\tconst enabled = isDeviceEnabled(device.key);\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tkey={device.key}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => enabled && onSelectDeviceType(device.key)}\n\t\t\t\t\t\t\tdisabled={!enabled}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tbackground: enabled ? '#ffffff' : '#f9fafb',\n\t\t\t\t\t\t\t\tborder: `2px solid ${enabled ? '#e5e7eb' : '#f3f4f6'}`,\n\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\tcursor: enabled ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\topacity: enabled ? 1 : 0.5,\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#10b981';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ecfdf5';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>{device.icon}</span>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{device.name}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280' }}>{device.description}</p>\n\t\t\t\t\t\t\t{!enabled && (\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '12px', color: '#9ca3af' }}>\n\t\t\t\t\t\t\t\t\t(Not enabled)\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</div>\n\n\t\t\t{/* Device Selection Modal for Authentication */}\n\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t}}\n\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\tusername={username}\n\t\t\t\tenvironmentId={environmentId}\n\t\t\t/>\n\n\t\t\t{/* OTP Modal for Authentication */}\n\t\t\t{showOTPModal && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '400px',\n\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\tboxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '600' }}>\n\t\t\t\t\t\t\tEnter Verification Code\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '0 0 20px 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tCheck your {selectedAuthDevice?.type} device for the code\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\tplaceholder=\"000000\"\n\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 16px',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\tletterSpacing: '8px',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tmarginBottom: '20px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: otpCode.length === 6 ? '#3b82f6' : '#9ca3af',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tVerify\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Wrapper Component\n *\n * Wraps the content with MFACredentialProvider to provide global credential state\n */\nexport const UnifiedMFARegistrationFlowV8: React.FC<UnifiedMFARegistrationFlowV8Props> = (\n\tprops\n) => {\n\tconst location = useLocation();\n\n\t// Get device type from props or location state (can be undefined)\n\tconst initialDeviceType =\n\t\tprops.deviceType || (location.state as { deviceType?: DeviceConfigKey })?.deviceType;\n\n\t// State for selected device type (allows user to select if not provided)\n\tconst [selectedDeviceType, setSelectedDeviceType] = useState<DeviceConfigKey | undefined>(\n\t\tinitialDeviceType\n\t);\n\n\t// User token state for OAuth authentication (User Flow)\n\tconst [userToken, setUserToken] = useState<string | null>(() => {\n\t\t// Check if we already have a user token from previous OAuth flow\n\t\tconst savedCreds = CredentialsServiceV8.loadCredentials('user-login-v8', {\n\t\t\tflowKey: 'user-login-v8',\n\t\t\tflowType: 'oauth',\n\t\t\tincludeClientSecret: false,\n\t\t\tincludeRedirectUri: false,\n\t\t\tincludeLogoutUri: false,\n\t\t\tincludeScopes: false,\n\t\t});\n\t\treturn savedCreds?.accessToken || null;\n\t});\n\n\t// If no device type selected, show device type selection screen\n\tif (!selectedDeviceType) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<MFAHeaderV8\n\t\t\t\t\ttitle=\"MFA Unified Flow\"\n\t\t\t\t\tdescription=\"Register or authenticate MFA devices\"\n\t\t\t\t\tversionTag=\"V8\"\n\t\t\t\t\tcurrentPage=\"registration\"\n\t\t\t\t\tshowBackToMain={true}\n\t\t\t\t\theaderColor=\"pingRed\"\n\t\t\t\t/>\n\t\t\t\t<GlobalMFAProvider>\n\t\t\t\t\t<MFACredentialProvider>\n\t\t\t\t\t\t<DeviceTypeSelectionScreen\n\t\t\t\t\t\t\tonSelectDeviceType={setSelectedDeviceType}\n\t\t\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</MFACredentialProvider>\n\t\t\t\t</GlobalMFAProvider>\n\t\t\t\t{/* API display (bottom of page) */}\n\t\t\t\t<div style={{ marginTop: '24px' }}>\n\t\t\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\t\t\t\t</div>\n\t\t\t</>\n\t\t);\n\t}\n\n\treturn (\n\t\t<GlobalMFAProvider>\n\t\t\t<MFACredentialProvider>\n\t\t\t\t<UnifiedMFARegistrationFlowContent\n\t\t\t\t\t{...props}\n\t\t\t\t\tdeviceType={selectedDeviceType}\n\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t/>\n\t\t\t</MFACredentialProvider>\n\t\t</GlobalMFAProvider>\n\t);\n};\n\n// ============================================================================\n// CONTENT COMPONENT (MAIN LOGIC)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Content Component\n *\n * Contains the actual flow logic and integrates with:\n * - MFACredentialContext (global credential state)\n * - useWorkerToken hook (token status and auto-refresh)\n * - deviceFlowConfigs (device-specific configuration)\n * - MFAFlowBaseV8 (5-step framework)\n */\nconst UnifiedMFARegistrationFlowContent: React.FC<\n\tRequired<Pick<UnifiedMFARegistrationFlowV8Props, 'deviceType'>> &\n\t\tOmit<UnifiedMFARegistrationFlowV8Props, 'deviceType'> & {\n\t\t\tuserToken: string | null;\n\t\t\tsetUserToken: (token: string | null) => void;\n\t\t}\n> = ({ deviceType, onCancel, userToken, setUserToken }) => {\n\t// ========================================================================\n\t// CONFIGURATION\n\t// ========================================================================\n\n\t// React Router navigation\n\tconst navigate = useNavigate();\n\n\t// Load device-specific configuration\n\tconst config = useMemo(() => {\n\t\treturn getDeviceConfig(deviceType);\n\t}, [deviceType]);\n\n\t// ========================================================================\n\t// USER FLOW OAUTH STATE\n\t// ========================================================================\n\n\t// State for User Login Modal (OAuth authentication for User Flow)\n\tconst [showUserLoginModal, setShowUserLoginModal] = useState(false);\n\tconst [showUserTokenSuccess, setShowUserTokenSuccess] = useState(false);\n\tconst [userTokenForDisplay, setUserTokenForDisplay] = useState<string>('');\n\tconst [usernameFromToken, setUsernameFromToken] = useState<string>('');\n\tconst [showUsernameDropdown, setShowUsernameDropdown] = useState(false);\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\tconst envIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Pending registration data while waiting for OAuth (use ref to avoid stale closure)\n\tconst pendingRegistrationRef = useRef<{\n\t\tdeviceType: DeviceConfigKey;\n\t\tfields: Record<string, string>;\n\t\tflowType: string;\n\t\tprops: MFAFlowBaseRenderProps;\n\t} | null>(null);\n\n\t// Worker token state for validation in registration flow\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Detect OAuth callback and re-open modal if needed\n\tuseEffect(() => {\n\t\tconst urlParams = new URLSearchParams(window.location.search);\n\t\tconst code = urlParams.get('code');\n\t\tconst hasStoredState = sessionStorage.getItem('user_login_state_v8');\n\n\t\t// If we have OAuth callback params and stored state, re-open the modal to process callback\n\t\t// But only if we don't already have a user token (to prevent reopening after silent auth)\n\t\tif (code && hasStoredState && !showUserLoginModal && !userToken) {\n\t\t\tconsole.log('[UNIFIED-FLOW] OAuth callback detected - re-opening modal to process');\n\t\t\tsetShowUserLoginModal(true);\n\t\t}\n\t}, [showUserLoginModal, userToken]);\n\n\t// ========================================================================\n\t// STEP VALIDATION\n\t// ========================================================================\n\n\t/**\n\t * Validate Step 0 (Configuration)\n\t */\n\tconst validateStep0 = useCallback(\n\t\t(\n\t\t\tcredentials: MFACredentials,\n\t\t\ttoken: TokenStatusInfo,\n\t\t\tnavigation: ReturnType<typeof useStepNavigationV8>\n\t\t) => {\n\t\t\t// Always check for valid worker token (required for MFA device operations)\n\t\t\tif (!token.isValid) {\n\t\t\t\tnavigation.setValidationErrors(['Invalid or expired worker token']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Check required configuration\n\t\t\tif (!credentials.environmentId || !credentials.username) {\n\t\t\t\tnavigation.setValidationErrors(['Environment ID and Username are required']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\t\t[]\n\t);\n\n\t// ========================================================================\n\t// STEP RENDERERS\n\t// ========================================================================\n\n\t/**\n\t * Perform device registration API call (with token already available)\n\t */\n\tconst performRegistrationWithToken = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string,\n\t\t\ttoken?: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== PERFORM REGISTRATION WITH TOKEN =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Token:', token ? `Present (${token.length} chars)` : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setIsLoading available:', typeof props.setIsLoading);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setCredentials available:', typeof props.setCredentials);\n\n\t\t\ttry {\n\t\t\t\tprops.setIsLoading(true);\n\n\t\t\t\t// Update credentials with device fields and user token if provided\n\t\t\t\tprops.setCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tflowType, // Store flowType so activation step knows if OTP is required\n\t\t\t\t\t...fields,\n\t\t\t\t\t...(flowType === 'user' && token\n\t\t\t\t\t\t? { userToken: token, tokenType: 'user' }\n\t\t\t\t\t\t: flowType !== 'user'\n\t\t\t\t\t\t\t? { tokenType: 'worker' }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t}));\n\n\t\t\t\t// Register the device using proper API call\n\t\t\t\t// CRITICAL: Flow-specific device status\n\t\t\t\t// - Admin flow: ACTIVE (no OTP sent, device ready immediately)\n\t\t\t\t// - Admin ACTIVATION_REQUIRED: ACTIVATION_REQUIRED (sends OTP for admin to activate)\n\t\t\t\t// - User flow: ACTIVATION_REQUIRED (sends OTP for user to activate)\n\t\t\t\t// - FIDO2: ACTIVE (WebAuthn verification happens during registration)\n\t\t\t\tlet deviceStatus: 'ACTIVE' | 'ACTIVATION_REQUIRED' | undefined;\n\n\t\t\t\t// Determine device status based on flow type (applies to all device types including FIDO2)\n\t\t\t\tif (flowType === 'admin-active') {\n\t\t\t\t\tdeviceStatus = 'ACTIVE';\n\t\t\t\t} else if (flowType === 'admin-activation') {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED';\n\t\t\t\t} else {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED'; // user flow\n\t\t\t\t}\n\n\t\t\t\t// Special note for FIDO2: WebAuthn verification proves device works,\n\t\t\t\t// but we still respect the flow type for status determination\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t'[UNIFIED-FLOW] FIDO2 device - status determined by flow type:',\n\t\t\t\t\t\tdeviceStatus\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device status determined:', {\n\t\t\t\t\tflowType,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tdeviceStatus,\n\t\t\t\t\totpWillBeSent: deviceStatus === 'ACTIVATION_REQUIRED',\n\t\t\t\t\treason:\n\t\t\t\t\t\tselectedDeviceType === 'FIDO2'\n\t\t\t\t\t\t\t? 'FIDO2 - ACTIVE after WebAuthn verification'\n\t\t\t\t\t\t\t: 'User flow - OTP required for activation',\n\t\t\t\t});\n\n\t\t\t\t// Use same parameter construction as working MFA flows\n\t\t\t\ttype RegisterDeviceParamsWithToken = RegisterDeviceParams & {\n\t\t\t\t\ttokenType?: 'worker' | 'user';\n\t\t\t\t\tuserToken?: string | undefined;\n\t\t\t\t};\n\t\t\t\tlet baseParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\tenvironmentId: props.credentials.environmentId,\n\t\t\t\t\tusername: props.credentials.username,\n\t\t\t\t\ttype: selectedDeviceType,\n\t\t\t\t};\n\t\t\t\t// Per rightTOTP.md: Pass token type and user token if available\n\t\t\t\tif (flowType === 'user' && token) {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'user',\n\t\t\t\t\t\tuserToken: token,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'worker',\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Always include status for all device types\n\t\t\t\t// FIDO2: Set to ACTIVE since WebAuthn verification proves device works\n\t\t\t\t// Other devices: Set based on flow type (admin-active = ACTIVE, others = ACTIVATION_REQUIRED)\n\t\t\t\tif (deviceStatus !== undefined) {\n\t\t\t\t\tbaseParams.status = deviceStatus;\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registration base params:', {\n\t\t\t\t\tenvironmentId: baseParams.environmentId,\n\t\t\t\t\tusername: baseParams.username,\n\t\t\t\t\ttype: baseParams.type,\n\t\t\t\t\ttokenType: baseParams.tokenType,\n\t\t\t\t\tstatus: baseParams.status,\n\t\t\t\t\tflowType,\n\t\t\t\t});\n\n\t\t\t\t// Map form field names to API field names\n\t\t\t\t// Form uses 'deviceName' but API expects 'nickname' or 'name'\n\t\t\t\tconst mappedFields: Record<string, string> = { ...fields };\n\t\t\t\tif (mappedFields.deviceName) {\n\t\t\t\t\tmappedFields.nickname = mappedFields.deviceName;\n\t\t\t\t\tmappedFields.name = mappedFields.deviceName;\n\t\t\t\t\tdelete mappedFields.deviceName;\n\t\t\t\t}\n\n\t\t\t\t// Format phone number for SMS/WhatsApp devices\n\t\t\t\t// Form sends: { phoneNumber: '9725231586', countryCode: '+1' }\n\t\t\t\t// API expects: { phone: '+1.9725231586' }\n\t\t\t\tif (mappedFields.phoneNumber && mappedFields.countryCode) {\n\t\t\t\t\tconst countryCode = mappedFields.countryCode.replace('+', ''); // Remove + for formatting\n\t\t\t\t\tconst phoneNumber = mappedFields.phoneNumber.replace(/\\D/g, ''); // Remove non-digits\n\t\t\t\t\tmappedFields.phone = `+${countryCode}.${phoneNumber}`;\n\t\t\t\t\tconsole.log('[UNIFIED-FLOW] Formatted phone:', mappedFields.phone);\n\t\t\t\t\tdelete mappedFields.phoneNumber;\n\t\t\t\t\tdelete mappedFields.countryCode;\n\t\t\t\t}\n\n\t\t\t\t// Include device-specific fields (phone, email, etc.)\n\t\t\t\tconst deviceParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\t...baseParams,\n\t\t\t\t\t...mappedFields,\n\t\t\t\t\t// Include policy for TOTP devices (required for secret and keyUri to be returned)\n\t\t\t\t\t...(selectedDeviceType === 'TOTP' && selectedPolicyRef.current\n\t\t\t\t\t\t? { policy: selectedPolicyRef.current.id }\n\t\t\t\t\t\t: {}),\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registering device with params:', deviceParams);\n\n\t\t\t\tconst result = await MFAServiceV8_Legacy.registerDevice(deviceParams);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device registered:', result);\n\n\t\t\t\t// Update MFA state with device info\n\t\t\t\tconst registrationResult = result as unknown as Record<string, unknown>;\n\n\t\t\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result for TOTP:', {\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\tqrCode: registrationResult.qrCode,\n\t\t\t\t\t\tqrCodeUrl: registrationResult.qrCodeUrl,\n\t\t\t\t\t\tsecret: registrationResult.secret,\n\t\t\t\t\t\ttotpSecret: registrationResult.totpSecret,\n\t\t\t\t\t\tfullResult: result,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// ===============================================\n\n\t\t\t\t// Clear stored registration data after successful use\n\t\t\t\tlocalStorage.removeItem('mfa_registration_flow_type');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_fields');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_device_type');\n\n\t\t\t\tprops.setMfaState((prev) => {\n\t\t\t\t\t// TOTP: QR code will be rendered by QRCodeSVG component in UnifiedActivationStep\n\t\t\t\t\t// No need to generate QR code data URL here - just pass the keyUri\n\t\t\t\t\tconst newState: MFAState = {\n\t\t\t\t\t\t...prev,\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tdeviceStatus: result.status,\n\t\t\t\t\t\t...(registrationResult.deviceActivateUri\n\t\t\t\t\t\t\t? { deviceActivateUri: String(registrationResult.deviceActivateUri) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'TOTP'\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\ttotpSecret: String(registrationResult.secret || ''),\n\t\t\t\t\t\t\t\t\tkeyUri: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tqrCodeUrl: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tshowQr: !!(registrationResult.secret || registrationResult.keyUri),\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'FIDO2' &&\n\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tpublicKeyCredentialCreationOptions:\n\t\t\t\t\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions,\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'MOBILE' && registrationResult.pairingKey\n\t\t\t\t\t\t\t? { pairingKey: String(registrationResult.pairingKey) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t};\n\n\t\t\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\t\t\tfullState: newState,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t// ================================================\n\n\t\t\t\t\treturn newState;\n\t\t\t\t});\n\n\t\t\t\t// FIDO2: Check if we already have credential data (from WebAuthn modal)\n\t\t\t\t// If credentialId and publicKey are present, registration is complete\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tif (fields.credentialId && fields.publicKey) {\n\t\t\t\t\t\t// WebAuthn already completed via modal - device fully registered\n\n\t\t\t\t\t\t// Admin Flow: Show QR but skip OTP validation - device ready immediately\n\t\t\t\t\t\t// Admin ACTIVATION_REQUIRED & User Flow: Show QR and require OTP validation\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tflowType === 'admin-active' ||\n\t\t\t\t\t\t\tflowType === 'admin-activation' ||\n\t\t\t\t\t\t\tresult.status === 'ACTIVE'\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t'[UNIFIED-FLOW] Admin flow or ACTIVE status - proceeding to show QR without OTP requirement'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered successfully!${flowType === 'admin-active' || flowType === 'admin-activation' ? ' Device is ready to use.' : ''}`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t// For Admin Flow, go to API docs page instead of OTP page\n\t\t\t\t\t\t\t// For User Flow, go to User Login step (Step 1)\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (result.status === 'ACTIVATION_REQUIRED') {\n\t\t\t\t\t\t\t// Device requires activation - PingOne automatically sends OTP\n\t\t\t\t\t\t\t// This applies to both admin_activation_required and user flow\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered! OTP has been sent automatically.`\n\t\t\t\t\t\t\t);\n  // DO NOT auto-advance for OTP-required devices\n\t\t\t\t\t\t\t// User should manually click Next after receiving OTP\n\t\t\t\t\t\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation - waiting for user to proceed manually`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Unknown status, proceed with flow-specific navigation\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} // End of FIDO2 section\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Registration failed:', error);\n\t\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Device registration failed';\n\n\t\t\t\t// Check if error is due to too many devices\n\t\t\t\tif (errorMessage.includes('Too many devices')) {\n\t\t\t\t\ttoastV8.error(\n\t\t\t\t\t\t`${errorMessage}\\n\\n‚ÑπÔ∏è You can manage your devices at:\\nhttps://localhost:3000/v8/delete-all-devices`,\n\t\t\t\t\t\t{ duration: 8000 }\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\ttoastV8.error(errorMessage);\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tprops.setIsLoading(false);\n\t\t\t}\n\t\t},\n\t\t[config.displayName, toastV8]\n\t);\n\n\t/**\n\t * Handle user token received from OAuth flow\n\t */\n\tconst handleUserTokenReceived = useCallback(\n\t\t(token: string) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== USER TOKEN RECEIVED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Token length:', token.length);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current pending registration:', pendingRegistrationRef.current);\n\n\t\t\tsetUserToken(token);\n\t\t\tsetUserTokenForDisplay(token);\n\n\t\t\t// Decode JWT to extract username\n\t\t\ttry {\n\t\t\t\tconst base64Url = token.split('.')[1];\n\t\t\t\tconst base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n\t\t\t\tconst jsonPayload = decodeURIComponent(\n\t\t\t\t\tatob(base64)\n\t\t\t\t\t\t.split('')\n\t\t\t\t\t\t.map((c) => `%${`00${c.charCodeAt(0).toString(16)}`.slice(-2)}`)\n\t\t\t\t\t\t.join('')\n\t\t\t\t);\n\t\t\t\tconst payload = JSON.parse(jsonPayload);\n\t\t\t\tconst username =\n\t\t\t\t\tpayload.username || payload.preferred_username || payload.sub || 'Unknown User';\n\t\t\t\tsetUsernameFromToken(username);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Extracted username:', username);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Failed to decode JWT:', error);\n\t\t\t\tsetUsernameFromToken('Unknown User');\n\t\t\t}\n\n\t\t\t// If we have pending registration, show success page first\n\t\t\tconst pending = pendingRegistrationRef.current;\n\t\t\tif (pending) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Found pending registration, showing success page first...');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending data:', {\n\t\t\t\t\tdeviceType: pending.deviceType,\n\t\t\t\t\tflowType: pending.flowType,\n\t\t\t\t\thasProps: !!pending.props,\n\t\t\t\t\thasFields: !!pending.fields,\n\t\t\t\t});\n\n\t\t\t\ttoastV8.success('‚úÖ Authentication successful! Your user token is ready.', {\n\t\t\t\t\tduration: 4000,\n\t\t\t\t});\n\n\t\t\t\t// Close login modal and show success page\n\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\tsetShowUserTokenSuccess(true);\n\t\t\t} else {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] WARNING: No pending registration found after OAuth!');\n\t\t\t}\n\t\t},\n\t\t[setUserToken]\n\t);\n\n\t/**\n\t * Handle continue from user token success page\n\t */\n\tconst handleContinueAfterUserLogin = useCallback(() => {\n\t\tconsole.log(\n\t\t\t'[UNIFIED-FLOW] User clicked continue after login, proceeding with registration...'\n\t\t);\n\n\t\tconst pending = pendingRegistrationRef.current;\n\t\tif (pending && userToken) {\n\t\t\tconst { deviceType: pendingDeviceType, fields, flowType, props } = pending;\n\t\t\tpendingRegistrationRef.current = null;\n\n\t\t\t// Hide success page\n\t\t\tsetShowUserTokenSuccess(false);\n\n\t\t\t// Continue with registration\n\t\t\tsetTimeout(() => {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Now executing performRegistrationWithToken...');\n\t\t\t\tperformRegistrationWithToken(props, pendingDeviceType, fields, flowType, userToken);\n\t\t\t}, 100);\n\t\t}\n\t}, [userToken, performRegistrationWithToken]);\n\n\t/**\n\t * Perform device registration API call\n\t * Checks if User Flow needs OAuth first, otherwise proceeds with registration\n\t */\n\tconst performRegistration = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== DEVICE REGISTRATION SUBMITTED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current userToken:', userToken ? 'Present' : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\n\t\t\t// CRITICAL: Validate worker token before allowing any registration\n\t\t\tif (!workerToken.tokenStatus.isValid) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Cannot proceed - no valid worker token');\n\t\t\t\ttoastV8.error(\n\t\t\t\t\t'‚ùå Worker token required for device registration. Please configure worker token credentials first.',\n\t\t\t\t\t{\n\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// For User Flow, check if we need OAuth authentication first\n\t\t\tif (flowType === 'user' && !userToken) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] User flow selected but no token - showing OAuth modal');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Storing pending registration...');\n\n\t\t\t\t// Store pending registration data\n\t\t\t\tpendingRegistrationRef.current = {\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tfields,\n\t\t\t\t\tflowType,\n\t\t\t\t\tprops,\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending registration stored:', pendingRegistrationRef.current);\n\n\t\t\t\t// Set return target for device registration flow\n\t\t\t\tReturnTargetServiceV8U.setReturnTarget(\n\t\t\t\t\t'mfa_device_registration',\n\t\t\t\t\t'/v8/unified-mfa',  // Return to unified MFA flow\n\t\t\t\t\t2  // Step 2: Device Selection\n\t\t\t\t);\n\n\t\t\t\t// Show the user login modal\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'üîê User Flow requires PingOne authentication. Please complete the login to continue with device registration.',\n\t\t\t\t\t{ duration: 6000 }\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t'[UNIFIED-FLOW] Proceeding directly with registration (token exists or admin flow)'\n\t\t\t);\n\t\t\t// Proceed with registration (using existing token for user flow)\n\t\t\tawait performRegistrationWithToken(\n\t\t\t\tprops,\n\t\t\t\tselectedDeviceType,\n\t\t\t\tfields,\n\t\t\t\tflowType,\n\t\t\t\tuserToken || undefined\n\t\t\t);\n\t\t},\n\t\t[workerToken.tokenStatus.isValid, userToken]\n\t);\n\n\t/**\n\t * Render Step 0: Configuration (environment, user, policy)\n\t */\n\tconst renderStep0 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn (\n\t\t\t\t<UnifiedDeviceRegistrationForm\n\t\t\t\t\tinitialDeviceType={deviceType}\n\t\t\t\t\tonSubmit={async (selectedDeviceType, fields, flowType) => {\n\t\t\t\t\t\tawait performRegistration(props, selectedDeviceType, fields, flowType);\n\t\t\t\t\t}}\n\t\t\t\t\tonCancel={() => {\n\t\t\t\t\t\tif (onCancel) onCancel();\n\t\t\t\t\t}}\n\t\t\t\t\ttokenStatus={props.tokenStatus}\n\t\t\t\t\tusername={props.credentials.username}\n\t\t\t\t/>\n\t\t\t);\n\t\t},\n\t\t[deviceType, onCancel, performRegistration]\n\t);\n\n\t/**\n\t * Render Step 1: User Login using Authorization Code Flow with PKCE\n\t */\n\tconst renderStep1 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <UserLoginStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 2: Device Selection (option to call registration if want new device, or have no devices)\n\t */\n\tconst renderStep2 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 3: Device-Specific Actions (OTP/QR Generation, FIDO, Mobile Push)\n\t */\n\tconst renderStep3 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific based on the device type\n\t\t\t// For now, return the activation step which handles device-specific logic\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 4: OTP Validation / Confirmation\n\t */\n\tconst renderStep4 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific validation\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 5: API Documentation\n\t */\n\tconst renderStep5 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <APIDocsStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 6: Success screen with all user data and other valuable options\n\t */\n\tconst renderStep6 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <SuccessStepV8 renderProps={props} />;\n\t}, []);\n\n\t// Step labels for device authentication flow\n\tconst stepLabels = useMemo(() => {\n\t\tif (deviceType === 'FIDO2') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Start FIDO in Browser',\n\t\t\t\t'Passkey confirmation',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else if (deviceType === 'MOBILE') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Push to Mobile App',\n\t\t\t\t'User Confirms on Mobile',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else {\n\t\t\t// SMS, Email, TOTP, WhatsApp\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Generate OTP/QR',\n\t\t\t\t'Validate OTP',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t}\n\t}, [deviceType]);\n\n\tconst shouldHideNextButton = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\tif (props.nav.currentStep === 0) {\n\t\t\treturn true; // Hide Next button on configuration step, use form submit\n\t\t}\n\t\tif (props.nav.currentStep === 1) {\n\t\t\treturn true; // Hide Next button on user login step, use authentication button\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\treturn (\n\t\t<>\n\t\t\t<MFAFlowBaseV8\n\t\t\t\tdeviceType={deviceType}\n\t\t\t\trenderStep0={renderStep0}\n\t\t\t\trenderStep1={renderStep1}\n\t\t\t\trenderStep2={renderStep2}\n\t\t\t\trenderStep3={renderStep3}\n\t\t\t\trenderStep4={renderStep4}\n\t\t\t\trenderStep5={renderStep5}\n\t\t\t\trenderStep6={renderStep6}\n\t\t\t\tvalidateStep0={validateStep0}\n\t\t\t\tstepLabels={stepLabels}\n\t\t\t\tshouldHideNextButton={shouldHideNextButton}\n\t\t\t\tflowType=\"device-auth\"\n\t\t\t/>\n\t\t\t<div style={{ height: '300px' }} />\n\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\n\t\t\t{/* User Login Modal for User Flow OAuth */}\n\t\t\t<UserLoginModalV8\n\t\t\t\tisOpen={showUserLoginModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\t\tpendingRegistrationRef.current = null;\n\t\t\t\t}}\n\t\t\t\tonTokenReceived={handleUserTokenReceived}\n\t\t\t\tenvironmentId={envIdForModal}\n\t\t\t/>\n\n\t\t\t{/* User Token Success Page - Show token after OAuth login */}\n\t\t\t{showUserTokenSuccess && userTokenForDisplay && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 10000,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\t\t\tboxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Success Header */}\n\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\twidth: '64px',\n\t\t\t\t\t\t\t\t\theight: '64px',\n\t\t\t\t\t\t\t\t\tborderRadius: '50%',\n\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>‚úÖ</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<h2 style={{ margin: '0 0 8px 0', fontSize: '24px', color: '#1f2937' }}>\n\t\t\t\t\t\t\t\tAuthentication Successful!\n\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\tYour user token has been obtained and is ready to use.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Username Dropdown */}\n\t\t\t\t\t\t{usernameFromToken && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUsernameDropdown(!showUsernameDropdown)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tpadding: 0,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: showUsernameDropdown ? '12px' : 0,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '16px', color: '#374151' }}>Username</h3>\n\t\t\t\t\t\t\t\t\t{showUsernameDropdown ? (\n\t\t\t\t\t\t\t\t\t\t<FiChevronUp size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t<FiChevronDown size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{showUsernameDropdown && (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{usernameFromToken}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(usernameFromToken);\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('Username copied to clipboard!');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüìã Copy Username\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Token Display */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<h3 style={{ margin: '0 0 12px 0', fontSize: '16px', color: '#374151' }}>\n\t\t\t\t\t\t\t\tUser Access Token\n\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{userTokenForDisplay}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(userTokenForDisplay);\n\t\t\t\t\t\t\t\t\ttoastV8.success('Token copied to clipboard!');\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüìã Copy Token\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Next Steps Info */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#eff6ff',\n\t\t\t\t\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#1e40af', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t<strong>Next:</strong> Click \"Continue with Registration\" to proceed with your{' '}\n\t\t\t\t\t\t\t\t{config.displayName} device registration using this user token.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Continue Button */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleContinueAfterUserLogin}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\tbackground: '#10b981',\n\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tboxShadow: '0 2px 8px rgba(16, 185, 129, 0.3)',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tContinue with Registration ‚Üí\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</>\n\t);\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default UnifiedMFARegistrationFlowV8;\n"},"tags":["fixable"],"source":null},{"category":"lint/correctness/noUnusedVariables","severity":"warning","description":"This variable registrationError is unused.","message":[{"elements":[],"content":"This variable "},{"elements":["Emphasis"],"content":"registrationError"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused variables are often the result of typos, incomplete refactors, or other sources of bugs."}]]},{"log":["info",[{"elements":[],"content":"Unsafe fix: If this is intentional, prepend "},{"elements":["Emphasis"],"content":"registrationError"},{"elements":[],"content":" with an underscore."}]]},{"diff":{"dictionary":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\tconst [usernameFromToken, setUsernameFromToken] = useState<string>('');\n\tconst [showUsernameDropdown, setShowUsernameDropdown] = useState(false);\n\tconst [registrationError_registrationError, setRegistrationError] = useState<string | null>(null);\n\tconst envIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\nexport default UnifiedMFARegistrationFlowV8;\n","ops":[{"diffOp":{"equal":{"range":[0,73]}}},{"equalLines":{"line_count":1984}},{"diffOp":{"equal":{"range":[73,228]}}},{"diffOp":{"delete":{"range":[228,245]}}},{"diffOp":{"insert":{"range":[245,263]}}},{"diffOp":{"equal":{"range":[263,413]}}},{"equalLines":{"line_count":872}},{"diffOp":{"equal":{"range":[413,459]}}}]}}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/UnifiedMFARegistrationFlowV8_Legacy.tsx"},"span":[61904,61921],"sourceCode":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\n * @description Unified MFA Registration Flow - Single component for all 6 device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Replace 6 device-specific flow components (SMS, Email, Mobile, WhatsApp, TOTP, FIDO2)\n * with a single configurable component using deviceFlowConfigs for device-specific behavior.\n *\n * Architecture:\n * - Configuration-driven using deviceFlowConfigs.ts\n * - Dynamic form rendering for simple devices (SMS, Email, WhatsApp)\n * - Custom components for complex devices (TOTP, FIDO2, Mobile)\n * - Integrates with MFACredentialContext and useWorkerToken hook\n * - Uses existing MFAFlowBaseV8 for 5-step framework\n *\n * @example\n * <UnifiedMFARegistrationFlowV8\n *   deviceType=\"SMS\"\n *   onSuccess={(result) => console.log('Device registered:', result.deviceId)}\n * />\n */\n\nimport * as React from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { FiChevronDown, FiChevronUp } from 'react-icons/fi';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { MFAHeaderV8 } from '@/v8/components/MFAHeaderV8';\nimport type { SearchableDropdownOption } from '@/v8/components/SearchableDropdownV8';\nimport { SearchableDropdownV8 } from '@/v8/components/SearchableDropdownV8';\nimport { SQLiteStatsDisplayV8 } from '@/v8/components/SQLiteStatsDisplayV8';\nimport { SuperSimpleApiDisplayV8 } from '@/v8/components/SuperSimpleApiDisplayV8';\nimport { UserLoginModalV8 } from '@/v8/components/UserLoginModalV8';\nimport { getDeviceConfig } from '@/v8/config/deviceFlowConfigs';\nimport type { DeviceConfigKey, DeviceRegistrationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport { PING_IDENTITY_COLORS } from '@/v8/constants/pingIdentityColors';\nimport { GlobalMFAProvider } from '@/v8/contexts/GlobalMFAContext';\nimport { MFACredentialProvider } from '@/v8/contexts/MFACredentialContext';\nimport { APIDocsStepV8 } from '@/v8/flows/shared/APIDocsStepV8';\nimport { SuccessStepV8 } from '@/v8/flows/shared/SuccessStepV8';\nimport { UserLoginStepV8 } from '@/v8/flows/shared/UserLoginStepV8';\nimport { useMFAPolicies } from '@/v8/hooks/useMFAPolicies';\nimport { useStepNavigationV8 } from '@/v8/hooks/useStepNavigationV8';\nimport { useUserSearch } from '@/v8/hooks/useUserSearch';\nimport { useWorkerToken } from '@/v8/hooks/useWorkerToken';\nimport { CredentialsServiceV8 } from '@/v8/services/credentialsServiceV8';\nimport { globalEnvironmentService } from '@/v8/services/globalEnvironmentService';\nimport { MfaAuthenticationServiceV8 } from '@/v8/services/mfaAuthenticationServiceV8';\nimport { type MFAFeatureFlag, MFAFeatureFlagsV8 } from '@/v8/services/mfaFeatureFlagsV8';\nimport MFAServiceV8_Legacy, { type RegisterDeviceParams } from '@/v8/services/mfaServiceV8_Legacy';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport type { TokenStatusInfo } from '@/v8/services/workerTokenStatusServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { ReturnTargetServiceV8U } from '@/v8u/services/returnTargetServiceV8U';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type MFAFlowBaseRenderProps, MFAFlowBaseV8 } from '../shared/MFAFlowBaseV8';\nimport type { DeviceAuthenticationPolicy, MFACredentials, MFAState } from '../shared/MFATypes';\nimport { UnifiedActivationStep } from './components/UnifiedActivationStep';\nimport { UnifiedDeviceRegistrationForm } from './components/UnifiedDeviceRegistrationForm';\nimport { UnifiedDeviceSelectionModal } from './components/UnifiedDeviceSelectionModal';\nimport { UnifiedSuccessStep } from './components/UnifiedSuccessStep';\nimport './UnifiedMFAFlow.css';\n\nconst MODULE_TAG = '[üîÑ UNIFIED-MFA-FLOW-V8]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedMFARegistrationFlowV8Props {\n\t/** Device type to render (optional - can be provided via navigation state) */\n\tdeviceType?: DeviceConfigKey;\n\n\t/** Optional initial credentials (for pre-filled forms) */\n\tinitialCredentials?: Partial<MFACredentials>;\n\n\t/** Optional callback when registration succeeds */\n\tonSuccess?: (result: DeviceRegistrationResult) => void;\n\n\t/** Optional callback when user cancels flow */\n\tonCancel?: () => void;\n\n\t/** Optional initial step (defaults to 0) */\n\tinitialStep?: number;\n\n\t/** Optional: Skip configuration step if already configured */\n\tskipConfiguration?: boolean;\n\n\t/** Optional: Force specific registration flow type */\n\tregistrationFlowType?: 'admin-active' | 'admin-activation' | 'user';\n}\n\n// ============================================================================\n// MFA FLOW SELECTION SCREEN\n// ============================================================================\n\ntype FlowMode = 'registration' | 'authentication';\n\n/** Map device types to their feature flags */\nconst DEVICE_FLAG_MAP: Record<DeviceConfigKey, MFAFeatureFlag> = {\n\tSMS: 'mfa_unified_sms',\n\tEMAIL: 'mfa_unified_email',\n\tMOBILE: 'mfa_unified_mobile',\n\tWHATSAPP: 'mfa_unified_whatsapp',\n\tTOTP: 'mfa_unified_totp',\n\tFIDO2: 'mfa_unified_fido2',\n};\n\nconst DEVICE_TYPES: { key: DeviceConfigKey; icon: string; name: string; description: string }[] = [\n\t{ key: 'SMS', icon: 'üì±', name: 'SMS', description: 'Receive OTP codes via text message' },\n\t{ key: 'EMAIL', icon: '‚úâÔ∏è', name: 'Email', description: 'Receive OTP codes via email' },\n\t{\n\t\tkey: 'TOTP',\n\t\ticon: 'üîê',\n\t\tname: 'Authenticator App (TOTP)',\n\t\tdescription: 'Use Google Authenticator, Authy, or similar',\n\t},\n\t{\n\t\tkey: 'MOBILE',\n\t\ticon: 'üì≤',\n\t\tname: 'Mobile Push',\n\t\tdescription: 'Receive push notifications on your phone',\n\t},\n\t{ key: 'WHATSAPP', icon: 'üí¨', name: 'WhatsApp', description: 'Receive OTP codes via WhatsApp' },\n\t{\n\t\tkey: 'FIDO2',\n\t\ticon: 'üîë',\n\t\tname: 'Security Key (FIDO2)',\n\t\tdescription: 'Use a hardware security key or passkey',\n\t},\n];\n\n/** Check if a device type is enabled via feature flags */\nconst isDeviceEnabled = (deviceKey: DeviceConfigKey): boolean => {\n\tconst flag = DEVICE_FLAG_MAP[deviceKey];\n\treturn MFAFeatureFlagsV8.isEnabled(flag);\n};\n\ninterface DeviceTypeSelectionScreenProps {\n\tonSelectDeviceType: (deviceType: DeviceConfigKey) => void;\n\tuserToken?: string | null;\n\tsetUserToken: (token: string | null) => void;\n}\n\nconst DeviceTypeSelectionScreen: React.FC<DeviceTypeSelectionScreenProps> = ({\n\tonSelectDeviceType,\n\tuserToken,\n\tsetUserToken,\n}) => {\n\tconst [flowMode, setFlowMode] = useState<FlowMode | null>(null);\n\tconst [environmentId, setEnvironmentId] = useState('');\n\tconst [username, setUsername] = useState('');\n\tconst [showDeviceSelectionModal, setShowDeviceSelectionModal] = useState(false);\n\tconst [showOTPModal, setShowOTPModal] = useState(false);\n\tconst [otpCode, setOtpCode] = useState('');\n\tconst [authenticationId, setAuthenticationId] = useState<string | null>(null);\n\tconst [selectedAuthDevice, setSelectedAuthDevice] = useState<{\n\t\tid: string;\n\t\ttype: string;\n\t\tnickname?: string;\n\t} | null>(null);\n\tconst [customLogoUrl, setCustomLogoUrl] = useState<string>('');\n\tconst [showAuthLoginModal, setShowAuthLoginModal] = useState(false);\n\tconst authEnvIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Load uploaded logo from localStorage on mount\n\tuseEffect(() => {\n\t\ttry {\n\t\t\tconst savedUpload = localStorage.getItem('custom-logo-upload');\n\t\t\tif (savedUpload) {\n\t\t\t\tconst uploadData = JSON.parse(savedUpload);\n\t\t\t\t// Handle both old format (objectUrl) and new format (base64Url)\n\t\t\t\tif (uploadData.base64Url) {\n\t\t\t\t\tsetCustomLogoUrl(uploadData.base64Url);\n\t\t\t\t} else if (uploadData.objectUrl) {\n\t\t\t\t\t// Old format - try to convert if possible, otherwise clear it\n\t\t\t\t\tconsole.warn('Old logo format detected - please re-upload your logo');\n\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load uploaded logo from localStorage:', error);\n\t\t\t// Clear corrupted data\n\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t}\n\t}, []);\n\n\t// Use worker token hook for token management\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Extract environment ID from worker token when available\n\tuseEffect(() => {\n\t\tconst extractEnvironmentId = async () => {\n\t\t\ttry {\n\t\t\t\tconst token = await workerTokenServiceV8.getToken();\n\t\t\t\tif (token && !environmentId) {\n\t\t\t\t\tconst parts = token.split('.');\n\t\t\t\t\tif (parts.length === 3) {\n\t\t\t\t\t\tconst payload = JSON.parse(atob(parts[1]));\n\t\t\t\t\t\tif (payload.environmentId) {\n\t\t\t\t\t\t\tsetEnvironmentId(payload.environmentId);\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`${MODULE_TAG} Environment ID extracted from worker token:`,\n\t\t\t\t\t\t\t\tpayload.environmentId\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Failed to extract environment ID from worker token:`, error);\n\t\t\t}\n\t\t};\n\n\t\textractEnvironmentId();\n\t}, [environmentId]);\n\n\tconst hasWorkerToken = workerToken.tokenStatus.isValid;\n\n\t// Use user search hook for user fetching and search\n\tconst {\n\t\tusers,\n\t\tisLoading: isLoadingUsers,\n\t\tsetSearchQuery,\n\t} = useUserSearch({\n\t\tenvironmentId,\n\t\ttokenValid: workerToken.tokenStatus.isValid,\n\t\tmaxPages: 100,\n\t\tuseCache: true,\n\t});\n\tconst tokenStatus = workerToken.tokenStatus;\n\n\t// Debug: Log users type to understand the issue\n\tuseEffect(() => {\n\t\tconsole.log(`${MODULE_TAG} users type check:`, {\n\t\t\tusers,\n\t\t\tisArray: Array.isArray(users),\n\t\t\ttype: typeof users,\n\t\t\tconstructor: users?.constructor?.name,\n\t\t});\n\t}, [users]);\n\n\t// Load Environment ID and username from global services on mount\n\tuseEffect(() => {\n\t\t// Initialize the service first to load from localStorage\n\t\tglobalEnvironmentService.initialize();\n\t\tconst savedEnvId = globalEnvironmentService.getEnvironmentId();\n\t\tif (savedEnvId) {\n\t\t\tsetEnvironmentId(savedEnvId);\n\t\t}\n\n\t\t// Load username from localStorage\n\t\tconst savedUsername = localStorage.getItem('mfa_unified_username');\n\t\tif (savedUsername) {\n\t\t\tsetUsername(savedUsername);\n\t\t}\n\t}, []);\n\n\t// Use MFA policies hook\n\tconst {\n\t\tpolicies,\n\t\tselectedPolicy,\n\t\tisLoading: isPoliciesLoading,\n\t\terror: policiesError,\n\t\tselectPolicy,\n\t\tdefaultPolicy,\n\t} = useMFAPolicies({\n\t\tenvironmentId,\n\t\ttokenIsValid: tokenStatus.isValid,\n\t\tautoLoad: true,\n\t\tautoSelectSingle: true,\n\t});\n\n\tconst selectedPolicyRef = useRef<DeviceAuthenticationPolicy | null>(null);\n\tuseEffect(() => {\n\t\tselectedPolicyRef.current = selectedPolicy ?? null;\n\t}, [selectedPolicy]);\n\n\tconst isPolicyDeviceEnabled = useCallback(\n\t\t(policy: DeviceAuthenticationPolicy | null, key: string) => {\n\t\t\tconst deviceConfig = policy?.[key] as { enabled?: boolean } | undefined;\n\t\t\treturn !!deviceConfig?.enabled;\n\t\t},\n\t\t[]\n\t);\n\n\tconst policyOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tpolicies.map((policy) => ({\n\t\t\t\tvalue: policy.id,\n\t\t\t\tlabel: policy.name,\n\t\t\t\t...(policy.default ? { secondaryLabel: '(Default)' } : {}),\n\t\t\t})),\n\t\t[policies]\n\t);\n\n\tconst userOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tArray.from(\n\t\t\t\tnew Map(\n\t\t\t\t\t(Array.isArray(users) ? users : []).map((user) => [\n\t\t\t\t\t\tuser.username,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvalue: user.username,\n\t\t\t\t\t\t\tlabel: user.username,\n\t\t\t\t\t\t\t...(user.email ? { secondaryLabel: user.email } : {}),\n\t\t\t\t\t\t} as SearchableDropdownOption,\n\t\t\t\t\t])\n\t\t\t\t).values()\n\t\t\t),\n\t\t[users]\n\t);\n\n\t// Auto-select default policy when policies load\n\tuseEffect(() => {\n\t\tif (defaultPolicy && !selectedPolicy) {\n\t\t\tselectPolicy(defaultPolicy.id);\n\t\t}\n\t}, [defaultPolicy, selectedPolicy, selectPolicy]);\n\n\t// Sync environment ID to global service and CredentialsServiceV8 when it changes\n\tuseEffect(() => {\n\t\tif (environmentId) {\n\t\t\tglobalEnvironmentService.setEnvironmentId(environmentId);\n\t\t\tlocalStorage.setItem('mfa_environmentId', environmentId);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tenvironmentId,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId, username: currentCreds.username }\n\t\t\t}));\n\t\t}\n\t}, [environmentId]);\n\n\t// Save username to localStorage and CredentialsServiceV8 when it changes\n\t// This ensures MFAFlowBase can read the username from its expected storage location\n\tuseEffect(() => {\n\t\tif (username) {\n\t\t\tlocalStorage.setItem('mfa_unified_username', username);\n\t\t\tlocalStorage.setItem('mfa_username', username);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tusername,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId: currentCreds.environmentId, username }\n\t\t\t}));\n\t\t}\n\t}, [username]);\n\n\t// Handle device selection for authentication\n\tconst handleDeviceSelectForAuthentication = async (device: {\n\t\tid: string;\n\t\ttype: string;\n\t\tdeviceName?: string;\n\t\tnickname?: string;\n\t}) => {\n\t\tconsole.log(`${MODULE_TAG} Selected device for authentication:`, device);\n\t\tsetShowDeviceSelectionModal(false);\n\t\tsetSelectedAuthDevice(device);\n\n\t\tconst policyId = selectedPolicy?.id;\n\t\tif (!policyId) {\n\t\t\ttoastV8.error('Please select an MFA Policy first');\n\t\t\treturn;\n\t\t}\n\n\t\t// Determine flow type and token\n\t\t// Admin flows should use worker tokens, not require user tokens\n\t\tconst flowType = userToken ? 'user' : 'admin';\n\t\tconst effectiveUserToken = flowType === 'user' ? userToken : undefined;\n\n\t\t// For admin flow, check if we have a valid worker token before proceeding\n\t\tif (flowType === 'admin' && !hasWorkerToken) {\n\t\t\ttoastV8.error('Admin flow requires a valid worker token. Please generate a worker token first.');\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\t// Initialize authentication with appropriate token\n\t\t\tconst response = await MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\tenvironmentId,\n\t\t\t\tusername: username.trim(),\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t\tdeviceId: device.id,\n\t\t\t\tregion: 'na',\n\t\t\t\ttokenType: flowType,\n\t\t\t\t...(effectiveUserToken && { userToken: effectiveUserToken }),\n\t\t\t});\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth initialized - full response:`, response);\n\t\t\tsetAuthenticationId(response.id);\n\n\t\t\tconst status = (response.status || '').toUpperCase();\n\t\t\tconst nextStep = (response.nextStep || '').toUpperCase();\n\t\t\tconst links = response._links as Record<string, { href?: string }> | undefined;\n\t\t\tconst hasOtpLink = !!(\n\t\t\t\tlinks &&\n\t\t\t\t(links.otp || links['otp.check'] || (links as Record<string, unknown>)['checkOtp'])\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth status:`, {\n\t\t\t\tstatus,\n\t\t\t\tnextStep,\n\t\t\t\thasOtpLink,\n\t\t\t\tdeviceType: device.type,\n\t\t\t});\n\n\t\t\t// Show appropriate UI based on response (normalize status/nextStep for PingOne variants)\n\t\t\tif (status === 'OTP_REQUIRED' || nextStep === 'OTP_REQUIRED' || hasOtpLink) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Opening OTP modal for device:`, device.type);\n\t\t\t\tsetShowOTPModal(true);\n\t\t\t\ttoastV8.success(`Verification code sent to your ${device.type} device`);\n\t\t\t} else if (status === 'ASSERTION_REQUIRED' || nextStep === 'ASSERTION_REQUIRED') {\n\t\t\t\tconsole.log(`${MODULE_TAG} FIDO2 assertion required`);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'FIDO2 authentication required. Please use /v8/mfa-config for FIDO2 authentication.'\n\t\t\t\t);\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'PUSH_CONFIRMATION_REQUIRED' ||\n\t\t\t\tnextStep === 'PUSH_CONFIRMATION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Push confirmation required`);\n\t\t\t\ttoastV8.success('Push notification sent! Please approve on your mobile device.');\n\t\t\t\ttoastV8.info('Complete authentication at /v8/mfa-config for push polling.');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (status === 'COMPLETED') {\n\t\t\t\ttoastV8.success('Authentication completed successfully!');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'DEVICE_SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'DEVICE_SELECTION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Device selection required - showing modal again`);\n\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t} else {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Unexpected authentication status:`, {\n\t\t\t\t\tstatus,\n\t\t\t\t\tnextStep,\n\t\t\t\t\tresponse,\n\t\t\t\t});\n\t\t\t\ttoastV8.info(`Authentication status: ${status || nextStep || 'UNKNOWN'}`);\n\t\t\t\t// Stay in authentication flow so user can try another device\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to initialize authentication:`, error);\n\n\t\t\t// Enhanced error handling for NO_USABLE_DEVICES\n\t\t\tlet errorMessage = 'Authentication failed: ';\n\t\t\tif (error instanceof Error) {\n\t\t\t\tconst errorStr = error.message.toLowerCase();\n\n\t\t\t\t// Check for NO_USABLE_DEVICES or device availability errors\n\t\t\t\tif (\n\t\t\t\t\terrorStr.includes('no usable devices') ||\n\t\t\t\t\terrorStr.includes('too many') ||\n\t\t\t\t\terrorStr.includes('cooldown') ||\n\t\t\t\t\terrorStr.includes('blocked')\n\t\t\t\t) {\n\t\t\t\t\terrorMessage = '‚ö†Ô∏è Device Temporarily Unavailable\\n\\n';\n\n\t\t\t\t\tif (errorStr.includes('cooldown') || errorStr.includes('too many')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Too many notifications have been sent to this device. It is temporarily in cooldown. ';\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Please wait a few minutes and try again, or select a different device.';\n\t\t\t\t\t} else if (errorStr.includes('blocked')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'This device has been blocked. Please contact your administrator or use a different device.';\n\t\t\t\t\t} else {\n\t\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terrorMessage += 'Unknown error';\n\t\t\t}\n\n\t\t\ttoastV8.error(errorMessage, { duration: 8000 });\n\t\t\t// Do NOT set flowMode(null) - keep user in authentication flow so they can retry or select another device\n\t\t}\n\t};\n\n\t// Handle OTP verification\n\tconst handleVerifyOTP = async () => {\n\t\tif (!authenticationId || !selectedAuthDevice) {\n\t\t\ttoastV8.error('Authentication session not found');\n\t\t\treturn;\n\t\t}\n\n\t\tif (otpCode.length !== 6) {\n\t\t\ttoastV8.error('Please enter a 6-digit code');\n\t\t\treturn;\n\t\t}\n\n\t\t// Get worker token for API call\n\t\tconst workerTokenForOTP = await workerTokenServiceV8.getToken();\n\n\t\tconsole.log(`${MODULE_TAG} OTP verification debug:`, {\n\t\t\tenvironmentId,\n\t\t\tusername: username.trim(),\n\t\t\tauthenticationId,\n\t\t\totpCode,\n\t\t\thasEnvironmentId: !!environmentId,\n\t\t\tenvIdLength: environmentId?.length,\n\t\t\thasWorkerToken: !!workerTokenForOTP,\n\t\t\tworkerTokenLength: workerTokenForOTP?.length,\n\t\t});\n\n\t\ttry {\n\t\t\t// Use backend proxy to avoid CORS issues\n\t\t\tconst response = await fetch('/api/pingone/mfa/validate-otp-for-device', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tenvironmentId,\n\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\tdeviceAuthId: authenticationId,\n\t\t\t\t\totp: otpCode,\n\t\t\t\t\tregion: 'na',\n\t\t\t\t\tworkerToken: workerTokenForOTP,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\n\t\t\t\tthrow new Error(errorData.error || errorData.message || `HTTP ${response.status}`);\n\t\t\t}\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.status === 'COMPLETED' || result.status === 'completed') {\n\t\t\t\ttoastV8.success('‚úÖ Authentication completed successfully!');\n\t\t\t\tsetShowOTPModal(false);\n\t\t\t\tsetFlowMode(null);\n\t\t\t\tsetOtpCode('');\n\t\t\t} else {\n\t\t\t\ttoastV8.error('Invalid code. Please try again.');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} OTP verification failed:`, error);\n\t\t\ttoastV8.error(\n\t\t\t\t`Verification failed: ${error instanceof Error ? error.message : 'Unknown error'}`\n\t\t\t);\n\t\t}\n\t};\n\n\t// Step 1: Choose Registration or Authentication\n\tif (!flowMode) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '12px' }}>\n\t\t\t\t\t{/* Header */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tboxShadow: '0 4px 12px rgba(239, 68, 68, 0.2)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h1\n\t\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîê MFA Unified Flow\n\t\t\t\t\t\t</h1>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tChoose what you want to do with MFA devices.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Configuration Section */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 12px 0',\n\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfiguration\n\t\t\t\t\t\t</h2>\n\n\t\t\t\t\t\t{/* Custom Logo URL */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-url\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[800],\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüé® Custom Logo URL (Optional)\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tDisplay a custom logo in the OTP verification modal\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t{/* URL Input */}\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tid=\"custom-logo-url\"\n\t\t\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\t\t\tvalue={customLogoUrl}\n\t\t\t\t\t\t\t\tonChange={(e) => setCustomLogoUrl(e.target.value)}\n\t\t\t\t\t\t\t\tplaceholder=\"https://example.com/logo.png\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\tpadding: '10px 14px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[900],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = `0 0 0 3px ${PING_IDENTITY_COLORS.primary[200]}`;\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.neutral[300];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* File Upload Section */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '13px', color: PING_IDENTITY_COLORS.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\tOR\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"file\"\n\t\t\t\t\t\t\t\t\tid=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\taccept=\"image/*\"\n\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\tconst file = e.target.files?.[0];\n\t\t\t\t\t\t\t\t\t\tif (!file) return;\n\n\t\t\t\t\t\t\t\t\t\t// Validate file type (images only)\n\t\t\t\t\t\t\t\t\t\tif (!file.type.startsWith('image/')) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Please select a logo file (JPG, PNG, etc.)');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Validate file size (max 5MB)\n\t\t\t\t\t\t\t\t\t\tif (file.size > 5 * 1024 * 1024) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('File size must be less than 5MB');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Convert file to base64 for persistence\n\t\t\t\t\t\t\t\t\t\tconst reader = new FileReader();\n\t\t\t\t\t\t\t\t\t\treader.onload = (event) => {\n\t\t\t\t\t\t\t\t\t\t\tconst base64Url = event.target?.result as string;\n\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl(base64Url);\n\n\t\t\t\t\t\t\t\t\t\t\t// Store base64 data for persistence\n\t\t\t\t\t\t\t\t\t\t\tconst uploadData = {\n\t\t\t\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\t\t\t\tbase64Url: base64Url,\n\t\t\t\t\t\t\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\t\t\t// Save to localStorage for persistence\n\t\t\t\t\t\t\t\t\t\t\tlocalStorage.setItem('custom-logo-upload', JSON.stringify(uploadData));\n\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.success(`Logo uploaded: ${file.name}`);\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.onerror = () => {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to read uploaded file');\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.readAsDataURL(file);\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'none' }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.primary[500],\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.primary[600]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '500',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[700];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìÅ Upload Logo File\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[500],\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tJPG, PNG, GIF (max 5MB)\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{customLogoUrl && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.neutral[50],\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tLogo Preview:\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\talt=\"Custom logo\"\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonError={() => {\n\t\t\t\t\t\t\t\t\t\t\t// Handle broken image URLs\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Failed to load custom logo URL');\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl('');\n\t\t\t\t\t\t\t\t\t\t\t\t// Clear uploaded file from localStorage\n\t\t\t\t\t\t\t\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.accent.pingRed[500],\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.accent.pingRed[600]}`,\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[600];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[500];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRemove Logo\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Environment ID - Hide when worker token is available */}\n\t\t\t\t\t\t{!hasWorkerToken && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"env-id\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tEnvironment ID\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"env-id\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setEnvironmentId(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* SQLite Database Stats */}\n\t\t\t\t\t\t{environmentId && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<SQLiteStatsDisplayV8\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tcompact={false}\n\t\t\t\t\t\t\t\t\trefreshInterval={30}\n\t\t\t\t\t\t\t\t\tshowRefreshButton={true}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Username */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUsername\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{environmentId && tokenStatus.isValid ? (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\toptions={userOptions}\n\t\t\t\t\t\t\t\t\tonChange={setUsername}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Type to search across 16,000+ users...\"\n\t\t\t\t\t\t\t\t\tisLoading={isLoadingUsers}\n\t\t\t\t\t\t\t\t\tonSearchChange={setSearchQuery}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setUsername(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* MFA Policy Dropdown */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"mfa-policy\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tMFA Policy\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{isPoliciesLoading ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tLoading policies...\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policiesError ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#ef4444', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tError loading policies: {policiesError}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policies.length === 0 ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tNo MFA policies found. Please check your environment ID and worker token.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"mfa-policy\"\n\t\t\t\t\t\t\t\t\tvalue={selectedPolicy?.id || ''}\n\t\t\t\t\t\t\t\t\toptions={policyOptions}\n\t\t\t\t\t\t\t\t\tonChange={selectPolicy}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Select an MFA policy...\"\n\t\t\t\t\t\t\t\t\tisLoading={isPoliciesLoading}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tSelect the MFA policy to use for device registration\n\t\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t\t{/* Policy Summary - Collapsible */}\n\t\t\t\t\t\t\t{selectedPolicy && (\n\t\t\t\t\t\t\t\t<details\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<summary\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\tuserSelect: 'none',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüìã Policy Details\n\t\t\t\t\t\t\t\t\t</summary>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '12px', fontSize: '13px', color: '#4b5563' }}>\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Policy Name:</strong> {String(selectedPolicy.name)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedPolicy.default && (\n\t\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px', color: '#059669' }}>\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>‚úì Default Policy</strong>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Enabled Devices:</strong>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '6px' }}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'sms') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì± SMS\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'email') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t‚úâÔ∏è Email\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'totp') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîê TOTP\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'fido2') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîë FIDO2\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'mobile') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì≤ Mobile\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'voice') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüìû Voice\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</details>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Worker Token Status */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t\tpaddingRight: '16px',\n\t\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={setEnvironmentId}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* User Token Status */}\n\t\t\t\t\t\t\t{userToken && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\t'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05))',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #10b981',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '20px' }}>üë§</span>\n\t\t\t\t\t\t\t\t\t\t<strong style={{ color: '#047857', fontSize: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t\tUser Token Active\n\t\t\t\t\t\t\t\t\t\t</strong>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: '14px', color: '#059669', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t\t‚úì User authentication token available\n\t\t\t\t\t\t\t\t\t\t<br />‚úì Ready for User Flow device registration\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Flow Mode Selection */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',\n\t\t\t\t\t\t\tgap: '16px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Registration Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => setFlowMode('registration')}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>‚ûï</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#047857',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Registration\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tRegister a new MFA device for a user. Create SMS, Email, TOTP, Mobile Push,\n\t\t\t\t\t\t\t\t\t\tWhatsApp, or FIDO2 devices.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t{/* Authentication Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tif (!userToken) {\n\t\t\t\t\t\t\t\t\tsetShowAuthLoginModal(true);\n\t\t\t\t\t\t\t\t\ttoastV8.info('üîê Please complete user login before device authentication.', {\n\t\t\t\t\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-4px)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 8px 24px rgba(59, 130, 246, 0.2)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>üîì</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#1d4ed8',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Authentication\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tAuthenticate using an existing MFA device. Verify user identity with OTP, push\n\t\t\t\t\t\t\t\t\t\tnotification, or security key.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{showAuthLoginModal && (\n\t\t\t\t\t<UserLoginModalV8\n\t\t\t\t\t\tisOpen={showAuthLoginModal}\n\t\t\t\t\t\tonClose={() => setShowAuthLoginModal(false)}\n\t\t\t\t\t\tonTokenReceived={(token) => {\n\t\t\t\t\t\t\tsetUserToken(token);\n\t\t\t\t\t\t\tsetShowAuthLoginModal(false);\n\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tenvironmentId={authEnvIdForModal}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</>\n\t\t);\n\t}\n\n\t// Authentication flow - dedicated view (device selection + OTP modals only; no registration grid)\n\tif (flowMode === 'authentication') {\n\t\treturn (\n\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\tsetSelectedAuthDevice(null);\n\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t‚Üê Back\n\t\t\t\t\t</button>\n\t\t\t\t\t<h1\n\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t>\n\t\t\t\t\t\tüîì Device Authentication\n\t\t\t\t\t</h1>\n\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\t{selectedAuthDevice && !showOTPModal\n\t\t\t\t\t\t\t? `Authenticating with ${selectedAuthDevice.type} ‚Äî enter the code when prompted.`\n\t\t\t\t\t\t\t: `Select an MFA device to authenticate for ${username || 'the user'}`}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t\t{!showDeviceSelectionModal && !showOTPModal && (\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowDeviceSelectionModal(true)}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tSelect MFA device\n\t\t\t\t\t</button>\n\t\t\t\t)}\n\t\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\t\tonClose={() => {\n\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t// Keep flowMode so user stays in auth flow; only clear if they click Back\n\t\t\t\t\t}}\n\t\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\t\tusername={username}\n\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t/>\n\t\t\t\t{showOTPModal && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.6)',\n\t\t\t\t\t\t\tbackdropFilter: 'blur(4px)',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t\t\tanimation: 'fadeIn 0.2s ease-out',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t{`\n\t\t\t\t\t\t\t@keyframes fadeIn {\n\t\t\t\t\t\t\t\tfrom { opacity: 0; }\n\t\t\t\t\t\t\t\tto { opacity: 1; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes slideUp {\n\t\t\t\t\t\t\t\tfrom { \n\t\t\t\t\t\t\t\t\topacity: 0;\n\t\t\t\t\t\t\t\t\ttransform: translateY(20px); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tto { \n\t\t\t\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t\t\t\t\ttransform: translateY(0); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes pulse {\n\t\t\t\t\t\t\t\t0%, 100% { opacity: 1; }\n\t\t\t\t\t\t\t\t50% { opacity: 0.5; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`}\n\t\t\t\t\t\t</style>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\tborderRadius: '24px',\n\t\t\t\t\t\t\t\tpadding: '48px 40px',\n\t\t\t\t\t\t\t\tmaxWidth: '480px',\n\t\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\t\tboxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',\n\t\t\t\t\t\t\t\tanimation: 'slideUp 0.3s ease-out',\n\t\t\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Logo Area */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '32px' }}>\n\t\t\t\t\t\t\t\t{customLogoUrl ? (\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\t\talt=\"Organization logo\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '120px',\n\t\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonError={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\t// Fallback to default icon if image fails to load\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.display = 'none';\n\t\t\t\t\t\t\t\t\t\t\t\tconst fallback = document.createElement('div');\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.style.cssText = `\n\t\t\t\t\t\t\t\t\t\t\t\twidth: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\theight: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: 0 auto 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: center;\n\t\t\t\t\t\t\t\t\t\t\t\tjustifyContent: center;\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: 36px;\n\t\t\t\t\t\t\t\t\t\t\t\tboxShadow: 0 10px 25px rgba(102, 126, 234, 0.3);\n\t\t\t\t\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.textContent = 'üîê';\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.parentElement!.appendChild(fallback);\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\theight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto 20px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '20px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '36px',\n\t\t\t\t\t\t\t\t\t\t\tboxShadow: '0 10px 25px rgba(102, 126, 234, 0.3)',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüîê\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tVerification Code\n\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\tEnter the 6-digit code sent to your <strong>{selectedAuthDevice?.type}</strong>{' '}\n\t\t\t\t\t\t\t\t\tdevice\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* OTP Input */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\t\t\tplaceholder=\"‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢\"\n\t\t\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tletterSpacing: '12px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow: otpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{otpCode.length > 0 && otpCode.length < 6 && (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\t\tanimation: 'pulse 2s ease-in-out infinite',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{6 - otpCode.length} more digit{6 - otpCode.length !== 1 ? 's' : ''} needed\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Resend Code Button */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={async () => {\n\t\t\t\t\t\t\t\t\t\tif (!selectedAuthDevice || !authenticationId) return;\n\t\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.info('Resending verification code...');\n\t\t\t\t\t\t\t\t\t\t\t// Re-initialize authentication to resend code\n\t\t\t\t\t\t\t\t\t\t\tconst response =\n\t\t\t\t\t\t\t\t\t\t\t\tawait MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\t\t\t\t\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\t\t\t\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicy?.id || '',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceId: selectedAuthDevice.id,\n\t\t\t\t\t\t\t\t\t\t\t\t\tregion: 'na',\n\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tif (response.status?.toUpperCase() === 'OTP_REQUIRED') {\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('New code sent to your device!');\n\t\t\t\t\t\t\t\t\t\t\t\tsetAuthenticationId(response.id);\n\t\t\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to resend code');\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Resend error:', error);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tcolor: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'transparent';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚Üª Resend Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Action Buttons */}\n\t\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#d1d5db';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f9fafb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'white';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6\n\t\t\t\t\t\t\t\t\t\t\t\t? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '#d1d5db',\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (otpCode.length === 6) {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚úì Verify Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Help Text */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<strong style={{ color: '#111827' }}>Didn't receive the code?</strong>\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\tCheck your spam folder or click \"Resend Code\" above\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t);\n\t}\n\n\t// Registration flow - show device type selection cards\n\treturn (\n\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t{/* Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #10b981 0%, #047857 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => setFlowMode(null)}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t‚Üê Back\n\t\t\t\t</button>\n\t\t\t\t<h1 style={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}>\n\t\t\t\t\t‚ûï Register MFA Device\n\t\t\t\t</h1>\n\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\tSelect a device type to register for {username || 'the user'}\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Device Type Cards */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',\n\t\t\t\t\tgap: '16px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t{DEVICE_TYPES.map((device) => {\n\t\t\t\t\tconst enabled = isDeviceEnabled(device.key);\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tkey={device.key}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => enabled && onSelectDeviceType(device.key)}\n\t\t\t\t\t\t\tdisabled={!enabled}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tbackground: enabled ? '#ffffff' : '#f9fafb',\n\t\t\t\t\t\t\t\tborder: `2px solid ${enabled ? '#e5e7eb' : '#f3f4f6'}`,\n\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\tcursor: enabled ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\topacity: enabled ? 1 : 0.5,\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#10b981';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ecfdf5';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>{device.icon}</span>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{device.name}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280' }}>{device.description}</p>\n\t\t\t\t\t\t\t{!enabled && (\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '12px', color: '#9ca3af' }}>\n\t\t\t\t\t\t\t\t\t(Not enabled)\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</div>\n\n\t\t\t{/* Device Selection Modal for Authentication */}\n\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t}}\n\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\tusername={username}\n\t\t\t\tenvironmentId={environmentId}\n\t\t\t/>\n\n\t\t\t{/* OTP Modal for Authentication */}\n\t\t\t{showOTPModal && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '400px',\n\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\tboxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '600' }}>\n\t\t\t\t\t\t\tEnter Verification Code\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '0 0 20px 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tCheck your {selectedAuthDevice?.type} device for the code\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\tplaceholder=\"000000\"\n\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 16px',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\tletterSpacing: '8px',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tmarginBottom: '20px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: otpCode.length === 6 ? '#3b82f6' : '#9ca3af',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tVerify\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Wrapper Component\n *\n * Wraps the content with MFACredentialProvider to provide global credential state\n */\nexport const UnifiedMFARegistrationFlowV8: React.FC<UnifiedMFARegistrationFlowV8Props> = (\n\tprops\n) => {\n\tconst location = useLocation();\n\n\t// Get device type from props or location state (can be undefined)\n\tconst initialDeviceType =\n\t\tprops.deviceType || (location.state as { deviceType?: DeviceConfigKey })?.deviceType;\n\n\t// State for selected device type (allows user to select if not provided)\n\tconst [selectedDeviceType, setSelectedDeviceType] = useState<DeviceConfigKey | undefined>(\n\t\tinitialDeviceType\n\t);\n\n\t// User token state for OAuth authentication (User Flow)\n\tconst [userToken, setUserToken] = useState<string | null>(() => {\n\t\t// Check if we already have a user token from previous OAuth flow\n\t\tconst savedCreds = CredentialsServiceV8.loadCredentials('user-login-v8', {\n\t\t\tflowKey: 'user-login-v8',\n\t\t\tflowType: 'oauth',\n\t\t\tincludeClientSecret: false,\n\t\t\tincludeRedirectUri: false,\n\t\t\tincludeLogoutUri: false,\n\t\t\tincludeScopes: false,\n\t\t});\n\t\treturn savedCreds?.accessToken || null;\n\t});\n\n\t// If no device type selected, show device type selection screen\n\tif (!selectedDeviceType) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<MFAHeaderV8\n\t\t\t\t\ttitle=\"MFA Unified Flow\"\n\t\t\t\t\tdescription=\"Register or authenticate MFA devices\"\n\t\t\t\t\tversionTag=\"V8\"\n\t\t\t\t\tcurrentPage=\"registration\"\n\t\t\t\t\tshowBackToMain={true}\n\t\t\t\t\theaderColor=\"pingRed\"\n\t\t\t\t/>\n\t\t\t\t<GlobalMFAProvider>\n\t\t\t\t\t<MFACredentialProvider>\n\t\t\t\t\t\t<DeviceTypeSelectionScreen\n\t\t\t\t\t\t\tonSelectDeviceType={setSelectedDeviceType}\n\t\t\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</MFACredentialProvider>\n\t\t\t\t</GlobalMFAProvider>\n\t\t\t\t{/* API display (bottom of page) */}\n\t\t\t\t<div style={{ marginTop: '24px' }}>\n\t\t\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\t\t\t\t</div>\n\t\t\t</>\n\t\t);\n\t}\n\n\treturn (\n\t\t<GlobalMFAProvider>\n\t\t\t<MFACredentialProvider>\n\t\t\t\t<UnifiedMFARegistrationFlowContent\n\t\t\t\t\t{...props}\n\t\t\t\t\tdeviceType={selectedDeviceType}\n\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t/>\n\t\t\t</MFACredentialProvider>\n\t\t</GlobalMFAProvider>\n\t);\n};\n\n// ============================================================================\n// CONTENT COMPONENT (MAIN LOGIC)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Content Component\n *\n * Contains the actual flow logic and integrates with:\n * - MFACredentialContext (global credential state)\n * - useWorkerToken hook (token status and auto-refresh)\n * - deviceFlowConfigs (device-specific configuration)\n * - MFAFlowBaseV8 (5-step framework)\n */\nconst UnifiedMFARegistrationFlowContent: React.FC<\n\tRequired<Pick<UnifiedMFARegistrationFlowV8Props, 'deviceType'>> &\n\t\tOmit<UnifiedMFARegistrationFlowV8Props, 'deviceType'> & {\n\t\t\tuserToken: string | null;\n\t\t\tsetUserToken: (token: string | null) => void;\n\t\t}\n> = ({ deviceType, onCancel, userToken, setUserToken }) => {\n\t// ========================================================================\n\t// CONFIGURATION\n\t// ========================================================================\n\n\t// React Router navigation\n\tconst navigate = useNavigate();\n\n\t// Load device-specific configuration\n\tconst config = useMemo(() => {\n\t\treturn getDeviceConfig(deviceType);\n\t}, [deviceType]);\n\n\t// ========================================================================\n\t// USER FLOW OAUTH STATE\n\t// ========================================================================\n\n\t// State for User Login Modal (OAuth authentication for User Flow)\n\tconst [showUserLoginModal, setShowUserLoginModal] = useState(false);\n\tconst [showUserTokenSuccess, setShowUserTokenSuccess] = useState(false);\n\tconst [userTokenForDisplay, setUserTokenForDisplay] = useState<string>('');\n\tconst [usernameFromToken, setUsernameFromToken] = useState<string>('');\n\tconst [showUsernameDropdown, setShowUsernameDropdown] = useState(false);\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\tconst envIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Pending registration data while waiting for OAuth (use ref to avoid stale closure)\n\tconst pendingRegistrationRef = useRef<{\n\t\tdeviceType: DeviceConfigKey;\n\t\tfields: Record<string, string>;\n\t\tflowType: string;\n\t\tprops: MFAFlowBaseRenderProps;\n\t} | null>(null);\n\n\t// Worker token state for validation in registration flow\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Detect OAuth callback and re-open modal if needed\n\tuseEffect(() => {\n\t\tconst urlParams = new URLSearchParams(window.location.search);\n\t\tconst code = urlParams.get('code');\n\t\tconst hasStoredState = sessionStorage.getItem('user_login_state_v8');\n\n\t\t// If we have OAuth callback params and stored state, re-open the modal to process callback\n\t\t// But only if we don't already have a user token (to prevent reopening after silent auth)\n\t\tif (code && hasStoredState && !showUserLoginModal && !userToken) {\n\t\t\tconsole.log('[UNIFIED-FLOW] OAuth callback detected - re-opening modal to process');\n\t\t\tsetShowUserLoginModal(true);\n\t\t}\n\t}, [showUserLoginModal, userToken]);\n\n\t// ========================================================================\n\t// STEP VALIDATION\n\t// ========================================================================\n\n\t/**\n\t * Validate Step 0 (Configuration)\n\t */\n\tconst validateStep0 = useCallback(\n\t\t(\n\t\t\tcredentials: MFACredentials,\n\t\t\ttoken: TokenStatusInfo,\n\t\t\tnavigation: ReturnType<typeof useStepNavigationV8>\n\t\t) => {\n\t\t\t// Always check for valid worker token (required for MFA device operations)\n\t\t\tif (!token.isValid) {\n\t\t\t\tnavigation.setValidationErrors(['Invalid or expired worker token']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Check required configuration\n\t\t\tif (!credentials.environmentId || !credentials.username) {\n\t\t\t\tnavigation.setValidationErrors(['Environment ID and Username are required']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\t\t[]\n\t);\n\n\t// ========================================================================\n\t// STEP RENDERERS\n\t// ========================================================================\n\n\t/**\n\t * Perform device registration API call (with token already available)\n\t */\n\tconst performRegistrationWithToken = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string,\n\t\t\ttoken?: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== PERFORM REGISTRATION WITH TOKEN =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Token:', token ? `Present (${token.length} chars)` : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setIsLoading available:', typeof props.setIsLoading);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setCredentials available:', typeof props.setCredentials);\n\n\t\t\ttry {\n\t\t\t\tprops.setIsLoading(true);\n\n\t\t\t\t// Update credentials with device fields and user token if provided\n\t\t\t\tprops.setCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tflowType, // Store flowType so activation step knows if OTP is required\n\t\t\t\t\t...fields,\n\t\t\t\t\t...(flowType === 'user' && token\n\t\t\t\t\t\t? { userToken: token, tokenType: 'user' }\n\t\t\t\t\t\t: flowType !== 'user'\n\t\t\t\t\t\t\t? { tokenType: 'worker' }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t}));\n\n\t\t\t\t// Register the device using proper API call\n\t\t\t\t// CRITICAL: Flow-specific device status\n\t\t\t\t// - Admin flow: ACTIVE (no OTP sent, device ready immediately)\n\t\t\t\t// - Admin ACTIVATION_REQUIRED: ACTIVATION_REQUIRED (sends OTP for admin to activate)\n\t\t\t\t// - User flow: ACTIVATION_REQUIRED (sends OTP for user to activate)\n\t\t\t\t// - FIDO2: ACTIVE (WebAuthn verification happens during registration)\n\t\t\t\tlet deviceStatus: 'ACTIVE' | 'ACTIVATION_REQUIRED' | undefined;\n\n\t\t\t\t// Determine device status based on flow type (applies to all device types including FIDO2)\n\t\t\t\tif (flowType === 'admin-active') {\n\t\t\t\t\tdeviceStatus = 'ACTIVE';\n\t\t\t\t} else if (flowType === 'admin-activation') {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED';\n\t\t\t\t} else {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED'; // user flow\n\t\t\t\t}\n\n\t\t\t\t// Special note for FIDO2: WebAuthn verification proves device works,\n\t\t\t\t// but we still respect the flow type for status determination\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t'[UNIFIED-FLOW] FIDO2 device - status determined by flow type:',\n\t\t\t\t\t\tdeviceStatus\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device status determined:', {\n\t\t\t\t\tflowType,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tdeviceStatus,\n\t\t\t\t\totpWillBeSent: deviceStatus === 'ACTIVATION_REQUIRED',\n\t\t\t\t\treason:\n\t\t\t\t\t\tselectedDeviceType === 'FIDO2'\n\t\t\t\t\t\t\t? 'FIDO2 - ACTIVE after WebAuthn verification'\n\t\t\t\t\t\t\t: 'User flow - OTP required for activation',\n\t\t\t\t});\n\n\t\t\t\t// Use same parameter construction as working MFA flows\n\t\t\t\ttype RegisterDeviceParamsWithToken = RegisterDeviceParams & {\n\t\t\t\t\ttokenType?: 'worker' | 'user';\n\t\t\t\t\tuserToken?: string | undefined;\n\t\t\t\t};\n\t\t\t\tlet baseParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\tenvironmentId: props.credentials.environmentId,\n\t\t\t\t\tusername: props.credentials.username,\n\t\t\t\t\ttype: selectedDeviceType,\n\t\t\t\t};\n\t\t\t\t// Per rightTOTP.md: Pass token type and user token if available\n\t\t\t\tif (flowType === 'user' && token) {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'user',\n\t\t\t\t\t\tuserToken: token,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'worker',\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Always include status for all device types\n\t\t\t\t// FIDO2: Set to ACTIVE since WebAuthn verification proves device works\n\t\t\t\t// Other devices: Set based on flow type (admin-active = ACTIVE, others = ACTIVATION_REQUIRED)\n\t\t\t\tif (deviceStatus !== undefined) {\n\t\t\t\t\tbaseParams.status = deviceStatus;\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registration base params:', {\n\t\t\t\t\tenvironmentId: baseParams.environmentId,\n\t\t\t\t\tusername: baseParams.username,\n\t\t\t\t\ttype: baseParams.type,\n\t\t\t\t\ttokenType: baseParams.tokenType,\n\t\t\t\t\tstatus: baseParams.status,\n\t\t\t\t\tflowType,\n\t\t\t\t});\n\n\t\t\t\t// Map form field names to API field names\n\t\t\t\t// Form uses 'deviceName' but API expects 'nickname' or 'name'\n\t\t\t\tconst mappedFields: Record<string, string> = { ...fields };\n\t\t\t\tif (mappedFields.deviceName) {\n\t\t\t\t\tmappedFields.nickname = mappedFields.deviceName;\n\t\t\t\t\tmappedFields.name = mappedFields.deviceName;\n\t\t\t\t\tdelete mappedFields.deviceName;\n\t\t\t\t}\n\n\t\t\t\t// Format phone number for SMS/WhatsApp devices\n\t\t\t\t// Form sends: { phoneNumber: '9725231586', countryCode: '+1' }\n\t\t\t\t// API expects: { phone: '+1.9725231586' }\n\t\t\t\tif (mappedFields.phoneNumber && mappedFields.countryCode) {\n\t\t\t\t\tconst countryCode = mappedFields.countryCode.replace('+', ''); // Remove + for formatting\n\t\t\t\t\tconst phoneNumber = mappedFields.phoneNumber.replace(/\\D/g, ''); // Remove non-digits\n\t\t\t\t\tmappedFields.phone = `+${countryCode}.${phoneNumber}`;\n\t\t\t\t\tconsole.log('[UNIFIED-FLOW] Formatted phone:', mappedFields.phone);\n\t\t\t\t\tdelete mappedFields.phoneNumber;\n\t\t\t\t\tdelete mappedFields.countryCode;\n\t\t\t\t}\n\n\t\t\t\t// Include device-specific fields (phone, email, etc.)\n\t\t\t\tconst deviceParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\t...baseParams,\n\t\t\t\t\t...mappedFields,\n\t\t\t\t\t// Include policy for TOTP devices (required for secret and keyUri to be returned)\n\t\t\t\t\t...(selectedDeviceType === 'TOTP' && selectedPolicyRef.current\n\t\t\t\t\t\t? { policy: selectedPolicyRef.current.id }\n\t\t\t\t\t\t: {}),\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registering device with params:', deviceParams);\n\n\t\t\t\tconst result = await MFAServiceV8_Legacy.registerDevice(deviceParams);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device registered:', result);\n\n\t\t\t\t// Update MFA state with device info\n\t\t\t\tconst registrationResult = result as unknown as Record<string, unknown>;\n\n\t\t\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result for TOTP:', {\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\tqrCode: registrationResult.qrCode,\n\t\t\t\t\t\tqrCodeUrl: registrationResult.qrCodeUrl,\n\t\t\t\t\t\tsecret: registrationResult.secret,\n\t\t\t\t\t\ttotpSecret: registrationResult.totpSecret,\n\t\t\t\t\t\tfullResult: result,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// ===============================================\n\n\t\t\t\t// Clear stored registration data after successful use\n\t\t\t\tlocalStorage.removeItem('mfa_registration_flow_type');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_fields');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_device_type');\n\n\t\t\t\tprops.setMfaState((prev) => {\n\t\t\t\t\t// TOTP: QR code will be rendered by QRCodeSVG component in UnifiedActivationStep\n\t\t\t\t\t// No need to generate QR code data URL here - just pass the keyUri\n\t\t\t\t\tconst newState: MFAState = {\n\t\t\t\t\t\t...prev,\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tdeviceStatus: result.status,\n\t\t\t\t\t\t...(registrationResult.deviceActivateUri\n\t\t\t\t\t\t\t? { deviceActivateUri: String(registrationResult.deviceActivateUri) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'TOTP'\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\ttotpSecret: String(registrationResult.secret || ''),\n\t\t\t\t\t\t\t\t\tkeyUri: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tqrCodeUrl: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tshowQr: !!(registrationResult.secret || registrationResult.keyUri),\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'FIDO2' &&\n\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tpublicKeyCredentialCreationOptions:\n\t\t\t\t\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions,\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'MOBILE' && registrationResult.pairingKey\n\t\t\t\t\t\t\t? { pairingKey: String(registrationResult.pairingKey) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t};\n\n\t\t\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\t\t\tfullState: newState,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t// ================================================\n\n\t\t\t\t\treturn newState;\n\t\t\t\t});\n\n\t\t\t\t// FIDO2: Check if we already have credential data (from WebAuthn modal)\n\t\t\t\t// If credentialId and publicKey are present, registration is complete\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tif (fields.credentialId && fields.publicKey) {\n\t\t\t\t\t\t// WebAuthn already completed via modal - device fully registered\n\n\t\t\t\t\t\t// Admin Flow: Show QR but skip OTP validation - device ready immediately\n\t\t\t\t\t\t// Admin ACTIVATION_REQUIRED & User Flow: Show QR and require OTP validation\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tflowType === 'admin-active' ||\n\t\t\t\t\t\t\tflowType === 'admin-activation' ||\n\t\t\t\t\t\t\tresult.status === 'ACTIVE'\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t'[UNIFIED-FLOW] Admin flow or ACTIVE status - proceeding to show QR without OTP requirement'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered successfully!${flowType === 'admin-active' || flowType === 'admin-activation' ? ' Device is ready to use.' : ''}`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t// For Admin Flow, go to API docs page instead of OTP page\n\t\t\t\t\t\t\t// For User Flow, go to User Login step (Step 1)\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (result.status === 'ACTIVATION_REQUIRED') {\n\t\t\t\t\t\t\t// Device requires activation - PingOne automatically sends OTP\n\t\t\t\t\t\t\t// This applies to both admin_activation_required and user flow\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered! OTP has been sent automatically.`\n\t\t\t\t\t\t\t);\n  // DO NOT auto-advance for OTP-required devices\n\t\t\t\t\t\t\t// User should manually click Next after receiving OTP\n\t\t\t\t\t\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation - waiting for user to proceed manually`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Unknown status, proceed with flow-specific navigation\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} // End of FIDO2 section\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Registration failed:', error);\n\t\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Device registration failed';\n\n\t\t\t\t// Check if error is due to too many devices\n\t\t\t\tif (errorMessage.includes('Too many devices')) {\n\t\t\t\t\ttoastV8.error(\n\t\t\t\t\t\t`${errorMessage}\\n\\n‚ÑπÔ∏è You can manage your devices at:\\nhttps://localhost:3000/v8/delete-all-devices`,\n\t\t\t\t\t\t{ duration: 8000 }\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\ttoastV8.error(errorMessage);\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tprops.setIsLoading(false);\n\t\t\t}\n\t\t},\n\t\t[config.displayName, toastV8]\n\t);\n\n\t/**\n\t * Handle user token received from OAuth flow\n\t */\n\tconst handleUserTokenReceived = useCallback(\n\t\t(token: string) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== USER TOKEN RECEIVED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Token length:', token.length);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current pending registration:', pendingRegistrationRef.current);\n\n\t\t\tsetUserToken(token);\n\t\t\tsetUserTokenForDisplay(token);\n\n\t\t\t// Decode JWT to extract username\n\t\t\ttry {\n\t\t\t\tconst base64Url = token.split('.')[1];\n\t\t\t\tconst base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n\t\t\t\tconst jsonPayload = decodeURIComponent(\n\t\t\t\t\tatob(base64)\n\t\t\t\t\t\t.split('')\n\t\t\t\t\t\t.map((c) => `%${`00${c.charCodeAt(0).toString(16)}`.slice(-2)}`)\n\t\t\t\t\t\t.join('')\n\t\t\t\t);\n\t\t\t\tconst payload = JSON.parse(jsonPayload);\n\t\t\t\tconst username =\n\t\t\t\t\tpayload.username || payload.preferred_username || payload.sub || 'Unknown User';\n\t\t\t\tsetUsernameFromToken(username);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Extracted username:', username);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Failed to decode JWT:', error);\n\t\t\t\tsetUsernameFromToken('Unknown User');\n\t\t\t}\n\n\t\t\t// If we have pending registration, show success page first\n\t\t\tconst pending = pendingRegistrationRef.current;\n\t\t\tif (pending) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Found pending registration, showing success page first...');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending data:', {\n\t\t\t\t\tdeviceType: pending.deviceType,\n\t\t\t\t\tflowType: pending.flowType,\n\t\t\t\t\thasProps: !!pending.props,\n\t\t\t\t\thasFields: !!pending.fields,\n\t\t\t\t});\n\n\t\t\t\ttoastV8.success('‚úÖ Authentication successful! Your user token is ready.', {\n\t\t\t\t\tduration: 4000,\n\t\t\t\t});\n\n\t\t\t\t// Close login modal and show success page\n\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\tsetShowUserTokenSuccess(true);\n\t\t\t} else {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] WARNING: No pending registration found after OAuth!');\n\t\t\t}\n\t\t},\n\t\t[setUserToken]\n\t);\n\n\t/**\n\t * Handle continue from user token success page\n\t */\n\tconst handleContinueAfterUserLogin = useCallback(() => {\n\t\tconsole.log(\n\t\t\t'[UNIFIED-FLOW] User clicked continue after login, proceeding with registration...'\n\t\t);\n\n\t\tconst pending = pendingRegistrationRef.current;\n\t\tif (pending && userToken) {\n\t\t\tconst { deviceType: pendingDeviceType, fields, flowType, props } = pending;\n\t\t\tpendingRegistrationRef.current = null;\n\n\t\t\t// Hide success page\n\t\t\tsetShowUserTokenSuccess(false);\n\n\t\t\t// Continue with registration\n\t\t\tsetTimeout(() => {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Now executing performRegistrationWithToken...');\n\t\t\t\tperformRegistrationWithToken(props, pendingDeviceType, fields, flowType, userToken);\n\t\t\t}, 100);\n\t\t}\n\t}, [userToken, performRegistrationWithToken]);\n\n\t/**\n\t * Perform device registration API call\n\t * Checks if User Flow needs OAuth first, otherwise proceeds with registration\n\t */\n\tconst performRegistration = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== DEVICE REGISTRATION SUBMITTED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current userToken:', userToken ? 'Present' : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\n\t\t\t// CRITICAL: Validate worker token before allowing any registration\n\t\t\tif (!workerToken.tokenStatus.isValid) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Cannot proceed - no valid worker token');\n\t\t\t\ttoastV8.error(\n\t\t\t\t\t'‚ùå Worker token required for device registration. Please configure worker token credentials first.',\n\t\t\t\t\t{\n\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// For User Flow, check if we need OAuth authentication first\n\t\t\tif (flowType === 'user' && !userToken) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] User flow selected but no token - showing OAuth modal');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Storing pending registration...');\n\n\t\t\t\t// Store pending registration data\n\t\t\t\tpendingRegistrationRef.current = {\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tfields,\n\t\t\t\t\tflowType,\n\t\t\t\t\tprops,\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending registration stored:', pendingRegistrationRef.current);\n\n\t\t\t\t// Set return target for device registration flow\n\t\t\t\tReturnTargetServiceV8U.setReturnTarget(\n\t\t\t\t\t'mfa_device_registration',\n\t\t\t\t\t'/v8/unified-mfa',  // Return to unified MFA flow\n\t\t\t\t\t2  // Step 2: Device Selection\n\t\t\t\t);\n\n\t\t\t\t// Show the user login modal\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'üîê User Flow requires PingOne authentication. Please complete the login to continue with device registration.',\n\t\t\t\t\t{ duration: 6000 }\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t'[UNIFIED-FLOW] Proceeding directly with registration (token exists or admin flow)'\n\t\t\t);\n\t\t\t// Proceed with registration (using existing token for user flow)\n\t\t\tawait performRegistrationWithToken(\n\t\t\t\tprops,\n\t\t\t\tselectedDeviceType,\n\t\t\t\tfields,\n\t\t\t\tflowType,\n\t\t\t\tuserToken || undefined\n\t\t\t);\n\t\t},\n\t\t[workerToken.tokenStatus.isValid, userToken]\n\t);\n\n\t/**\n\t * Render Step 0: Configuration (environment, user, policy)\n\t */\n\tconst renderStep0 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn (\n\t\t\t\t<UnifiedDeviceRegistrationForm\n\t\t\t\t\tinitialDeviceType={deviceType}\n\t\t\t\t\tonSubmit={async (selectedDeviceType, fields, flowType) => {\n\t\t\t\t\t\tawait performRegistration(props, selectedDeviceType, fields, flowType);\n\t\t\t\t\t}}\n\t\t\t\t\tonCancel={() => {\n\t\t\t\t\t\tif (onCancel) onCancel();\n\t\t\t\t\t}}\n\t\t\t\t\ttokenStatus={props.tokenStatus}\n\t\t\t\t\tusername={props.credentials.username}\n\t\t\t\t/>\n\t\t\t);\n\t\t},\n\t\t[deviceType, onCancel, performRegistration]\n\t);\n\n\t/**\n\t * Render Step 1: User Login using Authorization Code Flow with PKCE\n\t */\n\tconst renderStep1 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <UserLoginStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 2: Device Selection (option to call registration if want new device, or have no devices)\n\t */\n\tconst renderStep2 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 3: Device-Specific Actions (OTP/QR Generation, FIDO, Mobile Push)\n\t */\n\tconst renderStep3 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific based on the device type\n\t\t\t// For now, return the activation step which handles device-specific logic\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 4: OTP Validation / Confirmation\n\t */\n\tconst renderStep4 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific validation\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 5: API Documentation\n\t */\n\tconst renderStep5 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <APIDocsStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 6: Success screen with all user data and other valuable options\n\t */\n\tconst renderStep6 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <SuccessStepV8 renderProps={props} />;\n\t}, []);\n\n\t// Step labels for device authentication flow\n\tconst stepLabels = useMemo(() => {\n\t\tif (deviceType === 'FIDO2') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Start FIDO in Browser',\n\t\t\t\t'Passkey confirmation',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else if (deviceType === 'MOBILE') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Push to Mobile App',\n\t\t\t\t'User Confirms on Mobile',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else {\n\t\t\t// SMS, Email, TOTP, WhatsApp\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Generate OTP/QR',\n\t\t\t\t'Validate OTP',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t}\n\t}, [deviceType]);\n\n\tconst shouldHideNextButton = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\tif (props.nav.currentStep === 0) {\n\t\t\treturn true; // Hide Next button on configuration step, use form submit\n\t\t}\n\t\tif (props.nav.currentStep === 1) {\n\t\t\treturn true; // Hide Next button on user login step, use authentication button\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\treturn (\n\t\t<>\n\t\t\t<MFAFlowBaseV8\n\t\t\t\tdeviceType={deviceType}\n\t\t\t\trenderStep0={renderStep0}\n\t\t\t\trenderStep1={renderStep1}\n\t\t\t\trenderStep2={renderStep2}\n\t\t\t\trenderStep3={renderStep3}\n\t\t\t\trenderStep4={renderStep4}\n\t\t\t\trenderStep5={renderStep5}\n\t\t\t\trenderStep6={renderStep6}\n\t\t\t\tvalidateStep0={validateStep0}\n\t\t\t\tstepLabels={stepLabels}\n\t\t\t\tshouldHideNextButton={shouldHideNextButton}\n\t\t\t\tflowType=\"device-auth\"\n\t\t\t/>\n\t\t\t<div style={{ height: '300px' }} />\n\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\n\t\t\t{/* User Login Modal for User Flow OAuth */}\n\t\t\t<UserLoginModalV8\n\t\t\t\tisOpen={showUserLoginModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\t\tpendingRegistrationRef.current = null;\n\t\t\t\t}}\n\t\t\t\tonTokenReceived={handleUserTokenReceived}\n\t\t\t\tenvironmentId={envIdForModal}\n\t\t\t/>\n\n\t\t\t{/* User Token Success Page - Show token after OAuth login */}\n\t\t\t{showUserTokenSuccess && userTokenForDisplay && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 10000,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\t\t\tboxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Success Header */}\n\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\twidth: '64px',\n\t\t\t\t\t\t\t\t\theight: '64px',\n\t\t\t\t\t\t\t\t\tborderRadius: '50%',\n\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>‚úÖ</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<h2 style={{ margin: '0 0 8px 0', fontSize: '24px', color: '#1f2937' }}>\n\t\t\t\t\t\t\t\tAuthentication Successful!\n\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\tYour user token has been obtained and is ready to use.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Username Dropdown */}\n\t\t\t\t\t\t{usernameFromToken && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUsernameDropdown(!showUsernameDropdown)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tpadding: 0,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: showUsernameDropdown ? '12px' : 0,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '16px', color: '#374151' }}>Username</h3>\n\t\t\t\t\t\t\t\t\t{showUsernameDropdown ? (\n\t\t\t\t\t\t\t\t\t\t<FiChevronUp size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t<FiChevronDown size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{showUsernameDropdown && (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{usernameFromToken}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(usernameFromToken);\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('Username copied to clipboard!');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüìã Copy Username\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Token Display */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<h3 style={{ margin: '0 0 12px 0', fontSize: '16px', color: '#374151' }}>\n\t\t\t\t\t\t\t\tUser Access Token\n\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{userTokenForDisplay}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(userTokenForDisplay);\n\t\t\t\t\t\t\t\t\ttoastV8.success('Token copied to clipboard!');\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüìã Copy Token\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Next Steps Info */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#eff6ff',\n\t\t\t\t\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#1e40af', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t<strong>Next:</strong> Click \"Continue with Registration\" to proceed with your{' '}\n\t\t\t\t\t\t\t\t{config.displayName} device registration using this user token.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Continue Button */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleContinueAfterUserLogin}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\tbackground: '#10b981',\n\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tboxShadow: '0 2px 8px rgba(16, 185, 129, 0.3)',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tContinue with Registration ‚Üí\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</>\n\t);\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default UnifiedMFARegistrationFlowV8;\n"},"tags":["fixable"],"source":null},{"category":"lint/correctness/noUnusedVariables","severity":"warning","description":"This variable setRegistrationError is unused.","message":[{"elements":[],"content":"This variable "},{"elements":["Emphasis"],"content":"setRegistrationError"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused variables are often the result of typos, incomplete refactors, or other sources of bugs."}]]},{"log":["info",[{"elements":[],"content":"Unsafe fix: If this is intentional, prepend "},{"elements":["Emphasis"],"content":"setRegistrationError"},{"elements":[],"content":" with an underscore."}]]},{"diff":{"dictionary":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\tconst [usernameFromToken, setUsernameFromToken] = useState<string>('');\n\tconst [showUsernameDropdown, setShowUsernameDropdown] = useState(false);\n\tconst [registrationError, setRegistrationError_setRegistrationError] = useState<string | null>(null);\n\tconst envIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\nexport default UnifiedMFARegistrationFlowV8;\n","ops":[{"diffOp":{"equal":{"range":[0,73]}}},{"equalLines":{"line_count":1984}},{"diffOp":{"equal":{"range":[73,247]}}},{"diffOp":{"delete":{"range":[247,267]}}},{"diffOp":{"insert":{"range":[267,288]}}},{"diffOp":{"equal":{"range":[288,416]}}},{"equalLines":{"line_count":872}},{"diffOp":{"equal":{"range":[416,462]}}}]}}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/UnifiedMFARegistrationFlowV8_Legacy.tsx"},"span":[61923,61943],"sourceCode":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\n * @description Unified MFA Registration Flow - Single component for all 6 device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Replace 6 device-specific flow components (SMS, Email, Mobile, WhatsApp, TOTP, FIDO2)\n * with a single configurable component using deviceFlowConfigs for device-specific behavior.\n *\n * Architecture:\n * - Configuration-driven using deviceFlowConfigs.ts\n * - Dynamic form rendering for simple devices (SMS, Email, WhatsApp)\n * - Custom components for complex devices (TOTP, FIDO2, Mobile)\n * - Integrates with MFACredentialContext and useWorkerToken hook\n * - Uses existing MFAFlowBaseV8 for 5-step framework\n *\n * @example\n * <UnifiedMFARegistrationFlowV8\n *   deviceType=\"SMS\"\n *   onSuccess={(result) => console.log('Device registered:', result.deviceId)}\n * />\n */\n\nimport * as React from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { FiChevronDown, FiChevronUp } from 'react-icons/fi';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { MFAHeaderV8 } from '@/v8/components/MFAHeaderV8';\nimport type { SearchableDropdownOption } from '@/v8/components/SearchableDropdownV8';\nimport { SearchableDropdownV8 } from '@/v8/components/SearchableDropdownV8';\nimport { SQLiteStatsDisplayV8 } from '@/v8/components/SQLiteStatsDisplayV8';\nimport { SuperSimpleApiDisplayV8 } from '@/v8/components/SuperSimpleApiDisplayV8';\nimport { UserLoginModalV8 } from '@/v8/components/UserLoginModalV8';\nimport { getDeviceConfig } from '@/v8/config/deviceFlowConfigs';\nimport type { DeviceConfigKey, DeviceRegistrationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport { PING_IDENTITY_COLORS } from '@/v8/constants/pingIdentityColors';\nimport { GlobalMFAProvider } from '@/v8/contexts/GlobalMFAContext';\nimport { MFACredentialProvider } from '@/v8/contexts/MFACredentialContext';\nimport { APIDocsStepV8 } from '@/v8/flows/shared/APIDocsStepV8';\nimport { SuccessStepV8 } from '@/v8/flows/shared/SuccessStepV8';\nimport { UserLoginStepV8 } from '@/v8/flows/shared/UserLoginStepV8';\nimport { useMFAPolicies } from '@/v8/hooks/useMFAPolicies';\nimport { useStepNavigationV8 } from '@/v8/hooks/useStepNavigationV8';\nimport { useUserSearch } from '@/v8/hooks/useUserSearch';\nimport { useWorkerToken } from '@/v8/hooks/useWorkerToken';\nimport { CredentialsServiceV8 } from '@/v8/services/credentialsServiceV8';\nimport { globalEnvironmentService } from '@/v8/services/globalEnvironmentService';\nimport { MfaAuthenticationServiceV8 } from '@/v8/services/mfaAuthenticationServiceV8';\nimport { type MFAFeatureFlag, MFAFeatureFlagsV8 } from '@/v8/services/mfaFeatureFlagsV8';\nimport MFAServiceV8_Legacy, { type RegisterDeviceParams } from '@/v8/services/mfaServiceV8_Legacy';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport type { TokenStatusInfo } from '@/v8/services/workerTokenStatusServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { ReturnTargetServiceV8U } from '@/v8u/services/returnTargetServiceV8U';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type MFAFlowBaseRenderProps, MFAFlowBaseV8 } from '../shared/MFAFlowBaseV8';\nimport type { DeviceAuthenticationPolicy, MFACredentials, MFAState } from '../shared/MFATypes';\nimport { UnifiedActivationStep } from './components/UnifiedActivationStep';\nimport { UnifiedDeviceRegistrationForm } from './components/UnifiedDeviceRegistrationForm';\nimport { UnifiedDeviceSelectionModal } from './components/UnifiedDeviceSelectionModal';\nimport { UnifiedSuccessStep } from './components/UnifiedSuccessStep';\nimport './UnifiedMFAFlow.css';\n\nconst MODULE_TAG = '[üîÑ UNIFIED-MFA-FLOW-V8]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedMFARegistrationFlowV8Props {\n\t/** Device type to render (optional - can be provided via navigation state) */\n\tdeviceType?: DeviceConfigKey;\n\n\t/** Optional initial credentials (for pre-filled forms) */\n\tinitialCredentials?: Partial<MFACredentials>;\n\n\t/** Optional callback when registration succeeds */\n\tonSuccess?: (result: DeviceRegistrationResult) => void;\n\n\t/** Optional callback when user cancels flow */\n\tonCancel?: () => void;\n\n\t/** Optional initial step (defaults to 0) */\n\tinitialStep?: number;\n\n\t/** Optional: Skip configuration step if already configured */\n\tskipConfiguration?: boolean;\n\n\t/** Optional: Force specific registration flow type */\n\tregistrationFlowType?: 'admin-active' | 'admin-activation' | 'user';\n}\n\n// ============================================================================\n// MFA FLOW SELECTION SCREEN\n// ============================================================================\n\ntype FlowMode = 'registration' | 'authentication';\n\n/** Map device types to their feature flags */\nconst DEVICE_FLAG_MAP: Record<DeviceConfigKey, MFAFeatureFlag> = {\n\tSMS: 'mfa_unified_sms',\n\tEMAIL: 'mfa_unified_email',\n\tMOBILE: 'mfa_unified_mobile',\n\tWHATSAPP: 'mfa_unified_whatsapp',\n\tTOTP: 'mfa_unified_totp',\n\tFIDO2: 'mfa_unified_fido2',\n};\n\nconst DEVICE_TYPES: { key: DeviceConfigKey; icon: string; name: string; description: string }[] = [\n\t{ key: 'SMS', icon: 'üì±', name: 'SMS', description: 'Receive OTP codes via text message' },\n\t{ key: 'EMAIL', icon: '‚úâÔ∏è', name: 'Email', description: 'Receive OTP codes via email' },\n\t{\n\t\tkey: 'TOTP',\n\t\ticon: 'üîê',\n\t\tname: 'Authenticator App (TOTP)',\n\t\tdescription: 'Use Google Authenticator, Authy, or similar',\n\t},\n\t{\n\t\tkey: 'MOBILE',\n\t\ticon: 'üì≤',\n\t\tname: 'Mobile Push',\n\t\tdescription: 'Receive push notifications on your phone',\n\t},\n\t{ key: 'WHATSAPP', icon: 'üí¨', name: 'WhatsApp', description: 'Receive OTP codes via WhatsApp' },\n\t{\n\t\tkey: 'FIDO2',\n\t\ticon: 'üîë',\n\t\tname: 'Security Key (FIDO2)',\n\t\tdescription: 'Use a hardware security key or passkey',\n\t},\n];\n\n/** Check if a device type is enabled via feature flags */\nconst isDeviceEnabled = (deviceKey: DeviceConfigKey): boolean => {\n\tconst flag = DEVICE_FLAG_MAP[deviceKey];\n\treturn MFAFeatureFlagsV8.isEnabled(flag);\n};\n\ninterface DeviceTypeSelectionScreenProps {\n\tonSelectDeviceType: (deviceType: DeviceConfigKey) => void;\n\tuserToken?: string | null;\n\tsetUserToken: (token: string | null) => void;\n}\n\nconst DeviceTypeSelectionScreen: React.FC<DeviceTypeSelectionScreenProps> = ({\n\tonSelectDeviceType,\n\tuserToken,\n\tsetUserToken,\n}) => {\n\tconst [flowMode, setFlowMode] = useState<FlowMode | null>(null);\n\tconst [environmentId, setEnvironmentId] = useState('');\n\tconst [username, setUsername] = useState('');\n\tconst [showDeviceSelectionModal, setShowDeviceSelectionModal] = useState(false);\n\tconst [showOTPModal, setShowOTPModal] = useState(false);\n\tconst [otpCode, setOtpCode] = useState('');\n\tconst [authenticationId, setAuthenticationId] = useState<string | null>(null);\n\tconst [selectedAuthDevice, setSelectedAuthDevice] = useState<{\n\t\tid: string;\n\t\ttype: string;\n\t\tnickname?: string;\n\t} | null>(null);\n\tconst [customLogoUrl, setCustomLogoUrl] = useState<string>('');\n\tconst [showAuthLoginModal, setShowAuthLoginModal] = useState(false);\n\tconst authEnvIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Load uploaded logo from localStorage on mount\n\tuseEffect(() => {\n\t\ttry {\n\t\t\tconst savedUpload = localStorage.getItem('custom-logo-upload');\n\t\t\tif (savedUpload) {\n\t\t\t\tconst uploadData = JSON.parse(savedUpload);\n\t\t\t\t// Handle both old format (objectUrl) and new format (base64Url)\n\t\t\t\tif (uploadData.base64Url) {\n\t\t\t\t\tsetCustomLogoUrl(uploadData.base64Url);\n\t\t\t\t} else if (uploadData.objectUrl) {\n\t\t\t\t\t// Old format - try to convert if possible, otherwise clear it\n\t\t\t\t\tconsole.warn('Old logo format detected - please re-upload your logo');\n\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load uploaded logo from localStorage:', error);\n\t\t\t// Clear corrupted data\n\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t}\n\t}, []);\n\n\t// Use worker token hook for token management\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Extract environment ID from worker token when available\n\tuseEffect(() => {\n\t\tconst extractEnvironmentId = async () => {\n\t\t\ttry {\n\t\t\t\tconst token = await workerTokenServiceV8.getToken();\n\t\t\t\tif (token && !environmentId) {\n\t\t\t\t\tconst parts = token.split('.');\n\t\t\t\t\tif (parts.length === 3) {\n\t\t\t\t\t\tconst payload = JSON.parse(atob(parts[1]));\n\t\t\t\t\t\tif (payload.environmentId) {\n\t\t\t\t\t\t\tsetEnvironmentId(payload.environmentId);\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`${MODULE_TAG} Environment ID extracted from worker token:`,\n\t\t\t\t\t\t\t\tpayload.environmentId\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Failed to extract environment ID from worker token:`, error);\n\t\t\t}\n\t\t};\n\n\t\textractEnvironmentId();\n\t}, [environmentId]);\n\n\tconst hasWorkerToken = workerToken.tokenStatus.isValid;\n\n\t// Use user search hook for user fetching and search\n\tconst {\n\t\tusers,\n\t\tisLoading: isLoadingUsers,\n\t\tsetSearchQuery,\n\t} = useUserSearch({\n\t\tenvironmentId,\n\t\ttokenValid: workerToken.tokenStatus.isValid,\n\t\tmaxPages: 100,\n\t\tuseCache: true,\n\t});\n\tconst tokenStatus = workerToken.tokenStatus;\n\n\t// Debug: Log users type to understand the issue\n\tuseEffect(() => {\n\t\tconsole.log(`${MODULE_TAG} users type check:`, {\n\t\t\tusers,\n\t\t\tisArray: Array.isArray(users),\n\t\t\ttype: typeof users,\n\t\t\tconstructor: users?.constructor?.name,\n\t\t});\n\t}, [users]);\n\n\t// Load Environment ID and username from global services on mount\n\tuseEffect(() => {\n\t\t// Initialize the service first to load from localStorage\n\t\tglobalEnvironmentService.initialize();\n\t\tconst savedEnvId = globalEnvironmentService.getEnvironmentId();\n\t\tif (savedEnvId) {\n\t\t\tsetEnvironmentId(savedEnvId);\n\t\t}\n\n\t\t// Load username from localStorage\n\t\tconst savedUsername = localStorage.getItem('mfa_unified_username');\n\t\tif (savedUsername) {\n\t\t\tsetUsername(savedUsername);\n\t\t}\n\t}, []);\n\n\t// Use MFA policies hook\n\tconst {\n\t\tpolicies,\n\t\tselectedPolicy,\n\t\tisLoading: isPoliciesLoading,\n\t\terror: policiesError,\n\t\tselectPolicy,\n\t\tdefaultPolicy,\n\t} = useMFAPolicies({\n\t\tenvironmentId,\n\t\ttokenIsValid: tokenStatus.isValid,\n\t\tautoLoad: true,\n\t\tautoSelectSingle: true,\n\t});\n\n\tconst selectedPolicyRef = useRef<DeviceAuthenticationPolicy | null>(null);\n\tuseEffect(() => {\n\t\tselectedPolicyRef.current = selectedPolicy ?? null;\n\t}, [selectedPolicy]);\n\n\tconst isPolicyDeviceEnabled = useCallback(\n\t\t(policy: DeviceAuthenticationPolicy | null, key: string) => {\n\t\t\tconst deviceConfig = policy?.[key] as { enabled?: boolean } | undefined;\n\t\t\treturn !!deviceConfig?.enabled;\n\t\t},\n\t\t[]\n\t);\n\n\tconst policyOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tpolicies.map((policy) => ({\n\t\t\t\tvalue: policy.id,\n\t\t\t\tlabel: policy.name,\n\t\t\t\t...(policy.default ? { secondaryLabel: '(Default)' } : {}),\n\t\t\t})),\n\t\t[policies]\n\t);\n\n\tconst userOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tArray.from(\n\t\t\t\tnew Map(\n\t\t\t\t\t(Array.isArray(users) ? users : []).map((user) => [\n\t\t\t\t\t\tuser.username,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvalue: user.username,\n\t\t\t\t\t\t\tlabel: user.username,\n\t\t\t\t\t\t\t...(user.email ? { secondaryLabel: user.email } : {}),\n\t\t\t\t\t\t} as SearchableDropdownOption,\n\t\t\t\t\t])\n\t\t\t\t).values()\n\t\t\t),\n\t\t[users]\n\t);\n\n\t// Auto-select default policy when policies load\n\tuseEffect(() => {\n\t\tif (defaultPolicy && !selectedPolicy) {\n\t\t\tselectPolicy(defaultPolicy.id);\n\t\t}\n\t}, [defaultPolicy, selectedPolicy, selectPolicy]);\n\n\t// Sync environment ID to global service and CredentialsServiceV8 when it changes\n\tuseEffect(() => {\n\t\tif (environmentId) {\n\t\t\tglobalEnvironmentService.setEnvironmentId(environmentId);\n\t\t\tlocalStorage.setItem('mfa_environmentId', environmentId);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tenvironmentId,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId, username: currentCreds.username }\n\t\t\t}));\n\t\t}\n\t}, [environmentId]);\n\n\t// Save username to localStorage and CredentialsServiceV8 when it changes\n\t// This ensures MFAFlowBase can read the username from its expected storage location\n\tuseEffect(() => {\n\t\tif (username) {\n\t\t\tlocalStorage.setItem('mfa_unified_username', username);\n\t\t\tlocalStorage.setItem('mfa_username', username);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tusername,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId: currentCreds.environmentId, username }\n\t\t\t}));\n\t\t}\n\t}, [username]);\n\n\t// Handle device selection for authentication\n\tconst handleDeviceSelectForAuthentication = async (device: {\n\t\tid: string;\n\t\ttype: string;\n\t\tdeviceName?: string;\n\t\tnickname?: string;\n\t}) => {\n\t\tconsole.log(`${MODULE_TAG} Selected device for authentication:`, device);\n\t\tsetShowDeviceSelectionModal(false);\n\t\tsetSelectedAuthDevice(device);\n\n\t\tconst policyId = selectedPolicy?.id;\n\t\tif (!policyId) {\n\t\t\ttoastV8.error('Please select an MFA Policy first');\n\t\t\treturn;\n\t\t}\n\n\t\t// Determine flow type and token\n\t\t// Admin flows should use worker tokens, not require user tokens\n\t\tconst flowType = userToken ? 'user' : 'admin';\n\t\tconst effectiveUserToken = flowType === 'user' ? userToken : undefined;\n\n\t\t// For admin flow, check if we have a valid worker token before proceeding\n\t\tif (flowType === 'admin' && !hasWorkerToken) {\n\t\t\ttoastV8.error('Admin flow requires a valid worker token. Please generate a worker token first.');\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\t// Initialize authentication with appropriate token\n\t\t\tconst response = await MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\tenvironmentId,\n\t\t\t\tusername: username.trim(),\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t\tdeviceId: device.id,\n\t\t\t\tregion: 'na',\n\t\t\t\ttokenType: flowType,\n\t\t\t\t...(effectiveUserToken && { userToken: effectiveUserToken }),\n\t\t\t});\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth initialized - full response:`, response);\n\t\t\tsetAuthenticationId(response.id);\n\n\t\t\tconst status = (response.status || '').toUpperCase();\n\t\t\tconst nextStep = (response.nextStep || '').toUpperCase();\n\t\t\tconst links = response._links as Record<string, { href?: string }> | undefined;\n\t\t\tconst hasOtpLink = !!(\n\t\t\t\tlinks &&\n\t\t\t\t(links.otp || links['otp.check'] || (links as Record<string, unknown>)['checkOtp'])\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth status:`, {\n\t\t\t\tstatus,\n\t\t\t\tnextStep,\n\t\t\t\thasOtpLink,\n\t\t\t\tdeviceType: device.type,\n\t\t\t});\n\n\t\t\t// Show appropriate UI based on response (normalize status/nextStep for PingOne variants)\n\t\t\tif (status === 'OTP_REQUIRED' || nextStep === 'OTP_REQUIRED' || hasOtpLink) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Opening OTP modal for device:`, device.type);\n\t\t\t\tsetShowOTPModal(true);\n\t\t\t\ttoastV8.success(`Verification code sent to your ${device.type} device`);\n\t\t\t} else if (status === 'ASSERTION_REQUIRED' || nextStep === 'ASSERTION_REQUIRED') {\n\t\t\t\tconsole.log(`${MODULE_TAG} FIDO2 assertion required`);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'FIDO2 authentication required. Please use /v8/mfa-config for FIDO2 authentication.'\n\t\t\t\t);\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'PUSH_CONFIRMATION_REQUIRED' ||\n\t\t\t\tnextStep === 'PUSH_CONFIRMATION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Push confirmation required`);\n\t\t\t\ttoastV8.success('Push notification sent! Please approve on your mobile device.');\n\t\t\t\ttoastV8.info('Complete authentication at /v8/mfa-config for push polling.');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (status === 'COMPLETED') {\n\t\t\t\ttoastV8.success('Authentication completed successfully!');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'DEVICE_SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'DEVICE_SELECTION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Device selection required - showing modal again`);\n\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t} else {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Unexpected authentication status:`, {\n\t\t\t\t\tstatus,\n\t\t\t\t\tnextStep,\n\t\t\t\t\tresponse,\n\t\t\t\t});\n\t\t\t\ttoastV8.info(`Authentication status: ${status || nextStep || 'UNKNOWN'}`);\n\t\t\t\t// Stay in authentication flow so user can try another device\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to initialize authentication:`, error);\n\n\t\t\t// Enhanced error handling for NO_USABLE_DEVICES\n\t\t\tlet errorMessage = 'Authentication failed: ';\n\t\t\tif (error instanceof Error) {\n\t\t\t\tconst errorStr = error.message.toLowerCase();\n\n\t\t\t\t// Check for NO_USABLE_DEVICES or device availability errors\n\t\t\t\tif (\n\t\t\t\t\terrorStr.includes('no usable devices') ||\n\t\t\t\t\terrorStr.includes('too many') ||\n\t\t\t\t\terrorStr.includes('cooldown') ||\n\t\t\t\t\terrorStr.includes('blocked')\n\t\t\t\t) {\n\t\t\t\t\terrorMessage = '‚ö†Ô∏è Device Temporarily Unavailable\\n\\n';\n\n\t\t\t\t\tif (errorStr.includes('cooldown') || errorStr.includes('too many')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Too many notifications have been sent to this device. It is temporarily in cooldown. ';\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Please wait a few minutes and try again, or select a different device.';\n\t\t\t\t\t} else if (errorStr.includes('blocked')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'This device has been blocked. Please contact your administrator or use a different device.';\n\t\t\t\t\t} else {\n\t\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terrorMessage += 'Unknown error';\n\t\t\t}\n\n\t\t\ttoastV8.error(errorMessage, { duration: 8000 });\n\t\t\t// Do NOT set flowMode(null) - keep user in authentication flow so they can retry or select another device\n\t\t}\n\t};\n\n\t// Handle OTP verification\n\tconst handleVerifyOTP = async () => {\n\t\tif (!authenticationId || !selectedAuthDevice) {\n\t\t\ttoastV8.error('Authentication session not found');\n\t\t\treturn;\n\t\t}\n\n\t\tif (otpCode.length !== 6) {\n\t\t\ttoastV8.error('Please enter a 6-digit code');\n\t\t\treturn;\n\t\t}\n\n\t\t// Get worker token for API call\n\t\tconst workerTokenForOTP = await workerTokenServiceV8.getToken();\n\n\t\tconsole.log(`${MODULE_TAG} OTP verification debug:`, {\n\t\t\tenvironmentId,\n\t\t\tusername: username.trim(),\n\t\t\tauthenticationId,\n\t\t\totpCode,\n\t\t\thasEnvironmentId: !!environmentId,\n\t\t\tenvIdLength: environmentId?.length,\n\t\t\thasWorkerToken: !!workerTokenForOTP,\n\t\t\tworkerTokenLength: workerTokenForOTP?.length,\n\t\t});\n\n\t\ttry {\n\t\t\t// Use backend proxy to avoid CORS issues\n\t\t\tconst response = await fetch('/api/pingone/mfa/validate-otp-for-device', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tenvironmentId,\n\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\tdeviceAuthId: authenticationId,\n\t\t\t\t\totp: otpCode,\n\t\t\t\t\tregion: 'na',\n\t\t\t\t\tworkerToken: workerTokenForOTP,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\n\t\t\t\tthrow new Error(errorData.error || errorData.message || `HTTP ${response.status}`);\n\t\t\t}\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.status === 'COMPLETED' || result.status === 'completed') {\n\t\t\t\ttoastV8.success('‚úÖ Authentication completed successfully!');\n\t\t\t\tsetShowOTPModal(false);\n\t\t\t\tsetFlowMode(null);\n\t\t\t\tsetOtpCode('');\n\t\t\t} else {\n\t\t\t\ttoastV8.error('Invalid code. Please try again.');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} OTP verification failed:`, error);\n\t\t\ttoastV8.error(\n\t\t\t\t`Verification failed: ${error instanceof Error ? error.message : 'Unknown error'}`\n\t\t\t);\n\t\t}\n\t};\n\n\t// Step 1: Choose Registration or Authentication\n\tif (!flowMode) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '12px' }}>\n\t\t\t\t\t{/* Header */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tboxShadow: '0 4px 12px rgba(239, 68, 68, 0.2)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h1\n\t\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîê MFA Unified Flow\n\t\t\t\t\t\t</h1>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tChoose what you want to do with MFA devices.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Configuration Section */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 12px 0',\n\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfiguration\n\t\t\t\t\t\t</h2>\n\n\t\t\t\t\t\t{/* Custom Logo URL */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-url\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[800],\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüé® Custom Logo URL (Optional)\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tDisplay a custom logo in the OTP verification modal\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t{/* URL Input */}\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tid=\"custom-logo-url\"\n\t\t\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\t\t\tvalue={customLogoUrl}\n\t\t\t\t\t\t\t\tonChange={(e) => setCustomLogoUrl(e.target.value)}\n\t\t\t\t\t\t\t\tplaceholder=\"https://example.com/logo.png\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\tpadding: '10px 14px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[900],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = `0 0 0 3px ${PING_IDENTITY_COLORS.primary[200]}`;\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.neutral[300];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* File Upload Section */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '13px', color: PING_IDENTITY_COLORS.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\tOR\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"file\"\n\t\t\t\t\t\t\t\t\tid=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\taccept=\"image/*\"\n\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\tconst file = e.target.files?.[0];\n\t\t\t\t\t\t\t\t\t\tif (!file) return;\n\n\t\t\t\t\t\t\t\t\t\t// Validate file type (images only)\n\t\t\t\t\t\t\t\t\t\tif (!file.type.startsWith('image/')) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Please select a logo file (JPG, PNG, etc.)');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Validate file size (max 5MB)\n\t\t\t\t\t\t\t\t\t\tif (file.size > 5 * 1024 * 1024) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('File size must be less than 5MB');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Convert file to base64 for persistence\n\t\t\t\t\t\t\t\t\t\tconst reader = new FileReader();\n\t\t\t\t\t\t\t\t\t\treader.onload = (event) => {\n\t\t\t\t\t\t\t\t\t\t\tconst base64Url = event.target?.result as string;\n\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl(base64Url);\n\n\t\t\t\t\t\t\t\t\t\t\t// Store base64 data for persistence\n\t\t\t\t\t\t\t\t\t\t\tconst uploadData = {\n\t\t\t\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\t\t\t\tbase64Url: base64Url,\n\t\t\t\t\t\t\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\t\t\t// Save to localStorage for persistence\n\t\t\t\t\t\t\t\t\t\t\tlocalStorage.setItem('custom-logo-upload', JSON.stringify(uploadData));\n\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.success(`Logo uploaded: ${file.name}`);\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.onerror = () => {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to read uploaded file');\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.readAsDataURL(file);\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'none' }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.primary[500],\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.primary[600]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '500',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[700];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìÅ Upload Logo File\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[500],\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tJPG, PNG, GIF (max 5MB)\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{customLogoUrl && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.neutral[50],\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tLogo Preview:\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\talt=\"Custom logo\"\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonError={() => {\n\t\t\t\t\t\t\t\t\t\t\t// Handle broken image URLs\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Failed to load custom logo URL');\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl('');\n\t\t\t\t\t\t\t\t\t\t\t\t// Clear uploaded file from localStorage\n\t\t\t\t\t\t\t\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.accent.pingRed[500],\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.accent.pingRed[600]}`,\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[600];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[500];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRemove Logo\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Environment ID - Hide when worker token is available */}\n\t\t\t\t\t\t{!hasWorkerToken && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"env-id\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tEnvironment ID\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"env-id\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setEnvironmentId(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* SQLite Database Stats */}\n\t\t\t\t\t\t{environmentId && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<SQLiteStatsDisplayV8\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tcompact={false}\n\t\t\t\t\t\t\t\t\trefreshInterval={30}\n\t\t\t\t\t\t\t\t\tshowRefreshButton={true}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Username */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUsername\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{environmentId && tokenStatus.isValid ? (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\toptions={userOptions}\n\t\t\t\t\t\t\t\t\tonChange={setUsername}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Type to search across 16,000+ users...\"\n\t\t\t\t\t\t\t\t\tisLoading={isLoadingUsers}\n\t\t\t\t\t\t\t\t\tonSearchChange={setSearchQuery}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setUsername(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* MFA Policy Dropdown */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"mfa-policy\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tMFA Policy\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{isPoliciesLoading ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tLoading policies...\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policiesError ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#ef4444', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tError loading policies: {policiesError}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policies.length === 0 ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tNo MFA policies found. Please check your environment ID and worker token.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"mfa-policy\"\n\t\t\t\t\t\t\t\t\tvalue={selectedPolicy?.id || ''}\n\t\t\t\t\t\t\t\t\toptions={policyOptions}\n\t\t\t\t\t\t\t\t\tonChange={selectPolicy}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Select an MFA policy...\"\n\t\t\t\t\t\t\t\t\tisLoading={isPoliciesLoading}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tSelect the MFA policy to use for device registration\n\t\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t\t{/* Policy Summary - Collapsible */}\n\t\t\t\t\t\t\t{selectedPolicy && (\n\t\t\t\t\t\t\t\t<details\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<summary\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\tuserSelect: 'none',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüìã Policy Details\n\t\t\t\t\t\t\t\t\t</summary>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '12px', fontSize: '13px', color: '#4b5563' }}>\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Policy Name:</strong> {String(selectedPolicy.name)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedPolicy.default && (\n\t\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px', color: '#059669' }}>\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>‚úì Default Policy</strong>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Enabled Devices:</strong>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '6px' }}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'sms') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì± SMS\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'email') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t‚úâÔ∏è Email\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'totp') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîê TOTP\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'fido2') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîë FIDO2\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'mobile') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì≤ Mobile\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'voice') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüìû Voice\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</details>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Worker Token Status */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t\tpaddingRight: '16px',\n\t\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={setEnvironmentId}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* User Token Status */}\n\t\t\t\t\t\t\t{userToken && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\t'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05))',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #10b981',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '20px' }}>üë§</span>\n\t\t\t\t\t\t\t\t\t\t<strong style={{ color: '#047857', fontSize: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t\tUser Token Active\n\t\t\t\t\t\t\t\t\t\t</strong>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: '14px', color: '#059669', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t\t‚úì User authentication token available\n\t\t\t\t\t\t\t\t\t\t<br />‚úì Ready for User Flow device registration\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Flow Mode Selection */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',\n\t\t\t\t\t\t\tgap: '16px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Registration Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => setFlowMode('registration')}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>‚ûï</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#047857',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Registration\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tRegister a new MFA device for a user. Create SMS, Email, TOTP, Mobile Push,\n\t\t\t\t\t\t\t\t\t\tWhatsApp, or FIDO2 devices.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t{/* Authentication Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tif (!userToken) {\n\t\t\t\t\t\t\t\t\tsetShowAuthLoginModal(true);\n\t\t\t\t\t\t\t\t\ttoastV8.info('üîê Please complete user login before device authentication.', {\n\t\t\t\t\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-4px)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 8px 24px rgba(59, 130, 246, 0.2)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>üîì</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#1d4ed8',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Authentication\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tAuthenticate using an existing MFA device. Verify user identity with OTP, push\n\t\t\t\t\t\t\t\t\t\tnotification, or security key.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{showAuthLoginModal && (\n\t\t\t\t\t<UserLoginModalV8\n\t\t\t\t\t\tisOpen={showAuthLoginModal}\n\t\t\t\t\t\tonClose={() => setShowAuthLoginModal(false)}\n\t\t\t\t\t\tonTokenReceived={(token) => {\n\t\t\t\t\t\t\tsetUserToken(token);\n\t\t\t\t\t\t\tsetShowAuthLoginModal(false);\n\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tenvironmentId={authEnvIdForModal}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</>\n\t\t);\n\t}\n\n\t// Authentication flow - dedicated view (device selection + OTP modals only; no registration grid)\n\tif (flowMode === 'authentication') {\n\t\treturn (\n\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\tsetSelectedAuthDevice(null);\n\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t‚Üê Back\n\t\t\t\t\t</button>\n\t\t\t\t\t<h1\n\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t>\n\t\t\t\t\t\tüîì Device Authentication\n\t\t\t\t\t</h1>\n\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\t{selectedAuthDevice && !showOTPModal\n\t\t\t\t\t\t\t? `Authenticating with ${selectedAuthDevice.type} ‚Äî enter the code when prompted.`\n\t\t\t\t\t\t\t: `Select an MFA device to authenticate for ${username || 'the user'}`}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t\t{!showDeviceSelectionModal && !showOTPModal && (\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowDeviceSelectionModal(true)}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tSelect MFA device\n\t\t\t\t\t</button>\n\t\t\t\t)}\n\t\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\t\tonClose={() => {\n\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t// Keep flowMode so user stays in auth flow; only clear if they click Back\n\t\t\t\t\t}}\n\t\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\t\tusername={username}\n\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t/>\n\t\t\t\t{showOTPModal && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.6)',\n\t\t\t\t\t\t\tbackdropFilter: 'blur(4px)',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t\t\tanimation: 'fadeIn 0.2s ease-out',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t{`\n\t\t\t\t\t\t\t@keyframes fadeIn {\n\t\t\t\t\t\t\t\tfrom { opacity: 0; }\n\t\t\t\t\t\t\t\tto { opacity: 1; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes slideUp {\n\t\t\t\t\t\t\t\tfrom { \n\t\t\t\t\t\t\t\t\topacity: 0;\n\t\t\t\t\t\t\t\t\ttransform: translateY(20px); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tto { \n\t\t\t\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t\t\t\t\ttransform: translateY(0); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes pulse {\n\t\t\t\t\t\t\t\t0%, 100% { opacity: 1; }\n\t\t\t\t\t\t\t\t50% { opacity: 0.5; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`}\n\t\t\t\t\t\t</style>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\tborderRadius: '24px',\n\t\t\t\t\t\t\t\tpadding: '48px 40px',\n\t\t\t\t\t\t\t\tmaxWidth: '480px',\n\t\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\t\tboxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',\n\t\t\t\t\t\t\t\tanimation: 'slideUp 0.3s ease-out',\n\t\t\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Logo Area */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '32px' }}>\n\t\t\t\t\t\t\t\t{customLogoUrl ? (\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\t\talt=\"Organization logo\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '120px',\n\t\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonError={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\t// Fallback to default icon if image fails to load\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.display = 'none';\n\t\t\t\t\t\t\t\t\t\t\t\tconst fallback = document.createElement('div');\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.style.cssText = `\n\t\t\t\t\t\t\t\t\t\t\t\twidth: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\theight: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: 0 auto 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: center;\n\t\t\t\t\t\t\t\t\t\t\t\tjustifyContent: center;\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: 36px;\n\t\t\t\t\t\t\t\t\t\t\t\tboxShadow: 0 10px 25px rgba(102, 126, 234, 0.3);\n\t\t\t\t\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.textContent = 'üîê';\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.parentElement!.appendChild(fallback);\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\theight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto 20px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '20px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '36px',\n\t\t\t\t\t\t\t\t\t\t\tboxShadow: '0 10px 25px rgba(102, 126, 234, 0.3)',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüîê\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tVerification Code\n\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\tEnter the 6-digit code sent to your <strong>{selectedAuthDevice?.type}</strong>{' '}\n\t\t\t\t\t\t\t\t\tdevice\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* OTP Input */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\t\t\tplaceholder=\"‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢\"\n\t\t\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tletterSpacing: '12px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow: otpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{otpCode.length > 0 && otpCode.length < 6 && (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\t\tanimation: 'pulse 2s ease-in-out infinite',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{6 - otpCode.length} more digit{6 - otpCode.length !== 1 ? 's' : ''} needed\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Resend Code Button */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={async () => {\n\t\t\t\t\t\t\t\t\t\tif (!selectedAuthDevice || !authenticationId) return;\n\t\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.info('Resending verification code...');\n\t\t\t\t\t\t\t\t\t\t\t// Re-initialize authentication to resend code\n\t\t\t\t\t\t\t\t\t\t\tconst response =\n\t\t\t\t\t\t\t\t\t\t\t\tawait MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\t\t\t\t\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\t\t\t\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicy?.id || '',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceId: selectedAuthDevice.id,\n\t\t\t\t\t\t\t\t\t\t\t\t\tregion: 'na',\n\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tif (response.status?.toUpperCase() === 'OTP_REQUIRED') {\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('New code sent to your device!');\n\t\t\t\t\t\t\t\t\t\t\t\tsetAuthenticationId(response.id);\n\t\t\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to resend code');\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Resend error:', error);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tcolor: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'transparent';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚Üª Resend Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Action Buttons */}\n\t\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#d1d5db';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f9fafb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'white';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6\n\t\t\t\t\t\t\t\t\t\t\t\t? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '#d1d5db',\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (otpCode.length === 6) {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚úì Verify Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Help Text */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<strong style={{ color: '#111827' }}>Didn't receive the code?</strong>\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\tCheck your spam folder or click \"Resend Code\" above\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t);\n\t}\n\n\t// Registration flow - show device type selection cards\n\treturn (\n\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t{/* Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #10b981 0%, #047857 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => setFlowMode(null)}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t‚Üê Back\n\t\t\t\t</button>\n\t\t\t\t<h1 style={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}>\n\t\t\t\t\t‚ûï Register MFA Device\n\t\t\t\t</h1>\n\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\tSelect a device type to register for {username || 'the user'}\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Device Type Cards */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',\n\t\t\t\t\tgap: '16px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t{DEVICE_TYPES.map((device) => {\n\t\t\t\t\tconst enabled = isDeviceEnabled(device.key);\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tkey={device.key}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => enabled && onSelectDeviceType(device.key)}\n\t\t\t\t\t\t\tdisabled={!enabled}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tbackground: enabled ? '#ffffff' : '#f9fafb',\n\t\t\t\t\t\t\t\tborder: `2px solid ${enabled ? '#e5e7eb' : '#f3f4f6'}`,\n\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\tcursor: enabled ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\topacity: enabled ? 1 : 0.5,\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#10b981';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ecfdf5';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>{device.icon}</span>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{device.name}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280' }}>{device.description}</p>\n\t\t\t\t\t\t\t{!enabled && (\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '12px', color: '#9ca3af' }}>\n\t\t\t\t\t\t\t\t\t(Not enabled)\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</div>\n\n\t\t\t{/* Device Selection Modal for Authentication */}\n\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t}}\n\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\tusername={username}\n\t\t\t\tenvironmentId={environmentId}\n\t\t\t/>\n\n\t\t\t{/* OTP Modal for Authentication */}\n\t\t\t{showOTPModal && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '400px',\n\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\tboxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '600' }}>\n\t\t\t\t\t\t\tEnter Verification Code\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '0 0 20px 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tCheck your {selectedAuthDevice?.type} device for the code\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\tplaceholder=\"000000\"\n\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 16px',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\tletterSpacing: '8px',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tmarginBottom: '20px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: otpCode.length === 6 ? '#3b82f6' : '#9ca3af',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tVerify\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Wrapper Component\n *\n * Wraps the content with MFACredentialProvider to provide global credential state\n */\nexport const UnifiedMFARegistrationFlowV8: React.FC<UnifiedMFARegistrationFlowV8Props> = (\n\tprops\n) => {\n\tconst location = useLocation();\n\n\t// Get device type from props or location state (can be undefined)\n\tconst initialDeviceType =\n\t\tprops.deviceType || (location.state as { deviceType?: DeviceConfigKey })?.deviceType;\n\n\t// State for selected device type (allows user to select if not provided)\n\tconst [selectedDeviceType, setSelectedDeviceType] = useState<DeviceConfigKey | undefined>(\n\t\tinitialDeviceType\n\t);\n\n\t// User token state for OAuth authentication (User Flow)\n\tconst [userToken, setUserToken] = useState<string | null>(() => {\n\t\t// Check if we already have a user token from previous OAuth flow\n\t\tconst savedCreds = CredentialsServiceV8.loadCredentials('user-login-v8', {\n\t\t\tflowKey: 'user-login-v8',\n\t\t\tflowType: 'oauth',\n\t\t\tincludeClientSecret: false,\n\t\t\tincludeRedirectUri: false,\n\t\t\tincludeLogoutUri: false,\n\t\t\tincludeScopes: false,\n\t\t});\n\t\treturn savedCreds?.accessToken || null;\n\t});\n\n\t// If no device type selected, show device type selection screen\n\tif (!selectedDeviceType) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<MFAHeaderV8\n\t\t\t\t\ttitle=\"MFA Unified Flow\"\n\t\t\t\t\tdescription=\"Register or authenticate MFA devices\"\n\t\t\t\t\tversionTag=\"V8\"\n\t\t\t\t\tcurrentPage=\"registration\"\n\t\t\t\t\tshowBackToMain={true}\n\t\t\t\t\theaderColor=\"pingRed\"\n\t\t\t\t/>\n\t\t\t\t<GlobalMFAProvider>\n\t\t\t\t\t<MFACredentialProvider>\n\t\t\t\t\t\t<DeviceTypeSelectionScreen\n\t\t\t\t\t\t\tonSelectDeviceType={setSelectedDeviceType}\n\t\t\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</MFACredentialProvider>\n\t\t\t\t</GlobalMFAProvider>\n\t\t\t\t{/* API display (bottom of page) */}\n\t\t\t\t<div style={{ marginTop: '24px' }}>\n\t\t\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\t\t\t\t</div>\n\t\t\t</>\n\t\t);\n\t}\n\n\treturn (\n\t\t<GlobalMFAProvider>\n\t\t\t<MFACredentialProvider>\n\t\t\t\t<UnifiedMFARegistrationFlowContent\n\t\t\t\t\t{...props}\n\t\t\t\t\tdeviceType={selectedDeviceType}\n\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t/>\n\t\t\t</MFACredentialProvider>\n\t\t</GlobalMFAProvider>\n\t);\n};\n\n// ============================================================================\n// CONTENT COMPONENT (MAIN LOGIC)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Content Component\n *\n * Contains the actual flow logic and integrates with:\n * - MFACredentialContext (global credential state)\n * - useWorkerToken hook (token status and auto-refresh)\n * - deviceFlowConfigs (device-specific configuration)\n * - MFAFlowBaseV8 (5-step framework)\n */\nconst UnifiedMFARegistrationFlowContent: React.FC<\n\tRequired<Pick<UnifiedMFARegistrationFlowV8Props, 'deviceType'>> &\n\t\tOmit<UnifiedMFARegistrationFlowV8Props, 'deviceType'> & {\n\t\t\tuserToken: string | null;\n\t\t\tsetUserToken: (token: string | null) => void;\n\t\t}\n> = ({ deviceType, onCancel, userToken, setUserToken }) => {\n\t// ========================================================================\n\t// CONFIGURATION\n\t// ========================================================================\n\n\t// React Router navigation\n\tconst navigate = useNavigate();\n\n\t// Load device-specific configuration\n\tconst config = useMemo(() => {\n\t\treturn getDeviceConfig(deviceType);\n\t}, [deviceType]);\n\n\t// ========================================================================\n\t// USER FLOW OAUTH STATE\n\t// ========================================================================\n\n\t// State for User Login Modal (OAuth authentication for User Flow)\n\tconst [showUserLoginModal, setShowUserLoginModal] = useState(false);\n\tconst [showUserTokenSuccess, setShowUserTokenSuccess] = useState(false);\n\tconst [userTokenForDisplay, setUserTokenForDisplay] = useState<string>('');\n\tconst [usernameFromToken, setUsernameFromToken] = useState<string>('');\n\tconst [showUsernameDropdown, setShowUsernameDropdown] = useState(false);\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\tconst envIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Pending registration data while waiting for OAuth (use ref to avoid stale closure)\n\tconst pendingRegistrationRef = useRef<{\n\t\tdeviceType: DeviceConfigKey;\n\t\tfields: Record<string, string>;\n\t\tflowType: string;\n\t\tprops: MFAFlowBaseRenderProps;\n\t} | null>(null);\n\n\t// Worker token state for validation in registration flow\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Detect OAuth callback and re-open modal if needed\n\tuseEffect(() => {\n\t\tconst urlParams = new URLSearchParams(window.location.search);\n\t\tconst code = urlParams.get('code');\n\t\tconst hasStoredState = sessionStorage.getItem('user_login_state_v8');\n\n\t\t// If we have OAuth callback params and stored state, re-open the modal to process callback\n\t\t// But only if we don't already have a user token (to prevent reopening after silent auth)\n\t\tif (code && hasStoredState && !showUserLoginModal && !userToken) {\n\t\t\tconsole.log('[UNIFIED-FLOW] OAuth callback detected - re-opening modal to process');\n\t\t\tsetShowUserLoginModal(true);\n\t\t}\n\t}, [showUserLoginModal, userToken]);\n\n\t// ========================================================================\n\t// STEP VALIDATION\n\t// ========================================================================\n\n\t/**\n\t * Validate Step 0 (Configuration)\n\t */\n\tconst validateStep0 = useCallback(\n\t\t(\n\t\t\tcredentials: MFACredentials,\n\t\t\ttoken: TokenStatusInfo,\n\t\t\tnavigation: ReturnType<typeof useStepNavigationV8>\n\t\t) => {\n\t\t\t// Always check for valid worker token (required for MFA device operations)\n\t\t\tif (!token.isValid) {\n\t\t\t\tnavigation.setValidationErrors(['Invalid or expired worker token']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Check required configuration\n\t\t\tif (!credentials.environmentId || !credentials.username) {\n\t\t\t\tnavigation.setValidationErrors(['Environment ID and Username are required']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\t\t[]\n\t);\n\n\t// ========================================================================\n\t// STEP RENDERERS\n\t// ========================================================================\n\n\t/**\n\t * Perform device registration API call (with token already available)\n\t */\n\tconst performRegistrationWithToken = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string,\n\t\t\ttoken?: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== PERFORM REGISTRATION WITH TOKEN =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Token:', token ? `Present (${token.length} chars)` : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setIsLoading available:', typeof props.setIsLoading);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setCredentials available:', typeof props.setCredentials);\n\n\t\t\ttry {\n\t\t\t\tprops.setIsLoading(true);\n\n\t\t\t\t// Update credentials with device fields and user token if provided\n\t\t\t\tprops.setCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tflowType, // Store flowType so activation step knows if OTP is required\n\t\t\t\t\t...fields,\n\t\t\t\t\t...(flowType === 'user' && token\n\t\t\t\t\t\t? { userToken: token, tokenType: 'user' }\n\t\t\t\t\t\t: flowType !== 'user'\n\t\t\t\t\t\t\t? { tokenType: 'worker' }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t}));\n\n\t\t\t\t// Register the device using proper API call\n\t\t\t\t// CRITICAL: Flow-specific device status\n\t\t\t\t// - Admin flow: ACTIVE (no OTP sent, device ready immediately)\n\t\t\t\t// - Admin ACTIVATION_REQUIRED: ACTIVATION_REQUIRED (sends OTP for admin to activate)\n\t\t\t\t// - User flow: ACTIVATION_REQUIRED (sends OTP for user to activate)\n\t\t\t\t// - FIDO2: ACTIVE (WebAuthn verification happens during registration)\n\t\t\t\tlet deviceStatus: 'ACTIVE' | 'ACTIVATION_REQUIRED' | undefined;\n\n\t\t\t\t// Determine device status based on flow type (applies to all device types including FIDO2)\n\t\t\t\tif (flowType === 'admin-active') {\n\t\t\t\t\tdeviceStatus = 'ACTIVE';\n\t\t\t\t} else if (flowType === 'admin-activation') {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED';\n\t\t\t\t} else {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED'; // user flow\n\t\t\t\t}\n\n\t\t\t\t// Special note for FIDO2: WebAuthn verification proves device works,\n\t\t\t\t// but we still respect the flow type for status determination\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t'[UNIFIED-FLOW] FIDO2 device - status determined by flow type:',\n\t\t\t\t\t\tdeviceStatus\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device status determined:', {\n\t\t\t\t\tflowType,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tdeviceStatus,\n\t\t\t\t\totpWillBeSent: deviceStatus === 'ACTIVATION_REQUIRED',\n\t\t\t\t\treason:\n\t\t\t\t\t\tselectedDeviceType === 'FIDO2'\n\t\t\t\t\t\t\t? 'FIDO2 - ACTIVE after WebAuthn verification'\n\t\t\t\t\t\t\t: 'User flow - OTP required for activation',\n\t\t\t\t});\n\n\t\t\t\t// Use same parameter construction as working MFA flows\n\t\t\t\ttype RegisterDeviceParamsWithToken = RegisterDeviceParams & {\n\t\t\t\t\ttokenType?: 'worker' | 'user';\n\t\t\t\t\tuserToken?: string | undefined;\n\t\t\t\t};\n\t\t\t\tlet baseParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\tenvironmentId: props.credentials.environmentId,\n\t\t\t\t\tusername: props.credentials.username,\n\t\t\t\t\ttype: selectedDeviceType,\n\t\t\t\t};\n\t\t\t\t// Per rightTOTP.md: Pass token type and user token if available\n\t\t\t\tif (flowType === 'user' && token) {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'user',\n\t\t\t\t\t\tuserToken: token,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'worker',\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Always include status for all device types\n\t\t\t\t// FIDO2: Set to ACTIVE since WebAuthn verification proves device works\n\t\t\t\t// Other devices: Set based on flow type (admin-active = ACTIVE, others = ACTIVATION_REQUIRED)\n\t\t\t\tif (deviceStatus !== undefined) {\n\t\t\t\t\tbaseParams.status = deviceStatus;\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registration base params:', {\n\t\t\t\t\tenvironmentId: baseParams.environmentId,\n\t\t\t\t\tusername: baseParams.username,\n\t\t\t\t\ttype: baseParams.type,\n\t\t\t\t\ttokenType: baseParams.tokenType,\n\t\t\t\t\tstatus: baseParams.status,\n\t\t\t\t\tflowType,\n\t\t\t\t});\n\n\t\t\t\t// Map form field names to API field names\n\t\t\t\t// Form uses 'deviceName' but API expects 'nickname' or 'name'\n\t\t\t\tconst mappedFields: Record<string, string> = { ...fields };\n\t\t\t\tif (mappedFields.deviceName) {\n\t\t\t\t\tmappedFields.nickname = mappedFields.deviceName;\n\t\t\t\t\tmappedFields.name = mappedFields.deviceName;\n\t\t\t\t\tdelete mappedFields.deviceName;\n\t\t\t\t}\n\n\t\t\t\t// Format phone number for SMS/WhatsApp devices\n\t\t\t\t// Form sends: { phoneNumber: '9725231586', countryCode: '+1' }\n\t\t\t\t// API expects: { phone: '+1.9725231586' }\n\t\t\t\tif (mappedFields.phoneNumber && mappedFields.countryCode) {\n\t\t\t\t\tconst countryCode = mappedFields.countryCode.replace('+', ''); // Remove + for formatting\n\t\t\t\t\tconst phoneNumber = mappedFields.phoneNumber.replace(/\\D/g, ''); // Remove non-digits\n\t\t\t\t\tmappedFields.phone = `+${countryCode}.${phoneNumber}`;\n\t\t\t\t\tconsole.log('[UNIFIED-FLOW] Formatted phone:', mappedFields.phone);\n\t\t\t\t\tdelete mappedFields.phoneNumber;\n\t\t\t\t\tdelete mappedFields.countryCode;\n\t\t\t\t}\n\n\t\t\t\t// Include device-specific fields (phone, email, etc.)\n\t\t\t\tconst deviceParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\t...baseParams,\n\t\t\t\t\t...mappedFields,\n\t\t\t\t\t// Include policy for TOTP devices (required for secret and keyUri to be returned)\n\t\t\t\t\t...(selectedDeviceType === 'TOTP' && selectedPolicyRef.current\n\t\t\t\t\t\t? { policy: selectedPolicyRef.current.id }\n\t\t\t\t\t\t: {}),\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registering device with params:', deviceParams);\n\n\t\t\t\tconst result = await MFAServiceV8_Legacy.registerDevice(deviceParams);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device registered:', result);\n\n\t\t\t\t// Update MFA state with device info\n\t\t\t\tconst registrationResult = result as unknown as Record<string, unknown>;\n\n\t\t\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result for TOTP:', {\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\tqrCode: registrationResult.qrCode,\n\t\t\t\t\t\tqrCodeUrl: registrationResult.qrCodeUrl,\n\t\t\t\t\t\tsecret: registrationResult.secret,\n\t\t\t\t\t\ttotpSecret: registrationResult.totpSecret,\n\t\t\t\t\t\tfullResult: result,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// ===============================================\n\n\t\t\t\t// Clear stored registration data after successful use\n\t\t\t\tlocalStorage.removeItem('mfa_registration_flow_type');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_fields');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_device_type');\n\n\t\t\t\tprops.setMfaState((prev) => {\n\t\t\t\t\t// TOTP: QR code will be rendered by QRCodeSVG component in UnifiedActivationStep\n\t\t\t\t\t// No need to generate QR code data URL here - just pass the keyUri\n\t\t\t\t\tconst newState: MFAState = {\n\t\t\t\t\t\t...prev,\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tdeviceStatus: result.status,\n\t\t\t\t\t\t...(registrationResult.deviceActivateUri\n\t\t\t\t\t\t\t? { deviceActivateUri: String(registrationResult.deviceActivateUri) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'TOTP'\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\ttotpSecret: String(registrationResult.secret || ''),\n\t\t\t\t\t\t\t\t\tkeyUri: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tqrCodeUrl: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tshowQr: !!(registrationResult.secret || registrationResult.keyUri),\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'FIDO2' &&\n\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tpublicKeyCredentialCreationOptions:\n\t\t\t\t\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions,\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'MOBILE' && registrationResult.pairingKey\n\t\t\t\t\t\t\t? { pairingKey: String(registrationResult.pairingKey) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t};\n\n\t\t\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\t\t\tfullState: newState,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t// ================================================\n\n\t\t\t\t\treturn newState;\n\t\t\t\t});\n\n\t\t\t\t// FIDO2: Check if we already have credential data (from WebAuthn modal)\n\t\t\t\t// If credentialId and publicKey are present, registration is complete\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tif (fields.credentialId && fields.publicKey) {\n\t\t\t\t\t\t// WebAuthn already completed via modal - device fully registered\n\n\t\t\t\t\t\t// Admin Flow: Show QR but skip OTP validation - device ready immediately\n\t\t\t\t\t\t// Admin ACTIVATION_REQUIRED & User Flow: Show QR and require OTP validation\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tflowType === 'admin-active' ||\n\t\t\t\t\t\t\tflowType === 'admin-activation' ||\n\t\t\t\t\t\t\tresult.status === 'ACTIVE'\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t'[UNIFIED-FLOW] Admin flow or ACTIVE status - proceeding to show QR without OTP requirement'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered successfully!${flowType === 'admin-active' || flowType === 'admin-activation' ? ' Device is ready to use.' : ''}`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t// For Admin Flow, go to API docs page instead of OTP page\n\t\t\t\t\t\t\t// For User Flow, go to User Login step (Step 1)\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (result.status === 'ACTIVATION_REQUIRED') {\n\t\t\t\t\t\t\t// Device requires activation - PingOne automatically sends OTP\n\t\t\t\t\t\t\t// This applies to both admin_activation_required and user flow\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered! OTP has been sent automatically.`\n\t\t\t\t\t\t\t);\n  // DO NOT auto-advance for OTP-required devices\n\t\t\t\t\t\t\t// User should manually click Next after receiving OTP\n\t\t\t\t\t\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation - waiting for user to proceed manually`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Unknown status, proceed with flow-specific navigation\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} // End of FIDO2 section\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Registration failed:', error);\n\t\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Device registration failed';\n\n\t\t\t\t// Check if error is due to too many devices\n\t\t\t\tif (errorMessage.includes('Too many devices')) {\n\t\t\t\t\ttoastV8.error(\n\t\t\t\t\t\t`${errorMessage}\\n\\n‚ÑπÔ∏è You can manage your devices at:\\nhttps://localhost:3000/v8/delete-all-devices`,\n\t\t\t\t\t\t{ duration: 8000 }\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\ttoastV8.error(errorMessage);\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tprops.setIsLoading(false);\n\t\t\t}\n\t\t},\n\t\t[config.displayName, toastV8]\n\t);\n\n\t/**\n\t * Handle user token received from OAuth flow\n\t */\n\tconst handleUserTokenReceived = useCallback(\n\t\t(token: string) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== USER TOKEN RECEIVED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Token length:', token.length);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current pending registration:', pendingRegistrationRef.current);\n\n\t\t\tsetUserToken(token);\n\t\t\tsetUserTokenForDisplay(token);\n\n\t\t\t// Decode JWT to extract username\n\t\t\ttry {\n\t\t\t\tconst base64Url = token.split('.')[1];\n\t\t\t\tconst base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n\t\t\t\tconst jsonPayload = decodeURIComponent(\n\t\t\t\t\tatob(base64)\n\t\t\t\t\t\t.split('')\n\t\t\t\t\t\t.map((c) => `%${`00${c.charCodeAt(0).toString(16)}`.slice(-2)}`)\n\t\t\t\t\t\t.join('')\n\t\t\t\t);\n\t\t\t\tconst payload = JSON.parse(jsonPayload);\n\t\t\t\tconst username =\n\t\t\t\t\tpayload.username || payload.preferred_username || payload.sub || 'Unknown User';\n\t\t\t\tsetUsernameFromToken(username);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Extracted username:', username);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Failed to decode JWT:', error);\n\t\t\t\tsetUsernameFromToken('Unknown User');\n\t\t\t}\n\n\t\t\t// If we have pending registration, show success page first\n\t\t\tconst pending = pendingRegistrationRef.current;\n\t\t\tif (pending) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Found pending registration, showing success page first...');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending data:', {\n\t\t\t\t\tdeviceType: pending.deviceType,\n\t\t\t\t\tflowType: pending.flowType,\n\t\t\t\t\thasProps: !!pending.props,\n\t\t\t\t\thasFields: !!pending.fields,\n\t\t\t\t});\n\n\t\t\t\ttoastV8.success('‚úÖ Authentication successful! Your user token is ready.', {\n\t\t\t\t\tduration: 4000,\n\t\t\t\t});\n\n\t\t\t\t// Close login modal and show success page\n\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\tsetShowUserTokenSuccess(true);\n\t\t\t} else {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] WARNING: No pending registration found after OAuth!');\n\t\t\t}\n\t\t},\n\t\t[setUserToken]\n\t);\n\n\t/**\n\t * Handle continue from user token success page\n\t */\n\tconst handleContinueAfterUserLogin = useCallback(() => {\n\t\tconsole.log(\n\t\t\t'[UNIFIED-FLOW] User clicked continue after login, proceeding with registration...'\n\t\t);\n\n\t\tconst pending = pendingRegistrationRef.current;\n\t\tif (pending && userToken) {\n\t\t\tconst { deviceType: pendingDeviceType, fields, flowType, props } = pending;\n\t\t\tpendingRegistrationRef.current = null;\n\n\t\t\t// Hide success page\n\t\t\tsetShowUserTokenSuccess(false);\n\n\t\t\t// Continue with registration\n\t\t\tsetTimeout(() => {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Now executing performRegistrationWithToken...');\n\t\t\t\tperformRegistrationWithToken(props, pendingDeviceType, fields, flowType, userToken);\n\t\t\t}, 100);\n\t\t}\n\t}, [userToken, performRegistrationWithToken]);\n\n\t/**\n\t * Perform device registration API call\n\t * Checks if User Flow needs OAuth first, otherwise proceeds with registration\n\t */\n\tconst performRegistration = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== DEVICE REGISTRATION SUBMITTED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current userToken:', userToken ? 'Present' : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\n\t\t\t// CRITICAL: Validate worker token before allowing any registration\n\t\t\tif (!workerToken.tokenStatus.isValid) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Cannot proceed - no valid worker token');\n\t\t\t\ttoastV8.error(\n\t\t\t\t\t'‚ùå Worker token required for device registration. Please configure worker token credentials first.',\n\t\t\t\t\t{\n\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// For User Flow, check if we need OAuth authentication first\n\t\t\tif (flowType === 'user' && !userToken) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] User flow selected but no token - showing OAuth modal');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Storing pending registration...');\n\n\t\t\t\t// Store pending registration data\n\t\t\t\tpendingRegistrationRef.current = {\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tfields,\n\t\t\t\t\tflowType,\n\t\t\t\t\tprops,\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending registration stored:', pendingRegistrationRef.current);\n\n\t\t\t\t// Set return target for device registration flow\n\t\t\t\tReturnTargetServiceV8U.setReturnTarget(\n\t\t\t\t\t'mfa_device_registration',\n\t\t\t\t\t'/v8/unified-mfa',  // Return to unified MFA flow\n\t\t\t\t\t2  // Step 2: Device Selection\n\t\t\t\t);\n\n\t\t\t\t// Show the user login modal\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'üîê User Flow requires PingOne authentication. Please complete the login to continue with device registration.',\n\t\t\t\t\t{ duration: 6000 }\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t'[UNIFIED-FLOW] Proceeding directly with registration (token exists or admin flow)'\n\t\t\t);\n\t\t\t// Proceed with registration (using existing token for user flow)\n\t\t\tawait performRegistrationWithToken(\n\t\t\t\tprops,\n\t\t\t\tselectedDeviceType,\n\t\t\t\tfields,\n\t\t\t\tflowType,\n\t\t\t\tuserToken || undefined\n\t\t\t);\n\t\t},\n\t\t[workerToken.tokenStatus.isValid, userToken]\n\t);\n\n\t/**\n\t * Render Step 0: Configuration (environment, user, policy)\n\t */\n\tconst renderStep0 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn (\n\t\t\t\t<UnifiedDeviceRegistrationForm\n\t\t\t\t\tinitialDeviceType={deviceType}\n\t\t\t\t\tonSubmit={async (selectedDeviceType, fields, flowType) => {\n\t\t\t\t\t\tawait performRegistration(props, selectedDeviceType, fields, flowType);\n\t\t\t\t\t}}\n\t\t\t\t\tonCancel={() => {\n\t\t\t\t\t\tif (onCancel) onCancel();\n\t\t\t\t\t}}\n\t\t\t\t\ttokenStatus={props.tokenStatus}\n\t\t\t\t\tusername={props.credentials.username}\n\t\t\t\t/>\n\t\t\t);\n\t\t},\n\t\t[deviceType, onCancel, performRegistration]\n\t);\n\n\t/**\n\t * Render Step 1: User Login using Authorization Code Flow with PKCE\n\t */\n\tconst renderStep1 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <UserLoginStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 2: Device Selection (option to call registration if want new device, or have no devices)\n\t */\n\tconst renderStep2 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 3: Device-Specific Actions (OTP/QR Generation, FIDO, Mobile Push)\n\t */\n\tconst renderStep3 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific based on the device type\n\t\t\t// For now, return the activation step which handles device-specific logic\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 4: OTP Validation / Confirmation\n\t */\n\tconst renderStep4 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific validation\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 5: API Documentation\n\t */\n\tconst renderStep5 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <APIDocsStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 6: Success screen with all user data and other valuable options\n\t */\n\tconst renderStep6 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <SuccessStepV8 renderProps={props} />;\n\t}, []);\n\n\t// Step labels for device authentication flow\n\tconst stepLabels = useMemo(() => {\n\t\tif (deviceType === 'FIDO2') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Start FIDO in Browser',\n\t\t\t\t'Passkey confirmation',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else if (deviceType === 'MOBILE') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Push to Mobile App',\n\t\t\t\t'User Confirms on Mobile',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else {\n\t\t\t// SMS, Email, TOTP, WhatsApp\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Generate OTP/QR',\n\t\t\t\t'Validate OTP',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t}\n\t}, [deviceType]);\n\n\tconst shouldHideNextButton = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\tif (props.nav.currentStep === 0) {\n\t\t\treturn true; // Hide Next button on configuration step, use form submit\n\t\t}\n\t\tif (props.nav.currentStep === 1) {\n\t\t\treturn true; // Hide Next button on user login step, use authentication button\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\treturn (\n\t\t<>\n\t\t\t<MFAFlowBaseV8\n\t\t\t\tdeviceType={deviceType}\n\t\t\t\trenderStep0={renderStep0}\n\t\t\t\trenderStep1={renderStep1}\n\t\t\t\trenderStep2={renderStep2}\n\t\t\t\trenderStep3={renderStep3}\n\t\t\t\trenderStep4={renderStep4}\n\t\t\t\trenderStep5={renderStep5}\n\t\t\t\trenderStep6={renderStep6}\n\t\t\t\tvalidateStep0={validateStep0}\n\t\t\t\tstepLabels={stepLabels}\n\t\t\t\tshouldHideNextButton={shouldHideNextButton}\n\t\t\t\tflowType=\"device-auth\"\n\t\t\t/>\n\t\t\t<div style={{ height: '300px' }} />\n\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\n\t\t\t{/* User Login Modal for User Flow OAuth */}\n\t\t\t<UserLoginModalV8\n\t\t\t\tisOpen={showUserLoginModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\t\tpendingRegistrationRef.current = null;\n\t\t\t\t}}\n\t\t\t\tonTokenReceived={handleUserTokenReceived}\n\t\t\t\tenvironmentId={envIdForModal}\n\t\t\t/>\n\n\t\t\t{/* User Token Success Page - Show token after OAuth login */}\n\t\t\t{showUserTokenSuccess && userTokenForDisplay && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 10000,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\t\t\tboxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Success Header */}\n\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\twidth: '64px',\n\t\t\t\t\t\t\t\t\theight: '64px',\n\t\t\t\t\t\t\t\t\tborderRadius: '50%',\n\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>‚úÖ</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<h2 style={{ margin: '0 0 8px 0', fontSize: '24px', color: '#1f2937' }}>\n\t\t\t\t\t\t\t\tAuthentication Successful!\n\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\tYour user token has been obtained and is ready to use.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Username Dropdown */}\n\t\t\t\t\t\t{usernameFromToken && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUsernameDropdown(!showUsernameDropdown)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tpadding: 0,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: showUsernameDropdown ? '12px' : 0,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '16px', color: '#374151' }}>Username</h3>\n\t\t\t\t\t\t\t\t\t{showUsernameDropdown ? (\n\t\t\t\t\t\t\t\t\t\t<FiChevronUp size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t<FiChevronDown size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{showUsernameDropdown && (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{usernameFromToken}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(usernameFromToken);\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('Username copied to clipboard!');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüìã Copy Username\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Token Display */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<h3 style={{ margin: '0 0 12px 0', fontSize: '16px', color: '#374151' }}>\n\t\t\t\t\t\t\t\tUser Access Token\n\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{userTokenForDisplay}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(userTokenForDisplay);\n\t\t\t\t\t\t\t\t\ttoastV8.success('Token copied to clipboard!');\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüìã Copy Token\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Next Steps Info */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#eff6ff',\n\t\t\t\t\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#1e40af', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t<strong>Next:</strong> Click \"Continue with Registration\" to proceed with your{' '}\n\t\t\t\t\t\t\t\t{config.displayName} device registration using this user token.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Continue Button */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleContinueAfterUserLogin}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\tbackground: '#10b981',\n\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tboxShadow: '0 2px 8px rgba(16, 185, 129, 0.3)',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tContinue with Registration ‚Üí\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</>\n\t);\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default UnifiedMFARegistrationFlowV8;\n"},"tags":["fixable"],"source":null},{"category":"lint/correctness/useExhaustiveDependencies","severity":"warning","description":"This hook does not specify its dependency on config.deviceType.","message":[{"elements":[],"content":"This hook "},{"elements":["Emphasis"],"content":"does not specify"},{"elements":[],"content":" its dependency on "},{"elements":["Emphasis"],"content":"config.deviceType"},{"elements":[],"content":"."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"This dependency is being used here, but is not specified in the hook dependency list."}]]},{"frame":{"path":null,"span":[74469,74486],"sourceCode":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\n * @description Unified MFA Registration Flow - Single component for all 6 device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Replace 6 device-specific flow components (SMS, Email, Mobile, WhatsApp, TOTP, FIDO2)\n * with a single configurable component using deviceFlowConfigs for device-specific behavior.\n *\n * Architecture:\n * - Configuration-driven using deviceFlowConfigs.ts\n * - Dynamic form rendering for simple devices (SMS, Email, WhatsApp)\n * - Custom components for complex devices (TOTP, FIDO2, Mobile)\n * - Integrates with MFACredentialContext and useWorkerToken hook\n * - Uses existing MFAFlowBaseV8 for 5-step framework\n *\n * @example\n * <UnifiedMFARegistrationFlowV8\n *   deviceType=\"SMS\"\n *   onSuccess={(result) => console.log('Device registered:', result.deviceId)}\n * />\n */\n\nimport * as React from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { FiChevronDown, FiChevronUp } from 'react-icons/fi';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { MFAHeaderV8 } from '@/v8/components/MFAHeaderV8';\nimport type { SearchableDropdownOption } from '@/v8/components/SearchableDropdownV8';\nimport { SearchableDropdownV8 } from '@/v8/components/SearchableDropdownV8';\nimport { SQLiteStatsDisplayV8 } from '@/v8/components/SQLiteStatsDisplayV8';\nimport { SuperSimpleApiDisplayV8 } from '@/v8/components/SuperSimpleApiDisplayV8';\nimport { UserLoginModalV8 } from '@/v8/components/UserLoginModalV8';\nimport { getDeviceConfig } from '@/v8/config/deviceFlowConfigs';\nimport type { DeviceConfigKey, DeviceRegistrationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport { PING_IDENTITY_COLORS } from '@/v8/constants/pingIdentityColors';\nimport { GlobalMFAProvider } from '@/v8/contexts/GlobalMFAContext';\nimport { MFACredentialProvider } from '@/v8/contexts/MFACredentialContext';\nimport { APIDocsStepV8 } from '@/v8/flows/shared/APIDocsStepV8';\nimport { SuccessStepV8 } from '@/v8/flows/shared/SuccessStepV8';\nimport { UserLoginStepV8 } from '@/v8/flows/shared/UserLoginStepV8';\nimport { useMFAPolicies } from '@/v8/hooks/useMFAPolicies';\nimport { useStepNavigationV8 } from '@/v8/hooks/useStepNavigationV8';\nimport { useUserSearch } from '@/v8/hooks/useUserSearch';\nimport { useWorkerToken } from '@/v8/hooks/useWorkerToken';\nimport { CredentialsServiceV8 } from '@/v8/services/credentialsServiceV8';\nimport { globalEnvironmentService } from '@/v8/services/globalEnvironmentService';\nimport { MfaAuthenticationServiceV8 } from '@/v8/services/mfaAuthenticationServiceV8';\nimport { type MFAFeatureFlag, MFAFeatureFlagsV8 } from '@/v8/services/mfaFeatureFlagsV8';\nimport MFAServiceV8_Legacy, { type RegisterDeviceParams } from '@/v8/services/mfaServiceV8_Legacy';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport type { TokenStatusInfo } from '@/v8/services/workerTokenStatusServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { ReturnTargetServiceV8U } from '@/v8u/services/returnTargetServiceV8U';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type MFAFlowBaseRenderProps, MFAFlowBaseV8 } from '../shared/MFAFlowBaseV8';\nimport type { DeviceAuthenticationPolicy, MFACredentials, MFAState } from '../shared/MFATypes';\nimport { UnifiedActivationStep } from './components/UnifiedActivationStep';\nimport { UnifiedDeviceRegistrationForm } from './components/UnifiedDeviceRegistrationForm';\nimport { UnifiedDeviceSelectionModal } from './components/UnifiedDeviceSelectionModal';\nimport { UnifiedSuccessStep } from './components/UnifiedSuccessStep';\nimport './UnifiedMFAFlow.css';\n\nconst MODULE_TAG = '[üîÑ UNIFIED-MFA-FLOW-V8]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedMFARegistrationFlowV8Props {\n\t/** Device type to render (optional - can be provided via navigation state) */\n\tdeviceType?: DeviceConfigKey;\n\n\t/** Optional initial credentials (for pre-filled forms) */\n\tinitialCredentials?: Partial<MFACredentials>;\n\n\t/** Optional callback when registration succeeds */\n\tonSuccess?: (result: DeviceRegistrationResult) => void;\n\n\t/** Optional callback when user cancels flow */\n\tonCancel?: () => void;\n\n\t/** Optional initial step (defaults to 0) */\n\tinitialStep?: number;\n\n\t/** Optional: Skip configuration step if already configured */\n\tskipConfiguration?: boolean;\n\n\t/** Optional: Force specific registration flow type */\n\tregistrationFlowType?: 'admin-active' | 'admin-activation' | 'user';\n}\n\n// ============================================================================\n// MFA FLOW SELECTION SCREEN\n// ============================================================================\n\ntype FlowMode = 'registration' | 'authentication';\n\n/** Map device types to their feature flags */\nconst DEVICE_FLAG_MAP: Record<DeviceConfigKey, MFAFeatureFlag> = {\n\tSMS: 'mfa_unified_sms',\n\tEMAIL: 'mfa_unified_email',\n\tMOBILE: 'mfa_unified_mobile',\n\tWHATSAPP: 'mfa_unified_whatsapp',\n\tTOTP: 'mfa_unified_totp',\n\tFIDO2: 'mfa_unified_fido2',\n};\n\nconst DEVICE_TYPES: { key: DeviceConfigKey; icon: string; name: string; description: string }[] = [\n\t{ key: 'SMS', icon: 'üì±', name: 'SMS', description: 'Receive OTP codes via text message' },\n\t{ key: 'EMAIL', icon: '‚úâÔ∏è', name: 'Email', description: 'Receive OTP codes via email' },\n\t{\n\t\tkey: 'TOTP',\n\t\ticon: 'üîê',\n\t\tname: 'Authenticator App (TOTP)',\n\t\tdescription: 'Use Google Authenticator, Authy, or similar',\n\t},\n\t{\n\t\tkey: 'MOBILE',\n\t\ticon: 'üì≤',\n\t\tname: 'Mobile Push',\n\t\tdescription: 'Receive push notifications on your phone',\n\t},\n\t{ key: 'WHATSAPP', icon: 'üí¨', name: 'WhatsApp', description: 'Receive OTP codes via WhatsApp' },\n\t{\n\t\tkey: 'FIDO2',\n\t\ticon: 'üîë',\n\t\tname: 'Security Key (FIDO2)',\n\t\tdescription: 'Use a hardware security key or passkey',\n\t},\n];\n\n/** Check if a device type is enabled via feature flags */\nconst isDeviceEnabled = (deviceKey: DeviceConfigKey): boolean => {\n\tconst flag = DEVICE_FLAG_MAP[deviceKey];\n\treturn MFAFeatureFlagsV8.isEnabled(flag);\n};\n\ninterface DeviceTypeSelectionScreenProps {\n\tonSelectDeviceType: (deviceType: DeviceConfigKey) => void;\n\tuserToken?: string | null;\n\tsetUserToken: (token: string | null) => void;\n}\n\nconst DeviceTypeSelectionScreen: React.FC<DeviceTypeSelectionScreenProps> = ({\n\tonSelectDeviceType,\n\tuserToken,\n\tsetUserToken,\n}) => {\n\tconst [flowMode, setFlowMode] = useState<FlowMode | null>(null);\n\tconst [environmentId, setEnvironmentId] = useState('');\n\tconst [username, setUsername] = useState('');\n\tconst [showDeviceSelectionModal, setShowDeviceSelectionModal] = useState(false);\n\tconst [showOTPModal, setShowOTPModal] = useState(false);\n\tconst [otpCode, setOtpCode] = useState('');\n\tconst [authenticationId, setAuthenticationId] = useState<string | null>(null);\n\tconst [selectedAuthDevice, setSelectedAuthDevice] = useState<{\n\t\tid: string;\n\t\ttype: string;\n\t\tnickname?: string;\n\t} | null>(null);\n\tconst [customLogoUrl, setCustomLogoUrl] = useState<string>('');\n\tconst [showAuthLoginModal, setShowAuthLoginModal] = useState(false);\n\tconst authEnvIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Load uploaded logo from localStorage on mount\n\tuseEffect(() => {\n\t\ttry {\n\t\t\tconst savedUpload = localStorage.getItem('custom-logo-upload');\n\t\t\tif (savedUpload) {\n\t\t\t\tconst uploadData = JSON.parse(savedUpload);\n\t\t\t\t// Handle both old format (objectUrl) and new format (base64Url)\n\t\t\t\tif (uploadData.base64Url) {\n\t\t\t\t\tsetCustomLogoUrl(uploadData.base64Url);\n\t\t\t\t} else if (uploadData.objectUrl) {\n\t\t\t\t\t// Old format - try to convert if possible, otherwise clear it\n\t\t\t\t\tconsole.warn('Old logo format detected - please re-upload your logo');\n\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load uploaded logo from localStorage:', error);\n\t\t\t// Clear corrupted data\n\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t}\n\t}, []);\n\n\t// Use worker token hook for token management\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Extract environment ID from worker token when available\n\tuseEffect(() => {\n\t\tconst extractEnvironmentId = async () => {\n\t\t\ttry {\n\t\t\t\tconst token = await workerTokenServiceV8.getToken();\n\t\t\t\tif (token && !environmentId) {\n\t\t\t\t\tconst parts = token.split('.');\n\t\t\t\t\tif (parts.length === 3) {\n\t\t\t\t\t\tconst payload = JSON.parse(atob(parts[1]));\n\t\t\t\t\t\tif (payload.environmentId) {\n\t\t\t\t\t\t\tsetEnvironmentId(payload.environmentId);\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`${MODULE_TAG} Environment ID extracted from worker token:`,\n\t\t\t\t\t\t\t\tpayload.environmentId\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Failed to extract environment ID from worker token:`, error);\n\t\t\t}\n\t\t};\n\n\t\textractEnvironmentId();\n\t}, [environmentId]);\n\n\tconst hasWorkerToken = workerToken.tokenStatus.isValid;\n\n\t// Use user search hook for user fetching and search\n\tconst {\n\t\tusers,\n\t\tisLoading: isLoadingUsers,\n\t\tsetSearchQuery,\n\t} = useUserSearch({\n\t\tenvironmentId,\n\t\ttokenValid: workerToken.tokenStatus.isValid,\n\t\tmaxPages: 100,\n\t\tuseCache: true,\n\t});\n\tconst tokenStatus = workerToken.tokenStatus;\n\n\t// Debug: Log users type to understand the issue\n\tuseEffect(() => {\n\t\tconsole.log(`${MODULE_TAG} users type check:`, {\n\t\t\tusers,\n\t\t\tisArray: Array.isArray(users),\n\t\t\ttype: typeof users,\n\t\t\tconstructor: users?.constructor?.name,\n\t\t});\n\t}, [users]);\n\n\t// Load Environment ID and username from global services on mount\n\tuseEffect(() => {\n\t\t// Initialize the service first to load from localStorage\n\t\tglobalEnvironmentService.initialize();\n\t\tconst savedEnvId = globalEnvironmentService.getEnvironmentId();\n\t\tif (savedEnvId) {\n\t\t\tsetEnvironmentId(savedEnvId);\n\t\t}\n\n\t\t// Load username from localStorage\n\t\tconst savedUsername = localStorage.getItem('mfa_unified_username');\n\t\tif (savedUsername) {\n\t\t\tsetUsername(savedUsername);\n\t\t}\n\t}, []);\n\n\t// Use MFA policies hook\n\tconst {\n\t\tpolicies,\n\t\tselectedPolicy,\n\t\tisLoading: isPoliciesLoading,\n\t\terror: policiesError,\n\t\tselectPolicy,\n\t\tdefaultPolicy,\n\t} = useMFAPolicies({\n\t\tenvironmentId,\n\t\ttokenIsValid: tokenStatus.isValid,\n\t\tautoLoad: true,\n\t\tautoSelectSingle: true,\n\t});\n\n\tconst selectedPolicyRef = useRef<DeviceAuthenticationPolicy | null>(null);\n\tuseEffect(() => {\n\t\tselectedPolicyRef.current = selectedPolicy ?? null;\n\t}, [selectedPolicy]);\n\n\tconst isPolicyDeviceEnabled = useCallback(\n\t\t(policy: DeviceAuthenticationPolicy | null, key: string) => {\n\t\t\tconst deviceConfig = policy?.[key] as { enabled?: boolean } | undefined;\n\t\t\treturn !!deviceConfig?.enabled;\n\t\t},\n\t\t[]\n\t);\n\n\tconst policyOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tpolicies.map((policy) => ({\n\t\t\t\tvalue: policy.id,\n\t\t\t\tlabel: policy.name,\n\t\t\t\t...(policy.default ? { secondaryLabel: '(Default)' } : {}),\n\t\t\t})),\n\t\t[policies]\n\t);\n\n\tconst userOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tArray.from(\n\t\t\t\tnew Map(\n\t\t\t\t\t(Array.isArray(users) ? users : []).map((user) => [\n\t\t\t\t\t\tuser.username,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvalue: user.username,\n\t\t\t\t\t\t\tlabel: user.username,\n\t\t\t\t\t\t\t...(user.email ? { secondaryLabel: user.email } : {}),\n\t\t\t\t\t\t} as SearchableDropdownOption,\n\t\t\t\t\t])\n\t\t\t\t).values()\n\t\t\t),\n\t\t[users]\n\t);\n\n\t// Auto-select default policy when policies load\n\tuseEffect(() => {\n\t\tif (defaultPolicy && !selectedPolicy) {\n\t\t\tselectPolicy(defaultPolicy.id);\n\t\t}\n\t}, [defaultPolicy, selectedPolicy, selectPolicy]);\n\n\t// Sync environment ID to global service and CredentialsServiceV8 when it changes\n\tuseEffect(() => {\n\t\tif (environmentId) {\n\t\t\tglobalEnvironmentService.setEnvironmentId(environmentId);\n\t\t\tlocalStorage.setItem('mfa_environmentId', environmentId);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tenvironmentId,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId, username: currentCreds.username }\n\t\t\t}));\n\t\t}\n\t}, [environmentId]);\n\n\t// Save username to localStorage and CredentialsServiceV8 when it changes\n\t// This ensures MFAFlowBase can read the username from its expected storage location\n\tuseEffect(() => {\n\t\tif (username) {\n\t\t\tlocalStorage.setItem('mfa_unified_username', username);\n\t\t\tlocalStorage.setItem('mfa_username', username);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tusername,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId: currentCreds.environmentId, username }\n\t\t\t}));\n\t\t}\n\t}, [username]);\n\n\t// Handle device selection for authentication\n\tconst handleDeviceSelectForAuthentication = async (device: {\n\t\tid: string;\n\t\ttype: string;\n\t\tdeviceName?: string;\n\t\tnickname?: string;\n\t}) => {\n\t\tconsole.log(`${MODULE_TAG} Selected device for authentication:`, device);\n\t\tsetShowDeviceSelectionModal(false);\n\t\tsetSelectedAuthDevice(device);\n\n\t\tconst policyId = selectedPolicy?.id;\n\t\tif (!policyId) {\n\t\t\ttoastV8.error('Please select an MFA Policy first');\n\t\t\treturn;\n\t\t}\n\n\t\t// Determine flow type and token\n\t\t// Admin flows should use worker tokens, not require user tokens\n\t\tconst flowType = userToken ? 'user' : 'admin';\n\t\tconst effectiveUserToken = flowType === 'user' ? userToken : undefined;\n\n\t\t// For admin flow, check if we have a valid worker token before proceeding\n\t\tif (flowType === 'admin' && !hasWorkerToken) {\n\t\t\ttoastV8.error('Admin flow requires a valid worker token. Please generate a worker token first.');\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\t// Initialize authentication with appropriate token\n\t\t\tconst response = await MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\tenvironmentId,\n\t\t\t\tusername: username.trim(),\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t\tdeviceId: device.id,\n\t\t\t\tregion: 'na',\n\t\t\t\ttokenType: flowType,\n\t\t\t\t...(effectiveUserToken && { userToken: effectiveUserToken }),\n\t\t\t});\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth initialized - full response:`, response);\n\t\t\tsetAuthenticationId(response.id);\n\n\t\t\tconst status = (response.status || '').toUpperCase();\n\t\t\tconst nextStep = (response.nextStep || '').toUpperCase();\n\t\t\tconst links = response._links as Record<string, { href?: string }> | undefined;\n\t\t\tconst hasOtpLink = !!(\n\t\t\t\tlinks &&\n\t\t\t\t(links.otp || links['otp.check'] || (links as Record<string, unknown>)['checkOtp'])\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth status:`, {\n\t\t\t\tstatus,\n\t\t\t\tnextStep,\n\t\t\t\thasOtpLink,\n\t\t\t\tdeviceType: device.type,\n\t\t\t});\n\n\t\t\t// Show appropriate UI based on response (normalize status/nextStep for PingOne variants)\n\t\t\tif (status === 'OTP_REQUIRED' || nextStep === 'OTP_REQUIRED' || hasOtpLink) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Opening OTP modal for device:`, device.type);\n\t\t\t\tsetShowOTPModal(true);\n\t\t\t\ttoastV8.success(`Verification code sent to your ${device.type} device`);\n\t\t\t} else if (status === 'ASSERTION_REQUIRED' || nextStep === 'ASSERTION_REQUIRED') {\n\t\t\t\tconsole.log(`${MODULE_TAG} FIDO2 assertion required`);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'FIDO2 authentication required. Please use /v8/mfa-config for FIDO2 authentication.'\n\t\t\t\t);\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'PUSH_CONFIRMATION_REQUIRED' ||\n\t\t\t\tnextStep === 'PUSH_CONFIRMATION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Push confirmation required`);\n\t\t\t\ttoastV8.success('Push notification sent! Please approve on your mobile device.');\n\t\t\t\ttoastV8.info('Complete authentication at /v8/mfa-config for push polling.');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (status === 'COMPLETED') {\n\t\t\t\ttoastV8.success('Authentication completed successfully!');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'DEVICE_SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'DEVICE_SELECTION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Device selection required - showing modal again`);\n\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t} else {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Unexpected authentication status:`, {\n\t\t\t\t\tstatus,\n\t\t\t\t\tnextStep,\n\t\t\t\t\tresponse,\n\t\t\t\t});\n\t\t\t\ttoastV8.info(`Authentication status: ${status || nextStep || 'UNKNOWN'}`);\n\t\t\t\t// Stay in authentication flow so user can try another device\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to initialize authentication:`, error);\n\n\t\t\t// Enhanced error handling for NO_USABLE_DEVICES\n\t\t\tlet errorMessage = 'Authentication failed: ';\n\t\t\tif (error instanceof Error) {\n\t\t\t\tconst errorStr = error.message.toLowerCase();\n\n\t\t\t\t// Check for NO_USABLE_DEVICES or device availability errors\n\t\t\t\tif (\n\t\t\t\t\terrorStr.includes('no usable devices') ||\n\t\t\t\t\terrorStr.includes('too many') ||\n\t\t\t\t\terrorStr.includes('cooldown') ||\n\t\t\t\t\terrorStr.includes('blocked')\n\t\t\t\t) {\n\t\t\t\t\terrorMessage = '‚ö†Ô∏è Device Temporarily Unavailable\\n\\n';\n\n\t\t\t\t\tif (errorStr.includes('cooldown') || errorStr.includes('too many')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Too many notifications have been sent to this device. It is temporarily in cooldown. ';\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Please wait a few minutes and try again, or select a different device.';\n\t\t\t\t\t} else if (errorStr.includes('blocked')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'This device has been blocked. Please contact your administrator or use a different device.';\n\t\t\t\t\t} else {\n\t\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terrorMessage += 'Unknown error';\n\t\t\t}\n\n\t\t\ttoastV8.error(errorMessage, { duration: 8000 });\n\t\t\t// Do NOT set flowMode(null) - keep user in authentication flow so they can retry or select another device\n\t\t}\n\t};\n\n\t// Handle OTP verification\n\tconst handleVerifyOTP = async () => {\n\t\tif (!authenticationId || !selectedAuthDevice) {\n\t\t\ttoastV8.error('Authentication session not found');\n\t\t\treturn;\n\t\t}\n\n\t\tif (otpCode.length !== 6) {\n\t\t\ttoastV8.error('Please enter a 6-digit code');\n\t\t\treturn;\n\t\t}\n\n\t\t// Get worker token for API call\n\t\tconst workerTokenForOTP = await workerTokenServiceV8.getToken();\n\n\t\tconsole.log(`${MODULE_TAG} OTP verification debug:`, {\n\t\t\tenvironmentId,\n\t\t\tusername: username.trim(),\n\t\t\tauthenticationId,\n\t\t\totpCode,\n\t\t\thasEnvironmentId: !!environmentId,\n\t\t\tenvIdLength: environmentId?.length,\n\t\t\thasWorkerToken: !!workerTokenForOTP,\n\t\t\tworkerTokenLength: workerTokenForOTP?.length,\n\t\t});\n\n\t\ttry {\n\t\t\t// Use backend proxy to avoid CORS issues\n\t\t\tconst response = await fetch('/api/pingone/mfa/validate-otp-for-device', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tenvironmentId,\n\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\tdeviceAuthId: authenticationId,\n\t\t\t\t\totp: otpCode,\n\t\t\t\t\tregion: 'na',\n\t\t\t\t\tworkerToken: workerTokenForOTP,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\n\t\t\t\tthrow new Error(errorData.error || errorData.message || `HTTP ${response.status}`);\n\t\t\t}\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.status === 'COMPLETED' || result.status === 'completed') {\n\t\t\t\ttoastV8.success('‚úÖ Authentication completed successfully!');\n\t\t\t\tsetShowOTPModal(false);\n\t\t\t\tsetFlowMode(null);\n\t\t\t\tsetOtpCode('');\n\t\t\t} else {\n\t\t\t\ttoastV8.error('Invalid code. Please try again.');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} OTP verification failed:`, error);\n\t\t\ttoastV8.error(\n\t\t\t\t`Verification failed: ${error instanceof Error ? error.message : 'Unknown error'}`\n\t\t\t);\n\t\t}\n\t};\n\n\t// Step 1: Choose Registration or Authentication\n\tif (!flowMode) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '12px' }}>\n\t\t\t\t\t{/* Header */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tboxShadow: '0 4px 12px rgba(239, 68, 68, 0.2)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h1\n\t\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîê MFA Unified Flow\n\t\t\t\t\t\t</h1>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tChoose what you want to do with MFA devices.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Configuration Section */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 12px 0',\n\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfiguration\n\t\t\t\t\t\t</h2>\n\n\t\t\t\t\t\t{/* Custom Logo URL */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-url\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[800],\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüé® Custom Logo URL (Optional)\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tDisplay a custom logo in the OTP verification modal\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t{/* URL Input */}\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tid=\"custom-logo-url\"\n\t\t\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\t\t\tvalue={customLogoUrl}\n\t\t\t\t\t\t\t\tonChange={(e) => setCustomLogoUrl(e.target.value)}\n\t\t\t\t\t\t\t\tplaceholder=\"https://example.com/logo.png\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\tpadding: '10px 14px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[900],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = `0 0 0 3px ${PING_IDENTITY_COLORS.primary[200]}`;\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.neutral[300];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* File Upload Section */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '13px', color: PING_IDENTITY_COLORS.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\tOR\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"file\"\n\t\t\t\t\t\t\t\t\tid=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\taccept=\"image/*\"\n\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\tconst file = e.target.files?.[0];\n\t\t\t\t\t\t\t\t\t\tif (!file) return;\n\n\t\t\t\t\t\t\t\t\t\t// Validate file type (images only)\n\t\t\t\t\t\t\t\t\t\tif (!file.type.startsWith('image/')) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Please select a logo file (JPG, PNG, etc.)');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Validate file size (max 5MB)\n\t\t\t\t\t\t\t\t\t\tif (file.size > 5 * 1024 * 1024) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('File size must be less than 5MB');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Convert file to base64 for persistence\n\t\t\t\t\t\t\t\t\t\tconst reader = new FileReader();\n\t\t\t\t\t\t\t\t\t\treader.onload = (event) => {\n\t\t\t\t\t\t\t\t\t\t\tconst base64Url = event.target?.result as string;\n\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl(base64Url);\n\n\t\t\t\t\t\t\t\t\t\t\t// Store base64 data for persistence\n\t\t\t\t\t\t\t\t\t\t\tconst uploadData = {\n\t\t\t\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\t\t\t\tbase64Url: base64Url,\n\t\t\t\t\t\t\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\t\t\t// Save to localStorage for persistence\n\t\t\t\t\t\t\t\t\t\t\tlocalStorage.setItem('custom-logo-upload', JSON.stringify(uploadData));\n\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.success(`Logo uploaded: ${file.name}`);\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.onerror = () => {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to read uploaded file');\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.readAsDataURL(file);\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'none' }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.primary[500],\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.primary[600]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '500',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[700];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìÅ Upload Logo File\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[500],\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tJPG, PNG, GIF (max 5MB)\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{customLogoUrl && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.neutral[50],\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tLogo Preview:\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\talt=\"Custom logo\"\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonError={() => {\n\t\t\t\t\t\t\t\t\t\t\t// Handle broken image URLs\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Failed to load custom logo URL');\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl('');\n\t\t\t\t\t\t\t\t\t\t\t\t// Clear uploaded file from localStorage\n\t\t\t\t\t\t\t\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.accent.pingRed[500],\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.accent.pingRed[600]}`,\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[600];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[500];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRemove Logo\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Environment ID - Hide when worker token is available */}\n\t\t\t\t\t\t{!hasWorkerToken && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"env-id\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tEnvironment ID\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"env-id\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setEnvironmentId(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* SQLite Database Stats */}\n\t\t\t\t\t\t{environmentId && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<SQLiteStatsDisplayV8\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tcompact={false}\n\t\t\t\t\t\t\t\t\trefreshInterval={30}\n\t\t\t\t\t\t\t\t\tshowRefreshButton={true}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Username */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUsername\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{environmentId && tokenStatus.isValid ? (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\toptions={userOptions}\n\t\t\t\t\t\t\t\t\tonChange={setUsername}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Type to search across 16,000+ users...\"\n\t\t\t\t\t\t\t\t\tisLoading={isLoadingUsers}\n\t\t\t\t\t\t\t\t\tonSearchChange={setSearchQuery}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setUsername(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* MFA Policy Dropdown */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"mfa-policy\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tMFA Policy\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{isPoliciesLoading ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tLoading policies...\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policiesError ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#ef4444', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tError loading policies: {policiesError}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policies.length === 0 ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tNo MFA policies found. Please check your environment ID and worker token.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"mfa-policy\"\n\t\t\t\t\t\t\t\t\tvalue={selectedPolicy?.id || ''}\n\t\t\t\t\t\t\t\t\toptions={policyOptions}\n\t\t\t\t\t\t\t\t\tonChange={selectPolicy}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Select an MFA policy...\"\n\t\t\t\t\t\t\t\t\tisLoading={isPoliciesLoading}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tSelect the MFA policy to use for device registration\n\t\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t\t{/* Policy Summary - Collapsible */}\n\t\t\t\t\t\t\t{selectedPolicy && (\n\t\t\t\t\t\t\t\t<details\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<summary\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\tuserSelect: 'none',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüìã Policy Details\n\t\t\t\t\t\t\t\t\t</summary>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '12px', fontSize: '13px', color: '#4b5563' }}>\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Policy Name:</strong> {String(selectedPolicy.name)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedPolicy.default && (\n\t\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px', color: '#059669' }}>\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>‚úì Default Policy</strong>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Enabled Devices:</strong>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '6px' }}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'sms') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì± SMS\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'email') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t‚úâÔ∏è Email\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'totp') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîê TOTP\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'fido2') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîë FIDO2\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'mobile') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì≤ Mobile\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'voice') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüìû Voice\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</details>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Worker Token Status */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t\tpaddingRight: '16px',\n\t\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={setEnvironmentId}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* User Token Status */}\n\t\t\t\t\t\t\t{userToken && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\t'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05))',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #10b981',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '20px' }}>üë§</span>\n\t\t\t\t\t\t\t\t\t\t<strong style={{ color: '#047857', fontSize: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t\tUser Token Active\n\t\t\t\t\t\t\t\t\t\t</strong>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: '14px', color: '#059669', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t\t‚úì User authentication token available\n\t\t\t\t\t\t\t\t\t\t<br />‚úì Ready for User Flow device registration\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Flow Mode Selection */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',\n\t\t\t\t\t\t\tgap: '16px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Registration Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => setFlowMode('registration')}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>‚ûï</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#047857',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Registration\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tRegister a new MFA device for a user. Create SMS, Email, TOTP, Mobile Push,\n\t\t\t\t\t\t\t\t\t\tWhatsApp, or FIDO2 devices.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t{/* Authentication Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tif (!userToken) {\n\t\t\t\t\t\t\t\t\tsetShowAuthLoginModal(true);\n\t\t\t\t\t\t\t\t\ttoastV8.info('üîê Please complete user login before device authentication.', {\n\t\t\t\t\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-4px)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 8px 24px rgba(59, 130, 246, 0.2)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>üîì</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#1d4ed8',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Authentication\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tAuthenticate using an existing MFA device. Verify user identity with OTP, push\n\t\t\t\t\t\t\t\t\t\tnotification, or security key.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{showAuthLoginModal && (\n\t\t\t\t\t<UserLoginModalV8\n\t\t\t\t\t\tisOpen={showAuthLoginModal}\n\t\t\t\t\t\tonClose={() => setShowAuthLoginModal(false)}\n\t\t\t\t\t\tonTokenReceived={(token) => {\n\t\t\t\t\t\t\tsetUserToken(token);\n\t\t\t\t\t\t\tsetShowAuthLoginModal(false);\n\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tenvironmentId={authEnvIdForModal}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</>\n\t\t);\n\t}\n\n\t// Authentication flow - dedicated view (device selection + OTP modals only; no registration grid)\n\tif (flowMode === 'authentication') {\n\t\treturn (\n\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\tsetSelectedAuthDevice(null);\n\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t‚Üê Back\n\t\t\t\t\t</button>\n\t\t\t\t\t<h1\n\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t>\n\t\t\t\t\t\tüîì Device Authentication\n\t\t\t\t\t</h1>\n\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\t{selectedAuthDevice && !showOTPModal\n\t\t\t\t\t\t\t? `Authenticating with ${selectedAuthDevice.type} ‚Äî enter the code when prompted.`\n\t\t\t\t\t\t\t: `Select an MFA device to authenticate for ${username || 'the user'}`}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t\t{!showDeviceSelectionModal && !showOTPModal && (\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowDeviceSelectionModal(true)}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tSelect MFA device\n\t\t\t\t\t</button>\n\t\t\t\t)}\n\t\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\t\tonClose={() => {\n\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t// Keep flowMode so user stays in auth flow; only clear if they click Back\n\t\t\t\t\t}}\n\t\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\t\tusername={username}\n\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t/>\n\t\t\t\t{showOTPModal && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.6)',\n\t\t\t\t\t\t\tbackdropFilter: 'blur(4px)',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t\t\tanimation: 'fadeIn 0.2s ease-out',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t{`\n\t\t\t\t\t\t\t@keyframes fadeIn {\n\t\t\t\t\t\t\t\tfrom { opacity: 0; }\n\t\t\t\t\t\t\t\tto { opacity: 1; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes slideUp {\n\t\t\t\t\t\t\t\tfrom { \n\t\t\t\t\t\t\t\t\topacity: 0;\n\t\t\t\t\t\t\t\t\ttransform: translateY(20px); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tto { \n\t\t\t\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t\t\t\t\ttransform: translateY(0); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes pulse {\n\t\t\t\t\t\t\t\t0%, 100% { opacity: 1; }\n\t\t\t\t\t\t\t\t50% { opacity: 0.5; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`}\n\t\t\t\t\t\t</style>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\tborderRadius: '24px',\n\t\t\t\t\t\t\t\tpadding: '48px 40px',\n\t\t\t\t\t\t\t\tmaxWidth: '480px',\n\t\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\t\tboxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',\n\t\t\t\t\t\t\t\tanimation: 'slideUp 0.3s ease-out',\n\t\t\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Logo Area */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '32px' }}>\n\t\t\t\t\t\t\t\t{customLogoUrl ? (\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\t\talt=\"Organization logo\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '120px',\n\t\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonError={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\t// Fallback to default icon if image fails to load\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.display = 'none';\n\t\t\t\t\t\t\t\t\t\t\t\tconst fallback = document.createElement('div');\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.style.cssText = `\n\t\t\t\t\t\t\t\t\t\t\t\twidth: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\theight: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: 0 auto 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: center;\n\t\t\t\t\t\t\t\t\t\t\t\tjustifyContent: center;\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: 36px;\n\t\t\t\t\t\t\t\t\t\t\t\tboxShadow: 0 10px 25px rgba(102, 126, 234, 0.3);\n\t\t\t\t\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.textContent = 'üîê';\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.parentElement!.appendChild(fallback);\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\theight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto 20px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '20px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '36px',\n\t\t\t\t\t\t\t\t\t\t\tboxShadow: '0 10px 25px rgba(102, 126, 234, 0.3)',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüîê\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tVerification Code\n\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\tEnter the 6-digit code sent to your <strong>{selectedAuthDevice?.type}</strong>{' '}\n\t\t\t\t\t\t\t\t\tdevice\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* OTP Input */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\t\t\tplaceholder=\"‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢\"\n\t\t\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tletterSpacing: '12px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow: otpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{otpCode.length > 0 && otpCode.length < 6 && (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\t\tanimation: 'pulse 2s ease-in-out infinite',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{6 - otpCode.length} more digit{6 - otpCode.length !== 1 ? 's' : ''} needed\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Resend Code Button */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={async () => {\n\t\t\t\t\t\t\t\t\t\tif (!selectedAuthDevice || !authenticationId) return;\n\t\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.info('Resending verification code...');\n\t\t\t\t\t\t\t\t\t\t\t// Re-initialize authentication to resend code\n\t\t\t\t\t\t\t\t\t\t\tconst response =\n\t\t\t\t\t\t\t\t\t\t\t\tawait MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\t\t\t\t\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\t\t\t\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicy?.id || '',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceId: selectedAuthDevice.id,\n\t\t\t\t\t\t\t\t\t\t\t\t\tregion: 'na',\n\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tif (response.status?.toUpperCase() === 'OTP_REQUIRED') {\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('New code sent to your device!');\n\t\t\t\t\t\t\t\t\t\t\t\tsetAuthenticationId(response.id);\n\t\t\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to resend code');\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Resend error:', error);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tcolor: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'transparent';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚Üª Resend Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Action Buttons */}\n\t\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#d1d5db';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f9fafb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'white';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6\n\t\t\t\t\t\t\t\t\t\t\t\t? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '#d1d5db',\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (otpCode.length === 6) {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚úì Verify Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Help Text */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<strong style={{ color: '#111827' }}>Didn't receive the code?</strong>\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\tCheck your spam folder or click \"Resend Code\" above\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t);\n\t}\n\n\t// Registration flow - show device type selection cards\n\treturn (\n\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t{/* Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #10b981 0%, #047857 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => setFlowMode(null)}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t‚Üê Back\n\t\t\t\t</button>\n\t\t\t\t<h1 style={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}>\n\t\t\t\t\t‚ûï Register MFA Device\n\t\t\t\t</h1>\n\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\tSelect a device type to register for {username || 'the user'}\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Device Type Cards */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',\n\t\t\t\t\tgap: '16px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t{DEVICE_TYPES.map((device) => {\n\t\t\t\t\tconst enabled = isDeviceEnabled(device.key);\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tkey={device.key}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => enabled && onSelectDeviceType(device.key)}\n\t\t\t\t\t\t\tdisabled={!enabled}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tbackground: enabled ? '#ffffff' : '#f9fafb',\n\t\t\t\t\t\t\t\tborder: `2px solid ${enabled ? '#e5e7eb' : '#f3f4f6'}`,\n\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\tcursor: enabled ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\topacity: enabled ? 1 : 0.5,\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#10b981';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ecfdf5';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>{device.icon}</span>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{device.name}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280' }}>{device.description}</p>\n\t\t\t\t\t\t\t{!enabled && (\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '12px', color: '#9ca3af' }}>\n\t\t\t\t\t\t\t\t\t(Not enabled)\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</div>\n\n\t\t\t{/* Device Selection Modal for Authentication */}\n\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t}}\n\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\tusername={username}\n\t\t\t\tenvironmentId={environmentId}\n\t\t\t/>\n\n\t\t\t{/* OTP Modal for Authentication */}\n\t\t\t{showOTPModal && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '400px',\n\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\tboxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '600' }}>\n\t\t\t\t\t\t\tEnter Verification Code\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '0 0 20px 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tCheck your {selectedAuthDevice?.type} device for the code\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\tplaceholder=\"000000\"\n\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 16px',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\tletterSpacing: '8px',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tmarginBottom: '20px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: otpCode.length === 6 ? '#3b82f6' : '#9ca3af',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tVerify\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Wrapper Component\n *\n * Wraps the content with MFACredentialProvider to provide global credential state\n */\nexport const UnifiedMFARegistrationFlowV8: React.FC<UnifiedMFARegistrationFlowV8Props> = (\n\tprops\n) => {\n\tconst location = useLocation();\n\n\t// Get device type from props or location state (can be undefined)\n\tconst initialDeviceType =\n\t\tprops.deviceType || (location.state as { deviceType?: DeviceConfigKey })?.deviceType;\n\n\t// State for selected device type (allows user to select if not provided)\n\tconst [selectedDeviceType, setSelectedDeviceType] = useState<DeviceConfigKey | undefined>(\n\t\tinitialDeviceType\n\t);\n\n\t// User token state for OAuth authentication (User Flow)\n\tconst [userToken, setUserToken] = useState<string | null>(() => {\n\t\t// Check if we already have a user token from previous OAuth flow\n\t\tconst savedCreds = CredentialsServiceV8.loadCredentials('user-login-v8', {\n\t\t\tflowKey: 'user-login-v8',\n\t\t\tflowType: 'oauth',\n\t\t\tincludeClientSecret: false,\n\t\t\tincludeRedirectUri: false,\n\t\t\tincludeLogoutUri: false,\n\t\t\tincludeScopes: false,\n\t\t});\n\t\treturn savedCreds?.accessToken || null;\n\t});\n\n\t// If no device type selected, show device type selection screen\n\tif (!selectedDeviceType) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<MFAHeaderV8\n\t\t\t\t\ttitle=\"MFA Unified Flow\"\n\t\t\t\t\tdescription=\"Register or authenticate MFA devices\"\n\t\t\t\t\tversionTag=\"V8\"\n\t\t\t\t\tcurrentPage=\"registration\"\n\t\t\t\t\tshowBackToMain={true}\n\t\t\t\t\theaderColor=\"pingRed\"\n\t\t\t\t/>\n\t\t\t\t<GlobalMFAProvider>\n\t\t\t\t\t<MFACredentialProvider>\n\t\t\t\t\t\t<DeviceTypeSelectionScreen\n\t\t\t\t\t\t\tonSelectDeviceType={setSelectedDeviceType}\n\t\t\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</MFACredentialProvider>\n\t\t\t\t</GlobalMFAProvider>\n\t\t\t\t{/* API display (bottom of page) */}\n\t\t\t\t<div style={{ marginTop: '24px' }}>\n\t\t\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\t\t\t\t</div>\n\t\t\t</>\n\t\t);\n\t}\n\n\treturn (\n\t\t<GlobalMFAProvider>\n\t\t\t<MFACredentialProvider>\n\t\t\t\t<UnifiedMFARegistrationFlowContent\n\t\t\t\t\t{...props}\n\t\t\t\t\tdeviceType={selectedDeviceType}\n\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t/>\n\t\t\t</MFACredentialProvider>\n\t\t</GlobalMFAProvider>\n\t);\n};\n\n// ============================================================================\n// CONTENT COMPONENT (MAIN LOGIC)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Content Component\n *\n * Contains the actual flow logic and integrates with:\n * - MFACredentialContext (global credential state)\n * - useWorkerToken hook (token status and auto-refresh)\n * - deviceFlowConfigs (device-specific configuration)\n * - MFAFlowBaseV8 (5-step framework)\n */\nconst UnifiedMFARegistrationFlowContent: React.FC<\n\tRequired<Pick<UnifiedMFARegistrationFlowV8Props, 'deviceType'>> &\n\t\tOmit<UnifiedMFARegistrationFlowV8Props, 'deviceType'> & {\n\t\t\tuserToken: string | null;\n\t\t\tsetUserToken: (token: string | null) => void;\n\t\t}\n> = ({ deviceType, onCancel, userToken, setUserToken }) => {\n\t// ========================================================================\n\t// CONFIGURATION\n\t// ========================================================================\n\n\t// React Router navigation\n\tconst navigate = useNavigate();\n\n\t// Load device-specific configuration\n\tconst config = useMemo(() => {\n\t\treturn getDeviceConfig(deviceType);\n\t}, [deviceType]);\n\n\t// ========================================================================\n\t// USER FLOW OAUTH STATE\n\t// ========================================================================\n\n\t// State for User Login Modal (OAuth authentication for User Flow)\n\tconst [showUserLoginModal, setShowUserLoginModal] = useState(false);\n\tconst [showUserTokenSuccess, setShowUserTokenSuccess] = useState(false);\n\tconst [userTokenForDisplay, setUserTokenForDisplay] = useState<string>('');\n\tconst [usernameFromToken, setUsernameFromToken] = useState<string>('');\n\tconst [showUsernameDropdown, setShowUsernameDropdown] = useState(false);\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\tconst envIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Pending registration data while waiting for OAuth (use ref to avoid stale closure)\n\tconst pendingRegistrationRef = useRef<{\n\t\tdeviceType: DeviceConfigKey;\n\t\tfields: Record<string, string>;\n\t\tflowType: string;\n\t\tprops: MFAFlowBaseRenderProps;\n\t} | null>(null);\n\n\t// Worker token state for validation in registration flow\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Detect OAuth callback and re-open modal if needed\n\tuseEffect(() => {\n\t\tconst urlParams = new URLSearchParams(window.location.search);\n\t\tconst code = urlParams.get('code');\n\t\tconst hasStoredState = sessionStorage.getItem('user_login_state_v8');\n\n\t\t// If we have OAuth callback params and stored state, re-open the modal to process callback\n\t\t// But only if we don't already have a user token (to prevent reopening after silent auth)\n\t\tif (code && hasStoredState && !showUserLoginModal && !userToken) {\n\t\t\tconsole.log('[UNIFIED-FLOW] OAuth callback detected - re-opening modal to process');\n\t\t\tsetShowUserLoginModal(true);\n\t\t}\n\t}, [showUserLoginModal, userToken]);\n\n\t// ========================================================================\n\t// STEP VALIDATION\n\t// ========================================================================\n\n\t/**\n\t * Validate Step 0 (Configuration)\n\t */\n\tconst validateStep0 = useCallback(\n\t\t(\n\t\t\tcredentials: MFACredentials,\n\t\t\ttoken: TokenStatusInfo,\n\t\t\tnavigation: ReturnType<typeof useStepNavigationV8>\n\t\t) => {\n\t\t\t// Always check for valid worker token (required for MFA device operations)\n\t\t\tif (!token.isValid) {\n\t\t\t\tnavigation.setValidationErrors(['Invalid or expired worker token']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Check required configuration\n\t\t\tif (!credentials.environmentId || !credentials.username) {\n\t\t\t\tnavigation.setValidationErrors(['Environment ID and Username are required']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\t\t[]\n\t);\n\n\t// ========================================================================\n\t// STEP RENDERERS\n\t// ========================================================================\n\n\t/**\n\t * Perform device registration API call (with token already available)\n\t */\n\tconst performRegistrationWithToken = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string,\n\t\t\ttoken?: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== PERFORM REGISTRATION WITH TOKEN =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Token:', token ? `Present (${token.length} chars)` : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setIsLoading available:', typeof props.setIsLoading);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setCredentials available:', typeof props.setCredentials);\n\n\t\t\ttry {\n\t\t\t\tprops.setIsLoading(true);\n\n\t\t\t\t// Update credentials with device fields and user token if provided\n\t\t\t\tprops.setCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tflowType, // Store flowType so activation step knows if OTP is required\n\t\t\t\t\t...fields,\n\t\t\t\t\t...(flowType === 'user' && token\n\t\t\t\t\t\t? { userToken: token, tokenType: 'user' }\n\t\t\t\t\t\t: flowType !== 'user'\n\t\t\t\t\t\t\t? { tokenType: 'worker' }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t}));\n\n\t\t\t\t// Register the device using proper API call\n\t\t\t\t// CRITICAL: Flow-specific device status\n\t\t\t\t// - Admin flow: ACTIVE (no OTP sent, device ready immediately)\n\t\t\t\t// - Admin ACTIVATION_REQUIRED: ACTIVATION_REQUIRED (sends OTP for admin to activate)\n\t\t\t\t// - User flow: ACTIVATION_REQUIRED (sends OTP for user to activate)\n\t\t\t\t// - FIDO2: ACTIVE (WebAuthn verification happens during registration)\n\t\t\t\tlet deviceStatus: 'ACTIVE' | 'ACTIVATION_REQUIRED' | undefined;\n\n\t\t\t\t// Determine device status based on flow type (applies to all device types including FIDO2)\n\t\t\t\tif (flowType === 'admin-active') {\n\t\t\t\t\tdeviceStatus = 'ACTIVE';\n\t\t\t\t} else if (flowType === 'admin-activation') {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED';\n\t\t\t\t} else {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED'; // user flow\n\t\t\t\t}\n\n\t\t\t\t// Special note for FIDO2: WebAuthn verification proves device works,\n\t\t\t\t// but we still respect the flow type for status determination\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t'[UNIFIED-FLOW] FIDO2 device - status determined by flow type:',\n\t\t\t\t\t\tdeviceStatus\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device status determined:', {\n\t\t\t\t\tflowType,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tdeviceStatus,\n\t\t\t\t\totpWillBeSent: deviceStatus === 'ACTIVATION_REQUIRED',\n\t\t\t\t\treason:\n\t\t\t\t\t\tselectedDeviceType === 'FIDO2'\n\t\t\t\t\t\t\t? 'FIDO2 - ACTIVE after WebAuthn verification'\n\t\t\t\t\t\t\t: 'User flow - OTP required for activation',\n\t\t\t\t});\n\n\t\t\t\t// Use same parameter construction as working MFA flows\n\t\t\t\ttype RegisterDeviceParamsWithToken = RegisterDeviceParams & {\n\t\t\t\t\ttokenType?: 'worker' | 'user';\n\t\t\t\t\tuserToken?: string | undefined;\n\t\t\t\t};\n\t\t\t\tlet baseParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\tenvironmentId: props.credentials.environmentId,\n\t\t\t\t\tusername: props.credentials.username,\n\t\t\t\t\ttype: selectedDeviceType,\n\t\t\t\t};\n\t\t\t\t// Per rightTOTP.md: Pass token type and user token if available\n\t\t\t\tif (flowType === 'user' && token) {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'user',\n\t\t\t\t\t\tuserToken: token,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'worker',\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Always include status for all device types\n\t\t\t\t// FIDO2: Set to ACTIVE since WebAuthn verification proves device works\n\t\t\t\t// Other devices: Set based on flow type (admin-active = ACTIVE, others = ACTIVATION_REQUIRED)\n\t\t\t\tif (deviceStatus !== undefined) {\n\t\t\t\t\tbaseParams.status = deviceStatus;\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registration base params:', {\n\t\t\t\t\tenvironmentId: baseParams.environmentId,\n\t\t\t\t\tusername: baseParams.username,\n\t\t\t\t\ttype: baseParams.type,\n\t\t\t\t\ttokenType: baseParams.tokenType,\n\t\t\t\t\tstatus: baseParams.status,\n\t\t\t\t\tflowType,\n\t\t\t\t});\n\n\t\t\t\t// Map form field names to API field names\n\t\t\t\t// Form uses 'deviceName' but API expects 'nickname' or 'name'\n\t\t\t\tconst mappedFields: Record<string, string> = { ...fields };\n\t\t\t\tif (mappedFields.deviceName) {\n\t\t\t\t\tmappedFields.nickname = mappedFields.deviceName;\n\t\t\t\t\tmappedFields.name = mappedFields.deviceName;\n\t\t\t\t\tdelete mappedFields.deviceName;\n\t\t\t\t}\n\n\t\t\t\t// Format phone number for SMS/WhatsApp devices\n\t\t\t\t// Form sends: { phoneNumber: '9725231586', countryCode: '+1' }\n\t\t\t\t// API expects: { phone: '+1.9725231586' }\n\t\t\t\tif (mappedFields.phoneNumber && mappedFields.countryCode) {\n\t\t\t\t\tconst countryCode = mappedFields.countryCode.replace('+', ''); // Remove + for formatting\n\t\t\t\t\tconst phoneNumber = mappedFields.phoneNumber.replace(/\\D/g, ''); // Remove non-digits\n\t\t\t\t\tmappedFields.phone = `+${countryCode}.${phoneNumber}`;\n\t\t\t\t\tconsole.log('[UNIFIED-FLOW] Formatted phone:', mappedFields.phone);\n\t\t\t\t\tdelete mappedFields.phoneNumber;\n\t\t\t\t\tdelete mappedFields.countryCode;\n\t\t\t\t}\n\n\t\t\t\t// Include device-specific fields (phone, email, etc.)\n\t\t\t\tconst deviceParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\t...baseParams,\n\t\t\t\t\t...mappedFields,\n\t\t\t\t\t// Include policy for TOTP devices (required for secret and keyUri to be returned)\n\t\t\t\t\t...(selectedDeviceType === 'TOTP' && selectedPolicyRef.current\n\t\t\t\t\t\t? { policy: selectedPolicyRef.current.id }\n\t\t\t\t\t\t: {}),\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registering device with params:', deviceParams);\n\n\t\t\t\tconst result = await MFAServiceV8_Legacy.registerDevice(deviceParams);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device registered:', result);\n\n\t\t\t\t// Update MFA state with device info\n\t\t\t\tconst registrationResult = result as unknown as Record<string, unknown>;\n\n\t\t\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result for TOTP:', {\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\tqrCode: registrationResult.qrCode,\n\t\t\t\t\t\tqrCodeUrl: registrationResult.qrCodeUrl,\n\t\t\t\t\t\tsecret: registrationResult.secret,\n\t\t\t\t\t\ttotpSecret: registrationResult.totpSecret,\n\t\t\t\t\t\tfullResult: result,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// ===============================================\n\n\t\t\t\t// Clear stored registration data after successful use\n\t\t\t\tlocalStorage.removeItem('mfa_registration_flow_type');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_fields');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_device_type');\n\n\t\t\t\tprops.setMfaState((prev) => {\n\t\t\t\t\t// TOTP: QR code will be rendered by QRCodeSVG component in UnifiedActivationStep\n\t\t\t\t\t// No need to generate QR code data URL here - just pass the keyUri\n\t\t\t\t\tconst newState: MFAState = {\n\t\t\t\t\t\t...prev,\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tdeviceStatus: result.status,\n\t\t\t\t\t\t...(registrationResult.deviceActivateUri\n\t\t\t\t\t\t\t? { deviceActivateUri: String(registrationResult.deviceActivateUri) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'TOTP'\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\ttotpSecret: String(registrationResult.secret || ''),\n\t\t\t\t\t\t\t\t\tkeyUri: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tqrCodeUrl: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tshowQr: !!(registrationResult.secret || registrationResult.keyUri),\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'FIDO2' &&\n\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tpublicKeyCredentialCreationOptions:\n\t\t\t\t\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions,\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'MOBILE' && registrationResult.pairingKey\n\t\t\t\t\t\t\t? { pairingKey: String(registrationResult.pairingKey) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t};\n\n\t\t\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\t\t\tfullState: newState,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t// ================================================\n\n\t\t\t\t\treturn newState;\n\t\t\t\t});\n\n\t\t\t\t// FIDO2: Check if we already have credential data (from WebAuthn modal)\n\t\t\t\t// If credentialId and publicKey are present, registration is complete\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tif (fields.credentialId && fields.publicKey) {\n\t\t\t\t\t\t// WebAuthn already completed via modal - device fully registered\n\n\t\t\t\t\t\t// Admin Flow: Show QR but skip OTP validation - device ready immediately\n\t\t\t\t\t\t// Admin ACTIVATION_REQUIRED & User Flow: Show QR and require OTP validation\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tflowType === 'admin-active' ||\n\t\t\t\t\t\t\tflowType === 'admin-activation' ||\n\t\t\t\t\t\t\tresult.status === 'ACTIVE'\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t'[UNIFIED-FLOW] Admin flow or ACTIVE status - proceeding to show QR without OTP requirement'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered successfully!${flowType === 'admin-active' || flowType === 'admin-activation' ? ' Device is ready to use.' : ''}`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t// For Admin Flow, go to API docs page instead of OTP page\n\t\t\t\t\t\t\t// For User Flow, go to User Login step (Step 1)\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (result.status === 'ACTIVATION_REQUIRED') {\n\t\t\t\t\t\t\t// Device requires activation - PingOne automatically sends OTP\n\t\t\t\t\t\t\t// This applies to both admin_activation_required and user flow\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered! OTP has been sent automatically.`\n\t\t\t\t\t\t\t);\n  // DO NOT auto-advance for OTP-required devices\n\t\t\t\t\t\t\t// User should manually click Next after receiving OTP\n\t\t\t\t\t\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation - waiting for user to proceed manually`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Unknown status, proceed with flow-specific navigation\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} // End of FIDO2 section\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Registration failed:', error);\n\t\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Device registration failed';\n\n\t\t\t\t// Check if error is due to too many devices\n\t\t\t\tif (errorMessage.includes('Too many devices')) {\n\t\t\t\t\ttoastV8.error(\n\t\t\t\t\t\t`${errorMessage}\\n\\n‚ÑπÔ∏è You can manage your devices at:\\nhttps://localhost:3000/v8/delete-all-devices`,\n\t\t\t\t\t\t{ duration: 8000 }\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\ttoastV8.error(errorMessage);\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tprops.setIsLoading(false);\n\t\t\t}\n\t\t},\n\t\t[config.displayName, toastV8]\n\t);\n\n\t/**\n\t * Handle user token received from OAuth flow\n\t */\n\tconst handleUserTokenReceived = useCallback(\n\t\t(token: string) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== USER TOKEN RECEIVED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Token length:', token.length);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current pending registration:', pendingRegistrationRef.current);\n\n\t\t\tsetUserToken(token);\n\t\t\tsetUserTokenForDisplay(token);\n\n\t\t\t// Decode JWT to extract username\n\t\t\ttry {\n\t\t\t\tconst base64Url = token.split('.')[1];\n\t\t\t\tconst base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n\t\t\t\tconst jsonPayload = decodeURIComponent(\n\t\t\t\t\tatob(base64)\n\t\t\t\t\t\t.split('')\n\t\t\t\t\t\t.map((c) => `%${`00${c.charCodeAt(0).toString(16)}`.slice(-2)}`)\n\t\t\t\t\t\t.join('')\n\t\t\t\t);\n\t\t\t\tconst payload = JSON.parse(jsonPayload);\n\t\t\t\tconst username =\n\t\t\t\t\tpayload.username || payload.preferred_username || payload.sub || 'Unknown User';\n\t\t\t\tsetUsernameFromToken(username);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Extracted username:', username);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Failed to decode JWT:', error);\n\t\t\t\tsetUsernameFromToken('Unknown User');\n\t\t\t}\n\n\t\t\t// If we have pending registration, show success page first\n\t\t\tconst pending = pendingRegistrationRef.current;\n\t\t\tif (pending) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Found pending registration, showing success page first...');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending data:', {\n\t\t\t\t\tdeviceType: pending.deviceType,\n\t\t\t\t\tflowType: pending.flowType,\n\t\t\t\t\thasProps: !!pending.props,\n\t\t\t\t\thasFields: !!pending.fields,\n\t\t\t\t});\n\n\t\t\t\ttoastV8.success('‚úÖ Authentication successful! Your user token is ready.', {\n\t\t\t\t\tduration: 4000,\n\t\t\t\t});\n\n\t\t\t\t// Close login modal and show success page\n\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\tsetShowUserTokenSuccess(true);\n\t\t\t} else {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] WARNING: No pending registration found after OAuth!');\n\t\t\t}\n\t\t},\n\t\t[setUserToken]\n\t);\n\n\t/**\n\t * Handle continue from user token success page\n\t */\n\tconst handleContinueAfterUserLogin = useCallback(() => {\n\t\tconsole.log(\n\t\t\t'[UNIFIED-FLOW] User clicked continue after login, proceeding with registration...'\n\t\t);\n\n\t\tconst pending = pendingRegistrationRef.current;\n\t\tif (pending && userToken) {\n\t\t\tconst { deviceType: pendingDeviceType, fields, flowType, props } = pending;\n\t\t\tpendingRegistrationRef.current = null;\n\n\t\t\t// Hide success page\n\t\t\tsetShowUserTokenSuccess(false);\n\n\t\t\t// Continue with registration\n\t\t\tsetTimeout(() => {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Now executing performRegistrationWithToken...');\n\t\t\t\tperformRegistrationWithToken(props, pendingDeviceType, fields, flowType, userToken);\n\t\t\t}, 100);\n\t\t}\n\t}, [userToken, performRegistrationWithToken]);\n\n\t/**\n\t * Perform device registration API call\n\t * Checks if User Flow needs OAuth first, otherwise proceeds with registration\n\t */\n\tconst performRegistration = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== DEVICE REGISTRATION SUBMITTED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current userToken:', userToken ? 'Present' : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\n\t\t\t// CRITICAL: Validate worker token before allowing any registration\n\t\t\tif (!workerToken.tokenStatus.isValid) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Cannot proceed - no valid worker token');\n\t\t\t\ttoastV8.error(\n\t\t\t\t\t'‚ùå Worker token required for device registration. Please configure worker token credentials first.',\n\t\t\t\t\t{\n\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// For User Flow, check if we need OAuth authentication first\n\t\t\tif (flowType === 'user' && !userToken) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] User flow selected but no token - showing OAuth modal');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Storing pending registration...');\n\n\t\t\t\t// Store pending registration data\n\t\t\t\tpendingRegistrationRef.current = {\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tfields,\n\t\t\t\t\tflowType,\n\t\t\t\t\tprops,\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending registration stored:', pendingRegistrationRef.current);\n\n\t\t\t\t// Set return target for device registration flow\n\t\t\t\tReturnTargetServiceV8U.setReturnTarget(\n\t\t\t\t\t'mfa_device_registration',\n\t\t\t\t\t'/v8/unified-mfa',  // Return to unified MFA flow\n\t\t\t\t\t2  // Step 2: Device Selection\n\t\t\t\t);\n\n\t\t\t\t// Show the user login modal\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'üîê User Flow requires PingOne authentication. Please complete the login to continue with device registration.',\n\t\t\t\t\t{ duration: 6000 }\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t'[UNIFIED-FLOW] Proceeding directly with registration (token exists or admin flow)'\n\t\t\t);\n\t\t\t// Proceed with registration (using existing token for user flow)\n\t\t\tawait performRegistrationWithToken(\n\t\t\t\tprops,\n\t\t\t\tselectedDeviceType,\n\t\t\t\tfields,\n\t\t\t\tflowType,\n\t\t\t\tuserToken || undefined\n\t\t\t);\n\t\t},\n\t\t[workerToken.tokenStatus.isValid, userToken]\n\t);\n\n\t/**\n\t * Render Step 0: Configuration (environment, user, policy)\n\t */\n\tconst renderStep0 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn (\n\t\t\t\t<UnifiedDeviceRegistrationForm\n\t\t\t\t\tinitialDeviceType={deviceType}\n\t\t\t\t\tonSubmit={async (selectedDeviceType, fields, flowType) => {\n\t\t\t\t\t\tawait performRegistration(props, selectedDeviceType, fields, flowType);\n\t\t\t\t\t}}\n\t\t\t\t\tonCancel={() => {\n\t\t\t\t\t\tif (onCancel) onCancel();\n\t\t\t\t\t}}\n\t\t\t\t\ttokenStatus={props.tokenStatus}\n\t\t\t\t\tusername={props.credentials.username}\n\t\t\t\t/>\n\t\t\t);\n\t\t},\n\t\t[deviceType, onCancel, performRegistration]\n\t);\n\n\t/**\n\t * Render Step 1: User Login using Authorization Code Flow with PKCE\n\t */\n\tconst renderStep1 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <UserLoginStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 2: Device Selection (option to call registration if want new device, or have no devices)\n\t */\n\tconst renderStep2 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 3: Device-Specific Actions (OTP/QR Generation, FIDO, Mobile Push)\n\t */\n\tconst renderStep3 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific based on the device type\n\t\t\t// For now, return the activation step which handles device-specific logic\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 4: OTP Validation / Confirmation\n\t */\n\tconst renderStep4 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific validation\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 5: API Documentation\n\t */\n\tconst renderStep5 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <APIDocsStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 6: Success screen with all user data and other valuable options\n\t */\n\tconst renderStep6 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <SuccessStepV8 renderProps={props} />;\n\t}, []);\n\n\t// Step labels for device authentication flow\n\tconst stepLabels = useMemo(() => {\n\t\tif (deviceType === 'FIDO2') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Start FIDO in Browser',\n\t\t\t\t'Passkey confirmation',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else if (deviceType === 'MOBILE') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Push to Mobile App',\n\t\t\t\t'User Confirms on Mobile',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else {\n\t\t\t// SMS, Email, TOTP, WhatsApp\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Generate OTP/QR',\n\t\t\t\t'Validate OTP',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t}\n\t}, [deviceType]);\n\n\tconst shouldHideNextButton = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\tif (props.nav.currentStep === 0) {\n\t\t\treturn true; // Hide Next button on configuration step, use form submit\n\t\t}\n\t\tif (props.nav.currentStep === 1) {\n\t\t\treturn true; // Hide Next button on user login step, use authentication button\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\treturn (\n\t\t<>\n\t\t\t<MFAFlowBaseV8\n\t\t\t\tdeviceType={deviceType}\n\t\t\t\trenderStep0={renderStep0}\n\t\t\t\trenderStep1={renderStep1}\n\t\t\t\trenderStep2={renderStep2}\n\t\t\t\trenderStep3={renderStep3}\n\t\t\t\trenderStep4={renderStep4}\n\t\t\t\trenderStep5={renderStep5}\n\t\t\t\trenderStep6={renderStep6}\n\t\t\t\tvalidateStep0={validateStep0}\n\t\t\t\tstepLabels={stepLabels}\n\t\t\t\tshouldHideNextButton={shouldHideNextButton}\n\t\t\t\tflowType=\"device-auth\"\n\t\t\t/>\n\t\t\t<div style={{ height: '300px' }} />\n\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\n\t\t\t{/* User Login Modal for User Flow OAuth */}\n\t\t\t<UserLoginModalV8\n\t\t\t\tisOpen={showUserLoginModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\t\tpendingRegistrationRef.current = null;\n\t\t\t\t}}\n\t\t\t\tonTokenReceived={handleUserTokenReceived}\n\t\t\t\tenvironmentId={envIdForModal}\n\t\t\t/>\n\n\t\t\t{/* User Token Success Page - Show token after OAuth login */}\n\t\t\t{showUserTokenSuccess && userTokenForDisplay && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 10000,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\t\t\tboxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Success Header */}\n\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\twidth: '64px',\n\t\t\t\t\t\t\t\t\theight: '64px',\n\t\t\t\t\t\t\t\t\tborderRadius: '50%',\n\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>‚úÖ</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<h2 style={{ margin: '0 0 8px 0', fontSize: '24px', color: '#1f2937' }}>\n\t\t\t\t\t\t\t\tAuthentication Successful!\n\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\tYour user token has been obtained and is ready to use.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Username Dropdown */}\n\t\t\t\t\t\t{usernameFromToken && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUsernameDropdown(!showUsernameDropdown)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tpadding: 0,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: showUsernameDropdown ? '12px' : 0,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '16px', color: '#374151' }}>Username</h3>\n\t\t\t\t\t\t\t\t\t{showUsernameDropdown ? (\n\t\t\t\t\t\t\t\t\t\t<FiChevronUp size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t<FiChevronDown size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{showUsernameDropdown && (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{usernameFromToken}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(usernameFromToken);\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('Username copied to clipboard!');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüìã Copy Username\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Token Display */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<h3 style={{ margin: '0 0 12px 0', fontSize: '16px', color: '#374151' }}>\n\t\t\t\t\t\t\t\tUser Access Token\n\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{userTokenForDisplay}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(userTokenForDisplay);\n\t\t\t\t\t\t\t\t\ttoastV8.success('Token copied to clipboard!');\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüìã Copy Token\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Next Steps Info */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#eff6ff',\n\t\t\t\t\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#1e40af', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t<strong>Next:</strong> Click \"Continue with Registration\" to proceed with your{' '}\n\t\t\t\t\t\t\t\t{config.displayName} device registration using this user token.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Continue Button */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleContinueAfterUserLogin}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\tbackground: '#10b981',\n\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tboxShadow: '0 2px 8px rgba(16, 185, 129, 0.3)',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tContinue with Registration ‚Üí\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</>\n\t);\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default UnifiedMFARegistrationFlowV8;\n"}},{"log":["info",[{"elements":[],"content":"This dependency is being used here, but is not specified in the hook dependency list."}]]},{"frame":{"path":null,"span":[73522,73539],"sourceCode":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\n * @description Unified MFA Registration Flow - Single component for all 6 device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Replace 6 device-specific flow components (SMS, Email, Mobile, WhatsApp, TOTP, FIDO2)\n * with a single configurable component using deviceFlowConfigs for device-specific behavior.\n *\n * Architecture:\n * - Configuration-driven using deviceFlowConfigs.ts\n * - Dynamic form rendering for simple devices (SMS, Email, WhatsApp)\n * - Custom components for complex devices (TOTP, FIDO2, Mobile)\n * - Integrates with MFACredentialContext and useWorkerToken hook\n * - Uses existing MFAFlowBaseV8 for 5-step framework\n *\n * @example\n * <UnifiedMFARegistrationFlowV8\n *   deviceType=\"SMS\"\n *   onSuccess={(result) => console.log('Device registered:', result.deviceId)}\n * />\n */\n\nimport * as React from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { FiChevronDown, FiChevronUp } from 'react-icons/fi';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { MFAHeaderV8 } from '@/v8/components/MFAHeaderV8';\nimport type { SearchableDropdownOption } from '@/v8/components/SearchableDropdownV8';\nimport { SearchableDropdownV8 } from '@/v8/components/SearchableDropdownV8';\nimport { SQLiteStatsDisplayV8 } from '@/v8/components/SQLiteStatsDisplayV8';\nimport { SuperSimpleApiDisplayV8 } from '@/v8/components/SuperSimpleApiDisplayV8';\nimport { UserLoginModalV8 } from '@/v8/components/UserLoginModalV8';\nimport { getDeviceConfig } from '@/v8/config/deviceFlowConfigs';\nimport type { DeviceConfigKey, DeviceRegistrationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport { PING_IDENTITY_COLORS } from '@/v8/constants/pingIdentityColors';\nimport { GlobalMFAProvider } from '@/v8/contexts/GlobalMFAContext';\nimport { MFACredentialProvider } from '@/v8/contexts/MFACredentialContext';\nimport { APIDocsStepV8 } from '@/v8/flows/shared/APIDocsStepV8';\nimport { SuccessStepV8 } from '@/v8/flows/shared/SuccessStepV8';\nimport { UserLoginStepV8 } from '@/v8/flows/shared/UserLoginStepV8';\nimport { useMFAPolicies } from '@/v8/hooks/useMFAPolicies';\nimport { useStepNavigationV8 } from '@/v8/hooks/useStepNavigationV8';\nimport { useUserSearch } from '@/v8/hooks/useUserSearch';\nimport { useWorkerToken } from '@/v8/hooks/useWorkerToken';\nimport { CredentialsServiceV8 } from '@/v8/services/credentialsServiceV8';\nimport { globalEnvironmentService } from '@/v8/services/globalEnvironmentService';\nimport { MfaAuthenticationServiceV8 } from '@/v8/services/mfaAuthenticationServiceV8';\nimport { type MFAFeatureFlag, MFAFeatureFlagsV8 } from '@/v8/services/mfaFeatureFlagsV8';\nimport MFAServiceV8_Legacy, { type RegisterDeviceParams } from '@/v8/services/mfaServiceV8_Legacy';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport type { TokenStatusInfo } from '@/v8/services/workerTokenStatusServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { ReturnTargetServiceV8U } from '@/v8u/services/returnTargetServiceV8U';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type MFAFlowBaseRenderProps, MFAFlowBaseV8 } from '../shared/MFAFlowBaseV8';\nimport type { DeviceAuthenticationPolicy, MFACredentials, MFAState } from '../shared/MFATypes';\nimport { UnifiedActivationStep } from './components/UnifiedActivationStep';\nimport { UnifiedDeviceRegistrationForm } from './components/UnifiedDeviceRegistrationForm';\nimport { UnifiedDeviceSelectionModal } from './components/UnifiedDeviceSelectionModal';\nimport { UnifiedSuccessStep } from './components/UnifiedSuccessStep';\nimport './UnifiedMFAFlow.css';\n\nconst MODULE_TAG = '[üîÑ UNIFIED-MFA-FLOW-V8]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedMFARegistrationFlowV8Props {\n\t/** Device type to render (optional - can be provided via navigation state) */\n\tdeviceType?: DeviceConfigKey;\n\n\t/** Optional initial credentials (for pre-filled forms) */\n\tinitialCredentials?: Partial<MFACredentials>;\n\n\t/** Optional callback when registration succeeds */\n\tonSuccess?: (result: DeviceRegistrationResult) => void;\n\n\t/** Optional callback when user cancels flow */\n\tonCancel?: () => void;\n\n\t/** Optional initial step (defaults to 0) */\n\tinitialStep?: number;\n\n\t/** Optional: Skip configuration step if already configured */\n\tskipConfiguration?: boolean;\n\n\t/** Optional: Force specific registration flow type */\n\tregistrationFlowType?: 'admin-active' | 'admin-activation' | 'user';\n}\n\n// ============================================================================\n// MFA FLOW SELECTION SCREEN\n// ============================================================================\n\ntype FlowMode = 'registration' | 'authentication';\n\n/** Map device types to their feature flags */\nconst DEVICE_FLAG_MAP: Record<DeviceConfigKey, MFAFeatureFlag> = {\n\tSMS: 'mfa_unified_sms',\n\tEMAIL: 'mfa_unified_email',\n\tMOBILE: 'mfa_unified_mobile',\n\tWHATSAPP: 'mfa_unified_whatsapp',\n\tTOTP: 'mfa_unified_totp',\n\tFIDO2: 'mfa_unified_fido2',\n};\n\nconst DEVICE_TYPES: { key: DeviceConfigKey; icon: string; name: string; description: string }[] = [\n\t{ key: 'SMS', icon: 'üì±', name: 'SMS', description: 'Receive OTP codes via text message' },\n\t{ key: 'EMAIL', icon: '‚úâÔ∏è', name: 'Email', description: 'Receive OTP codes via email' },\n\t{\n\t\tkey: 'TOTP',\n\t\ticon: 'üîê',\n\t\tname: 'Authenticator App (TOTP)',\n\t\tdescription: 'Use Google Authenticator, Authy, or similar',\n\t},\n\t{\n\t\tkey: 'MOBILE',\n\t\ticon: 'üì≤',\n\t\tname: 'Mobile Push',\n\t\tdescription: 'Receive push notifications on your phone',\n\t},\n\t{ key: 'WHATSAPP', icon: 'üí¨', name: 'WhatsApp', description: 'Receive OTP codes via WhatsApp' },\n\t{\n\t\tkey: 'FIDO2',\n\t\ticon: 'üîë',\n\t\tname: 'Security Key (FIDO2)',\n\t\tdescription: 'Use a hardware security key or passkey',\n\t},\n];\n\n/** Check if a device type is enabled via feature flags */\nconst isDeviceEnabled = (deviceKey: DeviceConfigKey): boolean => {\n\tconst flag = DEVICE_FLAG_MAP[deviceKey];\n\treturn MFAFeatureFlagsV8.isEnabled(flag);\n};\n\ninterface DeviceTypeSelectionScreenProps {\n\tonSelectDeviceType: (deviceType: DeviceConfigKey) => void;\n\tuserToken?: string | null;\n\tsetUserToken: (token: string | null) => void;\n}\n\nconst DeviceTypeSelectionScreen: React.FC<DeviceTypeSelectionScreenProps> = ({\n\tonSelectDeviceType,\n\tuserToken,\n\tsetUserToken,\n}) => {\n\tconst [flowMode, setFlowMode] = useState<FlowMode | null>(null);\n\tconst [environmentId, setEnvironmentId] = useState('');\n\tconst [username, setUsername] = useState('');\n\tconst [showDeviceSelectionModal, setShowDeviceSelectionModal] = useState(false);\n\tconst [showOTPModal, setShowOTPModal] = useState(false);\n\tconst [otpCode, setOtpCode] = useState('');\n\tconst [authenticationId, setAuthenticationId] = useState<string | null>(null);\n\tconst [selectedAuthDevice, setSelectedAuthDevice] = useState<{\n\t\tid: string;\n\t\ttype: string;\n\t\tnickname?: string;\n\t} | null>(null);\n\tconst [customLogoUrl, setCustomLogoUrl] = useState<string>('');\n\tconst [showAuthLoginModal, setShowAuthLoginModal] = useState(false);\n\tconst authEnvIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Load uploaded logo from localStorage on mount\n\tuseEffect(() => {\n\t\ttry {\n\t\t\tconst savedUpload = localStorage.getItem('custom-logo-upload');\n\t\t\tif (savedUpload) {\n\t\t\t\tconst uploadData = JSON.parse(savedUpload);\n\t\t\t\t// Handle both old format (objectUrl) and new format (base64Url)\n\t\t\t\tif (uploadData.base64Url) {\n\t\t\t\t\tsetCustomLogoUrl(uploadData.base64Url);\n\t\t\t\t} else if (uploadData.objectUrl) {\n\t\t\t\t\t// Old format - try to convert if possible, otherwise clear it\n\t\t\t\t\tconsole.warn('Old logo format detected - please re-upload your logo');\n\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load uploaded logo from localStorage:', error);\n\t\t\t// Clear corrupted data\n\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t}\n\t}, []);\n\n\t// Use worker token hook for token management\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Extract environment ID from worker token when available\n\tuseEffect(() => {\n\t\tconst extractEnvironmentId = async () => {\n\t\t\ttry {\n\t\t\t\tconst token = await workerTokenServiceV8.getToken();\n\t\t\t\tif (token && !environmentId) {\n\t\t\t\t\tconst parts = token.split('.');\n\t\t\t\t\tif (parts.length === 3) {\n\t\t\t\t\t\tconst payload = JSON.parse(atob(parts[1]));\n\t\t\t\t\t\tif (payload.environmentId) {\n\t\t\t\t\t\t\tsetEnvironmentId(payload.environmentId);\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`${MODULE_TAG} Environment ID extracted from worker token:`,\n\t\t\t\t\t\t\t\tpayload.environmentId\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Failed to extract environment ID from worker token:`, error);\n\t\t\t}\n\t\t};\n\n\t\textractEnvironmentId();\n\t}, [environmentId]);\n\n\tconst hasWorkerToken = workerToken.tokenStatus.isValid;\n\n\t// Use user search hook for user fetching and search\n\tconst {\n\t\tusers,\n\t\tisLoading: isLoadingUsers,\n\t\tsetSearchQuery,\n\t} = useUserSearch({\n\t\tenvironmentId,\n\t\ttokenValid: workerToken.tokenStatus.isValid,\n\t\tmaxPages: 100,\n\t\tuseCache: true,\n\t});\n\tconst tokenStatus = workerToken.tokenStatus;\n\n\t// Debug: Log users type to understand the issue\n\tuseEffect(() => {\n\t\tconsole.log(`${MODULE_TAG} users type check:`, {\n\t\t\tusers,\n\t\t\tisArray: Array.isArray(users),\n\t\t\ttype: typeof users,\n\t\t\tconstructor: users?.constructor?.name,\n\t\t});\n\t}, [users]);\n\n\t// Load Environment ID and username from global services on mount\n\tuseEffect(() => {\n\t\t// Initialize the service first to load from localStorage\n\t\tglobalEnvironmentService.initialize();\n\t\tconst savedEnvId = globalEnvironmentService.getEnvironmentId();\n\t\tif (savedEnvId) {\n\t\t\tsetEnvironmentId(savedEnvId);\n\t\t}\n\n\t\t// Load username from localStorage\n\t\tconst savedUsername = localStorage.getItem('mfa_unified_username');\n\t\tif (savedUsername) {\n\t\t\tsetUsername(savedUsername);\n\t\t}\n\t}, []);\n\n\t// Use MFA policies hook\n\tconst {\n\t\tpolicies,\n\t\tselectedPolicy,\n\t\tisLoading: isPoliciesLoading,\n\t\terror: policiesError,\n\t\tselectPolicy,\n\t\tdefaultPolicy,\n\t} = useMFAPolicies({\n\t\tenvironmentId,\n\t\ttokenIsValid: tokenStatus.isValid,\n\t\tautoLoad: true,\n\t\tautoSelectSingle: true,\n\t});\n\n\tconst selectedPolicyRef = useRef<DeviceAuthenticationPolicy | null>(null);\n\tuseEffect(() => {\n\t\tselectedPolicyRef.current = selectedPolicy ?? null;\n\t}, [selectedPolicy]);\n\n\tconst isPolicyDeviceEnabled = useCallback(\n\t\t(policy: DeviceAuthenticationPolicy | null, key: string) => {\n\t\t\tconst deviceConfig = policy?.[key] as { enabled?: boolean } | undefined;\n\t\t\treturn !!deviceConfig?.enabled;\n\t\t},\n\t\t[]\n\t);\n\n\tconst policyOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tpolicies.map((policy) => ({\n\t\t\t\tvalue: policy.id,\n\t\t\t\tlabel: policy.name,\n\t\t\t\t...(policy.default ? { secondaryLabel: '(Default)' } : {}),\n\t\t\t})),\n\t\t[policies]\n\t);\n\n\tconst userOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tArray.from(\n\t\t\t\tnew Map(\n\t\t\t\t\t(Array.isArray(users) ? users : []).map((user) => [\n\t\t\t\t\t\tuser.username,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvalue: user.username,\n\t\t\t\t\t\t\tlabel: user.username,\n\t\t\t\t\t\t\t...(user.email ? { secondaryLabel: user.email } : {}),\n\t\t\t\t\t\t} as SearchableDropdownOption,\n\t\t\t\t\t])\n\t\t\t\t).values()\n\t\t\t),\n\t\t[users]\n\t);\n\n\t// Auto-select default policy when policies load\n\tuseEffect(() => {\n\t\tif (defaultPolicy && !selectedPolicy) {\n\t\t\tselectPolicy(defaultPolicy.id);\n\t\t}\n\t}, [defaultPolicy, selectedPolicy, selectPolicy]);\n\n\t// Sync environment ID to global service and CredentialsServiceV8 when it changes\n\tuseEffect(() => {\n\t\tif (environmentId) {\n\t\t\tglobalEnvironmentService.setEnvironmentId(environmentId);\n\t\t\tlocalStorage.setItem('mfa_environmentId', environmentId);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tenvironmentId,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId, username: currentCreds.username }\n\t\t\t}));\n\t\t}\n\t}, [environmentId]);\n\n\t// Save username to localStorage and CredentialsServiceV8 when it changes\n\t// This ensures MFAFlowBase can read the username from its expected storage location\n\tuseEffect(() => {\n\t\tif (username) {\n\t\t\tlocalStorage.setItem('mfa_unified_username', username);\n\t\t\tlocalStorage.setItem('mfa_username', username);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tusername,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId: currentCreds.environmentId, username }\n\t\t\t}));\n\t\t}\n\t}, [username]);\n\n\t// Handle device selection for authentication\n\tconst handleDeviceSelectForAuthentication = async (device: {\n\t\tid: string;\n\t\ttype: string;\n\t\tdeviceName?: string;\n\t\tnickname?: string;\n\t}) => {\n\t\tconsole.log(`${MODULE_TAG} Selected device for authentication:`, device);\n\t\tsetShowDeviceSelectionModal(false);\n\t\tsetSelectedAuthDevice(device);\n\n\t\tconst policyId = selectedPolicy?.id;\n\t\tif (!policyId) {\n\t\t\ttoastV8.error('Please select an MFA Policy first');\n\t\t\treturn;\n\t\t}\n\n\t\t// Determine flow type and token\n\t\t// Admin flows should use worker tokens, not require user tokens\n\t\tconst flowType = userToken ? 'user' : 'admin';\n\t\tconst effectiveUserToken = flowType === 'user' ? userToken : undefined;\n\n\t\t// For admin flow, check if we have a valid worker token before proceeding\n\t\tif (flowType === 'admin' && !hasWorkerToken) {\n\t\t\ttoastV8.error('Admin flow requires a valid worker token. Please generate a worker token first.');\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\t// Initialize authentication with appropriate token\n\t\t\tconst response = await MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\tenvironmentId,\n\t\t\t\tusername: username.trim(),\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t\tdeviceId: device.id,\n\t\t\t\tregion: 'na',\n\t\t\t\ttokenType: flowType,\n\t\t\t\t...(effectiveUserToken && { userToken: effectiveUserToken }),\n\t\t\t});\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth initialized - full response:`, response);\n\t\t\tsetAuthenticationId(response.id);\n\n\t\t\tconst status = (response.status || '').toUpperCase();\n\t\t\tconst nextStep = (response.nextStep || '').toUpperCase();\n\t\t\tconst links = response._links as Record<string, { href?: string }> | undefined;\n\t\t\tconst hasOtpLink = !!(\n\t\t\t\tlinks &&\n\t\t\t\t(links.otp || links['otp.check'] || (links as Record<string, unknown>)['checkOtp'])\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth status:`, {\n\t\t\t\tstatus,\n\t\t\t\tnextStep,\n\t\t\t\thasOtpLink,\n\t\t\t\tdeviceType: device.type,\n\t\t\t});\n\n\t\t\t// Show appropriate UI based on response (normalize status/nextStep for PingOne variants)\n\t\t\tif (status === 'OTP_REQUIRED' || nextStep === 'OTP_REQUIRED' || hasOtpLink) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Opening OTP modal for device:`, device.type);\n\t\t\t\tsetShowOTPModal(true);\n\t\t\t\ttoastV8.success(`Verification code sent to your ${device.type} device`);\n\t\t\t} else if (status === 'ASSERTION_REQUIRED' || nextStep === 'ASSERTION_REQUIRED') {\n\t\t\t\tconsole.log(`${MODULE_TAG} FIDO2 assertion required`);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'FIDO2 authentication required. Please use /v8/mfa-config for FIDO2 authentication.'\n\t\t\t\t);\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'PUSH_CONFIRMATION_REQUIRED' ||\n\t\t\t\tnextStep === 'PUSH_CONFIRMATION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Push confirmation required`);\n\t\t\t\ttoastV8.success('Push notification sent! Please approve on your mobile device.');\n\t\t\t\ttoastV8.info('Complete authentication at /v8/mfa-config for push polling.');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (status === 'COMPLETED') {\n\t\t\t\ttoastV8.success('Authentication completed successfully!');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'DEVICE_SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'DEVICE_SELECTION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Device selection required - showing modal again`);\n\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t} else {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Unexpected authentication status:`, {\n\t\t\t\t\tstatus,\n\t\t\t\t\tnextStep,\n\t\t\t\t\tresponse,\n\t\t\t\t});\n\t\t\t\ttoastV8.info(`Authentication status: ${status || nextStep || 'UNKNOWN'}`);\n\t\t\t\t// Stay in authentication flow so user can try another device\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to initialize authentication:`, error);\n\n\t\t\t// Enhanced error handling for NO_USABLE_DEVICES\n\t\t\tlet errorMessage = 'Authentication failed: ';\n\t\t\tif (error instanceof Error) {\n\t\t\t\tconst errorStr = error.message.toLowerCase();\n\n\t\t\t\t// Check for NO_USABLE_DEVICES or device availability errors\n\t\t\t\tif (\n\t\t\t\t\terrorStr.includes('no usable devices') ||\n\t\t\t\t\terrorStr.includes('too many') ||\n\t\t\t\t\terrorStr.includes('cooldown') ||\n\t\t\t\t\terrorStr.includes('blocked')\n\t\t\t\t) {\n\t\t\t\t\terrorMessage = '‚ö†Ô∏è Device Temporarily Unavailable\\n\\n';\n\n\t\t\t\t\tif (errorStr.includes('cooldown') || errorStr.includes('too many')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Too many notifications have been sent to this device. It is temporarily in cooldown. ';\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Please wait a few minutes and try again, or select a different device.';\n\t\t\t\t\t} else if (errorStr.includes('blocked')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'This device has been blocked. Please contact your administrator or use a different device.';\n\t\t\t\t\t} else {\n\t\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terrorMessage += 'Unknown error';\n\t\t\t}\n\n\t\t\ttoastV8.error(errorMessage, { duration: 8000 });\n\t\t\t// Do NOT set flowMode(null) - keep user in authentication flow so they can retry or select another device\n\t\t}\n\t};\n\n\t// Handle OTP verification\n\tconst handleVerifyOTP = async () => {\n\t\tif (!authenticationId || !selectedAuthDevice) {\n\t\t\ttoastV8.error('Authentication session not found');\n\t\t\treturn;\n\t\t}\n\n\t\tif (otpCode.length !== 6) {\n\t\t\ttoastV8.error('Please enter a 6-digit code');\n\t\t\treturn;\n\t\t}\n\n\t\t// Get worker token for API call\n\t\tconst workerTokenForOTP = await workerTokenServiceV8.getToken();\n\n\t\tconsole.log(`${MODULE_TAG} OTP verification debug:`, {\n\t\t\tenvironmentId,\n\t\t\tusername: username.trim(),\n\t\t\tauthenticationId,\n\t\t\totpCode,\n\t\t\thasEnvironmentId: !!environmentId,\n\t\t\tenvIdLength: environmentId?.length,\n\t\t\thasWorkerToken: !!workerTokenForOTP,\n\t\t\tworkerTokenLength: workerTokenForOTP?.length,\n\t\t});\n\n\t\ttry {\n\t\t\t// Use backend proxy to avoid CORS issues\n\t\t\tconst response = await fetch('/api/pingone/mfa/validate-otp-for-device', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tenvironmentId,\n\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\tdeviceAuthId: authenticationId,\n\t\t\t\t\totp: otpCode,\n\t\t\t\t\tregion: 'na',\n\t\t\t\t\tworkerToken: workerTokenForOTP,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\n\t\t\t\tthrow new Error(errorData.error || errorData.message || `HTTP ${response.status}`);\n\t\t\t}\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.status === 'COMPLETED' || result.status === 'completed') {\n\t\t\t\ttoastV8.success('‚úÖ Authentication completed successfully!');\n\t\t\t\tsetShowOTPModal(false);\n\t\t\t\tsetFlowMode(null);\n\t\t\t\tsetOtpCode('');\n\t\t\t} else {\n\t\t\t\ttoastV8.error('Invalid code. Please try again.');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} OTP verification failed:`, error);\n\t\t\ttoastV8.error(\n\t\t\t\t`Verification failed: ${error instanceof Error ? error.message : 'Unknown error'}`\n\t\t\t);\n\t\t}\n\t};\n\n\t// Step 1: Choose Registration or Authentication\n\tif (!flowMode) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '12px' }}>\n\t\t\t\t\t{/* Header */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tboxShadow: '0 4px 12px rgba(239, 68, 68, 0.2)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h1\n\t\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîê MFA Unified Flow\n\t\t\t\t\t\t</h1>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tChoose what you want to do with MFA devices.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Configuration Section */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 12px 0',\n\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfiguration\n\t\t\t\t\t\t</h2>\n\n\t\t\t\t\t\t{/* Custom Logo URL */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-url\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[800],\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüé® Custom Logo URL (Optional)\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tDisplay a custom logo in the OTP verification modal\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t{/* URL Input */}\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tid=\"custom-logo-url\"\n\t\t\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\t\t\tvalue={customLogoUrl}\n\t\t\t\t\t\t\t\tonChange={(e) => setCustomLogoUrl(e.target.value)}\n\t\t\t\t\t\t\t\tplaceholder=\"https://example.com/logo.png\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\tpadding: '10px 14px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[900],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = `0 0 0 3px ${PING_IDENTITY_COLORS.primary[200]}`;\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.neutral[300];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* File Upload Section */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '13px', color: PING_IDENTITY_COLORS.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\tOR\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"file\"\n\t\t\t\t\t\t\t\t\tid=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\taccept=\"image/*\"\n\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\tconst file = e.target.files?.[0];\n\t\t\t\t\t\t\t\t\t\tif (!file) return;\n\n\t\t\t\t\t\t\t\t\t\t// Validate file type (images only)\n\t\t\t\t\t\t\t\t\t\tif (!file.type.startsWith('image/')) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Please select a logo file (JPG, PNG, etc.)');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Validate file size (max 5MB)\n\t\t\t\t\t\t\t\t\t\tif (file.size > 5 * 1024 * 1024) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('File size must be less than 5MB');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Convert file to base64 for persistence\n\t\t\t\t\t\t\t\t\t\tconst reader = new FileReader();\n\t\t\t\t\t\t\t\t\t\treader.onload = (event) => {\n\t\t\t\t\t\t\t\t\t\t\tconst base64Url = event.target?.result as string;\n\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl(base64Url);\n\n\t\t\t\t\t\t\t\t\t\t\t// Store base64 data for persistence\n\t\t\t\t\t\t\t\t\t\t\tconst uploadData = {\n\t\t\t\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\t\t\t\tbase64Url: base64Url,\n\t\t\t\t\t\t\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\t\t\t// Save to localStorage for persistence\n\t\t\t\t\t\t\t\t\t\t\tlocalStorage.setItem('custom-logo-upload', JSON.stringify(uploadData));\n\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.success(`Logo uploaded: ${file.name}`);\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.onerror = () => {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to read uploaded file');\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.readAsDataURL(file);\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'none' }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.primary[500],\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.primary[600]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '500',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[700];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìÅ Upload Logo File\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[500],\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tJPG, PNG, GIF (max 5MB)\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{customLogoUrl && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.neutral[50],\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tLogo Preview:\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\talt=\"Custom logo\"\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonError={() => {\n\t\t\t\t\t\t\t\t\t\t\t// Handle broken image URLs\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Failed to load custom logo URL');\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl('');\n\t\t\t\t\t\t\t\t\t\t\t\t// Clear uploaded file from localStorage\n\t\t\t\t\t\t\t\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.accent.pingRed[500],\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.accent.pingRed[600]}`,\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[600];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[500];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRemove Logo\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Environment ID - Hide when worker token is available */}\n\t\t\t\t\t\t{!hasWorkerToken && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"env-id\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tEnvironment ID\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"env-id\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setEnvironmentId(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* SQLite Database Stats */}\n\t\t\t\t\t\t{environmentId && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<SQLiteStatsDisplayV8\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tcompact={false}\n\t\t\t\t\t\t\t\t\trefreshInterval={30}\n\t\t\t\t\t\t\t\t\tshowRefreshButton={true}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Username */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUsername\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{environmentId && tokenStatus.isValid ? (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\toptions={userOptions}\n\t\t\t\t\t\t\t\t\tonChange={setUsername}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Type to search across 16,000+ users...\"\n\t\t\t\t\t\t\t\t\tisLoading={isLoadingUsers}\n\t\t\t\t\t\t\t\t\tonSearchChange={setSearchQuery}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setUsername(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* MFA Policy Dropdown */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"mfa-policy\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tMFA Policy\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{isPoliciesLoading ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tLoading policies...\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policiesError ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#ef4444', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tError loading policies: {policiesError}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policies.length === 0 ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tNo MFA policies found. Please check your environment ID and worker token.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"mfa-policy\"\n\t\t\t\t\t\t\t\t\tvalue={selectedPolicy?.id || ''}\n\t\t\t\t\t\t\t\t\toptions={policyOptions}\n\t\t\t\t\t\t\t\t\tonChange={selectPolicy}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Select an MFA policy...\"\n\t\t\t\t\t\t\t\t\tisLoading={isPoliciesLoading}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tSelect the MFA policy to use for device registration\n\t\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t\t{/* Policy Summary - Collapsible */}\n\t\t\t\t\t\t\t{selectedPolicy && (\n\t\t\t\t\t\t\t\t<details\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<summary\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\tuserSelect: 'none',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüìã Policy Details\n\t\t\t\t\t\t\t\t\t</summary>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '12px', fontSize: '13px', color: '#4b5563' }}>\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Policy Name:</strong> {String(selectedPolicy.name)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedPolicy.default && (\n\t\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px', color: '#059669' }}>\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>‚úì Default Policy</strong>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Enabled Devices:</strong>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '6px' }}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'sms') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì± SMS\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'email') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t‚úâÔ∏è Email\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'totp') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîê TOTP\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'fido2') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîë FIDO2\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'mobile') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì≤ Mobile\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'voice') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüìû Voice\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</details>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Worker Token Status */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t\tpaddingRight: '16px',\n\t\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={setEnvironmentId}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* User Token Status */}\n\t\t\t\t\t\t\t{userToken && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\t'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05))',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #10b981',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '20px' }}>üë§</span>\n\t\t\t\t\t\t\t\t\t\t<strong style={{ color: '#047857', fontSize: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t\tUser Token Active\n\t\t\t\t\t\t\t\t\t\t</strong>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: '14px', color: '#059669', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t\t‚úì User authentication token available\n\t\t\t\t\t\t\t\t\t\t<br />‚úì Ready for User Flow device registration\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Flow Mode Selection */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',\n\t\t\t\t\t\t\tgap: '16px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Registration Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => setFlowMode('registration')}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>‚ûï</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#047857',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Registration\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tRegister a new MFA device for a user. Create SMS, Email, TOTP, Mobile Push,\n\t\t\t\t\t\t\t\t\t\tWhatsApp, or FIDO2 devices.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t{/* Authentication Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tif (!userToken) {\n\t\t\t\t\t\t\t\t\tsetShowAuthLoginModal(true);\n\t\t\t\t\t\t\t\t\ttoastV8.info('üîê Please complete user login before device authentication.', {\n\t\t\t\t\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-4px)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 8px 24px rgba(59, 130, 246, 0.2)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>üîì</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#1d4ed8',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Authentication\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tAuthenticate using an existing MFA device. Verify user identity with OTP, push\n\t\t\t\t\t\t\t\t\t\tnotification, or security key.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{showAuthLoginModal && (\n\t\t\t\t\t<UserLoginModalV8\n\t\t\t\t\t\tisOpen={showAuthLoginModal}\n\t\t\t\t\t\tonClose={() => setShowAuthLoginModal(false)}\n\t\t\t\t\t\tonTokenReceived={(token) => {\n\t\t\t\t\t\t\tsetUserToken(token);\n\t\t\t\t\t\t\tsetShowAuthLoginModal(false);\n\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tenvironmentId={authEnvIdForModal}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</>\n\t\t);\n\t}\n\n\t// Authentication flow - dedicated view (device selection + OTP modals only; no registration grid)\n\tif (flowMode === 'authentication') {\n\t\treturn (\n\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\tsetSelectedAuthDevice(null);\n\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t‚Üê Back\n\t\t\t\t\t</button>\n\t\t\t\t\t<h1\n\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t>\n\t\t\t\t\t\tüîì Device Authentication\n\t\t\t\t\t</h1>\n\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\t{selectedAuthDevice && !showOTPModal\n\t\t\t\t\t\t\t? `Authenticating with ${selectedAuthDevice.type} ‚Äî enter the code when prompted.`\n\t\t\t\t\t\t\t: `Select an MFA device to authenticate for ${username || 'the user'}`}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t\t{!showDeviceSelectionModal && !showOTPModal && (\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowDeviceSelectionModal(true)}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tSelect MFA device\n\t\t\t\t\t</button>\n\t\t\t\t)}\n\t\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\t\tonClose={() => {\n\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t// Keep flowMode so user stays in auth flow; only clear if they click Back\n\t\t\t\t\t}}\n\t\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\t\tusername={username}\n\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t/>\n\t\t\t\t{showOTPModal && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.6)',\n\t\t\t\t\t\t\tbackdropFilter: 'blur(4px)',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t\t\tanimation: 'fadeIn 0.2s ease-out',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t{`\n\t\t\t\t\t\t\t@keyframes fadeIn {\n\t\t\t\t\t\t\t\tfrom { opacity: 0; }\n\t\t\t\t\t\t\t\tto { opacity: 1; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes slideUp {\n\t\t\t\t\t\t\t\tfrom { \n\t\t\t\t\t\t\t\t\topacity: 0;\n\t\t\t\t\t\t\t\t\ttransform: translateY(20px); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tto { \n\t\t\t\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t\t\t\t\ttransform: translateY(0); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes pulse {\n\t\t\t\t\t\t\t\t0%, 100% { opacity: 1; }\n\t\t\t\t\t\t\t\t50% { opacity: 0.5; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`}\n\t\t\t\t\t\t</style>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\tborderRadius: '24px',\n\t\t\t\t\t\t\t\tpadding: '48px 40px',\n\t\t\t\t\t\t\t\tmaxWidth: '480px',\n\t\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\t\tboxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',\n\t\t\t\t\t\t\t\tanimation: 'slideUp 0.3s ease-out',\n\t\t\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Logo Area */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '32px' }}>\n\t\t\t\t\t\t\t\t{customLogoUrl ? (\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\t\talt=\"Organization logo\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '120px',\n\t\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonError={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\t// Fallback to default icon if image fails to load\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.display = 'none';\n\t\t\t\t\t\t\t\t\t\t\t\tconst fallback = document.createElement('div');\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.style.cssText = `\n\t\t\t\t\t\t\t\t\t\t\t\twidth: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\theight: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: 0 auto 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: center;\n\t\t\t\t\t\t\t\t\t\t\t\tjustifyContent: center;\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: 36px;\n\t\t\t\t\t\t\t\t\t\t\t\tboxShadow: 0 10px 25px rgba(102, 126, 234, 0.3);\n\t\t\t\t\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.textContent = 'üîê';\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.parentElement!.appendChild(fallback);\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\theight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto 20px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '20px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '36px',\n\t\t\t\t\t\t\t\t\t\t\tboxShadow: '0 10px 25px rgba(102, 126, 234, 0.3)',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüîê\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tVerification Code\n\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\tEnter the 6-digit code sent to your <strong>{selectedAuthDevice?.type}</strong>{' '}\n\t\t\t\t\t\t\t\t\tdevice\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* OTP Input */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\t\t\tplaceholder=\"‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢\"\n\t\t\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tletterSpacing: '12px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow: otpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{otpCode.length > 0 && otpCode.length < 6 && (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\t\tanimation: 'pulse 2s ease-in-out infinite',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{6 - otpCode.length} more digit{6 - otpCode.length !== 1 ? 's' : ''} needed\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Resend Code Button */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={async () => {\n\t\t\t\t\t\t\t\t\t\tif (!selectedAuthDevice || !authenticationId) return;\n\t\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.info('Resending verification code...');\n\t\t\t\t\t\t\t\t\t\t\t// Re-initialize authentication to resend code\n\t\t\t\t\t\t\t\t\t\t\tconst response =\n\t\t\t\t\t\t\t\t\t\t\t\tawait MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\t\t\t\t\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\t\t\t\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicy?.id || '',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceId: selectedAuthDevice.id,\n\t\t\t\t\t\t\t\t\t\t\t\t\tregion: 'na',\n\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tif (response.status?.toUpperCase() === 'OTP_REQUIRED') {\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('New code sent to your device!');\n\t\t\t\t\t\t\t\t\t\t\t\tsetAuthenticationId(response.id);\n\t\t\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to resend code');\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Resend error:', error);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tcolor: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'transparent';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚Üª Resend Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Action Buttons */}\n\t\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#d1d5db';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f9fafb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'white';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6\n\t\t\t\t\t\t\t\t\t\t\t\t? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '#d1d5db',\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (otpCode.length === 6) {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚úì Verify Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Help Text */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<strong style={{ color: '#111827' }}>Didn't receive the code?</strong>\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\tCheck your spam folder or click \"Resend Code\" above\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t);\n\t}\n\n\t// Registration flow - show device type selection cards\n\treturn (\n\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t{/* Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #10b981 0%, #047857 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => setFlowMode(null)}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t‚Üê Back\n\t\t\t\t</button>\n\t\t\t\t<h1 style={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}>\n\t\t\t\t\t‚ûï Register MFA Device\n\t\t\t\t</h1>\n\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\tSelect a device type to register for {username || 'the user'}\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Device Type Cards */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',\n\t\t\t\t\tgap: '16px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t{DEVICE_TYPES.map((device) => {\n\t\t\t\t\tconst enabled = isDeviceEnabled(device.key);\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tkey={device.key}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => enabled && onSelectDeviceType(device.key)}\n\t\t\t\t\t\t\tdisabled={!enabled}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tbackground: enabled ? '#ffffff' : '#f9fafb',\n\t\t\t\t\t\t\t\tborder: `2px solid ${enabled ? '#e5e7eb' : '#f3f4f6'}`,\n\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\tcursor: enabled ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\topacity: enabled ? 1 : 0.5,\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#10b981';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ecfdf5';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>{device.icon}</span>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{device.name}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280' }}>{device.description}</p>\n\t\t\t\t\t\t\t{!enabled && (\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '12px', color: '#9ca3af' }}>\n\t\t\t\t\t\t\t\t\t(Not enabled)\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</div>\n\n\t\t\t{/* Device Selection Modal for Authentication */}\n\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t}}\n\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\tusername={username}\n\t\t\t\tenvironmentId={environmentId}\n\t\t\t/>\n\n\t\t\t{/* OTP Modal for Authentication */}\n\t\t\t{showOTPModal && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '400px',\n\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\tboxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '600' }}>\n\t\t\t\t\t\t\tEnter Verification Code\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '0 0 20px 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tCheck your {selectedAuthDevice?.type} device for the code\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\tplaceholder=\"000000\"\n\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 16px',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\tletterSpacing: '8px',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tmarginBottom: '20px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: otpCode.length === 6 ? '#3b82f6' : '#9ca3af',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tVerify\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Wrapper Component\n *\n * Wraps the content with MFACredentialProvider to provide global credential state\n */\nexport const UnifiedMFARegistrationFlowV8: React.FC<UnifiedMFARegistrationFlowV8Props> = (\n\tprops\n) => {\n\tconst location = useLocation();\n\n\t// Get device type from props or location state (can be undefined)\n\tconst initialDeviceType =\n\t\tprops.deviceType || (location.state as { deviceType?: DeviceConfigKey })?.deviceType;\n\n\t// State for selected device type (allows user to select if not provided)\n\tconst [selectedDeviceType, setSelectedDeviceType] = useState<DeviceConfigKey | undefined>(\n\t\tinitialDeviceType\n\t);\n\n\t// User token state for OAuth authentication (User Flow)\n\tconst [userToken, setUserToken] = useState<string | null>(() => {\n\t\t// Check if we already have a user token from previous OAuth flow\n\t\tconst savedCreds = CredentialsServiceV8.loadCredentials('user-login-v8', {\n\t\t\tflowKey: 'user-login-v8',\n\t\t\tflowType: 'oauth',\n\t\t\tincludeClientSecret: false,\n\t\t\tincludeRedirectUri: false,\n\t\t\tincludeLogoutUri: false,\n\t\t\tincludeScopes: false,\n\t\t});\n\t\treturn savedCreds?.accessToken || null;\n\t});\n\n\t// If no device type selected, show device type selection screen\n\tif (!selectedDeviceType) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<MFAHeaderV8\n\t\t\t\t\ttitle=\"MFA Unified Flow\"\n\t\t\t\t\tdescription=\"Register or authenticate MFA devices\"\n\t\t\t\t\tversionTag=\"V8\"\n\t\t\t\t\tcurrentPage=\"registration\"\n\t\t\t\t\tshowBackToMain={true}\n\t\t\t\t\theaderColor=\"pingRed\"\n\t\t\t\t/>\n\t\t\t\t<GlobalMFAProvider>\n\t\t\t\t\t<MFACredentialProvider>\n\t\t\t\t\t\t<DeviceTypeSelectionScreen\n\t\t\t\t\t\t\tonSelectDeviceType={setSelectedDeviceType}\n\t\t\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</MFACredentialProvider>\n\t\t\t\t</GlobalMFAProvider>\n\t\t\t\t{/* API display (bottom of page) */}\n\t\t\t\t<div style={{ marginTop: '24px' }}>\n\t\t\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\t\t\t\t</div>\n\t\t\t</>\n\t\t);\n\t}\n\n\treturn (\n\t\t<GlobalMFAProvider>\n\t\t\t<MFACredentialProvider>\n\t\t\t\t<UnifiedMFARegistrationFlowContent\n\t\t\t\t\t{...props}\n\t\t\t\t\tdeviceType={selectedDeviceType}\n\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t/>\n\t\t\t</MFACredentialProvider>\n\t\t</GlobalMFAProvider>\n\t);\n};\n\n// ============================================================================\n// CONTENT COMPONENT (MAIN LOGIC)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Content Component\n *\n * Contains the actual flow logic and integrates with:\n * - MFACredentialContext (global credential state)\n * - useWorkerToken hook (token status and auto-refresh)\n * - deviceFlowConfigs (device-specific configuration)\n * - MFAFlowBaseV8 (5-step framework)\n */\nconst UnifiedMFARegistrationFlowContent: React.FC<\n\tRequired<Pick<UnifiedMFARegistrationFlowV8Props, 'deviceType'>> &\n\t\tOmit<UnifiedMFARegistrationFlowV8Props, 'deviceType'> & {\n\t\t\tuserToken: string | null;\n\t\t\tsetUserToken: (token: string | null) => void;\n\t\t}\n> = ({ deviceType, onCancel, userToken, setUserToken }) => {\n\t// ========================================================================\n\t// CONFIGURATION\n\t// ========================================================================\n\n\t// React Router navigation\n\tconst navigate = useNavigate();\n\n\t// Load device-specific configuration\n\tconst config = useMemo(() => {\n\t\treturn getDeviceConfig(deviceType);\n\t}, [deviceType]);\n\n\t// ========================================================================\n\t// USER FLOW OAUTH STATE\n\t// ========================================================================\n\n\t// State for User Login Modal (OAuth authentication for User Flow)\n\tconst [showUserLoginModal, setShowUserLoginModal] = useState(false);\n\tconst [showUserTokenSuccess, setShowUserTokenSuccess] = useState(false);\n\tconst [userTokenForDisplay, setUserTokenForDisplay] = useState<string>('');\n\tconst [usernameFromToken, setUsernameFromToken] = useState<string>('');\n\tconst [showUsernameDropdown, setShowUsernameDropdown] = useState(false);\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\tconst envIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Pending registration data while waiting for OAuth (use ref to avoid stale closure)\n\tconst pendingRegistrationRef = useRef<{\n\t\tdeviceType: DeviceConfigKey;\n\t\tfields: Record<string, string>;\n\t\tflowType: string;\n\t\tprops: MFAFlowBaseRenderProps;\n\t} | null>(null);\n\n\t// Worker token state for validation in registration flow\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Detect OAuth callback and re-open modal if needed\n\tuseEffect(() => {\n\t\tconst urlParams = new URLSearchParams(window.location.search);\n\t\tconst code = urlParams.get('code');\n\t\tconst hasStoredState = sessionStorage.getItem('user_login_state_v8');\n\n\t\t// If we have OAuth callback params and stored state, re-open the modal to process callback\n\t\t// But only if we don't already have a user token (to prevent reopening after silent auth)\n\t\tif (code && hasStoredState && !showUserLoginModal && !userToken) {\n\t\t\tconsole.log('[UNIFIED-FLOW] OAuth callback detected - re-opening modal to process');\n\t\t\tsetShowUserLoginModal(true);\n\t\t}\n\t}, [showUserLoginModal, userToken]);\n\n\t// ========================================================================\n\t// STEP VALIDATION\n\t// ========================================================================\n\n\t/**\n\t * Validate Step 0 (Configuration)\n\t */\n\tconst validateStep0 = useCallback(\n\t\t(\n\t\t\tcredentials: MFACredentials,\n\t\t\ttoken: TokenStatusInfo,\n\t\t\tnavigation: ReturnType<typeof useStepNavigationV8>\n\t\t) => {\n\t\t\t// Always check for valid worker token (required for MFA device operations)\n\t\t\tif (!token.isValid) {\n\t\t\t\tnavigation.setValidationErrors(['Invalid or expired worker token']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Check required configuration\n\t\t\tif (!credentials.environmentId || !credentials.username) {\n\t\t\t\tnavigation.setValidationErrors(['Environment ID and Username are required']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\t\t[]\n\t);\n\n\t// ========================================================================\n\t// STEP RENDERERS\n\t// ========================================================================\n\n\t/**\n\t * Perform device registration API call (with token already available)\n\t */\n\tconst performRegistrationWithToken = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string,\n\t\t\ttoken?: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== PERFORM REGISTRATION WITH TOKEN =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Token:', token ? `Present (${token.length} chars)` : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setIsLoading available:', typeof props.setIsLoading);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setCredentials available:', typeof props.setCredentials);\n\n\t\t\ttry {\n\t\t\t\tprops.setIsLoading(true);\n\n\t\t\t\t// Update credentials with device fields and user token if provided\n\t\t\t\tprops.setCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tflowType, // Store flowType so activation step knows if OTP is required\n\t\t\t\t\t...fields,\n\t\t\t\t\t...(flowType === 'user' && token\n\t\t\t\t\t\t? { userToken: token, tokenType: 'user' }\n\t\t\t\t\t\t: flowType !== 'user'\n\t\t\t\t\t\t\t? { tokenType: 'worker' }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t}));\n\n\t\t\t\t// Register the device using proper API call\n\t\t\t\t// CRITICAL: Flow-specific device status\n\t\t\t\t// - Admin flow: ACTIVE (no OTP sent, device ready immediately)\n\t\t\t\t// - Admin ACTIVATION_REQUIRED: ACTIVATION_REQUIRED (sends OTP for admin to activate)\n\t\t\t\t// - User flow: ACTIVATION_REQUIRED (sends OTP for user to activate)\n\t\t\t\t// - FIDO2: ACTIVE (WebAuthn verification happens during registration)\n\t\t\t\tlet deviceStatus: 'ACTIVE' | 'ACTIVATION_REQUIRED' | undefined;\n\n\t\t\t\t// Determine device status based on flow type (applies to all device types including FIDO2)\n\t\t\t\tif (flowType === 'admin-active') {\n\t\t\t\t\tdeviceStatus = 'ACTIVE';\n\t\t\t\t} else if (flowType === 'admin-activation') {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED';\n\t\t\t\t} else {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED'; // user flow\n\t\t\t\t}\n\n\t\t\t\t// Special note for FIDO2: WebAuthn verification proves device works,\n\t\t\t\t// but we still respect the flow type for status determination\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t'[UNIFIED-FLOW] FIDO2 device - status determined by flow type:',\n\t\t\t\t\t\tdeviceStatus\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device status determined:', {\n\t\t\t\t\tflowType,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tdeviceStatus,\n\t\t\t\t\totpWillBeSent: deviceStatus === 'ACTIVATION_REQUIRED',\n\t\t\t\t\treason:\n\t\t\t\t\t\tselectedDeviceType === 'FIDO2'\n\t\t\t\t\t\t\t? 'FIDO2 - ACTIVE after WebAuthn verification'\n\t\t\t\t\t\t\t: 'User flow - OTP required for activation',\n\t\t\t\t});\n\n\t\t\t\t// Use same parameter construction as working MFA flows\n\t\t\t\ttype RegisterDeviceParamsWithToken = RegisterDeviceParams & {\n\t\t\t\t\ttokenType?: 'worker' | 'user';\n\t\t\t\t\tuserToken?: string | undefined;\n\t\t\t\t};\n\t\t\t\tlet baseParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\tenvironmentId: props.credentials.environmentId,\n\t\t\t\t\tusername: props.credentials.username,\n\t\t\t\t\ttype: selectedDeviceType,\n\t\t\t\t};\n\t\t\t\t// Per rightTOTP.md: Pass token type and user token if available\n\t\t\t\tif (flowType === 'user' && token) {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'user',\n\t\t\t\t\t\tuserToken: token,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'worker',\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Always include status for all device types\n\t\t\t\t// FIDO2: Set to ACTIVE since WebAuthn verification proves device works\n\t\t\t\t// Other devices: Set based on flow type (admin-active = ACTIVE, others = ACTIVATION_REQUIRED)\n\t\t\t\tif (deviceStatus !== undefined) {\n\t\t\t\t\tbaseParams.status = deviceStatus;\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registration base params:', {\n\t\t\t\t\tenvironmentId: baseParams.environmentId,\n\t\t\t\t\tusername: baseParams.username,\n\t\t\t\t\ttype: baseParams.type,\n\t\t\t\t\ttokenType: baseParams.tokenType,\n\t\t\t\t\tstatus: baseParams.status,\n\t\t\t\t\tflowType,\n\t\t\t\t});\n\n\t\t\t\t// Map form field names to API field names\n\t\t\t\t// Form uses 'deviceName' but API expects 'nickname' or 'name'\n\t\t\t\tconst mappedFields: Record<string, string> = { ...fields };\n\t\t\t\tif (mappedFields.deviceName) {\n\t\t\t\t\tmappedFields.nickname = mappedFields.deviceName;\n\t\t\t\t\tmappedFields.name = mappedFields.deviceName;\n\t\t\t\t\tdelete mappedFields.deviceName;\n\t\t\t\t}\n\n\t\t\t\t// Format phone number for SMS/WhatsApp devices\n\t\t\t\t// Form sends: { phoneNumber: '9725231586', countryCode: '+1' }\n\t\t\t\t// API expects: { phone: '+1.9725231586' }\n\t\t\t\tif (mappedFields.phoneNumber && mappedFields.countryCode) {\n\t\t\t\t\tconst countryCode = mappedFields.countryCode.replace('+', ''); // Remove + for formatting\n\t\t\t\t\tconst phoneNumber = mappedFields.phoneNumber.replace(/\\D/g, ''); // Remove non-digits\n\t\t\t\t\tmappedFields.phone = `+${countryCode}.${phoneNumber}`;\n\t\t\t\t\tconsole.log('[UNIFIED-FLOW] Formatted phone:', mappedFields.phone);\n\t\t\t\t\tdelete mappedFields.phoneNumber;\n\t\t\t\t\tdelete mappedFields.countryCode;\n\t\t\t\t}\n\n\t\t\t\t// Include device-specific fields (phone, email, etc.)\n\t\t\t\tconst deviceParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\t...baseParams,\n\t\t\t\t\t...mappedFields,\n\t\t\t\t\t// Include policy for TOTP devices (required for secret and keyUri to be returned)\n\t\t\t\t\t...(selectedDeviceType === 'TOTP' && selectedPolicyRef.current\n\t\t\t\t\t\t? { policy: selectedPolicyRef.current.id }\n\t\t\t\t\t\t: {}),\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registering device with params:', deviceParams);\n\n\t\t\t\tconst result = await MFAServiceV8_Legacy.registerDevice(deviceParams);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device registered:', result);\n\n\t\t\t\t// Update MFA state with device info\n\t\t\t\tconst registrationResult = result as unknown as Record<string, unknown>;\n\n\t\t\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result for TOTP:', {\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\tqrCode: registrationResult.qrCode,\n\t\t\t\t\t\tqrCodeUrl: registrationResult.qrCodeUrl,\n\t\t\t\t\t\tsecret: registrationResult.secret,\n\t\t\t\t\t\ttotpSecret: registrationResult.totpSecret,\n\t\t\t\t\t\tfullResult: result,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// ===============================================\n\n\t\t\t\t// Clear stored registration data after successful use\n\t\t\t\tlocalStorage.removeItem('mfa_registration_flow_type');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_fields');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_device_type');\n\n\t\t\t\tprops.setMfaState((prev) => {\n\t\t\t\t\t// TOTP: QR code will be rendered by QRCodeSVG component in UnifiedActivationStep\n\t\t\t\t\t// No need to generate QR code data URL here - just pass the keyUri\n\t\t\t\t\tconst newState: MFAState = {\n\t\t\t\t\t\t...prev,\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tdeviceStatus: result.status,\n\t\t\t\t\t\t...(registrationResult.deviceActivateUri\n\t\t\t\t\t\t\t? { deviceActivateUri: String(registrationResult.deviceActivateUri) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'TOTP'\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\ttotpSecret: String(registrationResult.secret || ''),\n\t\t\t\t\t\t\t\t\tkeyUri: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tqrCodeUrl: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tshowQr: !!(registrationResult.secret || registrationResult.keyUri),\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'FIDO2' &&\n\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tpublicKeyCredentialCreationOptions:\n\t\t\t\t\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions,\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'MOBILE' && registrationResult.pairingKey\n\t\t\t\t\t\t\t? { pairingKey: String(registrationResult.pairingKey) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t};\n\n\t\t\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\t\t\tfullState: newState,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t// ================================================\n\n\t\t\t\t\treturn newState;\n\t\t\t\t});\n\n\t\t\t\t// FIDO2: Check if we already have credential data (from WebAuthn modal)\n\t\t\t\t// If credentialId and publicKey are present, registration is complete\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tif (fields.credentialId && fields.publicKey) {\n\t\t\t\t\t\t// WebAuthn already completed via modal - device fully registered\n\n\t\t\t\t\t\t// Admin Flow: Show QR but skip OTP validation - device ready immediately\n\t\t\t\t\t\t// Admin ACTIVATION_REQUIRED & User Flow: Show QR and require OTP validation\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tflowType === 'admin-active' ||\n\t\t\t\t\t\t\tflowType === 'admin-activation' ||\n\t\t\t\t\t\t\tresult.status === 'ACTIVE'\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t'[UNIFIED-FLOW] Admin flow or ACTIVE status - proceeding to show QR without OTP requirement'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered successfully!${flowType === 'admin-active' || flowType === 'admin-activation' ? ' Device is ready to use.' : ''}`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t// For Admin Flow, go to API docs page instead of OTP page\n\t\t\t\t\t\t\t// For User Flow, go to User Login step (Step 1)\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (result.status === 'ACTIVATION_REQUIRED') {\n\t\t\t\t\t\t\t// Device requires activation - PingOne automatically sends OTP\n\t\t\t\t\t\t\t// This applies to both admin_activation_required and user flow\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered! OTP has been sent automatically.`\n\t\t\t\t\t\t\t);\n  // DO NOT auto-advance for OTP-required devices\n\t\t\t\t\t\t\t// User should manually click Next after receiving OTP\n\t\t\t\t\t\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation - waiting for user to proceed manually`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Unknown status, proceed with flow-specific navigation\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} // End of FIDO2 section\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Registration failed:', error);\n\t\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Device registration failed';\n\n\t\t\t\t// Check if error is due to too many devices\n\t\t\t\tif (errorMessage.includes('Too many devices')) {\n\t\t\t\t\ttoastV8.error(\n\t\t\t\t\t\t`${errorMessage}\\n\\n‚ÑπÔ∏è You can manage your devices at:\\nhttps://localhost:3000/v8/delete-all-devices`,\n\t\t\t\t\t\t{ duration: 8000 }\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\ttoastV8.error(errorMessage);\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tprops.setIsLoading(false);\n\t\t\t}\n\t\t},\n\t\t[config.displayName, toastV8]\n\t);\n\n\t/**\n\t * Handle user token received from OAuth flow\n\t */\n\tconst handleUserTokenReceived = useCallback(\n\t\t(token: string) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== USER TOKEN RECEIVED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Token length:', token.length);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current pending registration:', pendingRegistrationRef.current);\n\n\t\t\tsetUserToken(token);\n\t\t\tsetUserTokenForDisplay(token);\n\n\t\t\t// Decode JWT to extract username\n\t\t\ttry {\n\t\t\t\tconst base64Url = token.split('.')[1];\n\t\t\t\tconst base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n\t\t\t\tconst jsonPayload = decodeURIComponent(\n\t\t\t\t\tatob(base64)\n\t\t\t\t\t\t.split('')\n\t\t\t\t\t\t.map((c) => `%${`00${c.charCodeAt(0).toString(16)}`.slice(-2)}`)\n\t\t\t\t\t\t.join('')\n\t\t\t\t);\n\t\t\t\tconst payload = JSON.parse(jsonPayload);\n\t\t\t\tconst username =\n\t\t\t\t\tpayload.username || payload.preferred_username || payload.sub || 'Unknown User';\n\t\t\t\tsetUsernameFromToken(username);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Extracted username:', username);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Failed to decode JWT:', error);\n\t\t\t\tsetUsernameFromToken('Unknown User');\n\t\t\t}\n\n\t\t\t// If we have pending registration, show success page first\n\t\t\tconst pending = pendingRegistrationRef.current;\n\t\t\tif (pending) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Found pending registration, showing success page first...');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending data:', {\n\t\t\t\t\tdeviceType: pending.deviceType,\n\t\t\t\t\tflowType: pending.flowType,\n\t\t\t\t\thasProps: !!pending.props,\n\t\t\t\t\thasFields: !!pending.fields,\n\t\t\t\t});\n\n\t\t\t\ttoastV8.success('‚úÖ Authentication successful! Your user token is ready.', {\n\t\t\t\t\tduration: 4000,\n\t\t\t\t});\n\n\t\t\t\t// Close login modal and show success page\n\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\tsetShowUserTokenSuccess(true);\n\t\t\t} else {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] WARNING: No pending registration found after OAuth!');\n\t\t\t}\n\t\t},\n\t\t[setUserToken]\n\t);\n\n\t/**\n\t * Handle continue from user token success page\n\t */\n\tconst handleContinueAfterUserLogin = useCallback(() => {\n\t\tconsole.log(\n\t\t\t'[UNIFIED-FLOW] User clicked continue after login, proceeding with registration...'\n\t\t);\n\n\t\tconst pending = pendingRegistrationRef.current;\n\t\tif (pending && userToken) {\n\t\t\tconst { deviceType: pendingDeviceType, fields, flowType, props } = pending;\n\t\t\tpendingRegistrationRef.current = null;\n\n\t\t\t// Hide success page\n\t\t\tsetShowUserTokenSuccess(false);\n\n\t\t\t// Continue with registration\n\t\t\tsetTimeout(() => {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Now executing performRegistrationWithToken...');\n\t\t\t\tperformRegistrationWithToken(props, pendingDeviceType, fields, flowType, userToken);\n\t\t\t}, 100);\n\t\t}\n\t}, [userToken, performRegistrationWithToken]);\n\n\t/**\n\t * Perform device registration API call\n\t * Checks if User Flow needs OAuth first, otherwise proceeds with registration\n\t */\n\tconst performRegistration = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== DEVICE REGISTRATION SUBMITTED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current userToken:', userToken ? 'Present' : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\n\t\t\t// CRITICAL: Validate worker token before allowing any registration\n\t\t\tif (!workerToken.tokenStatus.isValid) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Cannot proceed - no valid worker token');\n\t\t\t\ttoastV8.error(\n\t\t\t\t\t'‚ùå Worker token required for device registration. Please configure worker token credentials first.',\n\t\t\t\t\t{\n\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// For User Flow, check if we need OAuth authentication first\n\t\t\tif (flowType === 'user' && !userToken) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] User flow selected but no token - showing OAuth modal');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Storing pending registration...');\n\n\t\t\t\t// Store pending registration data\n\t\t\t\tpendingRegistrationRef.current = {\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tfields,\n\t\t\t\t\tflowType,\n\t\t\t\t\tprops,\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending registration stored:', pendingRegistrationRef.current);\n\n\t\t\t\t// Set return target for device registration flow\n\t\t\t\tReturnTargetServiceV8U.setReturnTarget(\n\t\t\t\t\t'mfa_device_registration',\n\t\t\t\t\t'/v8/unified-mfa',  // Return to unified MFA flow\n\t\t\t\t\t2  // Step 2: Device Selection\n\t\t\t\t);\n\n\t\t\t\t// Show the user login modal\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'üîê User Flow requires PingOne authentication. Please complete the login to continue with device registration.',\n\t\t\t\t\t{ duration: 6000 }\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t'[UNIFIED-FLOW] Proceeding directly with registration (token exists or admin flow)'\n\t\t\t);\n\t\t\t// Proceed with registration (using existing token for user flow)\n\t\t\tawait performRegistrationWithToken(\n\t\t\t\tprops,\n\t\t\t\tselectedDeviceType,\n\t\t\t\tfields,\n\t\t\t\tflowType,\n\t\t\t\tuserToken || undefined\n\t\t\t);\n\t\t},\n\t\t[workerToken.tokenStatus.isValid, userToken]\n\t);\n\n\t/**\n\t * Render Step 0: Configuration (environment, user, policy)\n\t */\n\tconst renderStep0 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn (\n\t\t\t\t<UnifiedDeviceRegistrationForm\n\t\t\t\t\tinitialDeviceType={deviceType}\n\t\t\t\t\tonSubmit={async (selectedDeviceType, fields, flowType) => {\n\t\t\t\t\t\tawait performRegistration(props, selectedDeviceType, fields, flowType);\n\t\t\t\t\t}}\n\t\t\t\t\tonCancel={() => {\n\t\t\t\t\t\tif (onCancel) onCancel();\n\t\t\t\t\t}}\n\t\t\t\t\ttokenStatus={props.tokenStatus}\n\t\t\t\t\tusername={props.credentials.username}\n\t\t\t\t/>\n\t\t\t);\n\t\t},\n\t\t[deviceType, onCancel, performRegistration]\n\t);\n\n\t/**\n\t * Render Step 1: User Login using Authorization Code Flow with PKCE\n\t */\n\tconst renderStep1 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <UserLoginStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 2: Device Selection (option to call registration if want new device, or have no devices)\n\t */\n\tconst renderStep2 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 3: Device-Specific Actions (OTP/QR Generation, FIDO, Mobile Push)\n\t */\n\tconst renderStep3 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific based on the device type\n\t\t\t// For now, return the activation step which handles device-specific logic\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 4: OTP Validation / Confirmation\n\t */\n\tconst renderStep4 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific validation\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 5: API Documentation\n\t */\n\tconst renderStep5 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <APIDocsStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 6: Success screen with all user data and other valuable options\n\t */\n\tconst renderStep6 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <SuccessStepV8 renderProps={props} />;\n\t}, []);\n\n\t// Step labels for device authentication flow\n\tconst stepLabels = useMemo(() => {\n\t\tif (deviceType === 'FIDO2') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Start FIDO in Browser',\n\t\t\t\t'Passkey confirmation',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else if (deviceType === 'MOBILE') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Push to Mobile App',\n\t\t\t\t'User Confirms on Mobile',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else {\n\t\t\t// SMS, Email, TOTP, WhatsApp\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Generate OTP/QR',\n\t\t\t\t'Validate OTP',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t}\n\t}, [deviceType]);\n\n\tconst shouldHideNextButton = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\tif (props.nav.currentStep === 0) {\n\t\t\treturn true; // Hide Next button on configuration step, use form submit\n\t\t}\n\t\tif (props.nav.currentStep === 1) {\n\t\t\treturn true; // Hide Next button on user login step, use authentication button\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\treturn (\n\t\t<>\n\t\t\t<MFAFlowBaseV8\n\t\t\t\tdeviceType={deviceType}\n\t\t\t\trenderStep0={renderStep0}\n\t\t\t\trenderStep1={renderStep1}\n\t\t\t\trenderStep2={renderStep2}\n\t\t\t\trenderStep3={renderStep3}\n\t\t\t\trenderStep4={renderStep4}\n\t\t\t\trenderStep5={renderStep5}\n\t\t\t\trenderStep6={renderStep6}\n\t\t\t\tvalidateStep0={validateStep0}\n\t\t\t\tstepLabels={stepLabels}\n\t\t\t\tshouldHideNextButton={shouldHideNextButton}\n\t\t\t\tflowType=\"device-auth\"\n\t\t\t/>\n\t\t\t<div style={{ height: '300px' }} />\n\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\n\t\t\t{/* User Login Modal for User Flow OAuth */}\n\t\t\t<UserLoginModalV8\n\t\t\t\tisOpen={showUserLoginModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\t\tpendingRegistrationRef.current = null;\n\t\t\t\t}}\n\t\t\t\tonTokenReceived={handleUserTokenReceived}\n\t\t\t\tenvironmentId={envIdForModal}\n\t\t\t/>\n\n\t\t\t{/* User Token Success Page - Show token after OAuth login */}\n\t\t\t{showUserTokenSuccess && userTokenForDisplay && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 10000,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\t\t\tboxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Success Header */}\n\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\twidth: '64px',\n\t\t\t\t\t\t\t\t\theight: '64px',\n\t\t\t\t\t\t\t\t\tborderRadius: '50%',\n\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>‚úÖ</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<h2 style={{ margin: '0 0 8px 0', fontSize: '24px', color: '#1f2937' }}>\n\t\t\t\t\t\t\t\tAuthentication Successful!\n\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\tYour user token has been obtained and is ready to use.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Username Dropdown */}\n\t\t\t\t\t\t{usernameFromToken && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUsernameDropdown(!showUsernameDropdown)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tpadding: 0,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: showUsernameDropdown ? '12px' : 0,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '16px', color: '#374151' }}>Username</h3>\n\t\t\t\t\t\t\t\t\t{showUsernameDropdown ? (\n\t\t\t\t\t\t\t\t\t\t<FiChevronUp size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t<FiChevronDown size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{showUsernameDropdown && (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{usernameFromToken}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(usernameFromToken);\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('Username copied to clipboard!');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüìã Copy Username\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Token Display */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<h3 style={{ margin: '0 0 12px 0', fontSize: '16px', color: '#374151' }}>\n\t\t\t\t\t\t\t\tUser Access Token\n\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{userTokenForDisplay}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(userTokenForDisplay);\n\t\t\t\t\t\t\t\t\ttoastV8.success('Token copied to clipboard!');\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüìã Copy Token\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Next Steps Info */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#eff6ff',\n\t\t\t\t\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#1e40af', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t<strong>Next:</strong> Click \"Continue with Registration\" to proceed with your{' '}\n\t\t\t\t\t\t\t\t{config.displayName} device registration using this user token.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Continue Button */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleContinueAfterUserLogin}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\tbackground: '#10b981',\n\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tboxShadow: '0 2px 8px rgba(16, 185, 129, 0.3)',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tContinue with Registration ‚Üí\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</>\n\t);\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default UnifiedMFARegistrationFlowV8;\n"}},{"log":["info",[{"elements":[],"content":"React relies on hook dependencies to determine when to re-compute Effects.\nFailing to specify dependencies can result in Effects "},{"elements":["Emphasis"],"content":"not updating correctly"},{"elements":[],"content":" when state changes.\nThese \"stale closures\" are a common source of surprising bugs."}]]},{"log":["info",[{"elements":[],"content":"Unsafe fix: Add the missing dependency to the list."}]]},{"diff":{"dictionary":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\t\t\t\tprops.setIsLoading(false);\n\t\t\t}\n\t\t},\n\t\t[config.displayName, toastV8, config.deviceType]\n\t);\n\nexport default UnifiedMFARegistrationFlowV8;\n","ops":[{"diffOp":{"equal":{"range":[0,73]}}},{"equalLines":{"line_count":2329}},{"diffOp":{"equal":{"range":[73,113]}}},{"diffOp":{"equal":{"range":[113,144]}}},{"diffOp":{"insert":{"range":[144,163]}}},{"diffOp":{"equal":{"range":[163,164]}}},{"diffOp":{"equal":{"range":[164,169]}}},{"equalLines":{"line_count":526}},{"diffOp":{"equal":{"range":[169,215]}}}]}}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/UnifiedMFARegistrationFlowV8_Legacy.tsx"},"span":[64272,64283],"sourceCode":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\n * @description Unified MFA Registration Flow - Single component for all 6 device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Replace 6 device-specific flow components (SMS, Email, Mobile, WhatsApp, TOTP, FIDO2)\n * with a single configurable component using deviceFlowConfigs for device-specific behavior.\n *\n * Architecture:\n * - Configuration-driven using deviceFlowConfigs.ts\n * - Dynamic form rendering for simple devices (SMS, Email, WhatsApp)\n * - Custom components for complex devices (TOTP, FIDO2, Mobile)\n * - Integrates with MFACredentialContext and useWorkerToken hook\n * - Uses existing MFAFlowBaseV8 for 5-step framework\n *\n * @example\n * <UnifiedMFARegistrationFlowV8\n *   deviceType=\"SMS\"\n *   onSuccess={(result) => console.log('Device registered:', result.deviceId)}\n * />\n */\n\nimport * as React from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { FiChevronDown, FiChevronUp } from 'react-icons/fi';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { MFAHeaderV8 } from '@/v8/components/MFAHeaderV8';\nimport type { SearchableDropdownOption } from '@/v8/components/SearchableDropdownV8';\nimport { SearchableDropdownV8 } from '@/v8/components/SearchableDropdownV8';\nimport { SQLiteStatsDisplayV8 } from '@/v8/components/SQLiteStatsDisplayV8';\nimport { SuperSimpleApiDisplayV8 } from '@/v8/components/SuperSimpleApiDisplayV8';\nimport { UserLoginModalV8 } from '@/v8/components/UserLoginModalV8';\nimport { getDeviceConfig } from '@/v8/config/deviceFlowConfigs';\nimport type { DeviceConfigKey, DeviceRegistrationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport { PING_IDENTITY_COLORS } from '@/v8/constants/pingIdentityColors';\nimport { GlobalMFAProvider } from '@/v8/contexts/GlobalMFAContext';\nimport { MFACredentialProvider } from '@/v8/contexts/MFACredentialContext';\nimport { APIDocsStepV8 } from '@/v8/flows/shared/APIDocsStepV8';\nimport { SuccessStepV8 } from '@/v8/flows/shared/SuccessStepV8';\nimport { UserLoginStepV8 } from '@/v8/flows/shared/UserLoginStepV8';\nimport { useMFAPolicies } from '@/v8/hooks/useMFAPolicies';\nimport { useStepNavigationV8 } from '@/v8/hooks/useStepNavigationV8';\nimport { useUserSearch } from '@/v8/hooks/useUserSearch';\nimport { useWorkerToken } from '@/v8/hooks/useWorkerToken';\nimport { CredentialsServiceV8 } from '@/v8/services/credentialsServiceV8';\nimport { globalEnvironmentService } from '@/v8/services/globalEnvironmentService';\nimport { MfaAuthenticationServiceV8 } from '@/v8/services/mfaAuthenticationServiceV8';\nimport { type MFAFeatureFlag, MFAFeatureFlagsV8 } from '@/v8/services/mfaFeatureFlagsV8';\nimport MFAServiceV8_Legacy, { type RegisterDeviceParams } from '@/v8/services/mfaServiceV8_Legacy';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport type { TokenStatusInfo } from '@/v8/services/workerTokenStatusServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { ReturnTargetServiceV8U } from '@/v8u/services/returnTargetServiceV8U';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type MFAFlowBaseRenderProps, MFAFlowBaseV8 } from '../shared/MFAFlowBaseV8';\nimport type { DeviceAuthenticationPolicy, MFACredentials, MFAState } from '../shared/MFATypes';\nimport { UnifiedActivationStep } from './components/UnifiedActivationStep';\nimport { UnifiedDeviceRegistrationForm } from './components/UnifiedDeviceRegistrationForm';\nimport { UnifiedDeviceSelectionModal } from './components/UnifiedDeviceSelectionModal';\nimport { UnifiedSuccessStep } from './components/UnifiedSuccessStep';\nimport './UnifiedMFAFlow.css';\n\nconst MODULE_TAG = '[üîÑ UNIFIED-MFA-FLOW-V8]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedMFARegistrationFlowV8Props {\n\t/** Device type to render (optional - can be provided via navigation state) */\n\tdeviceType?: DeviceConfigKey;\n\n\t/** Optional initial credentials (for pre-filled forms) */\n\tinitialCredentials?: Partial<MFACredentials>;\n\n\t/** Optional callback when registration succeeds */\n\tonSuccess?: (result: DeviceRegistrationResult) => void;\n\n\t/** Optional callback when user cancels flow */\n\tonCancel?: () => void;\n\n\t/** Optional initial step (defaults to 0) */\n\tinitialStep?: number;\n\n\t/** Optional: Skip configuration step if already configured */\n\tskipConfiguration?: boolean;\n\n\t/** Optional: Force specific registration flow type */\n\tregistrationFlowType?: 'admin-active' | 'admin-activation' | 'user';\n}\n\n// ============================================================================\n// MFA FLOW SELECTION SCREEN\n// ============================================================================\n\ntype FlowMode = 'registration' | 'authentication';\n\n/** Map device types to their feature flags */\nconst DEVICE_FLAG_MAP: Record<DeviceConfigKey, MFAFeatureFlag> = {\n\tSMS: 'mfa_unified_sms',\n\tEMAIL: 'mfa_unified_email',\n\tMOBILE: 'mfa_unified_mobile',\n\tWHATSAPP: 'mfa_unified_whatsapp',\n\tTOTP: 'mfa_unified_totp',\n\tFIDO2: 'mfa_unified_fido2',\n};\n\nconst DEVICE_TYPES: { key: DeviceConfigKey; icon: string; name: string; description: string }[] = [\n\t{ key: 'SMS', icon: 'üì±', name: 'SMS', description: 'Receive OTP codes via text message' },\n\t{ key: 'EMAIL', icon: '‚úâÔ∏è', name: 'Email', description: 'Receive OTP codes via email' },\n\t{\n\t\tkey: 'TOTP',\n\t\ticon: 'üîê',\n\t\tname: 'Authenticator App (TOTP)',\n\t\tdescription: 'Use Google Authenticator, Authy, or similar',\n\t},\n\t{\n\t\tkey: 'MOBILE',\n\t\ticon: 'üì≤',\n\t\tname: 'Mobile Push',\n\t\tdescription: 'Receive push notifications on your phone',\n\t},\n\t{ key: 'WHATSAPP', icon: 'üí¨', name: 'WhatsApp', description: 'Receive OTP codes via WhatsApp' },\n\t{\n\t\tkey: 'FIDO2',\n\t\ticon: 'üîë',\n\t\tname: 'Security Key (FIDO2)',\n\t\tdescription: 'Use a hardware security key or passkey',\n\t},\n];\n\n/** Check if a device type is enabled via feature flags */\nconst isDeviceEnabled = (deviceKey: DeviceConfigKey): boolean => {\n\tconst flag = DEVICE_FLAG_MAP[deviceKey];\n\treturn MFAFeatureFlagsV8.isEnabled(flag);\n};\n\ninterface DeviceTypeSelectionScreenProps {\n\tonSelectDeviceType: (deviceType: DeviceConfigKey) => void;\n\tuserToken?: string | null;\n\tsetUserToken: (token: string | null) => void;\n}\n\nconst DeviceTypeSelectionScreen: React.FC<DeviceTypeSelectionScreenProps> = ({\n\tonSelectDeviceType,\n\tuserToken,\n\tsetUserToken,\n}) => {\n\tconst [flowMode, setFlowMode] = useState<FlowMode | null>(null);\n\tconst [environmentId, setEnvironmentId] = useState('');\n\tconst [username, setUsername] = useState('');\n\tconst [showDeviceSelectionModal, setShowDeviceSelectionModal] = useState(false);\n\tconst [showOTPModal, setShowOTPModal] = useState(false);\n\tconst [otpCode, setOtpCode] = useState('');\n\tconst [authenticationId, setAuthenticationId] = useState<string | null>(null);\n\tconst [selectedAuthDevice, setSelectedAuthDevice] = useState<{\n\t\tid: string;\n\t\ttype: string;\n\t\tnickname?: string;\n\t} | null>(null);\n\tconst [customLogoUrl, setCustomLogoUrl] = useState<string>('');\n\tconst [showAuthLoginModal, setShowAuthLoginModal] = useState(false);\n\tconst authEnvIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Load uploaded logo from localStorage on mount\n\tuseEffect(() => {\n\t\ttry {\n\t\t\tconst savedUpload = localStorage.getItem('custom-logo-upload');\n\t\t\tif (savedUpload) {\n\t\t\t\tconst uploadData = JSON.parse(savedUpload);\n\t\t\t\t// Handle both old format (objectUrl) and new format (base64Url)\n\t\t\t\tif (uploadData.base64Url) {\n\t\t\t\t\tsetCustomLogoUrl(uploadData.base64Url);\n\t\t\t\t} else if (uploadData.objectUrl) {\n\t\t\t\t\t// Old format - try to convert if possible, otherwise clear it\n\t\t\t\t\tconsole.warn('Old logo format detected - please re-upload your logo');\n\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load uploaded logo from localStorage:', error);\n\t\t\t// Clear corrupted data\n\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t}\n\t}, []);\n\n\t// Use worker token hook for token management\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Extract environment ID from worker token when available\n\tuseEffect(() => {\n\t\tconst extractEnvironmentId = async () => {\n\t\t\ttry {\n\t\t\t\tconst token = await workerTokenServiceV8.getToken();\n\t\t\t\tif (token && !environmentId) {\n\t\t\t\t\tconst parts = token.split('.');\n\t\t\t\t\tif (parts.length === 3) {\n\t\t\t\t\t\tconst payload = JSON.parse(atob(parts[1]));\n\t\t\t\t\t\tif (payload.environmentId) {\n\t\t\t\t\t\t\tsetEnvironmentId(payload.environmentId);\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`${MODULE_TAG} Environment ID extracted from worker token:`,\n\t\t\t\t\t\t\t\tpayload.environmentId\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Failed to extract environment ID from worker token:`, error);\n\t\t\t}\n\t\t};\n\n\t\textractEnvironmentId();\n\t}, [environmentId]);\n\n\tconst hasWorkerToken = workerToken.tokenStatus.isValid;\n\n\t// Use user search hook for user fetching and search\n\tconst {\n\t\tusers,\n\t\tisLoading: isLoadingUsers,\n\t\tsetSearchQuery,\n\t} = useUserSearch({\n\t\tenvironmentId,\n\t\ttokenValid: workerToken.tokenStatus.isValid,\n\t\tmaxPages: 100,\n\t\tuseCache: true,\n\t});\n\tconst tokenStatus = workerToken.tokenStatus;\n\n\t// Debug: Log users type to understand the issue\n\tuseEffect(() => {\n\t\tconsole.log(`${MODULE_TAG} users type check:`, {\n\t\t\tusers,\n\t\t\tisArray: Array.isArray(users),\n\t\t\ttype: typeof users,\n\t\t\tconstructor: users?.constructor?.name,\n\t\t});\n\t}, [users]);\n\n\t// Load Environment ID and username from global services on mount\n\tuseEffect(() => {\n\t\t// Initialize the service first to load from localStorage\n\t\tglobalEnvironmentService.initialize();\n\t\tconst savedEnvId = globalEnvironmentService.getEnvironmentId();\n\t\tif (savedEnvId) {\n\t\t\tsetEnvironmentId(savedEnvId);\n\t\t}\n\n\t\t// Load username from localStorage\n\t\tconst savedUsername = localStorage.getItem('mfa_unified_username');\n\t\tif (savedUsername) {\n\t\t\tsetUsername(savedUsername);\n\t\t}\n\t}, []);\n\n\t// Use MFA policies hook\n\tconst {\n\t\tpolicies,\n\t\tselectedPolicy,\n\t\tisLoading: isPoliciesLoading,\n\t\terror: policiesError,\n\t\tselectPolicy,\n\t\tdefaultPolicy,\n\t} = useMFAPolicies({\n\t\tenvironmentId,\n\t\ttokenIsValid: tokenStatus.isValid,\n\t\tautoLoad: true,\n\t\tautoSelectSingle: true,\n\t});\n\n\tconst selectedPolicyRef = useRef<DeviceAuthenticationPolicy | null>(null);\n\tuseEffect(() => {\n\t\tselectedPolicyRef.current = selectedPolicy ?? null;\n\t}, [selectedPolicy]);\n\n\tconst isPolicyDeviceEnabled = useCallback(\n\t\t(policy: DeviceAuthenticationPolicy | null, key: string) => {\n\t\t\tconst deviceConfig = policy?.[key] as { enabled?: boolean } | undefined;\n\t\t\treturn !!deviceConfig?.enabled;\n\t\t},\n\t\t[]\n\t);\n\n\tconst policyOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tpolicies.map((policy) => ({\n\t\t\t\tvalue: policy.id,\n\t\t\t\tlabel: policy.name,\n\t\t\t\t...(policy.default ? { secondaryLabel: '(Default)' } : {}),\n\t\t\t})),\n\t\t[policies]\n\t);\n\n\tconst userOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tArray.from(\n\t\t\t\tnew Map(\n\t\t\t\t\t(Array.isArray(users) ? users : []).map((user) => [\n\t\t\t\t\t\tuser.username,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvalue: user.username,\n\t\t\t\t\t\t\tlabel: user.username,\n\t\t\t\t\t\t\t...(user.email ? { secondaryLabel: user.email } : {}),\n\t\t\t\t\t\t} as SearchableDropdownOption,\n\t\t\t\t\t])\n\t\t\t\t).values()\n\t\t\t),\n\t\t[users]\n\t);\n\n\t// Auto-select default policy when policies load\n\tuseEffect(() => {\n\t\tif (defaultPolicy && !selectedPolicy) {\n\t\t\tselectPolicy(defaultPolicy.id);\n\t\t}\n\t}, [defaultPolicy, selectedPolicy, selectPolicy]);\n\n\t// Sync environment ID to global service and CredentialsServiceV8 when it changes\n\tuseEffect(() => {\n\t\tif (environmentId) {\n\t\t\tglobalEnvironmentService.setEnvironmentId(environmentId);\n\t\t\tlocalStorage.setItem('mfa_environmentId', environmentId);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tenvironmentId,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId, username: currentCreds.username }\n\t\t\t}));\n\t\t}\n\t}, [environmentId]);\n\n\t// Save username to localStorage and CredentialsServiceV8 when it changes\n\t// This ensures MFAFlowBase can read the username from its expected storage location\n\tuseEffect(() => {\n\t\tif (username) {\n\t\t\tlocalStorage.setItem('mfa_unified_username', username);\n\t\t\tlocalStorage.setItem('mfa_username', username);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tusername,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId: currentCreds.environmentId, username }\n\t\t\t}));\n\t\t}\n\t}, [username]);\n\n\t// Handle device selection for authentication\n\tconst handleDeviceSelectForAuthentication = async (device: {\n\t\tid: string;\n\t\ttype: string;\n\t\tdeviceName?: string;\n\t\tnickname?: string;\n\t}) => {\n\t\tconsole.log(`${MODULE_TAG} Selected device for authentication:`, device);\n\t\tsetShowDeviceSelectionModal(false);\n\t\tsetSelectedAuthDevice(device);\n\n\t\tconst policyId = selectedPolicy?.id;\n\t\tif (!policyId) {\n\t\t\ttoastV8.error('Please select an MFA Policy first');\n\t\t\treturn;\n\t\t}\n\n\t\t// Determine flow type and token\n\t\t// Admin flows should use worker tokens, not require user tokens\n\t\tconst flowType = userToken ? 'user' : 'admin';\n\t\tconst effectiveUserToken = flowType === 'user' ? userToken : undefined;\n\n\t\t// For admin flow, check if we have a valid worker token before proceeding\n\t\tif (flowType === 'admin' && !hasWorkerToken) {\n\t\t\ttoastV8.error('Admin flow requires a valid worker token. Please generate a worker token first.');\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\t// Initialize authentication with appropriate token\n\t\t\tconst response = await MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\tenvironmentId,\n\t\t\t\tusername: username.trim(),\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t\tdeviceId: device.id,\n\t\t\t\tregion: 'na',\n\t\t\t\ttokenType: flowType,\n\t\t\t\t...(effectiveUserToken && { userToken: effectiveUserToken }),\n\t\t\t});\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth initialized - full response:`, response);\n\t\t\tsetAuthenticationId(response.id);\n\n\t\t\tconst status = (response.status || '').toUpperCase();\n\t\t\tconst nextStep = (response.nextStep || '').toUpperCase();\n\t\t\tconst links = response._links as Record<string, { href?: string }> | undefined;\n\t\t\tconst hasOtpLink = !!(\n\t\t\t\tlinks &&\n\t\t\t\t(links.otp || links['otp.check'] || (links as Record<string, unknown>)['checkOtp'])\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth status:`, {\n\t\t\t\tstatus,\n\t\t\t\tnextStep,\n\t\t\t\thasOtpLink,\n\t\t\t\tdeviceType: device.type,\n\t\t\t});\n\n\t\t\t// Show appropriate UI based on response (normalize status/nextStep for PingOne variants)\n\t\t\tif (status === 'OTP_REQUIRED' || nextStep === 'OTP_REQUIRED' || hasOtpLink) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Opening OTP modal for device:`, device.type);\n\t\t\t\tsetShowOTPModal(true);\n\t\t\t\ttoastV8.success(`Verification code sent to your ${device.type} device`);\n\t\t\t} else if (status === 'ASSERTION_REQUIRED' || nextStep === 'ASSERTION_REQUIRED') {\n\t\t\t\tconsole.log(`${MODULE_TAG} FIDO2 assertion required`);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'FIDO2 authentication required. Please use /v8/mfa-config for FIDO2 authentication.'\n\t\t\t\t);\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'PUSH_CONFIRMATION_REQUIRED' ||\n\t\t\t\tnextStep === 'PUSH_CONFIRMATION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Push confirmation required`);\n\t\t\t\ttoastV8.success('Push notification sent! Please approve on your mobile device.');\n\t\t\t\ttoastV8.info('Complete authentication at /v8/mfa-config for push polling.');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (status === 'COMPLETED') {\n\t\t\t\ttoastV8.success('Authentication completed successfully!');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'DEVICE_SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'DEVICE_SELECTION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Device selection required - showing modal again`);\n\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t} else {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Unexpected authentication status:`, {\n\t\t\t\t\tstatus,\n\t\t\t\t\tnextStep,\n\t\t\t\t\tresponse,\n\t\t\t\t});\n\t\t\t\ttoastV8.info(`Authentication status: ${status || nextStep || 'UNKNOWN'}`);\n\t\t\t\t// Stay in authentication flow so user can try another device\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to initialize authentication:`, error);\n\n\t\t\t// Enhanced error handling for NO_USABLE_DEVICES\n\t\t\tlet errorMessage = 'Authentication failed: ';\n\t\t\tif (error instanceof Error) {\n\t\t\t\tconst errorStr = error.message.toLowerCase();\n\n\t\t\t\t// Check for NO_USABLE_DEVICES or device availability errors\n\t\t\t\tif (\n\t\t\t\t\terrorStr.includes('no usable devices') ||\n\t\t\t\t\terrorStr.includes('too many') ||\n\t\t\t\t\terrorStr.includes('cooldown') ||\n\t\t\t\t\terrorStr.includes('blocked')\n\t\t\t\t) {\n\t\t\t\t\terrorMessage = '‚ö†Ô∏è Device Temporarily Unavailable\\n\\n';\n\n\t\t\t\t\tif (errorStr.includes('cooldown') || errorStr.includes('too many')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Too many notifications have been sent to this device. It is temporarily in cooldown. ';\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Please wait a few minutes and try again, or select a different device.';\n\t\t\t\t\t} else if (errorStr.includes('blocked')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'This device has been blocked. Please contact your administrator or use a different device.';\n\t\t\t\t\t} else {\n\t\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terrorMessage += 'Unknown error';\n\t\t\t}\n\n\t\t\ttoastV8.error(errorMessage, { duration: 8000 });\n\t\t\t// Do NOT set flowMode(null) - keep user in authentication flow so they can retry or select another device\n\t\t}\n\t};\n\n\t// Handle OTP verification\n\tconst handleVerifyOTP = async () => {\n\t\tif (!authenticationId || !selectedAuthDevice) {\n\t\t\ttoastV8.error('Authentication session not found');\n\t\t\treturn;\n\t\t}\n\n\t\tif (otpCode.length !== 6) {\n\t\t\ttoastV8.error('Please enter a 6-digit code');\n\t\t\treturn;\n\t\t}\n\n\t\t// Get worker token for API call\n\t\tconst workerTokenForOTP = await workerTokenServiceV8.getToken();\n\n\t\tconsole.log(`${MODULE_TAG} OTP verification debug:`, {\n\t\t\tenvironmentId,\n\t\t\tusername: username.trim(),\n\t\t\tauthenticationId,\n\t\t\totpCode,\n\t\t\thasEnvironmentId: !!environmentId,\n\t\t\tenvIdLength: environmentId?.length,\n\t\t\thasWorkerToken: !!workerTokenForOTP,\n\t\t\tworkerTokenLength: workerTokenForOTP?.length,\n\t\t});\n\n\t\ttry {\n\t\t\t// Use backend proxy to avoid CORS issues\n\t\t\tconst response = await fetch('/api/pingone/mfa/validate-otp-for-device', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tenvironmentId,\n\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\tdeviceAuthId: authenticationId,\n\t\t\t\t\totp: otpCode,\n\t\t\t\t\tregion: 'na',\n\t\t\t\t\tworkerToken: workerTokenForOTP,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\n\t\t\t\tthrow new Error(errorData.error || errorData.message || `HTTP ${response.status}`);\n\t\t\t}\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.status === 'COMPLETED' || result.status === 'completed') {\n\t\t\t\ttoastV8.success('‚úÖ Authentication completed successfully!');\n\t\t\t\tsetShowOTPModal(false);\n\t\t\t\tsetFlowMode(null);\n\t\t\t\tsetOtpCode('');\n\t\t\t} else {\n\t\t\t\ttoastV8.error('Invalid code. Please try again.');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} OTP verification failed:`, error);\n\t\t\ttoastV8.error(\n\t\t\t\t`Verification failed: ${error instanceof Error ? error.message : 'Unknown error'}`\n\t\t\t);\n\t\t}\n\t};\n\n\t// Step 1: Choose Registration or Authentication\n\tif (!flowMode) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '12px' }}>\n\t\t\t\t\t{/* Header */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tboxShadow: '0 4px 12px rgba(239, 68, 68, 0.2)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h1\n\t\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîê MFA Unified Flow\n\t\t\t\t\t\t</h1>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tChoose what you want to do with MFA devices.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Configuration Section */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 12px 0',\n\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfiguration\n\t\t\t\t\t\t</h2>\n\n\t\t\t\t\t\t{/* Custom Logo URL */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-url\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[800],\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüé® Custom Logo URL (Optional)\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tDisplay a custom logo in the OTP verification modal\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t{/* URL Input */}\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tid=\"custom-logo-url\"\n\t\t\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\t\t\tvalue={customLogoUrl}\n\t\t\t\t\t\t\t\tonChange={(e) => setCustomLogoUrl(e.target.value)}\n\t\t\t\t\t\t\t\tplaceholder=\"https://example.com/logo.png\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\tpadding: '10px 14px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[900],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = `0 0 0 3px ${PING_IDENTITY_COLORS.primary[200]}`;\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.neutral[300];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* File Upload Section */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '13px', color: PING_IDENTITY_COLORS.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\tOR\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"file\"\n\t\t\t\t\t\t\t\t\tid=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\taccept=\"image/*\"\n\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\tconst file = e.target.files?.[0];\n\t\t\t\t\t\t\t\t\t\tif (!file) return;\n\n\t\t\t\t\t\t\t\t\t\t// Validate file type (images only)\n\t\t\t\t\t\t\t\t\t\tif (!file.type.startsWith('image/')) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Please select a logo file (JPG, PNG, etc.)');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Validate file size (max 5MB)\n\t\t\t\t\t\t\t\t\t\tif (file.size > 5 * 1024 * 1024) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('File size must be less than 5MB');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Convert file to base64 for persistence\n\t\t\t\t\t\t\t\t\t\tconst reader = new FileReader();\n\t\t\t\t\t\t\t\t\t\treader.onload = (event) => {\n\t\t\t\t\t\t\t\t\t\t\tconst base64Url = event.target?.result as string;\n\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl(base64Url);\n\n\t\t\t\t\t\t\t\t\t\t\t// Store base64 data for persistence\n\t\t\t\t\t\t\t\t\t\t\tconst uploadData = {\n\t\t\t\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\t\t\t\tbase64Url: base64Url,\n\t\t\t\t\t\t\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\t\t\t// Save to localStorage for persistence\n\t\t\t\t\t\t\t\t\t\t\tlocalStorage.setItem('custom-logo-upload', JSON.stringify(uploadData));\n\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.success(`Logo uploaded: ${file.name}`);\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.onerror = () => {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to read uploaded file');\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.readAsDataURL(file);\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'none' }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.primary[500],\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.primary[600]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '500',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[700];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìÅ Upload Logo File\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[500],\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tJPG, PNG, GIF (max 5MB)\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{customLogoUrl && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.neutral[50],\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tLogo Preview:\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\talt=\"Custom logo\"\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonError={() => {\n\t\t\t\t\t\t\t\t\t\t\t// Handle broken image URLs\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Failed to load custom logo URL');\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl('');\n\t\t\t\t\t\t\t\t\t\t\t\t// Clear uploaded file from localStorage\n\t\t\t\t\t\t\t\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.accent.pingRed[500],\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.accent.pingRed[600]}`,\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[600];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[500];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRemove Logo\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Environment ID - Hide when worker token is available */}\n\t\t\t\t\t\t{!hasWorkerToken && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"env-id\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tEnvironment ID\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"env-id\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setEnvironmentId(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* SQLite Database Stats */}\n\t\t\t\t\t\t{environmentId && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<SQLiteStatsDisplayV8\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tcompact={false}\n\t\t\t\t\t\t\t\t\trefreshInterval={30}\n\t\t\t\t\t\t\t\t\tshowRefreshButton={true}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Username */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUsername\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{environmentId && tokenStatus.isValid ? (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\toptions={userOptions}\n\t\t\t\t\t\t\t\t\tonChange={setUsername}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Type to search across 16,000+ users...\"\n\t\t\t\t\t\t\t\t\tisLoading={isLoadingUsers}\n\t\t\t\t\t\t\t\t\tonSearchChange={setSearchQuery}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setUsername(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* MFA Policy Dropdown */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"mfa-policy\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tMFA Policy\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{isPoliciesLoading ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tLoading policies...\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policiesError ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#ef4444', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tError loading policies: {policiesError}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policies.length === 0 ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tNo MFA policies found. Please check your environment ID and worker token.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"mfa-policy\"\n\t\t\t\t\t\t\t\t\tvalue={selectedPolicy?.id || ''}\n\t\t\t\t\t\t\t\t\toptions={policyOptions}\n\t\t\t\t\t\t\t\t\tonChange={selectPolicy}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Select an MFA policy...\"\n\t\t\t\t\t\t\t\t\tisLoading={isPoliciesLoading}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tSelect the MFA policy to use for device registration\n\t\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t\t{/* Policy Summary - Collapsible */}\n\t\t\t\t\t\t\t{selectedPolicy && (\n\t\t\t\t\t\t\t\t<details\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<summary\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\tuserSelect: 'none',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüìã Policy Details\n\t\t\t\t\t\t\t\t\t</summary>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '12px', fontSize: '13px', color: '#4b5563' }}>\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Policy Name:</strong> {String(selectedPolicy.name)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedPolicy.default && (\n\t\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px', color: '#059669' }}>\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>‚úì Default Policy</strong>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Enabled Devices:</strong>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '6px' }}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'sms') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì± SMS\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'email') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t‚úâÔ∏è Email\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'totp') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîê TOTP\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'fido2') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîë FIDO2\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'mobile') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì≤ Mobile\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'voice') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüìû Voice\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</details>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Worker Token Status */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t\tpaddingRight: '16px',\n\t\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={setEnvironmentId}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* User Token Status */}\n\t\t\t\t\t\t\t{userToken && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\t'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05))',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #10b981',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '20px' }}>üë§</span>\n\t\t\t\t\t\t\t\t\t\t<strong style={{ color: '#047857', fontSize: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t\tUser Token Active\n\t\t\t\t\t\t\t\t\t\t</strong>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: '14px', color: '#059669', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t\t‚úì User authentication token available\n\t\t\t\t\t\t\t\t\t\t<br />‚úì Ready for User Flow device registration\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Flow Mode Selection */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',\n\t\t\t\t\t\t\tgap: '16px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Registration Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => setFlowMode('registration')}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>‚ûï</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#047857',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Registration\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tRegister a new MFA device for a user. Create SMS, Email, TOTP, Mobile Push,\n\t\t\t\t\t\t\t\t\t\tWhatsApp, or FIDO2 devices.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t{/* Authentication Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tif (!userToken) {\n\t\t\t\t\t\t\t\t\tsetShowAuthLoginModal(true);\n\t\t\t\t\t\t\t\t\ttoastV8.info('üîê Please complete user login before device authentication.', {\n\t\t\t\t\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-4px)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 8px 24px rgba(59, 130, 246, 0.2)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>üîì</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#1d4ed8',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Authentication\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tAuthenticate using an existing MFA device. Verify user identity with OTP, push\n\t\t\t\t\t\t\t\t\t\tnotification, or security key.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{showAuthLoginModal && (\n\t\t\t\t\t<UserLoginModalV8\n\t\t\t\t\t\tisOpen={showAuthLoginModal}\n\t\t\t\t\t\tonClose={() => setShowAuthLoginModal(false)}\n\t\t\t\t\t\tonTokenReceived={(token) => {\n\t\t\t\t\t\t\tsetUserToken(token);\n\t\t\t\t\t\t\tsetShowAuthLoginModal(false);\n\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tenvironmentId={authEnvIdForModal}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</>\n\t\t);\n\t}\n\n\t// Authentication flow - dedicated view (device selection + OTP modals only; no registration grid)\n\tif (flowMode === 'authentication') {\n\t\treturn (\n\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\tsetSelectedAuthDevice(null);\n\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t‚Üê Back\n\t\t\t\t\t</button>\n\t\t\t\t\t<h1\n\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t>\n\t\t\t\t\t\tüîì Device Authentication\n\t\t\t\t\t</h1>\n\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\t{selectedAuthDevice && !showOTPModal\n\t\t\t\t\t\t\t? `Authenticating with ${selectedAuthDevice.type} ‚Äî enter the code when prompted.`\n\t\t\t\t\t\t\t: `Select an MFA device to authenticate for ${username || 'the user'}`}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t\t{!showDeviceSelectionModal && !showOTPModal && (\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowDeviceSelectionModal(true)}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tSelect MFA device\n\t\t\t\t\t</button>\n\t\t\t\t)}\n\t\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\t\tonClose={() => {\n\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t// Keep flowMode so user stays in auth flow; only clear if they click Back\n\t\t\t\t\t}}\n\t\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\t\tusername={username}\n\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t/>\n\t\t\t\t{showOTPModal && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.6)',\n\t\t\t\t\t\t\tbackdropFilter: 'blur(4px)',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t\t\tanimation: 'fadeIn 0.2s ease-out',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t{`\n\t\t\t\t\t\t\t@keyframes fadeIn {\n\t\t\t\t\t\t\t\tfrom { opacity: 0; }\n\t\t\t\t\t\t\t\tto { opacity: 1; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes slideUp {\n\t\t\t\t\t\t\t\tfrom { \n\t\t\t\t\t\t\t\t\topacity: 0;\n\t\t\t\t\t\t\t\t\ttransform: translateY(20px); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tto { \n\t\t\t\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t\t\t\t\ttransform: translateY(0); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes pulse {\n\t\t\t\t\t\t\t\t0%, 100% { opacity: 1; }\n\t\t\t\t\t\t\t\t50% { opacity: 0.5; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`}\n\t\t\t\t\t\t</style>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\tborderRadius: '24px',\n\t\t\t\t\t\t\t\tpadding: '48px 40px',\n\t\t\t\t\t\t\t\tmaxWidth: '480px',\n\t\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\t\tboxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',\n\t\t\t\t\t\t\t\tanimation: 'slideUp 0.3s ease-out',\n\t\t\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Logo Area */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '32px' }}>\n\t\t\t\t\t\t\t\t{customLogoUrl ? (\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\t\talt=\"Organization logo\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '120px',\n\t\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonError={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\t// Fallback to default icon if image fails to load\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.display = 'none';\n\t\t\t\t\t\t\t\t\t\t\t\tconst fallback = document.createElement('div');\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.style.cssText = `\n\t\t\t\t\t\t\t\t\t\t\t\twidth: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\theight: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: 0 auto 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: center;\n\t\t\t\t\t\t\t\t\t\t\t\tjustifyContent: center;\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: 36px;\n\t\t\t\t\t\t\t\t\t\t\t\tboxShadow: 0 10px 25px rgba(102, 126, 234, 0.3);\n\t\t\t\t\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.textContent = 'üîê';\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.parentElement!.appendChild(fallback);\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\theight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto 20px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '20px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '36px',\n\t\t\t\t\t\t\t\t\t\t\tboxShadow: '0 10px 25px rgba(102, 126, 234, 0.3)',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüîê\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tVerification Code\n\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\tEnter the 6-digit code sent to your <strong>{selectedAuthDevice?.type}</strong>{' '}\n\t\t\t\t\t\t\t\t\tdevice\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* OTP Input */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\t\t\tplaceholder=\"‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢\"\n\t\t\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tletterSpacing: '12px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow: otpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{otpCode.length > 0 && otpCode.length < 6 && (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\t\tanimation: 'pulse 2s ease-in-out infinite',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{6 - otpCode.length} more digit{6 - otpCode.length !== 1 ? 's' : ''} needed\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Resend Code Button */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={async () => {\n\t\t\t\t\t\t\t\t\t\tif (!selectedAuthDevice || !authenticationId) return;\n\t\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.info('Resending verification code...');\n\t\t\t\t\t\t\t\t\t\t\t// Re-initialize authentication to resend code\n\t\t\t\t\t\t\t\t\t\t\tconst response =\n\t\t\t\t\t\t\t\t\t\t\t\tawait MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\t\t\t\t\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\t\t\t\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicy?.id || '',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceId: selectedAuthDevice.id,\n\t\t\t\t\t\t\t\t\t\t\t\t\tregion: 'na',\n\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tif (response.status?.toUpperCase() === 'OTP_REQUIRED') {\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('New code sent to your device!');\n\t\t\t\t\t\t\t\t\t\t\t\tsetAuthenticationId(response.id);\n\t\t\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to resend code');\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Resend error:', error);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tcolor: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'transparent';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚Üª Resend Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Action Buttons */}\n\t\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#d1d5db';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f9fafb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'white';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6\n\t\t\t\t\t\t\t\t\t\t\t\t? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '#d1d5db',\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (otpCode.length === 6) {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚úì Verify Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Help Text */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<strong style={{ color: '#111827' }}>Didn't receive the code?</strong>\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\tCheck your spam folder or click \"Resend Code\" above\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t);\n\t}\n\n\t// Registration flow - show device type selection cards\n\treturn (\n\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t{/* Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #10b981 0%, #047857 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => setFlowMode(null)}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t‚Üê Back\n\t\t\t\t</button>\n\t\t\t\t<h1 style={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}>\n\t\t\t\t\t‚ûï Register MFA Device\n\t\t\t\t</h1>\n\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\tSelect a device type to register for {username || 'the user'}\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Device Type Cards */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',\n\t\t\t\t\tgap: '16px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t{DEVICE_TYPES.map((device) => {\n\t\t\t\t\tconst enabled = isDeviceEnabled(device.key);\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tkey={device.key}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => enabled && onSelectDeviceType(device.key)}\n\t\t\t\t\t\t\tdisabled={!enabled}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tbackground: enabled ? '#ffffff' : '#f9fafb',\n\t\t\t\t\t\t\t\tborder: `2px solid ${enabled ? '#e5e7eb' : '#f3f4f6'}`,\n\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\tcursor: enabled ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\topacity: enabled ? 1 : 0.5,\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#10b981';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ecfdf5';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>{device.icon}</span>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{device.name}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280' }}>{device.description}</p>\n\t\t\t\t\t\t\t{!enabled && (\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '12px', color: '#9ca3af' }}>\n\t\t\t\t\t\t\t\t\t(Not enabled)\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</div>\n\n\t\t\t{/* Device Selection Modal for Authentication */}\n\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t}}\n\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\tusername={username}\n\t\t\t\tenvironmentId={environmentId}\n\t\t\t/>\n\n\t\t\t{/* OTP Modal for Authentication */}\n\t\t\t{showOTPModal && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '400px',\n\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\tboxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '600' }}>\n\t\t\t\t\t\t\tEnter Verification Code\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '0 0 20px 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tCheck your {selectedAuthDevice?.type} device for the code\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\tplaceholder=\"000000\"\n\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 16px',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\tletterSpacing: '8px',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tmarginBottom: '20px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: otpCode.length === 6 ? '#3b82f6' : '#9ca3af',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tVerify\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Wrapper Component\n *\n * Wraps the content with MFACredentialProvider to provide global credential state\n */\nexport const UnifiedMFARegistrationFlowV8: React.FC<UnifiedMFARegistrationFlowV8Props> = (\n\tprops\n) => {\n\tconst location = useLocation();\n\n\t// Get device type from props or location state (can be undefined)\n\tconst initialDeviceType =\n\t\tprops.deviceType || (location.state as { deviceType?: DeviceConfigKey })?.deviceType;\n\n\t// State for selected device type (allows user to select if not provided)\n\tconst [selectedDeviceType, setSelectedDeviceType] = useState<DeviceConfigKey | undefined>(\n\t\tinitialDeviceType\n\t);\n\n\t// User token state for OAuth authentication (User Flow)\n\tconst [userToken, setUserToken] = useState<string | null>(() => {\n\t\t// Check if we already have a user token from previous OAuth flow\n\t\tconst savedCreds = CredentialsServiceV8.loadCredentials('user-login-v8', {\n\t\t\tflowKey: 'user-login-v8',\n\t\t\tflowType: 'oauth',\n\t\t\tincludeClientSecret: false,\n\t\t\tincludeRedirectUri: false,\n\t\t\tincludeLogoutUri: false,\n\t\t\tincludeScopes: false,\n\t\t});\n\t\treturn savedCreds?.accessToken || null;\n\t});\n\n\t// If no device type selected, show device type selection screen\n\tif (!selectedDeviceType) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<MFAHeaderV8\n\t\t\t\t\ttitle=\"MFA Unified Flow\"\n\t\t\t\t\tdescription=\"Register or authenticate MFA devices\"\n\t\t\t\t\tversionTag=\"V8\"\n\t\t\t\t\tcurrentPage=\"registration\"\n\t\t\t\t\tshowBackToMain={true}\n\t\t\t\t\theaderColor=\"pingRed\"\n\t\t\t\t/>\n\t\t\t\t<GlobalMFAProvider>\n\t\t\t\t\t<MFACredentialProvider>\n\t\t\t\t\t\t<DeviceTypeSelectionScreen\n\t\t\t\t\t\t\tonSelectDeviceType={setSelectedDeviceType}\n\t\t\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</MFACredentialProvider>\n\t\t\t\t</GlobalMFAProvider>\n\t\t\t\t{/* API display (bottom of page) */}\n\t\t\t\t<div style={{ marginTop: '24px' }}>\n\t\t\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\t\t\t\t</div>\n\t\t\t</>\n\t\t);\n\t}\n\n\treturn (\n\t\t<GlobalMFAProvider>\n\t\t\t<MFACredentialProvider>\n\t\t\t\t<UnifiedMFARegistrationFlowContent\n\t\t\t\t\t{...props}\n\t\t\t\t\tdeviceType={selectedDeviceType}\n\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t/>\n\t\t\t</MFACredentialProvider>\n\t\t</GlobalMFAProvider>\n\t);\n};\n\n// ============================================================================\n// CONTENT COMPONENT (MAIN LOGIC)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Content Component\n *\n * Contains the actual flow logic and integrates with:\n * - MFACredentialContext (global credential state)\n * - useWorkerToken hook (token status and auto-refresh)\n * - deviceFlowConfigs (device-specific configuration)\n * - MFAFlowBaseV8 (5-step framework)\n */\nconst UnifiedMFARegistrationFlowContent: React.FC<\n\tRequired<Pick<UnifiedMFARegistrationFlowV8Props, 'deviceType'>> &\n\t\tOmit<UnifiedMFARegistrationFlowV8Props, 'deviceType'> & {\n\t\t\tuserToken: string | null;\n\t\t\tsetUserToken: (token: string | null) => void;\n\t\t}\n> = ({ deviceType, onCancel, userToken, setUserToken }) => {\n\t// ========================================================================\n\t// CONFIGURATION\n\t// ========================================================================\n\n\t// React Router navigation\n\tconst navigate = useNavigate();\n\n\t// Load device-specific configuration\n\tconst config = useMemo(() => {\n\t\treturn getDeviceConfig(deviceType);\n\t}, [deviceType]);\n\n\t// ========================================================================\n\t// USER FLOW OAUTH STATE\n\t// ========================================================================\n\n\t// State for User Login Modal (OAuth authentication for User Flow)\n\tconst [showUserLoginModal, setShowUserLoginModal] = useState(false);\n\tconst [showUserTokenSuccess, setShowUserTokenSuccess] = useState(false);\n\tconst [userTokenForDisplay, setUserTokenForDisplay] = useState<string>('');\n\tconst [usernameFromToken, setUsernameFromToken] = useState<string>('');\n\tconst [showUsernameDropdown, setShowUsernameDropdown] = useState(false);\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\tconst envIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Pending registration data while waiting for OAuth (use ref to avoid stale closure)\n\tconst pendingRegistrationRef = useRef<{\n\t\tdeviceType: DeviceConfigKey;\n\t\tfields: Record<string, string>;\n\t\tflowType: string;\n\t\tprops: MFAFlowBaseRenderProps;\n\t} | null>(null);\n\n\t// Worker token state for validation in registration flow\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Detect OAuth callback and re-open modal if needed\n\tuseEffect(() => {\n\t\tconst urlParams = new URLSearchParams(window.location.search);\n\t\tconst code = urlParams.get('code');\n\t\tconst hasStoredState = sessionStorage.getItem('user_login_state_v8');\n\n\t\t// If we have OAuth callback params and stored state, re-open the modal to process callback\n\t\t// But only if we don't already have a user token (to prevent reopening after silent auth)\n\t\tif (code && hasStoredState && !showUserLoginModal && !userToken) {\n\t\t\tconsole.log('[UNIFIED-FLOW] OAuth callback detected - re-opening modal to process');\n\t\t\tsetShowUserLoginModal(true);\n\t\t}\n\t}, [showUserLoginModal, userToken]);\n\n\t// ========================================================================\n\t// STEP VALIDATION\n\t// ========================================================================\n\n\t/**\n\t * Validate Step 0 (Configuration)\n\t */\n\tconst validateStep0 = useCallback(\n\t\t(\n\t\t\tcredentials: MFACredentials,\n\t\t\ttoken: TokenStatusInfo,\n\t\t\tnavigation: ReturnType<typeof useStepNavigationV8>\n\t\t) => {\n\t\t\t// Always check for valid worker token (required for MFA device operations)\n\t\t\tif (!token.isValid) {\n\t\t\t\tnavigation.setValidationErrors(['Invalid or expired worker token']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Check required configuration\n\t\t\tif (!credentials.environmentId || !credentials.username) {\n\t\t\t\tnavigation.setValidationErrors(['Environment ID and Username are required']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\t\t[]\n\t);\n\n\t// ========================================================================\n\t// STEP RENDERERS\n\t// ========================================================================\n\n\t/**\n\t * Perform device registration API call (with token already available)\n\t */\n\tconst performRegistrationWithToken = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string,\n\t\t\ttoken?: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== PERFORM REGISTRATION WITH TOKEN =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Token:', token ? `Present (${token.length} chars)` : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setIsLoading available:', typeof props.setIsLoading);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setCredentials available:', typeof props.setCredentials);\n\n\t\t\ttry {\n\t\t\t\tprops.setIsLoading(true);\n\n\t\t\t\t// Update credentials with device fields and user token if provided\n\t\t\t\tprops.setCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tflowType, // Store flowType so activation step knows if OTP is required\n\t\t\t\t\t...fields,\n\t\t\t\t\t...(flowType === 'user' && token\n\t\t\t\t\t\t? { userToken: token, tokenType: 'user' }\n\t\t\t\t\t\t: flowType !== 'user'\n\t\t\t\t\t\t\t? { tokenType: 'worker' }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t}));\n\n\t\t\t\t// Register the device using proper API call\n\t\t\t\t// CRITICAL: Flow-specific device status\n\t\t\t\t// - Admin flow: ACTIVE (no OTP sent, device ready immediately)\n\t\t\t\t// - Admin ACTIVATION_REQUIRED: ACTIVATION_REQUIRED (sends OTP for admin to activate)\n\t\t\t\t// - User flow: ACTIVATION_REQUIRED (sends OTP for user to activate)\n\t\t\t\t// - FIDO2: ACTIVE (WebAuthn verification happens during registration)\n\t\t\t\tlet deviceStatus: 'ACTIVE' | 'ACTIVATION_REQUIRED' | undefined;\n\n\t\t\t\t// Determine device status based on flow type (applies to all device types including FIDO2)\n\t\t\t\tif (flowType === 'admin-active') {\n\t\t\t\t\tdeviceStatus = 'ACTIVE';\n\t\t\t\t} else if (flowType === 'admin-activation') {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED';\n\t\t\t\t} else {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED'; // user flow\n\t\t\t\t}\n\n\t\t\t\t// Special note for FIDO2: WebAuthn verification proves device works,\n\t\t\t\t// but we still respect the flow type for status determination\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t'[UNIFIED-FLOW] FIDO2 device - status determined by flow type:',\n\t\t\t\t\t\tdeviceStatus\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device status determined:', {\n\t\t\t\t\tflowType,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tdeviceStatus,\n\t\t\t\t\totpWillBeSent: deviceStatus === 'ACTIVATION_REQUIRED',\n\t\t\t\t\treason:\n\t\t\t\t\t\tselectedDeviceType === 'FIDO2'\n\t\t\t\t\t\t\t? 'FIDO2 - ACTIVE after WebAuthn verification'\n\t\t\t\t\t\t\t: 'User flow - OTP required for activation',\n\t\t\t\t});\n\n\t\t\t\t// Use same parameter construction as working MFA flows\n\t\t\t\ttype RegisterDeviceParamsWithToken = RegisterDeviceParams & {\n\t\t\t\t\ttokenType?: 'worker' | 'user';\n\t\t\t\t\tuserToken?: string | undefined;\n\t\t\t\t};\n\t\t\t\tlet baseParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\tenvironmentId: props.credentials.environmentId,\n\t\t\t\t\tusername: props.credentials.username,\n\t\t\t\t\ttype: selectedDeviceType,\n\t\t\t\t};\n\t\t\t\t// Per rightTOTP.md: Pass token type and user token if available\n\t\t\t\tif (flowType === 'user' && token) {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'user',\n\t\t\t\t\t\tuserToken: token,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'worker',\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Always include status for all device types\n\t\t\t\t// FIDO2: Set to ACTIVE since WebAuthn verification proves device works\n\t\t\t\t// Other devices: Set based on flow type (admin-active = ACTIVE, others = ACTIVATION_REQUIRED)\n\t\t\t\tif (deviceStatus !== undefined) {\n\t\t\t\t\tbaseParams.status = deviceStatus;\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registration base params:', {\n\t\t\t\t\tenvironmentId: baseParams.environmentId,\n\t\t\t\t\tusername: baseParams.username,\n\t\t\t\t\ttype: baseParams.type,\n\t\t\t\t\ttokenType: baseParams.tokenType,\n\t\t\t\t\tstatus: baseParams.status,\n\t\t\t\t\tflowType,\n\t\t\t\t});\n\n\t\t\t\t// Map form field names to API field names\n\t\t\t\t// Form uses 'deviceName' but API expects 'nickname' or 'name'\n\t\t\t\tconst mappedFields: Record<string, string> = { ...fields };\n\t\t\t\tif (mappedFields.deviceName) {\n\t\t\t\t\tmappedFields.nickname = mappedFields.deviceName;\n\t\t\t\t\tmappedFields.name = mappedFields.deviceName;\n\t\t\t\t\tdelete mappedFields.deviceName;\n\t\t\t\t}\n\n\t\t\t\t// Format phone number for SMS/WhatsApp devices\n\t\t\t\t// Form sends: { phoneNumber: '9725231586', countryCode: '+1' }\n\t\t\t\t// API expects: { phone: '+1.9725231586' }\n\t\t\t\tif (mappedFields.phoneNumber && mappedFields.countryCode) {\n\t\t\t\t\tconst countryCode = mappedFields.countryCode.replace('+', ''); // Remove + for formatting\n\t\t\t\t\tconst phoneNumber = mappedFields.phoneNumber.replace(/\\D/g, ''); // Remove non-digits\n\t\t\t\t\tmappedFields.phone = `+${countryCode}.${phoneNumber}`;\n\t\t\t\t\tconsole.log('[UNIFIED-FLOW] Formatted phone:', mappedFields.phone);\n\t\t\t\t\tdelete mappedFields.phoneNumber;\n\t\t\t\t\tdelete mappedFields.countryCode;\n\t\t\t\t}\n\n\t\t\t\t// Include device-specific fields (phone, email, etc.)\n\t\t\t\tconst deviceParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\t...baseParams,\n\t\t\t\t\t...mappedFields,\n\t\t\t\t\t// Include policy for TOTP devices (required for secret and keyUri to be returned)\n\t\t\t\t\t...(selectedDeviceType === 'TOTP' && selectedPolicyRef.current\n\t\t\t\t\t\t? { policy: selectedPolicyRef.current.id }\n\t\t\t\t\t\t: {}),\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registering device with params:', deviceParams);\n\n\t\t\t\tconst result = await MFAServiceV8_Legacy.registerDevice(deviceParams);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device registered:', result);\n\n\t\t\t\t// Update MFA state with device info\n\t\t\t\tconst registrationResult = result as unknown as Record<string, unknown>;\n\n\t\t\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result for TOTP:', {\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\tqrCode: registrationResult.qrCode,\n\t\t\t\t\t\tqrCodeUrl: registrationResult.qrCodeUrl,\n\t\t\t\t\t\tsecret: registrationResult.secret,\n\t\t\t\t\t\ttotpSecret: registrationResult.totpSecret,\n\t\t\t\t\t\tfullResult: result,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// ===============================================\n\n\t\t\t\t// Clear stored registration data after successful use\n\t\t\t\tlocalStorage.removeItem('mfa_registration_flow_type');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_fields');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_device_type');\n\n\t\t\t\tprops.setMfaState((prev) => {\n\t\t\t\t\t// TOTP: QR code will be rendered by QRCodeSVG component in UnifiedActivationStep\n\t\t\t\t\t// No need to generate QR code data URL here - just pass the keyUri\n\t\t\t\t\tconst newState: MFAState = {\n\t\t\t\t\t\t...prev,\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tdeviceStatus: result.status,\n\t\t\t\t\t\t...(registrationResult.deviceActivateUri\n\t\t\t\t\t\t\t? { deviceActivateUri: String(registrationResult.deviceActivateUri) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'TOTP'\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\ttotpSecret: String(registrationResult.secret || ''),\n\t\t\t\t\t\t\t\t\tkeyUri: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tqrCodeUrl: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tshowQr: !!(registrationResult.secret || registrationResult.keyUri),\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'FIDO2' &&\n\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tpublicKeyCredentialCreationOptions:\n\t\t\t\t\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions,\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'MOBILE' && registrationResult.pairingKey\n\t\t\t\t\t\t\t? { pairingKey: String(registrationResult.pairingKey) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t};\n\n\t\t\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\t\t\tfullState: newState,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t// ================================================\n\n\t\t\t\t\treturn newState;\n\t\t\t\t});\n\n\t\t\t\t// FIDO2: Check if we already have credential data (from WebAuthn modal)\n\t\t\t\t// If credentialId and publicKey are present, registration is complete\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tif (fields.credentialId && fields.publicKey) {\n\t\t\t\t\t\t// WebAuthn already completed via modal - device fully registered\n\n\t\t\t\t\t\t// Admin Flow: Show QR but skip OTP validation - device ready immediately\n\t\t\t\t\t\t// Admin ACTIVATION_REQUIRED & User Flow: Show QR and require OTP validation\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tflowType === 'admin-active' ||\n\t\t\t\t\t\t\tflowType === 'admin-activation' ||\n\t\t\t\t\t\t\tresult.status === 'ACTIVE'\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t'[UNIFIED-FLOW] Admin flow or ACTIVE status - proceeding to show QR without OTP requirement'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered successfully!${flowType === 'admin-active' || flowType === 'admin-activation' ? ' Device is ready to use.' : ''}`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t// For Admin Flow, go to API docs page instead of OTP page\n\t\t\t\t\t\t\t// For User Flow, go to User Login step (Step 1)\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (result.status === 'ACTIVATION_REQUIRED') {\n\t\t\t\t\t\t\t// Device requires activation - PingOne automatically sends OTP\n\t\t\t\t\t\t\t// This applies to both admin_activation_required and user flow\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered! OTP has been sent automatically.`\n\t\t\t\t\t\t\t);\n  // DO NOT auto-advance for OTP-required devices\n\t\t\t\t\t\t\t// User should manually click Next after receiving OTP\n\t\t\t\t\t\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation - waiting for user to proceed manually`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Unknown status, proceed with flow-specific navigation\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} // End of FIDO2 section\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Registration failed:', error);\n\t\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Device registration failed';\n\n\t\t\t\t// Check if error is due to too many devices\n\t\t\t\tif (errorMessage.includes('Too many devices')) {\n\t\t\t\t\ttoastV8.error(\n\t\t\t\t\t\t`${errorMessage}\\n\\n‚ÑπÔ∏è You can manage your devices at:\\nhttps://localhost:3000/v8/delete-all-devices`,\n\t\t\t\t\t\t{ duration: 8000 }\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\ttoastV8.error(errorMessage);\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tprops.setIsLoading(false);\n\t\t\t}\n\t\t},\n\t\t[config.displayName, toastV8]\n\t);\n\n\t/**\n\t * Handle user token received from OAuth flow\n\t */\n\tconst handleUserTokenReceived = useCallback(\n\t\t(token: string) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== USER TOKEN RECEIVED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Token length:', token.length);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current pending registration:', pendingRegistrationRef.current);\n\n\t\t\tsetUserToken(token);\n\t\t\tsetUserTokenForDisplay(token);\n\n\t\t\t// Decode JWT to extract username\n\t\t\ttry {\n\t\t\t\tconst base64Url = token.split('.')[1];\n\t\t\t\tconst base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n\t\t\t\tconst jsonPayload = decodeURIComponent(\n\t\t\t\t\tatob(base64)\n\t\t\t\t\t\t.split('')\n\t\t\t\t\t\t.map((c) => `%${`00${c.charCodeAt(0).toString(16)}`.slice(-2)}`)\n\t\t\t\t\t\t.join('')\n\t\t\t\t);\n\t\t\t\tconst payload = JSON.parse(jsonPayload);\n\t\t\t\tconst username =\n\t\t\t\t\tpayload.username || payload.preferred_username || payload.sub || 'Unknown User';\n\t\t\t\tsetUsernameFromToken(username);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Extracted username:', username);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Failed to decode JWT:', error);\n\t\t\t\tsetUsernameFromToken('Unknown User');\n\t\t\t}\n\n\t\t\t// If we have pending registration, show success page first\n\t\t\tconst pending = pendingRegistrationRef.current;\n\t\t\tif (pending) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Found pending registration, showing success page first...');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending data:', {\n\t\t\t\t\tdeviceType: pending.deviceType,\n\t\t\t\t\tflowType: pending.flowType,\n\t\t\t\t\thasProps: !!pending.props,\n\t\t\t\t\thasFields: !!pending.fields,\n\t\t\t\t});\n\n\t\t\t\ttoastV8.success('‚úÖ Authentication successful! Your user token is ready.', {\n\t\t\t\t\tduration: 4000,\n\t\t\t\t});\n\n\t\t\t\t// Close login modal and show success page\n\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\tsetShowUserTokenSuccess(true);\n\t\t\t} else {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] WARNING: No pending registration found after OAuth!');\n\t\t\t}\n\t\t},\n\t\t[setUserToken]\n\t);\n\n\t/**\n\t * Handle continue from user token success page\n\t */\n\tconst handleContinueAfterUserLogin = useCallback(() => {\n\t\tconsole.log(\n\t\t\t'[UNIFIED-FLOW] User clicked continue after login, proceeding with registration...'\n\t\t);\n\n\t\tconst pending = pendingRegistrationRef.current;\n\t\tif (pending && userToken) {\n\t\t\tconst { deviceType: pendingDeviceType, fields, flowType, props } = pending;\n\t\t\tpendingRegistrationRef.current = null;\n\n\t\t\t// Hide success page\n\t\t\tsetShowUserTokenSuccess(false);\n\n\t\t\t// Continue with registration\n\t\t\tsetTimeout(() => {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Now executing performRegistrationWithToken...');\n\t\t\t\tperformRegistrationWithToken(props, pendingDeviceType, fields, flowType, userToken);\n\t\t\t}, 100);\n\t\t}\n\t}, [userToken, performRegistrationWithToken]);\n\n\t/**\n\t * Perform device registration API call\n\t * Checks if User Flow needs OAuth first, otherwise proceeds with registration\n\t */\n\tconst performRegistration = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== DEVICE REGISTRATION SUBMITTED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current userToken:', userToken ? 'Present' : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\n\t\t\t// CRITICAL: Validate worker token before allowing any registration\n\t\t\tif (!workerToken.tokenStatus.isValid) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Cannot proceed - no valid worker token');\n\t\t\t\ttoastV8.error(\n\t\t\t\t\t'‚ùå Worker token required for device registration. Please configure worker token credentials first.',\n\t\t\t\t\t{\n\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// For User Flow, check if we need OAuth authentication first\n\t\t\tif (flowType === 'user' && !userToken) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] User flow selected but no token - showing OAuth modal');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Storing pending registration...');\n\n\t\t\t\t// Store pending registration data\n\t\t\t\tpendingRegistrationRef.current = {\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tfields,\n\t\t\t\t\tflowType,\n\t\t\t\t\tprops,\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending registration stored:', pendingRegistrationRef.current);\n\n\t\t\t\t// Set return target for device registration flow\n\t\t\t\tReturnTargetServiceV8U.setReturnTarget(\n\t\t\t\t\t'mfa_device_registration',\n\t\t\t\t\t'/v8/unified-mfa',  // Return to unified MFA flow\n\t\t\t\t\t2  // Step 2: Device Selection\n\t\t\t\t);\n\n\t\t\t\t// Show the user login modal\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'üîê User Flow requires PingOne authentication. Please complete the login to continue with device registration.',\n\t\t\t\t\t{ duration: 6000 }\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t'[UNIFIED-FLOW] Proceeding directly with registration (token exists or admin flow)'\n\t\t\t);\n\t\t\t// Proceed with registration (using existing token for user flow)\n\t\t\tawait performRegistrationWithToken(\n\t\t\t\tprops,\n\t\t\t\tselectedDeviceType,\n\t\t\t\tfields,\n\t\t\t\tflowType,\n\t\t\t\tuserToken || undefined\n\t\t\t);\n\t\t},\n\t\t[workerToken.tokenStatus.isValid, userToken]\n\t);\n\n\t/**\n\t * Render Step 0: Configuration (environment, user, policy)\n\t */\n\tconst renderStep0 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn (\n\t\t\t\t<UnifiedDeviceRegistrationForm\n\t\t\t\t\tinitialDeviceType={deviceType}\n\t\t\t\t\tonSubmit={async (selectedDeviceType, fields, flowType) => {\n\t\t\t\t\t\tawait performRegistration(props, selectedDeviceType, fields, flowType);\n\t\t\t\t\t}}\n\t\t\t\t\tonCancel={() => {\n\t\t\t\t\t\tif (onCancel) onCancel();\n\t\t\t\t\t}}\n\t\t\t\t\ttokenStatus={props.tokenStatus}\n\t\t\t\t\tusername={props.credentials.username}\n\t\t\t\t/>\n\t\t\t);\n\t\t},\n\t\t[deviceType, onCancel, performRegistration]\n\t);\n\n\t/**\n\t * Render Step 1: User Login using Authorization Code Flow with PKCE\n\t */\n\tconst renderStep1 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <UserLoginStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 2: Device Selection (option to call registration if want new device, or have no devices)\n\t */\n\tconst renderStep2 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 3: Device-Specific Actions (OTP/QR Generation, FIDO, Mobile Push)\n\t */\n\tconst renderStep3 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific based on the device type\n\t\t\t// For now, return the activation step which handles device-specific logic\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 4: OTP Validation / Confirmation\n\t */\n\tconst renderStep4 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific validation\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 5: API Documentation\n\t */\n\tconst renderStep5 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <APIDocsStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 6: Success screen with all user data and other valuable options\n\t */\n\tconst renderStep6 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <SuccessStepV8 renderProps={props} />;\n\t}, []);\n\n\t// Step labels for device authentication flow\n\tconst stepLabels = useMemo(() => {\n\t\tif (deviceType === 'FIDO2') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Start FIDO in Browser',\n\t\t\t\t'Passkey confirmation',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else if (deviceType === 'MOBILE') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Push to Mobile App',\n\t\t\t\t'User Confirms on Mobile',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else {\n\t\t\t// SMS, Email, TOTP, WhatsApp\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Generate OTP/QR',\n\t\t\t\t'Validate OTP',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t}\n\t}, [deviceType]);\n\n\tconst shouldHideNextButton = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\tif (props.nav.currentStep === 0) {\n\t\t\treturn true; // Hide Next button on configuration step, use form submit\n\t\t}\n\t\tif (props.nav.currentStep === 1) {\n\t\t\treturn true; // Hide Next button on user login step, use authentication button\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\treturn (\n\t\t<>\n\t\t\t<MFAFlowBaseV8\n\t\t\t\tdeviceType={deviceType}\n\t\t\t\trenderStep0={renderStep0}\n\t\t\t\trenderStep1={renderStep1}\n\t\t\t\trenderStep2={renderStep2}\n\t\t\t\trenderStep3={renderStep3}\n\t\t\t\trenderStep4={renderStep4}\n\t\t\t\trenderStep5={renderStep5}\n\t\t\t\trenderStep6={renderStep6}\n\t\t\t\tvalidateStep0={validateStep0}\n\t\t\t\tstepLabels={stepLabels}\n\t\t\t\tshouldHideNextButton={shouldHideNextButton}\n\t\t\t\tflowType=\"device-auth\"\n\t\t\t/>\n\t\t\t<div style={{ height: '300px' }} />\n\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\n\t\t\t{/* User Login Modal for User Flow OAuth */}\n\t\t\t<UserLoginModalV8\n\t\t\t\tisOpen={showUserLoginModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\t\tpendingRegistrationRef.current = null;\n\t\t\t\t}}\n\t\t\t\tonTokenReceived={handleUserTokenReceived}\n\t\t\t\tenvironmentId={envIdForModal}\n\t\t\t/>\n\n\t\t\t{/* User Token Success Page - Show token after OAuth login */}\n\t\t\t{showUserTokenSuccess && userTokenForDisplay && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 10000,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\t\t\tboxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Success Header */}\n\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\twidth: '64px',\n\t\t\t\t\t\t\t\t\theight: '64px',\n\t\t\t\t\t\t\t\t\tborderRadius: '50%',\n\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>‚úÖ</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<h2 style={{ margin: '0 0 8px 0', fontSize: '24px', color: '#1f2937' }}>\n\t\t\t\t\t\t\t\tAuthentication Successful!\n\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\tYour user token has been obtained and is ready to use.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Username Dropdown */}\n\t\t\t\t\t\t{usernameFromToken && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUsernameDropdown(!showUsernameDropdown)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tpadding: 0,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: showUsernameDropdown ? '12px' : 0,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '16px', color: '#374151' }}>Username</h3>\n\t\t\t\t\t\t\t\t\t{showUsernameDropdown ? (\n\t\t\t\t\t\t\t\t\t\t<FiChevronUp size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t<FiChevronDown size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{showUsernameDropdown && (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{usernameFromToken}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(usernameFromToken);\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('Username copied to clipboard!');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüìã Copy Username\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Token Display */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<h3 style={{ margin: '0 0 12px 0', fontSize: '16px', color: '#374151' }}>\n\t\t\t\t\t\t\t\tUser Access Token\n\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{userTokenForDisplay}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(userTokenForDisplay);\n\t\t\t\t\t\t\t\t\ttoastV8.success('Token copied to clipboard!');\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüìã Copy Token\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Next Steps Info */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#eff6ff',\n\t\t\t\t\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#1e40af', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t<strong>Next:</strong> Click \"Continue with Registration\" to proceed with your{' '}\n\t\t\t\t\t\t\t\t{config.displayName} device registration using this user token.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Continue Button */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleContinueAfterUserLogin}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\tbackground: '#10b981',\n\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tboxShadow: '0 2px 8px rgba(16, 185, 129, 0.3)',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tContinue with Registration ‚Üí\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</>\n\t);\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default UnifiedMFARegistrationFlowV8;\n"},"tags":["fixable"],"source":null},{"category":"lint/correctness/useExhaustiveDependencies","severity":"warning","description":"This hook specifies more dependencies than necessary: toastV8.","message":[{"elements":[],"content":"This hook specifies "},{"elements":["Emphasis"],"content":"more dependencies than necessary"},{"elements":[],"content":": toastV8."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Outer scope values aren't valid dependencies because mutating them doesn't re-render the component."}]]},{"frame":{"path":null,"span":[75251,75258],"sourceCode":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\n * @description Unified MFA Registration Flow - Single component for all 6 device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Replace 6 device-specific flow components (SMS, Email, Mobile, WhatsApp, TOTP, FIDO2)\n * with a single configurable component using deviceFlowConfigs for device-specific behavior.\n *\n * Architecture:\n * - Configuration-driven using deviceFlowConfigs.ts\n * - Dynamic form rendering for simple devices (SMS, Email, WhatsApp)\n * - Custom components for complex devices (TOTP, FIDO2, Mobile)\n * - Integrates with MFACredentialContext and useWorkerToken hook\n * - Uses existing MFAFlowBaseV8 for 5-step framework\n *\n * @example\n * <UnifiedMFARegistrationFlowV8\n *   deviceType=\"SMS\"\n *   onSuccess={(result) => console.log('Device registered:', result.deviceId)}\n * />\n */\n\nimport * as React from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { FiChevronDown, FiChevronUp } from 'react-icons/fi';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { MFAHeaderV8 } from '@/v8/components/MFAHeaderV8';\nimport type { SearchableDropdownOption } from '@/v8/components/SearchableDropdownV8';\nimport { SearchableDropdownV8 } from '@/v8/components/SearchableDropdownV8';\nimport { SQLiteStatsDisplayV8 } from '@/v8/components/SQLiteStatsDisplayV8';\nimport { SuperSimpleApiDisplayV8 } from '@/v8/components/SuperSimpleApiDisplayV8';\nimport { UserLoginModalV8 } from '@/v8/components/UserLoginModalV8';\nimport { getDeviceConfig } from '@/v8/config/deviceFlowConfigs';\nimport type { DeviceConfigKey, DeviceRegistrationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport { PING_IDENTITY_COLORS } from '@/v8/constants/pingIdentityColors';\nimport { GlobalMFAProvider } from '@/v8/contexts/GlobalMFAContext';\nimport { MFACredentialProvider } from '@/v8/contexts/MFACredentialContext';\nimport { APIDocsStepV8 } from '@/v8/flows/shared/APIDocsStepV8';\nimport { SuccessStepV8 } from '@/v8/flows/shared/SuccessStepV8';\nimport { UserLoginStepV8 } from '@/v8/flows/shared/UserLoginStepV8';\nimport { useMFAPolicies } from '@/v8/hooks/useMFAPolicies';\nimport { useStepNavigationV8 } from '@/v8/hooks/useStepNavigationV8';\nimport { useUserSearch } from '@/v8/hooks/useUserSearch';\nimport { useWorkerToken } from '@/v8/hooks/useWorkerToken';\nimport { CredentialsServiceV8 } from '@/v8/services/credentialsServiceV8';\nimport { globalEnvironmentService } from '@/v8/services/globalEnvironmentService';\nimport { MfaAuthenticationServiceV8 } from '@/v8/services/mfaAuthenticationServiceV8';\nimport { type MFAFeatureFlag, MFAFeatureFlagsV8 } from '@/v8/services/mfaFeatureFlagsV8';\nimport MFAServiceV8_Legacy, { type RegisterDeviceParams } from '@/v8/services/mfaServiceV8_Legacy';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport type { TokenStatusInfo } from '@/v8/services/workerTokenStatusServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { ReturnTargetServiceV8U } from '@/v8u/services/returnTargetServiceV8U';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type MFAFlowBaseRenderProps, MFAFlowBaseV8 } from '../shared/MFAFlowBaseV8';\nimport type { DeviceAuthenticationPolicy, MFACredentials, MFAState } from '../shared/MFATypes';\nimport { UnifiedActivationStep } from './components/UnifiedActivationStep';\nimport { UnifiedDeviceRegistrationForm } from './components/UnifiedDeviceRegistrationForm';\nimport { UnifiedDeviceSelectionModal } from './components/UnifiedDeviceSelectionModal';\nimport { UnifiedSuccessStep } from './components/UnifiedSuccessStep';\nimport './UnifiedMFAFlow.css';\n\nconst MODULE_TAG = '[üîÑ UNIFIED-MFA-FLOW-V8]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedMFARegistrationFlowV8Props {\n\t/** Device type to render (optional - can be provided via navigation state) */\n\tdeviceType?: DeviceConfigKey;\n\n\t/** Optional initial credentials (for pre-filled forms) */\n\tinitialCredentials?: Partial<MFACredentials>;\n\n\t/** Optional callback when registration succeeds */\n\tonSuccess?: (result: DeviceRegistrationResult) => void;\n\n\t/** Optional callback when user cancels flow */\n\tonCancel?: () => void;\n\n\t/** Optional initial step (defaults to 0) */\n\tinitialStep?: number;\n\n\t/** Optional: Skip configuration step if already configured */\n\tskipConfiguration?: boolean;\n\n\t/** Optional: Force specific registration flow type */\n\tregistrationFlowType?: 'admin-active' | 'admin-activation' | 'user';\n}\n\n// ============================================================================\n// MFA FLOW SELECTION SCREEN\n// ============================================================================\n\ntype FlowMode = 'registration' | 'authentication';\n\n/** Map device types to their feature flags */\nconst DEVICE_FLAG_MAP: Record<DeviceConfigKey, MFAFeatureFlag> = {\n\tSMS: 'mfa_unified_sms',\n\tEMAIL: 'mfa_unified_email',\n\tMOBILE: 'mfa_unified_mobile',\n\tWHATSAPP: 'mfa_unified_whatsapp',\n\tTOTP: 'mfa_unified_totp',\n\tFIDO2: 'mfa_unified_fido2',\n};\n\nconst DEVICE_TYPES: { key: DeviceConfigKey; icon: string; name: string; description: string }[] = [\n\t{ key: 'SMS', icon: 'üì±', name: 'SMS', description: 'Receive OTP codes via text message' },\n\t{ key: 'EMAIL', icon: '‚úâÔ∏è', name: 'Email', description: 'Receive OTP codes via email' },\n\t{\n\t\tkey: 'TOTP',\n\t\ticon: 'üîê',\n\t\tname: 'Authenticator App (TOTP)',\n\t\tdescription: 'Use Google Authenticator, Authy, or similar',\n\t},\n\t{\n\t\tkey: 'MOBILE',\n\t\ticon: 'üì≤',\n\t\tname: 'Mobile Push',\n\t\tdescription: 'Receive push notifications on your phone',\n\t},\n\t{ key: 'WHATSAPP', icon: 'üí¨', name: 'WhatsApp', description: 'Receive OTP codes via WhatsApp' },\n\t{\n\t\tkey: 'FIDO2',\n\t\ticon: 'üîë',\n\t\tname: 'Security Key (FIDO2)',\n\t\tdescription: 'Use a hardware security key or passkey',\n\t},\n];\n\n/** Check if a device type is enabled via feature flags */\nconst isDeviceEnabled = (deviceKey: DeviceConfigKey): boolean => {\n\tconst flag = DEVICE_FLAG_MAP[deviceKey];\n\treturn MFAFeatureFlagsV8.isEnabled(flag);\n};\n\ninterface DeviceTypeSelectionScreenProps {\n\tonSelectDeviceType: (deviceType: DeviceConfigKey) => void;\n\tuserToken?: string | null;\n\tsetUserToken: (token: string | null) => void;\n}\n\nconst DeviceTypeSelectionScreen: React.FC<DeviceTypeSelectionScreenProps> = ({\n\tonSelectDeviceType,\n\tuserToken,\n\tsetUserToken,\n}) => {\n\tconst [flowMode, setFlowMode] = useState<FlowMode | null>(null);\n\tconst [environmentId, setEnvironmentId] = useState('');\n\tconst [username, setUsername] = useState('');\n\tconst [showDeviceSelectionModal, setShowDeviceSelectionModal] = useState(false);\n\tconst [showOTPModal, setShowOTPModal] = useState(false);\n\tconst [otpCode, setOtpCode] = useState('');\n\tconst [authenticationId, setAuthenticationId] = useState<string | null>(null);\n\tconst [selectedAuthDevice, setSelectedAuthDevice] = useState<{\n\t\tid: string;\n\t\ttype: string;\n\t\tnickname?: string;\n\t} | null>(null);\n\tconst [customLogoUrl, setCustomLogoUrl] = useState<string>('');\n\tconst [showAuthLoginModal, setShowAuthLoginModal] = useState(false);\n\tconst authEnvIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Load uploaded logo from localStorage on mount\n\tuseEffect(() => {\n\t\ttry {\n\t\t\tconst savedUpload = localStorage.getItem('custom-logo-upload');\n\t\t\tif (savedUpload) {\n\t\t\t\tconst uploadData = JSON.parse(savedUpload);\n\t\t\t\t// Handle both old format (objectUrl) and new format (base64Url)\n\t\t\t\tif (uploadData.base64Url) {\n\t\t\t\t\tsetCustomLogoUrl(uploadData.base64Url);\n\t\t\t\t} else if (uploadData.objectUrl) {\n\t\t\t\t\t// Old format - try to convert if possible, otherwise clear it\n\t\t\t\t\tconsole.warn('Old logo format detected - please re-upload your logo');\n\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load uploaded logo from localStorage:', error);\n\t\t\t// Clear corrupted data\n\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t}\n\t}, []);\n\n\t// Use worker token hook for token management\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Extract environment ID from worker token when available\n\tuseEffect(() => {\n\t\tconst extractEnvironmentId = async () => {\n\t\t\ttry {\n\t\t\t\tconst token = await workerTokenServiceV8.getToken();\n\t\t\t\tif (token && !environmentId) {\n\t\t\t\t\tconst parts = token.split('.');\n\t\t\t\t\tif (parts.length === 3) {\n\t\t\t\t\t\tconst payload = JSON.parse(atob(parts[1]));\n\t\t\t\t\t\tif (payload.environmentId) {\n\t\t\t\t\t\t\tsetEnvironmentId(payload.environmentId);\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`${MODULE_TAG} Environment ID extracted from worker token:`,\n\t\t\t\t\t\t\t\tpayload.environmentId\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Failed to extract environment ID from worker token:`, error);\n\t\t\t}\n\t\t};\n\n\t\textractEnvironmentId();\n\t}, [environmentId]);\n\n\tconst hasWorkerToken = workerToken.tokenStatus.isValid;\n\n\t// Use user search hook for user fetching and search\n\tconst {\n\t\tusers,\n\t\tisLoading: isLoadingUsers,\n\t\tsetSearchQuery,\n\t} = useUserSearch({\n\t\tenvironmentId,\n\t\ttokenValid: workerToken.tokenStatus.isValid,\n\t\tmaxPages: 100,\n\t\tuseCache: true,\n\t});\n\tconst tokenStatus = workerToken.tokenStatus;\n\n\t// Debug: Log users type to understand the issue\n\tuseEffect(() => {\n\t\tconsole.log(`${MODULE_TAG} users type check:`, {\n\t\t\tusers,\n\t\t\tisArray: Array.isArray(users),\n\t\t\ttype: typeof users,\n\t\t\tconstructor: users?.constructor?.name,\n\t\t});\n\t}, [users]);\n\n\t// Load Environment ID and username from global services on mount\n\tuseEffect(() => {\n\t\t// Initialize the service first to load from localStorage\n\t\tglobalEnvironmentService.initialize();\n\t\tconst savedEnvId = globalEnvironmentService.getEnvironmentId();\n\t\tif (savedEnvId) {\n\t\t\tsetEnvironmentId(savedEnvId);\n\t\t}\n\n\t\t// Load username from localStorage\n\t\tconst savedUsername = localStorage.getItem('mfa_unified_username');\n\t\tif (savedUsername) {\n\t\t\tsetUsername(savedUsername);\n\t\t}\n\t}, []);\n\n\t// Use MFA policies hook\n\tconst {\n\t\tpolicies,\n\t\tselectedPolicy,\n\t\tisLoading: isPoliciesLoading,\n\t\terror: policiesError,\n\t\tselectPolicy,\n\t\tdefaultPolicy,\n\t} = useMFAPolicies({\n\t\tenvironmentId,\n\t\ttokenIsValid: tokenStatus.isValid,\n\t\tautoLoad: true,\n\t\tautoSelectSingle: true,\n\t});\n\n\tconst selectedPolicyRef = useRef<DeviceAuthenticationPolicy | null>(null);\n\tuseEffect(() => {\n\t\tselectedPolicyRef.current = selectedPolicy ?? null;\n\t}, [selectedPolicy]);\n\n\tconst isPolicyDeviceEnabled = useCallback(\n\t\t(policy: DeviceAuthenticationPolicy | null, key: string) => {\n\t\t\tconst deviceConfig = policy?.[key] as { enabled?: boolean } | undefined;\n\t\t\treturn !!deviceConfig?.enabled;\n\t\t},\n\t\t[]\n\t);\n\n\tconst policyOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tpolicies.map((policy) => ({\n\t\t\t\tvalue: policy.id,\n\t\t\t\tlabel: policy.name,\n\t\t\t\t...(policy.default ? { secondaryLabel: '(Default)' } : {}),\n\t\t\t})),\n\t\t[policies]\n\t);\n\n\tconst userOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tArray.from(\n\t\t\t\tnew Map(\n\t\t\t\t\t(Array.isArray(users) ? users : []).map((user) => [\n\t\t\t\t\t\tuser.username,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvalue: user.username,\n\t\t\t\t\t\t\tlabel: user.username,\n\t\t\t\t\t\t\t...(user.email ? { secondaryLabel: user.email } : {}),\n\t\t\t\t\t\t} as SearchableDropdownOption,\n\t\t\t\t\t])\n\t\t\t\t).values()\n\t\t\t),\n\t\t[users]\n\t);\n\n\t// Auto-select default policy when policies load\n\tuseEffect(() => {\n\t\tif (defaultPolicy && !selectedPolicy) {\n\t\t\tselectPolicy(defaultPolicy.id);\n\t\t}\n\t}, [defaultPolicy, selectedPolicy, selectPolicy]);\n\n\t// Sync environment ID to global service and CredentialsServiceV8 when it changes\n\tuseEffect(() => {\n\t\tif (environmentId) {\n\t\t\tglobalEnvironmentService.setEnvironmentId(environmentId);\n\t\t\tlocalStorage.setItem('mfa_environmentId', environmentId);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tenvironmentId,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId, username: currentCreds.username }\n\t\t\t}));\n\t\t}\n\t}, [environmentId]);\n\n\t// Save username to localStorage and CredentialsServiceV8 when it changes\n\t// This ensures MFAFlowBase can read the username from its expected storage location\n\tuseEffect(() => {\n\t\tif (username) {\n\t\t\tlocalStorage.setItem('mfa_unified_username', username);\n\t\t\tlocalStorage.setItem('mfa_username', username);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tusername,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId: currentCreds.environmentId, username }\n\t\t\t}));\n\t\t}\n\t}, [username]);\n\n\t// Handle device selection for authentication\n\tconst handleDeviceSelectForAuthentication = async (device: {\n\t\tid: string;\n\t\ttype: string;\n\t\tdeviceName?: string;\n\t\tnickname?: string;\n\t}) => {\n\t\tconsole.log(`${MODULE_TAG} Selected device for authentication:`, device);\n\t\tsetShowDeviceSelectionModal(false);\n\t\tsetSelectedAuthDevice(device);\n\n\t\tconst policyId = selectedPolicy?.id;\n\t\tif (!policyId) {\n\t\t\ttoastV8.error('Please select an MFA Policy first');\n\t\t\treturn;\n\t\t}\n\n\t\t// Determine flow type and token\n\t\t// Admin flows should use worker tokens, not require user tokens\n\t\tconst flowType = userToken ? 'user' : 'admin';\n\t\tconst effectiveUserToken = flowType === 'user' ? userToken : undefined;\n\n\t\t// For admin flow, check if we have a valid worker token before proceeding\n\t\tif (flowType === 'admin' && !hasWorkerToken) {\n\t\t\ttoastV8.error('Admin flow requires a valid worker token. Please generate a worker token first.');\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\t// Initialize authentication with appropriate token\n\t\t\tconst response = await MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\tenvironmentId,\n\t\t\t\tusername: username.trim(),\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t\tdeviceId: device.id,\n\t\t\t\tregion: 'na',\n\t\t\t\ttokenType: flowType,\n\t\t\t\t...(effectiveUserToken && { userToken: effectiveUserToken }),\n\t\t\t});\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth initialized - full response:`, response);\n\t\t\tsetAuthenticationId(response.id);\n\n\t\t\tconst status = (response.status || '').toUpperCase();\n\t\t\tconst nextStep = (response.nextStep || '').toUpperCase();\n\t\t\tconst links = response._links as Record<string, { href?: string }> | undefined;\n\t\t\tconst hasOtpLink = !!(\n\t\t\t\tlinks &&\n\t\t\t\t(links.otp || links['otp.check'] || (links as Record<string, unknown>)['checkOtp'])\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth status:`, {\n\t\t\t\tstatus,\n\t\t\t\tnextStep,\n\t\t\t\thasOtpLink,\n\t\t\t\tdeviceType: device.type,\n\t\t\t});\n\n\t\t\t// Show appropriate UI based on response (normalize status/nextStep for PingOne variants)\n\t\t\tif (status === 'OTP_REQUIRED' || nextStep === 'OTP_REQUIRED' || hasOtpLink) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Opening OTP modal for device:`, device.type);\n\t\t\t\tsetShowOTPModal(true);\n\t\t\t\ttoastV8.success(`Verification code sent to your ${device.type} device`);\n\t\t\t} else if (status === 'ASSERTION_REQUIRED' || nextStep === 'ASSERTION_REQUIRED') {\n\t\t\t\tconsole.log(`${MODULE_TAG} FIDO2 assertion required`);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'FIDO2 authentication required. Please use /v8/mfa-config for FIDO2 authentication.'\n\t\t\t\t);\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'PUSH_CONFIRMATION_REQUIRED' ||\n\t\t\t\tnextStep === 'PUSH_CONFIRMATION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Push confirmation required`);\n\t\t\t\ttoastV8.success('Push notification sent! Please approve on your mobile device.');\n\t\t\t\ttoastV8.info('Complete authentication at /v8/mfa-config for push polling.');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (status === 'COMPLETED') {\n\t\t\t\ttoastV8.success('Authentication completed successfully!');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'DEVICE_SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'DEVICE_SELECTION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Device selection required - showing modal again`);\n\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t} else {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Unexpected authentication status:`, {\n\t\t\t\t\tstatus,\n\t\t\t\t\tnextStep,\n\t\t\t\t\tresponse,\n\t\t\t\t});\n\t\t\t\ttoastV8.info(`Authentication status: ${status || nextStep || 'UNKNOWN'}`);\n\t\t\t\t// Stay in authentication flow so user can try another device\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to initialize authentication:`, error);\n\n\t\t\t// Enhanced error handling for NO_USABLE_DEVICES\n\t\t\tlet errorMessage = 'Authentication failed: ';\n\t\t\tif (error instanceof Error) {\n\t\t\t\tconst errorStr = error.message.toLowerCase();\n\n\t\t\t\t// Check for NO_USABLE_DEVICES or device availability errors\n\t\t\t\tif (\n\t\t\t\t\terrorStr.includes('no usable devices') ||\n\t\t\t\t\terrorStr.includes('too many') ||\n\t\t\t\t\terrorStr.includes('cooldown') ||\n\t\t\t\t\terrorStr.includes('blocked')\n\t\t\t\t) {\n\t\t\t\t\terrorMessage = '‚ö†Ô∏è Device Temporarily Unavailable\\n\\n';\n\n\t\t\t\t\tif (errorStr.includes('cooldown') || errorStr.includes('too many')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Too many notifications have been sent to this device. It is temporarily in cooldown. ';\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Please wait a few minutes and try again, or select a different device.';\n\t\t\t\t\t} else if (errorStr.includes('blocked')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'This device has been blocked. Please contact your administrator or use a different device.';\n\t\t\t\t\t} else {\n\t\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terrorMessage += 'Unknown error';\n\t\t\t}\n\n\t\t\ttoastV8.error(errorMessage, { duration: 8000 });\n\t\t\t// Do NOT set flowMode(null) - keep user in authentication flow so they can retry or select another device\n\t\t}\n\t};\n\n\t// Handle OTP verification\n\tconst handleVerifyOTP = async () => {\n\t\tif (!authenticationId || !selectedAuthDevice) {\n\t\t\ttoastV8.error('Authentication session not found');\n\t\t\treturn;\n\t\t}\n\n\t\tif (otpCode.length !== 6) {\n\t\t\ttoastV8.error('Please enter a 6-digit code');\n\t\t\treturn;\n\t\t}\n\n\t\t// Get worker token for API call\n\t\tconst workerTokenForOTP = await workerTokenServiceV8.getToken();\n\n\t\tconsole.log(`${MODULE_TAG} OTP verification debug:`, {\n\t\t\tenvironmentId,\n\t\t\tusername: username.trim(),\n\t\t\tauthenticationId,\n\t\t\totpCode,\n\t\t\thasEnvironmentId: !!environmentId,\n\t\t\tenvIdLength: environmentId?.length,\n\t\t\thasWorkerToken: !!workerTokenForOTP,\n\t\t\tworkerTokenLength: workerTokenForOTP?.length,\n\t\t});\n\n\t\ttry {\n\t\t\t// Use backend proxy to avoid CORS issues\n\t\t\tconst response = await fetch('/api/pingone/mfa/validate-otp-for-device', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tenvironmentId,\n\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\tdeviceAuthId: authenticationId,\n\t\t\t\t\totp: otpCode,\n\t\t\t\t\tregion: 'na',\n\t\t\t\t\tworkerToken: workerTokenForOTP,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\n\t\t\t\tthrow new Error(errorData.error || errorData.message || `HTTP ${response.status}`);\n\t\t\t}\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.status === 'COMPLETED' || result.status === 'completed') {\n\t\t\t\ttoastV8.success('‚úÖ Authentication completed successfully!');\n\t\t\t\tsetShowOTPModal(false);\n\t\t\t\tsetFlowMode(null);\n\t\t\t\tsetOtpCode('');\n\t\t\t} else {\n\t\t\t\ttoastV8.error('Invalid code. Please try again.');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} OTP verification failed:`, error);\n\t\t\ttoastV8.error(\n\t\t\t\t`Verification failed: ${error instanceof Error ? error.message : 'Unknown error'}`\n\t\t\t);\n\t\t}\n\t};\n\n\t// Step 1: Choose Registration or Authentication\n\tif (!flowMode) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '12px' }}>\n\t\t\t\t\t{/* Header */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tboxShadow: '0 4px 12px rgba(239, 68, 68, 0.2)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h1\n\t\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîê MFA Unified Flow\n\t\t\t\t\t\t</h1>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tChoose what you want to do with MFA devices.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Configuration Section */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 12px 0',\n\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfiguration\n\t\t\t\t\t\t</h2>\n\n\t\t\t\t\t\t{/* Custom Logo URL */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-url\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[800],\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüé® Custom Logo URL (Optional)\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tDisplay a custom logo in the OTP verification modal\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t{/* URL Input */}\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tid=\"custom-logo-url\"\n\t\t\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\t\t\tvalue={customLogoUrl}\n\t\t\t\t\t\t\t\tonChange={(e) => setCustomLogoUrl(e.target.value)}\n\t\t\t\t\t\t\t\tplaceholder=\"https://example.com/logo.png\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\tpadding: '10px 14px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[900],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = `0 0 0 3px ${PING_IDENTITY_COLORS.primary[200]}`;\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.neutral[300];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* File Upload Section */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '13px', color: PING_IDENTITY_COLORS.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\tOR\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"file\"\n\t\t\t\t\t\t\t\t\tid=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\taccept=\"image/*\"\n\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\tconst file = e.target.files?.[0];\n\t\t\t\t\t\t\t\t\t\tif (!file) return;\n\n\t\t\t\t\t\t\t\t\t\t// Validate file type (images only)\n\t\t\t\t\t\t\t\t\t\tif (!file.type.startsWith('image/')) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Please select a logo file (JPG, PNG, etc.)');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Validate file size (max 5MB)\n\t\t\t\t\t\t\t\t\t\tif (file.size > 5 * 1024 * 1024) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('File size must be less than 5MB');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Convert file to base64 for persistence\n\t\t\t\t\t\t\t\t\t\tconst reader = new FileReader();\n\t\t\t\t\t\t\t\t\t\treader.onload = (event) => {\n\t\t\t\t\t\t\t\t\t\t\tconst base64Url = event.target?.result as string;\n\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl(base64Url);\n\n\t\t\t\t\t\t\t\t\t\t\t// Store base64 data for persistence\n\t\t\t\t\t\t\t\t\t\t\tconst uploadData = {\n\t\t\t\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\t\t\t\tbase64Url: base64Url,\n\t\t\t\t\t\t\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\t\t\t// Save to localStorage for persistence\n\t\t\t\t\t\t\t\t\t\t\tlocalStorage.setItem('custom-logo-upload', JSON.stringify(uploadData));\n\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.success(`Logo uploaded: ${file.name}`);\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.onerror = () => {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to read uploaded file');\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.readAsDataURL(file);\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'none' }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.primary[500],\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.primary[600]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '500',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[700];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìÅ Upload Logo File\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[500],\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tJPG, PNG, GIF (max 5MB)\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{customLogoUrl && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.neutral[50],\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tLogo Preview:\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\talt=\"Custom logo\"\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonError={() => {\n\t\t\t\t\t\t\t\t\t\t\t// Handle broken image URLs\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Failed to load custom logo URL');\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl('');\n\t\t\t\t\t\t\t\t\t\t\t\t// Clear uploaded file from localStorage\n\t\t\t\t\t\t\t\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.accent.pingRed[500],\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.accent.pingRed[600]}`,\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[600];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[500];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRemove Logo\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Environment ID - Hide when worker token is available */}\n\t\t\t\t\t\t{!hasWorkerToken && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"env-id\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tEnvironment ID\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"env-id\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setEnvironmentId(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* SQLite Database Stats */}\n\t\t\t\t\t\t{environmentId && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<SQLiteStatsDisplayV8\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tcompact={false}\n\t\t\t\t\t\t\t\t\trefreshInterval={30}\n\t\t\t\t\t\t\t\t\tshowRefreshButton={true}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Username */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUsername\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{environmentId && tokenStatus.isValid ? (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\toptions={userOptions}\n\t\t\t\t\t\t\t\t\tonChange={setUsername}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Type to search across 16,000+ users...\"\n\t\t\t\t\t\t\t\t\tisLoading={isLoadingUsers}\n\t\t\t\t\t\t\t\t\tonSearchChange={setSearchQuery}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setUsername(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* MFA Policy Dropdown */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"mfa-policy\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tMFA Policy\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{isPoliciesLoading ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tLoading policies...\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policiesError ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#ef4444', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tError loading policies: {policiesError}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policies.length === 0 ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tNo MFA policies found. Please check your environment ID and worker token.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"mfa-policy\"\n\t\t\t\t\t\t\t\t\tvalue={selectedPolicy?.id || ''}\n\t\t\t\t\t\t\t\t\toptions={policyOptions}\n\t\t\t\t\t\t\t\t\tonChange={selectPolicy}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Select an MFA policy...\"\n\t\t\t\t\t\t\t\t\tisLoading={isPoliciesLoading}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tSelect the MFA policy to use for device registration\n\t\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t\t{/* Policy Summary - Collapsible */}\n\t\t\t\t\t\t\t{selectedPolicy && (\n\t\t\t\t\t\t\t\t<details\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<summary\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\tuserSelect: 'none',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüìã Policy Details\n\t\t\t\t\t\t\t\t\t</summary>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '12px', fontSize: '13px', color: '#4b5563' }}>\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Policy Name:</strong> {String(selectedPolicy.name)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedPolicy.default && (\n\t\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px', color: '#059669' }}>\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>‚úì Default Policy</strong>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Enabled Devices:</strong>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '6px' }}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'sms') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì± SMS\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'email') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t‚úâÔ∏è Email\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'totp') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîê TOTP\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'fido2') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîë FIDO2\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'mobile') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì≤ Mobile\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'voice') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüìû Voice\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</details>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Worker Token Status */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t\tpaddingRight: '16px',\n\t\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={setEnvironmentId}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* User Token Status */}\n\t\t\t\t\t\t\t{userToken && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\t'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05))',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #10b981',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '20px' }}>üë§</span>\n\t\t\t\t\t\t\t\t\t\t<strong style={{ color: '#047857', fontSize: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t\tUser Token Active\n\t\t\t\t\t\t\t\t\t\t</strong>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: '14px', color: '#059669', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t\t‚úì User authentication token available\n\t\t\t\t\t\t\t\t\t\t<br />‚úì Ready for User Flow device registration\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Flow Mode Selection */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',\n\t\t\t\t\t\t\tgap: '16px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Registration Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => setFlowMode('registration')}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>‚ûï</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#047857',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Registration\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tRegister a new MFA device for a user. Create SMS, Email, TOTP, Mobile Push,\n\t\t\t\t\t\t\t\t\t\tWhatsApp, or FIDO2 devices.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t{/* Authentication Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tif (!userToken) {\n\t\t\t\t\t\t\t\t\tsetShowAuthLoginModal(true);\n\t\t\t\t\t\t\t\t\ttoastV8.info('üîê Please complete user login before device authentication.', {\n\t\t\t\t\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-4px)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 8px 24px rgba(59, 130, 246, 0.2)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>üîì</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#1d4ed8',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Authentication\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tAuthenticate using an existing MFA device. Verify user identity with OTP, push\n\t\t\t\t\t\t\t\t\t\tnotification, or security key.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{showAuthLoginModal && (\n\t\t\t\t\t<UserLoginModalV8\n\t\t\t\t\t\tisOpen={showAuthLoginModal}\n\t\t\t\t\t\tonClose={() => setShowAuthLoginModal(false)}\n\t\t\t\t\t\tonTokenReceived={(token) => {\n\t\t\t\t\t\t\tsetUserToken(token);\n\t\t\t\t\t\t\tsetShowAuthLoginModal(false);\n\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tenvironmentId={authEnvIdForModal}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</>\n\t\t);\n\t}\n\n\t// Authentication flow - dedicated view (device selection + OTP modals only; no registration grid)\n\tif (flowMode === 'authentication') {\n\t\treturn (\n\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\tsetSelectedAuthDevice(null);\n\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t‚Üê Back\n\t\t\t\t\t</button>\n\t\t\t\t\t<h1\n\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t>\n\t\t\t\t\t\tüîì Device Authentication\n\t\t\t\t\t</h1>\n\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\t{selectedAuthDevice && !showOTPModal\n\t\t\t\t\t\t\t? `Authenticating with ${selectedAuthDevice.type} ‚Äî enter the code when prompted.`\n\t\t\t\t\t\t\t: `Select an MFA device to authenticate for ${username || 'the user'}`}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t\t{!showDeviceSelectionModal && !showOTPModal && (\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowDeviceSelectionModal(true)}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tSelect MFA device\n\t\t\t\t\t</button>\n\t\t\t\t)}\n\t\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\t\tonClose={() => {\n\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t// Keep flowMode so user stays in auth flow; only clear if they click Back\n\t\t\t\t\t}}\n\t\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\t\tusername={username}\n\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t/>\n\t\t\t\t{showOTPModal && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.6)',\n\t\t\t\t\t\t\tbackdropFilter: 'blur(4px)',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t\t\tanimation: 'fadeIn 0.2s ease-out',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t{`\n\t\t\t\t\t\t\t@keyframes fadeIn {\n\t\t\t\t\t\t\t\tfrom { opacity: 0; }\n\t\t\t\t\t\t\t\tto { opacity: 1; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes slideUp {\n\t\t\t\t\t\t\t\tfrom { \n\t\t\t\t\t\t\t\t\topacity: 0;\n\t\t\t\t\t\t\t\t\ttransform: translateY(20px); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tto { \n\t\t\t\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t\t\t\t\ttransform: translateY(0); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes pulse {\n\t\t\t\t\t\t\t\t0%, 100% { opacity: 1; }\n\t\t\t\t\t\t\t\t50% { opacity: 0.5; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`}\n\t\t\t\t\t\t</style>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\tborderRadius: '24px',\n\t\t\t\t\t\t\t\tpadding: '48px 40px',\n\t\t\t\t\t\t\t\tmaxWidth: '480px',\n\t\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\t\tboxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',\n\t\t\t\t\t\t\t\tanimation: 'slideUp 0.3s ease-out',\n\t\t\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Logo Area */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '32px' }}>\n\t\t\t\t\t\t\t\t{customLogoUrl ? (\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\t\talt=\"Organization logo\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '120px',\n\t\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonError={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\t// Fallback to default icon if image fails to load\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.display = 'none';\n\t\t\t\t\t\t\t\t\t\t\t\tconst fallback = document.createElement('div');\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.style.cssText = `\n\t\t\t\t\t\t\t\t\t\t\t\twidth: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\theight: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: 0 auto 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: center;\n\t\t\t\t\t\t\t\t\t\t\t\tjustifyContent: center;\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: 36px;\n\t\t\t\t\t\t\t\t\t\t\t\tboxShadow: 0 10px 25px rgba(102, 126, 234, 0.3);\n\t\t\t\t\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.textContent = 'üîê';\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.parentElement!.appendChild(fallback);\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\theight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto 20px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '20px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '36px',\n\t\t\t\t\t\t\t\t\t\t\tboxShadow: '0 10px 25px rgba(102, 126, 234, 0.3)',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüîê\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tVerification Code\n\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\tEnter the 6-digit code sent to your <strong>{selectedAuthDevice?.type}</strong>{' '}\n\t\t\t\t\t\t\t\t\tdevice\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* OTP Input */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\t\t\tplaceholder=\"‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢\"\n\t\t\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tletterSpacing: '12px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow: otpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{otpCode.length > 0 && otpCode.length < 6 && (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\t\tanimation: 'pulse 2s ease-in-out infinite',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{6 - otpCode.length} more digit{6 - otpCode.length !== 1 ? 's' : ''} needed\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Resend Code Button */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={async () => {\n\t\t\t\t\t\t\t\t\t\tif (!selectedAuthDevice || !authenticationId) return;\n\t\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.info('Resending verification code...');\n\t\t\t\t\t\t\t\t\t\t\t// Re-initialize authentication to resend code\n\t\t\t\t\t\t\t\t\t\t\tconst response =\n\t\t\t\t\t\t\t\t\t\t\t\tawait MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\t\t\t\t\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\t\t\t\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicy?.id || '',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceId: selectedAuthDevice.id,\n\t\t\t\t\t\t\t\t\t\t\t\t\tregion: 'na',\n\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tif (response.status?.toUpperCase() === 'OTP_REQUIRED') {\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('New code sent to your device!');\n\t\t\t\t\t\t\t\t\t\t\t\tsetAuthenticationId(response.id);\n\t\t\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to resend code');\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Resend error:', error);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tcolor: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'transparent';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚Üª Resend Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Action Buttons */}\n\t\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#d1d5db';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f9fafb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'white';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6\n\t\t\t\t\t\t\t\t\t\t\t\t? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '#d1d5db',\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (otpCode.length === 6) {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚úì Verify Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Help Text */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<strong style={{ color: '#111827' }}>Didn't receive the code?</strong>\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\tCheck your spam folder or click \"Resend Code\" above\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t);\n\t}\n\n\t// Registration flow - show device type selection cards\n\treturn (\n\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t{/* Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #10b981 0%, #047857 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => setFlowMode(null)}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t‚Üê Back\n\t\t\t\t</button>\n\t\t\t\t<h1 style={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}>\n\t\t\t\t\t‚ûï Register MFA Device\n\t\t\t\t</h1>\n\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\tSelect a device type to register for {username || 'the user'}\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Device Type Cards */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',\n\t\t\t\t\tgap: '16px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t{DEVICE_TYPES.map((device) => {\n\t\t\t\t\tconst enabled = isDeviceEnabled(device.key);\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tkey={device.key}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => enabled && onSelectDeviceType(device.key)}\n\t\t\t\t\t\t\tdisabled={!enabled}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tbackground: enabled ? '#ffffff' : '#f9fafb',\n\t\t\t\t\t\t\t\tborder: `2px solid ${enabled ? '#e5e7eb' : '#f3f4f6'}`,\n\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\tcursor: enabled ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\topacity: enabled ? 1 : 0.5,\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#10b981';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ecfdf5';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>{device.icon}</span>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{device.name}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280' }}>{device.description}</p>\n\t\t\t\t\t\t\t{!enabled && (\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '12px', color: '#9ca3af' }}>\n\t\t\t\t\t\t\t\t\t(Not enabled)\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</div>\n\n\t\t\t{/* Device Selection Modal for Authentication */}\n\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t}}\n\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\tusername={username}\n\t\t\t\tenvironmentId={environmentId}\n\t\t\t/>\n\n\t\t\t{/* OTP Modal for Authentication */}\n\t\t\t{showOTPModal && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '400px',\n\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\tboxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '600' }}>\n\t\t\t\t\t\t\tEnter Verification Code\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '0 0 20px 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tCheck your {selectedAuthDevice?.type} device for the code\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\tplaceholder=\"000000\"\n\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 16px',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\tletterSpacing: '8px',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tmarginBottom: '20px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: otpCode.length === 6 ? '#3b82f6' : '#9ca3af',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tVerify\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Wrapper Component\n *\n * Wraps the content with MFACredentialProvider to provide global credential state\n */\nexport const UnifiedMFARegistrationFlowV8: React.FC<UnifiedMFARegistrationFlowV8Props> = (\n\tprops\n) => {\n\tconst location = useLocation();\n\n\t// Get device type from props or location state (can be undefined)\n\tconst initialDeviceType =\n\t\tprops.deviceType || (location.state as { deviceType?: DeviceConfigKey })?.deviceType;\n\n\t// State for selected device type (allows user to select if not provided)\n\tconst [selectedDeviceType, setSelectedDeviceType] = useState<DeviceConfigKey | undefined>(\n\t\tinitialDeviceType\n\t);\n\n\t// User token state for OAuth authentication (User Flow)\n\tconst [userToken, setUserToken] = useState<string | null>(() => {\n\t\t// Check if we already have a user token from previous OAuth flow\n\t\tconst savedCreds = CredentialsServiceV8.loadCredentials('user-login-v8', {\n\t\t\tflowKey: 'user-login-v8',\n\t\t\tflowType: 'oauth',\n\t\t\tincludeClientSecret: false,\n\t\t\tincludeRedirectUri: false,\n\t\t\tincludeLogoutUri: false,\n\t\t\tincludeScopes: false,\n\t\t});\n\t\treturn savedCreds?.accessToken || null;\n\t});\n\n\t// If no device type selected, show device type selection screen\n\tif (!selectedDeviceType) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<MFAHeaderV8\n\t\t\t\t\ttitle=\"MFA Unified Flow\"\n\t\t\t\t\tdescription=\"Register or authenticate MFA devices\"\n\t\t\t\t\tversionTag=\"V8\"\n\t\t\t\t\tcurrentPage=\"registration\"\n\t\t\t\t\tshowBackToMain={true}\n\t\t\t\t\theaderColor=\"pingRed\"\n\t\t\t\t/>\n\t\t\t\t<GlobalMFAProvider>\n\t\t\t\t\t<MFACredentialProvider>\n\t\t\t\t\t\t<DeviceTypeSelectionScreen\n\t\t\t\t\t\t\tonSelectDeviceType={setSelectedDeviceType}\n\t\t\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</MFACredentialProvider>\n\t\t\t\t</GlobalMFAProvider>\n\t\t\t\t{/* API display (bottom of page) */}\n\t\t\t\t<div style={{ marginTop: '24px' }}>\n\t\t\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\t\t\t\t</div>\n\t\t\t</>\n\t\t);\n\t}\n\n\treturn (\n\t\t<GlobalMFAProvider>\n\t\t\t<MFACredentialProvider>\n\t\t\t\t<UnifiedMFARegistrationFlowContent\n\t\t\t\t\t{...props}\n\t\t\t\t\tdeviceType={selectedDeviceType}\n\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t/>\n\t\t\t</MFACredentialProvider>\n\t\t</GlobalMFAProvider>\n\t);\n};\n\n// ============================================================================\n// CONTENT COMPONENT (MAIN LOGIC)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Content Component\n *\n * Contains the actual flow logic and integrates with:\n * - MFACredentialContext (global credential state)\n * - useWorkerToken hook (token status and auto-refresh)\n * - deviceFlowConfigs (device-specific configuration)\n * - MFAFlowBaseV8 (5-step framework)\n */\nconst UnifiedMFARegistrationFlowContent: React.FC<\n\tRequired<Pick<UnifiedMFARegistrationFlowV8Props, 'deviceType'>> &\n\t\tOmit<UnifiedMFARegistrationFlowV8Props, 'deviceType'> & {\n\t\t\tuserToken: string | null;\n\t\t\tsetUserToken: (token: string | null) => void;\n\t\t}\n> = ({ deviceType, onCancel, userToken, setUserToken }) => {\n\t// ========================================================================\n\t// CONFIGURATION\n\t// ========================================================================\n\n\t// React Router navigation\n\tconst navigate = useNavigate();\n\n\t// Load device-specific configuration\n\tconst config = useMemo(() => {\n\t\treturn getDeviceConfig(deviceType);\n\t}, [deviceType]);\n\n\t// ========================================================================\n\t// USER FLOW OAUTH STATE\n\t// ========================================================================\n\n\t// State for User Login Modal (OAuth authentication for User Flow)\n\tconst [showUserLoginModal, setShowUserLoginModal] = useState(false);\n\tconst [showUserTokenSuccess, setShowUserTokenSuccess] = useState(false);\n\tconst [userTokenForDisplay, setUserTokenForDisplay] = useState<string>('');\n\tconst [usernameFromToken, setUsernameFromToken] = useState<string>('');\n\tconst [showUsernameDropdown, setShowUsernameDropdown] = useState(false);\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\tconst envIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Pending registration data while waiting for OAuth (use ref to avoid stale closure)\n\tconst pendingRegistrationRef = useRef<{\n\t\tdeviceType: DeviceConfigKey;\n\t\tfields: Record<string, string>;\n\t\tflowType: string;\n\t\tprops: MFAFlowBaseRenderProps;\n\t} | null>(null);\n\n\t// Worker token state for validation in registration flow\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Detect OAuth callback and re-open modal if needed\n\tuseEffect(() => {\n\t\tconst urlParams = new URLSearchParams(window.location.search);\n\t\tconst code = urlParams.get('code');\n\t\tconst hasStoredState = sessionStorage.getItem('user_login_state_v8');\n\n\t\t// If we have OAuth callback params and stored state, re-open the modal to process callback\n\t\t// But only if we don't already have a user token (to prevent reopening after silent auth)\n\t\tif (code && hasStoredState && !showUserLoginModal && !userToken) {\n\t\t\tconsole.log('[UNIFIED-FLOW] OAuth callback detected - re-opening modal to process');\n\t\t\tsetShowUserLoginModal(true);\n\t\t}\n\t}, [showUserLoginModal, userToken]);\n\n\t// ========================================================================\n\t// STEP VALIDATION\n\t// ========================================================================\n\n\t/**\n\t * Validate Step 0 (Configuration)\n\t */\n\tconst validateStep0 = useCallback(\n\t\t(\n\t\t\tcredentials: MFACredentials,\n\t\t\ttoken: TokenStatusInfo,\n\t\t\tnavigation: ReturnType<typeof useStepNavigationV8>\n\t\t) => {\n\t\t\t// Always check for valid worker token (required for MFA device operations)\n\t\t\tif (!token.isValid) {\n\t\t\t\tnavigation.setValidationErrors(['Invalid or expired worker token']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Check required configuration\n\t\t\tif (!credentials.environmentId || !credentials.username) {\n\t\t\t\tnavigation.setValidationErrors(['Environment ID and Username are required']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\t\t[]\n\t);\n\n\t// ========================================================================\n\t// STEP RENDERERS\n\t// ========================================================================\n\n\t/**\n\t * Perform device registration API call (with token already available)\n\t */\n\tconst performRegistrationWithToken = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string,\n\t\t\ttoken?: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== PERFORM REGISTRATION WITH TOKEN =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Token:', token ? `Present (${token.length} chars)` : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setIsLoading available:', typeof props.setIsLoading);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setCredentials available:', typeof props.setCredentials);\n\n\t\t\ttry {\n\t\t\t\tprops.setIsLoading(true);\n\n\t\t\t\t// Update credentials with device fields and user token if provided\n\t\t\t\tprops.setCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tflowType, // Store flowType so activation step knows if OTP is required\n\t\t\t\t\t...fields,\n\t\t\t\t\t...(flowType === 'user' && token\n\t\t\t\t\t\t? { userToken: token, tokenType: 'user' }\n\t\t\t\t\t\t: flowType !== 'user'\n\t\t\t\t\t\t\t? { tokenType: 'worker' }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t}));\n\n\t\t\t\t// Register the device using proper API call\n\t\t\t\t// CRITICAL: Flow-specific device status\n\t\t\t\t// - Admin flow: ACTIVE (no OTP sent, device ready immediately)\n\t\t\t\t// - Admin ACTIVATION_REQUIRED: ACTIVATION_REQUIRED (sends OTP for admin to activate)\n\t\t\t\t// - User flow: ACTIVATION_REQUIRED (sends OTP for user to activate)\n\t\t\t\t// - FIDO2: ACTIVE (WebAuthn verification happens during registration)\n\t\t\t\tlet deviceStatus: 'ACTIVE' | 'ACTIVATION_REQUIRED' | undefined;\n\n\t\t\t\t// Determine device status based on flow type (applies to all device types including FIDO2)\n\t\t\t\tif (flowType === 'admin-active') {\n\t\t\t\t\tdeviceStatus = 'ACTIVE';\n\t\t\t\t} else if (flowType === 'admin-activation') {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED';\n\t\t\t\t} else {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED'; // user flow\n\t\t\t\t}\n\n\t\t\t\t// Special note for FIDO2: WebAuthn verification proves device works,\n\t\t\t\t// but we still respect the flow type for status determination\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t'[UNIFIED-FLOW] FIDO2 device - status determined by flow type:',\n\t\t\t\t\t\tdeviceStatus\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device status determined:', {\n\t\t\t\t\tflowType,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tdeviceStatus,\n\t\t\t\t\totpWillBeSent: deviceStatus === 'ACTIVATION_REQUIRED',\n\t\t\t\t\treason:\n\t\t\t\t\t\tselectedDeviceType === 'FIDO2'\n\t\t\t\t\t\t\t? 'FIDO2 - ACTIVE after WebAuthn verification'\n\t\t\t\t\t\t\t: 'User flow - OTP required for activation',\n\t\t\t\t});\n\n\t\t\t\t// Use same parameter construction as working MFA flows\n\t\t\t\ttype RegisterDeviceParamsWithToken = RegisterDeviceParams & {\n\t\t\t\t\ttokenType?: 'worker' | 'user';\n\t\t\t\t\tuserToken?: string | undefined;\n\t\t\t\t};\n\t\t\t\tlet baseParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\tenvironmentId: props.credentials.environmentId,\n\t\t\t\t\tusername: props.credentials.username,\n\t\t\t\t\ttype: selectedDeviceType,\n\t\t\t\t};\n\t\t\t\t// Per rightTOTP.md: Pass token type and user token if available\n\t\t\t\tif (flowType === 'user' && token) {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'user',\n\t\t\t\t\t\tuserToken: token,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'worker',\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Always include status for all device types\n\t\t\t\t// FIDO2: Set to ACTIVE since WebAuthn verification proves device works\n\t\t\t\t// Other devices: Set based on flow type (admin-active = ACTIVE, others = ACTIVATION_REQUIRED)\n\t\t\t\tif (deviceStatus !== undefined) {\n\t\t\t\t\tbaseParams.status = deviceStatus;\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registration base params:', {\n\t\t\t\t\tenvironmentId: baseParams.environmentId,\n\t\t\t\t\tusername: baseParams.username,\n\t\t\t\t\ttype: baseParams.type,\n\t\t\t\t\ttokenType: baseParams.tokenType,\n\t\t\t\t\tstatus: baseParams.status,\n\t\t\t\t\tflowType,\n\t\t\t\t});\n\n\t\t\t\t// Map form field names to API field names\n\t\t\t\t// Form uses 'deviceName' but API expects 'nickname' or 'name'\n\t\t\t\tconst mappedFields: Record<string, string> = { ...fields };\n\t\t\t\tif (mappedFields.deviceName) {\n\t\t\t\t\tmappedFields.nickname = mappedFields.deviceName;\n\t\t\t\t\tmappedFields.name = mappedFields.deviceName;\n\t\t\t\t\tdelete mappedFields.deviceName;\n\t\t\t\t}\n\n\t\t\t\t// Format phone number for SMS/WhatsApp devices\n\t\t\t\t// Form sends: { phoneNumber: '9725231586', countryCode: '+1' }\n\t\t\t\t// API expects: { phone: '+1.9725231586' }\n\t\t\t\tif (mappedFields.phoneNumber && mappedFields.countryCode) {\n\t\t\t\t\tconst countryCode = mappedFields.countryCode.replace('+', ''); // Remove + for formatting\n\t\t\t\t\tconst phoneNumber = mappedFields.phoneNumber.replace(/\\D/g, ''); // Remove non-digits\n\t\t\t\t\tmappedFields.phone = `+${countryCode}.${phoneNumber}`;\n\t\t\t\t\tconsole.log('[UNIFIED-FLOW] Formatted phone:', mappedFields.phone);\n\t\t\t\t\tdelete mappedFields.phoneNumber;\n\t\t\t\t\tdelete mappedFields.countryCode;\n\t\t\t\t}\n\n\t\t\t\t// Include device-specific fields (phone, email, etc.)\n\t\t\t\tconst deviceParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\t...baseParams,\n\t\t\t\t\t...mappedFields,\n\t\t\t\t\t// Include policy for TOTP devices (required for secret and keyUri to be returned)\n\t\t\t\t\t...(selectedDeviceType === 'TOTP' && selectedPolicyRef.current\n\t\t\t\t\t\t? { policy: selectedPolicyRef.current.id }\n\t\t\t\t\t\t: {}),\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registering device with params:', deviceParams);\n\n\t\t\t\tconst result = await MFAServiceV8_Legacy.registerDevice(deviceParams);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device registered:', result);\n\n\t\t\t\t// Update MFA state with device info\n\t\t\t\tconst registrationResult = result as unknown as Record<string, unknown>;\n\n\t\t\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result for TOTP:', {\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\tqrCode: registrationResult.qrCode,\n\t\t\t\t\t\tqrCodeUrl: registrationResult.qrCodeUrl,\n\t\t\t\t\t\tsecret: registrationResult.secret,\n\t\t\t\t\t\ttotpSecret: registrationResult.totpSecret,\n\t\t\t\t\t\tfullResult: result,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// ===============================================\n\n\t\t\t\t// Clear stored registration data after successful use\n\t\t\t\tlocalStorage.removeItem('mfa_registration_flow_type');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_fields');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_device_type');\n\n\t\t\t\tprops.setMfaState((prev) => {\n\t\t\t\t\t// TOTP: QR code will be rendered by QRCodeSVG component in UnifiedActivationStep\n\t\t\t\t\t// No need to generate QR code data URL here - just pass the keyUri\n\t\t\t\t\tconst newState: MFAState = {\n\t\t\t\t\t\t...prev,\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tdeviceStatus: result.status,\n\t\t\t\t\t\t...(registrationResult.deviceActivateUri\n\t\t\t\t\t\t\t? { deviceActivateUri: String(registrationResult.deviceActivateUri) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'TOTP'\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\ttotpSecret: String(registrationResult.secret || ''),\n\t\t\t\t\t\t\t\t\tkeyUri: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tqrCodeUrl: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tshowQr: !!(registrationResult.secret || registrationResult.keyUri),\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'FIDO2' &&\n\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tpublicKeyCredentialCreationOptions:\n\t\t\t\t\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions,\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'MOBILE' && registrationResult.pairingKey\n\t\t\t\t\t\t\t? { pairingKey: String(registrationResult.pairingKey) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t};\n\n\t\t\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\t\t\tfullState: newState,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t// ================================================\n\n\t\t\t\t\treturn newState;\n\t\t\t\t});\n\n\t\t\t\t// FIDO2: Check if we already have credential data (from WebAuthn modal)\n\t\t\t\t// If credentialId and publicKey are present, registration is complete\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tif (fields.credentialId && fields.publicKey) {\n\t\t\t\t\t\t// WebAuthn already completed via modal - device fully registered\n\n\t\t\t\t\t\t// Admin Flow: Show QR but skip OTP validation - device ready immediately\n\t\t\t\t\t\t// Admin ACTIVATION_REQUIRED & User Flow: Show QR and require OTP validation\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tflowType === 'admin-active' ||\n\t\t\t\t\t\t\tflowType === 'admin-activation' ||\n\t\t\t\t\t\t\tresult.status === 'ACTIVE'\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t'[UNIFIED-FLOW] Admin flow or ACTIVE status - proceeding to show QR without OTP requirement'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered successfully!${flowType === 'admin-active' || flowType === 'admin-activation' ? ' Device is ready to use.' : ''}`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t// For Admin Flow, go to API docs page instead of OTP page\n\t\t\t\t\t\t\t// For User Flow, go to User Login step (Step 1)\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (result.status === 'ACTIVATION_REQUIRED') {\n\t\t\t\t\t\t\t// Device requires activation - PingOne automatically sends OTP\n\t\t\t\t\t\t\t// This applies to both admin_activation_required and user flow\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered! OTP has been sent automatically.`\n\t\t\t\t\t\t\t);\n  // DO NOT auto-advance for OTP-required devices\n\t\t\t\t\t\t\t// User should manually click Next after receiving OTP\n\t\t\t\t\t\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation - waiting for user to proceed manually`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Unknown status, proceed with flow-specific navigation\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} // End of FIDO2 section\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Registration failed:', error);\n\t\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Device registration failed';\n\n\t\t\t\t// Check if error is due to too many devices\n\t\t\t\tif (errorMessage.includes('Too many devices')) {\n\t\t\t\t\ttoastV8.error(\n\t\t\t\t\t\t`${errorMessage}\\n\\n‚ÑπÔ∏è You can manage your devices at:\\nhttps://localhost:3000/v8/delete-all-devices`,\n\t\t\t\t\t\t{ duration: 8000 }\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\ttoastV8.error(errorMessage);\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tprops.setIsLoading(false);\n\t\t\t}\n\t\t},\n\t\t[config.displayName, toastV8]\n\t);\n\n\t/**\n\t * Handle user token received from OAuth flow\n\t */\n\tconst handleUserTokenReceived = useCallback(\n\t\t(token: string) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== USER TOKEN RECEIVED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Token length:', token.length);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current pending registration:', pendingRegistrationRef.current);\n\n\t\t\tsetUserToken(token);\n\t\t\tsetUserTokenForDisplay(token);\n\n\t\t\t// Decode JWT to extract username\n\t\t\ttry {\n\t\t\t\tconst base64Url = token.split('.')[1];\n\t\t\t\tconst base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n\t\t\t\tconst jsonPayload = decodeURIComponent(\n\t\t\t\t\tatob(base64)\n\t\t\t\t\t\t.split('')\n\t\t\t\t\t\t.map((c) => `%${`00${c.charCodeAt(0).toString(16)}`.slice(-2)}`)\n\t\t\t\t\t\t.join('')\n\t\t\t\t);\n\t\t\t\tconst payload = JSON.parse(jsonPayload);\n\t\t\t\tconst username =\n\t\t\t\t\tpayload.username || payload.preferred_username || payload.sub || 'Unknown User';\n\t\t\t\tsetUsernameFromToken(username);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Extracted username:', username);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Failed to decode JWT:', error);\n\t\t\t\tsetUsernameFromToken('Unknown User');\n\t\t\t}\n\n\t\t\t// If we have pending registration, show success page first\n\t\t\tconst pending = pendingRegistrationRef.current;\n\t\t\tif (pending) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Found pending registration, showing success page first...');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending data:', {\n\t\t\t\t\tdeviceType: pending.deviceType,\n\t\t\t\t\tflowType: pending.flowType,\n\t\t\t\t\thasProps: !!pending.props,\n\t\t\t\t\thasFields: !!pending.fields,\n\t\t\t\t});\n\n\t\t\t\ttoastV8.success('‚úÖ Authentication successful! Your user token is ready.', {\n\t\t\t\t\tduration: 4000,\n\t\t\t\t});\n\n\t\t\t\t// Close login modal and show success page\n\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\tsetShowUserTokenSuccess(true);\n\t\t\t} else {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] WARNING: No pending registration found after OAuth!');\n\t\t\t}\n\t\t},\n\t\t[setUserToken]\n\t);\n\n\t/**\n\t * Handle continue from user token success page\n\t */\n\tconst handleContinueAfterUserLogin = useCallback(() => {\n\t\tconsole.log(\n\t\t\t'[UNIFIED-FLOW] User clicked continue after login, proceeding with registration...'\n\t\t);\n\n\t\tconst pending = pendingRegistrationRef.current;\n\t\tif (pending && userToken) {\n\t\t\tconst { deviceType: pendingDeviceType, fields, flowType, props } = pending;\n\t\t\tpendingRegistrationRef.current = null;\n\n\t\t\t// Hide success page\n\t\t\tsetShowUserTokenSuccess(false);\n\n\t\t\t// Continue with registration\n\t\t\tsetTimeout(() => {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Now executing performRegistrationWithToken...');\n\t\t\t\tperformRegistrationWithToken(props, pendingDeviceType, fields, flowType, userToken);\n\t\t\t}, 100);\n\t\t}\n\t}, [userToken, performRegistrationWithToken]);\n\n\t/**\n\t * Perform device registration API call\n\t * Checks if User Flow needs OAuth first, otherwise proceeds with registration\n\t */\n\tconst performRegistration = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== DEVICE REGISTRATION SUBMITTED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current userToken:', userToken ? 'Present' : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\n\t\t\t// CRITICAL: Validate worker token before allowing any registration\n\t\t\tif (!workerToken.tokenStatus.isValid) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Cannot proceed - no valid worker token');\n\t\t\t\ttoastV8.error(\n\t\t\t\t\t'‚ùå Worker token required for device registration. Please configure worker token credentials first.',\n\t\t\t\t\t{\n\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// For User Flow, check if we need OAuth authentication first\n\t\t\tif (flowType === 'user' && !userToken) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] User flow selected but no token - showing OAuth modal');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Storing pending registration...');\n\n\t\t\t\t// Store pending registration data\n\t\t\t\tpendingRegistrationRef.current = {\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tfields,\n\t\t\t\t\tflowType,\n\t\t\t\t\tprops,\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending registration stored:', pendingRegistrationRef.current);\n\n\t\t\t\t// Set return target for device registration flow\n\t\t\t\tReturnTargetServiceV8U.setReturnTarget(\n\t\t\t\t\t'mfa_device_registration',\n\t\t\t\t\t'/v8/unified-mfa',  // Return to unified MFA flow\n\t\t\t\t\t2  // Step 2: Device Selection\n\t\t\t\t);\n\n\t\t\t\t// Show the user login modal\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'üîê User Flow requires PingOne authentication. Please complete the login to continue with device registration.',\n\t\t\t\t\t{ duration: 6000 }\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t'[UNIFIED-FLOW] Proceeding directly with registration (token exists or admin flow)'\n\t\t\t);\n\t\t\t// Proceed with registration (using existing token for user flow)\n\t\t\tawait performRegistrationWithToken(\n\t\t\t\tprops,\n\t\t\t\tselectedDeviceType,\n\t\t\t\tfields,\n\t\t\t\tflowType,\n\t\t\t\tuserToken || undefined\n\t\t\t);\n\t\t},\n\t\t[workerToken.tokenStatus.isValid, userToken]\n\t);\n\n\t/**\n\t * Render Step 0: Configuration (environment, user, policy)\n\t */\n\tconst renderStep0 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn (\n\t\t\t\t<UnifiedDeviceRegistrationForm\n\t\t\t\t\tinitialDeviceType={deviceType}\n\t\t\t\t\tonSubmit={async (selectedDeviceType, fields, flowType) => {\n\t\t\t\t\t\tawait performRegistration(props, selectedDeviceType, fields, flowType);\n\t\t\t\t\t}}\n\t\t\t\t\tonCancel={() => {\n\t\t\t\t\t\tif (onCancel) onCancel();\n\t\t\t\t\t}}\n\t\t\t\t\ttokenStatus={props.tokenStatus}\n\t\t\t\t\tusername={props.credentials.username}\n\t\t\t\t/>\n\t\t\t);\n\t\t},\n\t\t[deviceType, onCancel, performRegistration]\n\t);\n\n\t/**\n\t * Render Step 1: User Login using Authorization Code Flow with PKCE\n\t */\n\tconst renderStep1 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <UserLoginStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 2: Device Selection (option to call registration if want new device, or have no devices)\n\t */\n\tconst renderStep2 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 3: Device-Specific Actions (OTP/QR Generation, FIDO, Mobile Push)\n\t */\n\tconst renderStep3 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific based on the device type\n\t\t\t// For now, return the activation step which handles device-specific logic\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 4: OTP Validation / Confirmation\n\t */\n\tconst renderStep4 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific validation\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 5: API Documentation\n\t */\n\tconst renderStep5 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <APIDocsStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 6: Success screen with all user data and other valuable options\n\t */\n\tconst renderStep6 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <SuccessStepV8 renderProps={props} />;\n\t}, []);\n\n\t// Step labels for device authentication flow\n\tconst stepLabels = useMemo(() => {\n\t\tif (deviceType === 'FIDO2') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Start FIDO in Browser',\n\t\t\t\t'Passkey confirmation',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else if (deviceType === 'MOBILE') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Push to Mobile App',\n\t\t\t\t'User Confirms on Mobile',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else {\n\t\t\t// SMS, Email, TOTP, WhatsApp\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Generate OTP/QR',\n\t\t\t\t'Validate OTP',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t}\n\t}, [deviceType]);\n\n\tconst shouldHideNextButton = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\tif (props.nav.currentStep === 0) {\n\t\t\treturn true; // Hide Next button on configuration step, use form submit\n\t\t}\n\t\tif (props.nav.currentStep === 1) {\n\t\t\treturn true; // Hide Next button on user login step, use authentication button\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\treturn (\n\t\t<>\n\t\t\t<MFAFlowBaseV8\n\t\t\t\tdeviceType={deviceType}\n\t\t\t\trenderStep0={renderStep0}\n\t\t\t\trenderStep1={renderStep1}\n\t\t\t\trenderStep2={renderStep2}\n\t\t\t\trenderStep3={renderStep3}\n\t\t\t\trenderStep4={renderStep4}\n\t\t\t\trenderStep5={renderStep5}\n\t\t\t\trenderStep6={renderStep6}\n\t\t\t\tvalidateStep0={validateStep0}\n\t\t\t\tstepLabels={stepLabels}\n\t\t\t\tshouldHideNextButton={shouldHideNextButton}\n\t\t\t\tflowType=\"device-auth\"\n\t\t\t/>\n\t\t\t<div style={{ height: '300px' }} />\n\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\n\t\t\t{/* User Login Modal for User Flow OAuth */}\n\t\t\t<UserLoginModalV8\n\t\t\t\tisOpen={showUserLoginModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\t\tpendingRegistrationRef.current = null;\n\t\t\t\t}}\n\t\t\t\tonTokenReceived={handleUserTokenReceived}\n\t\t\t\tenvironmentId={envIdForModal}\n\t\t\t/>\n\n\t\t\t{/* User Token Success Page - Show token after OAuth login */}\n\t\t\t{showUserTokenSuccess && userTokenForDisplay && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 10000,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\t\t\tboxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Success Header */}\n\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\twidth: '64px',\n\t\t\t\t\t\t\t\t\theight: '64px',\n\t\t\t\t\t\t\t\t\tborderRadius: '50%',\n\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>‚úÖ</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<h2 style={{ margin: '0 0 8px 0', fontSize: '24px', color: '#1f2937' }}>\n\t\t\t\t\t\t\t\tAuthentication Successful!\n\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\tYour user token has been obtained and is ready to use.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Username Dropdown */}\n\t\t\t\t\t\t{usernameFromToken && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUsernameDropdown(!showUsernameDropdown)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tpadding: 0,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: showUsernameDropdown ? '12px' : 0,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '16px', color: '#374151' }}>Username</h3>\n\t\t\t\t\t\t\t\t\t{showUsernameDropdown ? (\n\t\t\t\t\t\t\t\t\t\t<FiChevronUp size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t<FiChevronDown size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{showUsernameDropdown && (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{usernameFromToken}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(usernameFromToken);\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('Username copied to clipboard!');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüìã Copy Username\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Token Display */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<h3 style={{ margin: '0 0 12px 0', fontSize: '16px', color: '#374151' }}>\n\t\t\t\t\t\t\t\tUser Access Token\n\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{userTokenForDisplay}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(userTokenForDisplay);\n\t\t\t\t\t\t\t\t\ttoastV8.success('Token copied to clipboard!');\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüìã Copy Token\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Next Steps Info */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#eff6ff',\n\t\t\t\t\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#1e40af', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t<strong>Next:</strong> Click \"Continue with Registration\" to proceed with your{' '}\n\t\t\t\t\t\t\t\t{config.displayName} device registration using this user token.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Continue Button */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleContinueAfterUserLogin}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\tbackground: '#10b981',\n\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tboxShadow: '0 2px 8px rgba(16, 185, 129, 0.3)',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tContinue with Registration ‚Üí\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</>\n\t);\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default UnifiedMFARegistrationFlowV8;\n"}},{"log":["info",[{"elements":[],"content":"React relies on hook dependencies to determine when to re-compute Effects.\nSpecifying more dependencies than required can lead to "},{"elements":["Emphasis"],"content":"unnecessary re-rendering"},{"elements":[],"content":"\nand "},{"elements":["Emphasis"],"content":"degraded performance"},{"elements":[],"content":"."}]]},{"log":["info",[{"elements":[],"content":"Unsafe fix: Remove the extra dependencies from the list."}]]},{"diff":{"dictionary":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\t\t\t\tprops.setIsLoading(false);\n\t\t\t}\n\t\t},\n\t\t[config.displayName, toastV8]\n\t);\n\nexport default UnifiedMFARegistrationFlowV8;\n","ops":[{"diffOp":{"equal":{"range":[0,73]}}},{"equalLines":{"line_count":2329}},{"diffOp":{"equal":{"range":[73,113]}}},{"diffOp":{"equal":{"range":[113,135]}}},{"diffOp":{"delete":{"range":[135,144]}}},{"diffOp":{"equal":{"range":[144,145]}}},{"diffOp":{"equal":{"range":[145,150]}}},{"equalLines":{"line_count":526}},{"diffOp":{"equal":{"range":[150,196]}}}]}}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/UnifiedMFARegistrationFlowV8_Legacy.tsx"},"span":[64272,64283],"sourceCode":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\n * @description Unified MFA Registration Flow - Single component for all 6 device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Replace 6 device-specific flow components (SMS, Email, Mobile, WhatsApp, TOTP, FIDO2)\n * with a single configurable component using deviceFlowConfigs for device-specific behavior.\n *\n * Architecture:\n * - Configuration-driven using deviceFlowConfigs.ts\n * - Dynamic form rendering for simple devices (SMS, Email, WhatsApp)\n * - Custom components for complex devices (TOTP, FIDO2, Mobile)\n * - Integrates with MFACredentialContext and useWorkerToken hook\n * - Uses existing MFAFlowBaseV8 for 5-step framework\n *\n * @example\n * <UnifiedMFARegistrationFlowV8\n *   deviceType=\"SMS\"\n *   onSuccess={(result) => console.log('Device registered:', result.deviceId)}\n * />\n */\n\nimport * as React from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { FiChevronDown, FiChevronUp } from 'react-icons/fi';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { MFAHeaderV8 } from '@/v8/components/MFAHeaderV8';\nimport type { SearchableDropdownOption } from '@/v8/components/SearchableDropdownV8';\nimport { SearchableDropdownV8 } from '@/v8/components/SearchableDropdownV8';\nimport { SQLiteStatsDisplayV8 } from '@/v8/components/SQLiteStatsDisplayV8';\nimport { SuperSimpleApiDisplayV8 } from '@/v8/components/SuperSimpleApiDisplayV8';\nimport { UserLoginModalV8 } from '@/v8/components/UserLoginModalV8';\nimport { getDeviceConfig } from '@/v8/config/deviceFlowConfigs';\nimport type { DeviceConfigKey, DeviceRegistrationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport { PING_IDENTITY_COLORS } from '@/v8/constants/pingIdentityColors';\nimport { GlobalMFAProvider } from '@/v8/contexts/GlobalMFAContext';\nimport { MFACredentialProvider } from '@/v8/contexts/MFACredentialContext';\nimport { APIDocsStepV8 } from '@/v8/flows/shared/APIDocsStepV8';\nimport { SuccessStepV8 } from '@/v8/flows/shared/SuccessStepV8';\nimport { UserLoginStepV8 } from '@/v8/flows/shared/UserLoginStepV8';\nimport { useMFAPolicies } from '@/v8/hooks/useMFAPolicies';\nimport { useStepNavigationV8 } from '@/v8/hooks/useStepNavigationV8';\nimport { useUserSearch } from '@/v8/hooks/useUserSearch';\nimport { useWorkerToken } from '@/v8/hooks/useWorkerToken';\nimport { CredentialsServiceV8 } from '@/v8/services/credentialsServiceV8';\nimport { globalEnvironmentService } from '@/v8/services/globalEnvironmentService';\nimport { MfaAuthenticationServiceV8 } from '@/v8/services/mfaAuthenticationServiceV8';\nimport { type MFAFeatureFlag, MFAFeatureFlagsV8 } from '@/v8/services/mfaFeatureFlagsV8';\nimport MFAServiceV8_Legacy, { type RegisterDeviceParams } from '@/v8/services/mfaServiceV8_Legacy';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport type { TokenStatusInfo } from '@/v8/services/workerTokenStatusServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { ReturnTargetServiceV8U } from '@/v8u/services/returnTargetServiceV8U';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type MFAFlowBaseRenderProps, MFAFlowBaseV8 } from '../shared/MFAFlowBaseV8';\nimport type { DeviceAuthenticationPolicy, MFACredentials, MFAState } from '../shared/MFATypes';\nimport { UnifiedActivationStep } from './components/UnifiedActivationStep';\nimport { UnifiedDeviceRegistrationForm } from './components/UnifiedDeviceRegistrationForm';\nimport { UnifiedDeviceSelectionModal } from './components/UnifiedDeviceSelectionModal';\nimport { UnifiedSuccessStep } from './components/UnifiedSuccessStep';\nimport './UnifiedMFAFlow.css';\n\nconst MODULE_TAG = '[üîÑ UNIFIED-MFA-FLOW-V8]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedMFARegistrationFlowV8Props {\n\t/** Device type to render (optional - can be provided via navigation state) */\n\tdeviceType?: DeviceConfigKey;\n\n\t/** Optional initial credentials (for pre-filled forms) */\n\tinitialCredentials?: Partial<MFACredentials>;\n\n\t/** Optional callback when registration succeeds */\n\tonSuccess?: (result: DeviceRegistrationResult) => void;\n\n\t/** Optional callback when user cancels flow */\n\tonCancel?: () => void;\n\n\t/** Optional initial step (defaults to 0) */\n\tinitialStep?: number;\n\n\t/** Optional: Skip configuration step if already configured */\n\tskipConfiguration?: boolean;\n\n\t/** Optional: Force specific registration flow type */\n\tregistrationFlowType?: 'admin-active' | 'admin-activation' | 'user';\n}\n\n// ============================================================================\n// MFA FLOW SELECTION SCREEN\n// ============================================================================\n\ntype FlowMode = 'registration' | 'authentication';\n\n/** Map device types to their feature flags */\nconst DEVICE_FLAG_MAP: Record<DeviceConfigKey, MFAFeatureFlag> = {\n\tSMS: 'mfa_unified_sms',\n\tEMAIL: 'mfa_unified_email',\n\tMOBILE: 'mfa_unified_mobile',\n\tWHATSAPP: 'mfa_unified_whatsapp',\n\tTOTP: 'mfa_unified_totp',\n\tFIDO2: 'mfa_unified_fido2',\n};\n\nconst DEVICE_TYPES: { key: DeviceConfigKey; icon: string; name: string; description: string }[] = [\n\t{ key: 'SMS', icon: 'üì±', name: 'SMS', description: 'Receive OTP codes via text message' },\n\t{ key: 'EMAIL', icon: '‚úâÔ∏è', name: 'Email', description: 'Receive OTP codes via email' },\n\t{\n\t\tkey: 'TOTP',\n\t\ticon: 'üîê',\n\t\tname: 'Authenticator App (TOTP)',\n\t\tdescription: 'Use Google Authenticator, Authy, or similar',\n\t},\n\t{\n\t\tkey: 'MOBILE',\n\t\ticon: 'üì≤',\n\t\tname: 'Mobile Push',\n\t\tdescription: 'Receive push notifications on your phone',\n\t},\n\t{ key: 'WHATSAPP', icon: 'üí¨', name: 'WhatsApp', description: 'Receive OTP codes via WhatsApp' },\n\t{\n\t\tkey: 'FIDO2',\n\t\ticon: 'üîë',\n\t\tname: 'Security Key (FIDO2)',\n\t\tdescription: 'Use a hardware security key or passkey',\n\t},\n];\n\n/** Check if a device type is enabled via feature flags */\nconst isDeviceEnabled = (deviceKey: DeviceConfigKey): boolean => {\n\tconst flag = DEVICE_FLAG_MAP[deviceKey];\n\treturn MFAFeatureFlagsV8.isEnabled(flag);\n};\n\ninterface DeviceTypeSelectionScreenProps {\n\tonSelectDeviceType: (deviceType: DeviceConfigKey) => void;\n\tuserToken?: string | null;\n\tsetUserToken: (token: string | null) => void;\n}\n\nconst DeviceTypeSelectionScreen: React.FC<DeviceTypeSelectionScreenProps> = ({\n\tonSelectDeviceType,\n\tuserToken,\n\tsetUserToken,\n}) => {\n\tconst [flowMode, setFlowMode] = useState<FlowMode | null>(null);\n\tconst [environmentId, setEnvironmentId] = useState('');\n\tconst [username, setUsername] = useState('');\n\tconst [showDeviceSelectionModal, setShowDeviceSelectionModal] = useState(false);\n\tconst [showOTPModal, setShowOTPModal] = useState(false);\n\tconst [otpCode, setOtpCode] = useState('');\n\tconst [authenticationId, setAuthenticationId] = useState<string | null>(null);\n\tconst [selectedAuthDevice, setSelectedAuthDevice] = useState<{\n\t\tid: string;\n\t\ttype: string;\n\t\tnickname?: string;\n\t} | null>(null);\n\tconst [customLogoUrl, setCustomLogoUrl] = useState<string>('');\n\tconst [showAuthLoginModal, setShowAuthLoginModal] = useState(false);\n\tconst authEnvIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Load uploaded logo from localStorage on mount\n\tuseEffect(() => {\n\t\ttry {\n\t\t\tconst savedUpload = localStorage.getItem('custom-logo-upload');\n\t\t\tif (savedUpload) {\n\t\t\t\tconst uploadData = JSON.parse(savedUpload);\n\t\t\t\t// Handle both old format (objectUrl) and new format (base64Url)\n\t\t\t\tif (uploadData.base64Url) {\n\t\t\t\t\tsetCustomLogoUrl(uploadData.base64Url);\n\t\t\t\t} else if (uploadData.objectUrl) {\n\t\t\t\t\t// Old format - try to convert if possible, otherwise clear it\n\t\t\t\t\tconsole.warn('Old logo format detected - please re-upload your logo');\n\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load uploaded logo from localStorage:', error);\n\t\t\t// Clear corrupted data\n\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t}\n\t}, []);\n\n\t// Use worker token hook for token management\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Extract environment ID from worker token when available\n\tuseEffect(() => {\n\t\tconst extractEnvironmentId = async () => {\n\t\t\ttry {\n\t\t\t\tconst token = await workerTokenServiceV8.getToken();\n\t\t\t\tif (token && !environmentId) {\n\t\t\t\t\tconst parts = token.split('.');\n\t\t\t\t\tif (parts.length === 3) {\n\t\t\t\t\t\tconst payload = JSON.parse(atob(parts[1]));\n\t\t\t\t\t\tif (payload.environmentId) {\n\t\t\t\t\t\t\tsetEnvironmentId(payload.environmentId);\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`${MODULE_TAG} Environment ID extracted from worker token:`,\n\t\t\t\t\t\t\t\tpayload.environmentId\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Failed to extract environment ID from worker token:`, error);\n\t\t\t}\n\t\t};\n\n\t\textractEnvironmentId();\n\t}, [environmentId]);\n\n\tconst hasWorkerToken = workerToken.tokenStatus.isValid;\n\n\t// Use user search hook for user fetching and search\n\tconst {\n\t\tusers,\n\t\tisLoading: isLoadingUsers,\n\t\tsetSearchQuery,\n\t} = useUserSearch({\n\t\tenvironmentId,\n\t\ttokenValid: workerToken.tokenStatus.isValid,\n\t\tmaxPages: 100,\n\t\tuseCache: true,\n\t});\n\tconst tokenStatus = workerToken.tokenStatus;\n\n\t// Debug: Log users type to understand the issue\n\tuseEffect(() => {\n\t\tconsole.log(`${MODULE_TAG} users type check:`, {\n\t\t\tusers,\n\t\t\tisArray: Array.isArray(users),\n\t\t\ttype: typeof users,\n\t\t\tconstructor: users?.constructor?.name,\n\t\t});\n\t}, [users]);\n\n\t// Load Environment ID and username from global services on mount\n\tuseEffect(() => {\n\t\t// Initialize the service first to load from localStorage\n\t\tglobalEnvironmentService.initialize();\n\t\tconst savedEnvId = globalEnvironmentService.getEnvironmentId();\n\t\tif (savedEnvId) {\n\t\t\tsetEnvironmentId(savedEnvId);\n\t\t}\n\n\t\t// Load username from localStorage\n\t\tconst savedUsername = localStorage.getItem('mfa_unified_username');\n\t\tif (savedUsername) {\n\t\t\tsetUsername(savedUsername);\n\t\t}\n\t}, []);\n\n\t// Use MFA policies hook\n\tconst {\n\t\tpolicies,\n\t\tselectedPolicy,\n\t\tisLoading: isPoliciesLoading,\n\t\terror: policiesError,\n\t\tselectPolicy,\n\t\tdefaultPolicy,\n\t} = useMFAPolicies({\n\t\tenvironmentId,\n\t\ttokenIsValid: tokenStatus.isValid,\n\t\tautoLoad: true,\n\t\tautoSelectSingle: true,\n\t});\n\n\tconst selectedPolicyRef = useRef<DeviceAuthenticationPolicy | null>(null);\n\tuseEffect(() => {\n\t\tselectedPolicyRef.current = selectedPolicy ?? null;\n\t}, [selectedPolicy]);\n\n\tconst isPolicyDeviceEnabled = useCallback(\n\t\t(policy: DeviceAuthenticationPolicy | null, key: string) => {\n\t\t\tconst deviceConfig = policy?.[key] as { enabled?: boolean } | undefined;\n\t\t\treturn !!deviceConfig?.enabled;\n\t\t},\n\t\t[]\n\t);\n\n\tconst policyOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tpolicies.map((policy) => ({\n\t\t\t\tvalue: policy.id,\n\t\t\t\tlabel: policy.name,\n\t\t\t\t...(policy.default ? { secondaryLabel: '(Default)' } : {}),\n\t\t\t})),\n\t\t[policies]\n\t);\n\n\tconst userOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tArray.from(\n\t\t\t\tnew Map(\n\t\t\t\t\t(Array.isArray(users) ? users : []).map((user) => [\n\t\t\t\t\t\tuser.username,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvalue: user.username,\n\t\t\t\t\t\t\tlabel: user.username,\n\t\t\t\t\t\t\t...(user.email ? { secondaryLabel: user.email } : {}),\n\t\t\t\t\t\t} as SearchableDropdownOption,\n\t\t\t\t\t])\n\t\t\t\t).values()\n\t\t\t),\n\t\t[users]\n\t);\n\n\t// Auto-select default policy when policies load\n\tuseEffect(() => {\n\t\tif (defaultPolicy && !selectedPolicy) {\n\t\t\tselectPolicy(defaultPolicy.id);\n\t\t}\n\t}, [defaultPolicy, selectedPolicy, selectPolicy]);\n\n\t// Sync environment ID to global service and CredentialsServiceV8 when it changes\n\tuseEffect(() => {\n\t\tif (environmentId) {\n\t\t\tglobalEnvironmentService.setEnvironmentId(environmentId);\n\t\t\tlocalStorage.setItem('mfa_environmentId', environmentId);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tenvironmentId,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId, username: currentCreds.username }\n\t\t\t}));\n\t\t}\n\t}, [environmentId]);\n\n\t// Save username to localStorage and CredentialsServiceV8 when it changes\n\t// This ensures MFAFlowBase can read the username from its expected storage location\n\tuseEffect(() => {\n\t\tif (username) {\n\t\t\tlocalStorage.setItem('mfa_unified_username', username);\n\t\t\tlocalStorage.setItem('mfa_username', username);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tusername,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId: currentCreds.environmentId, username }\n\t\t\t}));\n\t\t}\n\t}, [username]);\n\n\t// Handle device selection for authentication\n\tconst handleDeviceSelectForAuthentication = async (device: {\n\t\tid: string;\n\t\ttype: string;\n\t\tdeviceName?: string;\n\t\tnickname?: string;\n\t}) => {\n\t\tconsole.log(`${MODULE_TAG} Selected device for authentication:`, device);\n\t\tsetShowDeviceSelectionModal(false);\n\t\tsetSelectedAuthDevice(device);\n\n\t\tconst policyId = selectedPolicy?.id;\n\t\tif (!policyId) {\n\t\t\ttoastV8.error('Please select an MFA Policy first');\n\t\t\treturn;\n\t\t}\n\n\t\t// Determine flow type and token\n\t\t// Admin flows should use worker tokens, not require user tokens\n\t\tconst flowType = userToken ? 'user' : 'admin';\n\t\tconst effectiveUserToken = flowType === 'user' ? userToken : undefined;\n\n\t\t// For admin flow, check if we have a valid worker token before proceeding\n\t\tif (flowType === 'admin' && !hasWorkerToken) {\n\t\t\ttoastV8.error('Admin flow requires a valid worker token. Please generate a worker token first.');\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\t// Initialize authentication with appropriate token\n\t\t\tconst response = await MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\tenvironmentId,\n\t\t\t\tusername: username.trim(),\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t\tdeviceId: device.id,\n\t\t\t\tregion: 'na',\n\t\t\t\ttokenType: flowType,\n\t\t\t\t...(effectiveUserToken && { userToken: effectiveUserToken }),\n\t\t\t});\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth initialized - full response:`, response);\n\t\t\tsetAuthenticationId(response.id);\n\n\t\t\tconst status = (response.status || '').toUpperCase();\n\t\t\tconst nextStep = (response.nextStep || '').toUpperCase();\n\t\t\tconst links = response._links as Record<string, { href?: string }> | undefined;\n\t\t\tconst hasOtpLink = !!(\n\t\t\t\tlinks &&\n\t\t\t\t(links.otp || links['otp.check'] || (links as Record<string, unknown>)['checkOtp'])\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth status:`, {\n\t\t\t\tstatus,\n\t\t\t\tnextStep,\n\t\t\t\thasOtpLink,\n\t\t\t\tdeviceType: device.type,\n\t\t\t});\n\n\t\t\t// Show appropriate UI based on response (normalize status/nextStep for PingOne variants)\n\t\t\tif (status === 'OTP_REQUIRED' || nextStep === 'OTP_REQUIRED' || hasOtpLink) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Opening OTP modal for device:`, device.type);\n\t\t\t\tsetShowOTPModal(true);\n\t\t\t\ttoastV8.success(`Verification code sent to your ${device.type} device`);\n\t\t\t} else if (status === 'ASSERTION_REQUIRED' || nextStep === 'ASSERTION_REQUIRED') {\n\t\t\t\tconsole.log(`${MODULE_TAG} FIDO2 assertion required`);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'FIDO2 authentication required. Please use /v8/mfa-config for FIDO2 authentication.'\n\t\t\t\t);\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'PUSH_CONFIRMATION_REQUIRED' ||\n\t\t\t\tnextStep === 'PUSH_CONFIRMATION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Push confirmation required`);\n\t\t\t\ttoastV8.success('Push notification sent! Please approve on your mobile device.');\n\t\t\t\ttoastV8.info('Complete authentication at /v8/mfa-config for push polling.');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (status === 'COMPLETED') {\n\t\t\t\ttoastV8.success('Authentication completed successfully!');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'DEVICE_SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'DEVICE_SELECTION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Device selection required - showing modal again`);\n\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t} else {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Unexpected authentication status:`, {\n\t\t\t\t\tstatus,\n\t\t\t\t\tnextStep,\n\t\t\t\t\tresponse,\n\t\t\t\t});\n\t\t\t\ttoastV8.info(`Authentication status: ${status || nextStep || 'UNKNOWN'}`);\n\t\t\t\t// Stay in authentication flow so user can try another device\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to initialize authentication:`, error);\n\n\t\t\t// Enhanced error handling for NO_USABLE_DEVICES\n\t\t\tlet errorMessage = 'Authentication failed: ';\n\t\t\tif (error instanceof Error) {\n\t\t\t\tconst errorStr = error.message.toLowerCase();\n\n\t\t\t\t// Check for NO_USABLE_DEVICES or device availability errors\n\t\t\t\tif (\n\t\t\t\t\terrorStr.includes('no usable devices') ||\n\t\t\t\t\terrorStr.includes('too many') ||\n\t\t\t\t\terrorStr.includes('cooldown') ||\n\t\t\t\t\terrorStr.includes('blocked')\n\t\t\t\t) {\n\t\t\t\t\terrorMessage = '‚ö†Ô∏è Device Temporarily Unavailable\\n\\n';\n\n\t\t\t\t\tif (errorStr.includes('cooldown') || errorStr.includes('too many')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Too many notifications have been sent to this device. It is temporarily in cooldown. ';\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Please wait a few minutes and try again, or select a different device.';\n\t\t\t\t\t} else if (errorStr.includes('blocked')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'This device has been blocked. Please contact your administrator or use a different device.';\n\t\t\t\t\t} else {\n\t\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terrorMessage += 'Unknown error';\n\t\t\t}\n\n\t\t\ttoastV8.error(errorMessage, { duration: 8000 });\n\t\t\t// Do NOT set flowMode(null) - keep user in authentication flow so they can retry or select another device\n\t\t}\n\t};\n\n\t// Handle OTP verification\n\tconst handleVerifyOTP = async () => {\n\t\tif (!authenticationId || !selectedAuthDevice) {\n\t\t\ttoastV8.error('Authentication session not found');\n\t\t\treturn;\n\t\t}\n\n\t\tif (otpCode.length !== 6) {\n\t\t\ttoastV8.error('Please enter a 6-digit code');\n\t\t\treturn;\n\t\t}\n\n\t\t// Get worker token for API call\n\t\tconst workerTokenForOTP = await workerTokenServiceV8.getToken();\n\n\t\tconsole.log(`${MODULE_TAG} OTP verification debug:`, {\n\t\t\tenvironmentId,\n\t\t\tusername: username.trim(),\n\t\t\tauthenticationId,\n\t\t\totpCode,\n\t\t\thasEnvironmentId: !!environmentId,\n\t\t\tenvIdLength: environmentId?.length,\n\t\t\thasWorkerToken: !!workerTokenForOTP,\n\t\t\tworkerTokenLength: workerTokenForOTP?.length,\n\t\t});\n\n\t\ttry {\n\t\t\t// Use backend proxy to avoid CORS issues\n\t\t\tconst response = await fetch('/api/pingone/mfa/validate-otp-for-device', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tenvironmentId,\n\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\tdeviceAuthId: authenticationId,\n\t\t\t\t\totp: otpCode,\n\t\t\t\t\tregion: 'na',\n\t\t\t\t\tworkerToken: workerTokenForOTP,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\n\t\t\t\tthrow new Error(errorData.error || errorData.message || `HTTP ${response.status}`);\n\t\t\t}\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.status === 'COMPLETED' || result.status === 'completed') {\n\t\t\t\ttoastV8.success('‚úÖ Authentication completed successfully!');\n\t\t\t\tsetShowOTPModal(false);\n\t\t\t\tsetFlowMode(null);\n\t\t\t\tsetOtpCode('');\n\t\t\t} else {\n\t\t\t\ttoastV8.error('Invalid code. Please try again.');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} OTP verification failed:`, error);\n\t\t\ttoastV8.error(\n\t\t\t\t`Verification failed: ${error instanceof Error ? error.message : 'Unknown error'}`\n\t\t\t);\n\t\t}\n\t};\n\n\t// Step 1: Choose Registration or Authentication\n\tif (!flowMode) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '12px' }}>\n\t\t\t\t\t{/* Header */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tboxShadow: '0 4px 12px rgba(239, 68, 68, 0.2)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h1\n\t\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîê MFA Unified Flow\n\t\t\t\t\t\t</h1>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tChoose what you want to do with MFA devices.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Configuration Section */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 12px 0',\n\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfiguration\n\t\t\t\t\t\t</h2>\n\n\t\t\t\t\t\t{/* Custom Logo URL */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-url\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[800],\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüé® Custom Logo URL (Optional)\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tDisplay a custom logo in the OTP verification modal\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t{/* URL Input */}\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tid=\"custom-logo-url\"\n\t\t\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\t\t\tvalue={customLogoUrl}\n\t\t\t\t\t\t\t\tonChange={(e) => setCustomLogoUrl(e.target.value)}\n\t\t\t\t\t\t\t\tplaceholder=\"https://example.com/logo.png\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\tpadding: '10px 14px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[900],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = `0 0 0 3px ${PING_IDENTITY_COLORS.primary[200]}`;\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.neutral[300];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* File Upload Section */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '13px', color: PING_IDENTITY_COLORS.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\tOR\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"file\"\n\t\t\t\t\t\t\t\t\tid=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\taccept=\"image/*\"\n\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\tconst file = e.target.files?.[0];\n\t\t\t\t\t\t\t\t\t\tif (!file) return;\n\n\t\t\t\t\t\t\t\t\t\t// Validate file type (images only)\n\t\t\t\t\t\t\t\t\t\tif (!file.type.startsWith('image/')) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Please select a logo file (JPG, PNG, etc.)');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Validate file size (max 5MB)\n\t\t\t\t\t\t\t\t\t\tif (file.size > 5 * 1024 * 1024) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('File size must be less than 5MB');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Convert file to base64 for persistence\n\t\t\t\t\t\t\t\t\t\tconst reader = new FileReader();\n\t\t\t\t\t\t\t\t\t\treader.onload = (event) => {\n\t\t\t\t\t\t\t\t\t\t\tconst base64Url = event.target?.result as string;\n\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl(base64Url);\n\n\t\t\t\t\t\t\t\t\t\t\t// Store base64 data for persistence\n\t\t\t\t\t\t\t\t\t\t\tconst uploadData = {\n\t\t\t\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\t\t\t\tbase64Url: base64Url,\n\t\t\t\t\t\t\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\t\t\t// Save to localStorage for persistence\n\t\t\t\t\t\t\t\t\t\t\tlocalStorage.setItem('custom-logo-upload', JSON.stringify(uploadData));\n\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.success(`Logo uploaded: ${file.name}`);\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.onerror = () => {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to read uploaded file');\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.readAsDataURL(file);\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'none' }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.primary[500],\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.primary[600]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '500',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[700];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìÅ Upload Logo File\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[500],\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tJPG, PNG, GIF (max 5MB)\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{customLogoUrl && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.neutral[50],\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tLogo Preview:\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\talt=\"Custom logo\"\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonError={() => {\n\t\t\t\t\t\t\t\t\t\t\t// Handle broken image URLs\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Failed to load custom logo URL');\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl('');\n\t\t\t\t\t\t\t\t\t\t\t\t// Clear uploaded file from localStorage\n\t\t\t\t\t\t\t\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.accent.pingRed[500],\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.accent.pingRed[600]}`,\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[600];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[500];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRemove Logo\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Environment ID - Hide when worker token is available */}\n\t\t\t\t\t\t{!hasWorkerToken && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"env-id\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tEnvironment ID\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"env-id\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setEnvironmentId(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* SQLite Database Stats */}\n\t\t\t\t\t\t{environmentId && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<SQLiteStatsDisplayV8\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tcompact={false}\n\t\t\t\t\t\t\t\t\trefreshInterval={30}\n\t\t\t\t\t\t\t\t\tshowRefreshButton={true}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Username */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUsername\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{environmentId && tokenStatus.isValid ? (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\toptions={userOptions}\n\t\t\t\t\t\t\t\t\tonChange={setUsername}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Type to search across 16,000+ users...\"\n\t\t\t\t\t\t\t\t\tisLoading={isLoadingUsers}\n\t\t\t\t\t\t\t\t\tonSearchChange={setSearchQuery}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setUsername(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* MFA Policy Dropdown */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"mfa-policy\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tMFA Policy\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{isPoliciesLoading ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tLoading policies...\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policiesError ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#ef4444', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tError loading policies: {policiesError}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policies.length === 0 ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tNo MFA policies found. Please check your environment ID and worker token.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"mfa-policy\"\n\t\t\t\t\t\t\t\t\tvalue={selectedPolicy?.id || ''}\n\t\t\t\t\t\t\t\t\toptions={policyOptions}\n\t\t\t\t\t\t\t\t\tonChange={selectPolicy}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Select an MFA policy...\"\n\t\t\t\t\t\t\t\t\tisLoading={isPoliciesLoading}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tSelect the MFA policy to use for device registration\n\t\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t\t{/* Policy Summary - Collapsible */}\n\t\t\t\t\t\t\t{selectedPolicy && (\n\t\t\t\t\t\t\t\t<details\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<summary\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\tuserSelect: 'none',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüìã Policy Details\n\t\t\t\t\t\t\t\t\t</summary>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '12px', fontSize: '13px', color: '#4b5563' }}>\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Policy Name:</strong> {String(selectedPolicy.name)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedPolicy.default && (\n\t\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px', color: '#059669' }}>\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>‚úì Default Policy</strong>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Enabled Devices:</strong>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '6px' }}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'sms') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì± SMS\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'email') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t‚úâÔ∏è Email\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'totp') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîê TOTP\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'fido2') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîë FIDO2\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'mobile') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì≤ Mobile\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'voice') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüìû Voice\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</details>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Worker Token Status */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t\tpaddingRight: '16px',\n\t\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={setEnvironmentId}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* User Token Status */}\n\t\t\t\t\t\t\t{userToken && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\t'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05))',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #10b981',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '20px' }}>üë§</span>\n\t\t\t\t\t\t\t\t\t\t<strong style={{ color: '#047857', fontSize: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t\tUser Token Active\n\t\t\t\t\t\t\t\t\t\t</strong>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: '14px', color: '#059669', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t\t‚úì User authentication token available\n\t\t\t\t\t\t\t\t\t\t<br />‚úì Ready for User Flow device registration\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Flow Mode Selection */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',\n\t\t\t\t\t\t\tgap: '16px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Registration Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => setFlowMode('registration')}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>‚ûï</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#047857',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Registration\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tRegister a new MFA device for a user. Create SMS, Email, TOTP, Mobile Push,\n\t\t\t\t\t\t\t\t\t\tWhatsApp, or FIDO2 devices.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t{/* Authentication Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tif (!userToken) {\n\t\t\t\t\t\t\t\t\tsetShowAuthLoginModal(true);\n\t\t\t\t\t\t\t\t\ttoastV8.info('üîê Please complete user login before device authentication.', {\n\t\t\t\t\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-4px)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 8px 24px rgba(59, 130, 246, 0.2)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>üîì</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#1d4ed8',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Authentication\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tAuthenticate using an existing MFA device. Verify user identity with OTP, push\n\t\t\t\t\t\t\t\t\t\tnotification, or security key.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{showAuthLoginModal && (\n\t\t\t\t\t<UserLoginModalV8\n\t\t\t\t\t\tisOpen={showAuthLoginModal}\n\t\t\t\t\t\tonClose={() => setShowAuthLoginModal(false)}\n\t\t\t\t\t\tonTokenReceived={(token) => {\n\t\t\t\t\t\t\tsetUserToken(token);\n\t\t\t\t\t\t\tsetShowAuthLoginModal(false);\n\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tenvironmentId={authEnvIdForModal}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</>\n\t\t);\n\t}\n\n\t// Authentication flow - dedicated view (device selection + OTP modals only; no registration grid)\n\tif (flowMode === 'authentication') {\n\t\treturn (\n\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\tsetSelectedAuthDevice(null);\n\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t‚Üê Back\n\t\t\t\t\t</button>\n\t\t\t\t\t<h1\n\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t>\n\t\t\t\t\t\tüîì Device Authentication\n\t\t\t\t\t</h1>\n\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\t{selectedAuthDevice && !showOTPModal\n\t\t\t\t\t\t\t? `Authenticating with ${selectedAuthDevice.type} ‚Äî enter the code when prompted.`\n\t\t\t\t\t\t\t: `Select an MFA device to authenticate for ${username || 'the user'}`}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t\t{!showDeviceSelectionModal && !showOTPModal && (\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowDeviceSelectionModal(true)}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tSelect MFA device\n\t\t\t\t\t</button>\n\t\t\t\t)}\n\t\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\t\tonClose={() => {\n\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t// Keep flowMode so user stays in auth flow; only clear if they click Back\n\t\t\t\t\t}}\n\t\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\t\tusername={username}\n\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t/>\n\t\t\t\t{showOTPModal && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.6)',\n\t\t\t\t\t\t\tbackdropFilter: 'blur(4px)',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t\t\tanimation: 'fadeIn 0.2s ease-out',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t{`\n\t\t\t\t\t\t\t@keyframes fadeIn {\n\t\t\t\t\t\t\t\tfrom { opacity: 0; }\n\t\t\t\t\t\t\t\tto { opacity: 1; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes slideUp {\n\t\t\t\t\t\t\t\tfrom { \n\t\t\t\t\t\t\t\t\topacity: 0;\n\t\t\t\t\t\t\t\t\ttransform: translateY(20px); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tto { \n\t\t\t\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t\t\t\t\ttransform: translateY(0); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes pulse {\n\t\t\t\t\t\t\t\t0%, 100% { opacity: 1; }\n\t\t\t\t\t\t\t\t50% { opacity: 0.5; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`}\n\t\t\t\t\t\t</style>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\tborderRadius: '24px',\n\t\t\t\t\t\t\t\tpadding: '48px 40px',\n\t\t\t\t\t\t\t\tmaxWidth: '480px',\n\t\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\t\tboxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',\n\t\t\t\t\t\t\t\tanimation: 'slideUp 0.3s ease-out',\n\t\t\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Logo Area */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '32px' }}>\n\t\t\t\t\t\t\t\t{customLogoUrl ? (\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\t\talt=\"Organization logo\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '120px',\n\t\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonError={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\t// Fallback to default icon if image fails to load\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.display = 'none';\n\t\t\t\t\t\t\t\t\t\t\t\tconst fallback = document.createElement('div');\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.style.cssText = `\n\t\t\t\t\t\t\t\t\t\t\t\twidth: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\theight: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: 0 auto 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: center;\n\t\t\t\t\t\t\t\t\t\t\t\tjustifyContent: center;\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: 36px;\n\t\t\t\t\t\t\t\t\t\t\t\tboxShadow: 0 10px 25px rgba(102, 126, 234, 0.3);\n\t\t\t\t\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.textContent = 'üîê';\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.parentElement!.appendChild(fallback);\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\theight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto 20px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '20px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '36px',\n\t\t\t\t\t\t\t\t\t\t\tboxShadow: '0 10px 25px rgba(102, 126, 234, 0.3)',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüîê\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tVerification Code\n\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\tEnter the 6-digit code sent to your <strong>{selectedAuthDevice?.type}</strong>{' '}\n\t\t\t\t\t\t\t\t\tdevice\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* OTP Input */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\t\t\tplaceholder=\"‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢\"\n\t\t\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tletterSpacing: '12px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow: otpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{otpCode.length > 0 && otpCode.length < 6 && (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\t\tanimation: 'pulse 2s ease-in-out infinite',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{6 - otpCode.length} more digit{6 - otpCode.length !== 1 ? 's' : ''} needed\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Resend Code Button */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={async () => {\n\t\t\t\t\t\t\t\t\t\tif (!selectedAuthDevice || !authenticationId) return;\n\t\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.info('Resending verification code...');\n\t\t\t\t\t\t\t\t\t\t\t// Re-initialize authentication to resend code\n\t\t\t\t\t\t\t\t\t\t\tconst response =\n\t\t\t\t\t\t\t\t\t\t\t\tawait MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\t\t\t\t\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\t\t\t\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicy?.id || '',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceId: selectedAuthDevice.id,\n\t\t\t\t\t\t\t\t\t\t\t\t\tregion: 'na',\n\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tif (response.status?.toUpperCase() === 'OTP_REQUIRED') {\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('New code sent to your device!');\n\t\t\t\t\t\t\t\t\t\t\t\tsetAuthenticationId(response.id);\n\t\t\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to resend code');\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Resend error:', error);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tcolor: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'transparent';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚Üª Resend Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Action Buttons */}\n\t\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#d1d5db';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f9fafb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'white';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6\n\t\t\t\t\t\t\t\t\t\t\t\t? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '#d1d5db',\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (otpCode.length === 6) {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚úì Verify Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Help Text */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<strong style={{ color: '#111827' }}>Didn't receive the code?</strong>\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\tCheck your spam folder or click \"Resend Code\" above\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t);\n\t}\n\n\t// Registration flow - show device type selection cards\n\treturn (\n\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t{/* Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #10b981 0%, #047857 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => setFlowMode(null)}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t‚Üê Back\n\t\t\t\t</button>\n\t\t\t\t<h1 style={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}>\n\t\t\t\t\t‚ûï Register MFA Device\n\t\t\t\t</h1>\n\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\tSelect a device type to register for {username || 'the user'}\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Device Type Cards */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',\n\t\t\t\t\tgap: '16px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t{DEVICE_TYPES.map((device) => {\n\t\t\t\t\tconst enabled = isDeviceEnabled(device.key);\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tkey={device.key}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => enabled && onSelectDeviceType(device.key)}\n\t\t\t\t\t\t\tdisabled={!enabled}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tbackground: enabled ? '#ffffff' : '#f9fafb',\n\t\t\t\t\t\t\t\tborder: `2px solid ${enabled ? '#e5e7eb' : '#f3f4f6'}`,\n\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\tcursor: enabled ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\topacity: enabled ? 1 : 0.5,\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#10b981';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ecfdf5';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>{device.icon}</span>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{device.name}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280' }}>{device.description}</p>\n\t\t\t\t\t\t\t{!enabled && (\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '12px', color: '#9ca3af' }}>\n\t\t\t\t\t\t\t\t\t(Not enabled)\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</div>\n\n\t\t\t{/* Device Selection Modal for Authentication */}\n\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t}}\n\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\tusername={username}\n\t\t\t\tenvironmentId={environmentId}\n\t\t\t/>\n\n\t\t\t{/* OTP Modal for Authentication */}\n\t\t\t{showOTPModal && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '400px',\n\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\tboxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '600' }}>\n\t\t\t\t\t\t\tEnter Verification Code\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '0 0 20px 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tCheck your {selectedAuthDevice?.type} device for the code\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\tplaceholder=\"000000\"\n\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 16px',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\tletterSpacing: '8px',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tmarginBottom: '20px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: otpCode.length === 6 ? '#3b82f6' : '#9ca3af',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tVerify\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Wrapper Component\n *\n * Wraps the content with MFACredentialProvider to provide global credential state\n */\nexport const UnifiedMFARegistrationFlowV8: React.FC<UnifiedMFARegistrationFlowV8Props> = (\n\tprops\n) => {\n\tconst location = useLocation();\n\n\t// Get device type from props or location state (can be undefined)\n\tconst initialDeviceType =\n\t\tprops.deviceType || (location.state as { deviceType?: DeviceConfigKey })?.deviceType;\n\n\t// State for selected device type (allows user to select if not provided)\n\tconst [selectedDeviceType, setSelectedDeviceType] = useState<DeviceConfigKey | undefined>(\n\t\tinitialDeviceType\n\t);\n\n\t// User token state for OAuth authentication (User Flow)\n\tconst [userToken, setUserToken] = useState<string | null>(() => {\n\t\t// Check if we already have a user token from previous OAuth flow\n\t\tconst savedCreds = CredentialsServiceV8.loadCredentials('user-login-v8', {\n\t\t\tflowKey: 'user-login-v8',\n\t\t\tflowType: 'oauth',\n\t\t\tincludeClientSecret: false,\n\t\t\tincludeRedirectUri: false,\n\t\t\tincludeLogoutUri: false,\n\t\t\tincludeScopes: false,\n\t\t});\n\t\treturn savedCreds?.accessToken || null;\n\t});\n\n\t// If no device type selected, show device type selection screen\n\tif (!selectedDeviceType) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<MFAHeaderV8\n\t\t\t\t\ttitle=\"MFA Unified Flow\"\n\t\t\t\t\tdescription=\"Register or authenticate MFA devices\"\n\t\t\t\t\tversionTag=\"V8\"\n\t\t\t\t\tcurrentPage=\"registration\"\n\t\t\t\t\tshowBackToMain={true}\n\t\t\t\t\theaderColor=\"pingRed\"\n\t\t\t\t/>\n\t\t\t\t<GlobalMFAProvider>\n\t\t\t\t\t<MFACredentialProvider>\n\t\t\t\t\t\t<DeviceTypeSelectionScreen\n\t\t\t\t\t\t\tonSelectDeviceType={setSelectedDeviceType}\n\t\t\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</MFACredentialProvider>\n\t\t\t\t</GlobalMFAProvider>\n\t\t\t\t{/* API display (bottom of page) */}\n\t\t\t\t<div style={{ marginTop: '24px' }}>\n\t\t\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\t\t\t\t</div>\n\t\t\t</>\n\t\t);\n\t}\n\n\treturn (\n\t\t<GlobalMFAProvider>\n\t\t\t<MFACredentialProvider>\n\t\t\t\t<UnifiedMFARegistrationFlowContent\n\t\t\t\t\t{...props}\n\t\t\t\t\tdeviceType={selectedDeviceType}\n\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t/>\n\t\t\t</MFACredentialProvider>\n\t\t</GlobalMFAProvider>\n\t);\n};\n\n// ============================================================================\n// CONTENT COMPONENT (MAIN LOGIC)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Content Component\n *\n * Contains the actual flow logic and integrates with:\n * - MFACredentialContext (global credential state)\n * - useWorkerToken hook (token status and auto-refresh)\n * - deviceFlowConfigs (device-specific configuration)\n * - MFAFlowBaseV8 (5-step framework)\n */\nconst UnifiedMFARegistrationFlowContent: React.FC<\n\tRequired<Pick<UnifiedMFARegistrationFlowV8Props, 'deviceType'>> &\n\t\tOmit<UnifiedMFARegistrationFlowV8Props, 'deviceType'> & {\n\t\t\tuserToken: string | null;\n\t\t\tsetUserToken: (token: string | null) => void;\n\t\t}\n> = ({ deviceType, onCancel, userToken, setUserToken }) => {\n\t// ========================================================================\n\t// CONFIGURATION\n\t// ========================================================================\n\n\t// React Router navigation\n\tconst navigate = useNavigate();\n\n\t// Load device-specific configuration\n\tconst config = useMemo(() => {\n\t\treturn getDeviceConfig(deviceType);\n\t}, [deviceType]);\n\n\t// ========================================================================\n\t// USER FLOW OAUTH STATE\n\t// ========================================================================\n\n\t// State for User Login Modal (OAuth authentication for User Flow)\n\tconst [showUserLoginModal, setShowUserLoginModal] = useState(false);\n\tconst [showUserTokenSuccess, setShowUserTokenSuccess] = useState(false);\n\tconst [userTokenForDisplay, setUserTokenForDisplay] = useState<string>('');\n\tconst [usernameFromToken, setUsernameFromToken] = useState<string>('');\n\tconst [showUsernameDropdown, setShowUsernameDropdown] = useState(false);\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\tconst envIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Pending registration data while waiting for OAuth (use ref to avoid stale closure)\n\tconst pendingRegistrationRef = useRef<{\n\t\tdeviceType: DeviceConfigKey;\n\t\tfields: Record<string, string>;\n\t\tflowType: string;\n\t\tprops: MFAFlowBaseRenderProps;\n\t} | null>(null);\n\n\t// Worker token state for validation in registration flow\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Detect OAuth callback and re-open modal if needed\n\tuseEffect(() => {\n\t\tconst urlParams = new URLSearchParams(window.location.search);\n\t\tconst code = urlParams.get('code');\n\t\tconst hasStoredState = sessionStorage.getItem('user_login_state_v8');\n\n\t\t// If we have OAuth callback params and stored state, re-open the modal to process callback\n\t\t// But only if we don't already have a user token (to prevent reopening after silent auth)\n\t\tif (code && hasStoredState && !showUserLoginModal && !userToken) {\n\t\t\tconsole.log('[UNIFIED-FLOW] OAuth callback detected - re-opening modal to process');\n\t\t\tsetShowUserLoginModal(true);\n\t\t}\n\t}, [showUserLoginModal, userToken]);\n\n\t// ========================================================================\n\t// STEP VALIDATION\n\t// ========================================================================\n\n\t/**\n\t * Validate Step 0 (Configuration)\n\t */\n\tconst validateStep0 = useCallback(\n\t\t(\n\t\t\tcredentials: MFACredentials,\n\t\t\ttoken: TokenStatusInfo,\n\t\t\tnavigation: ReturnType<typeof useStepNavigationV8>\n\t\t) => {\n\t\t\t// Always check for valid worker token (required for MFA device operations)\n\t\t\tif (!token.isValid) {\n\t\t\t\tnavigation.setValidationErrors(['Invalid or expired worker token']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Check required configuration\n\t\t\tif (!credentials.environmentId || !credentials.username) {\n\t\t\t\tnavigation.setValidationErrors(['Environment ID and Username are required']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\t\t[]\n\t);\n\n\t// ========================================================================\n\t// STEP RENDERERS\n\t// ========================================================================\n\n\t/**\n\t * Perform device registration API call (with token already available)\n\t */\n\tconst performRegistrationWithToken = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string,\n\t\t\ttoken?: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== PERFORM REGISTRATION WITH TOKEN =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Token:', token ? `Present (${token.length} chars)` : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setIsLoading available:', typeof props.setIsLoading);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setCredentials available:', typeof props.setCredentials);\n\n\t\t\ttry {\n\t\t\t\tprops.setIsLoading(true);\n\n\t\t\t\t// Update credentials with device fields and user token if provided\n\t\t\t\tprops.setCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tflowType, // Store flowType so activation step knows if OTP is required\n\t\t\t\t\t...fields,\n\t\t\t\t\t...(flowType === 'user' && token\n\t\t\t\t\t\t? { userToken: token, tokenType: 'user' }\n\t\t\t\t\t\t: flowType !== 'user'\n\t\t\t\t\t\t\t? { tokenType: 'worker' }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t}));\n\n\t\t\t\t// Register the device using proper API call\n\t\t\t\t// CRITICAL: Flow-specific device status\n\t\t\t\t// - Admin flow: ACTIVE (no OTP sent, device ready immediately)\n\t\t\t\t// - Admin ACTIVATION_REQUIRED: ACTIVATION_REQUIRED (sends OTP for admin to activate)\n\t\t\t\t// - User flow: ACTIVATION_REQUIRED (sends OTP for user to activate)\n\t\t\t\t// - FIDO2: ACTIVE (WebAuthn verification happens during registration)\n\t\t\t\tlet deviceStatus: 'ACTIVE' | 'ACTIVATION_REQUIRED' | undefined;\n\n\t\t\t\t// Determine device status based on flow type (applies to all device types including FIDO2)\n\t\t\t\tif (flowType === 'admin-active') {\n\t\t\t\t\tdeviceStatus = 'ACTIVE';\n\t\t\t\t} else if (flowType === 'admin-activation') {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED';\n\t\t\t\t} else {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED'; // user flow\n\t\t\t\t}\n\n\t\t\t\t// Special note for FIDO2: WebAuthn verification proves device works,\n\t\t\t\t// but we still respect the flow type for status determination\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t'[UNIFIED-FLOW] FIDO2 device - status determined by flow type:',\n\t\t\t\t\t\tdeviceStatus\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device status determined:', {\n\t\t\t\t\tflowType,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tdeviceStatus,\n\t\t\t\t\totpWillBeSent: deviceStatus === 'ACTIVATION_REQUIRED',\n\t\t\t\t\treason:\n\t\t\t\t\t\tselectedDeviceType === 'FIDO2'\n\t\t\t\t\t\t\t? 'FIDO2 - ACTIVE after WebAuthn verification'\n\t\t\t\t\t\t\t: 'User flow - OTP required for activation',\n\t\t\t\t});\n\n\t\t\t\t// Use same parameter construction as working MFA flows\n\t\t\t\ttype RegisterDeviceParamsWithToken = RegisterDeviceParams & {\n\t\t\t\t\ttokenType?: 'worker' | 'user';\n\t\t\t\t\tuserToken?: string | undefined;\n\t\t\t\t};\n\t\t\t\tlet baseParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\tenvironmentId: props.credentials.environmentId,\n\t\t\t\t\tusername: props.credentials.username,\n\t\t\t\t\ttype: selectedDeviceType,\n\t\t\t\t};\n\t\t\t\t// Per rightTOTP.md: Pass token type and user token if available\n\t\t\t\tif (flowType === 'user' && token) {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'user',\n\t\t\t\t\t\tuserToken: token,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'worker',\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Always include status for all device types\n\t\t\t\t// FIDO2: Set to ACTIVE since WebAuthn verification proves device works\n\t\t\t\t// Other devices: Set based on flow type (admin-active = ACTIVE, others = ACTIVATION_REQUIRED)\n\t\t\t\tif (deviceStatus !== undefined) {\n\t\t\t\t\tbaseParams.status = deviceStatus;\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registration base params:', {\n\t\t\t\t\tenvironmentId: baseParams.environmentId,\n\t\t\t\t\tusername: baseParams.username,\n\t\t\t\t\ttype: baseParams.type,\n\t\t\t\t\ttokenType: baseParams.tokenType,\n\t\t\t\t\tstatus: baseParams.status,\n\t\t\t\t\tflowType,\n\t\t\t\t});\n\n\t\t\t\t// Map form field names to API field names\n\t\t\t\t// Form uses 'deviceName' but API expects 'nickname' or 'name'\n\t\t\t\tconst mappedFields: Record<string, string> = { ...fields };\n\t\t\t\tif (mappedFields.deviceName) {\n\t\t\t\t\tmappedFields.nickname = mappedFields.deviceName;\n\t\t\t\t\tmappedFields.name = mappedFields.deviceName;\n\t\t\t\t\tdelete mappedFields.deviceName;\n\t\t\t\t}\n\n\t\t\t\t// Format phone number for SMS/WhatsApp devices\n\t\t\t\t// Form sends: { phoneNumber: '9725231586', countryCode: '+1' }\n\t\t\t\t// API expects: { phone: '+1.9725231586' }\n\t\t\t\tif (mappedFields.phoneNumber && mappedFields.countryCode) {\n\t\t\t\t\tconst countryCode = mappedFields.countryCode.replace('+', ''); // Remove + for formatting\n\t\t\t\t\tconst phoneNumber = mappedFields.phoneNumber.replace(/\\D/g, ''); // Remove non-digits\n\t\t\t\t\tmappedFields.phone = `+${countryCode}.${phoneNumber}`;\n\t\t\t\t\tconsole.log('[UNIFIED-FLOW] Formatted phone:', mappedFields.phone);\n\t\t\t\t\tdelete mappedFields.phoneNumber;\n\t\t\t\t\tdelete mappedFields.countryCode;\n\t\t\t\t}\n\n\t\t\t\t// Include device-specific fields (phone, email, etc.)\n\t\t\t\tconst deviceParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\t...baseParams,\n\t\t\t\t\t...mappedFields,\n\t\t\t\t\t// Include policy for TOTP devices (required for secret and keyUri to be returned)\n\t\t\t\t\t...(selectedDeviceType === 'TOTP' && selectedPolicyRef.current\n\t\t\t\t\t\t? { policy: selectedPolicyRef.current.id }\n\t\t\t\t\t\t: {}),\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registering device with params:', deviceParams);\n\n\t\t\t\tconst result = await MFAServiceV8_Legacy.registerDevice(deviceParams);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device registered:', result);\n\n\t\t\t\t// Update MFA state with device info\n\t\t\t\tconst registrationResult = result as unknown as Record<string, unknown>;\n\n\t\t\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result for TOTP:', {\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\tqrCode: registrationResult.qrCode,\n\t\t\t\t\t\tqrCodeUrl: registrationResult.qrCodeUrl,\n\t\t\t\t\t\tsecret: registrationResult.secret,\n\t\t\t\t\t\ttotpSecret: registrationResult.totpSecret,\n\t\t\t\t\t\tfullResult: result,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// ===============================================\n\n\t\t\t\t// Clear stored registration data after successful use\n\t\t\t\tlocalStorage.removeItem('mfa_registration_flow_type');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_fields');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_device_type');\n\n\t\t\t\tprops.setMfaState((prev) => {\n\t\t\t\t\t// TOTP: QR code will be rendered by QRCodeSVG component in UnifiedActivationStep\n\t\t\t\t\t// No need to generate QR code data URL here - just pass the keyUri\n\t\t\t\t\tconst newState: MFAState = {\n\t\t\t\t\t\t...prev,\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tdeviceStatus: result.status,\n\t\t\t\t\t\t...(registrationResult.deviceActivateUri\n\t\t\t\t\t\t\t? { deviceActivateUri: String(registrationResult.deviceActivateUri) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'TOTP'\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\ttotpSecret: String(registrationResult.secret || ''),\n\t\t\t\t\t\t\t\t\tkeyUri: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tqrCodeUrl: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tshowQr: !!(registrationResult.secret || registrationResult.keyUri),\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'FIDO2' &&\n\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tpublicKeyCredentialCreationOptions:\n\t\t\t\t\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions,\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'MOBILE' && registrationResult.pairingKey\n\t\t\t\t\t\t\t? { pairingKey: String(registrationResult.pairingKey) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t};\n\n\t\t\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\t\t\tfullState: newState,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t// ================================================\n\n\t\t\t\t\treturn newState;\n\t\t\t\t});\n\n\t\t\t\t// FIDO2: Check if we already have credential data (from WebAuthn modal)\n\t\t\t\t// If credentialId and publicKey are present, registration is complete\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tif (fields.credentialId && fields.publicKey) {\n\t\t\t\t\t\t// WebAuthn already completed via modal - device fully registered\n\n\t\t\t\t\t\t// Admin Flow: Show QR but skip OTP validation - device ready immediately\n\t\t\t\t\t\t// Admin ACTIVATION_REQUIRED & User Flow: Show QR and require OTP validation\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tflowType === 'admin-active' ||\n\t\t\t\t\t\t\tflowType === 'admin-activation' ||\n\t\t\t\t\t\t\tresult.status === 'ACTIVE'\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t'[UNIFIED-FLOW] Admin flow or ACTIVE status - proceeding to show QR without OTP requirement'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered successfully!${flowType === 'admin-active' || flowType === 'admin-activation' ? ' Device is ready to use.' : ''}`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t// For Admin Flow, go to API docs page instead of OTP page\n\t\t\t\t\t\t\t// For User Flow, go to User Login step (Step 1)\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (result.status === 'ACTIVATION_REQUIRED') {\n\t\t\t\t\t\t\t// Device requires activation - PingOne automatically sends OTP\n\t\t\t\t\t\t\t// This applies to both admin_activation_required and user flow\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered! OTP has been sent automatically.`\n\t\t\t\t\t\t\t);\n  // DO NOT auto-advance for OTP-required devices\n\t\t\t\t\t\t\t// User should manually click Next after receiving OTP\n\t\t\t\t\t\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation - waiting for user to proceed manually`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Unknown status, proceed with flow-specific navigation\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} // End of FIDO2 section\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Registration failed:', error);\n\t\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Device registration failed';\n\n\t\t\t\t// Check if error is due to too many devices\n\t\t\t\tif (errorMessage.includes('Too many devices')) {\n\t\t\t\t\ttoastV8.error(\n\t\t\t\t\t\t`${errorMessage}\\n\\n‚ÑπÔ∏è You can manage your devices at:\\nhttps://localhost:3000/v8/delete-all-devices`,\n\t\t\t\t\t\t{ duration: 8000 }\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\ttoastV8.error(errorMessage);\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tprops.setIsLoading(false);\n\t\t\t}\n\t\t},\n\t\t[config.displayName, toastV8]\n\t);\n\n\t/**\n\t * Handle user token received from OAuth flow\n\t */\n\tconst handleUserTokenReceived = useCallback(\n\t\t(token: string) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== USER TOKEN RECEIVED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Token length:', token.length);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current pending registration:', pendingRegistrationRef.current);\n\n\t\t\tsetUserToken(token);\n\t\t\tsetUserTokenForDisplay(token);\n\n\t\t\t// Decode JWT to extract username\n\t\t\ttry {\n\t\t\t\tconst base64Url = token.split('.')[1];\n\t\t\t\tconst base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n\t\t\t\tconst jsonPayload = decodeURIComponent(\n\t\t\t\t\tatob(base64)\n\t\t\t\t\t\t.split('')\n\t\t\t\t\t\t.map((c) => `%${`00${c.charCodeAt(0).toString(16)}`.slice(-2)}`)\n\t\t\t\t\t\t.join('')\n\t\t\t\t);\n\t\t\t\tconst payload = JSON.parse(jsonPayload);\n\t\t\t\tconst username =\n\t\t\t\t\tpayload.username || payload.preferred_username || payload.sub || 'Unknown User';\n\t\t\t\tsetUsernameFromToken(username);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Extracted username:', username);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Failed to decode JWT:', error);\n\t\t\t\tsetUsernameFromToken('Unknown User');\n\t\t\t}\n\n\t\t\t// If we have pending registration, show success page first\n\t\t\tconst pending = pendingRegistrationRef.current;\n\t\t\tif (pending) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Found pending registration, showing success page first...');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending data:', {\n\t\t\t\t\tdeviceType: pending.deviceType,\n\t\t\t\t\tflowType: pending.flowType,\n\t\t\t\t\thasProps: !!pending.props,\n\t\t\t\t\thasFields: !!pending.fields,\n\t\t\t\t});\n\n\t\t\t\ttoastV8.success('‚úÖ Authentication successful! Your user token is ready.', {\n\t\t\t\t\tduration: 4000,\n\t\t\t\t});\n\n\t\t\t\t// Close login modal and show success page\n\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\tsetShowUserTokenSuccess(true);\n\t\t\t} else {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] WARNING: No pending registration found after OAuth!');\n\t\t\t}\n\t\t},\n\t\t[setUserToken]\n\t);\n\n\t/**\n\t * Handle continue from user token success page\n\t */\n\tconst handleContinueAfterUserLogin = useCallback(() => {\n\t\tconsole.log(\n\t\t\t'[UNIFIED-FLOW] User clicked continue after login, proceeding with registration...'\n\t\t);\n\n\t\tconst pending = pendingRegistrationRef.current;\n\t\tif (pending && userToken) {\n\t\t\tconst { deviceType: pendingDeviceType, fields, flowType, props } = pending;\n\t\t\tpendingRegistrationRef.current = null;\n\n\t\t\t// Hide success page\n\t\t\tsetShowUserTokenSuccess(false);\n\n\t\t\t// Continue with registration\n\t\t\tsetTimeout(() => {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Now executing performRegistrationWithToken...');\n\t\t\t\tperformRegistrationWithToken(props, pendingDeviceType, fields, flowType, userToken);\n\t\t\t}, 100);\n\t\t}\n\t}, [userToken, performRegistrationWithToken]);\n\n\t/**\n\t * Perform device registration API call\n\t * Checks if User Flow needs OAuth first, otherwise proceeds with registration\n\t */\n\tconst performRegistration = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== DEVICE REGISTRATION SUBMITTED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current userToken:', userToken ? 'Present' : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\n\t\t\t// CRITICAL: Validate worker token before allowing any registration\n\t\t\tif (!workerToken.tokenStatus.isValid) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Cannot proceed - no valid worker token');\n\t\t\t\ttoastV8.error(\n\t\t\t\t\t'‚ùå Worker token required for device registration. Please configure worker token credentials first.',\n\t\t\t\t\t{\n\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// For User Flow, check if we need OAuth authentication first\n\t\t\tif (flowType === 'user' && !userToken) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] User flow selected but no token - showing OAuth modal');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Storing pending registration...');\n\n\t\t\t\t// Store pending registration data\n\t\t\t\tpendingRegistrationRef.current = {\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tfields,\n\t\t\t\t\tflowType,\n\t\t\t\t\tprops,\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending registration stored:', pendingRegistrationRef.current);\n\n\t\t\t\t// Set return target for device registration flow\n\t\t\t\tReturnTargetServiceV8U.setReturnTarget(\n\t\t\t\t\t'mfa_device_registration',\n\t\t\t\t\t'/v8/unified-mfa',  // Return to unified MFA flow\n\t\t\t\t\t2  // Step 2: Device Selection\n\t\t\t\t);\n\n\t\t\t\t// Show the user login modal\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'üîê User Flow requires PingOne authentication. Please complete the login to continue with device registration.',\n\t\t\t\t\t{ duration: 6000 }\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t'[UNIFIED-FLOW] Proceeding directly with registration (token exists or admin flow)'\n\t\t\t);\n\t\t\t// Proceed with registration (using existing token for user flow)\n\t\t\tawait performRegistrationWithToken(\n\t\t\t\tprops,\n\t\t\t\tselectedDeviceType,\n\t\t\t\tfields,\n\t\t\t\tflowType,\n\t\t\t\tuserToken || undefined\n\t\t\t);\n\t\t},\n\t\t[workerToken.tokenStatus.isValid, userToken]\n\t);\n\n\t/**\n\t * Render Step 0: Configuration (environment, user, policy)\n\t */\n\tconst renderStep0 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn (\n\t\t\t\t<UnifiedDeviceRegistrationForm\n\t\t\t\t\tinitialDeviceType={deviceType}\n\t\t\t\t\tonSubmit={async (selectedDeviceType, fields, flowType) => {\n\t\t\t\t\t\tawait performRegistration(props, selectedDeviceType, fields, flowType);\n\t\t\t\t\t}}\n\t\t\t\t\tonCancel={() => {\n\t\t\t\t\t\tif (onCancel) onCancel();\n\t\t\t\t\t}}\n\t\t\t\t\ttokenStatus={props.tokenStatus}\n\t\t\t\t\tusername={props.credentials.username}\n\t\t\t\t/>\n\t\t\t);\n\t\t},\n\t\t[deviceType, onCancel, performRegistration]\n\t);\n\n\t/**\n\t * Render Step 1: User Login using Authorization Code Flow with PKCE\n\t */\n\tconst renderStep1 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <UserLoginStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 2: Device Selection (option to call registration if want new device, or have no devices)\n\t */\n\tconst renderStep2 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 3: Device-Specific Actions (OTP/QR Generation, FIDO, Mobile Push)\n\t */\n\tconst renderStep3 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific based on the device type\n\t\t\t// For now, return the activation step which handles device-specific logic\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 4: OTP Validation / Confirmation\n\t */\n\tconst renderStep4 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific validation\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 5: API Documentation\n\t */\n\tconst renderStep5 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <APIDocsStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 6: Success screen with all user data and other valuable options\n\t */\n\tconst renderStep6 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <SuccessStepV8 renderProps={props} />;\n\t}, []);\n\n\t// Step labels for device authentication flow\n\tconst stepLabels = useMemo(() => {\n\t\tif (deviceType === 'FIDO2') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Start FIDO in Browser',\n\t\t\t\t'Passkey confirmation',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else if (deviceType === 'MOBILE') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Push to Mobile App',\n\t\t\t\t'User Confirms on Mobile',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else {\n\t\t\t// SMS, Email, TOTP, WhatsApp\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Generate OTP/QR',\n\t\t\t\t'Validate OTP',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t}\n\t}, [deviceType]);\n\n\tconst shouldHideNextButton = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\tif (props.nav.currentStep === 0) {\n\t\t\treturn true; // Hide Next button on configuration step, use form submit\n\t\t}\n\t\tif (props.nav.currentStep === 1) {\n\t\t\treturn true; // Hide Next button on user login step, use authentication button\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\treturn (\n\t\t<>\n\t\t\t<MFAFlowBaseV8\n\t\t\t\tdeviceType={deviceType}\n\t\t\t\trenderStep0={renderStep0}\n\t\t\t\trenderStep1={renderStep1}\n\t\t\t\trenderStep2={renderStep2}\n\t\t\t\trenderStep3={renderStep3}\n\t\t\t\trenderStep4={renderStep4}\n\t\t\t\trenderStep5={renderStep5}\n\t\t\t\trenderStep6={renderStep6}\n\t\t\t\tvalidateStep0={validateStep0}\n\t\t\t\tstepLabels={stepLabels}\n\t\t\t\tshouldHideNextButton={shouldHideNextButton}\n\t\t\t\tflowType=\"device-auth\"\n\t\t\t/>\n\t\t\t<div style={{ height: '300px' }} />\n\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\n\t\t\t{/* User Login Modal for User Flow OAuth */}\n\t\t\t<UserLoginModalV8\n\t\t\t\tisOpen={showUserLoginModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\t\tpendingRegistrationRef.current = null;\n\t\t\t\t}}\n\t\t\t\tonTokenReceived={handleUserTokenReceived}\n\t\t\t\tenvironmentId={envIdForModal}\n\t\t\t/>\n\n\t\t\t{/* User Token Success Page - Show token after OAuth login */}\n\t\t\t{showUserTokenSuccess && userTokenForDisplay && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 10000,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\t\t\tboxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Success Header */}\n\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\twidth: '64px',\n\t\t\t\t\t\t\t\t\theight: '64px',\n\t\t\t\t\t\t\t\t\tborderRadius: '50%',\n\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>‚úÖ</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<h2 style={{ margin: '0 0 8px 0', fontSize: '24px', color: '#1f2937' }}>\n\t\t\t\t\t\t\t\tAuthentication Successful!\n\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\tYour user token has been obtained and is ready to use.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Username Dropdown */}\n\t\t\t\t\t\t{usernameFromToken && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUsernameDropdown(!showUsernameDropdown)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tpadding: 0,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: showUsernameDropdown ? '12px' : 0,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '16px', color: '#374151' }}>Username</h3>\n\t\t\t\t\t\t\t\t\t{showUsernameDropdown ? (\n\t\t\t\t\t\t\t\t\t\t<FiChevronUp size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t<FiChevronDown size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{showUsernameDropdown && (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{usernameFromToken}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(usernameFromToken);\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('Username copied to clipboard!');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüìã Copy Username\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Token Display */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<h3 style={{ margin: '0 0 12px 0', fontSize: '16px', color: '#374151' }}>\n\t\t\t\t\t\t\t\tUser Access Token\n\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{userTokenForDisplay}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(userTokenForDisplay);\n\t\t\t\t\t\t\t\t\ttoastV8.success('Token copied to clipboard!');\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüìã Copy Token\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Next Steps Info */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#eff6ff',\n\t\t\t\t\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#1e40af', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t<strong>Next:</strong> Click \"Continue with Registration\" to proceed with your{' '}\n\t\t\t\t\t\t\t\t{config.displayName} device registration using this user token.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Continue Button */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleContinueAfterUserLogin}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\tbackground: '#10b981',\n\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tboxShadow: '0 2px 8px rgba(16, 185, 129, 0.3)',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tContinue with Registration ‚Üí\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</>\n\t);\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default UnifiedMFARegistrationFlowV8;\n"},"tags":["fixable"],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/DeviceComponentRegistry.tsx"},"span":[8384,8387],"sourceCode":"/**\n * @file DeviceComponentRegistry.tsx\n * @module v8/flows/unified/components\n * @description Registry of device-specific custom components for complex flows\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle the 20% of device flows that are too complex for dynamic forms.\n * TOTP needs QR code display, FIDO2 needs WebAuthn, Mobile needs app pairing.\n *\n * Architecture:\n * - Each component receives standard props (credentials, mfaState, callbacks)\n * - Components manage their own device-specific UI\n * - Registry maps device types to components (null = use DynamicFormRenderer)\n *\n * @example\n * const CustomComponent = DeviceComponentRegistry[deviceType];\n * if (CustomComponent) {\n *   return <CustomComponent {...props} />;\n * } else {\n *   return <DynamicFormRenderer {...props} />;\n * }\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport type { DeviceConfigKey, DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFACredentials, MFAState } from '@/v8/flows/shared/MFATypes';\n\nconst MODULE_TAG = '[üé® DEVICE-COMPONENT-REGISTRY]';\n\n// ============================================================================\n// SHARED PROPS INTERFACE\n// ============================================================================\n\n/**\n * Props passed to device-specific custom components\n */\nexport interface DeviceComponentProps {\n\t/** MFA credentials */\n\tcredentials: MFACredentials;\n\n\t/** MFA state (contains device-specific data like QR codes) */\n\tmfaState: MFAState;\n\n\t/** Update MFA state */\n\tsetMfaState: (state: MFAState | ((prev: MFAState) => MFAState)) => void;\n\n\t/** Success callback */\n\tonSuccess: (data: Record<string, unknown>) => void;\n\n\t/** Error callback */\n\tonError: (error: string) => void;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device configuration */\n\tconfig: DeviceFlowConfig;\n}\n\n// ============================================================================\n// TOTP REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * TOTP Registration Component\n *\n * Displays QR code and secret key for authenticator app setup.\n * Used for Google Authenticator, Authy, Microsoft Authenticator, etc.\n */\nexport const TOTPRegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tmfaState,\n\tconfig,\n\tonSuccess,\n\tonError,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering TOTP registration component`, {\n\t\thasQRCode: !!mfaState.qrCodeUrl,\n\t\thasSecret: !!mfaState.totpSecret,\n\t});\n\n\tconst [showSecret, setShowSecret] = useState(false);\n\tconst [copied, setCopied] = useState(false);\n\n\t// Handle copy secret to clipboard\n\tconst handleCopySecret = useCallback(() => {\n\t\tif (mfaState.totpSecret) {\n\t\t\tnavigator.clipboard\n\t\t\t\t.writeText(mfaState.totpSecret)\n\t\t\t\t.then(() => {\n\t\t\t\t\tconsole.log(`${MODULE_TAG} Secret copied to clipboard`);\n\t\t\t\t\tsetCopied(true);\n\t\t\t\t\tsetTimeout(() => setCopied(false), 2000);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tconsole.error(`${MODULE_TAG} Failed to copy secret:`, err);\n\t\t\t\t\tonError('Failed to copy secret to clipboard');\n\t\t\t\t});\n\t\t}\n\t}, [mfaState.totpSecret, onError]);\n\n\treturn (\n\t\t<div className=\"totp-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"totp-header\">\n\t\t\t\t<h3>{config.icon} Set Up Authenticator App</h3>\n\t\t\t\t<p className=\"totp-description\">\n\t\t\t\t\tScan the QR code below with your authenticator app, or enter the secret key manually.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* QR Code Display */}\n\t\t\t{mfaState.qrCodeUrl && (\n\t\t\t\t<div className=\"qr-code-section\">\n\t\t\t\t\t<div className=\"qr-code-container\">\n\t\t\t\t\t\t<img src={mfaState.qrCodeUrl} alt=\"TOTP QR Code\" className=\"qr-code-image\" />\n\t\t\t\t\t</div>\n\t\t\t\t\t<p className=\"qr-instruction\">Scan this QR code with your authenticator app</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Manual Entry Section */}\n\t\t\t{mfaState.totpSecret && (\n\t\t\t\t<div className=\"manual-entry-section\">\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowSecret(!showSecret)}\n\t\t\t\t\t\tclassName=\"toggle-secret-button\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{showSecret ? 'Hide' : 'Show'} Manual Entry Key\n\t\t\t\t\t</button>\n\n\t\t\t\t\t{showSecret && (\n\t\t\t\t\t\t<div className=\"secret-display\">\n\t\t\t\t\t\t\t<label htmlFor=\"totp-secret\">Secret Key:</label>\n\t\t\t\t\t\t\t<div className=\"secret-input-group\">\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"totp-secret\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={mfaState.totpSecret}\n\t\t\t\t\t\t\t\t\treadOnly\n\t\t\t\t\t\t\t\t\tclassName=\"secret-input\"\n\t\t\t\t\t\t\t\t\tonClick={(e) => e.currentTarget.select()}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleCopySecret}\n\t\t\t\t\t\t\t\t\tclassName=\"copy-button\"\n\t\t\t\t\t\t\t\t\taria-label=\"Copy secret to clipboard\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{copied ? '‚úì Copied' : 'üìã Copy'}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p className=\"secret-hint\">\n\t\t\t\t\t\t\t\tEnter this key manually in your authenticator app if you can't scan the QR code.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Supported Apps */}\n\t\t\t<details className=\"supported-apps\">\n\t\t\t\t<summary>Supported Authenticator Apps</summary>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>Google Authenticator</li>\n\t\t\t\t\t<li>Microsoft Authenticator</li>\n\t\t\t\t\t<li>Authy</li>\n\t\t\t\t\t<li>1Password</li>\n\t\t\t\t\t<li>LastPass Authenticator</li>\n\t\t\t\t\t<li>Any TOTP-compatible app</li>\n\t\t\t\t</ul>\n\t\t\t</details>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"totp-education\">\n\t\t\t\t\t<summary>Learn more about TOTP</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\n\t\t\t{/* No QR Code Warning */}\n\t\t\t{!mfaState.qrCodeUrl && !mfaState.totpSecret && (\n\t\t\t\t<div className=\"no-data-warning\">\n\t\t\t\t\t<p>‚ö†Ô∏è QR code and secret not available yet.</p>\n\t\t\t\t\t<p>Please complete device registration first.</p>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// FIDO2 REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * FIDO2 Registration Component\n *\n * Triggers WebAuthn credential registration for security keys and biometrics.\n * Used for YubiKey, Windows Hello, Touch ID, Face ID, etc.\n */\nexport const FIDO2RegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tcredentials,\n\tmfaState,\n\tsetMfaState,\n\tonSuccess,\n\tonError,\n\tcontroller,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering FIDO2 registration component`, {\n\t\thasOptions: !!mfaState.publicKeyCredentialCreationOptions,\n\t});\n\n\tconst [isRegistering, setIsRegistering] = useState(false);\n\tconst [browserSupported, setBrowserSupported] = useState(true);\n\n\t// Check browser support on mount\n\tuseEffect(() => {\n\t\tconst supported =\n\t\t\twindow.PublicKeyCredential !== undefined && navigator.credentials !== undefined;\n\n\t\tconsole.log(`${MODULE_TAG} WebAuthn support:`, supported);\n\t\tsetBrowserSupported(supported);\n\n\t\tif (!supported) {\n\t\t\tonError(\n\t\t\t\t'Your browser does not support FIDO2/WebAuthn. Please use a modern browser like Chrome, Firefox, Safari, or Edge.'\n\t\t\t);\n\t\t}\n\t}, [onError]);\n\n\t/**\n\t * Handle WebAuthn registration\n\t * Calls the FIDO2FlowController to complete the full registration flow:\n\t * 1. Call navigator.credentials.create() with PingOne options\n\t * 2. Send attestation back to PingOne to activate device\n\t */\n\tconst handleWebAuthnRegistration = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting WebAuthn registration`);\n\t\tsetIsRegistering(true);\n\n\t\ttry {\n\t\t\t// Check if we have device ID and credential creation options\n\t\t\tif (!mfaState.deviceId) {\n\t\t\t\tthrow new Error('Device ID is missing. Please try registering again.');\n\t\t\t}\n\n\t\t\tconst options = mfaState.publicKeyCredentialCreationOptions;\n\n\t\t\tif (!options) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t'Missing WebAuthn credential creation options. Please complete device registration first.'\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t`${MODULE_TAG} Calling controller.registerFIDO2Device with deviceId:`,\n\t\t\t\tmfaState.deviceId\n\t\t\t);\n\n\t\t\t// Import FIDO2FlowController\n\t\t\tconst { FIDO2FlowController } = await import('@/v8/flows/controllers/FIDO2FlowController');\n\n\t\t\t// Check if controller is FIDO2FlowController instance, otherwise create one\n\t\t\tconst fido2Controller =\n\t\t\t\tcontroller instanceof FIDO2FlowController\n\t\t\t\t\t? controller\n\t\t\t\t\t: new FIDO2FlowController({\n\t\t\t\t\t\t\tonUpdate: (state: any) => setMfaState((prev) => ({ ...prev, ...state })),\n\t\t\t\t\t\t\tonError: (error: string) => console.error('FIDO2 Controller Error:', error),\n\t\t\t\t\t\t});\n\n\t\t\t// Call the full FIDO2 registration flow (WebAuthn + activation)\n\t\t\tconst result = await (fido2Controller as any).registerFIDO2Device(\n\t\t\t\tcredentials,\n\t\t\t\tmfaState.deviceId,\n\t\t\t\tJSON.stringify(options)\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} FIDO2 registration complete:`, result);\n\n\t\t\t// Update state with final device status\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceStatus: result.status,\n\t\t\t\tcredentialId: result.credentialId,\n\t\t\t}));\n\n\t\t\t// Call success callback - this will trigger navigation to next step\n\t\t\tonSuccess({\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tcredentialId: result.credentialId,\n\t\t\t});\n\t\t} catch (error: unknown) {\n\t\t\tconsole.error(`${MODULE_TAG} WebAuthn registration failed:`, error);\n\n\t\t\t// Handle common errors\n\t\t\tlet errorMessage = 'Biometric registration failed';\n\n\t\t\tif (error instanceof Error) {\n\t\t\t\terrorMessage = error.message;\n\t\t\t}\n\n\t\t\tonError(errorMessage);\n\t\t} finally {\n\t\t\tsetIsRegistering(false);\n\t\t}\n\t}, [mfaState, setMfaState, onSuccess, onError, controller, credentials]);\n\n\treturn (\n\t\t<div className=\"fido2-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"fido2-header\">\n\t\t\t\t<h3>{config.icon} Register Security Key or Biometric</h3>\n\t\t\t\t<p className=\"fido2-description\">\n\t\t\t\t\tUse a hardware security key or your device's biometric authentication (fingerprint, facial\n\t\t\t\t\trecognition).\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Browser Support Check */}\n\t\t\t{!browserSupported && (\n\t\t\t\t<div className=\"browser-not-supported\">\n\t\t\t\t\t<p>‚ùå Your browser does not support FIDO2/WebAuthn</p>\n\t\t\t\t\t<p>Please use Chrome, Firefox, Safari, or Edge</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Button */}\n\t\t\t{browserSupported && (\n\t\t\t\t<div className=\"fido2-registration-section\">\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={handleWebAuthnRegistration}\n\t\t\t\t\t\tdisabled={\n\t\t\t\t\t\t\tisRegistering || !mfaState.publicKeyCredentialCreationOptions || !mfaState.deviceId\n\t\t\t\t\t\t}\n\t\t\t\t\t\tclassName=\"webauthn-register-button\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{isRegistering ? 'üîê Authenticating...' : 'üîê Complete Biometric Registration'}\n\t\t\t\t\t</button>\n\n\t\t\t\t\t{isRegistering && (\n\t\t\t\t\t\t<p className=\"registration-hint\">\n\t\t\t\t\t\t\tüîê Follow the prompts from your browser to use your security key or biometric\n\t\t\t\t\t\t\t(TouchID/FaceID)...\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{!mfaState.publicKeyCredentialCreationOptions && (\n\t\t\t\t\t\t<p className=\"no-options-warning\">\n\t\t\t\t\t\t\t‚ö†Ô∏è Waiting for device creation... Click \"Next Step\" above to create the device first.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{mfaState.publicKeyCredentialCreationOptions && !isRegistering && (\n\t\t\t\t\t\t<p className=\"registration-ready\">\n\t\t\t\t\t\t\t‚úÖ Device created. Click the button above to complete biometric registration.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Supported Authenticators */}\n\t\t\t<details className=\"supported-authenticators\">\n\t\t\t\t<summary>Supported Authenticators</summary>\n\t\t\t\t<div className=\"authenticator-lists\">\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h4>Hardware Security Keys</h4>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>YubiKey (5 Series, Security Key)</li>\n\t\t\t\t\t\t\t<li>Google Titan Security Key</li>\n\t\t\t\t\t\t\t<li>Feitian ePass FIDO2</li>\n\t\t\t\t\t\t\t<li>Thetis FIDO2 Security Key</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h4>Platform Authenticators</h4>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>Windows Hello (fingerprint, facial recognition)</li>\n\t\t\t\t\t\t\t<li>Touch ID (MacBook, iMac)</li>\n\t\t\t\t\t\t\t<li>Face ID (iPhone, iPad)</li>\n\t\t\t\t\t\t\t<li>Android Biometrics</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</details>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"fido2-education\">\n\t\t\t\t\t<summary>Learn more about FIDO2</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MOBILE REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * Mobile Registration Component\n *\n * Displays QR code for PingOne Mobile app pairing.\n * Used for mobile push notifications.\n */\nexport const MobileRegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tmfaState,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering Mobile registration component`, {\n\t\thasQRCode: !!mfaState.qrCodeUrl,\n\t\thasPairingKey: !!mfaState.pairingKey,\n\t});\n\n\tconst [copied, setCopied] = useState(false);\n\n\t// Handle copy pairing key to clipboard\n\tconst handleCopyPairingKey = useCallback(() => {\n\t\tif (mfaState.pairingKey) {\n\t\t\tnavigator.clipboard\n\t\t\t\t.writeText(mfaState.pairingKey)\n\t\t\t\t.then(() => {\n\t\t\t\t\tconsole.log(`${MODULE_TAG} Pairing key copied to clipboard`);\n\t\t\t\t\tsetCopied(true);\n\t\t\t\t\tsetTimeout(() => setCopied(false), 2000);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tconsole.error(`${MODULE_TAG} Failed to copy pairing key:`, err);\n\t\t\t\t});\n\t\t}\n\t}, [mfaState.pairingKey]);\n\n\treturn (\n\t\t<div className=\"mobile-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"mobile-header\">\n\t\t\t\t<h3>{config.icon} Pair PingOne Mobile App</h3>\n\t\t\t\t<p className=\"mobile-description\">\n\t\t\t\t\tScan the QR code below with the PingOne Mobile app to pair your device.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* QR Code Display */}\n\t\t\t{mfaState.qrCodeUrl && (\n\t\t\t\t<div className=\"pairing-qr-section\">\n\t\t\t\t\t<div className=\"pairing-qr-container\">\n\t\t\t\t\t\t<img\n\t\t\t\t\t\t\tsrc={mfaState.qrCodeUrl}\n\t\t\t\t\t\t\talt=\"Mobile Pairing QR Code\"\n\t\t\t\t\t\t\tclassName=\"pairing-qr-image\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<p className=\"qr-instruction\">Open PingOne Mobile app and scan this QR code</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Manual Pairing Key */}\n\t\t\t{mfaState.pairingKey && (\n\t\t\t\t<div className=\"pairing-key-section\">\n\t\t\t\t\t<h4>Manual Pairing</h4>\n\t\t\t\t\t<p>If you can't scan the QR code, enter this pairing key manually:</p>\n\n\t\t\t\t\t<div className=\"pairing-key-display\">\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={mfaState.pairingKey}\n\t\t\t\t\t\t\treadOnly\n\t\t\t\t\t\t\tclassName=\"pairing-key-input\"\n\t\t\t\t\t\t\tonClick={(e) => e.currentTarget.select()}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleCopyPairingKey}\n\t\t\t\t\t\t\tclassName=\"copy-button\"\n\t\t\t\t\t\t\taria-label=\"Copy pairing key to clipboard\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{copied ? '‚úì Copied' : 'üìã Copy'}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* App Download Instructions */}\n\t\t\t<div className=\"app-download-section\">\n\t\t\t\t<h4>Don't have the app?</h4>\n\t\t\t\t<p>Download PingOne Mobile from your app store:</p>\n\t\t\t\t<div className=\"app-store-buttons\">\n\t\t\t\t\t<a\n\t\t\t\t\t\thref=\"https://apps.apple.com/app/pingone/id1063305932\"\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\t\tclassName=\"app-store-link\"\n\t\t\t\t\t>\n\t\t\t\t\t\tüì± Download for iOS\n\t\t\t\t\t</a>\n\t\t\t\t\t<a\n\t\t\t\t\t\thref=\"https://play.google.com/store/apps/details?id=com.pingidentity.pingone\"\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\t\tclassName=\"app-store-link\"\n\t\t\t\t\t>\n\t\t\t\t\t\tü§ñ Download for Android\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"mobile-education\">\n\t\t\t\t\t<summary>Learn more about Mobile Push</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\n\t\t\t{/* No QR Code Warning */}\n\t\t\t{!mfaState.qrCodeUrl && !mfaState.pairingKey && (\n\t\t\t\t<div className=\"no-data-warning\">\n\t\t\t\t\t<p>‚ö†Ô∏è Pairing QR code and key not available yet.</p>\n\t\t\t\t\t<p>Please complete device registration first.</p>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// DEVICE COMPONENT REGISTRY\n// ============================================================================\n\n/**\n * Device Component Registry\n *\n * Maps device types to custom components.\n * - null = use DynamicFormRenderer (SMS, Email, WhatsApp)\n * - Component = use custom component (TOTP, FIDO2, Mobile)\n */\nexport const DeviceComponentRegistry: Record<\n\tDeviceConfigKey,\n\tReact.FC<DeviceComponentProps> | null\n> = {\n\tSMS: null, // Use DynamicFormRenderer\n\tEMAIL: null, // Use DynamicFormRenderer\n\tWHATSAPP: null, // Use DynamicFormRenderer\n\tTOTP: null, // Use DynamicFormRenderer - Registration happens first, QR shown in activation step\n\tFIDO2: FIDO2RegistrationComponent,\n\tMOBILE: MobileRegistrationComponent,\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default DeviceComponentRegistry;\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/DeviceComponentRegistry.tsx"},"span":[8647,8650],"sourceCode":"/**\n * @file DeviceComponentRegistry.tsx\n * @module v8/flows/unified/components\n * @description Registry of device-specific custom components for complex flows\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle the 20% of device flows that are too complex for dynamic forms.\n * TOTP needs QR code display, FIDO2 needs WebAuthn, Mobile needs app pairing.\n *\n * Architecture:\n * - Each component receives standard props (credentials, mfaState, callbacks)\n * - Components manage their own device-specific UI\n * - Registry maps device types to components (null = use DynamicFormRenderer)\n *\n * @example\n * const CustomComponent = DeviceComponentRegistry[deviceType];\n * if (CustomComponent) {\n *   return <CustomComponent {...props} />;\n * } else {\n *   return <DynamicFormRenderer {...props} />;\n * }\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport type { DeviceConfigKey, DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFACredentials, MFAState } from '@/v8/flows/shared/MFATypes';\n\nconst MODULE_TAG = '[üé® DEVICE-COMPONENT-REGISTRY]';\n\n// ============================================================================\n// SHARED PROPS INTERFACE\n// ============================================================================\n\n/**\n * Props passed to device-specific custom components\n */\nexport interface DeviceComponentProps {\n\t/** MFA credentials */\n\tcredentials: MFACredentials;\n\n\t/** MFA state (contains device-specific data like QR codes) */\n\tmfaState: MFAState;\n\n\t/** Update MFA state */\n\tsetMfaState: (state: MFAState | ((prev: MFAState) => MFAState)) => void;\n\n\t/** Success callback */\n\tonSuccess: (data: Record<string, unknown>) => void;\n\n\t/** Error callback */\n\tonError: (error: string) => void;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device configuration */\n\tconfig: DeviceFlowConfig;\n}\n\n// ============================================================================\n// TOTP REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * TOTP Registration Component\n *\n * Displays QR code and secret key for authenticator app setup.\n * Used for Google Authenticator, Authy, Microsoft Authenticator, etc.\n */\nexport const TOTPRegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tmfaState,\n\tconfig,\n\tonSuccess,\n\tonError,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering TOTP registration component`, {\n\t\thasQRCode: !!mfaState.qrCodeUrl,\n\t\thasSecret: !!mfaState.totpSecret,\n\t});\n\n\tconst [showSecret, setShowSecret] = useState(false);\n\tconst [copied, setCopied] = useState(false);\n\n\t// Handle copy secret to clipboard\n\tconst handleCopySecret = useCallback(() => {\n\t\tif (mfaState.totpSecret) {\n\t\t\tnavigator.clipboard\n\t\t\t\t.writeText(mfaState.totpSecret)\n\t\t\t\t.then(() => {\n\t\t\t\t\tconsole.log(`${MODULE_TAG} Secret copied to clipboard`);\n\t\t\t\t\tsetCopied(true);\n\t\t\t\t\tsetTimeout(() => setCopied(false), 2000);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tconsole.error(`${MODULE_TAG} Failed to copy secret:`, err);\n\t\t\t\t\tonError('Failed to copy secret to clipboard');\n\t\t\t\t});\n\t\t}\n\t}, [mfaState.totpSecret, onError]);\n\n\treturn (\n\t\t<div className=\"totp-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"totp-header\">\n\t\t\t\t<h3>{config.icon} Set Up Authenticator App</h3>\n\t\t\t\t<p className=\"totp-description\">\n\t\t\t\t\tScan the QR code below with your authenticator app, or enter the secret key manually.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* QR Code Display */}\n\t\t\t{mfaState.qrCodeUrl && (\n\t\t\t\t<div className=\"qr-code-section\">\n\t\t\t\t\t<div className=\"qr-code-container\">\n\t\t\t\t\t\t<img src={mfaState.qrCodeUrl} alt=\"TOTP QR Code\" className=\"qr-code-image\" />\n\t\t\t\t\t</div>\n\t\t\t\t\t<p className=\"qr-instruction\">Scan this QR code with your authenticator app</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Manual Entry Section */}\n\t\t\t{mfaState.totpSecret && (\n\t\t\t\t<div className=\"manual-entry-section\">\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowSecret(!showSecret)}\n\t\t\t\t\t\tclassName=\"toggle-secret-button\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{showSecret ? 'Hide' : 'Show'} Manual Entry Key\n\t\t\t\t\t</button>\n\n\t\t\t\t\t{showSecret && (\n\t\t\t\t\t\t<div className=\"secret-display\">\n\t\t\t\t\t\t\t<label htmlFor=\"totp-secret\">Secret Key:</label>\n\t\t\t\t\t\t\t<div className=\"secret-input-group\">\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"totp-secret\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={mfaState.totpSecret}\n\t\t\t\t\t\t\t\t\treadOnly\n\t\t\t\t\t\t\t\t\tclassName=\"secret-input\"\n\t\t\t\t\t\t\t\t\tonClick={(e) => e.currentTarget.select()}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleCopySecret}\n\t\t\t\t\t\t\t\t\tclassName=\"copy-button\"\n\t\t\t\t\t\t\t\t\taria-label=\"Copy secret to clipboard\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{copied ? '‚úì Copied' : 'üìã Copy'}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p className=\"secret-hint\">\n\t\t\t\t\t\t\t\tEnter this key manually in your authenticator app if you can't scan the QR code.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Supported Apps */}\n\t\t\t<details className=\"supported-apps\">\n\t\t\t\t<summary>Supported Authenticator Apps</summary>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>Google Authenticator</li>\n\t\t\t\t\t<li>Microsoft Authenticator</li>\n\t\t\t\t\t<li>Authy</li>\n\t\t\t\t\t<li>1Password</li>\n\t\t\t\t\t<li>LastPass Authenticator</li>\n\t\t\t\t\t<li>Any TOTP-compatible app</li>\n\t\t\t\t</ul>\n\t\t\t</details>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"totp-education\">\n\t\t\t\t\t<summary>Learn more about TOTP</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\n\t\t\t{/* No QR Code Warning */}\n\t\t\t{!mfaState.qrCodeUrl && !mfaState.totpSecret && (\n\t\t\t\t<div className=\"no-data-warning\">\n\t\t\t\t\t<p>‚ö†Ô∏è QR code and secret not available yet.</p>\n\t\t\t\t\t<p>Please complete device registration first.</p>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// FIDO2 REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * FIDO2 Registration Component\n *\n * Triggers WebAuthn credential registration for security keys and biometrics.\n * Used for YubiKey, Windows Hello, Touch ID, Face ID, etc.\n */\nexport const FIDO2RegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tcredentials,\n\tmfaState,\n\tsetMfaState,\n\tonSuccess,\n\tonError,\n\tcontroller,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering FIDO2 registration component`, {\n\t\thasOptions: !!mfaState.publicKeyCredentialCreationOptions,\n\t});\n\n\tconst [isRegistering, setIsRegistering] = useState(false);\n\tconst [browserSupported, setBrowserSupported] = useState(true);\n\n\t// Check browser support on mount\n\tuseEffect(() => {\n\t\tconst supported =\n\t\t\twindow.PublicKeyCredential !== undefined && navigator.credentials !== undefined;\n\n\t\tconsole.log(`${MODULE_TAG} WebAuthn support:`, supported);\n\t\tsetBrowserSupported(supported);\n\n\t\tif (!supported) {\n\t\t\tonError(\n\t\t\t\t'Your browser does not support FIDO2/WebAuthn. Please use a modern browser like Chrome, Firefox, Safari, or Edge.'\n\t\t\t);\n\t\t}\n\t}, [onError]);\n\n\t/**\n\t * Handle WebAuthn registration\n\t * Calls the FIDO2FlowController to complete the full registration flow:\n\t * 1. Call navigator.credentials.create() with PingOne options\n\t * 2. Send attestation back to PingOne to activate device\n\t */\n\tconst handleWebAuthnRegistration = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting WebAuthn registration`);\n\t\tsetIsRegistering(true);\n\n\t\ttry {\n\t\t\t// Check if we have device ID and credential creation options\n\t\t\tif (!mfaState.deviceId) {\n\t\t\t\tthrow new Error('Device ID is missing. Please try registering again.');\n\t\t\t}\n\n\t\t\tconst options = mfaState.publicKeyCredentialCreationOptions;\n\n\t\t\tif (!options) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t'Missing WebAuthn credential creation options. Please complete device registration first.'\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t`${MODULE_TAG} Calling controller.registerFIDO2Device with deviceId:`,\n\t\t\t\tmfaState.deviceId\n\t\t\t);\n\n\t\t\t// Import FIDO2FlowController\n\t\t\tconst { FIDO2FlowController } = await import('@/v8/flows/controllers/FIDO2FlowController');\n\n\t\t\t// Check if controller is FIDO2FlowController instance, otherwise create one\n\t\t\tconst fido2Controller =\n\t\t\t\tcontroller instanceof FIDO2FlowController\n\t\t\t\t\t? controller\n\t\t\t\t\t: new FIDO2FlowController({\n\t\t\t\t\t\t\tonUpdate: (state: any) => setMfaState((prev) => ({ ...prev, ...state })),\n\t\t\t\t\t\t\tonError: (error: string) => console.error('FIDO2 Controller Error:', error),\n\t\t\t\t\t\t});\n\n\t\t\t// Call the full FIDO2 registration flow (WebAuthn + activation)\n\t\t\tconst result = await (fido2Controller as any).registerFIDO2Device(\n\t\t\t\tcredentials,\n\t\t\t\tmfaState.deviceId,\n\t\t\t\tJSON.stringify(options)\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} FIDO2 registration complete:`, result);\n\n\t\t\t// Update state with final device status\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceStatus: result.status,\n\t\t\t\tcredentialId: result.credentialId,\n\t\t\t}));\n\n\t\t\t// Call success callback - this will trigger navigation to next step\n\t\t\tonSuccess({\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tcredentialId: result.credentialId,\n\t\t\t});\n\t\t} catch (error: unknown) {\n\t\t\tconsole.error(`${MODULE_TAG} WebAuthn registration failed:`, error);\n\n\t\t\t// Handle common errors\n\t\t\tlet errorMessage = 'Biometric registration failed';\n\n\t\t\tif (error instanceof Error) {\n\t\t\t\terrorMessage = error.message;\n\t\t\t}\n\n\t\t\tonError(errorMessage);\n\t\t} finally {\n\t\t\tsetIsRegistering(false);\n\t\t}\n\t}, [mfaState, setMfaState, onSuccess, onError, controller, credentials]);\n\n\treturn (\n\t\t<div className=\"fido2-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"fido2-header\">\n\t\t\t\t<h3>{config.icon} Register Security Key or Biometric</h3>\n\t\t\t\t<p className=\"fido2-description\">\n\t\t\t\t\tUse a hardware security key or your device's biometric authentication (fingerprint, facial\n\t\t\t\t\trecognition).\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Browser Support Check */}\n\t\t\t{!browserSupported && (\n\t\t\t\t<div className=\"browser-not-supported\">\n\t\t\t\t\t<p>‚ùå Your browser does not support FIDO2/WebAuthn</p>\n\t\t\t\t\t<p>Please use Chrome, Firefox, Safari, or Edge</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Button */}\n\t\t\t{browserSupported && (\n\t\t\t\t<div className=\"fido2-registration-section\">\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={handleWebAuthnRegistration}\n\t\t\t\t\t\tdisabled={\n\t\t\t\t\t\t\tisRegistering || !mfaState.publicKeyCredentialCreationOptions || !mfaState.deviceId\n\t\t\t\t\t\t}\n\t\t\t\t\t\tclassName=\"webauthn-register-button\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{isRegistering ? 'üîê Authenticating...' : 'üîê Complete Biometric Registration'}\n\t\t\t\t\t</button>\n\n\t\t\t\t\t{isRegistering && (\n\t\t\t\t\t\t<p className=\"registration-hint\">\n\t\t\t\t\t\t\tüîê Follow the prompts from your browser to use your security key or biometric\n\t\t\t\t\t\t\t(TouchID/FaceID)...\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{!mfaState.publicKeyCredentialCreationOptions && (\n\t\t\t\t\t\t<p className=\"no-options-warning\">\n\t\t\t\t\t\t\t‚ö†Ô∏è Waiting for device creation... Click \"Next Step\" above to create the device first.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{mfaState.publicKeyCredentialCreationOptions && !isRegistering && (\n\t\t\t\t\t\t<p className=\"registration-ready\">\n\t\t\t\t\t\t\t‚úÖ Device created. Click the button above to complete biometric registration.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Supported Authenticators */}\n\t\t\t<details className=\"supported-authenticators\">\n\t\t\t\t<summary>Supported Authenticators</summary>\n\t\t\t\t<div className=\"authenticator-lists\">\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h4>Hardware Security Keys</h4>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>YubiKey (5 Series, Security Key)</li>\n\t\t\t\t\t\t\t<li>Google Titan Security Key</li>\n\t\t\t\t\t\t\t<li>Feitian ePass FIDO2</li>\n\t\t\t\t\t\t\t<li>Thetis FIDO2 Security Key</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h4>Platform Authenticators</h4>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>Windows Hello (fingerprint, facial recognition)</li>\n\t\t\t\t\t\t\t<li>Touch ID (MacBook, iMac)</li>\n\t\t\t\t\t\t\t<li>Face ID (iPhone, iPad)</li>\n\t\t\t\t\t\t\t<li>Android Biometrics</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</details>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"fido2-education\">\n\t\t\t\t\t<summary>Learn more about FIDO2</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MOBILE REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * Mobile Registration Component\n *\n * Displays QR code for PingOne Mobile app pairing.\n * Used for mobile push notifications.\n */\nexport const MobileRegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tmfaState,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering Mobile registration component`, {\n\t\thasQRCode: !!mfaState.qrCodeUrl,\n\t\thasPairingKey: !!mfaState.pairingKey,\n\t});\n\n\tconst [copied, setCopied] = useState(false);\n\n\t// Handle copy pairing key to clipboard\n\tconst handleCopyPairingKey = useCallback(() => {\n\t\tif (mfaState.pairingKey) {\n\t\t\tnavigator.clipboard\n\t\t\t\t.writeText(mfaState.pairingKey)\n\t\t\t\t.then(() => {\n\t\t\t\t\tconsole.log(`${MODULE_TAG} Pairing key copied to clipboard`);\n\t\t\t\t\tsetCopied(true);\n\t\t\t\t\tsetTimeout(() => setCopied(false), 2000);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tconsole.error(`${MODULE_TAG} Failed to copy pairing key:`, err);\n\t\t\t\t});\n\t\t}\n\t}, [mfaState.pairingKey]);\n\n\treturn (\n\t\t<div className=\"mobile-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"mobile-header\">\n\t\t\t\t<h3>{config.icon} Pair PingOne Mobile App</h3>\n\t\t\t\t<p className=\"mobile-description\">\n\t\t\t\t\tScan the QR code below with the PingOne Mobile app to pair your device.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* QR Code Display */}\n\t\t\t{mfaState.qrCodeUrl && (\n\t\t\t\t<div className=\"pairing-qr-section\">\n\t\t\t\t\t<div className=\"pairing-qr-container\">\n\t\t\t\t\t\t<img\n\t\t\t\t\t\t\tsrc={mfaState.qrCodeUrl}\n\t\t\t\t\t\t\talt=\"Mobile Pairing QR Code\"\n\t\t\t\t\t\t\tclassName=\"pairing-qr-image\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<p className=\"qr-instruction\">Open PingOne Mobile app and scan this QR code</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Manual Pairing Key */}\n\t\t\t{mfaState.pairingKey && (\n\t\t\t\t<div className=\"pairing-key-section\">\n\t\t\t\t\t<h4>Manual Pairing</h4>\n\t\t\t\t\t<p>If you can't scan the QR code, enter this pairing key manually:</p>\n\n\t\t\t\t\t<div className=\"pairing-key-display\">\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={mfaState.pairingKey}\n\t\t\t\t\t\t\treadOnly\n\t\t\t\t\t\t\tclassName=\"pairing-key-input\"\n\t\t\t\t\t\t\tonClick={(e) => e.currentTarget.select()}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleCopyPairingKey}\n\t\t\t\t\t\t\tclassName=\"copy-button\"\n\t\t\t\t\t\t\taria-label=\"Copy pairing key to clipboard\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{copied ? '‚úì Copied' : 'üìã Copy'}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* App Download Instructions */}\n\t\t\t<div className=\"app-download-section\">\n\t\t\t\t<h4>Don't have the app?</h4>\n\t\t\t\t<p>Download PingOne Mobile from your app store:</p>\n\t\t\t\t<div className=\"app-store-buttons\">\n\t\t\t\t\t<a\n\t\t\t\t\t\thref=\"https://apps.apple.com/app/pingone/id1063305932\"\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\t\tclassName=\"app-store-link\"\n\t\t\t\t\t>\n\t\t\t\t\t\tüì± Download for iOS\n\t\t\t\t\t</a>\n\t\t\t\t\t<a\n\t\t\t\t\t\thref=\"https://play.google.com/store/apps/details?id=com.pingidentity.pingone\"\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\t\tclassName=\"app-store-link\"\n\t\t\t\t\t>\n\t\t\t\t\t\tü§ñ Download for Android\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"mobile-education\">\n\t\t\t\t\t<summary>Learn more about Mobile Push</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\n\t\t\t{/* No QR Code Warning */}\n\t\t\t{!mfaState.qrCodeUrl && !mfaState.pairingKey && (\n\t\t\t\t<div className=\"no-data-warning\">\n\t\t\t\t\t<p>‚ö†Ô∏è Pairing QR code and key not available yet.</p>\n\t\t\t\t\t<p>Please complete device registration first.</p>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// DEVICE COMPONENT REGISTRY\n// ============================================================================\n\n/**\n * Device Component Registry\n *\n * Maps device types to custom components.\n * - null = use DynamicFormRenderer (SMS, Email, WhatsApp)\n * - Component = use custom component (TOTP, FIDO2, Mobile)\n */\nexport const DeviceComponentRegistry: Record<\n\tDeviceConfigKey,\n\tReact.FC<DeviceComponentProps> | null\n> = {\n\tSMS: null, // Use DynamicFormRenderer\n\tEMAIL: null, // Use DynamicFormRenderer\n\tWHATSAPP: null, // Use DynamicFormRenderer\n\tTOTP: null, // Use DynamicFormRenderer - Registration happens first, QR shown in activation step\n\tFIDO2: FIDO2RegistrationComponent,\n\tMOBILE: MobileRegistrationComponent,\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default DeviceComponentRegistry;\n"},"tags":[],"source":null},{"category":"lint/correctness/noUnusedFunctionParameters","severity":"warning","description":"This parameter is unused.","message":[{"elements":[],"content":"This "},{"elements":["Emphasis"],"content":"parameter"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused parameters might be the result of an incomplete refactoring."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/DeviceComponentRegistry.tsx"},"span":[2437,2446],"sourceCode":"/**\n * @file DeviceComponentRegistry.tsx\n * @module v8/flows/unified/components\n * @description Registry of device-specific custom components for complex flows\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle the 20% of device flows that are too complex for dynamic forms.\n * TOTP needs QR code display, FIDO2 needs WebAuthn, Mobile needs app pairing.\n *\n * Architecture:\n * - Each component receives standard props (credentials, mfaState, callbacks)\n * - Components manage their own device-specific UI\n * - Registry maps device types to components (null = use DynamicFormRenderer)\n *\n * @example\n * const CustomComponent = DeviceComponentRegistry[deviceType];\n * if (CustomComponent) {\n *   return <CustomComponent {...props} />;\n * } else {\n *   return <DynamicFormRenderer {...props} />;\n * }\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport type { DeviceConfigKey, DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFACredentials, MFAState } from '@/v8/flows/shared/MFATypes';\n\nconst MODULE_TAG = '[üé® DEVICE-COMPONENT-REGISTRY]';\n\n// ============================================================================\n// SHARED PROPS INTERFACE\n// ============================================================================\n\n/**\n * Props passed to device-specific custom components\n */\nexport interface DeviceComponentProps {\n\t/** MFA credentials */\n\tcredentials: MFACredentials;\n\n\t/** MFA state (contains device-specific data like QR codes) */\n\tmfaState: MFAState;\n\n\t/** Update MFA state */\n\tsetMfaState: (state: MFAState | ((prev: MFAState) => MFAState)) => void;\n\n\t/** Success callback */\n\tonSuccess: (data: Record<string, unknown>) => void;\n\n\t/** Error callback */\n\tonError: (error: string) => void;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device configuration */\n\tconfig: DeviceFlowConfig;\n}\n\n// ============================================================================\n// TOTP REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * TOTP Registration Component\n *\n * Displays QR code and secret key for authenticator app setup.\n * Used for Google Authenticator, Authy, Microsoft Authenticator, etc.\n */\nexport const TOTPRegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tmfaState,\n\tconfig,\n\tonSuccess,\n\tonError,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering TOTP registration component`, {\n\t\thasQRCode: !!mfaState.qrCodeUrl,\n\t\thasSecret: !!mfaState.totpSecret,\n\t});\n\n\tconst [showSecret, setShowSecret] = useState(false);\n\tconst [copied, setCopied] = useState(false);\n\n\t// Handle copy secret to clipboard\n\tconst handleCopySecret = useCallback(() => {\n\t\tif (mfaState.totpSecret) {\n\t\t\tnavigator.clipboard\n\t\t\t\t.writeText(mfaState.totpSecret)\n\t\t\t\t.then(() => {\n\t\t\t\t\tconsole.log(`${MODULE_TAG} Secret copied to clipboard`);\n\t\t\t\t\tsetCopied(true);\n\t\t\t\t\tsetTimeout(() => setCopied(false), 2000);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tconsole.error(`${MODULE_TAG} Failed to copy secret:`, err);\n\t\t\t\t\tonError('Failed to copy secret to clipboard');\n\t\t\t\t});\n\t\t}\n\t}, [mfaState.totpSecret, onError]);\n\n\treturn (\n\t\t<div className=\"totp-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"totp-header\">\n\t\t\t\t<h3>{config.icon} Set Up Authenticator App</h3>\n\t\t\t\t<p className=\"totp-description\">\n\t\t\t\t\tScan the QR code below with your authenticator app, or enter the secret key manually.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* QR Code Display */}\n\t\t\t{mfaState.qrCodeUrl && (\n\t\t\t\t<div className=\"qr-code-section\">\n\t\t\t\t\t<div className=\"qr-code-container\">\n\t\t\t\t\t\t<img src={mfaState.qrCodeUrl} alt=\"TOTP QR Code\" className=\"qr-code-image\" />\n\t\t\t\t\t</div>\n\t\t\t\t\t<p className=\"qr-instruction\">Scan this QR code with your authenticator app</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Manual Entry Section */}\n\t\t\t{mfaState.totpSecret && (\n\t\t\t\t<div className=\"manual-entry-section\">\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowSecret(!showSecret)}\n\t\t\t\t\t\tclassName=\"toggle-secret-button\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{showSecret ? 'Hide' : 'Show'} Manual Entry Key\n\t\t\t\t\t</button>\n\n\t\t\t\t\t{showSecret && (\n\t\t\t\t\t\t<div className=\"secret-display\">\n\t\t\t\t\t\t\t<label htmlFor=\"totp-secret\">Secret Key:</label>\n\t\t\t\t\t\t\t<div className=\"secret-input-group\">\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"totp-secret\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={mfaState.totpSecret}\n\t\t\t\t\t\t\t\t\treadOnly\n\t\t\t\t\t\t\t\t\tclassName=\"secret-input\"\n\t\t\t\t\t\t\t\t\tonClick={(e) => e.currentTarget.select()}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleCopySecret}\n\t\t\t\t\t\t\t\t\tclassName=\"copy-button\"\n\t\t\t\t\t\t\t\t\taria-label=\"Copy secret to clipboard\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{copied ? '‚úì Copied' : 'üìã Copy'}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p className=\"secret-hint\">\n\t\t\t\t\t\t\t\tEnter this key manually in your authenticator app if you can't scan the QR code.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Supported Apps */}\n\t\t\t<details className=\"supported-apps\">\n\t\t\t\t<summary>Supported Authenticator Apps</summary>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>Google Authenticator</li>\n\t\t\t\t\t<li>Microsoft Authenticator</li>\n\t\t\t\t\t<li>Authy</li>\n\t\t\t\t\t<li>1Password</li>\n\t\t\t\t\t<li>LastPass Authenticator</li>\n\t\t\t\t\t<li>Any TOTP-compatible app</li>\n\t\t\t\t</ul>\n\t\t\t</details>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"totp-education\">\n\t\t\t\t\t<summary>Learn more about TOTP</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\n\t\t\t{/* No QR Code Warning */}\n\t\t\t{!mfaState.qrCodeUrl && !mfaState.totpSecret && (\n\t\t\t\t<div className=\"no-data-warning\">\n\t\t\t\t\t<p>‚ö†Ô∏è QR code and secret not available yet.</p>\n\t\t\t\t\t<p>Please complete device registration first.</p>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// FIDO2 REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * FIDO2 Registration Component\n *\n * Triggers WebAuthn credential registration for security keys and biometrics.\n * Used for YubiKey, Windows Hello, Touch ID, Face ID, etc.\n */\nexport const FIDO2RegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tcredentials,\n\tmfaState,\n\tsetMfaState,\n\tonSuccess,\n\tonError,\n\tcontroller,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering FIDO2 registration component`, {\n\t\thasOptions: !!mfaState.publicKeyCredentialCreationOptions,\n\t});\n\n\tconst [isRegistering, setIsRegistering] = useState(false);\n\tconst [browserSupported, setBrowserSupported] = useState(true);\n\n\t// Check browser support on mount\n\tuseEffect(() => {\n\t\tconst supported =\n\t\t\twindow.PublicKeyCredential !== undefined && navigator.credentials !== undefined;\n\n\t\tconsole.log(`${MODULE_TAG} WebAuthn support:`, supported);\n\t\tsetBrowserSupported(supported);\n\n\t\tif (!supported) {\n\t\t\tonError(\n\t\t\t\t'Your browser does not support FIDO2/WebAuthn. Please use a modern browser like Chrome, Firefox, Safari, or Edge.'\n\t\t\t);\n\t\t}\n\t}, [onError]);\n\n\t/**\n\t * Handle WebAuthn registration\n\t * Calls the FIDO2FlowController to complete the full registration flow:\n\t * 1. Call navigator.credentials.create() with PingOne options\n\t * 2. Send attestation back to PingOne to activate device\n\t */\n\tconst handleWebAuthnRegistration = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting WebAuthn registration`);\n\t\tsetIsRegistering(true);\n\n\t\ttry {\n\t\t\t// Check if we have device ID and credential creation options\n\t\t\tif (!mfaState.deviceId) {\n\t\t\t\tthrow new Error('Device ID is missing. Please try registering again.');\n\t\t\t}\n\n\t\t\tconst options = mfaState.publicKeyCredentialCreationOptions;\n\n\t\t\tif (!options) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t'Missing WebAuthn credential creation options. Please complete device registration first.'\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t`${MODULE_TAG} Calling controller.registerFIDO2Device with deviceId:`,\n\t\t\t\tmfaState.deviceId\n\t\t\t);\n\n\t\t\t// Import FIDO2FlowController\n\t\t\tconst { FIDO2FlowController } = await import('@/v8/flows/controllers/FIDO2FlowController');\n\n\t\t\t// Check if controller is FIDO2FlowController instance, otherwise create one\n\t\t\tconst fido2Controller =\n\t\t\t\tcontroller instanceof FIDO2FlowController\n\t\t\t\t\t? controller\n\t\t\t\t\t: new FIDO2FlowController({\n\t\t\t\t\t\t\tonUpdate: (state: any) => setMfaState((prev) => ({ ...prev, ...state })),\n\t\t\t\t\t\t\tonError: (error: string) => console.error('FIDO2 Controller Error:', error),\n\t\t\t\t\t\t});\n\n\t\t\t// Call the full FIDO2 registration flow (WebAuthn + activation)\n\t\t\tconst result = await (fido2Controller as any).registerFIDO2Device(\n\t\t\t\tcredentials,\n\t\t\t\tmfaState.deviceId,\n\t\t\t\tJSON.stringify(options)\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} FIDO2 registration complete:`, result);\n\n\t\t\t// Update state with final device status\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceStatus: result.status,\n\t\t\t\tcredentialId: result.credentialId,\n\t\t\t}));\n\n\t\t\t// Call success callback - this will trigger navigation to next step\n\t\t\tonSuccess({\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tcredentialId: result.credentialId,\n\t\t\t});\n\t\t} catch (error: unknown) {\n\t\t\tconsole.error(`${MODULE_TAG} WebAuthn registration failed:`, error);\n\n\t\t\t// Handle common errors\n\t\t\tlet errorMessage = 'Biometric registration failed';\n\n\t\t\tif (error instanceof Error) {\n\t\t\t\terrorMessage = error.message;\n\t\t\t}\n\n\t\t\tonError(errorMessage);\n\t\t} finally {\n\t\t\tsetIsRegistering(false);\n\t\t}\n\t}, [mfaState, setMfaState, onSuccess, onError, controller, credentials]);\n\n\treturn (\n\t\t<div className=\"fido2-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"fido2-header\">\n\t\t\t\t<h3>{config.icon} Register Security Key or Biometric</h3>\n\t\t\t\t<p className=\"fido2-description\">\n\t\t\t\t\tUse a hardware security key or your device's biometric authentication (fingerprint, facial\n\t\t\t\t\trecognition).\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Browser Support Check */}\n\t\t\t{!browserSupported && (\n\t\t\t\t<div className=\"browser-not-supported\">\n\t\t\t\t\t<p>‚ùå Your browser does not support FIDO2/WebAuthn</p>\n\t\t\t\t\t<p>Please use Chrome, Firefox, Safari, or Edge</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Button */}\n\t\t\t{browserSupported && (\n\t\t\t\t<div className=\"fido2-registration-section\">\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={handleWebAuthnRegistration}\n\t\t\t\t\t\tdisabled={\n\t\t\t\t\t\t\tisRegistering || !mfaState.publicKeyCredentialCreationOptions || !mfaState.deviceId\n\t\t\t\t\t\t}\n\t\t\t\t\t\tclassName=\"webauthn-register-button\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{isRegistering ? 'üîê Authenticating...' : 'üîê Complete Biometric Registration'}\n\t\t\t\t\t</button>\n\n\t\t\t\t\t{isRegistering && (\n\t\t\t\t\t\t<p className=\"registration-hint\">\n\t\t\t\t\t\t\tüîê Follow the prompts from your browser to use your security key or biometric\n\t\t\t\t\t\t\t(TouchID/FaceID)...\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{!mfaState.publicKeyCredentialCreationOptions && (\n\t\t\t\t\t\t<p className=\"no-options-warning\">\n\t\t\t\t\t\t\t‚ö†Ô∏è Waiting for device creation... Click \"Next Step\" above to create the device first.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{mfaState.publicKeyCredentialCreationOptions && !isRegistering && (\n\t\t\t\t\t\t<p className=\"registration-ready\">\n\t\t\t\t\t\t\t‚úÖ Device created. Click the button above to complete biometric registration.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Supported Authenticators */}\n\t\t\t<details className=\"supported-authenticators\">\n\t\t\t\t<summary>Supported Authenticators</summary>\n\t\t\t\t<div className=\"authenticator-lists\">\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h4>Hardware Security Keys</h4>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>YubiKey (5 Series, Security Key)</li>\n\t\t\t\t\t\t\t<li>Google Titan Security Key</li>\n\t\t\t\t\t\t\t<li>Feitian ePass FIDO2</li>\n\t\t\t\t\t\t\t<li>Thetis FIDO2 Security Key</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h4>Platform Authenticators</h4>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>Windows Hello (fingerprint, facial recognition)</li>\n\t\t\t\t\t\t\t<li>Touch ID (MacBook, iMac)</li>\n\t\t\t\t\t\t\t<li>Face ID (iPhone, iPad)</li>\n\t\t\t\t\t\t\t<li>Android Biometrics</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</details>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"fido2-education\">\n\t\t\t\t\t<summary>Learn more about FIDO2</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MOBILE REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * Mobile Registration Component\n *\n * Displays QR code for PingOne Mobile app pairing.\n * Used for mobile push notifications.\n */\nexport const MobileRegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tmfaState,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering Mobile registration component`, {\n\t\thasQRCode: !!mfaState.qrCodeUrl,\n\t\thasPairingKey: !!mfaState.pairingKey,\n\t});\n\n\tconst [copied, setCopied] = useState(false);\n\n\t// Handle copy pairing key to clipboard\n\tconst handleCopyPairingKey = useCallback(() => {\n\t\tif (mfaState.pairingKey) {\n\t\t\tnavigator.clipboard\n\t\t\t\t.writeText(mfaState.pairingKey)\n\t\t\t\t.then(() => {\n\t\t\t\t\tconsole.log(`${MODULE_TAG} Pairing key copied to clipboard`);\n\t\t\t\t\tsetCopied(true);\n\t\t\t\t\tsetTimeout(() => setCopied(false), 2000);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tconsole.error(`${MODULE_TAG} Failed to copy pairing key:`, err);\n\t\t\t\t});\n\t\t}\n\t}, [mfaState.pairingKey]);\n\n\treturn (\n\t\t<div className=\"mobile-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"mobile-header\">\n\t\t\t\t<h3>{config.icon} Pair PingOne Mobile App</h3>\n\t\t\t\t<p className=\"mobile-description\">\n\t\t\t\t\tScan the QR code below with the PingOne Mobile app to pair your device.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* QR Code Display */}\n\t\t\t{mfaState.qrCodeUrl && (\n\t\t\t\t<div className=\"pairing-qr-section\">\n\t\t\t\t\t<div className=\"pairing-qr-container\">\n\t\t\t\t\t\t<img\n\t\t\t\t\t\t\tsrc={mfaState.qrCodeUrl}\n\t\t\t\t\t\t\talt=\"Mobile Pairing QR Code\"\n\t\t\t\t\t\t\tclassName=\"pairing-qr-image\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<p className=\"qr-instruction\">Open PingOne Mobile app and scan this QR code</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Manual Pairing Key */}\n\t\t\t{mfaState.pairingKey && (\n\t\t\t\t<div className=\"pairing-key-section\">\n\t\t\t\t\t<h4>Manual Pairing</h4>\n\t\t\t\t\t<p>If you can't scan the QR code, enter this pairing key manually:</p>\n\n\t\t\t\t\t<div className=\"pairing-key-display\">\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={mfaState.pairingKey}\n\t\t\t\t\t\t\treadOnly\n\t\t\t\t\t\t\tclassName=\"pairing-key-input\"\n\t\t\t\t\t\t\tonClick={(e) => e.currentTarget.select()}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleCopyPairingKey}\n\t\t\t\t\t\t\tclassName=\"copy-button\"\n\t\t\t\t\t\t\taria-label=\"Copy pairing key to clipboard\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{copied ? '‚úì Copied' : 'üìã Copy'}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* App Download Instructions */}\n\t\t\t<div className=\"app-download-section\">\n\t\t\t\t<h4>Don't have the app?</h4>\n\t\t\t\t<p>Download PingOne Mobile from your app store:</p>\n\t\t\t\t<div className=\"app-store-buttons\">\n\t\t\t\t\t<a\n\t\t\t\t\t\thref=\"https://apps.apple.com/app/pingone/id1063305932\"\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\t\tclassName=\"app-store-link\"\n\t\t\t\t\t>\n\t\t\t\t\t\tüì± Download for iOS\n\t\t\t\t\t</a>\n\t\t\t\t\t<a\n\t\t\t\t\t\thref=\"https://play.google.com/store/apps/details?id=com.pingidentity.pingone\"\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\t\tclassName=\"app-store-link\"\n\t\t\t\t\t>\n\t\t\t\t\t\tü§ñ Download for Android\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"mobile-education\">\n\t\t\t\t\t<summary>Learn more about Mobile Push</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\n\t\t\t{/* No QR Code Warning */}\n\t\t\t{!mfaState.qrCodeUrl && !mfaState.pairingKey && (\n\t\t\t\t<div className=\"no-data-warning\">\n\t\t\t\t\t<p>‚ö†Ô∏è Pairing QR code and key not available yet.</p>\n\t\t\t\t\t<p>Please complete device registration first.</p>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// DEVICE COMPONENT REGISTRY\n// ============================================================================\n\n/**\n * Device Component Registry\n *\n * Maps device types to custom components.\n * - null = use DynamicFormRenderer (SMS, Email, WhatsApp)\n * - Component = use custom component (TOTP, FIDO2, Mobile)\n */\nexport const DeviceComponentRegistry: Record<\n\tDeviceConfigKey,\n\tReact.FC<DeviceComponentProps> | null\n> = {\n\tSMS: null, // Use DynamicFormRenderer\n\tEMAIL: null, // Use DynamicFormRenderer\n\tWHATSAPP: null, // Use DynamicFormRenderer\n\tTOTP: null, // Use DynamicFormRenderer - Registration happens first, QR shown in activation step\n\tFIDO2: FIDO2RegistrationComponent,\n\tMOBILE: MobileRegistrationComponent,\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default DeviceComponentRegistry;\n"},"tags":[],"source":null},{"category":"lint/correctness/noUnusedFunctionParameters","severity":"warning","description":"This parameter is unused.","message":[{"elements":[],"content":"This "},{"elements":["Emphasis"],"content":"parameter"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused parameters might be the result of an incomplete refactoring."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedActivationStep.tsx"},"span":[2090,2104],"sourceCode":"/**\n * @file UnifiedActivationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 3: Device Activation - Unified activation for all device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle device activation for all 6 device types using different methods:\n * - SMS, Email, WhatsApp, TOTP: OTP input and validation\n * - FIDO2: Already activated during registration (show success)\n * - Mobile: Show pairing status and completion\n *\n * Flow:\n * 1. Check device type and status\n * 2. Display appropriate activation UI\n * 3. Handle OTP validation or pairing completion\n * 4. Update mfaState with activation result\n * 5. Navigate to success step\n *\n * @example\n * <UnifiedActivationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n * />\n */\n\nimport { QRCodeSVG } from 'qrcode.react';\nimport React, { useCallback, useEffect, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { UnifiedOTPActivationTemplate } from './UnifiedOTPActivationTemplate';\n\nconst MODULE_TAG = '[üîê UNIFIED-ACTIVATION-STEP]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedActivationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Activation Step (Step 3)\n *\n * Handles device activation for all device types with appropriate UI:\n * - OTP input for SMS, Email, WhatsApp, TOTP\n * - Success message for FIDO2 (already activated)\n * - Pairing status for Mobile\n */\nexport const UnifiedActivationStep: React.FC<UnifiedActivationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering activation step for:`, config.deviceType);\n\tconsole.log(`${MODULE_TAG} Device status:`, mfaState.deviceStatus);\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [otp, setOtp] = useState('');\n\tconst [otpError, setOtpError] = useState<string | null>(null);\n\tconst [validationAttempts, setValidationAttempts] = useState(0);\n\tconst [canResend, setCanResend] = useState(false);\n\tconst [resendCooldown, setResendCooldown] = useState(0);\n\n\t// ========================================================================\n\t// EFFECTS\n\t// ========================================================================\n\n\t/**\n\t * Start resend cooldown timer (60 seconds)\n\t */\n\tuseEffect(() => {\n\t\tif (resendCooldown > 0) {\n\t\t\tconst timer = setTimeout(() => {\n\t\t\t\tsetResendCooldown(resendCooldown - 1);\n\t\t\t}, 1000);\n\t\t\treturn () => clearTimeout(timer);\n\t\t} else {\n\t\t\tsetCanResend(true);\n\t\t}\n\t}, [resendCooldown]);\n\n\t/**\n\t * Scroll to top when TOTP activation loads (so QR code is visible)\n\t * Use multiple scroll targets and requestAnimationFrame for reliability\n\t */\n\tuseEffect(() => {\n\t\tif (config.deviceType === 'TOTP' && (mfaState.qrCodeUrl || mfaState.totpSecret)) {\n\t\t\tconsole.log('üîç [TOTP DEBUG] Scrolling to top - QR code data available');\n\n\t\t\tconst scrollToTop = () => {\n\t\t\t\t// Scroll main window\n\t\t\t\twindow.scrollTo({ top: 0, left: 0, behavior: 'instant' });\n\t\t\t\tdocument.documentElement.scrollTop = 0;\n\t\t\t\tdocument.body.scrollTop = 0;\n\n\t\t\t\t// Find and scroll the step header into view\n\t\t\t\tconst stepHeader = document.querySelector('.step-header');\n\t\t\t\tif (stepHeader) {\n\t\t\t\t\tstepHeader.scrollIntoView({ behavior: 'instant', block: 'start' });\n\t\t\t\t}\n\n\t\t\t\t// Find and scroll the unified-activation-step container\n\t\t\t\tconst activationStep = document.querySelector('.unified-activation-step');\n\t\t\t\tif (activationStep) {\n\t\t\t\t\tactivationStep.scrollIntoView({ behavior: 'instant', block: 'start' });\n\t\t\t\t}\n\n\t\t\t\t// Scroll all scrollable parents\n\t\t\t\tconst scrollableElements = document.querySelectorAll('[style*=\"overflow\"]');\n\t\t\t\tscrollableElements.forEach((el) => {\n\t\t\t\t\tif (el instanceof HTMLElement) {\n\t\t\t\t\t\tel.scrollTop = 0;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t};\n\n\t\t\t// Multiple scroll attempts with increasing delays\n\t\t\tscrollToTop(); // Immediate\n\t\t\trequestAnimationFrame(scrollToTop); // After next paint\n\t\t\tsetTimeout(scrollToTop, 10);\n\t\t\tsetTimeout(scrollToTop, 50);\n\t\t\tsetTimeout(scrollToTop, 100);\n\t\t\tsetTimeout(scrollToTop, 200);\n\t\t\tsetTimeout(scrollToTop, 300);\n\t\t\tsetTimeout(scrollToTop, 500);\n\t\t}\n\t}, [config.deviceType, mfaState.qrCodeUrl, mfaState.totpSecret]); // Re-run when QR data arrives\n\n\t/**\n\t * Check if device is already activated\n\t * NOTE: Don't auto-advance for Admin Flow - user needs to see QR code or confirmation\n\t */\n\tuseEffect(() => {\n\t\t// Skip auto-advance for Admin Flow (user needs to manually click \"Continue to Success\")\n\t\tif (credentials.flowType === 'admin') {\n\t\t\treturn;\n\t\t}\n\n\t\tif (mfaState.deviceStatus === 'ACTIVE') {\n\t\t\tconsole.log(`${MODULE_TAG} Device already activated, proceeding to success`);\n\t\t\tnav.markStepComplete();\n\t\t\tsetTimeout(() => nav.goToNext(), 1500); // Auto-advance after 1.5s\n\t\t}\n\t}, [mfaState.deviceStatus, nav, credentials.flowType]);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle OTP input change\n\t */\n\tconst handleOtpChange = useCallback((value: string) => {\n\t\t// Only allow digits and limit to 6 characters\n\t\tconst sanitized = value.replace(/\\D/g, '').slice(0, 6);\n\t\tsetOtp(sanitized);\n\t\tsetOtpError(null);\n\t}, []);\n\n\t/**\n\t * Handle OTP validation (device activation)\n\t *\n\t * IMPORTANT: For registration flows, we use activateDevice() not validateOTP()\n\t * - activateDevice(): Used after device registration to activate with OTP\n\t * - validateOTP(): Used for authentication flows with an existing active device\n\t */\n\tconst handleValidateOtp = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Activating device with OTP:`, otp);\n\n\t\tif (!otp || otp.length !== 6) {\n\t\t\tsetOtpError('Please enter a valid 6-digit code');\n\t\t\treturn;\n\t\t}\n\n\t\tsetIsLoading(true);\n\n\t\ttry {\n\t\t\tconsole.log(`${MODULE_TAG} Activating device via activateDevice API`);\n\n\t\t\t// Activate device via MFAServiceV8.activateDevice()\n\t\t\t// This is the correct method for registration flows (not validateOTP)\n\t\t\tconst { MFAServiceV8 } = await import('@/v8/services/mfaServiceV8');\n\n\t\t\tconst result = await MFAServiceV8.activateDevice({\n\t\t\t\tenvironmentId: credentials.environmentId,\n\t\t\t\tusername: credentials.username,\n\t\t\t\tdeviceId: mfaState.deviceId,\n\t\t\t\totp,\n\t\t\t\t...(mfaState.deviceActivateUri && { deviceActivateUri: mfaState.deviceActivateUri }),\n\t\t\t});\n\n\t\t\t// Check if activation was successful\n\t\t\t// activateDevice returns the device object on success\n\t\t\tconst activationResult = result as Record<string, unknown>;\n\t\t\tif (!result || activationResult.error) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\tString(activationResult.error || activationResult.message || 'Device activation failed')\n\t\t\t\t);\n\t\t\t}\n\t\t\tconsole.log(`${MODULE_TAG} Device activation successful:`, result);\n\n\t\t\t// Update MFA state with activation result\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceStatus: 'ACTIVE',\n\t\t\t\tactivatedAt: new Date().toISOString(),\n\t\t\t}));\n\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} device activated successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to success step\n\t\t\tnav.goToNext();\n\n\t\t\t// Increment validation attempts\n\t\t\tsetValidationAttempts((prev) => prev + 1);\n\t\t} catch (error: unknown) {\n\t\t\tconsole.error(`${MODULE_TAG} Device activation failed:`, error);\n\n\t\t\t// Increment validation attempts\n\t\t\tsetValidationAttempts((prev) => prev + 1);\n\n\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Invalid OTP code';\n\t\t\tsetOtpError(errorMessage);\n\n\t\t\t// Set validation errors in nav\n\t\t\tnav.setValidationErrors([errorMessage]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\n\t\t\t// Clear OTP input after failed attempt\n\t\t\tsetOtp('');\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [otp, mfaState, credentials, config, nav, setMfaState, setIsLoading]);\n\n\t/**\n\t * Handle resend OTP (resend pairing code for device activation)\n\t *\n\t * Uses resendPairingCode() which is the correct method for devices in ACTIVATION_REQUIRED state.\n\t * This is different from authentication flows which use initializeDeviceAuthentication().\n\t */\n\tconst handleResendOtp = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Resending pairing code for device:`, mfaState.deviceId);\n\n\t\tsetIsLoading(true);\n\t\tsetCanResend(false);\n\t\tsetResendCooldown(60); // 60 second cooldown\n\n\t\ttry {\n\t\t\t// Resend pairing code via MFAServiceV8.resendPairingCode()\n\t\t\t// This is the correct method for registration activation flows\n\t\t\tconst { MFAServiceV8 } = await import('@/v8/services/mfaServiceV8');\n\t\t\tawait MFAServiceV8.resendPairingCode({\n\t\t\t\tenvironmentId: credentials.environmentId,\n\t\t\t\tusername: credentials.username,\n\t\t\t\tdeviceId: mfaState.deviceId,\n\t\t\t});\n\n\t\t\tconsole.log(`${MODULE_TAG} Pairing code resent successfully`);\n\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`New ${config.displayName} verification code sent`);\n\n\t\t\t// Clear previous OTP and error\n\t\t\tsetOtp('');\n\t\t\tsetOtpError(null);\n\t\t} catch (error: unknown) {\n\t\t\tconsole.error(`${MODULE_TAG} Resend pairing code failed:`, error);\n\n\t\t\tconst errorMessage =\n\t\t\t\terror instanceof Error ? error.message : 'Failed to resend verification code';\n\t\t\tsetOtpError(errorMessage);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\n\t\t\t// Reset cooldown on error\n\t\t\tsetCanResend(true);\n\t\t\tsetResendCooldown(0);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [\n\t\tmfaState.deviceId,\n\t\tcredentials.environmentId,\n\t\tcredentials.username,\n\t\tconfig.displayName,\n\t\tsetIsLoading,\n\t]);\n\n\t// ========================================================================\n\t// RENDER LOGIC\n\t// ========================================================================\n\n\t/**\n\t * Render activation UI based on device type and status\n\t */\n\tconst renderActivationUI = () => {\n\t\t// FIDO2: Already activated during registration\n\t\tif (config.deviceType === 'FIDO2') {\n\t\t\treturn (\n\t\t\t\t<div className=\"activation-success\">\n\t\t\t\t\t<div className=\"success-icon\">‚úì</div>\n\t\t\t\t\t<h3>Security Key Registered</h3>\n\t\t\t\t\t<p>Your FIDO2 security key has been successfully registered and is ready to use.</p>\n\t\t\t\t</div>\n\t\t\t);\n\t\t}\n\n\t\t// Mobile: Show pairing status\n\t\tif (config.deviceType === 'MOBILE') {\n\t\t\treturn (\n\t\t\t\t<div className=\"mobile-pairing-status\">\n\t\t\t\t\t<h3>Pairing Your Mobile Device</h3>\n\t\t\t\t\t<p>\n\t\t\t\t\t\tPlease scan the QR code displayed in the previous step using the PingOne Mobile app to\n\t\t\t\t\t\tcomplete pairing.\n\t\t\t\t\t</p>\n\t\t\t\t\t<div className=\"pairing-status-indicator\">\n\t\t\t\t\t\t{mfaState.deviceStatus === 'ACTIVE' ? (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<div className=\"status-icon success\">‚úì</div>\n\t\t\t\t\t\t\t\t<p className=\"status-text\">Device paired successfully! Redirecting...</p>\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<div className=\"status-icon pending\">‚è≥</div>\n\t\t\t\t\t\t\t\t<p className=\"status-text\">Waiting for pairing...</p>\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t);\n\t\t}\n\n\t\t// SMS, Email, WhatsApp, TOTP: Use the unified OTP template\n\t\tif (config.requiresOTP) {\n\t\t\t// ========== DEBUG: TOTP ACTIVATION STATE ==========\n\t\t\tif (config.deviceType === 'TOTP') {\n\t\t\t\tconsole.log('üîç [TOTP DEBUG] Activation step rendering:', {\n\t\t\t\t\tqrCodeUrl: mfaState.qrCodeUrl,\n\t\t\t\t\ttotpSecret: mfaState.totpSecret,\n\t\t\t\t\tshowQr: mfaState.showQr,\n\t\t\t\t\tdeviceStatus: mfaState.deviceStatus,\n\t\t\t\t\thasQrData: !!(mfaState.qrCodeUrl || mfaState.totpSecret),\n\t\t\t\t\tfullMfaState: mfaState,\n\t\t\t\t});\n\t\t\t}\n\t\t\t// ================================================\n\n\t\t\treturn (\n\t\t\t\t<>\n\t\t\t\t\t{/* TOTP: Show QR code and secret before OTP input */}\n\t\t\t\t\t{config.deviceType === 'TOTP' && (mfaState.qrCodeUrl || mfaState.totpSecret) && (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclassName=\"totp-qr-section\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t\tpadding: '20px',\n\t\t\t\t\t\t\t\tbackground: '#f8f9fa',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tborder: '1px solid #dee2e6',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<h3 style={{ margin: '0 0 16px 0', fontSize: '18px', fontWeight: 600 }}>\n\t\t\t\t\t\t\t\tüì± Scan QR Code\n\t\t\t\t\t\t\t</h3>\n\n\t\t\t\t\t\t\t{mfaState.qrCodeUrl && (\n\t\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t{/* Render QR code from keyUri using QRCodeSVG */}\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'inline-block',\n\t\t\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\t\tborder: '2px solid #dee2e6',\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<QRCodeSVG\n\t\t\t\t\t\t\t\t\t\t\tvalue={mfaState.qrCodeUrl}\n\t\t\t\t\t\t\t\t\t\t\tsize={200}\n\t\t\t\t\t\t\t\t\t\t\tlevel=\"M\"\n\t\t\t\t\t\t\t\t\t\t\tincludeMargin={false}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: '12px 0 0 0', fontSize: '14px', color: '#6c757d' }}>\n\t\t\t\t\t\t\t\t\t\tScan this code with your authenticator app\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t\t{mfaState.totpSecret && (\n\t\t\t\t\t\t\t\t<details style={{ marginTop: '16px' }}>\n\t\t\t\t\t\t\t\t\t<summary style={{ cursor: 'pointer', fontWeight: 500, color: '#495057' }}>\n\t\t\t\t\t\t\t\t\t\tCan't scan? Enter manually\n\t\t\t\t\t\t\t\t\t</summary>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\tborder: '1px solid #dee2e6',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<code\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#212529',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{mfaState.totpSecret}\n\t\t\t\t\t\t\t\t\t\t</code>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(mfaState.totpSecret || '');\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('Secret copied to clipboard');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmarginTop: '8px',\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#007bff',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüìã Copy Secret\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</details>\n\t\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmargin: '16px 0 0 0',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#6c757d',\n\t\t\t\t\t\t\t\t\tfontStyle: 'italic',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t‚úì Supported: Google Authenticator, Microsoft Authenticator, Authy, 1Password, etc.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* For Admin Flow with OTP devices, show skip button instead of OTP input */}\n\t\t\t\t\t{config.requiresOTP &&\n\t\t\t\t\tcredentials.tokenType === 'worker' &&\n\t\t\t\t\tcredentials.deviceStatus === 'ACTIVE' ? (\n\t\t\t\t\t\t<div style={{ marginTop: '24px', textAlign: 'center' }}>\n\t\t\t\t\t\t\t<p style={{ marginBottom: '16px', fontSize: '14px', color: '#6c757d' }}>\n\t\t\t\t\t\t\t\t‚úì Your {config.displayName} device is registered and ready to use immediately.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tsetMfaState((prev) => ({ ...prev, deviceStatus: 'ACTIVE' }));\n\t\t\t\t\t\t\t\t\tnav.markStepComplete();\n\t\t\t\t\t\t\t\t\tnav.goToNext();\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '12px 24px',\n\t\t\t\t\t\t\t\t\tbackground: '#10b981',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\t\tfontWeight: 600,\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tContinue to Success ‚Üí\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : config.requiresOTP &&\n\t\t\t\t\t\t!(credentials.tokenType === 'worker' && credentials.deviceStatus === 'ACTIVE') ? (\n\t\t\t\t\t\t<UnifiedOTPActivationTemplate\n\t\t\t\t\t\t\tdeviceType={config.deviceType}\n\t\t\t\t\t\t\tdeviceDisplayName={config.displayName}\n\t\t\t\t\t\t\tinstructions={\n\t\t\t\t\t\t\t\tconfig.deviceType === 'TOTP'\n\t\t\t\t\t\t\t\t\t? 'Enter the current 6-digit code from your authenticator app'\n\t\t\t\t\t\t\t\t\t: `Enter the 6-digit code sent to your ${config.displayName.toLowerCase()}`\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tcontextText={\n\t\t\t\t\t\t\t\tconfig.deviceType === 'TOTP'\n\t\t\t\t\t\t\t\t\t? 'Codes refresh every 30 seconds. Wait for a new code if time is running out.'\n\t\t\t\t\t\t\t\t\t: config.deviceType === 'SMS'\n\t\t\t\t\t\t\t\t\t\t? \"Codes expire after 10 minutes. Check your signal if you don't receive the code.\"\n\t\t\t\t\t\t\t\t\t\t: config.deviceType === 'EMAIL'\n\t\t\t\t\t\t\t\t\t\t\t? \"Check your spam folder if you don't see the email in your inbox.\"\n\t\t\t\t\t\t\t\t\t\t\t: config.deviceType === 'WHATSAPP'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'Make sure WhatsApp is installed and you have internet connectivity.'\n\t\t\t\t\t\t\t\t\t\t\t\t: 'Listen carefully and have a pen ready. The code will be read twice.'\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tonValidateOtp={async (_otpCode) => {\n\t\t\t\t\t\t\t\tawait handleValidateOtp();\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonResendOtp={async () => {\n\t\t\t\t\t\t\t\t// For TOTP, the \"resend\" action should show the QR code again (navigate to registration/QR step)\n\t\t\t\t\t\t\t\tif (config.deviceType === 'TOTP') {\n\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\tnav.goToStep(0); // Show registration step where QR is displayed\n\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\t\t\t\t\tconsole.error('[UNIFIED-ACTIVATION] Failed to navigate to QR step:', err);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tawait handleResendOtp();\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tisLoading={isLoading}\n\t\t\t\t\t\t\totpError={otpError}\n\t\t\t\t\t\t\tcanResend={canResend}\n\t\t\t\t\t\t\tresendCooldown={resendCooldown}\n\t\t\t\t\t\t\totp={otp}\n\t\t\t\t\t\t\tonOtpChange={handleOtpChange}\n\t\t\t\t\t\t\tvalidationAttempts={validationAttempts}\n\t\t\t\t\t\t\tmaxAttempts={3}\n\t\t\t\t\t\t/>\n\t\t\t\t\t) : null}\n\t\t\t\t</>\n\t\t\t);\n\t\t}\n\n\t\t// Default: Device is already active\n\t\treturn (\n\t\t\t<div className=\"activation-success\">\n\t\t\t\t<div className=\"success-icon\">‚úì</div>\n\t\t\t\t<h3>Device Activated</h3>\n\t\t\t\t<p>Your {config.displayName} device is already active and ready to use.</p>\n\t\t\t</div>\n\t\t);\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-activation-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Activate {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">Complete the activation process.</p>\n\t\t\t</div>\n\n\t\t\t{/* Activation UI */}\n\t\t\t<div className=\"activation-ui\">{renderActivationUI()}</div>\n\n\t\t\t{/* Action Buttons */}\n\t\t\t<div\n\t\t\t\tclassName=\"step-actions\"\n\t\t\t\tstyle={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}\n\t\t\t>\n\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => nav.goToPrevious()}\n\t\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t\t\tclassName=\"button-secondary\"\n\t\t\t\t\t>\n\t\t\t\t\t\t‚Üê Previous\n\t\t\t\t\t</button>\n\n\t\t\t\t\t{config.requiresOTP && otp.length === 6 && (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleValidateOtp}\n\t\t\t\t\t\t\tdisabled={isLoading || !tokenStatus.isValid}\n\t\t\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{isLoading ? 'Validating...' : 'Verify Code'}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{!config.requiresOTP && mfaState.deviceStatus === 'ACTIVE' && (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => nav.goToNext()}\n\t\t\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tContinue ‚Üí\n\t\t\t\t\t\t</button>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => nav.goToStep(0)}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\tbackground: '#6b7280',\n\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\tcursor: isLoading ? 'not-allowed' : 'pointer',\n\t\t\t\t\t\topacity: isLoading ? 0.5 : 1,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\tüîÑ Restart Flow\n\t\t\t\t</button>\n\t\t\t</div>\n\n\t\t\t{/* Token Status Warning */}\n\t\t\t{!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\nexport default UnifiedActivationStep;\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedConfigurationStep.modern.tsx"},"span":[5339,5342],"sourceCode":"/**\n * @file UnifiedConfigurationStep.modern.tsx\n * @module v8/flows/unified/components\n * @description MODERNIZED Step 0: Configuration - Uses global services, no redundant inputs\n * @version 9.2.0\n * @since 2026-01-29\n *\n * Key Changes:\n * - Uses GlobalMFAContext (no redundant Environment ID/Worker Token inputs)\n * - Modern UI with design system components\n * - All buttons functional with proper states\n * - Simplified configuration flow\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport { FiAlertCircle, FiArrowRight, FiCheck } from 'react-icons/fi';\nimport { Button } from '@/v8/components/Button';\nimport { FormInput } from '@/v8/components/FormInput';\nimport { LoadingSpinner } from '@/v8/components/LoadingSpinner';\nimport { PageTransition } from '@/v8/components/PageTransition';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport { useGlobalMFA } from '@/v8/contexts/GlobalMFAContext';\nimport { borderRadius, colors, spacing, typography } from '@/v8/design/tokens';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { useFormValidation } from '@/v8/hooks/useFormValidation';\nimport { MFAServiceV8 } from '@/v8/services/mfaServiceV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[‚öôÔ∏è UNIFIED-CONFIG-MODERN]';\n\nexport interface UnifiedConfigurationStepProps extends MFAFlowBaseRenderProps {\n\tconfig: DeviceFlowConfig;\n\tdeviceType: string;\n\tregistrationFlowType?: 'admin' | 'user';\n}\n\nexport const UnifiedConfigurationStepModern: React.FC<UnifiedConfigurationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tnav,\n\tconfig,\n\tdeviceType,\n\tregistrationFlowType = 'admin',\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering for:`, deviceType, 'Flow type:', registrationFlowType);\n\n\t// Global MFA state\n\tconst {\n\t\tenvironmentId,\n\t\tworkerTokenStatus,\n\t\tisConfigured,\n\t\tisLoading: globalLoading,\n\t} = useGlobalMFA();\n\n\t// Debug logging\n\tconsole.log(`${MODULE_TAG} Global state:`, {\n\t\tenvironmentId,\n\t\tworkerTokenStatus,\n\t\tisConfigured,\n\t\tglobalLoading,\n\t});\n\n\t// Form validation - initialize with credentials.username\n\tconst { values, errors, touched, handleChange, handleBlur, validateAll, setValues } =\n\t\tuseFormValidation(\n\t\t\t{\n\t\t\t\tusername: credentials.username || '',\n\t\t\t\tflowType: registrationFlowType === 'user' ? 'user' : 'admin-activation',\n\t\t\t},\n\t\t\t{\n\t\t\t\tusername: {\n\t\t\t\t\trequired: true,\n\t\t\t\t\tminLength: 3,\n\t\t\t\t},\n\t\t\t}\n\t\t);\n\n\tconst [isSubmitting, setIsSubmitting] = useState(false);\n\tconst [selectedFlowType, setSelectedFlowType] = useState<\n\t\t'admin-active' | 'admin-activation' | 'user'\n\t>(registrationFlowType === 'user' ? 'user' : 'admin-activation');\n\n\t// Update form when credentials change\n\tuseEffect(() => {\n\t\tif (credentials.username && values.username !== credentials.username) {\n\t\t\tsetValues({ username: credentials.username });\n\t\t}\n\t}, [credentials.username, values.username, setValues]);\n\n\t// Auto-populate credentials from global state\n\tuseEffect(() => {\n\t\tif (environmentId && !credentials.environmentId) {\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tenvironmentId,\n\t\t\t}));\n\t\t}\n\t}, [environmentId, credentials.environmentId, setCredentials]);\n\n\t// Handle continue\n\tconst handleContinue = useCallback(async () => {\n\t\tconsole.log(\n\t\t\t`${MODULE_TAG} Continuing for device type:`,\n\t\t\tdeviceType,\n\t\t\t'Flow type:',\n\t\t\tselectedFlowType\n\t\t);\n\n\t\t// Validate form\n\t\tif (!validateAll()) {\n\t\t\ttoastV8.error('Please fix the validation errors');\n\t\t\treturn;\n\t\t}\n\n\t\t// Check global configuration\n\t\tif (!isConfigured) {\n\t\t\ttoastV8.error('Please configure Environment ID and Worker Token first');\n\t\t\tnav.setValidationErrors(['Global configuration incomplete']);\n\t\t\treturn;\n\t\t}\n\n\t\tsetIsSubmitting(true);\n\n\t\ttry {\n\t\t\t// Update credentials\n\t\t\tconst updatedCredentials = {\n\t\t\t\t...credentials,\n\t\t\t\tenvironmentId: environmentId!,\n\t\t\t\tusername: values.username.trim(),\n\t\t\t\ttokenType: 'worker' as const,\n\t\t\t\tdeviceType,\n\t\t\t};\n\n\t\t\tsetCredentials(updatedCredentials);\n\n\t\t\t/**\n\t\t\t * CRITICAL: MFA OTP and TOTP devices MUST always register directly\n\t\t\t *\n\t\t\t * Flow Types:\n\t\t\t * 1. Admin Active (admin-active): Register ‚Üí Skip activation ‚Üí Success\n\t\t\t * 2. Admin Activation Required (admin-activation): Register ‚Üí OTP activation ‚Üí Success\n\t\t\t * 3. User Flow (user): Register ‚Üí PingOne login ‚Üí OTP activation ‚Üí Success\n\t\t\t *\n\t\t\t * NEVER skip activation for ACTIVATION_REQUIRED or user flow!\n\t\t\t */\n\t\t\tconst DIRECT_REGISTRATION_DEVICES = ['EMAIL', 'SMS', 'WHATSAPP', 'TOTP'];\n\n\t\t\tif (DIRECT_REGISTRATION_DEVICES.includes(deviceType)) {\n\t\t\t\tconsole.log(\n\t\t\t\t\t`${MODULE_TAG} Registering ${deviceType} device directly with flow type: ${selectedFlowType}`\n\t\t\t\t);\n\n\t\t\t\t// Map device type to field name\n\t\t\t\tconst fieldMap: Record<string, string> = {\n\t\t\t\t\tEMAIL: 'email',\n\t\t\t\t\tSMS: 'phone',\n\t\t\t\t\tWHATSAPP: 'phone',\n\t\t\t\t\tTOTP: 'deviceName', // TOTP doesn't need contact field\n\t\t\t\t};\n\n\t\t\t\tconst fieldName = fieldMap[deviceType];\n\t\t\t\tconst fieldValue = deviceType === 'TOTP' ? deviceType : values.username.trim();\n\n\t\t\t\t// Determine device status based on flow type\n\t\t\t\t// CRITICAL: Only admin-active flow creates ACTIVE devices\n\t\t\t\tconst deviceStatus = selectedFlowType === 'admin-active' ? 'ACTIVE' : 'ACTIVATION_REQUIRED';\n\n\t\t\t\t// Prepare registration parameters\n\t\t\t\tconst registrationParams: Record<string, any> = {\n\t\t\t\t\tenvironmentId: environmentId!,\n\t\t\t\t\tusername: values.username.trim(),\n\t\t\t\t\tdeviceType,\n\t\t\t\t\t[fieldName]: fieldValue,\n\t\t\t\t\tdeviceName: deviceType,\n\t\t\t\t\tnickname: 'MyKnickName',\n\t\t\t\t\ttokenType: 'worker' as const,\n\t\t\t\t\t// Only admin flows set status, user flow doesn't include it\n\t\t\t\t\t...(selectedFlowType !== 'user' && { status: deviceStatus }),\n\t\t\t\t};\n\n\t\t\t\tconsole.log(`${MODULE_TAG} Registration params:`, registrationParams);\n\n\t\t\t\t// Call MFA Service to register device\n\t\t\t\tconst result = await MFAServiceV8.registerDevice(registrationParams);\n\t\t\t\tconsole.log(`${MODULE_TAG} Device registered with status:`, result.status);\n\n\t\t\t\t// CRITICAL VALIDATION: Ensure activation flow is followed correctly\n\t\t\t\tif (result.status === 'ACTIVATION_REQUIRED' && selectedFlowType === 'admin-active') {\n\t\t\t\t\tconsole.error(`${MODULE_TAG} ERROR: Expected ACTIVE but got ACTIVATION_REQUIRED`);\n\t\t\t\t\tthrow new Error('Device registration flow mismatch - expected ACTIVE device');\n\t\t\t\t}\n\n\t\t\t\t// Update credentials with device info\n\t\t\t\tsetCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\tdeviceStatus: result.status,\n\t\t\t\t}));\n\n\t\t\t\t// Mark step complete\n\t\t\t\tnav.markStepComplete();\n\n\t\t\t\t/**\n\t\t\t\t * ROUTING LOGIC - CRITICAL:\n\t\t\t\t * - ACTIVE devices: Skip activation ‚Üí Go to success (Step 2)\n\t\t\t\t * - ACTIVATION_REQUIRED: MUST go to activation step (Step 1) for OTP entry\n\t\t\t\t * - User flow: MUST go to activation (Step 1) even if device shows as ACTIVE\n\t\t\t\t */\n\t\t\t\tif (result.status === 'ACTIVE' && selectedFlowType === 'admin-active') {\n\t\t\t\t\tconsole.log(`${MODULE_TAG} Admin Active flow: Skipping activation, going to success`);\n\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t`${config.displayName} device registered successfully! Device is ready to use.`\n\t\t\t\t\t);\n\t\t\t\t\tnav.goToStep(2); // Skip activation, go to success\n\t\t\t\t} else {\n\t\t\t\t\t// ACTIVATION_REQUIRED or User Flow - MUST go through activation\n\t\t\t\t\tconsole.log(`${MODULE_TAG} Activation required: Going to activation step`);\n\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t`${config.displayName} device registered! ${result.status === 'ACTIVATION_REQUIRED' ? 'OTP has been sent automatically.' : 'Please complete activation.'}`\n\t\t\t\t\t);\n\t\t\t\t\tnav.goToNext(); // Go to activation step\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// For FIDO2, MOBILE - go to device selection/registration form\n\t\t\t\tconsole.log(`${MODULE_TAG} Navigating to device selection for ${deviceType}`);\n\n\t\t\t\t// Mark step complete\n\t\t\t\tnav.markStepComplete();\n\n\t\t\t\t// Navigate to next step (device selection/registration form)\n\t\t\t\tnav.goToNext();\n\n\t\t\t\ttoastV8.success('Configuration saved');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} Error:`, error);\n\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Failed to process request';\n\t\t\ttoastV8.error(errorMessage);\n\t\t\tnav.setValidationErrors([errorMessage]);\n\t\t} finally {\n\t\t\tsetIsSubmitting(false);\n\t\t}\n\t}, [\n\t\tvalidateAll,\n\t\tisConfigured,\n\t\tenvironmentId,\n\t\tvalues,\n\t\tdeviceType,\n\t\tselectedFlowType,\n\t\tcredentials,\n\t\tsetCredentials,\n\t\tnav,\n\t\tconfig,\n\t]);\n\n\t// Loading state\n\tif (globalLoading) {\n\t\treturn (\n\t\t\t<div style={{ padding: spacing['3xl'], textAlign: 'center' }}>\n\t\t\t\t<LoadingSpinner size=\"large\" text=\"Loading global configuration...\" />\n\t\t\t</div>\n\t\t);\n\t}\n\n\t// Not configured - show prompt\n\tif (!isConfigured) {\n\t\treturn (\n\t\t\t<PageTransition>\n\t\t\t\t<div style={{ maxWidth: '600px', margin: '0 auto', padding: spacing.xl }}>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: colors.warning[50],\n\t\t\t\t\t\t\tborder: `2px solid ${colors.warning[500]}`,\n\t\t\t\t\t\t\tborderRadius: borderRadius.lg,\n\t\t\t\t\t\t\tpadding: spacing.xl,\n\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<FiAlertCircle\n\t\t\t\t\t\t\tsize={48}\n\t\t\t\t\t\t\tcolor={colors.warning[500]}\n\t\t\t\t\t\t\tstyle={{ marginBottom: spacing.md }}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<h2 style={{ margin: `0 0 ${spacing.md} 0`, color: colors.warning[900] }}>\n\t\t\t\t\t\t\tGlobal Configuration Required\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: `0 0 ${spacing.lg} 0`, color: colors.warning[700] }}>\n\t\t\t\t\t\t\tPlease configure your Environment ID and Worker Token before proceeding.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t\t\tsize=\"lg\"\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t// Navigate to settings or show configuration modal\n\t\t\t\t\t\t\t\ttoastV8.info('Please configure global settings in the admin panel');\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfigure Settings\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</PageTransition>\n\t\t);\n\t}\n\n\t// Configured - show simplified form\n\treturn (\n\t\t<PageTransition>\n\t\t\t<div style={{ maxWidth: '800px', margin: '0 auto', padding: spacing.xl }}>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: `linear-gradient(135deg, ${colors.primary[500]} 0%, ${colors.primary[700]} 100%)`,\n\t\t\t\t\t\tborderRadius: borderRadius.xl,\n\t\t\t\t\t\tpadding: spacing.xl,\n\t\t\t\t\t\tmarginBottom: spacing.xl,\n\t\t\t\t\t\tboxShadow: `0 4px 12px ${colors.primary[500]}33`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<h2\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tmargin: `0 0 ${spacing.sm} 0`,\n\t\t\t\t\t\t\tfontSize: typography.fontSize['3xl'],\n\t\t\t\t\t\t\tfontWeight: typography.fontWeight.bold,\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tgap: spacing.md,\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{config.icon} Configure {config.displayName}\n\t\t\t\t\t</h2>\n\t\t\t\t\t<p style={{ margin: 0, color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\tEnter user details to begin registration\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Global Config Status */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: colors.success[50],\n\t\t\t\t\t\tborder: `1px solid ${colors.success[500]}`,\n\t\t\t\t\t\tborderRadius: borderRadius.lg,\n\t\t\t\t\t\tpadding: spacing.lg,\n\t\t\t\t\t\tmarginBottom: spacing.xl,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'center', gap: spacing.md }}>\n\t\t\t\t\t\t<FiCheck size={24} color={colors.success[500]} />\n\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t<h3 style={{ margin: `0 0 ${spacing.xs} 0`, color: colors.success[900] }}>\n\t\t\t\t\t\t\t\tGlobal Configuration Active\n\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\tstyle={{ margin: 0, fontSize: typography.fontSize.sm, color: colors.success[700] }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tEnvironment ID: <strong>{environmentId}</strong>\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\tWorker Token: <strong>{workerTokenStatus?.tokenValid ? 'Valid' : 'Invalid'}</strong>\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* User Configuration Form */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\tborderRadius: borderRadius.xl,\n\t\t\t\t\t\tpadding: spacing.xl,\n\t\t\t\t\t\tboxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',\n\t\t\t\t\t\tborder: `1px solid ${colors.neutral[200]}`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<h3 style={{ margin: `0 0 ${spacing.lg} 0`, color: colors.neutral[900] }}>\n\t\t\t\t\t\tUser Details\n\t\t\t\t\t</h3>\n\n\t\t\t\t\t<FormInput\n\t\t\t\t\t\tlabel=\"Username\"\n\t\t\t\t\t\tname=\"username\"\n\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\tvalue={values.username}\n\t\t\t\t\t\terror={errors.username}\n\t\t\t\t\t\ttouched={touched.username}\n\t\t\t\t\t\tonChange={handleChange}\n\t\t\t\t\t\tonBlur={handleBlur}\n\t\t\t\t\t\trequired\n\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\thelpText=\"The user who will register this MFA device\"\n\t\t\t\t\t/>\n\n\t\t\t\t\t{/* Flow Type Selection */}\n\t\t\t\t\t<div style={{ marginTop: spacing.lg }}>\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\tmarginBottom: spacing.sm,\n\t\t\t\t\t\t\t\tfontWeight: typography.fontWeight.semibold,\n\t\t\t\t\t\t\t\tcolor: colors.neutral[700],\n\t\t\t\t\t\t\t\tfontSize: typography.fontSize.sm,\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tRegistration Flow Type\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<div style={{ display: 'flex', flexDirection: 'column', gap: spacing.sm }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tpadding: spacing.md,\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${selectedFlowType === 'admin-active' ? colors.primary[500] : colors.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: borderRadius.md,\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\tbackground: selectedFlowType === 'admin-active' ? colors.primary[50] : 'white',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\tvalue=\"admin-active\"\n\t\t\t\t\t\t\t\t\tchecked={selectedFlowType === 'admin-active'}\n\t\t\t\t\t\t\t\t\tonChange={() => setSelectedFlowType('admin-active')}\n\t\t\t\t\t\t\t\t\tstyle={{ marginRight: spacing.sm }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<strong>Admin - Active</strong>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: typography.fontSize.sm, color: colors.neutral[600] }}>\n\t\t\t\t\t\t\t\t\t\tDevice ready immediately (no activation required)\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tpadding: spacing.md,\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${selectedFlowType === 'admin-activation' ? colors.primary[500] : colors.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: borderRadius.md,\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\tselectedFlowType === 'admin-activation' ? colors.primary[50] : 'white',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\tvalue=\"admin-activation\"\n\t\t\t\t\t\t\t\t\tchecked={selectedFlowType === 'admin-activation'}\n\t\t\t\t\t\t\t\t\tonChange={() => setSelectedFlowType('admin-activation')}\n\t\t\t\t\t\t\t\t\tstyle={{ marginRight: spacing.sm }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<strong>Admin - Activation Required</strong>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: typography.fontSize.sm, color: colors.neutral[600] }}>\n\t\t\t\t\t\t\t\t\t\tRequires OTP activation after registration\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tpadding: spacing.md,\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${selectedFlowType === 'user' ? colors.primary[500] : colors.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: borderRadius.md,\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\tbackground: selectedFlowType === 'user' ? colors.primary[50] : 'white',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\tvalue=\"user\"\n\t\t\t\t\t\t\t\t\tchecked={selectedFlowType === 'user'}\n\t\t\t\t\t\t\t\t\tonChange={() => setSelectedFlowType('user')}\n\t\t\t\t\t\t\t\t\tstyle={{ marginRight: spacing.sm }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<strong>User Flow</strong>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: typography.fontSize.sm, color: colors.neutral[600] }}>\n\t\t\t\t\t\t\t\t\t\tRequires PingOne login + OTP activation\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Action Buttons */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tjustifyContent: 'flex-end',\n\t\t\t\t\t\tgap: spacing.md,\n\t\t\t\t\t\tmarginTop: spacing.xl,\n\t\t\t\t\t\tpaddingTop: spacing.lg,\n\t\t\t\t\t\tborderTop: `1px solid ${colors.neutral[200]}`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<Button\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t\tsize=\"lg\"\n\t\t\t\t\t\tonClick={handleContinue}\n\t\t\t\t\t\tloading={isSubmitting}\n\t\t\t\t\t\tdisabled={isSubmitting || !values.username.trim()}\n\t\t\t\t\t\trightIcon={<FiArrowRight />}\n\t\t\t\t\t\tfullWidth\n\t\t\t\t\t>\n\t\t\t\t\t\t{['EMAIL', 'SMS', 'WHATSAPP', 'TOTP'].includes(deviceType)\n\t\t\t\t\t\t\t? `Register ${config.displayName} ‚Üí`\n\t\t\t\t\t\t\t: 'Continue to Device Selection ‚Üí'}\n\t\t\t\t\t</Button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</PageTransition>\n\t);\n};\n\nexport default UnifiedConfigurationStepModern;\n"},"tags":[],"source":null},{"category":"lint/correctness/noUnusedFunctionParameters","severity":"warning","description":"This parameter is unused.","message":[{"elements":[],"content":"This "},{"elements":["Emphasis"],"content":"parameter"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused parameters might be the result of an incomplete refactoring."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedConfigurationStep.tsx"},"span":[2222,2242],"sourceCode":"/**\n * @file UnifiedConfigurationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 0: Configuration - Environment and credential setup\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Configure environment, credentials, and token type before device registration\n *\n * Flow:\n * 1. Enter environment ID, username\n * 2. Select token type (Worker or User)\n * 3. Select device authentication policy (optional)\n * 4. Validate configuration\n * 5. Navigate to device selection step\n *\n * @example\n * <UnifiedConfigurationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   registrationFlowType=\"admin\"\n * />\n */\n\nimport React, { useCallback, useEffect, useRef, useState } from 'react';\nimport { MFAInfoButtonV8 } from '@/v8/components/MFAInfoButtonV8';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport type { TokenType } from '@/v8/flows/shared/MFATypes';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[‚öôÔ∏è UNIFIED-CONFIGURATION-STEP]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedConfigurationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Registration flow type (admin uses worker token, user uses user token) */\n\tregistrationFlowType?: 'admin' | 'user';\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Configuration Step (Step 0)\n *\n * Handles environment and credential configuration for unified MFA flow.\n */\nexport const UnifiedConfigurationStep: React.FC<UnifiedConfigurationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\ttokenStatus,\n\tdeviceAuthPolicies,\n\tisLoadingPolicies,\n\tpoliciesError,\n\trefreshDeviceAuthPolicies,\n\tshowWorkerTokenModal,\n\tsetShowWorkerTokenModal,\n\tshowUserLoginModal,\n\tsetShowUserLoginModal,\n\tshowSettingsModal,\n\tsetShowSettingsModal,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tregistrationFlowType = 'admin',\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering configuration step for:`, config.deviceType);\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\t// Load saved username from localStorage\n\tconst getSavedUsername = () => {\n\t\ttry {\n\t\t\treturn localStorage.getItem('mfa_unified_username') || credentials.username || '';\n\t\t} catch {\n\t\t\treturn credentials.username || '';\n\t\t}\n\t};\n\n\tconst [environmentId, setEnvironmentId] = useState(credentials.environmentId || '');\n\tconst [username, setUsername] = useState(getSavedUsername);\n\n\t// Registration flow type: 'admin-active', 'admin-activation', or 'user'\n\tconst [flowType, setFlowType] = useState<'admin-active' | 'admin-activation' | 'user'>(\n\t\tregistrationFlowType === 'user' ? 'user' : 'admin-active'\n\t);\n\n\t// Derived token type from flow type\n\tconst tokenType: TokenType = flowType === 'user' ? 'user' : 'worker';\n\n\t// Device status for admin flows\n\tconst adminDeviceStatus = flowType === 'admin-active' ? 'ACTIVE' : 'ACTIVATION_REQUIRED';\n\n\tconst [selectedPolicyId, setSelectedPolicyId] = useState(\n\t\tcredentials.deviceAuthenticationPolicyId || ''\n\t);\n\n\t// Validation errors\n\tconst [errors, setErrors] = useState<Record<string, string>>({});\n\n\t// ========================================================================\n\t// EFFECTS\n\t// ========================================================================\n\n\t/**\n\t * Auto-populate environment ID from worker token if available\n\t */\n\tuseEffect(() => {\n\t\tif (!environmentId && tokenStatus.isValid) {\n\t\t\tconst workerCreds = workerTokenServiceV8.loadCredentialsSync();\n\t\t\tif (workerCreds?.environmentId) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Auto-populating environment ID:`, workerCreds.environmentId);\n\t\t\t\tsetEnvironmentId(workerCreds.environmentId);\n\t\t\t\tsetCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tenvironmentId: workerCreds.environmentId,\n\t\t\t\t\tregion: workerCreds.region || prev.region || 'us',\n\t\t\t\t\tcustomDomain: workerCreds.customDomain || prev.customDomain,\n\t\t\t\t}));\n\t\t\t}\n\t\t}\n\t}, [tokenStatus.isValid, environmentId, setCredentials]);\n\n\t/**\n\t * Save username to localStorage when it changes\n\t */\n\tuseEffect(() => {\n\t\tif (username.trim()) {\n\t\t\ttry {\n\t\t\t\tlocalStorage.setItem('mfa_unified_username', username.trim());\n\t\t\t\tconsole.log(`${MODULE_TAG} Saved username to localStorage`);\n\t\t\t} catch {\n\t\t\t\t// Ignore localStorage errors\n\t\t\t}\n\t\t}\n\t}, [username]);\n\n\t/**\n\t * Auto-select first device authentication policy when loaded\n\t */\n\tuseEffect(() => {\n\t\tif (deviceAuthPolicies.length > 0 && !selectedPolicyId) {\n\t\t\tconst firstPolicy = deviceAuthPolicies[0];\n\t\t\tconsole.log(`${MODULE_TAG} Auto-selecting first policy:`, firstPolicy.name);\n\t\t\tsetSelectedPolicyId(firstPolicy.id);\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceAuthenticationPolicyId: firstPolicy.id,\n\t\t\t}));\n\t\t}\n\t}, [deviceAuthPolicies, selectedPolicyId, setCredentials]);\n\n\t/**\n\t * Sync flow type when registration flow type prop changes\n\t */\n\tuseEffect(() => {\n\t\tif (registrationFlowType === 'user' && flowType !== 'user') {\n\t\t\tconsole.log(`${MODULE_TAG} User registration flow - switching to user flow type`);\n\t\t\tsetFlowType('user');\n\t\t}\n\t}, [registrationFlowType, flowType]);\n\n\t/**\n\t * Track if we've already auto-advanced to prevent loops\n\t */\n\tconst hasAutoAdvanced = useRef(false);\n\n\t/**\n\t * Auto-advance after successful OAuth login for User Flow\n\t * When user returns from OAuth with a token, automatically proceed to next step\n\t */\n\tuseEffect(() => {\n\t\t// Only auto-advance for user flow when we have a user token\n\t\tif (\n\t\t\tflowType === 'user' &&\n\t\t\tcredentials.userToken &&\n\t\t\tenvironmentId.trim() &&\n\t\t\tusername.trim() &&\n\t\t\t!hasAutoAdvanced.current\n\t\t) {\n\t\t\tconsole.log(`${MODULE_TAG} Auto-advancing after OAuth login`);\n\t\t\thasAutoAdvanced.current = true;\n\n\t\t\t// Update credentials with final values\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tenvironmentId: environmentId.trim(),\n\t\t\t\tusername: username.trim(),\n\t\t\t\ttokenType: 'user',\n\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicyId,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t}));\n\n\t\t\t// Small delay to ensure state updates propagate\n\t\t\tsetTimeout(() => {\n\t\t\t\ttoastV8.success('Authentication successful! Proceeding to next step...');\n\t\t\t\tnav.markStepComplete();\n\t\t\t\tnav.goToNext();\n\t\t\t}, 300);\n\t\t}\n\t}, [\n\t\tcredentials.userToken,\n\t\tflowType,\n\t\tenvironmentId,\n\t\tusername,\n\t\tselectedPolicyId,\n\t\tconfig.deviceType,\n\t\tsetCredentials,\n\t\tnav,\n\t]);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Validate configuration fields\n\t */\n\tconst validateConfiguration = useCallback((): boolean => {\n\t\tconst newErrors: Record<string, string> = {};\n\n\t\t// Validate environment ID\n\t\tif (!environmentId.trim()) {\n\t\t\tnewErrors.environmentId = 'Environment ID is required';\n\t\t}\n\n\t\t// Validate username\n\t\tif (!username.trim()) {\n\t\t\tnewErrors.username = 'Username is required';\n\t\t}\n\n\t\t// Validate token based on token type\n\t\tif (tokenType === 'worker') {\n\t\t\tif (!tokenStatus.isValid) {\n\t\t\t\tnewErrors.token = 'Valid worker token is required';\n\t\t\t}\n\t\t} else if (tokenType === 'user') {\n\t\t\tif (!credentials.userToken) {\n\t\t\t\tnewErrors.token = 'User token is required. Please log in.';\n\t\t\t}\n\t\t}\n\n\t\tsetErrors(newErrors);\n\n\t\tif (Object.keys(newErrors).length > 0) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed:`, newErrors);\n\t\t\tnav.setValidationErrors(Object.values(newErrors));\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}, [environmentId, username, tokenType, tokenStatus, credentials, nav]);\n\n\t/**\n\t * Handle continue button click\n\t */\n\tconst handleContinue = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} Continuing to device selection`);\n\n\t\t// Validate configuration\n\t\tif (!validateConfiguration()) {\n\t\t\ttoastV8.error('Please fix the configuration errors');\n\t\t\treturn;\n\t\t}\n\n\t\t// Update credentials with final values\n\t\tsetCredentials((prev) => ({\n\t\t\t...prev,\n\t\t\tenvironmentId: environmentId.trim(),\n\t\t\tusername: username.trim(),\n\t\t\ttokenType,\n\t\t\tdeviceAuthenticationPolicyId: selectedPolicyId,\n\t\t\tdeviceType: config.deviceType,\n\t\t\t// Store device status for admin flows (ACTIVE or ACTIVATION_REQUIRED)\n\t\t\tdeviceStatus: flowType !== 'user' ? adminDeviceStatus : undefined,\n\t\t}));\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to next step (device selection)\n\t\tnav.goToNext();\n\t}, [\n\t\tenvironmentId,\n\t\tusername,\n\t\ttokenType,\n\t\tselectedPolicyId,\n\t\tconfig,\n\t\tvalidateConfiguration,\n\t\tsetCredentials,\n\t\tnav,\n\t\tadminDeviceStatus,\n\t\tflowType,\n\t]);\n\n\t/**\n\t * Handle environment ID change\n\t */\n\tconst handleEnvironmentIdChange = useCallback((value: string) => {\n\t\tsetEnvironmentId(value);\n\t\tsetErrors((prev) => {\n\t\t\tconst { environmentId, ...rest } = prev;\n\t\t\treturn rest;\n\t\t});\n\t}, []);\n\n\t/**\n\t * Handle username change\n\t */\n\tconst handleUsernameChange = useCallback((value: string) => {\n\t\tsetUsername(value);\n\t\tsetErrors((prev) => {\n\t\t\tconst { username, ...rest } = prev;\n\t\t\treturn rest;\n\t\t});\n\t}, []);\n\n\t/**\n\t * Handle flow type change\n\t */\n\tconst handleFlowTypeChange = useCallback(\n\t\t(type: 'admin-active' | 'admin-activation' | 'user') => {\n\t\t\tconsole.log(`${MODULE_TAG} Flow type changed to:`, type);\n\t\t\tsetFlowType(type);\n\t\t\tsetErrors((prev) => {\n\t\t\t\tconst { token, ...rest } = prev;\n\t\t\t\treturn rest;\n\t\t\t});\n\n\t\t\t// Open user login modal when user flow is selected\n\t\t\tif (type === 'user' && !credentials.userToken) {\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t}\n\t\t},\n\t\t[credentials.userToken, setShowUserLoginModal]\n\t);\n\n\t/**\n\t * Handle policy selection change\n\t */\n\tconst handlePolicyChange = useCallback(\n\t\t(policyId: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Policy changed to:`, policyId);\n\t\t\tsetSelectedPolicyId(policyId);\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t}));\n\t\t},\n\t\t[setCredentials]\n\t);\n\n\t// ========================================================================\n\t// COMPUTED PROPERTIES\n\t// ========================================================================\n\n\tconst selectedPolicy = deviceAuthPolicies.find((p) => p.id === selectedPolicyId);\n\tconst canProceed =\n\t\tenvironmentId.trim() &&\n\t\tusername.trim() &&\n\t\t(tokenType === 'worker' ? tokenStatus.isValid : !!credentials.userToken);\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div\n\t\t\tclassName=\"unified-configuration-step\"\n\t\t\tstyle={{\n\t\t\t\tmaxWidth: '900px',\n\t\t\t\tmargin: '0 auto',\n\t\t\t\tpadding: '24px',\n\t\t\t}}\n\t\t>\n\t\t\t{/* Step Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\tboxShadow: '0 4px 12px rgba(139, 92, 246, 0.2)',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<h2\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\tfontSize: '26px',\n\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\tcolor: '#ffffff',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '12px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{config.icon} Configure {config.displayName} Registration\n\t\t\t\t</h2>\n\t\t\t\t<p\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\tEnter your environment and user credentials to begin the registration process.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Configuration Form */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px',\n\t\t\t\t\tboxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',\n\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>\n\t\t\t\t\t{/* Environment ID */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\thtmlFor=\"environmentId\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tEnvironment ID <span style={{ color: '#dc2626' }}>*</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tid=\"environmentId\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\tonChange={(e) => handleEnvironmentIdChange(e.target.value)}\n\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 14px',\n\t\t\t\t\t\t\t\tborder: `1px solid ${errors.environmentId ? '#dc2626' : '#d1d5db'}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#8b5cf6';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(139, 92, 246, 0.1)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = errors.environmentId ? '#dc2626' : '#d1d5db';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\taria-invalid={!!errors.environmentId}\n\t\t\t\t\t\t\taria-describedby={errors.environmentId ? 'environmentId-error' : undefined}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{errors.environmentId && (\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tid=\"environmentId-error\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#dc2626',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{errors.environmentId}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Username */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tUsername <span style={{ color: '#dc2626' }}>*</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\tonChange={(e) => handleUsernameChange(e.target.value)}\n\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 14px',\n\t\t\t\t\t\t\t\tborder: `1px solid ${errors.username ? '#dc2626' : '#d1d5db'}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#8b5cf6';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(139, 92, 246, 0.1)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = errors.username ? '#dc2626' : '#d1d5db';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\taria-invalid={!!errors.username}\n\t\t\t\t\t\t\taria-describedby={errors.username ? 'username-error' : undefined}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{errors.username && (\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tid=\"username-error\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#dc2626',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{errors.username}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Registration Flow Type Selection */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tRegistration Flow <span className=\"required\">*</span>\n\t\t\t\t\t\t\t<MFAInfoButtonV8 contentKey=\"mfa.registrationFlowType\" displayMode=\"modal\" />\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t\t\t\t\tgap: '12px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Admin Flow (ACTIVE) Option */}\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-active' ? '#10b981' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\tbackground: flowType === 'admin-active' ? '#ecfdf5' : '#ffffff',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\tflowType === 'admin-active'\n\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(16, 185, 129, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-active') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#6ee7b7';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f0fdf4';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-active') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"admin-active\"\n\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'admin-active'}\n\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('admin-active')}\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\taccentColor: '#10b981',\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'admin-active' ? '#047857' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüîë Admin Flow (ACTIVE)\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#065f46',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tInstant Activation\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tDevice is created and immediately active. No OTP verification required. Uses\n\t\t\t\t\t\t\t\t\t\t\tWorker Token.\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t\t{/* Admin Flow (ACTIVATION_REQUIRED) Option - Hidden for FIDO2 */}\n\t\t\t\t\t\t\t{config.deviceType !== 'FIDO2' && (\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-activation' ? '#f59e0b' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\t\tbackground: flowType === 'admin-activation' ? '#fffbeb' : '#ffffff',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\tflowType === 'admin-activation'\n\t\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(245, 158, 11, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-activation') {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#fcd34d';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#fefce8';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-activation') {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\t\tvalue=\"admin-activation\"\n\t\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'admin-activation'}\n\t\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('admin-activation')}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\t\taccentColor: '#f59e0b',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'admin-activation' ? '#b45309' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tüîê Admin Flow (ACTIVATION_REQUIRED)\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#fef3c7',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#92400e',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tOTP Required\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tDevice is created pending activation. User must verify with OTP before\n\t\t\t\t\t\t\t\t\t\t\t\tdevice becomes active. Uses Worker Token.\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t\t{/* User Flow Option */}\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'user' ? '#8b5cf6' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\tbackground: flowType === 'user' ? '#f5f3ff' : '#ffffff',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\tflowType === 'user'\n\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(139, 92, 246, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'user') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#c4b5fd';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#faf5ff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'user') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"user\"\n\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'user'}\n\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('user')}\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\taccentColor: '#8b5cf6',\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'user' ? '#6d28d9' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüë§ User Flow\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#ede9fe',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#5b21b6',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tOAuth Login\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tUser authenticates via OAuth and registers their own device. Requires user\n\t\t\t\t\t\t\t\t\t\t\tlogin.\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Token Status Display */}\n\t\t\t\t\t<div className=\"token-status-section\">\n\t\t\t\t\t\t{tokenType === 'worker' && (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={handleEnvironmentIdChange}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{errors.token && (\n\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\tclassName=\"error-message\"\n\t\t\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t\t\t\tstyle={{ marginTop: '12px', display: 'block' }}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{errors.token}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{tokenType === 'user' && (\n\t\t\t\t\t\t\t<div className=\"token-status-card\">\n\t\t\t\t\t\t\t\t<h4>User Token Status</h4>\n\t\t\t\t\t\t\t\t<div className={`status-indicator ${credentials.userToken ? 'valid' : 'invalid'}`}>\n\t\t\t\t\t\t\t\t\t{credentials.userToken ? '‚úì Logged In' : '‚úó Not Logged In'}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUserLoginModal(true)}\n\t\t\t\t\t\t\t\t\tclassName=\"button-link\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{credentials.userToken ? 'Re-authenticate' : 'Login via OAuth'}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{errors.token && (\n\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\tclassName=\"error-message\"\n\t\t\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t\t\t\tstyle={{ marginTop: '12px', display: 'block' }}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{errors.token}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Device Authentication Policy */}\n\t\t\t\t\t{deviceAuthPolicies.length > 0 && (\n\t\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t\t<label htmlFor=\"deviceAuthPolicy\">\n\t\t\t\t\t\t\t\tDevice Authentication Policy\n\t\t\t\t\t\t\t\t<MFAInfoButtonV8 contentKey=\"device.authentication.policy\" displayMode=\"modal\" />\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<select\n\t\t\t\t\t\t\t\tid=\"deviceAuthPolicy\"\n\t\t\t\t\t\t\t\tvalue={selectedPolicyId}\n\t\t\t\t\t\t\t\tonChange={(e) => handlePolicyChange(e.target.value)}\n\t\t\t\t\t\t\t\tdisabled={isLoadingPolicies}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{deviceAuthPolicies.map((policy) => (\n\t\t\t\t\t\t\t\t\t<option key={policy.id} value={policy.id}>\n\t\t\t\t\t\t\t\t\t\t{policy.name}\n\t\t\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t{selectedPolicy?.description && (\n\t\t\t\t\t\t\t\t<p className=\"field-hint\">{selectedPolicy.description}</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* Policy Loading/Error States */}\n\t\t\t\t\t{isLoadingPolicies && (\n\t\t\t\t\t\t<div className=\"loading-indicator\">Loading device authentication policies...</div>\n\t\t\t\t\t)}\n\t\t\t\t\t{policiesError && (\n\t\t\t\t\t\t<div className=\"error-message\" role=\"alert\">\n\t\t\t\t\t\t\t{policiesError}\n\t\t\t\t\t\t\t<button type=\"button\" onClick={refreshDeviceAuthPolicies} className=\"button-link\">\n\t\t\t\t\t\t\t\tRetry\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{/* Action Buttons */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\tjustifyContent: 'flex-end',\n\t\t\t\t\talignItems: 'center',\n\t\t\t\t\tmarginTop: '32px',\n\t\t\t\t\tpaddingTop: '24px',\n\t\t\t\t\tborderTop: '1px solid #e5e7eb',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleContinue}\n\t\t\t\t\tdisabled={!canProceed || isLoading}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: '14px 28px',\n\t\t\t\t\t\tbackground: canProceed && !isLoading ? '#8b5cf6' : '#d1d5db',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\tcolor: canProceed && !isLoading ? '#ffffff' : '#9ca3af',\n\t\t\t\t\t\tcursor: canProceed && !isLoading ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\tboxShadow: canProceed && !isLoading ? '0 4px 12px rgba(139, 92, 246, 0.3)' : 'none',\n\t\t\t\t\t}}\n\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\tif (canProceed && !isLoading) {\n\t\t\t\t\t\t\te.currentTarget.style.background = '#7c3aed';\n\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 16px rgba(139, 92, 246, 0.4)';\n\t\t\t\t\t\t}\n\t\t\t\t\t}}\n\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\tif (canProceed && !isLoading) {\n\t\t\t\t\t\t\te.currentTarget.style.background = '#8b5cf6';\n\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 4px 12px rgba(139, 92, 246, 0.3)';\n\t\t\t\t\t\t}\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Loading...' : 'Next Step ‚Üí'}\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n\nexport default UnifiedConfigurationStep;\n"},"tags":[],"source":null},{"category":"lint/correctness/noUnusedFunctionParameters","severity":"warning","description":"This parameter is unused.","message":[{"elements":[],"content":"This "},{"elements":["Emphasis"],"content":"parameter"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused parameters might be the result of an incomplete refactoring."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedConfigurationStep.tsx"},"span":[2245,2268],"sourceCode":"/**\n * @file UnifiedConfigurationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 0: Configuration - Environment and credential setup\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Configure environment, credentials, and token type before device registration\n *\n * Flow:\n * 1. Enter environment ID, username\n * 2. Select token type (Worker or User)\n * 3. Select device authentication policy (optional)\n * 4. Validate configuration\n * 5. Navigate to device selection step\n *\n * @example\n * <UnifiedConfigurationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   registrationFlowType=\"admin\"\n * />\n */\n\nimport React, { useCallback, useEffect, useRef, useState } from 'react';\nimport { MFAInfoButtonV8 } from '@/v8/components/MFAInfoButtonV8';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport type { TokenType } from '@/v8/flows/shared/MFATypes';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[‚öôÔ∏è UNIFIED-CONFIGURATION-STEP]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedConfigurationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Registration flow type (admin uses worker token, user uses user token) */\n\tregistrationFlowType?: 'admin' | 'user';\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Configuration Step (Step 0)\n *\n * Handles environment and credential configuration for unified MFA flow.\n */\nexport const UnifiedConfigurationStep: React.FC<UnifiedConfigurationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\ttokenStatus,\n\tdeviceAuthPolicies,\n\tisLoadingPolicies,\n\tpoliciesError,\n\trefreshDeviceAuthPolicies,\n\tshowWorkerTokenModal,\n\tsetShowWorkerTokenModal,\n\tshowUserLoginModal,\n\tsetShowUserLoginModal,\n\tshowSettingsModal,\n\tsetShowSettingsModal,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tregistrationFlowType = 'admin',\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering configuration step for:`, config.deviceType);\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\t// Load saved username from localStorage\n\tconst getSavedUsername = () => {\n\t\ttry {\n\t\t\treturn localStorage.getItem('mfa_unified_username') || credentials.username || '';\n\t\t} catch {\n\t\t\treturn credentials.username || '';\n\t\t}\n\t};\n\n\tconst [environmentId, setEnvironmentId] = useState(credentials.environmentId || '');\n\tconst [username, setUsername] = useState(getSavedUsername);\n\n\t// Registration flow type: 'admin-active', 'admin-activation', or 'user'\n\tconst [flowType, setFlowType] = useState<'admin-active' | 'admin-activation' | 'user'>(\n\t\tregistrationFlowType === 'user' ? 'user' : 'admin-active'\n\t);\n\n\t// Derived token type from flow type\n\tconst tokenType: TokenType = flowType === 'user' ? 'user' : 'worker';\n\n\t// Device status for admin flows\n\tconst adminDeviceStatus = flowType === 'admin-active' ? 'ACTIVE' : 'ACTIVATION_REQUIRED';\n\n\tconst [selectedPolicyId, setSelectedPolicyId] = useState(\n\t\tcredentials.deviceAuthenticationPolicyId || ''\n\t);\n\n\t// Validation errors\n\tconst [errors, setErrors] = useState<Record<string, string>>({});\n\n\t// ========================================================================\n\t// EFFECTS\n\t// ========================================================================\n\n\t/**\n\t * Auto-populate environment ID from worker token if available\n\t */\n\tuseEffect(() => {\n\t\tif (!environmentId && tokenStatus.isValid) {\n\t\t\tconst workerCreds = workerTokenServiceV8.loadCredentialsSync();\n\t\t\tif (workerCreds?.environmentId) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Auto-populating environment ID:`, workerCreds.environmentId);\n\t\t\t\tsetEnvironmentId(workerCreds.environmentId);\n\t\t\t\tsetCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tenvironmentId: workerCreds.environmentId,\n\t\t\t\t\tregion: workerCreds.region || prev.region || 'us',\n\t\t\t\t\tcustomDomain: workerCreds.customDomain || prev.customDomain,\n\t\t\t\t}));\n\t\t\t}\n\t\t}\n\t}, [tokenStatus.isValid, environmentId, setCredentials]);\n\n\t/**\n\t * Save username to localStorage when it changes\n\t */\n\tuseEffect(() => {\n\t\tif (username.trim()) {\n\t\t\ttry {\n\t\t\t\tlocalStorage.setItem('mfa_unified_username', username.trim());\n\t\t\t\tconsole.log(`${MODULE_TAG} Saved username to localStorage`);\n\t\t\t} catch {\n\t\t\t\t// Ignore localStorage errors\n\t\t\t}\n\t\t}\n\t}, [username]);\n\n\t/**\n\t * Auto-select first device authentication policy when loaded\n\t */\n\tuseEffect(() => {\n\t\tif (deviceAuthPolicies.length > 0 && !selectedPolicyId) {\n\t\t\tconst firstPolicy = deviceAuthPolicies[0];\n\t\t\tconsole.log(`${MODULE_TAG} Auto-selecting first policy:`, firstPolicy.name);\n\t\t\tsetSelectedPolicyId(firstPolicy.id);\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceAuthenticationPolicyId: firstPolicy.id,\n\t\t\t}));\n\t\t}\n\t}, [deviceAuthPolicies, selectedPolicyId, setCredentials]);\n\n\t/**\n\t * Sync flow type when registration flow type prop changes\n\t */\n\tuseEffect(() => {\n\t\tif (registrationFlowType === 'user' && flowType !== 'user') {\n\t\t\tconsole.log(`${MODULE_TAG} User registration flow - switching to user flow type`);\n\t\t\tsetFlowType('user');\n\t\t}\n\t}, [registrationFlowType, flowType]);\n\n\t/**\n\t * Track if we've already auto-advanced to prevent loops\n\t */\n\tconst hasAutoAdvanced = useRef(false);\n\n\t/**\n\t * Auto-advance after successful OAuth login for User Flow\n\t * When user returns from OAuth with a token, automatically proceed to next step\n\t */\n\tuseEffect(() => {\n\t\t// Only auto-advance for user flow when we have a user token\n\t\tif (\n\t\t\tflowType === 'user' &&\n\t\t\tcredentials.userToken &&\n\t\t\tenvironmentId.trim() &&\n\t\t\tusername.trim() &&\n\t\t\t!hasAutoAdvanced.current\n\t\t) {\n\t\t\tconsole.log(`${MODULE_TAG} Auto-advancing after OAuth login`);\n\t\t\thasAutoAdvanced.current = true;\n\n\t\t\t// Update credentials with final values\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tenvironmentId: environmentId.trim(),\n\t\t\t\tusername: username.trim(),\n\t\t\t\ttokenType: 'user',\n\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicyId,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t}));\n\n\t\t\t// Small delay to ensure state updates propagate\n\t\t\tsetTimeout(() => {\n\t\t\t\ttoastV8.success('Authentication successful! Proceeding to next step...');\n\t\t\t\tnav.markStepComplete();\n\t\t\t\tnav.goToNext();\n\t\t\t}, 300);\n\t\t}\n\t}, [\n\t\tcredentials.userToken,\n\t\tflowType,\n\t\tenvironmentId,\n\t\tusername,\n\t\tselectedPolicyId,\n\t\tconfig.deviceType,\n\t\tsetCredentials,\n\t\tnav,\n\t]);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Validate configuration fields\n\t */\n\tconst validateConfiguration = useCallback((): boolean => {\n\t\tconst newErrors: Record<string, string> = {};\n\n\t\t// Validate environment ID\n\t\tif (!environmentId.trim()) {\n\t\t\tnewErrors.environmentId = 'Environment ID is required';\n\t\t}\n\n\t\t// Validate username\n\t\tif (!username.trim()) {\n\t\t\tnewErrors.username = 'Username is required';\n\t\t}\n\n\t\t// Validate token based on token type\n\t\tif (tokenType === 'worker') {\n\t\t\tif (!tokenStatus.isValid) {\n\t\t\t\tnewErrors.token = 'Valid worker token is required';\n\t\t\t}\n\t\t} else if (tokenType === 'user') {\n\t\t\tif (!credentials.userToken) {\n\t\t\t\tnewErrors.token = 'User token is required. Please log in.';\n\t\t\t}\n\t\t}\n\n\t\tsetErrors(newErrors);\n\n\t\tif (Object.keys(newErrors).length > 0) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed:`, newErrors);\n\t\t\tnav.setValidationErrors(Object.values(newErrors));\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}, [environmentId, username, tokenType, tokenStatus, credentials, nav]);\n\n\t/**\n\t * Handle continue button click\n\t */\n\tconst handleContinue = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} Continuing to device selection`);\n\n\t\t// Validate configuration\n\t\tif (!validateConfiguration()) {\n\t\t\ttoastV8.error('Please fix the configuration errors');\n\t\t\treturn;\n\t\t}\n\n\t\t// Update credentials with final values\n\t\tsetCredentials((prev) => ({\n\t\t\t...prev,\n\t\t\tenvironmentId: environmentId.trim(),\n\t\t\tusername: username.trim(),\n\t\t\ttokenType,\n\t\t\tdeviceAuthenticationPolicyId: selectedPolicyId,\n\t\t\tdeviceType: config.deviceType,\n\t\t\t// Store device status for admin flows (ACTIVE or ACTIVATION_REQUIRED)\n\t\t\tdeviceStatus: flowType !== 'user' ? adminDeviceStatus : undefined,\n\t\t}));\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to next step (device selection)\n\t\tnav.goToNext();\n\t}, [\n\t\tenvironmentId,\n\t\tusername,\n\t\ttokenType,\n\t\tselectedPolicyId,\n\t\tconfig,\n\t\tvalidateConfiguration,\n\t\tsetCredentials,\n\t\tnav,\n\t\tadminDeviceStatus,\n\t\tflowType,\n\t]);\n\n\t/**\n\t * Handle environment ID change\n\t */\n\tconst handleEnvironmentIdChange = useCallback((value: string) => {\n\t\tsetEnvironmentId(value);\n\t\tsetErrors((prev) => {\n\t\t\tconst { environmentId, ...rest } = prev;\n\t\t\treturn rest;\n\t\t});\n\t}, []);\n\n\t/**\n\t * Handle username change\n\t */\n\tconst handleUsernameChange = useCallback((value: string) => {\n\t\tsetUsername(value);\n\t\tsetErrors((prev) => {\n\t\t\tconst { username, ...rest } = prev;\n\t\t\treturn rest;\n\t\t});\n\t}, []);\n\n\t/**\n\t * Handle flow type change\n\t */\n\tconst handleFlowTypeChange = useCallback(\n\t\t(type: 'admin-active' | 'admin-activation' | 'user') => {\n\t\t\tconsole.log(`${MODULE_TAG} Flow type changed to:`, type);\n\t\t\tsetFlowType(type);\n\t\t\tsetErrors((prev) => {\n\t\t\t\tconst { token, ...rest } = prev;\n\t\t\t\treturn rest;\n\t\t\t});\n\n\t\t\t// Open user login modal when user flow is selected\n\t\t\tif (type === 'user' && !credentials.userToken) {\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t}\n\t\t},\n\t\t[credentials.userToken, setShowUserLoginModal]\n\t);\n\n\t/**\n\t * Handle policy selection change\n\t */\n\tconst handlePolicyChange = useCallback(\n\t\t(policyId: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Policy changed to:`, policyId);\n\t\t\tsetSelectedPolicyId(policyId);\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t}));\n\t\t},\n\t\t[setCredentials]\n\t);\n\n\t// ========================================================================\n\t// COMPUTED PROPERTIES\n\t// ========================================================================\n\n\tconst selectedPolicy = deviceAuthPolicies.find((p) => p.id === selectedPolicyId);\n\tconst canProceed =\n\t\tenvironmentId.trim() &&\n\t\tusername.trim() &&\n\t\t(tokenType === 'worker' ? tokenStatus.isValid : !!credentials.userToken);\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div\n\t\t\tclassName=\"unified-configuration-step\"\n\t\t\tstyle={{\n\t\t\t\tmaxWidth: '900px',\n\t\t\t\tmargin: '0 auto',\n\t\t\t\tpadding: '24px',\n\t\t\t}}\n\t\t>\n\t\t\t{/* Step Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\tboxShadow: '0 4px 12px rgba(139, 92, 246, 0.2)',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<h2\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\tfontSize: '26px',\n\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\tcolor: '#ffffff',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '12px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{config.icon} Configure {config.displayName} Registration\n\t\t\t\t</h2>\n\t\t\t\t<p\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\tEnter your environment and user credentials to begin the registration process.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Configuration Form */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px',\n\t\t\t\t\tboxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',\n\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>\n\t\t\t\t\t{/* Environment ID */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\thtmlFor=\"environmentId\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tEnvironment ID <span style={{ color: '#dc2626' }}>*</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tid=\"environmentId\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\tonChange={(e) => handleEnvironmentIdChange(e.target.value)}\n\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 14px',\n\t\t\t\t\t\t\t\tborder: `1px solid ${errors.environmentId ? '#dc2626' : '#d1d5db'}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#8b5cf6';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(139, 92, 246, 0.1)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = errors.environmentId ? '#dc2626' : '#d1d5db';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\taria-invalid={!!errors.environmentId}\n\t\t\t\t\t\t\taria-describedby={errors.environmentId ? 'environmentId-error' : undefined}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{errors.environmentId && (\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tid=\"environmentId-error\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#dc2626',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{errors.environmentId}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Username */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tUsername <span style={{ color: '#dc2626' }}>*</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\tonChange={(e) => handleUsernameChange(e.target.value)}\n\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 14px',\n\t\t\t\t\t\t\t\tborder: `1px solid ${errors.username ? '#dc2626' : '#d1d5db'}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#8b5cf6';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(139, 92, 246, 0.1)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = errors.username ? '#dc2626' : '#d1d5db';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\taria-invalid={!!errors.username}\n\t\t\t\t\t\t\taria-describedby={errors.username ? 'username-error' : undefined}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{errors.username && (\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tid=\"username-error\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#dc2626',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{errors.username}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Registration Flow Type Selection */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tRegistration Flow <span className=\"required\">*</span>\n\t\t\t\t\t\t\t<MFAInfoButtonV8 contentKey=\"mfa.registrationFlowType\" displayMode=\"modal\" />\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t\t\t\t\tgap: '12px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Admin Flow (ACTIVE) Option */}\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-active' ? '#10b981' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\tbackground: flowType === 'admin-active' ? '#ecfdf5' : '#ffffff',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\tflowType === 'admin-active'\n\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(16, 185, 129, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-active') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#6ee7b7';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f0fdf4';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-active') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"admin-active\"\n\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'admin-active'}\n\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('admin-active')}\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\taccentColor: '#10b981',\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'admin-active' ? '#047857' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüîë Admin Flow (ACTIVE)\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#065f46',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tInstant Activation\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tDevice is created and immediately active. No OTP verification required. Uses\n\t\t\t\t\t\t\t\t\t\t\tWorker Token.\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t\t{/* Admin Flow (ACTIVATION_REQUIRED) Option - Hidden for FIDO2 */}\n\t\t\t\t\t\t\t{config.deviceType !== 'FIDO2' && (\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-activation' ? '#f59e0b' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\t\tbackground: flowType === 'admin-activation' ? '#fffbeb' : '#ffffff',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\tflowType === 'admin-activation'\n\t\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(245, 158, 11, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-activation') {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#fcd34d';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#fefce8';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-activation') {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\t\tvalue=\"admin-activation\"\n\t\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'admin-activation'}\n\t\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('admin-activation')}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\t\taccentColor: '#f59e0b',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'admin-activation' ? '#b45309' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tüîê Admin Flow (ACTIVATION_REQUIRED)\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#fef3c7',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#92400e',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tOTP Required\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tDevice is created pending activation. User must verify with OTP before\n\t\t\t\t\t\t\t\t\t\t\t\tdevice becomes active. Uses Worker Token.\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t\t{/* User Flow Option */}\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'user' ? '#8b5cf6' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\tbackground: flowType === 'user' ? '#f5f3ff' : '#ffffff',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\tflowType === 'user'\n\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(139, 92, 246, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'user') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#c4b5fd';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#faf5ff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'user') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"user\"\n\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'user'}\n\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('user')}\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\taccentColor: '#8b5cf6',\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'user' ? '#6d28d9' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüë§ User Flow\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#ede9fe',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#5b21b6',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tOAuth Login\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tUser authenticates via OAuth and registers their own device. Requires user\n\t\t\t\t\t\t\t\t\t\t\tlogin.\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Token Status Display */}\n\t\t\t\t\t<div className=\"token-status-section\">\n\t\t\t\t\t\t{tokenType === 'worker' && (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={handleEnvironmentIdChange}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{errors.token && (\n\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\tclassName=\"error-message\"\n\t\t\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t\t\t\tstyle={{ marginTop: '12px', display: 'block' }}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{errors.token}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{tokenType === 'user' && (\n\t\t\t\t\t\t\t<div className=\"token-status-card\">\n\t\t\t\t\t\t\t\t<h4>User Token Status</h4>\n\t\t\t\t\t\t\t\t<div className={`status-indicator ${credentials.userToken ? 'valid' : 'invalid'}`}>\n\t\t\t\t\t\t\t\t\t{credentials.userToken ? '‚úì Logged In' : '‚úó Not Logged In'}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUserLoginModal(true)}\n\t\t\t\t\t\t\t\t\tclassName=\"button-link\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{credentials.userToken ? 'Re-authenticate' : 'Login via OAuth'}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{errors.token && (\n\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\tclassName=\"error-message\"\n\t\t\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t\t\t\tstyle={{ marginTop: '12px', display: 'block' }}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{errors.token}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Device Authentication Policy */}\n\t\t\t\t\t{deviceAuthPolicies.length > 0 && (\n\t\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t\t<label htmlFor=\"deviceAuthPolicy\">\n\t\t\t\t\t\t\t\tDevice Authentication Policy\n\t\t\t\t\t\t\t\t<MFAInfoButtonV8 contentKey=\"device.authentication.policy\" displayMode=\"modal\" />\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<select\n\t\t\t\t\t\t\t\tid=\"deviceAuthPolicy\"\n\t\t\t\t\t\t\t\tvalue={selectedPolicyId}\n\t\t\t\t\t\t\t\tonChange={(e) => handlePolicyChange(e.target.value)}\n\t\t\t\t\t\t\t\tdisabled={isLoadingPolicies}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{deviceAuthPolicies.map((policy) => (\n\t\t\t\t\t\t\t\t\t<option key={policy.id} value={policy.id}>\n\t\t\t\t\t\t\t\t\t\t{policy.name}\n\t\t\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t{selectedPolicy?.description && (\n\t\t\t\t\t\t\t\t<p className=\"field-hint\">{selectedPolicy.description}</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* Policy Loading/Error States */}\n\t\t\t\t\t{isLoadingPolicies && (\n\t\t\t\t\t\t<div className=\"loading-indicator\">Loading device authentication policies...</div>\n\t\t\t\t\t)}\n\t\t\t\t\t{policiesError && (\n\t\t\t\t\t\t<div className=\"error-message\" role=\"alert\">\n\t\t\t\t\t\t\t{policiesError}\n\t\t\t\t\t\t\t<button type=\"button\" onClick={refreshDeviceAuthPolicies} className=\"button-link\">\n\t\t\t\t\t\t\t\tRetry\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{/* Action Buttons */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\tjustifyContent: 'flex-end',\n\t\t\t\t\talignItems: 'center',\n\t\t\t\t\tmarginTop: '32px',\n\t\t\t\t\tpaddingTop: '24px',\n\t\t\t\t\tborderTop: '1px solid #e5e7eb',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleContinue}\n\t\t\t\t\tdisabled={!canProceed || isLoading}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: '14px 28px',\n\t\t\t\t\t\tbackground: canProceed && !isLoading ? '#8b5cf6' : '#d1d5db',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\tcolor: canProceed && !isLoading ? '#ffffff' : '#9ca3af',\n\t\t\t\t\t\tcursor: canProceed && !isLoading ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\tboxShadow: canProceed && !isLoading ? '0 4px 12px rgba(139, 92, 246, 0.3)' : 'none',\n\t\t\t\t\t}}\n\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\tif (canProceed && !isLoading) {\n\t\t\t\t\t\t\te.currentTarget.style.background = '#7c3aed';\n\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 16px rgba(139, 92, 246, 0.4)';\n\t\t\t\t\t\t}\n\t\t\t\t\t}}\n\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\tif (canProceed && !isLoading) {\n\t\t\t\t\t\t\te.currentTarget.style.background = '#8b5cf6';\n\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 4px 12px rgba(139, 92, 246, 0.3)';\n\t\t\t\t\t\t}\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Loading...' : 'Next Step ‚Üí'}\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n\nexport default UnifiedConfigurationStep;\n"},"tags":[],"source":null},{"category":"lint/correctness/noUnusedFunctionParameters","severity":"warning","description":"This parameter is unused.","message":[{"elements":[],"content":"This "},{"elements":["Emphasis"],"content":"parameter"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused parameters might be the result of an incomplete refactoring."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedConfigurationStep.tsx"},"span":[2271,2289],"sourceCode":"/**\n * @file UnifiedConfigurationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 0: Configuration - Environment and credential setup\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Configure environment, credentials, and token type before device registration\n *\n * Flow:\n * 1. Enter environment ID, username\n * 2. Select token type (Worker or User)\n * 3. Select device authentication policy (optional)\n * 4. Validate configuration\n * 5. Navigate to device selection step\n *\n * @example\n * <UnifiedConfigurationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   registrationFlowType=\"admin\"\n * />\n */\n\nimport React, { useCallback, useEffect, useRef, useState } from 'react';\nimport { MFAInfoButtonV8 } from '@/v8/components/MFAInfoButtonV8';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport type { TokenType } from '@/v8/flows/shared/MFATypes';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[‚öôÔ∏è UNIFIED-CONFIGURATION-STEP]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedConfigurationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Registration flow type (admin uses worker token, user uses user token) */\n\tregistrationFlowType?: 'admin' | 'user';\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Configuration Step (Step 0)\n *\n * Handles environment and credential configuration for unified MFA flow.\n */\nexport const UnifiedConfigurationStep: React.FC<UnifiedConfigurationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\ttokenStatus,\n\tdeviceAuthPolicies,\n\tisLoadingPolicies,\n\tpoliciesError,\n\trefreshDeviceAuthPolicies,\n\tshowWorkerTokenModal,\n\tsetShowWorkerTokenModal,\n\tshowUserLoginModal,\n\tsetShowUserLoginModal,\n\tshowSettingsModal,\n\tsetShowSettingsModal,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tregistrationFlowType = 'admin',\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering configuration step for:`, config.deviceType);\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\t// Load saved username from localStorage\n\tconst getSavedUsername = () => {\n\t\ttry {\n\t\t\treturn localStorage.getItem('mfa_unified_username') || credentials.username || '';\n\t\t} catch {\n\t\t\treturn credentials.username || '';\n\t\t}\n\t};\n\n\tconst [environmentId, setEnvironmentId] = useState(credentials.environmentId || '');\n\tconst [username, setUsername] = useState(getSavedUsername);\n\n\t// Registration flow type: 'admin-active', 'admin-activation', or 'user'\n\tconst [flowType, setFlowType] = useState<'admin-active' | 'admin-activation' | 'user'>(\n\t\tregistrationFlowType === 'user' ? 'user' : 'admin-active'\n\t);\n\n\t// Derived token type from flow type\n\tconst tokenType: TokenType = flowType === 'user' ? 'user' : 'worker';\n\n\t// Device status for admin flows\n\tconst adminDeviceStatus = flowType === 'admin-active' ? 'ACTIVE' : 'ACTIVATION_REQUIRED';\n\n\tconst [selectedPolicyId, setSelectedPolicyId] = useState(\n\t\tcredentials.deviceAuthenticationPolicyId || ''\n\t);\n\n\t// Validation errors\n\tconst [errors, setErrors] = useState<Record<string, string>>({});\n\n\t// ========================================================================\n\t// EFFECTS\n\t// ========================================================================\n\n\t/**\n\t * Auto-populate environment ID from worker token if available\n\t */\n\tuseEffect(() => {\n\t\tif (!environmentId && tokenStatus.isValid) {\n\t\t\tconst workerCreds = workerTokenServiceV8.loadCredentialsSync();\n\t\t\tif (workerCreds?.environmentId) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Auto-populating environment ID:`, workerCreds.environmentId);\n\t\t\t\tsetEnvironmentId(workerCreds.environmentId);\n\t\t\t\tsetCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tenvironmentId: workerCreds.environmentId,\n\t\t\t\t\tregion: workerCreds.region || prev.region || 'us',\n\t\t\t\t\tcustomDomain: workerCreds.customDomain || prev.customDomain,\n\t\t\t\t}));\n\t\t\t}\n\t\t}\n\t}, [tokenStatus.isValid, environmentId, setCredentials]);\n\n\t/**\n\t * Save username to localStorage when it changes\n\t */\n\tuseEffect(() => {\n\t\tif (username.trim()) {\n\t\t\ttry {\n\t\t\t\tlocalStorage.setItem('mfa_unified_username', username.trim());\n\t\t\t\tconsole.log(`${MODULE_TAG} Saved username to localStorage`);\n\t\t\t} catch {\n\t\t\t\t// Ignore localStorage errors\n\t\t\t}\n\t\t}\n\t}, [username]);\n\n\t/**\n\t * Auto-select first device authentication policy when loaded\n\t */\n\tuseEffect(() => {\n\t\tif (deviceAuthPolicies.length > 0 && !selectedPolicyId) {\n\t\t\tconst firstPolicy = deviceAuthPolicies[0];\n\t\t\tconsole.log(`${MODULE_TAG} Auto-selecting first policy:`, firstPolicy.name);\n\t\t\tsetSelectedPolicyId(firstPolicy.id);\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceAuthenticationPolicyId: firstPolicy.id,\n\t\t\t}));\n\t\t}\n\t}, [deviceAuthPolicies, selectedPolicyId, setCredentials]);\n\n\t/**\n\t * Sync flow type when registration flow type prop changes\n\t */\n\tuseEffect(() => {\n\t\tif (registrationFlowType === 'user' && flowType !== 'user') {\n\t\t\tconsole.log(`${MODULE_TAG} User registration flow - switching to user flow type`);\n\t\t\tsetFlowType('user');\n\t\t}\n\t}, [registrationFlowType, flowType]);\n\n\t/**\n\t * Track if we've already auto-advanced to prevent loops\n\t */\n\tconst hasAutoAdvanced = useRef(false);\n\n\t/**\n\t * Auto-advance after successful OAuth login for User Flow\n\t * When user returns from OAuth with a token, automatically proceed to next step\n\t */\n\tuseEffect(() => {\n\t\t// Only auto-advance for user flow when we have a user token\n\t\tif (\n\t\t\tflowType === 'user' &&\n\t\t\tcredentials.userToken &&\n\t\t\tenvironmentId.trim() &&\n\t\t\tusername.trim() &&\n\t\t\t!hasAutoAdvanced.current\n\t\t) {\n\t\t\tconsole.log(`${MODULE_TAG} Auto-advancing after OAuth login`);\n\t\t\thasAutoAdvanced.current = true;\n\n\t\t\t// Update credentials with final values\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tenvironmentId: environmentId.trim(),\n\t\t\t\tusername: username.trim(),\n\t\t\t\ttokenType: 'user',\n\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicyId,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t}));\n\n\t\t\t// Small delay to ensure state updates propagate\n\t\t\tsetTimeout(() => {\n\t\t\t\ttoastV8.success('Authentication successful! Proceeding to next step...');\n\t\t\t\tnav.markStepComplete();\n\t\t\t\tnav.goToNext();\n\t\t\t}, 300);\n\t\t}\n\t}, [\n\t\tcredentials.userToken,\n\t\tflowType,\n\t\tenvironmentId,\n\t\tusername,\n\t\tselectedPolicyId,\n\t\tconfig.deviceType,\n\t\tsetCredentials,\n\t\tnav,\n\t]);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Validate configuration fields\n\t */\n\tconst validateConfiguration = useCallback((): boolean => {\n\t\tconst newErrors: Record<string, string> = {};\n\n\t\t// Validate environment ID\n\t\tif (!environmentId.trim()) {\n\t\t\tnewErrors.environmentId = 'Environment ID is required';\n\t\t}\n\n\t\t// Validate username\n\t\tif (!username.trim()) {\n\t\t\tnewErrors.username = 'Username is required';\n\t\t}\n\n\t\t// Validate token based on token type\n\t\tif (tokenType === 'worker') {\n\t\t\tif (!tokenStatus.isValid) {\n\t\t\t\tnewErrors.token = 'Valid worker token is required';\n\t\t\t}\n\t\t} else if (tokenType === 'user') {\n\t\t\tif (!credentials.userToken) {\n\t\t\t\tnewErrors.token = 'User token is required. Please log in.';\n\t\t\t}\n\t\t}\n\n\t\tsetErrors(newErrors);\n\n\t\tif (Object.keys(newErrors).length > 0) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed:`, newErrors);\n\t\t\tnav.setValidationErrors(Object.values(newErrors));\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}, [environmentId, username, tokenType, tokenStatus, credentials, nav]);\n\n\t/**\n\t * Handle continue button click\n\t */\n\tconst handleContinue = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} Continuing to device selection`);\n\n\t\t// Validate configuration\n\t\tif (!validateConfiguration()) {\n\t\t\ttoastV8.error('Please fix the configuration errors');\n\t\t\treturn;\n\t\t}\n\n\t\t// Update credentials with final values\n\t\tsetCredentials((prev) => ({\n\t\t\t...prev,\n\t\t\tenvironmentId: environmentId.trim(),\n\t\t\tusername: username.trim(),\n\t\t\ttokenType,\n\t\t\tdeviceAuthenticationPolicyId: selectedPolicyId,\n\t\t\tdeviceType: config.deviceType,\n\t\t\t// Store device status for admin flows (ACTIVE or ACTIVATION_REQUIRED)\n\t\t\tdeviceStatus: flowType !== 'user' ? adminDeviceStatus : undefined,\n\t\t}));\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to next step (device selection)\n\t\tnav.goToNext();\n\t}, [\n\t\tenvironmentId,\n\t\tusername,\n\t\ttokenType,\n\t\tselectedPolicyId,\n\t\tconfig,\n\t\tvalidateConfiguration,\n\t\tsetCredentials,\n\t\tnav,\n\t\tadminDeviceStatus,\n\t\tflowType,\n\t]);\n\n\t/**\n\t * Handle environment ID change\n\t */\n\tconst handleEnvironmentIdChange = useCallback((value: string) => {\n\t\tsetEnvironmentId(value);\n\t\tsetErrors((prev) => {\n\t\t\tconst { environmentId, ...rest } = prev;\n\t\t\treturn rest;\n\t\t});\n\t}, []);\n\n\t/**\n\t * Handle username change\n\t */\n\tconst handleUsernameChange = useCallback((value: string) => {\n\t\tsetUsername(value);\n\t\tsetErrors((prev) => {\n\t\t\tconst { username, ...rest } = prev;\n\t\t\treturn rest;\n\t\t});\n\t}, []);\n\n\t/**\n\t * Handle flow type change\n\t */\n\tconst handleFlowTypeChange = useCallback(\n\t\t(type: 'admin-active' | 'admin-activation' | 'user') => {\n\t\t\tconsole.log(`${MODULE_TAG} Flow type changed to:`, type);\n\t\t\tsetFlowType(type);\n\t\t\tsetErrors((prev) => {\n\t\t\t\tconst { token, ...rest } = prev;\n\t\t\t\treturn rest;\n\t\t\t});\n\n\t\t\t// Open user login modal when user flow is selected\n\t\t\tif (type === 'user' && !credentials.userToken) {\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t}\n\t\t},\n\t\t[credentials.userToken, setShowUserLoginModal]\n\t);\n\n\t/**\n\t * Handle policy selection change\n\t */\n\tconst handlePolicyChange = useCallback(\n\t\t(policyId: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Policy changed to:`, policyId);\n\t\t\tsetSelectedPolicyId(policyId);\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t}));\n\t\t},\n\t\t[setCredentials]\n\t);\n\n\t// ========================================================================\n\t// COMPUTED PROPERTIES\n\t// ========================================================================\n\n\tconst selectedPolicy = deviceAuthPolicies.find((p) => p.id === selectedPolicyId);\n\tconst canProceed =\n\t\tenvironmentId.trim() &&\n\t\tusername.trim() &&\n\t\t(tokenType === 'worker' ? tokenStatus.isValid : !!credentials.userToken);\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div\n\t\t\tclassName=\"unified-configuration-step\"\n\t\t\tstyle={{\n\t\t\t\tmaxWidth: '900px',\n\t\t\t\tmargin: '0 auto',\n\t\t\t\tpadding: '24px',\n\t\t\t}}\n\t\t>\n\t\t\t{/* Step Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\tboxShadow: '0 4px 12px rgba(139, 92, 246, 0.2)',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<h2\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\tfontSize: '26px',\n\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\tcolor: '#ffffff',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '12px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{config.icon} Configure {config.displayName} Registration\n\t\t\t\t</h2>\n\t\t\t\t<p\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\tEnter your environment and user credentials to begin the registration process.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Configuration Form */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px',\n\t\t\t\t\tboxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',\n\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>\n\t\t\t\t\t{/* Environment ID */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\thtmlFor=\"environmentId\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tEnvironment ID <span style={{ color: '#dc2626' }}>*</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tid=\"environmentId\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\tonChange={(e) => handleEnvironmentIdChange(e.target.value)}\n\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 14px',\n\t\t\t\t\t\t\t\tborder: `1px solid ${errors.environmentId ? '#dc2626' : '#d1d5db'}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#8b5cf6';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(139, 92, 246, 0.1)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = errors.environmentId ? '#dc2626' : '#d1d5db';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\taria-invalid={!!errors.environmentId}\n\t\t\t\t\t\t\taria-describedby={errors.environmentId ? 'environmentId-error' : undefined}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{errors.environmentId && (\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tid=\"environmentId-error\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#dc2626',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{errors.environmentId}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Username */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tUsername <span style={{ color: '#dc2626' }}>*</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\tonChange={(e) => handleUsernameChange(e.target.value)}\n\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 14px',\n\t\t\t\t\t\t\t\tborder: `1px solid ${errors.username ? '#dc2626' : '#d1d5db'}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#8b5cf6';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(139, 92, 246, 0.1)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = errors.username ? '#dc2626' : '#d1d5db';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\taria-invalid={!!errors.username}\n\t\t\t\t\t\t\taria-describedby={errors.username ? 'username-error' : undefined}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{errors.username && (\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tid=\"username-error\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#dc2626',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{errors.username}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Registration Flow Type Selection */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tRegistration Flow <span className=\"required\">*</span>\n\t\t\t\t\t\t\t<MFAInfoButtonV8 contentKey=\"mfa.registrationFlowType\" displayMode=\"modal\" />\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t\t\t\t\tgap: '12px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Admin Flow (ACTIVE) Option */}\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-active' ? '#10b981' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\tbackground: flowType === 'admin-active' ? '#ecfdf5' : '#ffffff',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\tflowType === 'admin-active'\n\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(16, 185, 129, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-active') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#6ee7b7';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f0fdf4';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-active') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"admin-active\"\n\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'admin-active'}\n\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('admin-active')}\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\taccentColor: '#10b981',\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'admin-active' ? '#047857' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüîë Admin Flow (ACTIVE)\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#065f46',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tInstant Activation\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tDevice is created and immediately active. No OTP verification required. Uses\n\t\t\t\t\t\t\t\t\t\t\tWorker Token.\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t\t{/* Admin Flow (ACTIVATION_REQUIRED) Option - Hidden for FIDO2 */}\n\t\t\t\t\t\t\t{config.deviceType !== 'FIDO2' && (\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-activation' ? '#f59e0b' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\t\tbackground: flowType === 'admin-activation' ? '#fffbeb' : '#ffffff',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\tflowType === 'admin-activation'\n\t\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(245, 158, 11, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-activation') {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#fcd34d';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#fefce8';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-activation') {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\t\tvalue=\"admin-activation\"\n\t\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'admin-activation'}\n\t\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('admin-activation')}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\t\taccentColor: '#f59e0b',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'admin-activation' ? '#b45309' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tüîê Admin Flow (ACTIVATION_REQUIRED)\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#fef3c7',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#92400e',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tOTP Required\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tDevice is created pending activation. User must verify with OTP before\n\t\t\t\t\t\t\t\t\t\t\t\tdevice becomes active. Uses Worker Token.\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t\t{/* User Flow Option */}\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'user' ? '#8b5cf6' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\tbackground: flowType === 'user' ? '#f5f3ff' : '#ffffff',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\tflowType === 'user'\n\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(139, 92, 246, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'user') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#c4b5fd';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#faf5ff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'user') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"user\"\n\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'user'}\n\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('user')}\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\taccentColor: '#8b5cf6',\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'user' ? '#6d28d9' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüë§ User Flow\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#ede9fe',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#5b21b6',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tOAuth Login\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tUser authenticates via OAuth and registers their own device. Requires user\n\t\t\t\t\t\t\t\t\t\t\tlogin.\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Token Status Display */}\n\t\t\t\t\t<div className=\"token-status-section\">\n\t\t\t\t\t\t{tokenType === 'worker' && (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={handleEnvironmentIdChange}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{errors.token && (\n\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\tclassName=\"error-message\"\n\t\t\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t\t\t\tstyle={{ marginTop: '12px', display: 'block' }}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{errors.token}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{tokenType === 'user' && (\n\t\t\t\t\t\t\t<div className=\"token-status-card\">\n\t\t\t\t\t\t\t\t<h4>User Token Status</h4>\n\t\t\t\t\t\t\t\t<div className={`status-indicator ${credentials.userToken ? 'valid' : 'invalid'}`}>\n\t\t\t\t\t\t\t\t\t{credentials.userToken ? '‚úì Logged In' : '‚úó Not Logged In'}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUserLoginModal(true)}\n\t\t\t\t\t\t\t\t\tclassName=\"button-link\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{credentials.userToken ? 'Re-authenticate' : 'Login via OAuth'}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{errors.token && (\n\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\tclassName=\"error-message\"\n\t\t\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t\t\t\tstyle={{ marginTop: '12px', display: 'block' }}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{errors.token}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Device Authentication Policy */}\n\t\t\t\t\t{deviceAuthPolicies.length > 0 && (\n\t\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t\t<label htmlFor=\"deviceAuthPolicy\">\n\t\t\t\t\t\t\t\tDevice Authentication Policy\n\t\t\t\t\t\t\t\t<MFAInfoButtonV8 contentKey=\"device.authentication.policy\" displayMode=\"modal\" />\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<select\n\t\t\t\t\t\t\t\tid=\"deviceAuthPolicy\"\n\t\t\t\t\t\t\t\tvalue={selectedPolicyId}\n\t\t\t\t\t\t\t\tonChange={(e) => handlePolicyChange(e.target.value)}\n\t\t\t\t\t\t\t\tdisabled={isLoadingPolicies}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{deviceAuthPolicies.map((policy) => (\n\t\t\t\t\t\t\t\t\t<option key={policy.id} value={policy.id}>\n\t\t\t\t\t\t\t\t\t\t{policy.name}\n\t\t\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t{selectedPolicy?.description && (\n\t\t\t\t\t\t\t\t<p className=\"field-hint\">{selectedPolicy.description}</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* Policy Loading/Error States */}\n\t\t\t\t\t{isLoadingPolicies && (\n\t\t\t\t\t\t<div className=\"loading-indicator\">Loading device authentication policies...</div>\n\t\t\t\t\t)}\n\t\t\t\t\t{policiesError && (\n\t\t\t\t\t\t<div className=\"error-message\" role=\"alert\">\n\t\t\t\t\t\t\t{policiesError}\n\t\t\t\t\t\t\t<button type=\"button\" onClick={refreshDeviceAuthPolicies} className=\"button-link\">\n\t\t\t\t\t\t\t\tRetry\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{/* Action Buttons */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\tjustifyContent: 'flex-end',\n\t\t\t\t\talignItems: 'center',\n\t\t\t\t\tmarginTop: '32px',\n\t\t\t\t\tpaddingTop: '24px',\n\t\t\t\t\tborderTop: '1px solid #e5e7eb',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleContinue}\n\t\t\t\t\tdisabled={!canProceed || isLoading}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: '14px 28px',\n\t\t\t\t\t\tbackground: canProceed && !isLoading ? '#8b5cf6' : '#d1d5db',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\tcolor: canProceed && !isLoading ? '#ffffff' : '#9ca3af',\n\t\t\t\t\t\tcursor: canProceed && !isLoading ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\tboxShadow: canProceed && !isLoading ? '0 4px 12px rgba(139, 92, 246, 0.3)' : 'none',\n\t\t\t\t\t}}\n\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\tif (canProceed && !isLoading) {\n\t\t\t\t\t\t\te.currentTarget.style.background = '#7c3aed';\n\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 16px rgba(139, 92, 246, 0.4)';\n\t\t\t\t\t\t}\n\t\t\t\t\t}}\n\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\tif (canProceed && !isLoading) {\n\t\t\t\t\t\t\te.currentTarget.style.background = '#8b5cf6';\n\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 4px 12px rgba(139, 92, 246, 0.3)';\n\t\t\t\t\t\t}\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Loading...' : 'Next Step ‚Üí'}\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n\nexport default UnifiedConfigurationStep;\n"},"tags":[],"source":null},{"category":"lint/correctness/noUnusedFunctionParameters","severity":"warning","description":"This parameter is unused.","message":[{"elements":[],"content":"This "},{"elements":["Emphasis"],"content":"parameter"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused parameters might be the result of an incomplete refactoring."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedConfigurationStep.tsx"},"span":[2316,2333],"sourceCode":"/**\n * @file UnifiedConfigurationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 0: Configuration - Environment and credential setup\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Configure environment, credentials, and token type before device registration\n *\n * Flow:\n * 1. Enter environment ID, username\n * 2. Select token type (Worker or User)\n * 3. Select device authentication policy (optional)\n * 4. Validate configuration\n * 5. Navigate to device selection step\n *\n * @example\n * <UnifiedConfigurationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   registrationFlowType=\"admin\"\n * />\n */\n\nimport React, { useCallback, useEffect, useRef, useState } from 'react';\nimport { MFAInfoButtonV8 } from '@/v8/components/MFAInfoButtonV8';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport type { TokenType } from '@/v8/flows/shared/MFATypes';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[‚öôÔ∏è UNIFIED-CONFIGURATION-STEP]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedConfigurationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Registration flow type (admin uses worker token, user uses user token) */\n\tregistrationFlowType?: 'admin' | 'user';\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Configuration Step (Step 0)\n *\n * Handles environment and credential configuration for unified MFA flow.\n */\nexport const UnifiedConfigurationStep: React.FC<UnifiedConfigurationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\ttokenStatus,\n\tdeviceAuthPolicies,\n\tisLoadingPolicies,\n\tpoliciesError,\n\trefreshDeviceAuthPolicies,\n\tshowWorkerTokenModal,\n\tsetShowWorkerTokenModal,\n\tshowUserLoginModal,\n\tsetShowUserLoginModal,\n\tshowSettingsModal,\n\tsetShowSettingsModal,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tregistrationFlowType = 'admin',\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering configuration step for:`, config.deviceType);\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\t// Load saved username from localStorage\n\tconst getSavedUsername = () => {\n\t\ttry {\n\t\t\treturn localStorage.getItem('mfa_unified_username') || credentials.username || '';\n\t\t} catch {\n\t\t\treturn credentials.username || '';\n\t\t}\n\t};\n\n\tconst [environmentId, setEnvironmentId] = useState(credentials.environmentId || '');\n\tconst [username, setUsername] = useState(getSavedUsername);\n\n\t// Registration flow type: 'admin-active', 'admin-activation', or 'user'\n\tconst [flowType, setFlowType] = useState<'admin-active' | 'admin-activation' | 'user'>(\n\t\tregistrationFlowType === 'user' ? 'user' : 'admin-active'\n\t);\n\n\t// Derived token type from flow type\n\tconst tokenType: TokenType = flowType === 'user' ? 'user' : 'worker';\n\n\t// Device status for admin flows\n\tconst adminDeviceStatus = flowType === 'admin-active' ? 'ACTIVE' : 'ACTIVATION_REQUIRED';\n\n\tconst [selectedPolicyId, setSelectedPolicyId] = useState(\n\t\tcredentials.deviceAuthenticationPolicyId || ''\n\t);\n\n\t// Validation errors\n\tconst [errors, setErrors] = useState<Record<string, string>>({});\n\n\t// ========================================================================\n\t// EFFECTS\n\t// ========================================================================\n\n\t/**\n\t * Auto-populate environment ID from worker token if available\n\t */\n\tuseEffect(() => {\n\t\tif (!environmentId && tokenStatus.isValid) {\n\t\t\tconst workerCreds = workerTokenServiceV8.loadCredentialsSync();\n\t\t\tif (workerCreds?.environmentId) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Auto-populating environment ID:`, workerCreds.environmentId);\n\t\t\t\tsetEnvironmentId(workerCreds.environmentId);\n\t\t\t\tsetCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tenvironmentId: workerCreds.environmentId,\n\t\t\t\t\tregion: workerCreds.region || prev.region || 'us',\n\t\t\t\t\tcustomDomain: workerCreds.customDomain || prev.customDomain,\n\t\t\t\t}));\n\t\t\t}\n\t\t}\n\t}, [tokenStatus.isValid, environmentId, setCredentials]);\n\n\t/**\n\t * Save username to localStorage when it changes\n\t */\n\tuseEffect(() => {\n\t\tif (username.trim()) {\n\t\t\ttry {\n\t\t\t\tlocalStorage.setItem('mfa_unified_username', username.trim());\n\t\t\t\tconsole.log(`${MODULE_TAG} Saved username to localStorage`);\n\t\t\t} catch {\n\t\t\t\t// Ignore localStorage errors\n\t\t\t}\n\t\t}\n\t}, [username]);\n\n\t/**\n\t * Auto-select first device authentication policy when loaded\n\t */\n\tuseEffect(() => {\n\t\tif (deviceAuthPolicies.length > 0 && !selectedPolicyId) {\n\t\t\tconst firstPolicy = deviceAuthPolicies[0];\n\t\t\tconsole.log(`${MODULE_TAG} Auto-selecting first policy:`, firstPolicy.name);\n\t\t\tsetSelectedPolicyId(firstPolicy.id);\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceAuthenticationPolicyId: firstPolicy.id,\n\t\t\t}));\n\t\t}\n\t}, [deviceAuthPolicies, selectedPolicyId, setCredentials]);\n\n\t/**\n\t * Sync flow type when registration flow type prop changes\n\t */\n\tuseEffect(() => {\n\t\tif (registrationFlowType === 'user' && flowType !== 'user') {\n\t\t\tconsole.log(`${MODULE_TAG} User registration flow - switching to user flow type`);\n\t\t\tsetFlowType('user');\n\t\t}\n\t}, [registrationFlowType, flowType]);\n\n\t/**\n\t * Track if we've already auto-advanced to prevent loops\n\t */\n\tconst hasAutoAdvanced = useRef(false);\n\n\t/**\n\t * Auto-advance after successful OAuth login for User Flow\n\t * When user returns from OAuth with a token, automatically proceed to next step\n\t */\n\tuseEffect(() => {\n\t\t// Only auto-advance for user flow when we have a user token\n\t\tif (\n\t\t\tflowType === 'user' &&\n\t\t\tcredentials.userToken &&\n\t\t\tenvironmentId.trim() &&\n\t\t\tusername.trim() &&\n\t\t\t!hasAutoAdvanced.current\n\t\t) {\n\t\t\tconsole.log(`${MODULE_TAG} Auto-advancing after OAuth login`);\n\t\t\thasAutoAdvanced.current = true;\n\n\t\t\t// Update credentials with final values\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tenvironmentId: environmentId.trim(),\n\t\t\t\tusername: username.trim(),\n\t\t\t\ttokenType: 'user',\n\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicyId,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t}));\n\n\t\t\t// Small delay to ensure state updates propagate\n\t\t\tsetTimeout(() => {\n\t\t\t\ttoastV8.success('Authentication successful! Proceeding to next step...');\n\t\t\t\tnav.markStepComplete();\n\t\t\t\tnav.goToNext();\n\t\t\t}, 300);\n\t\t}\n\t}, [\n\t\tcredentials.userToken,\n\t\tflowType,\n\t\tenvironmentId,\n\t\tusername,\n\t\tselectedPolicyId,\n\t\tconfig.deviceType,\n\t\tsetCredentials,\n\t\tnav,\n\t]);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Validate configuration fields\n\t */\n\tconst validateConfiguration = useCallback((): boolean => {\n\t\tconst newErrors: Record<string, string> = {};\n\n\t\t// Validate environment ID\n\t\tif (!environmentId.trim()) {\n\t\t\tnewErrors.environmentId = 'Environment ID is required';\n\t\t}\n\n\t\t// Validate username\n\t\tif (!username.trim()) {\n\t\t\tnewErrors.username = 'Username is required';\n\t\t}\n\n\t\t// Validate token based on token type\n\t\tif (tokenType === 'worker') {\n\t\t\tif (!tokenStatus.isValid) {\n\t\t\t\tnewErrors.token = 'Valid worker token is required';\n\t\t\t}\n\t\t} else if (tokenType === 'user') {\n\t\t\tif (!credentials.userToken) {\n\t\t\t\tnewErrors.token = 'User token is required. Please log in.';\n\t\t\t}\n\t\t}\n\n\t\tsetErrors(newErrors);\n\n\t\tif (Object.keys(newErrors).length > 0) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed:`, newErrors);\n\t\t\tnav.setValidationErrors(Object.values(newErrors));\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}, [environmentId, username, tokenType, tokenStatus, credentials, nav]);\n\n\t/**\n\t * Handle continue button click\n\t */\n\tconst handleContinue = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} Continuing to device selection`);\n\n\t\t// Validate configuration\n\t\tif (!validateConfiguration()) {\n\t\t\ttoastV8.error('Please fix the configuration errors');\n\t\t\treturn;\n\t\t}\n\n\t\t// Update credentials with final values\n\t\tsetCredentials((prev) => ({\n\t\t\t...prev,\n\t\t\tenvironmentId: environmentId.trim(),\n\t\t\tusername: username.trim(),\n\t\t\ttokenType,\n\t\t\tdeviceAuthenticationPolicyId: selectedPolicyId,\n\t\t\tdeviceType: config.deviceType,\n\t\t\t// Store device status for admin flows (ACTIVE or ACTIVATION_REQUIRED)\n\t\t\tdeviceStatus: flowType !== 'user' ? adminDeviceStatus : undefined,\n\t\t}));\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to next step (device selection)\n\t\tnav.goToNext();\n\t}, [\n\t\tenvironmentId,\n\t\tusername,\n\t\ttokenType,\n\t\tselectedPolicyId,\n\t\tconfig,\n\t\tvalidateConfiguration,\n\t\tsetCredentials,\n\t\tnav,\n\t\tadminDeviceStatus,\n\t\tflowType,\n\t]);\n\n\t/**\n\t * Handle environment ID change\n\t */\n\tconst handleEnvironmentIdChange = useCallback((value: string) => {\n\t\tsetEnvironmentId(value);\n\t\tsetErrors((prev) => {\n\t\t\tconst { environmentId, ...rest } = prev;\n\t\t\treturn rest;\n\t\t});\n\t}, []);\n\n\t/**\n\t * Handle username change\n\t */\n\tconst handleUsernameChange = useCallback((value: string) => {\n\t\tsetUsername(value);\n\t\tsetErrors((prev) => {\n\t\t\tconst { username, ...rest } = prev;\n\t\t\treturn rest;\n\t\t});\n\t}, []);\n\n\t/**\n\t * Handle flow type change\n\t */\n\tconst handleFlowTypeChange = useCallback(\n\t\t(type: 'admin-active' | 'admin-activation' | 'user') => {\n\t\t\tconsole.log(`${MODULE_TAG} Flow type changed to:`, type);\n\t\t\tsetFlowType(type);\n\t\t\tsetErrors((prev) => {\n\t\t\t\tconst { token, ...rest } = prev;\n\t\t\t\treturn rest;\n\t\t\t});\n\n\t\t\t// Open user login modal when user flow is selected\n\t\t\tif (type === 'user' && !credentials.userToken) {\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t}\n\t\t},\n\t\t[credentials.userToken, setShowUserLoginModal]\n\t);\n\n\t/**\n\t * Handle policy selection change\n\t */\n\tconst handlePolicyChange = useCallback(\n\t\t(policyId: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Policy changed to:`, policyId);\n\t\t\tsetSelectedPolicyId(policyId);\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t}));\n\t\t},\n\t\t[setCredentials]\n\t);\n\n\t// ========================================================================\n\t// COMPUTED PROPERTIES\n\t// ========================================================================\n\n\tconst selectedPolicy = deviceAuthPolicies.find((p) => p.id === selectedPolicyId);\n\tconst canProceed =\n\t\tenvironmentId.trim() &&\n\t\tusername.trim() &&\n\t\t(tokenType === 'worker' ? tokenStatus.isValid : !!credentials.userToken);\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div\n\t\t\tclassName=\"unified-configuration-step\"\n\t\t\tstyle={{\n\t\t\t\tmaxWidth: '900px',\n\t\t\t\tmargin: '0 auto',\n\t\t\t\tpadding: '24px',\n\t\t\t}}\n\t\t>\n\t\t\t{/* Step Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\tboxShadow: '0 4px 12px rgba(139, 92, 246, 0.2)',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<h2\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\tfontSize: '26px',\n\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\tcolor: '#ffffff',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '12px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{config.icon} Configure {config.displayName} Registration\n\t\t\t\t</h2>\n\t\t\t\t<p\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\tEnter your environment and user credentials to begin the registration process.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Configuration Form */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px',\n\t\t\t\t\tboxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',\n\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>\n\t\t\t\t\t{/* Environment ID */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\thtmlFor=\"environmentId\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tEnvironment ID <span style={{ color: '#dc2626' }}>*</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tid=\"environmentId\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\tonChange={(e) => handleEnvironmentIdChange(e.target.value)}\n\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 14px',\n\t\t\t\t\t\t\t\tborder: `1px solid ${errors.environmentId ? '#dc2626' : '#d1d5db'}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#8b5cf6';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(139, 92, 246, 0.1)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = errors.environmentId ? '#dc2626' : '#d1d5db';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\taria-invalid={!!errors.environmentId}\n\t\t\t\t\t\t\taria-describedby={errors.environmentId ? 'environmentId-error' : undefined}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{errors.environmentId && (\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tid=\"environmentId-error\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#dc2626',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{errors.environmentId}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Username */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tUsername <span style={{ color: '#dc2626' }}>*</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\tonChange={(e) => handleUsernameChange(e.target.value)}\n\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 14px',\n\t\t\t\t\t\t\t\tborder: `1px solid ${errors.username ? '#dc2626' : '#d1d5db'}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#8b5cf6';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(139, 92, 246, 0.1)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = errors.username ? '#dc2626' : '#d1d5db';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\taria-invalid={!!errors.username}\n\t\t\t\t\t\t\taria-describedby={errors.username ? 'username-error' : undefined}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{errors.username && (\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tid=\"username-error\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#dc2626',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{errors.username}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Registration Flow Type Selection */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tRegistration Flow <span className=\"required\">*</span>\n\t\t\t\t\t\t\t<MFAInfoButtonV8 contentKey=\"mfa.registrationFlowType\" displayMode=\"modal\" />\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t\t\t\t\tgap: '12px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Admin Flow (ACTIVE) Option */}\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-active' ? '#10b981' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\tbackground: flowType === 'admin-active' ? '#ecfdf5' : '#ffffff',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\tflowType === 'admin-active'\n\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(16, 185, 129, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-active') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#6ee7b7';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f0fdf4';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-active') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"admin-active\"\n\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'admin-active'}\n\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('admin-active')}\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\taccentColor: '#10b981',\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'admin-active' ? '#047857' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüîë Admin Flow (ACTIVE)\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#065f46',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tInstant Activation\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tDevice is created and immediately active. No OTP verification required. Uses\n\t\t\t\t\t\t\t\t\t\t\tWorker Token.\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t\t{/* Admin Flow (ACTIVATION_REQUIRED) Option - Hidden for FIDO2 */}\n\t\t\t\t\t\t\t{config.deviceType !== 'FIDO2' && (\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-activation' ? '#f59e0b' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\t\tbackground: flowType === 'admin-activation' ? '#fffbeb' : '#ffffff',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\tflowType === 'admin-activation'\n\t\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(245, 158, 11, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-activation') {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#fcd34d';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#fefce8';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-activation') {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\t\tvalue=\"admin-activation\"\n\t\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'admin-activation'}\n\t\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('admin-activation')}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\t\taccentColor: '#f59e0b',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'admin-activation' ? '#b45309' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tüîê Admin Flow (ACTIVATION_REQUIRED)\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#fef3c7',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#92400e',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tOTP Required\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tDevice is created pending activation. User must verify with OTP before\n\t\t\t\t\t\t\t\t\t\t\t\tdevice becomes active. Uses Worker Token.\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t\t{/* User Flow Option */}\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'user' ? '#8b5cf6' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\tbackground: flowType === 'user' ? '#f5f3ff' : '#ffffff',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\tflowType === 'user'\n\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(139, 92, 246, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'user') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#c4b5fd';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#faf5ff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'user') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"user\"\n\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'user'}\n\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('user')}\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\taccentColor: '#8b5cf6',\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'user' ? '#6d28d9' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüë§ User Flow\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#ede9fe',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#5b21b6',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tOAuth Login\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tUser authenticates via OAuth and registers their own device. Requires user\n\t\t\t\t\t\t\t\t\t\t\tlogin.\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Token Status Display */}\n\t\t\t\t\t<div className=\"token-status-section\">\n\t\t\t\t\t\t{tokenType === 'worker' && (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={handleEnvironmentIdChange}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{errors.token && (\n\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\tclassName=\"error-message\"\n\t\t\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t\t\t\tstyle={{ marginTop: '12px', display: 'block' }}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{errors.token}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{tokenType === 'user' && (\n\t\t\t\t\t\t\t<div className=\"token-status-card\">\n\t\t\t\t\t\t\t\t<h4>User Token Status</h4>\n\t\t\t\t\t\t\t\t<div className={`status-indicator ${credentials.userToken ? 'valid' : 'invalid'}`}>\n\t\t\t\t\t\t\t\t\t{credentials.userToken ? '‚úì Logged In' : '‚úó Not Logged In'}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUserLoginModal(true)}\n\t\t\t\t\t\t\t\t\tclassName=\"button-link\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{credentials.userToken ? 'Re-authenticate' : 'Login via OAuth'}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{errors.token && (\n\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\tclassName=\"error-message\"\n\t\t\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t\t\t\tstyle={{ marginTop: '12px', display: 'block' }}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{errors.token}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Device Authentication Policy */}\n\t\t\t\t\t{deviceAuthPolicies.length > 0 && (\n\t\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t\t<label htmlFor=\"deviceAuthPolicy\">\n\t\t\t\t\t\t\t\tDevice Authentication Policy\n\t\t\t\t\t\t\t\t<MFAInfoButtonV8 contentKey=\"device.authentication.policy\" displayMode=\"modal\" />\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<select\n\t\t\t\t\t\t\t\tid=\"deviceAuthPolicy\"\n\t\t\t\t\t\t\t\tvalue={selectedPolicyId}\n\t\t\t\t\t\t\t\tonChange={(e) => handlePolicyChange(e.target.value)}\n\t\t\t\t\t\t\t\tdisabled={isLoadingPolicies}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{deviceAuthPolicies.map((policy) => (\n\t\t\t\t\t\t\t\t\t<option key={policy.id} value={policy.id}>\n\t\t\t\t\t\t\t\t\t\t{policy.name}\n\t\t\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t{selectedPolicy?.description && (\n\t\t\t\t\t\t\t\t<p className=\"field-hint\">{selectedPolicy.description}</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* Policy Loading/Error States */}\n\t\t\t\t\t{isLoadingPolicies && (\n\t\t\t\t\t\t<div className=\"loading-indicator\">Loading device authentication policies...</div>\n\t\t\t\t\t)}\n\t\t\t\t\t{policiesError && (\n\t\t\t\t\t\t<div className=\"error-message\" role=\"alert\">\n\t\t\t\t\t\t\t{policiesError}\n\t\t\t\t\t\t\t<button type=\"button\" onClick={refreshDeviceAuthPolicies} className=\"button-link\">\n\t\t\t\t\t\t\t\tRetry\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{/* Action Buttons */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\tjustifyContent: 'flex-end',\n\t\t\t\t\talignItems: 'center',\n\t\t\t\t\tmarginTop: '32px',\n\t\t\t\t\tpaddingTop: '24px',\n\t\t\t\t\tborderTop: '1px solid #e5e7eb',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleContinue}\n\t\t\t\t\tdisabled={!canProceed || isLoading}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: '14px 28px',\n\t\t\t\t\t\tbackground: canProceed && !isLoading ? '#8b5cf6' : '#d1d5db',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\tcolor: canProceed && !isLoading ? '#ffffff' : '#9ca3af',\n\t\t\t\t\t\tcursor: canProceed && !isLoading ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\tboxShadow: canProceed && !isLoading ? '0 4px 12px rgba(139, 92, 246, 0.3)' : 'none',\n\t\t\t\t\t}}\n\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\tif (canProceed && !isLoading) {\n\t\t\t\t\t\t\te.currentTarget.style.background = '#7c3aed';\n\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 16px rgba(139, 92, 246, 0.4)';\n\t\t\t\t\t\t}\n\t\t\t\t\t}}\n\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\tif (canProceed && !isLoading) {\n\t\t\t\t\t\t\te.currentTarget.style.background = '#8b5cf6';\n\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 4px 12px rgba(139, 92, 246, 0.3)';\n\t\t\t\t\t\t}\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Loading...' : 'Next Step ‚Üí'}\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n\nexport default UnifiedConfigurationStep;\n"},"tags":[],"source":null},{"category":"lint/correctness/noUnusedFunctionParameters","severity":"warning","description":"This parameter is unused.","message":[{"elements":[],"content":"This "},{"elements":["Emphasis"],"content":"parameter"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused parameters might be the result of an incomplete refactoring."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedConfigurationStep.tsx"},"span":[2336,2356],"sourceCode":"/**\n * @file UnifiedConfigurationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 0: Configuration - Environment and credential setup\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Configure environment, credentials, and token type before device registration\n *\n * Flow:\n * 1. Enter environment ID, username\n * 2. Select token type (Worker or User)\n * 3. Select device authentication policy (optional)\n * 4. Validate configuration\n * 5. Navigate to device selection step\n *\n * @example\n * <UnifiedConfigurationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   registrationFlowType=\"admin\"\n * />\n */\n\nimport React, { useCallback, useEffect, useRef, useState } from 'react';\nimport { MFAInfoButtonV8 } from '@/v8/components/MFAInfoButtonV8';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport type { TokenType } from '@/v8/flows/shared/MFATypes';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[‚öôÔ∏è UNIFIED-CONFIGURATION-STEP]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedConfigurationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Registration flow type (admin uses worker token, user uses user token) */\n\tregistrationFlowType?: 'admin' | 'user';\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Configuration Step (Step 0)\n *\n * Handles environment and credential configuration for unified MFA flow.\n */\nexport const UnifiedConfigurationStep: React.FC<UnifiedConfigurationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\ttokenStatus,\n\tdeviceAuthPolicies,\n\tisLoadingPolicies,\n\tpoliciesError,\n\trefreshDeviceAuthPolicies,\n\tshowWorkerTokenModal,\n\tsetShowWorkerTokenModal,\n\tshowUserLoginModal,\n\tsetShowUserLoginModal,\n\tshowSettingsModal,\n\tsetShowSettingsModal,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tregistrationFlowType = 'admin',\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering configuration step for:`, config.deviceType);\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\t// Load saved username from localStorage\n\tconst getSavedUsername = () => {\n\t\ttry {\n\t\t\treturn localStorage.getItem('mfa_unified_username') || credentials.username || '';\n\t\t} catch {\n\t\t\treturn credentials.username || '';\n\t\t}\n\t};\n\n\tconst [environmentId, setEnvironmentId] = useState(credentials.environmentId || '');\n\tconst [username, setUsername] = useState(getSavedUsername);\n\n\t// Registration flow type: 'admin-active', 'admin-activation', or 'user'\n\tconst [flowType, setFlowType] = useState<'admin-active' | 'admin-activation' | 'user'>(\n\t\tregistrationFlowType === 'user' ? 'user' : 'admin-active'\n\t);\n\n\t// Derived token type from flow type\n\tconst tokenType: TokenType = flowType === 'user' ? 'user' : 'worker';\n\n\t// Device status for admin flows\n\tconst adminDeviceStatus = flowType === 'admin-active' ? 'ACTIVE' : 'ACTIVATION_REQUIRED';\n\n\tconst [selectedPolicyId, setSelectedPolicyId] = useState(\n\t\tcredentials.deviceAuthenticationPolicyId || ''\n\t);\n\n\t// Validation errors\n\tconst [errors, setErrors] = useState<Record<string, string>>({});\n\n\t// ========================================================================\n\t// EFFECTS\n\t// ========================================================================\n\n\t/**\n\t * Auto-populate environment ID from worker token if available\n\t */\n\tuseEffect(() => {\n\t\tif (!environmentId && tokenStatus.isValid) {\n\t\t\tconst workerCreds = workerTokenServiceV8.loadCredentialsSync();\n\t\t\tif (workerCreds?.environmentId) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Auto-populating environment ID:`, workerCreds.environmentId);\n\t\t\t\tsetEnvironmentId(workerCreds.environmentId);\n\t\t\t\tsetCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tenvironmentId: workerCreds.environmentId,\n\t\t\t\t\tregion: workerCreds.region || prev.region || 'us',\n\t\t\t\t\tcustomDomain: workerCreds.customDomain || prev.customDomain,\n\t\t\t\t}));\n\t\t\t}\n\t\t}\n\t}, [tokenStatus.isValid, environmentId, setCredentials]);\n\n\t/**\n\t * Save username to localStorage when it changes\n\t */\n\tuseEffect(() => {\n\t\tif (username.trim()) {\n\t\t\ttry {\n\t\t\t\tlocalStorage.setItem('mfa_unified_username', username.trim());\n\t\t\t\tconsole.log(`${MODULE_TAG} Saved username to localStorage`);\n\t\t\t} catch {\n\t\t\t\t// Ignore localStorage errors\n\t\t\t}\n\t\t}\n\t}, [username]);\n\n\t/**\n\t * Auto-select first device authentication policy when loaded\n\t */\n\tuseEffect(() => {\n\t\tif (deviceAuthPolicies.length > 0 && !selectedPolicyId) {\n\t\t\tconst firstPolicy = deviceAuthPolicies[0];\n\t\t\tconsole.log(`${MODULE_TAG} Auto-selecting first policy:`, firstPolicy.name);\n\t\t\tsetSelectedPolicyId(firstPolicy.id);\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceAuthenticationPolicyId: firstPolicy.id,\n\t\t\t}));\n\t\t}\n\t}, [deviceAuthPolicies, selectedPolicyId, setCredentials]);\n\n\t/**\n\t * Sync flow type when registration flow type prop changes\n\t */\n\tuseEffect(() => {\n\t\tif (registrationFlowType === 'user' && flowType !== 'user') {\n\t\t\tconsole.log(`${MODULE_TAG} User registration flow - switching to user flow type`);\n\t\t\tsetFlowType('user');\n\t\t}\n\t}, [registrationFlowType, flowType]);\n\n\t/**\n\t * Track if we've already auto-advanced to prevent loops\n\t */\n\tconst hasAutoAdvanced = useRef(false);\n\n\t/**\n\t * Auto-advance after successful OAuth login for User Flow\n\t * When user returns from OAuth with a token, automatically proceed to next step\n\t */\n\tuseEffect(() => {\n\t\t// Only auto-advance for user flow when we have a user token\n\t\tif (\n\t\t\tflowType === 'user' &&\n\t\t\tcredentials.userToken &&\n\t\t\tenvironmentId.trim() &&\n\t\t\tusername.trim() &&\n\t\t\t!hasAutoAdvanced.current\n\t\t) {\n\t\t\tconsole.log(`${MODULE_TAG} Auto-advancing after OAuth login`);\n\t\t\thasAutoAdvanced.current = true;\n\n\t\t\t// Update credentials with final values\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tenvironmentId: environmentId.trim(),\n\t\t\t\tusername: username.trim(),\n\t\t\t\ttokenType: 'user',\n\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicyId,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t}));\n\n\t\t\t// Small delay to ensure state updates propagate\n\t\t\tsetTimeout(() => {\n\t\t\t\ttoastV8.success('Authentication successful! Proceeding to next step...');\n\t\t\t\tnav.markStepComplete();\n\t\t\t\tnav.goToNext();\n\t\t\t}, 300);\n\t\t}\n\t}, [\n\t\tcredentials.userToken,\n\t\tflowType,\n\t\tenvironmentId,\n\t\tusername,\n\t\tselectedPolicyId,\n\t\tconfig.deviceType,\n\t\tsetCredentials,\n\t\tnav,\n\t]);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Validate configuration fields\n\t */\n\tconst validateConfiguration = useCallback((): boolean => {\n\t\tconst newErrors: Record<string, string> = {};\n\n\t\t// Validate environment ID\n\t\tif (!environmentId.trim()) {\n\t\t\tnewErrors.environmentId = 'Environment ID is required';\n\t\t}\n\n\t\t// Validate username\n\t\tif (!username.trim()) {\n\t\t\tnewErrors.username = 'Username is required';\n\t\t}\n\n\t\t// Validate token based on token type\n\t\tif (tokenType === 'worker') {\n\t\t\tif (!tokenStatus.isValid) {\n\t\t\t\tnewErrors.token = 'Valid worker token is required';\n\t\t\t}\n\t\t} else if (tokenType === 'user') {\n\t\t\tif (!credentials.userToken) {\n\t\t\t\tnewErrors.token = 'User token is required. Please log in.';\n\t\t\t}\n\t\t}\n\n\t\tsetErrors(newErrors);\n\n\t\tif (Object.keys(newErrors).length > 0) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed:`, newErrors);\n\t\t\tnav.setValidationErrors(Object.values(newErrors));\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}, [environmentId, username, tokenType, tokenStatus, credentials, nav]);\n\n\t/**\n\t * Handle continue button click\n\t */\n\tconst handleContinue = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} Continuing to device selection`);\n\n\t\t// Validate configuration\n\t\tif (!validateConfiguration()) {\n\t\t\ttoastV8.error('Please fix the configuration errors');\n\t\t\treturn;\n\t\t}\n\n\t\t// Update credentials with final values\n\t\tsetCredentials((prev) => ({\n\t\t\t...prev,\n\t\t\tenvironmentId: environmentId.trim(),\n\t\t\tusername: username.trim(),\n\t\t\ttokenType,\n\t\t\tdeviceAuthenticationPolicyId: selectedPolicyId,\n\t\t\tdeviceType: config.deviceType,\n\t\t\t// Store device status for admin flows (ACTIVE or ACTIVATION_REQUIRED)\n\t\t\tdeviceStatus: flowType !== 'user' ? adminDeviceStatus : undefined,\n\t\t}));\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to next step (device selection)\n\t\tnav.goToNext();\n\t}, [\n\t\tenvironmentId,\n\t\tusername,\n\t\ttokenType,\n\t\tselectedPolicyId,\n\t\tconfig,\n\t\tvalidateConfiguration,\n\t\tsetCredentials,\n\t\tnav,\n\t\tadminDeviceStatus,\n\t\tflowType,\n\t]);\n\n\t/**\n\t * Handle environment ID change\n\t */\n\tconst handleEnvironmentIdChange = useCallback((value: string) => {\n\t\tsetEnvironmentId(value);\n\t\tsetErrors((prev) => {\n\t\t\tconst { environmentId, ...rest } = prev;\n\t\t\treturn rest;\n\t\t});\n\t}, []);\n\n\t/**\n\t * Handle username change\n\t */\n\tconst handleUsernameChange = useCallback((value: string) => {\n\t\tsetUsername(value);\n\t\tsetErrors((prev) => {\n\t\t\tconst { username, ...rest } = prev;\n\t\t\treturn rest;\n\t\t});\n\t}, []);\n\n\t/**\n\t * Handle flow type change\n\t */\n\tconst handleFlowTypeChange = useCallback(\n\t\t(type: 'admin-active' | 'admin-activation' | 'user') => {\n\t\t\tconsole.log(`${MODULE_TAG} Flow type changed to:`, type);\n\t\t\tsetFlowType(type);\n\t\t\tsetErrors((prev) => {\n\t\t\t\tconst { token, ...rest } = prev;\n\t\t\t\treturn rest;\n\t\t\t});\n\n\t\t\t// Open user login modal when user flow is selected\n\t\t\tif (type === 'user' && !credentials.userToken) {\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t}\n\t\t},\n\t\t[credentials.userToken, setShowUserLoginModal]\n\t);\n\n\t/**\n\t * Handle policy selection change\n\t */\n\tconst handlePolicyChange = useCallback(\n\t\t(policyId: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Policy changed to:`, policyId);\n\t\t\tsetSelectedPolicyId(policyId);\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t}));\n\t\t},\n\t\t[setCredentials]\n\t);\n\n\t// ========================================================================\n\t// COMPUTED PROPERTIES\n\t// ========================================================================\n\n\tconst selectedPolicy = deviceAuthPolicies.find((p) => p.id === selectedPolicyId);\n\tconst canProceed =\n\t\tenvironmentId.trim() &&\n\t\tusername.trim() &&\n\t\t(tokenType === 'worker' ? tokenStatus.isValid : !!credentials.userToken);\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div\n\t\t\tclassName=\"unified-configuration-step\"\n\t\t\tstyle={{\n\t\t\t\tmaxWidth: '900px',\n\t\t\t\tmargin: '0 auto',\n\t\t\t\tpadding: '24px',\n\t\t\t}}\n\t\t>\n\t\t\t{/* Step Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\tboxShadow: '0 4px 12px rgba(139, 92, 246, 0.2)',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<h2\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\tfontSize: '26px',\n\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\tcolor: '#ffffff',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '12px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{config.icon} Configure {config.displayName} Registration\n\t\t\t\t</h2>\n\t\t\t\t<p\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\tEnter your environment and user credentials to begin the registration process.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Configuration Form */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px',\n\t\t\t\t\tboxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',\n\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>\n\t\t\t\t\t{/* Environment ID */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\thtmlFor=\"environmentId\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tEnvironment ID <span style={{ color: '#dc2626' }}>*</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tid=\"environmentId\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\tonChange={(e) => handleEnvironmentIdChange(e.target.value)}\n\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 14px',\n\t\t\t\t\t\t\t\tborder: `1px solid ${errors.environmentId ? '#dc2626' : '#d1d5db'}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#8b5cf6';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(139, 92, 246, 0.1)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = errors.environmentId ? '#dc2626' : '#d1d5db';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\taria-invalid={!!errors.environmentId}\n\t\t\t\t\t\t\taria-describedby={errors.environmentId ? 'environmentId-error' : undefined}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{errors.environmentId && (\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tid=\"environmentId-error\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#dc2626',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{errors.environmentId}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Username */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tUsername <span style={{ color: '#dc2626' }}>*</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\tonChange={(e) => handleUsernameChange(e.target.value)}\n\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 14px',\n\t\t\t\t\t\t\t\tborder: `1px solid ${errors.username ? '#dc2626' : '#d1d5db'}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#8b5cf6';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(139, 92, 246, 0.1)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = errors.username ? '#dc2626' : '#d1d5db';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\taria-invalid={!!errors.username}\n\t\t\t\t\t\t\taria-describedby={errors.username ? 'username-error' : undefined}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{errors.username && (\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tid=\"username-error\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#dc2626',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{errors.username}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Registration Flow Type Selection */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tRegistration Flow <span className=\"required\">*</span>\n\t\t\t\t\t\t\t<MFAInfoButtonV8 contentKey=\"mfa.registrationFlowType\" displayMode=\"modal\" />\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t\t\t\t\tgap: '12px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Admin Flow (ACTIVE) Option */}\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-active' ? '#10b981' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\tbackground: flowType === 'admin-active' ? '#ecfdf5' : '#ffffff',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\tflowType === 'admin-active'\n\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(16, 185, 129, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-active') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#6ee7b7';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f0fdf4';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-active') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"admin-active\"\n\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'admin-active'}\n\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('admin-active')}\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\taccentColor: '#10b981',\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'admin-active' ? '#047857' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüîë Admin Flow (ACTIVE)\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#065f46',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tInstant Activation\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tDevice is created and immediately active. No OTP verification required. Uses\n\t\t\t\t\t\t\t\t\t\t\tWorker Token.\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t\t{/* Admin Flow (ACTIVATION_REQUIRED) Option - Hidden for FIDO2 */}\n\t\t\t\t\t\t\t{config.deviceType !== 'FIDO2' && (\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-activation' ? '#f59e0b' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\t\tbackground: flowType === 'admin-activation' ? '#fffbeb' : '#ffffff',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\tflowType === 'admin-activation'\n\t\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(245, 158, 11, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-activation') {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#fcd34d';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#fefce8';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-activation') {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\t\tvalue=\"admin-activation\"\n\t\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'admin-activation'}\n\t\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('admin-activation')}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\t\taccentColor: '#f59e0b',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'admin-activation' ? '#b45309' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tüîê Admin Flow (ACTIVATION_REQUIRED)\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#fef3c7',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#92400e',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tOTP Required\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tDevice is created pending activation. User must verify with OTP before\n\t\t\t\t\t\t\t\t\t\t\t\tdevice becomes active. Uses Worker Token.\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t\t{/* User Flow Option */}\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'user' ? '#8b5cf6' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\tbackground: flowType === 'user' ? '#f5f3ff' : '#ffffff',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\tflowType === 'user'\n\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(139, 92, 246, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'user') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#c4b5fd';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#faf5ff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'user') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"user\"\n\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'user'}\n\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('user')}\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\taccentColor: '#8b5cf6',\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'user' ? '#6d28d9' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüë§ User Flow\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#ede9fe',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#5b21b6',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tOAuth Login\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tUser authenticates via OAuth and registers their own device. Requires user\n\t\t\t\t\t\t\t\t\t\t\tlogin.\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Token Status Display */}\n\t\t\t\t\t<div className=\"token-status-section\">\n\t\t\t\t\t\t{tokenType === 'worker' && (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={handleEnvironmentIdChange}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{errors.token && (\n\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\tclassName=\"error-message\"\n\t\t\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t\t\t\tstyle={{ marginTop: '12px', display: 'block' }}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{errors.token}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{tokenType === 'user' && (\n\t\t\t\t\t\t\t<div className=\"token-status-card\">\n\t\t\t\t\t\t\t\t<h4>User Token Status</h4>\n\t\t\t\t\t\t\t\t<div className={`status-indicator ${credentials.userToken ? 'valid' : 'invalid'}`}>\n\t\t\t\t\t\t\t\t\t{credentials.userToken ? '‚úì Logged In' : '‚úó Not Logged In'}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUserLoginModal(true)}\n\t\t\t\t\t\t\t\t\tclassName=\"button-link\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{credentials.userToken ? 'Re-authenticate' : 'Login via OAuth'}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{errors.token && (\n\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\tclassName=\"error-message\"\n\t\t\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t\t\t\tstyle={{ marginTop: '12px', display: 'block' }}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{errors.token}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Device Authentication Policy */}\n\t\t\t\t\t{deviceAuthPolicies.length > 0 && (\n\t\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t\t<label htmlFor=\"deviceAuthPolicy\">\n\t\t\t\t\t\t\t\tDevice Authentication Policy\n\t\t\t\t\t\t\t\t<MFAInfoButtonV8 contentKey=\"device.authentication.policy\" displayMode=\"modal\" />\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<select\n\t\t\t\t\t\t\t\tid=\"deviceAuthPolicy\"\n\t\t\t\t\t\t\t\tvalue={selectedPolicyId}\n\t\t\t\t\t\t\t\tonChange={(e) => handlePolicyChange(e.target.value)}\n\t\t\t\t\t\t\t\tdisabled={isLoadingPolicies}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{deviceAuthPolicies.map((policy) => (\n\t\t\t\t\t\t\t\t\t<option key={policy.id} value={policy.id}>\n\t\t\t\t\t\t\t\t\t\t{policy.name}\n\t\t\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t{selectedPolicy?.description && (\n\t\t\t\t\t\t\t\t<p className=\"field-hint\">{selectedPolicy.description}</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* Policy Loading/Error States */}\n\t\t\t\t\t{isLoadingPolicies && (\n\t\t\t\t\t\t<div className=\"loading-indicator\">Loading device authentication policies...</div>\n\t\t\t\t\t)}\n\t\t\t\t\t{policiesError && (\n\t\t\t\t\t\t<div className=\"error-message\" role=\"alert\">\n\t\t\t\t\t\t\t{policiesError}\n\t\t\t\t\t\t\t<button type=\"button\" onClick={refreshDeviceAuthPolicies} className=\"button-link\">\n\t\t\t\t\t\t\t\tRetry\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{/* Action Buttons */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\tjustifyContent: 'flex-end',\n\t\t\t\t\talignItems: 'center',\n\t\t\t\t\tmarginTop: '32px',\n\t\t\t\t\tpaddingTop: '24px',\n\t\t\t\t\tborderTop: '1px solid #e5e7eb',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleContinue}\n\t\t\t\t\tdisabled={!canProceed || isLoading}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: '14px 28px',\n\t\t\t\t\t\tbackground: canProceed && !isLoading ? '#8b5cf6' : '#d1d5db',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\tcolor: canProceed && !isLoading ? '#ffffff' : '#9ca3af',\n\t\t\t\t\t\tcursor: canProceed && !isLoading ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\tboxShadow: canProceed && !isLoading ? '0 4px 12px rgba(139, 92, 246, 0.3)' : 'none',\n\t\t\t\t\t}}\n\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\tif (canProceed && !isLoading) {\n\t\t\t\t\t\t\te.currentTarget.style.background = '#7c3aed';\n\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 16px rgba(139, 92, 246, 0.4)';\n\t\t\t\t\t\t}\n\t\t\t\t\t}}\n\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\tif (canProceed && !isLoading) {\n\t\t\t\t\t\t\te.currentTarget.style.background = '#8b5cf6';\n\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 4px 12px rgba(139, 92, 246, 0.3)';\n\t\t\t\t\t\t}\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Loading...' : 'Next Step ‚Üí'}\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n\nexport default UnifiedConfigurationStep;\n"},"tags":[],"source":null},{"category":"lint/correctness/noUnusedFunctionParameters","severity":"warning","description":"This parameter is unused.","message":[{"elements":[],"content":"This "},{"elements":["Emphasis"],"content":"parameter"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused parameters might be the result of an incomplete refactoring."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedConfigurationStep.tsx"},"span":[2371,2383],"sourceCode":"/**\n * @file UnifiedConfigurationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 0: Configuration - Environment and credential setup\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Configure environment, credentials, and token type before device registration\n *\n * Flow:\n * 1. Enter environment ID, username\n * 2. Select token type (Worker or User)\n * 3. Select device authentication policy (optional)\n * 4. Validate configuration\n * 5. Navigate to device selection step\n *\n * @example\n * <UnifiedConfigurationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   registrationFlowType=\"admin\"\n * />\n */\n\nimport React, { useCallback, useEffect, useRef, useState } from 'react';\nimport { MFAInfoButtonV8 } from '@/v8/components/MFAInfoButtonV8';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport type { TokenType } from '@/v8/flows/shared/MFATypes';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[‚öôÔ∏è UNIFIED-CONFIGURATION-STEP]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedConfigurationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Registration flow type (admin uses worker token, user uses user token) */\n\tregistrationFlowType?: 'admin' | 'user';\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Configuration Step (Step 0)\n *\n * Handles environment and credential configuration for unified MFA flow.\n */\nexport const UnifiedConfigurationStep: React.FC<UnifiedConfigurationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\ttokenStatus,\n\tdeviceAuthPolicies,\n\tisLoadingPolicies,\n\tpoliciesError,\n\trefreshDeviceAuthPolicies,\n\tshowWorkerTokenModal,\n\tsetShowWorkerTokenModal,\n\tshowUserLoginModal,\n\tsetShowUserLoginModal,\n\tshowSettingsModal,\n\tsetShowSettingsModal,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tregistrationFlowType = 'admin',\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering configuration step for:`, config.deviceType);\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\t// Load saved username from localStorage\n\tconst getSavedUsername = () => {\n\t\ttry {\n\t\t\treturn localStorage.getItem('mfa_unified_username') || credentials.username || '';\n\t\t} catch {\n\t\t\treturn credentials.username || '';\n\t\t}\n\t};\n\n\tconst [environmentId, setEnvironmentId] = useState(credentials.environmentId || '');\n\tconst [username, setUsername] = useState(getSavedUsername);\n\n\t// Registration flow type: 'admin-active', 'admin-activation', or 'user'\n\tconst [flowType, setFlowType] = useState<'admin-active' | 'admin-activation' | 'user'>(\n\t\tregistrationFlowType === 'user' ? 'user' : 'admin-active'\n\t);\n\n\t// Derived token type from flow type\n\tconst tokenType: TokenType = flowType === 'user' ? 'user' : 'worker';\n\n\t// Device status for admin flows\n\tconst adminDeviceStatus = flowType === 'admin-active' ? 'ACTIVE' : 'ACTIVATION_REQUIRED';\n\n\tconst [selectedPolicyId, setSelectedPolicyId] = useState(\n\t\tcredentials.deviceAuthenticationPolicyId || ''\n\t);\n\n\t// Validation errors\n\tconst [errors, setErrors] = useState<Record<string, string>>({});\n\n\t// ========================================================================\n\t// EFFECTS\n\t// ========================================================================\n\n\t/**\n\t * Auto-populate environment ID from worker token if available\n\t */\n\tuseEffect(() => {\n\t\tif (!environmentId && tokenStatus.isValid) {\n\t\t\tconst workerCreds = workerTokenServiceV8.loadCredentialsSync();\n\t\t\tif (workerCreds?.environmentId) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Auto-populating environment ID:`, workerCreds.environmentId);\n\t\t\t\tsetEnvironmentId(workerCreds.environmentId);\n\t\t\t\tsetCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tenvironmentId: workerCreds.environmentId,\n\t\t\t\t\tregion: workerCreds.region || prev.region || 'us',\n\t\t\t\t\tcustomDomain: workerCreds.customDomain || prev.customDomain,\n\t\t\t\t}));\n\t\t\t}\n\t\t}\n\t}, [tokenStatus.isValid, environmentId, setCredentials]);\n\n\t/**\n\t * Save username to localStorage when it changes\n\t */\n\tuseEffect(() => {\n\t\tif (username.trim()) {\n\t\t\ttry {\n\t\t\t\tlocalStorage.setItem('mfa_unified_username', username.trim());\n\t\t\t\tconsole.log(`${MODULE_TAG} Saved username to localStorage`);\n\t\t\t} catch {\n\t\t\t\t// Ignore localStorage errors\n\t\t\t}\n\t\t}\n\t}, [username]);\n\n\t/**\n\t * Auto-select first device authentication policy when loaded\n\t */\n\tuseEffect(() => {\n\t\tif (deviceAuthPolicies.length > 0 && !selectedPolicyId) {\n\t\t\tconst firstPolicy = deviceAuthPolicies[0];\n\t\t\tconsole.log(`${MODULE_TAG} Auto-selecting first policy:`, firstPolicy.name);\n\t\t\tsetSelectedPolicyId(firstPolicy.id);\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceAuthenticationPolicyId: firstPolicy.id,\n\t\t\t}));\n\t\t}\n\t}, [deviceAuthPolicies, selectedPolicyId, setCredentials]);\n\n\t/**\n\t * Sync flow type when registration flow type prop changes\n\t */\n\tuseEffect(() => {\n\t\tif (registrationFlowType === 'user' && flowType !== 'user') {\n\t\t\tconsole.log(`${MODULE_TAG} User registration flow - switching to user flow type`);\n\t\t\tsetFlowType('user');\n\t\t}\n\t}, [registrationFlowType, flowType]);\n\n\t/**\n\t * Track if we've already auto-advanced to prevent loops\n\t */\n\tconst hasAutoAdvanced = useRef(false);\n\n\t/**\n\t * Auto-advance after successful OAuth login for User Flow\n\t * When user returns from OAuth with a token, automatically proceed to next step\n\t */\n\tuseEffect(() => {\n\t\t// Only auto-advance for user flow when we have a user token\n\t\tif (\n\t\t\tflowType === 'user' &&\n\t\t\tcredentials.userToken &&\n\t\t\tenvironmentId.trim() &&\n\t\t\tusername.trim() &&\n\t\t\t!hasAutoAdvanced.current\n\t\t) {\n\t\t\tconsole.log(`${MODULE_TAG} Auto-advancing after OAuth login`);\n\t\t\thasAutoAdvanced.current = true;\n\n\t\t\t// Update credentials with final values\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tenvironmentId: environmentId.trim(),\n\t\t\t\tusername: username.trim(),\n\t\t\t\ttokenType: 'user',\n\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicyId,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t}));\n\n\t\t\t// Small delay to ensure state updates propagate\n\t\t\tsetTimeout(() => {\n\t\t\t\ttoastV8.success('Authentication successful! Proceeding to next step...');\n\t\t\t\tnav.markStepComplete();\n\t\t\t\tnav.goToNext();\n\t\t\t}, 300);\n\t\t}\n\t}, [\n\t\tcredentials.userToken,\n\t\tflowType,\n\t\tenvironmentId,\n\t\tusername,\n\t\tselectedPolicyId,\n\t\tconfig.deviceType,\n\t\tsetCredentials,\n\t\tnav,\n\t]);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Validate configuration fields\n\t */\n\tconst validateConfiguration = useCallback((): boolean => {\n\t\tconst newErrors: Record<string, string> = {};\n\n\t\t// Validate environment ID\n\t\tif (!environmentId.trim()) {\n\t\t\tnewErrors.environmentId = 'Environment ID is required';\n\t\t}\n\n\t\t// Validate username\n\t\tif (!username.trim()) {\n\t\t\tnewErrors.username = 'Username is required';\n\t\t}\n\n\t\t// Validate token based on token type\n\t\tif (tokenType === 'worker') {\n\t\t\tif (!tokenStatus.isValid) {\n\t\t\t\tnewErrors.token = 'Valid worker token is required';\n\t\t\t}\n\t\t} else if (tokenType === 'user') {\n\t\t\tif (!credentials.userToken) {\n\t\t\t\tnewErrors.token = 'User token is required. Please log in.';\n\t\t\t}\n\t\t}\n\n\t\tsetErrors(newErrors);\n\n\t\tif (Object.keys(newErrors).length > 0) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed:`, newErrors);\n\t\t\tnav.setValidationErrors(Object.values(newErrors));\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}, [environmentId, username, tokenType, tokenStatus, credentials, nav]);\n\n\t/**\n\t * Handle continue button click\n\t */\n\tconst handleContinue = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} Continuing to device selection`);\n\n\t\t// Validate configuration\n\t\tif (!validateConfiguration()) {\n\t\t\ttoastV8.error('Please fix the configuration errors');\n\t\t\treturn;\n\t\t}\n\n\t\t// Update credentials with final values\n\t\tsetCredentials((prev) => ({\n\t\t\t...prev,\n\t\t\tenvironmentId: environmentId.trim(),\n\t\t\tusername: username.trim(),\n\t\t\ttokenType,\n\t\t\tdeviceAuthenticationPolicyId: selectedPolicyId,\n\t\t\tdeviceType: config.deviceType,\n\t\t\t// Store device status for admin flows (ACTIVE or ACTIVATION_REQUIRED)\n\t\t\tdeviceStatus: flowType !== 'user' ? adminDeviceStatus : undefined,\n\t\t}));\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to next step (device selection)\n\t\tnav.goToNext();\n\t}, [\n\t\tenvironmentId,\n\t\tusername,\n\t\ttokenType,\n\t\tselectedPolicyId,\n\t\tconfig,\n\t\tvalidateConfiguration,\n\t\tsetCredentials,\n\t\tnav,\n\t\tadminDeviceStatus,\n\t\tflowType,\n\t]);\n\n\t/**\n\t * Handle environment ID change\n\t */\n\tconst handleEnvironmentIdChange = useCallback((value: string) => {\n\t\tsetEnvironmentId(value);\n\t\tsetErrors((prev) => {\n\t\t\tconst { environmentId, ...rest } = prev;\n\t\t\treturn rest;\n\t\t});\n\t}, []);\n\n\t/**\n\t * Handle username change\n\t */\n\tconst handleUsernameChange = useCallback((value: string) => {\n\t\tsetUsername(value);\n\t\tsetErrors((prev) => {\n\t\t\tconst { username, ...rest } = prev;\n\t\t\treturn rest;\n\t\t});\n\t}, []);\n\n\t/**\n\t * Handle flow type change\n\t */\n\tconst handleFlowTypeChange = useCallback(\n\t\t(type: 'admin-active' | 'admin-activation' | 'user') => {\n\t\t\tconsole.log(`${MODULE_TAG} Flow type changed to:`, type);\n\t\t\tsetFlowType(type);\n\t\t\tsetErrors((prev) => {\n\t\t\t\tconst { token, ...rest } = prev;\n\t\t\t\treturn rest;\n\t\t\t});\n\n\t\t\t// Open user login modal when user flow is selected\n\t\t\tif (type === 'user' && !credentials.userToken) {\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t}\n\t\t},\n\t\t[credentials.userToken, setShowUserLoginModal]\n\t);\n\n\t/**\n\t * Handle policy selection change\n\t */\n\tconst handlePolicyChange = useCallback(\n\t\t(policyId: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Policy changed to:`, policyId);\n\t\t\tsetSelectedPolicyId(policyId);\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t}));\n\t\t},\n\t\t[setCredentials]\n\t);\n\n\t// ========================================================================\n\t// COMPUTED PROPERTIES\n\t// ========================================================================\n\n\tconst selectedPolicy = deviceAuthPolicies.find((p) => p.id === selectedPolicyId);\n\tconst canProceed =\n\t\tenvironmentId.trim() &&\n\t\tusername.trim() &&\n\t\t(tokenType === 'worker' ? tokenStatus.isValid : !!credentials.userToken);\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div\n\t\t\tclassName=\"unified-configuration-step\"\n\t\t\tstyle={{\n\t\t\t\tmaxWidth: '900px',\n\t\t\t\tmargin: '0 auto',\n\t\t\t\tpadding: '24px',\n\t\t\t}}\n\t\t>\n\t\t\t{/* Step Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\tboxShadow: '0 4px 12px rgba(139, 92, 246, 0.2)',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<h2\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\tfontSize: '26px',\n\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\tcolor: '#ffffff',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '12px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{config.icon} Configure {config.displayName} Registration\n\t\t\t\t</h2>\n\t\t\t\t<p\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\tEnter your environment and user credentials to begin the registration process.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Configuration Form */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px',\n\t\t\t\t\tboxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',\n\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>\n\t\t\t\t\t{/* Environment ID */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\thtmlFor=\"environmentId\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tEnvironment ID <span style={{ color: '#dc2626' }}>*</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tid=\"environmentId\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\tonChange={(e) => handleEnvironmentIdChange(e.target.value)}\n\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 14px',\n\t\t\t\t\t\t\t\tborder: `1px solid ${errors.environmentId ? '#dc2626' : '#d1d5db'}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#8b5cf6';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(139, 92, 246, 0.1)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = errors.environmentId ? '#dc2626' : '#d1d5db';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\taria-invalid={!!errors.environmentId}\n\t\t\t\t\t\t\taria-describedby={errors.environmentId ? 'environmentId-error' : undefined}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{errors.environmentId && (\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tid=\"environmentId-error\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#dc2626',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{errors.environmentId}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Username */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tUsername <span style={{ color: '#dc2626' }}>*</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\tonChange={(e) => handleUsernameChange(e.target.value)}\n\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 14px',\n\t\t\t\t\t\t\t\tborder: `1px solid ${errors.username ? '#dc2626' : '#d1d5db'}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#8b5cf6';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(139, 92, 246, 0.1)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = errors.username ? '#dc2626' : '#d1d5db';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\taria-invalid={!!errors.username}\n\t\t\t\t\t\t\taria-describedby={errors.username ? 'username-error' : undefined}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{errors.username && (\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tid=\"username-error\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#dc2626',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{errors.username}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Registration Flow Type Selection */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tRegistration Flow <span className=\"required\">*</span>\n\t\t\t\t\t\t\t<MFAInfoButtonV8 contentKey=\"mfa.registrationFlowType\" displayMode=\"modal\" />\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t\t\t\t\tgap: '12px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Admin Flow (ACTIVE) Option */}\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-active' ? '#10b981' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\tbackground: flowType === 'admin-active' ? '#ecfdf5' : '#ffffff',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\tflowType === 'admin-active'\n\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(16, 185, 129, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-active') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#6ee7b7';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f0fdf4';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-active') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"admin-active\"\n\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'admin-active'}\n\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('admin-active')}\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\taccentColor: '#10b981',\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'admin-active' ? '#047857' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüîë Admin Flow (ACTIVE)\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#065f46',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tInstant Activation\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tDevice is created and immediately active. No OTP verification required. Uses\n\t\t\t\t\t\t\t\t\t\t\tWorker Token.\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t\t{/* Admin Flow (ACTIVATION_REQUIRED) Option - Hidden for FIDO2 */}\n\t\t\t\t\t\t\t{config.deviceType !== 'FIDO2' && (\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-activation' ? '#f59e0b' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\t\tbackground: flowType === 'admin-activation' ? '#fffbeb' : '#ffffff',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\tflowType === 'admin-activation'\n\t\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(245, 158, 11, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-activation') {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#fcd34d';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#fefce8';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-activation') {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\t\tvalue=\"admin-activation\"\n\t\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'admin-activation'}\n\t\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('admin-activation')}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\t\taccentColor: '#f59e0b',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'admin-activation' ? '#b45309' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tüîê Admin Flow (ACTIVATION_REQUIRED)\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#fef3c7',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#92400e',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tOTP Required\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tDevice is created pending activation. User must verify with OTP before\n\t\t\t\t\t\t\t\t\t\t\t\tdevice becomes active. Uses Worker Token.\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t\t{/* User Flow Option */}\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'user' ? '#8b5cf6' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\tbackground: flowType === 'user' ? '#f5f3ff' : '#ffffff',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\tflowType === 'user'\n\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(139, 92, 246, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'user') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#c4b5fd';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#faf5ff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'user') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"user\"\n\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'user'}\n\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('user')}\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\taccentColor: '#8b5cf6',\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'user' ? '#6d28d9' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüë§ User Flow\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#ede9fe',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#5b21b6',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tOAuth Login\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tUser authenticates via OAuth and registers their own device. Requires user\n\t\t\t\t\t\t\t\t\t\t\tlogin.\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Token Status Display */}\n\t\t\t\t\t<div className=\"token-status-section\">\n\t\t\t\t\t\t{tokenType === 'worker' && (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={handleEnvironmentIdChange}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{errors.token && (\n\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\tclassName=\"error-message\"\n\t\t\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t\t\t\tstyle={{ marginTop: '12px', display: 'block' }}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{errors.token}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{tokenType === 'user' && (\n\t\t\t\t\t\t\t<div className=\"token-status-card\">\n\t\t\t\t\t\t\t\t<h4>User Token Status</h4>\n\t\t\t\t\t\t\t\t<div className={`status-indicator ${credentials.userToken ? 'valid' : 'invalid'}`}>\n\t\t\t\t\t\t\t\t\t{credentials.userToken ? '‚úì Logged In' : '‚úó Not Logged In'}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUserLoginModal(true)}\n\t\t\t\t\t\t\t\t\tclassName=\"button-link\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{credentials.userToken ? 'Re-authenticate' : 'Login via OAuth'}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{errors.token && (\n\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\tclassName=\"error-message\"\n\t\t\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t\t\t\tstyle={{ marginTop: '12px', display: 'block' }}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{errors.token}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Device Authentication Policy */}\n\t\t\t\t\t{deviceAuthPolicies.length > 0 && (\n\t\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t\t<label htmlFor=\"deviceAuthPolicy\">\n\t\t\t\t\t\t\t\tDevice Authentication Policy\n\t\t\t\t\t\t\t\t<MFAInfoButtonV8 contentKey=\"device.authentication.policy\" displayMode=\"modal\" />\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<select\n\t\t\t\t\t\t\t\tid=\"deviceAuthPolicy\"\n\t\t\t\t\t\t\t\tvalue={selectedPolicyId}\n\t\t\t\t\t\t\t\tonChange={(e) => handlePolicyChange(e.target.value)}\n\t\t\t\t\t\t\t\tdisabled={isLoadingPolicies}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{deviceAuthPolicies.map((policy) => (\n\t\t\t\t\t\t\t\t\t<option key={policy.id} value={policy.id}>\n\t\t\t\t\t\t\t\t\t\t{policy.name}\n\t\t\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t{selectedPolicy?.description && (\n\t\t\t\t\t\t\t\t<p className=\"field-hint\">{selectedPolicy.description}</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* Policy Loading/Error States */}\n\t\t\t\t\t{isLoadingPolicies && (\n\t\t\t\t\t\t<div className=\"loading-indicator\">Loading device authentication policies...</div>\n\t\t\t\t\t)}\n\t\t\t\t\t{policiesError && (\n\t\t\t\t\t\t<div className=\"error-message\" role=\"alert\">\n\t\t\t\t\t\t\t{policiesError}\n\t\t\t\t\t\t\t<button type=\"button\" onClick={refreshDeviceAuthPolicies} className=\"button-link\">\n\t\t\t\t\t\t\t\tRetry\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{/* Action Buttons */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\tjustifyContent: 'flex-end',\n\t\t\t\t\talignItems: 'center',\n\t\t\t\t\tmarginTop: '32px',\n\t\t\t\t\tpaddingTop: '24px',\n\t\t\t\t\tborderTop: '1px solid #e5e7eb',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleContinue}\n\t\t\t\t\tdisabled={!canProceed || isLoading}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: '14px 28px',\n\t\t\t\t\t\tbackground: canProceed && !isLoading ? '#8b5cf6' : '#d1d5db',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\tcolor: canProceed && !isLoading ? '#ffffff' : '#9ca3af',\n\t\t\t\t\t\tcursor: canProceed && !isLoading ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\tboxShadow: canProceed && !isLoading ? '0 4px 12px rgba(139, 92, 246, 0.3)' : 'none',\n\t\t\t\t\t}}\n\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\tif (canProceed && !isLoading) {\n\t\t\t\t\t\t\te.currentTarget.style.background = '#7c3aed';\n\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 16px rgba(139, 92, 246, 0.4)';\n\t\t\t\t\t\t}\n\t\t\t\t\t}}\n\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\tif (canProceed && !isLoading) {\n\t\t\t\t\t\t\te.currentTarget.style.background = '#8b5cf6';\n\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 4px 12px rgba(139, 92, 246, 0.3)';\n\t\t\t\t\t\t}\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Loading...' : 'Next Step ‚Üí'}\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n\nexport default UnifiedConfigurationStep;\n"},"tags":[],"source":null},{"category":"lint/correctness/noUnusedFunctionParameters","severity":"warning","description":"This parameter is unused.","message":[{"elements":[],"content":"This "},{"elements":["Emphasis"],"content":"parameter"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused parameters might be the result of an incomplete refactoring."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedDeviceRegistrationForm.tsx"},"span":[3011,3019],"sourceCode":"/**\n * @file UnifiedDeviceRegistrationForm.tsx\n * @module v8/flows/unified/components\n * @description Combined device type selection + info input form\n * @version 9.2.0\n * @since 2026-01-29\n *\n * Purpose: Single form showing all device types with their input fields\n * Users can see all options and fill in the appropriate fields in one view\n */\n\nimport React, { useCallback, useEffect, useMemo, useState } from 'react';\nimport FIDO2RegistrationModal from '@/components/FIDO2RegistrationModal';\nimport { Button } from '@/v8/components/Button';\nimport { PageTransition } from '@/v8/components/PageTransition';\nimport type { SearchableDropdownOption } from '@/v8/components/SearchableDropdownV8';\nimport { SearchableDropdownV8 } from '@/v8/components/SearchableDropdownV8';\nimport { getDeviceConfig } from '@/v8/config/deviceFlowConfigs';\nimport type { DeviceConfigKey } from '@/v8/config/deviceFlowConfigTypes';\nimport { useUserSearch } from '@/v8/hooks/useUserSearch';\nimport { useWorkerToken } from '@/v8/hooks/useWorkerToken';\nimport type { TokenStatusInfo } from '@/v8/services/workerTokenStatusServiceV8';\nimport { colors, spacing } from '@/v8/styles/designTokens';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { APIComparisonModal } from './APIComparisonModal';\nimport { DynamicFormRenderer } from './DynamicFormRenderer';\nimport '../UnifiedMFAFlow.css';\n\nconst MODULE_TAG = '[üìù UNIFIED-DEVICE-REG-FORM]';\n\ninterface DeviceTypeTab {\n\tkey: DeviceConfigKey;\n\ticon: string;\n\tlabel: string;\n\tdescription: string;\n}\n\nconst DEVICE_TABS: DeviceTypeTab[] = [\n\t{ key: 'SMS', icon: 'üì±', label: 'SMS', description: 'Text message verification' },\n\t{ key: 'EMAIL', icon: '‚úâÔ∏è', label: 'Email', description: 'Email verification' },\n\t{ key: 'TOTP', icon: 'üîê', label: 'Authenticator', description: 'App-based codes' },\n\t{ key: 'MOBILE', icon: 'üì≤', label: 'Mobile Push', description: 'Push notifications' },\n\t{ key: 'WHATSAPP', icon: 'üí¨', label: 'WhatsApp', description: 'WhatsApp messages' },\n\t{ key: 'FIDO2', icon: 'üîë', label: 'Security Key / FIDO2', description: 'Hardware key/passkey' },\n];\n\ntype FlowType = 'admin-active' | 'admin-activation' | 'user';\n\nexport interface UnifiedDeviceRegistrationFormProps {\n\tonSubmit: (\n\t\tdeviceType: DeviceConfigKey,\n\t\tfields: Record<string, string>,\n\t\tflowType: FlowType\n\t) => void;\n\tonCancel: () => void;\n\tisLoading?: boolean;\n\t/** Initial device type to select (defaults to SMS) */\n\tinitialDeviceType?: DeviceConfigKey;\n\t/** Token status for validation */\n\ttokenStatus: TokenStatusInfo;\n\t/** Registration error to display */\n\tregistrationError?: string | null;\n\t/** Callback to clear error */\n\tonClearError?: () => void;\n\t/** Username for FIDO2 registration */\n\tusername?: string;\n\t/** Callback to update username */\n\tonUsernameChange?: (username: string) => void;\n\t/** Environment ID for user search */\n\tenvironmentId?: string;\n}\n\nexport const UnifiedDeviceRegistrationForm: React.FC<UnifiedDeviceRegistrationFormProps> = ({\n\tonSubmit,\n\tonCancel,\n\tisLoading = false,\n\tinitialDeviceType = 'SMS',\n\ttokenStatus,\n\tregistrationError,\n\tonClearError,\n\tusername,\n\tonUsernameChange,\n\tenvironmentId,\n}) => {\n\tconst [selectedTab, setSelectedTab] = useState<DeviceConfigKey>(initialDeviceType);\n\tconst [flowType, setFlowType] = useState<FlowType>('admin-active');\n\n\t// User search functionality for username dropdown\n\tconst {\n\t\tusers,\n\t\tisLoading: isLoadingUsers,\n\t\tsetSearchQuery,\n\t} = useUserSearch({\n\t\tenvironmentId: environmentId || '',\n\t\ttokenValid: tokenStatus.isValid,\n\t\tmaxPages: 100,\n\t});\n\n\t// Worker token for user search\n\tconst { tokenStatus: workerTokenStatus } = useWorkerToken();\n\n\t// Format users for dropdown\n\tconst userOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tArray.from(\n\t\t\t\tnew Map(\n\t\t\t\t\t(Array.isArray(users) ? users : []).map((user) => [\n\t\t\t\t\t\tuser.username,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvalue: user.username,\n\t\t\t\t\t\t\tlabel: user.username,\n\t\t\t\t\t\t\t...(user.email ? { secondaryLabel: user.email } : {}),\n\t\t\t\t\t\t} as SearchableDropdownOption,\n\t\t\t\t\t])\n\t\t\t\t).values()\n\t\t\t),\n\t\t[users]\n\t);\n\n\t// Debug logging for flowType changes\n\tuseEffect(() => {\n\t\tconsole.log('üîç [FLOW TYPE DEBUG] flowType state changed:', flowType);\n\t}, [flowType]);\n\n\t// Debug logging on mount\n\tuseEffect(() => {\n\t\tconsole.log('üîç [FLOW TYPE DEBUG] UnifiedDeviceRegistrationForm mounted');\n\t\tconsole.log('üîç [FLOW TYPE DEBUG] Initial flowType:', flowType);\n\t\tconsole.log('üîç [FLOW TYPE DEBUG] Initial selectedTab:', selectedTab);\n\t}, [flowType, selectedTab]);\n\n\tconst [deviceFields, setDeviceFields] = useState<Record<DeviceConfigKey, Record<string, string>>>(\n\t\t() => {\n\t\t\t// Initialize with saved values from localStorage\n\t\t\tconst savedPhone = localStorage.getItem('mfa_saved_phoneNumber');\n\t\t\tconst savedCountryCode = localStorage.getItem('mfa_saved_countryCode');\n\t\t\tconst savedEmail = localStorage.getItem('mfa_saved_email');\n\n\t\t\tconst initialFields: Record<DeviceConfigKey, Record<string, string>> = {\n\t\t\t\tSMS: { name: 'SMS', nickname: 'MyKnickName' },\n\t\t\t\tEMAIL: { name: 'EMAIL', nickname: 'MyKnickName' },\n\t\t\t\tTOTP: { name: 'TOTP', nickname: 'MyKnickName' },\n\t\t\t\tMOBILE: { name: 'MOBILE', nickname: 'MyKnickName' },\n\t\t\t\tWHATSAPP: { name: 'WHATSAPP', nickname: 'MyKnickName' },\n\t\t\t\tFIDO2: { name: 'FIDO2', nickname: 'MyKnickName' },\n\t\t\t};\n\n\t\t\t// Restore saved values if available\n\t\t\tif (savedPhone) {\n\t\t\t\tinitialFields.SMS = { ...initialFields.SMS, phoneNumber: savedPhone };\n\t\t\t}\n\t\t\tif (savedCountryCode) {\n\t\t\t\tinitialFields.SMS = { ...initialFields.SMS, countryCode: savedCountryCode };\n\t\t\t\tinitialFields.SMS.countryCode = savedCountryCode;\n\t\t\t\tinitialFields.WHATSAPP.countryCode = savedCountryCode;\n\t\t\t}\n\t\t\tif (savedEmail) {\n\t\t\t\tinitialFields.EMAIL.email = savedEmail;\n\t\t\t}\n\n\t\t\treturn initialFields;\n\t\t}\n\t);\n\tconst [errors, setErrors] = useState<Record<string, string>>({});\n\tconst [showApiModal, setShowApiModal] = useState(false);\n\tconst [showFido2Modal, setShowFido2Modal] = useState(false);\n\n\tconst config = getDeviceConfig(selectedTab);\n\n\tconst handleFieldChange = useCallback(\n\t\t(field: string, value: string) => {\n\t\t\tsetDeviceFields((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t[selectedTab]: {\n\t\t\t\t\t...prev[selectedTab],\n\t\t\t\t\t[field]: value,\n\t\t\t\t},\n\t\t\t}));\n\t\t\t// Clear error for this field\n\t\t\tif (errors[field]) {\n\t\t\t\tsetErrors((prev) => {\n\t\t\t\t\tconst newErrors = { ...prev };\n\t\t\t\t\tdelete newErrors[field];\n\t\t\t\t\treturn newErrors;\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t\t[selectedTab, errors]\n\t);\n\n\tconst handleSubmit = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} Submitting registration for:`, selectedTab, 'Flow type:', flowType);\n\t\tconst fields = deviceFields[selectedTab];\n\n\t\t// ========== DEBUG: FORM SUBMISSION ==========\n\t\tconsole.log('üîç [FORM DEBUG] Submit handler called:', {\n\t\t\tselectedTab,\n\t\t\tflowType,\n\t\t\tfields,\n\t\t\ttokenIsValid: tokenStatus.isValid,\n\t\t\thasOnSubmit: !!onSubmit,\n\t\t});\n\t\t// ============================================\n\n\t\t// Check worker token status\n\t\tif (!tokenStatus.isValid) {\n\t\t\ttoastV8.error('Worker token is invalid or expired. Please refresh the worker token.');\n\t\t\tconsole.log('üîç [FORM DEBUG] Token invalid, blocking submission');\n\t\t\treturn;\n\t\t}\n\n\t\t// Basic validation\n\t\tconst requiredFields = config.requiredFields || [];\n\t\tconst newErrors: Record<string, string> = {};\n\n\t\trequiredFields.forEach((field) => {\n\t\t\tif (!fields[field]?.trim()) {\n\t\t\t\tnewErrors[field] = `${field} is required`;\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(newErrors).length > 0) {\n\t\t\tsetErrors(newErrors);\n\t\t\tconsole.log('üîç [FORM DEBUG] Validation errors:', newErrors);\n\t\t\treturn;\n\t\t}\n\n\t\tconsole.log('üîç [FORM DEBUG] Calling onSubmit callback');\n\n\t\t// Special handling for FIDO2\n\t\tif (selectedTab === 'FIDO2') {\n\t\t\tsetShowFido2Modal(true);\n\t\t\treturn;\n\t\t}\n\n\t\tonSubmit(selectedTab, fields, flowType);\n\t}, [selectedTab, deviceFields, config, onSubmit, flowType, tokenStatus]);\n\n\tconst handleFido2Success = useCallback(\n\t\t(credentialId: string, publicKey: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} FIDO2 registration successful`, { credentialId });\n\t\t\ttoastV8.success('FIDO2 device registered successfully!');\n\t\t\tsetShowFido2Modal(false);\n\n\t\t\t// Update device fields with FIDO2 data\n\t\t\tconst fido2Fields = {\n\t\t\t\t...deviceFields.FIDO2,\n\t\t\t\tcredentialId,\n\t\t\t\tpublicKey,\n\t\t\t};\n\n\t\t\t// Submit FIDO2 registration\n\t\t\tonSubmit('FIDO2', fido2Fields, flowType);\n\t\t},\n\t\t[deviceFields, flowType, onSubmit]\n\t);\n\n\treturn (\n\t\t<PageTransition>\n\t\t\t<div style={{ maxWidth: '900px', margin: '0 auto', padding: spacing[6] }}>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div style={{ marginBottom: spacing[6] }}>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\talignItems: 'flex-start',\n\t\t\t\t\t\t\tmarginBottom: spacing[2],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\tstyle={{ margin: 0, fontSize: '24px', fontWeight: '700', color: colors.gray[900] }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tRegister MFA Device\n\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t<p style={{ margin: '4px 0 0 0', fontSize: '14px', color: colors.gray[600] }}>\n\t\t\t\t\t\t\t\tSelect a device type and enter the required information\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tvariant=\"secondary\"\n\t\t\t\t\t\t\tonClick={() => setShowApiModal(true)}\n\t\t\t\t\t\t\tstyle={{ fontSize: '12px', padding: '8px 12px' }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîç API Comparison\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Flow Type Selection */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\tborder: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tpadding: spacing[4],\n\t\t\t\t\t\tmarginBottom: spacing[6],\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<h3\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tmargin: `0 0 ${spacing[3]}`,\n\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcolor: colors.gray[900],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tRegistration Flow Type\n\t\t\t\t\t</h3>\n\t\t\t\t\t<div style={{ display: 'flex', flexDirection: 'column', gap: spacing[3] }}>\n\t\t\t\t\t\t{/* Admin Flow */}\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\talignItems: 'flex-start',\n\t\t\t\t\t\t\t\tgap: spacing[2],\n\t\t\t\t\t\t\t\tpadding: spacing[3],\n\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-active' ? colors.primary[500] : colors.gray[200]}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tbackground: flowType === 'admin-active' ? colors.primary[50] : 'transparent',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\tvalue=\"admin-active\"\n\t\t\t\t\t\t\t\tchecked={flowType === 'admin-active'}\n\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\tconsole.log('üîç [FLOW TYPE DEBUG] Admin Flow radio selected');\n\t\t\t\t\t\t\t\t\tconsole.log('üîç [FLOW TYPE DEBUG] New value:', e.target.value);\n\t\t\t\t\t\t\t\t\tsetFlowType(e.target.value as FlowType);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{ marginTop: '2px', cursor: 'pointer' }}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<div style={{ fontWeight: '600', color: colors.gray[900], marginBottom: '4px' }}>\n\t\t\t\t\t\t\t\t\tAdmin Flow (Direct Registration)\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div style={{ fontSize: '13px', color: colors.gray[600] }}>\n\t\t\t\t\t\t\t\t\tRegister device directly as admin. Device is immediately active and ready to use.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t{/* Admin with Activation Required - Hide for FIDO2 (no OTP activation needed) */}\n\t\t\t\t\t\t{selectedTab !== 'FIDO2' && (\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\talignItems: 'flex-start',\n\t\t\t\t\t\t\t\t\tgap: spacing[2],\n\t\t\t\t\t\t\t\t\tpadding: spacing[3],\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-activation' ? colors.primary[500] : colors.gray[200]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\tbackground: flowType === 'admin-activation' ? colors.primary[50] : 'transparent',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\tvalue=\"admin-activation\"\n\t\t\t\t\t\t\t\t\tchecked={flowType === 'admin-activation'}\n\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\tconsole.log('üîç [FLOW TYPE DEBUG] Admin ACTIVATION_REQUIRED radio selected');\n\t\t\t\t\t\t\t\t\t\tconsole.log('üîç [FLOW TYPE DEBUG] New value:', e.target.value);\n\t\t\t\t\t\t\t\t\t\tsetFlowType(e.target.value as FlowType);\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{ marginTop: '2px', cursor: 'pointer' }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontWeight: '600', color: colors.gray[900], marginBottom: '4px' }}>\n\t\t\t\t\t\t\t\t\t\tAdmin Flow with Activation Required\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: '13px', color: colors.gray[600] }}>\n\t\t\t\t\t\t\t\t\t\tRegister device as admin, but require user activation (OTP verification) before\n\t\t\t\t\t\t\t\t\t\tit's active.\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* User Flow */}\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\talignItems: 'flex-start',\n\t\t\t\t\t\t\t\tgap: spacing[2],\n\t\t\t\t\t\t\t\tpadding: spacing[3],\n\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'user' ? colors.primary[500] : colors.gray[200]}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tbackground: flowType === 'user' ? colors.primary[50] : 'transparent',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\tvalue=\"user\"\n\t\t\t\t\t\t\t\tchecked={flowType === 'user'}\n\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\tconsole.log('üîç [FLOW TYPE DEBUG] User Flow radio selected');\n\t\t\t\t\t\t\t\t\tconsole.log('üîç [FLOW TYPE DEBUG] New value:', e.target.value);\n\t\t\t\t\t\t\t\t\tsetFlowType(e.target.value as FlowType);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{ marginTop: '2px', cursor: 'pointer' }}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<div style={{ fontWeight: '600', color: colors.gray[900], marginBottom: '4px' }}>\n\t\t\t\t\t\t\t\t\tUser Flow (PingOne Authentication)\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div style={{ fontSize: '13px', color: colors.gray[600] }}>\n\t\t\t\t\t\t\t\t\tUser registers their own device. Redirects to PingOne for authentication before\n\t\t\t\t\t\t\t\t\tregistration.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Username Field */}\n\t\t\t\t<div style={{ marginBottom: spacing[4] }}>\n\t\t\t\t\t<label\n\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcolor: colors.gray[700],\n\t\t\t\t\t\t\tmarginBottom: spacing[2],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tUsername\n\t\t\t\t\t</label>\n\t\t\t\t\t{environmentId && tokenStatus.isValid ? (\n\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\tvalue={username || ''}\n\t\t\t\t\t\t\toptions={userOptions}\n\t\t\t\t\t\t\tonChange={(value) => {\n\t\t\t\t\t\t\t\tif (onUsernameChange) {\n\t\t\t\t\t\t\t\t\tonUsernameChange(value);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tplaceholder=\"Type to search across 16,000+ users...\"\n\t\t\t\t\t\t\tisLoading={isLoadingUsers}\n\t\t\t\t\t\t\tonSearchChange={setSearchQuery}\n\t\t\t\t\t\t/>\n\t\t\t\t\t) : (\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={username || ''}\n\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\tconst newUsername = e.target.value;\n\t\t\t\t\t\t\t\tif (onUsernameChange) {\n\t\t\t\t\t\t\t\t\tonUsernameChange(newUsername);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tcolor: colors.gray[700],\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\n\t\t\t\t{/* Device Type Tabs */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tgap: spacing[2],\n\t\t\t\t\t\tmarginBottom: spacing[4],\n\t\t\t\t\t\tborderBottom: `2px solid ${colors.gray[200]}`,\n\t\t\t\t\t\toverflowX: 'auto',\n\t\t\t\t\t\tpaddingBottom: spacing[2],\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{DEVICE_TABS.map((tab) => (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tkey={tab.key}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => setSelectedTab(tab.key)}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\tgap: spacing[1],\n\t\t\t\t\t\t\t\tpadding: `${spacing[2]} ${spacing[3]}`,\n\t\t\t\t\t\t\t\tbackground: selectedTab === tab.key ? colors.primary[50] : 'transparent',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tborderBottom:\n\t\t\t\t\t\t\t\t\tselectedTab === tab.key\n\t\t\t\t\t\t\t\t\t\t? `3px solid ${colors.primary[600]}`\n\t\t\t\t\t\t\t\t\t\t: '3px solid transparent',\n\t\t\t\t\t\t\t\tborderRadius: '8px 8px 0 0',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\tminWidth: '100px',\n\t\t\t\t\t\t\t\tmarginBottom: '-2px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span style={{ fontSize: '24px' }}>{tab.icon}</span>\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tfontWeight: selectedTab === tab.key ? '600' : '500',\n\t\t\t\t\t\t\t\t\tcolor: selectedTab === tab.key ? colors.primary[700] : colors.gray[600],\n\t\t\t\t\t\t\t\t\twhiteSpace: 'nowrap',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{tab.label}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t))}\n\t\t\t\t</div>\n\n\t\t\t\t{/* Device Configuration Section */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmarginTop: spacing[4],\n\t\t\t\t\t\tpadding: spacing[4],\n\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)',\n\t\t\t\t\t\tborder: `3px solid ${colors.primary[300]}`,\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tboxShadow: '0 4px 12px rgba(59, 130, 246, 0.15)',\n\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\tzIndex: 10,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: 'absolute',\n\t\t\t\t\t\t\ttop: '-12px',\n\t\t\t\t\t\t\tleft: '20px',\n\t\t\t\t\t\t\tbackground: colors.primary[600],\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tpadding: '4px 12px',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tboxShadow: '0 2px 4px rgba(0,0,0,0.2)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t‚öôÔ∏è DEVICE CONFIGURATION\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style={{ marginTop: '8px' }}>\n\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: `0 0 ${spacing[3]}`,\n\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\tcolor: colors.primary[900],\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfigure {config.displayName} Device\n\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: `0 0 ${spacing[3]}`,\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tcolor: colors.primary[700],\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{config.description || DEVICE_TABS.find((t) => t.key === selectedTab)?.description}\n\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t{config.deviceType === 'FIDO2'\n\t\t\t\t\t\t\t\t? 'Register a hardware security key, platform authenticator, or passkey for secure authentication.'\n\t\t\t\t\t\t\t\t: 'Configure your device settings below to enable secure multi-factor authentication.'}\n\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t{/* Device-Specific Form */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tborder: `2px solid ${colors.primary[200]}`,\n\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\tpadding: spacing[4],\n\t\t\t\t\t\t\t\tmarginTop: spacing[3],\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{config.deviceType === 'FIDO2' ? (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<p style={{ fontSize: '48px', margin: `0 0 ${spacing[3]}` }}>üîë</p>\n\t\t\t\t\t\t\t\t\t<h3\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: `0 0 ${spacing[2]}`,\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[900],\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tFIDO2 Security Key / Passkey\n\t\t\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: `0 0 ${spacing[4]}`,\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[600],\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tRegister a hardware security key, platform authenticator, or passkey\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\t\t\t\t\t\tconfig={config}\n\t\t\t\t\t\t\t\t\t\tvalues={deviceFields[selectedTab] || {}}\n\t\t\t\t\t\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\t\t\t\t\t\terrors={errors}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: `${spacing[4]} 0 0 0`,\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[500],\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t‚ÑπÔ∏è Click \"Register Security Key\" below to start the WebAuthn registration flow\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\t\t\t\t\tconfig={config}\n\t\t\t\t\t\t\t\t\tvalues={deviceFields[selectedTab] || {}}\n\t\t\t\t\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\t\t\t\t\terrors={errors}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Registration Error Display */}\n\t\t\t\t{registrationError && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\tbackground: '#fef2f2',\n\t\t\t\t\t\t\tborder: '2px solid #fca5a5',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tmarginBottom: '20px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\t\talignItems: 'flex-start',\n\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '20px' }}>‚ö†Ô∏è</span>\n\t\t\t\t\t\t\t\t<strong style={{ color: '#991b1b', fontSize: '15px' }}>Registration Failed</strong>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t{onClearError && (\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={onClearError}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tbackground: 'none',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tcolor: '#991b1b',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\t\t\tpadding: '0',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t√ó\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 12px 0',\n\t\t\t\t\t\t\t\tcolor: '#7f1d1d',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{registrationError}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t{registrationError.includes('Too many devices') && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tbackground: '#fff',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #fca5a5',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\tcolor: '#7f1d1d',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüí° Need to manage your devices?\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t<a\n\t\t\t\t\t\t\t\t\thref=\"/v8/delete-all-devices\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'inline-block',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tbackground: '#dc2626',\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\ttextDecoration: 'none',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tGo to Device Management ‚Üí\n\t\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{/* Registration Info */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: '12px 16px',\n\t\t\t\t\t\tbackground: '#eff6ff',\n\t\t\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t‚ÑπÔ∏è Clicking \"Register {config.displayName} ‚Üí\" will register your device and send the\n\t\t\t\t\tactivation code.\n\t\t\t\t</div>\n\n\t\t\t\t{/* Action Buttons */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tpaddingTop: spacing[4],\n\t\t\t\t\t\tborderTop: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<Button variant=\"primary\" onClick={handleSubmit} disabled={isLoading} loading={isLoading}>\n\t\t\t\t\t\t{flowType === 'user' ? `Continue to User Login ‚Üí` : `Register ${config.displayName} ‚Üí`}\n\t\t\t\t\t</Button>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{/* API Comparison Modal */}\n\t\t\t<APIComparisonModal isOpen={showApiModal} onClose={() => setShowApiModal(false)} />\n\n\t\t\t{/* FIDO2 Registration Modal */}\n\t\t\t<FIDO2RegistrationModal\n\t\t\t\tisOpen={showFido2Modal}\n\t\t\t\tonClose={() => setShowFido2Modal(false)}\n\t\t\t\tonSuccess={handleFido2Success}\n\t\t\t\tuserId={username || deviceFields.FIDO2?.userId || 'default-user'}\n\t\t\t\tdeviceName={deviceFields.FIDO2?.name || 'Security Key'}\n\t\t\t/>\n\t\t</PageTransition>\n\t);\n};\n\nexport default UnifiedDeviceRegistrationForm;\n"},"tags":[],"source":null},{"category":"lint/correctness/noUnusedVariables","severity":"warning","description":"This variable workerTokenStatus is unused.","message":[{"elements":[],"content":"This variable "},{"elements":["Emphasis"],"content":"workerTokenStatus"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused variables are often the result of typos, incomplete refactors, or other sources of bugs."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedDeviceRegistrationForm.tsx"},"span":[3616,3633],"sourceCode":"/**\n * @file UnifiedDeviceRegistrationForm.tsx\n * @module v8/flows/unified/components\n * @description Combined device type selection + info input form\n * @version 9.2.0\n * @since 2026-01-29\n *\n * Purpose: Single form showing all device types with their input fields\n * Users can see all options and fill in the appropriate fields in one view\n */\n\nimport React, { useCallback, useEffect, useMemo, useState } from 'react';\nimport FIDO2RegistrationModal from '@/components/FIDO2RegistrationModal';\nimport { Button } from '@/v8/components/Button';\nimport { PageTransition } from '@/v8/components/PageTransition';\nimport type { SearchableDropdownOption } from '@/v8/components/SearchableDropdownV8';\nimport { SearchableDropdownV8 } from '@/v8/components/SearchableDropdownV8';\nimport { getDeviceConfig } from '@/v8/config/deviceFlowConfigs';\nimport type { DeviceConfigKey } from '@/v8/config/deviceFlowConfigTypes';\nimport { useUserSearch } from '@/v8/hooks/useUserSearch';\nimport { useWorkerToken } from '@/v8/hooks/useWorkerToken';\nimport type { TokenStatusInfo } from '@/v8/services/workerTokenStatusServiceV8';\nimport { colors, spacing } from '@/v8/styles/designTokens';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { APIComparisonModal } from './APIComparisonModal';\nimport { DynamicFormRenderer } from './DynamicFormRenderer';\nimport '../UnifiedMFAFlow.css';\n\nconst MODULE_TAG = '[üìù UNIFIED-DEVICE-REG-FORM]';\n\ninterface DeviceTypeTab {\n\tkey: DeviceConfigKey;\n\ticon: string;\n\tlabel: string;\n\tdescription: string;\n}\n\nconst DEVICE_TABS: DeviceTypeTab[] = [\n\t{ key: 'SMS', icon: 'üì±', label: 'SMS', description: 'Text message verification' },\n\t{ key: 'EMAIL', icon: '‚úâÔ∏è', label: 'Email', description: 'Email verification' },\n\t{ key: 'TOTP', icon: 'üîê', label: 'Authenticator', description: 'App-based codes' },\n\t{ key: 'MOBILE', icon: 'üì≤', label: 'Mobile Push', description: 'Push notifications' },\n\t{ key: 'WHATSAPP', icon: 'üí¨', label: 'WhatsApp', description: 'WhatsApp messages' },\n\t{ key: 'FIDO2', icon: 'üîë', label: 'Security Key / FIDO2', description: 'Hardware key/passkey' },\n];\n\ntype FlowType = 'admin-active' | 'admin-activation' | 'user';\n\nexport interface UnifiedDeviceRegistrationFormProps {\n\tonSubmit: (\n\t\tdeviceType: DeviceConfigKey,\n\t\tfields: Record<string, string>,\n\t\tflowType: FlowType\n\t) => void;\n\tonCancel: () => void;\n\tisLoading?: boolean;\n\t/** Initial device type to select (defaults to SMS) */\n\tinitialDeviceType?: DeviceConfigKey;\n\t/** Token status for validation */\n\ttokenStatus: TokenStatusInfo;\n\t/** Registration error to display */\n\tregistrationError?: string | null;\n\t/** Callback to clear error */\n\tonClearError?: () => void;\n\t/** Username for FIDO2 registration */\n\tusername?: string;\n\t/** Callback to update username */\n\tonUsernameChange?: (username: string) => void;\n\t/** Environment ID for user search */\n\tenvironmentId?: string;\n}\n\nexport const UnifiedDeviceRegistrationForm: React.FC<UnifiedDeviceRegistrationFormProps> = ({\n\tonSubmit,\n\tonCancel,\n\tisLoading = false,\n\tinitialDeviceType = 'SMS',\n\ttokenStatus,\n\tregistrationError,\n\tonClearError,\n\tusername,\n\tonUsernameChange,\n\tenvironmentId,\n}) => {\n\tconst [selectedTab, setSelectedTab] = useState<DeviceConfigKey>(initialDeviceType);\n\tconst [flowType, setFlowType] = useState<FlowType>('admin-active');\n\n\t// User search functionality for username dropdown\n\tconst {\n\t\tusers,\n\t\tisLoading: isLoadingUsers,\n\t\tsetSearchQuery,\n\t} = useUserSearch({\n\t\tenvironmentId: environmentId || '',\n\t\ttokenValid: tokenStatus.isValid,\n\t\tmaxPages: 100,\n\t});\n\n\t// Worker token for user search\n\tconst { tokenStatus: workerTokenStatus } = useWorkerToken();\n\n\t// Format users for dropdown\n\tconst userOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tArray.from(\n\t\t\t\tnew Map(\n\t\t\t\t\t(Array.isArray(users) ? users : []).map((user) => [\n\t\t\t\t\t\tuser.username,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvalue: user.username,\n\t\t\t\t\t\t\tlabel: user.username,\n\t\t\t\t\t\t\t...(user.email ? { secondaryLabel: user.email } : {}),\n\t\t\t\t\t\t} as SearchableDropdownOption,\n\t\t\t\t\t])\n\t\t\t\t).values()\n\t\t\t),\n\t\t[users]\n\t);\n\n\t// Debug logging for flowType changes\n\tuseEffect(() => {\n\t\tconsole.log('üîç [FLOW TYPE DEBUG] flowType state changed:', flowType);\n\t}, [flowType]);\n\n\t// Debug logging on mount\n\tuseEffect(() => {\n\t\tconsole.log('üîç [FLOW TYPE DEBUG] UnifiedDeviceRegistrationForm mounted');\n\t\tconsole.log('üîç [FLOW TYPE DEBUG] Initial flowType:', flowType);\n\t\tconsole.log('üîç [FLOW TYPE DEBUG] Initial selectedTab:', selectedTab);\n\t}, [flowType, selectedTab]);\n\n\tconst [deviceFields, setDeviceFields] = useState<Record<DeviceConfigKey, Record<string, string>>>(\n\t\t() => {\n\t\t\t// Initialize with saved values from localStorage\n\t\t\tconst savedPhone = localStorage.getItem('mfa_saved_phoneNumber');\n\t\t\tconst savedCountryCode = localStorage.getItem('mfa_saved_countryCode');\n\t\t\tconst savedEmail = localStorage.getItem('mfa_saved_email');\n\n\t\t\tconst initialFields: Record<DeviceConfigKey, Record<string, string>> = {\n\t\t\t\tSMS: { name: 'SMS', nickname: 'MyKnickName' },\n\t\t\t\tEMAIL: { name: 'EMAIL', nickname: 'MyKnickName' },\n\t\t\t\tTOTP: { name: 'TOTP', nickname: 'MyKnickName' },\n\t\t\t\tMOBILE: { name: 'MOBILE', nickname: 'MyKnickName' },\n\t\t\t\tWHATSAPP: { name: 'WHATSAPP', nickname: 'MyKnickName' },\n\t\t\t\tFIDO2: { name: 'FIDO2', nickname: 'MyKnickName' },\n\t\t\t};\n\n\t\t\t// Restore saved values if available\n\t\t\tif (savedPhone) {\n\t\t\t\tinitialFields.SMS = { ...initialFields.SMS, phoneNumber: savedPhone };\n\t\t\t}\n\t\t\tif (savedCountryCode) {\n\t\t\t\tinitialFields.SMS = { ...initialFields.SMS, countryCode: savedCountryCode };\n\t\t\t\tinitialFields.SMS.countryCode = savedCountryCode;\n\t\t\t\tinitialFields.WHATSAPP.countryCode = savedCountryCode;\n\t\t\t}\n\t\t\tif (savedEmail) {\n\t\t\t\tinitialFields.EMAIL.email = savedEmail;\n\t\t\t}\n\n\t\t\treturn initialFields;\n\t\t}\n\t);\n\tconst [errors, setErrors] = useState<Record<string, string>>({});\n\tconst [showApiModal, setShowApiModal] = useState(false);\n\tconst [showFido2Modal, setShowFido2Modal] = useState(false);\n\n\tconst config = getDeviceConfig(selectedTab);\n\n\tconst handleFieldChange = useCallback(\n\t\t(field: string, value: string) => {\n\t\t\tsetDeviceFields((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t[selectedTab]: {\n\t\t\t\t\t...prev[selectedTab],\n\t\t\t\t\t[field]: value,\n\t\t\t\t},\n\t\t\t}));\n\t\t\t// Clear error for this field\n\t\t\tif (errors[field]) {\n\t\t\t\tsetErrors((prev) => {\n\t\t\t\t\tconst newErrors = { ...prev };\n\t\t\t\t\tdelete newErrors[field];\n\t\t\t\t\treturn newErrors;\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t\t[selectedTab, errors]\n\t);\n\n\tconst handleSubmit = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} Submitting registration for:`, selectedTab, 'Flow type:', flowType);\n\t\tconst fields = deviceFields[selectedTab];\n\n\t\t// ========== DEBUG: FORM SUBMISSION ==========\n\t\tconsole.log('üîç [FORM DEBUG] Submit handler called:', {\n\t\t\tselectedTab,\n\t\t\tflowType,\n\t\t\tfields,\n\t\t\ttokenIsValid: tokenStatus.isValid,\n\t\t\thasOnSubmit: !!onSubmit,\n\t\t});\n\t\t// ============================================\n\n\t\t// Check worker token status\n\t\tif (!tokenStatus.isValid) {\n\t\t\ttoastV8.error('Worker token is invalid or expired. Please refresh the worker token.');\n\t\t\tconsole.log('üîç [FORM DEBUG] Token invalid, blocking submission');\n\t\t\treturn;\n\t\t}\n\n\t\t// Basic validation\n\t\tconst requiredFields = config.requiredFields || [];\n\t\tconst newErrors: Record<string, string> = {};\n\n\t\trequiredFields.forEach((field) => {\n\t\t\tif (!fields[field]?.trim()) {\n\t\t\t\tnewErrors[field] = `${field} is required`;\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(newErrors).length > 0) {\n\t\t\tsetErrors(newErrors);\n\t\t\tconsole.log('üîç [FORM DEBUG] Validation errors:', newErrors);\n\t\t\treturn;\n\t\t}\n\n\t\tconsole.log('üîç [FORM DEBUG] Calling onSubmit callback');\n\n\t\t// Special handling for FIDO2\n\t\tif (selectedTab === 'FIDO2') {\n\t\t\tsetShowFido2Modal(true);\n\t\t\treturn;\n\t\t}\n\n\t\tonSubmit(selectedTab, fields, flowType);\n\t}, [selectedTab, deviceFields, config, onSubmit, flowType, tokenStatus]);\n\n\tconst handleFido2Success = useCallback(\n\t\t(credentialId: string, publicKey: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} FIDO2 registration successful`, { credentialId });\n\t\t\ttoastV8.success('FIDO2 device registered successfully!');\n\t\t\tsetShowFido2Modal(false);\n\n\t\t\t// Update device fields with FIDO2 data\n\t\t\tconst fido2Fields = {\n\t\t\t\t...deviceFields.FIDO2,\n\t\t\t\tcredentialId,\n\t\t\t\tpublicKey,\n\t\t\t};\n\n\t\t\t// Submit FIDO2 registration\n\t\t\tonSubmit('FIDO2', fido2Fields, flowType);\n\t\t},\n\t\t[deviceFields, flowType, onSubmit]\n\t);\n\n\treturn (\n\t\t<PageTransition>\n\t\t\t<div style={{ maxWidth: '900px', margin: '0 auto', padding: spacing[6] }}>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div style={{ marginBottom: spacing[6] }}>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\talignItems: 'flex-start',\n\t\t\t\t\t\t\tmarginBottom: spacing[2],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\tstyle={{ margin: 0, fontSize: '24px', fontWeight: '700', color: colors.gray[900] }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tRegister MFA Device\n\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t<p style={{ margin: '4px 0 0 0', fontSize: '14px', color: colors.gray[600] }}>\n\t\t\t\t\t\t\t\tSelect a device type and enter the required information\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tvariant=\"secondary\"\n\t\t\t\t\t\t\tonClick={() => setShowApiModal(true)}\n\t\t\t\t\t\t\tstyle={{ fontSize: '12px', padding: '8px 12px' }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîç API Comparison\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Flow Type Selection */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\tborder: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tpadding: spacing[4],\n\t\t\t\t\t\tmarginBottom: spacing[6],\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<h3\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tmargin: `0 0 ${spacing[3]}`,\n\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcolor: colors.gray[900],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tRegistration Flow Type\n\t\t\t\t\t</h3>\n\t\t\t\t\t<div style={{ display: 'flex', flexDirection: 'column', gap: spacing[3] }}>\n\t\t\t\t\t\t{/* Admin Flow */}\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\talignItems: 'flex-start',\n\t\t\t\t\t\t\t\tgap: spacing[2],\n\t\t\t\t\t\t\t\tpadding: spacing[3],\n\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-active' ? colors.primary[500] : colors.gray[200]}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tbackground: flowType === 'admin-active' ? colors.primary[50] : 'transparent',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\tvalue=\"admin-active\"\n\t\t\t\t\t\t\t\tchecked={flowType === 'admin-active'}\n\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\tconsole.log('üîç [FLOW TYPE DEBUG] Admin Flow radio selected');\n\t\t\t\t\t\t\t\t\tconsole.log('üîç [FLOW TYPE DEBUG] New value:', e.target.value);\n\t\t\t\t\t\t\t\t\tsetFlowType(e.target.value as FlowType);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{ marginTop: '2px', cursor: 'pointer' }}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<div style={{ fontWeight: '600', color: colors.gray[900], marginBottom: '4px' }}>\n\t\t\t\t\t\t\t\t\tAdmin Flow (Direct Registration)\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div style={{ fontSize: '13px', color: colors.gray[600] }}>\n\t\t\t\t\t\t\t\t\tRegister device directly as admin. Device is immediately active and ready to use.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t{/* Admin with Activation Required - Hide for FIDO2 (no OTP activation needed) */}\n\t\t\t\t\t\t{selectedTab !== 'FIDO2' && (\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\talignItems: 'flex-start',\n\t\t\t\t\t\t\t\t\tgap: spacing[2],\n\t\t\t\t\t\t\t\t\tpadding: spacing[3],\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-activation' ? colors.primary[500] : colors.gray[200]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\tbackground: flowType === 'admin-activation' ? colors.primary[50] : 'transparent',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\tvalue=\"admin-activation\"\n\t\t\t\t\t\t\t\t\tchecked={flowType === 'admin-activation'}\n\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\tconsole.log('üîç [FLOW TYPE DEBUG] Admin ACTIVATION_REQUIRED radio selected');\n\t\t\t\t\t\t\t\t\t\tconsole.log('üîç [FLOW TYPE DEBUG] New value:', e.target.value);\n\t\t\t\t\t\t\t\t\t\tsetFlowType(e.target.value as FlowType);\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{ marginTop: '2px', cursor: 'pointer' }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontWeight: '600', color: colors.gray[900], marginBottom: '4px' }}>\n\t\t\t\t\t\t\t\t\t\tAdmin Flow with Activation Required\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: '13px', color: colors.gray[600] }}>\n\t\t\t\t\t\t\t\t\t\tRegister device as admin, but require user activation (OTP verification) before\n\t\t\t\t\t\t\t\t\t\tit's active.\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* User Flow */}\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\talignItems: 'flex-start',\n\t\t\t\t\t\t\t\tgap: spacing[2],\n\t\t\t\t\t\t\t\tpadding: spacing[3],\n\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'user' ? colors.primary[500] : colors.gray[200]}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tbackground: flowType === 'user' ? colors.primary[50] : 'transparent',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\tvalue=\"user\"\n\t\t\t\t\t\t\t\tchecked={flowType === 'user'}\n\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\tconsole.log('üîç [FLOW TYPE DEBUG] User Flow radio selected');\n\t\t\t\t\t\t\t\t\tconsole.log('üîç [FLOW TYPE DEBUG] New value:', e.target.value);\n\t\t\t\t\t\t\t\t\tsetFlowType(e.target.value as FlowType);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{ marginTop: '2px', cursor: 'pointer' }}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<div style={{ fontWeight: '600', color: colors.gray[900], marginBottom: '4px' }}>\n\t\t\t\t\t\t\t\t\tUser Flow (PingOne Authentication)\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div style={{ fontSize: '13px', color: colors.gray[600] }}>\n\t\t\t\t\t\t\t\t\tUser registers their own device. Redirects to PingOne for authentication before\n\t\t\t\t\t\t\t\t\tregistration.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Username Field */}\n\t\t\t\t<div style={{ marginBottom: spacing[4] }}>\n\t\t\t\t\t<label\n\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcolor: colors.gray[700],\n\t\t\t\t\t\t\tmarginBottom: spacing[2],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tUsername\n\t\t\t\t\t</label>\n\t\t\t\t\t{environmentId && tokenStatus.isValid ? (\n\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\tvalue={username || ''}\n\t\t\t\t\t\t\toptions={userOptions}\n\t\t\t\t\t\t\tonChange={(value) => {\n\t\t\t\t\t\t\t\tif (onUsernameChange) {\n\t\t\t\t\t\t\t\t\tonUsernameChange(value);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tplaceholder=\"Type to search across 16,000+ users...\"\n\t\t\t\t\t\t\tisLoading={isLoadingUsers}\n\t\t\t\t\t\t\tonSearchChange={setSearchQuery}\n\t\t\t\t\t\t/>\n\t\t\t\t\t) : (\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={username || ''}\n\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\tconst newUsername = e.target.value;\n\t\t\t\t\t\t\t\tif (onUsernameChange) {\n\t\t\t\t\t\t\t\t\tonUsernameChange(newUsername);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tcolor: colors.gray[700],\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\n\t\t\t\t{/* Device Type Tabs */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tgap: spacing[2],\n\t\t\t\t\t\tmarginBottom: spacing[4],\n\t\t\t\t\t\tborderBottom: `2px solid ${colors.gray[200]}`,\n\t\t\t\t\t\toverflowX: 'auto',\n\t\t\t\t\t\tpaddingBottom: spacing[2],\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{DEVICE_TABS.map((tab) => (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tkey={tab.key}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => setSelectedTab(tab.key)}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\tgap: spacing[1],\n\t\t\t\t\t\t\t\tpadding: `${spacing[2]} ${spacing[3]}`,\n\t\t\t\t\t\t\t\tbackground: selectedTab === tab.key ? colors.primary[50] : 'transparent',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tborderBottom:\n\t\t\t\t\t\t\t\t\tselectedTab === tab.key\n\t\t\t\t\t\t\t\t\t\t? `3px solid ${colors.primary[600]}`\n\t\t\t\t\t\t\t\t\t\t: '3px solid transparent',\n\t\t\t\t\t\t\t\tborderRadius: '8px 8px 0 0',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\tminWidth: '100px',\n\t\t\t\t\t\t\t\tmarginBottom: '-2px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span style={{ fontSize: '24px' }}>{tab.icon}</span>\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tfontWeight: selectedTab === tab.key ? '600' : '500',\n\t\t\t\t\t\t\t\t\tcolor: selectedTab === tab.key ? colors.primary[700] : colors.gray[600],\n\t\t\t\t\t\t\t\t\twhiteSpace: 'nowrap',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{tab.label}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t))}\n\t\t\t\t</div>\n\n\t\t\t\t{/* Device Configuration Section */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmarginTop: spacing[4],\n\t\t\t\t\t\tpadding: spacing[4],\n\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)',\n\t\t\t\t\t\tborder: `3px solid ${colors.primary[300]}`,\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tboxShadow: '0 4px 12px rgba(59, 130, 246, 0.15)',\n\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\tzIndex: 10,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: 'absolute',\n\t\t\t\t\t\t\ttop: '-12px',\n\t\t\t\t\t\t\tleft: '20px',\n\t\t\t\t\t\t\tbackground: colors.primary[600],\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tpadding: '4px 12px',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tboxShadow: '0 2px 4px rgba(0,0,0,0.2)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t‚öôÔ∏è DEVICE CONFIGURATION\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style={{ marginTop: '8px' }}>\n\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: `0 0 ${spacing[3]}`,\n\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\tcolor: colors.primary[900],\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfigure {config.displayName} Device\n\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: `0 0 ${spacing[3]}`,\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tcolor: colors.primary[700],\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{config.description || DEVICE_TABS.find((t) => t.key === selectedTab)?.description}\n\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t{config.deviceType === 'FIDO2'\n\t\t\t\t\t\t\t\t? 'Register a hardware security key, platform authenticator, or passkey for secure authentication.'\n\t\t\t\t\t\t\t\t: 'Configure your device settings below to enable secure multi-factor authentication.'}\n\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t{/* Device-Specific Form */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tborder: `2px solid ${colors.primary[200]}`,\n\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\tpadding: spacing[4],\n\t\t\t\t\t\t\t\tmarginTop: spacing[3],\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{config.deviceType === 'FIDO2' ? (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<p style={{ fontSize: '48px', margin: `0 0 ${spacing[3]}` }}>üîë</p>\n\t\t\t\t\t\t\t\t\t<h3\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: `0 0 ${spacing[2]}`,\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[900],\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tFIDO2 Security Key / Passkey\n\t\t\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: `0 0 ${spacing[4]}`,\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[600],\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tRegister a hardware security key, platform authenticator, or passkey\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\t\t\t\t\t\tconfig={config}\n\t\t\t\t\t\t\t\t\t\tvalues={deviceFields[selectedTab] || {}}\n\t\t\t\t\t\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\t\t\t\t\t\terrors={errors}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: `${spacing[4]} 0 0 0`,\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[500],\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t‚ÑπÔ∏è Click \"Register Security Key\" below to start the WebAuthn registration flow\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\t\t\t\t\tconfig={config}\n\t\t\t\t\t\t\t\t\tvalues={deviceFields[selectedTab] || {}}\n\t\t\t\t\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\t\t\t\t\terrors={errors}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Registration Error Display */}\n\t\t\t\t{registrationError && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\tbackground: '#fef2f2',\n\t\t\t\t\t\t\tborder: '2px solid #fca5a5',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tmarginBottom: '20px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\t\talignItems: 'flex-start',\n\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '20px' }}>‚ö†Ô∏è</span>\n\t\t\t\t\t\t\t\t<strong style={{ color: '#991b1b', fontSize: '15px' }}>Registration Failed</strong>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t{onClearError && (\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={onClearError}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tbackground: 'none',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tcolor: '#991b1b',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\t\t\tpadding: '0',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t√ó\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 12px 0',\n\t\t\t\t\t\t\t\tcolor: '#7f1d1d',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{registrationError}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t{registrationError.includes('Too many devices') && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tbackground: '#fff',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #fca5a5',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\tcolor: '#7f1d1d',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüí° Need to manage your devices?\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t<a\n\t\t\t\t\t\t\t\t\thref=\"/v8/delete-all-devices\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'inline-block',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tbackground: '#dc2626',\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\ttextDecoration: 'none',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tGo to Device Management ‚Üí\n\t\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{/* Registration Info */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: '12px 16px',\n\t\t\t\t\t\tbackground: '#eff6ff',\n\t\t\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t‚ÑπÔ∏è Clicking \"Register {config.displayName} ‚Üí\" will register your device and send the\n\t\t\t\t\tactivation code.\n\t\t\t\t</div>\n\n\t\t\t\t{/* Action Buttons */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tpaddingTop: spacing[4],\n\t\t\t\t\t\tborderTop: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<Button variant=\"primary\" onClick={handleSubmit} disabled={isLoading} loading={isLoading}>\n\t\t\t\t\t\t{flowType === 'user' ? `Continue to User Login ‚Üí` : `Register ${config.displayName} ‚Üí`}\n\t\t\t\t\t</Button>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{/* API Comparison Modal */}\n\t\t\t<APIComparisonModal isOpen={showApiModal} onClose={() => setShowApiModal(false)} />\n\n\t\t\t{/* FIDO2 Registration Modal */}\n\t\t\t<FIDO2RegistrationModal\n\t\t\t\tisOpen={showFido2Modal}\n\t\t\t\tonClose={() => setShowFido2Modal(false)}\n\t\t\t\tonSuccess={handleFido2Success}\n\t\t\t\tuserId={username || deviceFields.FIDO2?.userId || 'default-user'}\n\t\t\t\tdeviceName={deviceFields.FIDO2?.name || 'Security Key'}\n\t\t\t/>\n\t\t</PageTransition>\n\t);\n};\n\nexport default UnifiedDeviceRegistrationForm;\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedDeviceSelectionModal.tsx"},"span":[2563,2566],"sourceCode":"/**\n * @file UnifiedDeviceSelectionModal.tsx\n * @module v8/flows/unified/components\n * @description Modern device selection modal for MFA authentication\n * @version 9.2.2\n * @since 2026-01-30\n *\n * Purpose: Allow users to select which MFA device to authenticate with\n * Shows all registered devices with their types and status\n */\n\nimport React, { useEffect, useState } from 'react';\nimport { MFAServiceV8 } from '@/v8/services/mfaServiceV8';\nimport { colors, spacing } from '@/v8/styles/designTokens';\n\ninterface Device {\n\tid: string;\n\ttype: 'SMS' | 'EMAIL' | 'TOTP' | 'VOICE' | 'FIDO2' | 'MOBILE' | 'WHATSAPP';\n\tdeviceName?: string;\n\tnickname?: string;\n\tstatus:\n\t\t| 'ACTIVE'\n\t\t| 'ACTIVATION_REQUIRED'\n\t\t| 'DISABLED'\n\t\t| 'BLOCKED'\n\t\t| 'LOCKED'\n\t\t| 'PENDING'\n\t\t| 'SUSPENDED'\n\t\t| 'EXPIRED';\n}\n\ninterface UnifiedDeviceSelectionModalProps {\n\tisOpen: boolean;\n\tonClose: () => void;\n\tonDeviceSelect: (device: Device) => void;\n\tusername: string;\n\tenvironmentId: string;\n\tloading?: boolean;\n\terror?: string;\n}\n\nconst DEVICE_ICONS = {\n\tSMS: 'üì±',\n\tEMAIL: 'üìß',\n\tTOTP: 'üîê',\n\tVOICE: 'üìû',\n\tFIDO2: 'üîë',\n\tMOBILE: 'üì≤',\n\tWHATSAPP: 'üí¨',\n};\n\nconst DEVICE_COLORS = {\n\tSMS: colors.primary[600],\n\tEMAIL: colors.success[600],\n\tTOTP: colors.purple[600],\n\tVOICE: colors.warning[600],\n\tFIDO2: colors.info[600],\n\tMOBILE: colors.primary[500],\n\tWHATSAPP: colors.success[500],\n};\n\nconst STATUS_BADGES = {\n\tACTIVE: { text: 'Active', color: colors.success[600], bg: colors.success[50] },\n\tACTIVATION_REQUIRED: {\n\t\ttext: 'Activation Required',\n\t\tcolor: colors.warning[600],\n\t\tbg: colors.warning[50],\n\t},\n\tDISABLED: { text: 'Disabled', color: colors.gray[600], bg: colors.gray[50] },\n};\n\nexport const UnifiedDeviceSelectionModal: React.FC<UnifiedDeviceSelectionModalProps> = ({\n\tisOpen,\n\tonClose,\n\tonDeviceSelect,\n\tusername,\n\tenvironmentId,\n\tloading = false,\n\terror = null,\n}) => {\n\tconst [devices, setDevices] = useState<Device[]>([]);\n\tconst [searchQuery, setSearchQuery] = useState('');\n\tconst [isLoading, setIsLoading] = useState(false);\n\tconst [errorMsg, setErrorMsg] = useState<string | null>(null);\n\n\t// Fetch real devices from API\n\tuseEffect(() => {\n\t\tif (isOpen && username && environmentId) {\n\t\t\tconst fetchDevices = async () => {\n\t\t\t\tsetIsLoading(true);\n\t\t\t\tsetErrorMsg(null);\n\t\t\t\ttry {\n\t\t\t\t\tconst allDevices = await MFAServiceV8.getAllDevices({\n\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\tusername,\n\t\t\t\t\t});\n\n\t\t\t\t\t// Filter out devices with ACTIVATION_REQUIRED status\n\t\t\t\t\t// Only show ACTIVE devices for authentication\n\t\t\t\t\tconst activeDevices = allDevices\n\t\t\t\t\t\t.filter((device: any) => device.status === 'ACTIVE')\n\t\t\t\t\t\t.map((device: any) => ({\n\t\t\t\t\t\t\tid: device.id,\n\t\t\t\t\t\t\ttype: device.type,\n\t\t\t\t\t\t\tdeviceName: device.name || device.phone?.number || device.email?.address,\n\t\t\t\t\t\t\tnickname: device.nickname,\n\t\t\t\t\t\t\tstatus: device.status,\n\t\t\t\t\t\t}));\n\n\t\t\t\t\tconsole.log('[DEVICE-SELECTION] Loaded devices:', activeDevices.length, 'active devices');\n\t\t\t\t\tsetDevices(activeDevices);\n\t\t\t\t} catch (err) {\n\t\t\t\t\tconsole.error('[DEVICE-SELECTION] Error loading devices:', err);\n\t\t\t\t\tsetErrorMsg(err instanceof Error ? err.message : 'Failed to load devices');\n\t\t\t\t} finally {\n\t\t\t\t\tsetIsLoading(false);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tfetchDevices();\n\t\t}\n\t}, [isOpen, username, environmentId]);\n\n\t// Filter devices based on search query\n\tconst filteredDevices = devices.filter(\n\t\t(device) =>\n\t\t\tdevice.deviceName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n\t\t\tdevice.nickname?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n\t\t\tdevice.type.toLowerCase().includes(searchQuery.toLowerCase())\n\t);\n\n\t// Only show active devices for authentication\n\tconst availableDevices = filteredDevices.filter((device) => device.status === 'ACTIVE');\n\n\tconst handleDeviceSelect = (device: Device) => {\n\t\tonDeviceSelect(device);\n\t\tonClose();\n\t};\n\n\tif (!isOpen) return null;\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tposition: 'fixed',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\tdisplay: 'flex',\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tzIndex: 1000,\n\t\t\t}}\n\t\t\tonClick={onClose}\n\t\t\tonKeyDown={(e) => {\n\t\t\t\tif (e.key === 'Escape') {\n\t\t\t\t\tonClose();\n\t\t\t\t}\n\t\t\t}}\n\t\t\trole=\"dialog\"\n\t\t\taria-modal=\"true\"\n\t\t>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'white',\n\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\tboxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',\n\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\twidth: '90%',\n\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t}}\n\t\t\t\tonClick={(e) => e.stopPropagation()}\n\t\t\t>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\tborderBottom: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tmarginBottom: spacing[4],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: 0, fontSize: '20px', fontWeight: '700', color: colors.gray[900] }}>\n\t\t\t\t\t\t\tüîì Select Authentication Device\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'none',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\tcolor: colors.gray[400],\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tpadding: '0',\n\t\t\t\t\t\t\t\tlineHeight: 1,\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t√ó\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style={{ fontSize: '14px', color: colors.gray[600], lineHeight: 1.5 }}>\n\t\t\t\t\t\tChoose which MFA device to authenticate with for <strong>{username}</strong>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Search */}\n\t\t\t\t\t<div style={{ marginTop: spacing[4] }}>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tplaceholder=\"Search devices...\"\n\t\t\t\t\t\t\tvalue={searchQuery}\n\t\t\t\t\t\t\tonChange={(e) => setSearchQuery(e.target.value)}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: spacing[3],\n\t\t\t\t\t\t\t\tborder: `1px solid ${colors.gray[300]}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Content */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\toverflowY: 'auto',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4] }}>‚è≥</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.gray[600] }}>Loading your devices...</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : errorMsg ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4], color: colors.error[500] }}>\n\t\t\t\t\t\t\t\t‚ö†Ô∏è\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.error[600] }}>{errorMsg}</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : availableDevices.length === 0 ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4] }}>üì±</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.gray[600] }}>\n\t\t\t\t\t\t\t\tNo active MFA devices found. Please register a device first.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : (\n\t\t\t\t\t\t<div style={{ display: 'grid', gap: spacing[4] }}>\n\t\t\t\t\t\t\t{availableDevices.map((device) => (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tkey={device.id}\n\t\t\t\t\t\t\t\t\tonClick={() => handleDeviceSelect(device)}\n\t\t\t\t\t\t\t\t\tonKeyDown={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (e.key === 'Enter' || e.key === ' ') {\n\t\t\t\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t\t\t\thandleDeviceSelect(device);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: spacing[4],\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${colors.gray[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: spacing[4],\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = DEVICE_COLORS[device.type];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.backgroundColor = colors.gray[50];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = colors.gray[200];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.backgroundColor = 'white';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\ttabIndex={0}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{/* Device Icon */}\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\t\twidth: '48px',\n\t\t\t\t\t\t\t\t\t\t\theight: '48px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tbackground: `${DEVICE_COLORS[device.type]}15`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{DEVICE_ICONS[device.type]}\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Device Info */}\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[900],\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: spacing[1],\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{device.nickname || device.deviceName || `${device.type} Device`}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'center', gap: spacing[2] }}>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[600],\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: `${DEVICE_COLORS[device.type]}15`,\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 6px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{device.type}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 6px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: STATUS_BADGES[device.status].bg,\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: STATUS_BADGES[device.status].color,\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{STATUS_BADGES[device.status].text}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Arrow */}\n\t\t\t\t\t\t\t\t\t<div style={{ color: colors.gray[400] }}>‚Üí</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\n\t\t\t\t{/* Footer */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\tborderTop: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div style={{ fontSize: '12px', color: colors.gray[500] }}>\n\t\t\t\t\t\t{availableDevices.length} device{availableDevices.length !== 1 ? 's' : ''} available\n\t\t\t\t\t</div>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: `${spacing[2]} ${spacing[4]}`,\n\t\t\t\t\t\t\tbackground: colors.gray[100],\n\t\t\t\t\t\t\tborder: `1px solid ${colors.gray[300]}`,\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcolor: colors.gray[700],\n\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tCancel\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedDeviceSelectionModal.tsx"},"span":[2619,2622],"sourceCode":"/**\n * @file UnifiedDeviceSelectionModal.tsx\n * @module v8/flows/unified/components\n * @description Modern device selection modal for MFA authentication\n * @version 9.2.2\n * @since 2026-01-30\n *\n * Purpose: Allow users to select which MFA device to authenticate with\n * Shows all registered devices with their types and status\n */\n\nimport React, { useEffect, useState } from 'react';\nimport { MFAServiceV8 } from '@/v8/services/mfaServiceV8';\nimport { colors, spacing } from '@/v8/styles/designTokens';\n\ninterface Device {\n\tid: string;\n\ttype: 'SMS' | 'EMAIL' | 'TOTP' | 'VOICE' | 'FIDO2' | 'MOBILE' | 'WHATSAPP';\n\tdeviceName?: string;\n\tnickname?: string;\n\tstatus:\n\t\t| 'ACTIVE'\n\t\t| 'ACTIVATION_REQUIRED'\n\t\t| 'DISABLED'\n\t\t| 'BLOCKED'\n\t\t| 'LOCKED'\n\t\t| 'PENDING'\n\t\t| 'SUSPENDED'\n\t\t| 'EXPIRED';\n}\n\ninterface UnifiedDeviceSelectionModalProps {\n\tisOpen: boolean;\n\tonClose: () => void;\n\tonDeviceSelect: (device: Device) => void;\n\tusername: string;\n\tenvironmentId: string;\n\tloading?: boolean;\n\terror?: string;\n}\n\nconst DEVICE_ICONS = {\n\tSMS: 'üì±',\n\tEMAIL: 'üìß',\n\tTOTP: 'üîê',\n\tVOICE: 'üìû',\n\tFIDO2: 'üîë',\n\tMOBILE: 'üì≤',\n\tWHATSAPP: 'üí¨',\n};\n\nconst DEVICE_COLORS = {\n\tSMS: colors.primary[600],\n\tEMAIL: colors.success[600],\n\tTOTP: colors.purple[600],\n\tVOICE: colors.warning[600],\n\tFIDO2: colors.info[600],\n\tMOBILE: colors.primary[500],\n\tWHATSAPP: colors.success[500],\n};\n\nconst STATUS_BADGES = {\n\tACTIVE: { text: 'Active', color: colors.success[600], bg: colors.success[50] },\n\tACTIVATION_REQUIRED: {\n\t\ttext: 'Activation Required',\n\t\tcolor: colors.warning[600],\n\t\tbg: colors.warning[50],\n\t},\n\tDISABLED: { text: 'Disabled', color: colors.gray[600], bg: colors.gray[50] },\n};\n\nexport const UnifiedDeviceSelectionModal: React.FC<UnifiedDeviceSelectionModalProps> = ({\n\tisOpen,\n\tonClose,\n\tonDeviceSelect,\n\tusername,\n\tenvironmentId,\n\tloading = false,\n\terror = null,\n}) => {\n\tconst [devices, setDevices] = useState<Device[]>([]);\n\tconst [searchQuery, setSearchQuery] = useState('');\n\tconst [isLoading, setIsLoading] = useState(false);\n\tconst [errorMsg, setErrorMsg] = useState<string | null>(null);\n\n\t// Fetch real devices from API\n\tuseEffect(() => {\n\t\tif (isOpen && username && environmentId) {\n\t\t\tconst fetchDevices = async () => {\n\t\t\t\tsetIsLoading(true);\n\t\t\t\tsetErrorMsg(null);\n\t\t\t\ttry {\n\t\t\t\t\tconst allDevices = await MFAServiceV8.getAllDevices({\n\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\tusername,\n\t\t\t\t\t});\n\n\t\t\t\t\t// Filter out devices with ACTIVATION_REQUIRED status\n\t\t\t\t\t// Only show ACTIVE devices for authentication\n\t\t\t\t\tconst activeDevices = allDevices\n\t\t\t\t\t\t.filter((device: any) => device.status === 'ACTIVE')\n\t\t\t\t\t\t.map((device: any) => ({\n\t\t\t\t\t\t\tid: device.id,\n\t\t\t\t\t\t\ttype: device.type,\n\t\t\t\t\t\t\tdeviceName: device.name || device.phone?.number || device.email?.address,\n\t\t\t\t\t\t\tnickname: device.nickname,\n\t\t\t\t\t\t\tstatus: device.status,\n\t\t\t\t\t\t}));\n\n\t\t\t\t\tconsole.log('[DEVICE-SELECTION] Loaded devices:', activeDevices.length, 'active devices');\n\t\t\t\t\tsetDevices(activeDevices);\n\t\t\t\t} catch (err) {\n\t\t\t\t\tconsole.error('[DEVICE-SELECTION] Error loading devices:', err);\n\t\t\t\t\tsetErrorMsg(err instanceof Error ? err.message : 'Failed to load devices');\n\t\t\t\t} finally {\n\t\t\t\t\tsetIsLoading(false);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tfetchDevices();\n\t\t}\n\t}, [isOpen, username, environmentId]);\n\n\t// Filter devices based on search query\n\tconst filteredDevices = devices.filter(\n\t\t(device) =>\n\t\t\tdevice.deviceName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n\t\t\tdevice.nickname?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n\t\t\tdevice.type.toLowerCase().includes(searchQuery.toLowerCase())\n\t);\n\n\t// Only show active devices for authentication\n\tconst availableDevices = filteredDevices.filter((device) => device.status === 'ACTIVE');\n\n\tconst handleDeviceSelect = (device: Device) => {\n\t\tonDeviceSelect(device);\n\t\tonClose();\n\t};\n\n\tif (!isOpen) return null;\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tposition: 'fixed',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\tdisplay: 'flex',\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tzIndex: 1000,\n\t\t\t}}\n\t\t\tonClick={onClose}\n\t\t\tonKeyDown={(e) => {\n\t\t\t\tif (e.key === 'Escape') {\n\t\t\t\t\tonClose();\n\t\t\t\t}\n\t\t\t}}\n\t\t\trole=\"dialog\"\n\t\t\taria-modal=\"true\"\n\t\t>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'white',\n\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\tboxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',\n\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\twidth: '90%',\n\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t}}\n\t\t\t\tonClick={(e) => e.stopPropagation()}\n\t\t\t>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\tborderBottom: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tmarginBottom: spacing[4],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: 0, fontSize: '20px', fontWeight: '700', color: colors.gray[900] }}>\n\t\t\t\t\t\t\tüîì Select Authentication Device\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'none',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\tcolor: colors.gray[400],\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tpadding: '0',\n\t\t\t\t\t\t\t\tlineHeight: 1,\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t√ó\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style={{ fontSize: '14px', color: colors.gray[600], lineHeight: 1.5 }}>\n\t\t\t\t\t\tChoose which MFA device to authenticate with for <strong>{username}</strong>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Search */}\n\t\t\t\t\t<div style={{ marginTop: spacing[4] }}>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tplaceholder=\"Search devices...\"\n\t\t\t\t\t\t\tvalue={searchQuery}\n\t\t\t\t\t\t\tonChange={(e) => setSearchQuery(e.target.value)}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: spacing[3],\n\t\t\t\t\t\t\t\tborder: `1px solid ${colors.gray[300]}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Content */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\toverflowY: 'auto',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4] }}>‚è≥</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.gray[600] }}>Loading your devices...</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : errorMsg ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4], color: colors.error[500] }}>\n\t\t\t\t\t\t\t\t‚ö†Ô∏è\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.error[600] }}>{errorMsg}</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : availableDevices.length === 0 ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4] }}>üì±</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.gray[600] }}>\n\t\t\t\t\t\t\t\tNo active MFA devices found. Please register a device first.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : (\n\t\t\t\t\t\t<div style={{ display: 'grid', gap: spacing[4] }}>\n\t\t\t\t\t\t\t{availableDevices.map((device) => (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tkey={device.id}\n\t\t\t\t\t\t\t\t\tonClick={() => handleDeviceSelect(device)}\n\t\t\t\t\t\t\t\t\tonKeyDown={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (e.key === 'Enter' || e.key === ' ') {\n\t\t\t\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t\t\t\thandleDeviceSelect(device);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: spacing[4],\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${colors.gray[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: spacing[4],\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = DEVICE_COLORS[device.type];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.backgroundColor = colors.gray[50];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = colors.gray[200];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.backgroundColor = 'white';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\ttabIndex={0}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{/* Device Icon */}\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\t\twidth: '48px',\n\t\t\t\t\t\t\t\t\t\t\theight: '48px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tbackground: `${DEVICE_COLORS[device.type]}15`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{DEVICE_ICONS[device.type]}\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Device Info */}\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[900],\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: spacing[1],\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{device.nickname || device.deviceName || `${device.type} Device`}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'center', gap: spacing[2] }}>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[600],\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: `${DEVICE_COLORS[device.type]}15`,\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 6px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{device.type}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 6px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: STATUS_BADGES[device.status].bg,\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: STATUS_BADGES[device.status].color,\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{STATUS_BADGES[device.status].text}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Arrow */}\n\t\t\t\t\t\t\t\t\t<div style={{ color: colors.gray[400] }}>‚Üí</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\n\t\t\t\t{/* Footer */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\tborderTop: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div style={{ fontSize: '12px', color: colors.gray[500] }}>\n\t\t\t\t\t\t{availableDevices.length} device{availableDevices.length !== 1 ? 's' : ''} available\n\t\t\t\t\t</div>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: `${spacing[2]} ${spacing[4]}`,\n\t\t\t\t\t\t\tbackground: colors.gray[100],\n\t\t\t\t\t\t\tborder: `1px solid ${colors.gray[300]}`,\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcolor: colors.gray[700],\n\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tCancel\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n"},"tags":[],"source":null},{"category":"lint/correctness/noUnusedFunctionParameters","severity":"warning","description":"This parameter is unused.","message":[{"elements":[],"content":"This "},{"elements":["Emphasis"],"content":"parameter"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused parameters might be the result of an incomplete refactoring."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedDeviceSelectionModal.tsx"},"span":[1829,1836],"sourceCode":"/**\n * @file UnifiedDeviceSelectionModal.tsx\n * @module v8/flows/unified/components\n * @description Modern device selection modal for MFA authentication\n * @version 9.2.2\n * @since 2026-01-30\n *\n * Purpose: Allow users to select which MFA device to authenticate with\n * Shows all registered devices with their types and status\n */\n\nimport React, { useEffect, useState } from 'react';\nimport { MFAServiceV8 } from '@/v8/services/mfaServiceV8';\nimport { colors, spacing } from '@/v8/styles/designTokens';\n\ninterface Device {\n\tid: string;\n\ttype: 'SMS' | 'EMAIL' | 'TOTP' | 'VOICE' | 'FIDO2' | 'MOBILE' | 'WHATSAPP';\n\tdeviceName?: string;\n\tnickname?: string;\n\tstatus:\n\t\t| 'ACTIVE'\n\t\t| 'ACTIVATION_REQUIRED'\n\t\t| 'DISABLED'\n\t\t| 'BLOCKED'\n\t\t| 'LOCKED'\n\t\t| 'PENDING'\n\t\t| 'SUSPENDED'\n\t\t| 'EXPIRED';\n}\n\ninterface UnifiedDeviceSelectionModalProps {\n\tisOpen: boolean;\n\tonClose: () => void;\n\tonDeviceSelect: (device: Device) => void;\n\tusername: string;\n\tenvironmentId: string;\n\tloading?: boolean;\n\terror?: string;\n}\n\nconst DEVICE_ICONS = {\n\tSMS: 'üì±',\n\tEMAIL: 'üìß',\n\tTOTP: 'üîê',\n\tVOICE: 'üìû',\n\tFIDO2: 'üîë',\n\tMOBILE: 'üì≤',\n\tWHATSAPP: 'üí¨',\n};\n\nconst DEVICE_COLORS = {\n\tSMS: colors.primary[600],\n\tEMAIL: colors.success[600],\n\tTOTP: colors.purple[600],\n\tVOICE: colors.warning[600],\n\tFIDO2: colors.info[600],\n\tMOBILE: colors.primary[500],\n\tWHATSAPP: colors.success[500],\n};\n\nconst STATUS_BADGES = {\n\tACTIVE: { text: 'Active', color: colors.success[600], bg: colors.success[50] },\n\tACTIVATION_REQUIRED: {\n\t\ttext: 'Activation Required',\n\t\tcolor: colors.warning[600],\n\t\tbg: colors.warning[50],\n\t},\n\tDISABLED: { text: 'Disabled', color: colors.gray[600], bg: colors.gray[50] },\n};\n\nexport const UnifiedDeviceSelectionModal: React.FC<UnifiedDeviceSelectionModalProps> = ({\n\tisOpen,\n\tonClose,\n\tonDeviceSelect,\n\tusername,\n\tenvironmentId,\n\tloading = false,\n\terror = null,\n}) => {\n\tconst [devices, setDevices] = useState<Device[]>([]);\n\tconst [searchQuery, setSearchQuery] = useState('');\n\tconst [isLoading, setIsLoading] = useState(false);\n\tconst [errorMsg, setErrorMsg] = useState<string | null>(null);\n\n\t// Fetch real devices from API\n\tuseEffect(() => {\n\t\tif (isOpen && username && environmentId) {\n\t\t\tconst fetchDevices = async () => {\n\t\t\t\tsetIsLoading(true);\n\t\t\t\tsetErrorMsg(null);\n\t\t\t\ttry {\n\t\t\t\t\tconst allDevices = await MFAServiceV8.getAllDevices({\n\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\tusername,\n\t\t\t\t\t});\n\n\t\t\t\t\t// Filter out devices with ACTIVATION_REQUIRED status\n\t\t\t\t\t// Only show ACTIVE devices for authentication\n\t\t\t\t\tconst activeDevices = allDevices\n\t\t\t\t\t\t.filter((device: any) => device.status === 'ACTIVE')\n\t\t\t\t\t\t.map((device: any) => ({\n\t\t\t\t\t\t\tid: device.id,\n\t\t\t\t\t\t\ttype: device.type,\n\t\t\t\t\t\t\tdeviceName: device.name || device.phone?.number || device.email?.address,\n\t\t\t\t\t\t\tnickname: device.nickname,\n\t\t\t\t\t\t\tstatus: device.status,\n\t\t\t\t\t\t}));\n\n\t\t\t\t\tconsole.log('[DEVICE-SELECTION] Loaded devices:', activeDevices.length, 'active devices');\n\t\t\t\t\tsetDevices(activeDevices);\n\t\t\t\t} catch (err) {\n\t\t\t\t\tconsole.error('[DEVICE-SELECTION] Error loading devices:', err);\n\t\t\t\t\tsetErrorMsg(err instanceof Error ? err.message : 'Failed to load devices');\n\t\t\t\t} finally {\n\t\t\t\t\tsetIsLoading(false);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tfetchDevices();\n\t\t}\n\t}, [isOpen, username, environmentId]);\n\n\t// Filter devices based on search query\n\tconst filteredDevices = devices.filter(\n\t\t(device) =>\n\t\t\tdevice.deviceName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n\t\t\tdevice.nickname?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n\t\t\tdevice.type.toLowerCase().includes(searchQuery.toLowerCase())\n\t);\n\n\t// Only show active devices for authentication\n\tconst availableDevices = filteredDevices.filter((device) => device.status === 'ACTIVE');\n\n\tconst handleDeviceSelect = (device: Device) => {\n\t\tonDeviceSelect(device);\n\t\tonClose();\n\t};\n\n\tif (!isOpen) return null;\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tposition: 'fixed',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\tdisplay: 'flex',\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tzIndex: 1000,\n\t\t\t}}\n\t\t\tonClick={onClose}\n\t\t\tonKeyDown={(e) => {\n\t\t\t\tif (e.key === 'Escape') {\n\t\t\t\t\tonClose();\n\t\t\t\t}\n\t\t\t}}\n\t\t\trole=\"dialog\"\n\t\t\taria-modal=\"true\"\n\t\t>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'white',\n\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\tboxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',\n\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\twidth: '90%',\n\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t}}\n\t\t\t\tonClick={(e) => e.stopPropagation()}\n\t\t\t>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\tborderBottom: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tmarginBottom: spacing[4],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: 0, fontSize: '20px', fontWeight: '700', color: colors.gray[900] }}>\n\t\t\t\t\t\t\tüîì Select Authentication Device\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'none',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\tcolor: colors.gray[400],\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tpadding: '0',\n\t\t\t\t\t\t\t\tlineHeight: 1,\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t√ó\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style={{ fontSize: '14px', color: colors.gray[600], lineHeight: 1.5 }}>\n\t\t\t\t\t\tChoose which MFA device to authenticate with for <strong>{username}</strong>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Search */}\n\t\t\t\t\t<div style={{ marginTop: spacing[4] }}>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tplaceholder=\"Search devices...\"\n\t\t\t\t\t\t\tvalue={searchQuery}\n\t\t\t\t\t\t\tonChange={(e) => setSearchQuery(e.target.value)}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: spacing[3],\n\t\t\t\t\t\t\t\tborder: `1px solid ${colors.gray[300]}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Content */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\toverflowY: 'auto',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4] }}>‚è≥</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.gray[600] }}>Loading your devices...</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : errorMsg ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4], color: colors.error[500] }}>\n\t\t\t\t\t\t\t\t‚ö†Ô∏è\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.error[600] }}>{errorMsg}</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : availableDevices.length === 0 ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4] }}>üì±</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.gray[600] }}>\n\t\t\t\t\t\t\t\tNo active MFA devices found. Please register a device first.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : (\n\t\t\t\t\t\t<div style={{ display: 'grid', gap: spacing[4] }}>\n\t\t\t\t\t\t\t{availableDevices.map((device) => (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tkey={device.id}\n\t\t\t\t\t\t\t\t\tonClick={() => handleDeviceSelect(device)}\n\t\t\t\t\t\t\t\t\tonKeyDown={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (e.key === 'Enter' || e.key === ' ') {\n\t\t\t\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t\t\t\thandleDeviceSelect(device);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: spacing[4],\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${colors.gray[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: spacing[4],\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = DEVICE_COLORS[device.type];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.backgroundColor = colors.gray[50];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = colors.gray[200];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.backgroundColor = 'white';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\ttabIndex={0}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{/* Device Icon */}\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\t\twidth: '48px',\n\t\t\t\t\t\t\t\t\t\t\theight: '48px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tbackground: `${DEVICE_COLORS[device.type]}15`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{DEVICE_ICONS[device.type]}\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Device Info */}\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[900],\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: spacing[1],\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{device.nickname || device.deviceName || `${device.type} Device`}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'center', gap: spacing[2] }}>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[600],\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: `${DEVICE_COLORS[device.type]}15`,\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 6px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{device.type}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 6px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: STATUS_BADGES[device.status].bg,\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: STATUS_BADGES[device.status].color,\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{STATUS_BADGES[device.status].text}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Arrow */}\n\t\t\t\t\t\t\t\t\t<div style={{ color: colors.gray[400] }}>‚Üí</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\n\t\t\t\t{/* Footer */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\tborderTop: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div style={{ fontSize: '12px', color: colors.gray[500] }}>\n\t\t\t\t\t\t{availableDevices.length} device{availableDevices.length !== 1 ? 's' : ''} available\n\t\t\t\t\t</div>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: `${spacing[2]} ${spacing[4]}`,\n\t\t\t\t\t\t\tbackground: colors.gray[100],\n\t\t\t\t\t\t\tborder: `1px solid ${colors.gray[300]}`,\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcolor: colors.gray[700],\n\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tCancel\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n"},"tags":[],"source":null},{"category":"lint/correctness/noUnusedFunctionParameters","severity":"warning","description":"This parameter is unused.","message":[{"elements":[],"content":"This "},{"elements":["Emphasis"],"content":"parameter"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused parameters might be the result of an incomplete refactoring."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedDeviceSelectionModal.tsx"},"span":[1847,1852],"sourceCode":"/**\n * @file UnifiedDeviceSelectionModal.tsx\n * @module v8/flows/unified/components\n * @description Modern device selection modal for MFA authentication\n * @version 9.2.2\n * @since 2026-01-30\n *\n * Purpose: Allow users to select which MFA device to authenticate with\n * Shows all registered devices with their types and status\n */\n\nimport React, { useEffect, useState } from 'react';\nimport { MFAServiceV8 } from '@/v8/services/mfaServiceV8';\nimport { colors, spacing } from '@/v8/styles/designTokens';\n\ninterface Device {\n\tid: string;\n\ttype: 'SMS' | 'EMAIL' | 'TOTP' | 'VOICE' | 'FIDO2' | 'MOBILE' | 'WHATSAPP';\n\tdeviceName?: string;\n\tnickname?: string;\n\tstatus:\n\t\t| 'ACTIVE'\n\t\t| 'ACTIVATION_REQUIRED'\n\t\t| 'DISABLED'\n\t\t| 'BLOCKED'\n\t\t| 'LOCKED'\n\t\t| 'PENDING'\n\t\t| 'SUSPENDED'\n\t\t| 'EXPIRED';\n}\n\ninterface UnifiedDeviceSelectionModalProps {\n\tisOpen: boolean;\n\tonClose: () => void;\n\tonDeviceSelect: (device: Device) => void;\n\tusername: string;\n\tenvironmentId: string;\n\tloading?: boolean;\n\terror?: string;\n}\n\nconst DEVICE_ICONS = {\n\tSMS: 'üì±',\n\tEMAIL: 'üìß',\n\tTOTP: 'üîê',\n\tVOICE: 'üìû',\n\tFIDO2: 'üîë',\n\tMOBILE: 'üì≤',\n\tWHATSAPP: 'üí¨',\n};\n\nconst DEVICE_COLORS = {\n\tSMS: colors.primary[600],\n\tEMAIL: colors.success[600],\n\tTOTP: colors.purple[600],\n\tVOICE: colors.warning[600],\n\tFIDO2: colors.info[600],\n\tMOBILE: colors.primary[500],\n\tWHATSAPP: colors.success[500],\n};\n\nconst STATUS_BADGES = {\n\tACTIVE: { text: 'Active', color: colors.success[600], bg: colors.success[50] },\n\tACTIVATION_REQUIRED: {\n\t\ttext: 'Activation Required',\n\t\tcolor: colors.warning[600],\n\t\tbg: colors.warning[50],\n\t},\n\tDISABLED: { text: 'Disabled', color: colors.gray[600], bg: colors.gray[50] },\n};\n\nexport const UnifiedDeviceSelectionModal: React.FC<UnifiedDeviceSelectionModalProps> = ({\n\tisOpen,\n\tonClose,\n\tonDeviceSelect,\n\tusername,\n\tenvironmentId,\n\tloading = false,\n\terror = null,\n}) => {\n\tconst [devices, setDevices] = useState<Device[]>([]);\n\tconst [searchQuery, setSearchQuery] = useState('');\n\tconst [isLoading, setIsLoading] = useState(false);\n\tconst [errorMsg, setErrorMsg] = useState<string | null>(null);\n\n\t// Fetch real devices from API\n\tuseEffect(() => {\n\t\tif (isOpen && username && environmentId) {\n\t\t\tconst fetchDevices = async () => {\n\t\t\t\tsetIsLoading(true);\n\t\t\t\tsetErrorMsg(null);\n\t\t\t\ttry {\n\t\t\t\t\tconst allDevices = await MFAServiceV8.getAllDevices({\n\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\tusername,\n\t\t\t\t\t});\n\n\t\t\t\t\t// Filter out devices with ACTIVATION_REQUIRED status\n\t\t\t\t\t// Only show ACTIVE devices for authentication\n\t\t\t\t\tconst activeDevices = allDevices\n\t\t\t\t\t\t.filter((device: any) => device.status === 'ACTIVE')\n\t\t\t\t\t\t.map((device: any) => ({\n\t\t\t\t\t\t\tid: device.id,\n\t\t\t\t\t\t\ttype: device.type,\n\t\t\t\t\t\t\tdeviceName: device.name || device.phone?.number || device.email?.address,\n\t\t\t\t\t\t\tnickname: device.nickname,\n\t\t\t\t\t\t\tstatus: device.status,\n\t\t\t\t\t\t}));\n\n\t\t\t\t\tconsole.log('[DEVICE-SELECTION] Loaded devices:', activeDevices.length, 'active devices');\n\t\t\t\t\tsetDevices(activeDevices);\n\t\t\t\t} catch (err) {\n\t\t\t\t\tconsole.error('[DEVICE-SELECTION] Error loading devices:', err);\n\t\t\t\t\tsetErrorMsg(err instanceof Error ? err.message : 'Failed to load devices');\n\t\t\t\t} finally {\n\t\t\t\t\tsetIsLoading(false);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tfetchDevices();\n\t\t}\n\t}, [isOpen, username, environmentId]);\n\n\t// Filter devices based on search query\n\tconst filteredDevices = devices.filter(\n\t\t(device) =>\n\t\t\tdevice.deviceName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n\t\t\tdevice.nickname?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n\t\t\tdevice.type.toLowerCase().includes(searchQuery.toLowerCase())\n\t);\n\n\t// Only show active devices for authentication\n\tconst availableDevices = filteredDevices.filter((device) => device.status === 'ACTIVE');\n\n\tconst handleDeviceSelect = (device: Device) => {\n\t\tonDeviceSelect(device);\n\t\tonClose();\n\t};\n\n\tif (!isOpen) return null;\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tposition: 'fixed',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\tdisplay: 'flex',\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tzIndex: 1000,\n\t\t\t}}\n\t\t\tonClick={onClose}\n\t\t\tonKeyDown={(e) => {\n\t\t\t\tif (e.key === 'Escape') {\n\t\t\t\t\tonClose();\n\t\t\t\t}\n\t\t\t}}\n\t\t\trole=\"dialog\"\n\t\t\taria-modal=\"true\"\n\t\t>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'white',\n\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\tboxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',\n\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\twidth: '90%',\n\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t}}\n\t\t\t\tonClick={(e) => e.stopPropagation()}\n\t\t\t>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\tborderBottom: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tmarginBottom: spacing[4],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: 0, fontSize: '20px', fontWeight: '700', color: colors.gray[900] }}>\n\t\t\t\t\t\t\tüîì Select Authentication Device\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'none',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\tcolor: colors.gray[400],\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tpadding: '0',\n\t\t\t\t\t\t\t\tlineHeight: 1,\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t√ó\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style={{ fontSize: '14px', color: colors.gray[600], lineHeight: 1.5 }}>\n\t\t\t\t\t\tChoose which MFA device to authenticate with for <strong>{username}</strong>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Search */}\n\t\t\t\t\t<div style={{ marginTop: spacing[4] }}>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tplaceholder=\"Search devices...\"\n\t\t\t\t\t\t\tvalue={searchQuery}\n\t\t\t\t\t\t\tonChange={(e) => setSearchQuery(e.target.value)}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: spacing[3],\n\t\t\t\t\t\t\t\tborder: `1px solid ${colors.gray[300]}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Content */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\toverflowY: 'auto',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4] }}>‚è≥</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.gray[600] }}>Loading your devices...</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : errorMsg ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4], color: colors.error[500] }}>\n\t\t\t\t\t\t\t\t‚ö†Ô∏è\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.error[600] }}>{errorMsg}</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : availableDevices.length === 0 ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4] }}>üì±</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.gray[600] }}>\n\t\t\t\t\t\t\t\tNo active MFA devices found. Please register a device first.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : (\n\t\t\t\t\t\t<div style={{ display: 'grid', gap: spacing[4] }}>\n\t\t\t\t\t\t\t{availableDevices.map((device) => (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tkey={device.id}\n\t\t\t\t\t\t\t\t\tonClick={() => handleDeviceSelect(device)}\n\t\t\t\t\t\t\t\t\tonKeyDown={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (e.key === 'Enter' || e.key === ' ') {\n\t\t\t\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t\t\t\thandleDeviceSelect(device);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: spacing[4],\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${colors.gray[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: spacing[4],\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = DEVICE_COLORS[device.type];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.backgroundColor = colors.gray[50];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = colors.gray[200];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.backgroundColor = 'white';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\ttabIndex={0}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{/* Device Icon */}\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\t\twidth: '48px',\n\t\t\t\t\t\t\t\t\t\t\theight: '48px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tbackground: `${DEVICE_COLORS[device.type]}15`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{DEVICE_ICONS[device.type]}\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Device Info */}\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[900],\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: spacing[1],\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{device.nickname || device.deviceName || `${device.type} Device`}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'center', gap: spacing[2] }}>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[600],\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: `${DEVICE_COLORS[device.type]}15`,\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 6px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{device.type}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 6px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: STATUS_BADGES[device.status].bg,\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: STATUS_BADGES[device.status].color,\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{STATUS_BADGES[device.status].text}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Arrow */}\n\t\t\t\t\t\t\t\t\t<div style={{ color: colors.gray[400] }}>‚Üí</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\n\t\t\t\t{/* Footer */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\tborderTop: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div style={{ fontSize: '12px', color: colors.gray[500] }}>\n\t\t\t\t\t\t{availableDevices.length} device{availableDevices.length !== 1 ? 's' : ''} available\n\t\t\t\t\t</div>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: `${spacing[2]} ${spacing[4]}`,\n\t\t\t\t\t\t\tbackground: colors.gray[100],\n\t\t\t\t\t\t\tborder: `1px solid ${colors.gray[300]}`,\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcolor: colors.gray[700],\n\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tCancel\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n"},"tags":[],"source":null},{"category":"lint/correctness/useExhaustiveDependencies","severity":"warning","description":"loadDevices changes on every re-render and should not be used as a hook dependency.","message":[{"elements":["Emphasis"],"content":"loadDevices"},{"elements":[],"content":" changes on every re-render and should not be used as a hook dependency."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"To fix this, wrap the definition of "},{"elements":["Emphasis"],"content":"loadDevices"},{"elements":[],"content":" in its own "},{"elements":["Emphasis"],"content":"useCallback()"},{"elements":[],"content":" hook."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedDeviceSelectionStep.modern.tsx"},"span":[2085,2096],"sourceCode":"/**\n * @file UnifiedDeviceSelectionStep.modern.tsx\n * @module v8/flows/unified/components\n * @description MODERNIZED Step 1: Device Selection - Modern card-based UI\n * @version 9.2.0\n * @since 2026-01-29\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport { FiArrowRight, FiCheck, FiKey, FiMail, FiPlus, FiSmartphone } from 'react-icons/fi';\nimport { Button } from '@/v8/components/Button';\nimport { EmptyState } from '@/v8/components/EmptyState';\nimport { LoadingSpinner } from '@/v8/components/LoadingSpinner';\nimport { PageTransition } from '@/v8/components/PageTransition';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport { useGlobalMFA } from '@/v8/contexts/GlobalMFAContext';\nimport { borderRadius, colors, spacing, typography } from '@/v8/design/tokens';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { unifiedFlowServiceIntegration } from '@/v8/flows/unified/services/unifiedFlowServiceIntegration';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[üîç DEVICE-SELECTION-MODERN]';\n\ninterface ExistingDevice {\n\tid: string;\n\ttype: string;\n\tname?: string;\n\tstatus: string;\n\tphone?: string;\n\temail?: string;\n\tcreatedAt?: string;\n}\n\nexport interface UnifiedDeviceSelectionStepProps extends MFAFlowBaseRenderProps {\n\tconfig: DeviceFlowConfig;\n\tdeviceType: string;\n}\n\nexport const UnifiedDeviceSelectionStepModern: React.FC<UnifiedDeviceSelectionStepProps> = ({\n\tcredentials,\n\tsetMfaState,\n\tnav,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering for:`, config.deviceType);\n\n\tconst { isConfigured } = useGlobalMFA();\n\tconst [existingDevices, setExistingDevices] = useState<ExistingDevice[]>([]);\n\tconst [selectedDeviceId, setSelectedDeviceId] = useState<string | null>(null);\n\tconst [isLoading, setIsLoading] = useState(false);\n\tconst [loadError, setLoadError] = useState<string | null>(null);\n\n\t// Load existing devices\n\tuseEffect(() => {\n\t\tif (isConfigured && credentials.username) {\n\t\t\tloadDevices();\n\t\t}\n\t}, [isConfigured, credentials.username, loadDevices]);\n\n\tconst loadDevices = async () => {\n\t\tsetIsLoading(true);\n\t\tsetLoadError(null);\n\n\t\ttry {\n\t\t\tconst devices = await unifiedFlowServiceIntegration.listDevices(\n\t\t\t\tcredentials.username,\n\t\t\t\t`type eq \"${config.deviceType}\"`\n\t\t\t);\n\n\t\t\tsetExistingDevices(devices as unknown as ExistingDevice[]);\n\n\t\t\tif (devices.length === 0) {\n\t\t\t\ttoastV8.info(`No existing ${config.displayName} devices found`);\n\t\t\t}\n\t\t} catch (error: unknown) {\n\t\t\tconst errorMsg = error instanceof Error ? error.message : 'Failed to load devices';\n\t\t\tsetLoadError(errorMsg);\n\t\t\ttoastV8.error(errorMsg);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t};\n\n\tconst handleUseDevice = useCallback(() => {\n\t\tif (!selectedDeviceId) {\n\t\t\ttoastV8.warning('Please select a device');\n\t\t\treturn;\n\t\t}\n\n\t\tconst device = existingDevices.find((d) => d.id === selectedDeviceId);\n\t\tif (!device) return;\n\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: device.id,\n\t\t\tdeviceStatus: device.status,\n\t\t}));\n\n\t\tnav.markStepComplete();\n\t\tnav.goToStep(3); // Skip to activation\n\t\ttoastV8.success(`Using ${device.name || config.displayName}`);\n\t}, [selectedDeviceId, existingDevices, config, setMfaState, nav]);\n\n\tconst handleRegisterNew = useCallback(() => {\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: '',\n\t\t\tdeviceStatus: '',\n\t\t}));\n\n\t\tnav.markStepComplete();\n\t\tnav.goToNext();\n\t}, [setMfaState, nav]);\n\n\tconst getDeviceIcon = (type: string) => {\n\t\tswitch (type.toUpperCase()) {\n\t\t\tcase 'SMS':\n\t\t\tcase 'MOBILE':\n\t\t\t\treturn <FiSmartphone size={32} />;\n\t\t\tcase 'EMAIL':\n\t\t\t\treturn <FiMail size={32} />;\n\t\t\tcase 'TOTP':\n\t\t\tcase 'FIDO2':\n\t\t\t\treturn <FiKey size={32} />;\n\t\t\tdefault:\n\t\t\t\treturn <FiSmartphone size={32} />;\n\t\t}\n\t};\n\n\tif (isLoading) {\n\t\treturn (\n\t\t\t<div style={{ padding: spacing['3xl'], textAlign: 'center' }}>\n\t\t\t\t<LoadingSpinner size=\"large\" text=\"Loading devices...\" />\n\t\t\t</div>\n\t\t);\n\t}\n\n\treturn (\n\t\t<PageTransition>\n\t\t\t<div style={{ maxWidth: '900px', margin: '0 auto', padding: spacing.xl }}>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: `linear-gradient(135deg, ${colors.primary[500]} 0%, ${colors.primary[700]} 100%)`,\n\t\t\t\t\t\tborderRadius: borderRadius.xl,\n\t\t\t\t\t\tpadding: spacing.xl,\n\t\t\t\t\t\tmarginBottom: spacing.xl,\n\t\t\t\t\t\tboxShadow: `0 4px 12px ${colors.primary[500]}33`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<h2\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tmargin: `0 0 ${spacing.sm} 0`,\n\t\t\t\t\t\t\tfontSize: typography.fontSize['3xl'],\n\t\t\t\t\t\t\tfontWeight: typography.fontWeight.bold,\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tgap: spacing.md,\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{config.icon} Select {config.displayName} Device\n\t\t\t\t\t</h2>\n\t\t\t\t\t<p style={{ margin: 0, color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\tChoose an existing device or register a new one\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Error State */}\n\t\t\t\t{loadError && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: colors.error[50],\n\t\t\t\t\t\t\tborder: `1px solid ${colors.error[500]}`,\n\t\t\t\t\t\t\tborderRadius: borderRadius.lg,\n\t\t\t\t\t\t\tpadding: spacing.lg,\n\t\t\t\t\t\t\tmarginBottom: spacing.xl,\n\t\t\t\t\t\t\tcolor: colors.error[900],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{loadError}\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tvariant=\"outline\"\n\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\tonClick={loadDevices}\n\t\t\t\t\t\t\tstyle={{ marginLeft: spacing.md }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tRetry\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{/* Existing Devices */}\n\t\t\t\t{existingDevices.length > 0 && (\n\t\t\t\t\t<div style={{ marginBottom: spacing.xl }}>\n\t\t\t\t\t\t<h3 style={{ margin: `0 0 ${spacing.lg} 0`, color: colors.neutral[900] }}>\n\t\t\t\t\t\t\tExisting Devices\n\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t<div style={{ display: 'grid', gap: spacing.md }}>\n\t\t\t\t\t\t\t{existingDevices.map((device) => (\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\tkey={device.id}\n\t\t\t\t\t\t\t\t\tonClick={() => setSelectedDeviceId(device.id)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: spacing.lg,\n\t\t\t\t\t\t\t\t\t\tbackground: selectedDeviceId === device.id ? colors.primary[50] : 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${selectedDeviceId === device.id ? colors.primary[500] : colors.neutral[300]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: borderRadius.lg,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: spacing.lg,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcolor:\n\t\t\t\t\t\t\t\t\t\t\t\tselectedDeviceId === device.id ? colors.primary[500] : colors.neutral[400],\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{getDeviceIcon(device.type)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: typography.fontWeight.semibold,\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.neutral[900],\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{device.name || `${device.type} Device`}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div style={{ fontSize: typography.fontSize.sm, color: colors.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\t\t{device.phone || device.email || device.id}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: typography.fontSize.xs,\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.neutral[400],\n\t\t\t\t\t\t\t\t\t\t\t\tmarginTop: spacing.xs,\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tStatus: {device.status}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t{selectedDeviceId === device.id && (\n\t\t\t\t\t\t\t\t\t\t<FiCheck size={24} color={colors.primary[500]} />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style={{ marginTop: spacing.lg }}>\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t\t\t\tsize=\"lg\"\n\t\t\t\t\t\t\t\tonClick={handleUseDevice}\n\t\t\t\t\t\t\t\tdisabled={!selectedDeviceId}\n\t\t\t\t\t\t\t\trightIcon={<FiArrowRight />}\n\t\t\t\t\t\t\t\tfullWidth\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUse Selected Device\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{/* Empty State */}\n\t\t\t\t{existingDevices.length === 0 && !loadError && (\n\t\t\t\t\t<EmptyState\n\t\t\t\t\t\ticon={getDeviceIcon(config.deviceType)}\n\t\t\t\t\t\ttitle={`No ${config.displayName} Devices`}\n\t\t\t\t\t\tdescription={`You haven't registered any ${config.displayName} devices yet. Register a new device to get started.`}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\n\t\t\t\t{/* Register New Device */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\tborderRadius: borderRadius.xl,\n\t\t\t\t\t\tpadding: spacing.xl,\n\t\t\t\t\t\tborder: `2px dashed ${colors.neutral[300]}`,\n\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<h3 style={{ margin: `0 0 ${spacing.md} 0`, color: colors.neutral[900] }}>\n\t\t\t\t\t\tRegister New Device\n\t\t\t\t\t</h3>\n\t\t\t\t\t<p style={{ margin: `0 0 ${spacing.lg} 0`, color: colors.neutral[600] }}>\n\t\t\t\t\t\tAdd a new {config.displayName} device to your account\n\t\t\t\t\t</p>\n\t\t\t\t\t<Button variant=\"primary\" size=\"lg\" onClick={handleRegisterNew} leftIcon={<FiPlus />}>\n\t\t\t\t\t\tRegister New {config.displayName}\n\t\t\t\t\t</Button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</PageTransition>\n\t);\n};\n\nexport default UnifiedDeviceSelectionStepModern;\n"},"tags":[],"source":null},{"category":"lint/correctness/noUnusedFunctionParameters","severity":"warning","description":"This parameter is unused.","message":[{"elements":[],"content":"This "},{"elements":["Emphasis"],"content":"parameter"},{"elements":[],"content":" is unused."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Unused parameters might be the result of an incomplete refactoring."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedDeviceSelectionStep.tsx"},"span":[2224,2238],"sourceCode":"/**\n * @file UnifiedDeviceSelectionStep.tsx\n * @module v8/flows/unified/components\n * @description Step 1: Device Selection - Load and select existing devices or register new\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Allow users to select an existing device for authentication or register a new device\n *\n * Flow:\n * 1. Load existing devices from API\n * 2. Display device list (if any)\n * 3. Allow selection of existing device\n * 4. Provide \"Register New Device\" button\n * 5. Navigate to registration or authentication step based on selection\n *\n * @example\n * <UnifiedDeviceSelectionStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n * />\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[üîç UNIFIED-DEVICE-SELECTION-STEP]';\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\ninterface ExistingDevice {\n\tid: string;\n\ttype: string;\n\tname?: string;\n\tstatus: string;\n\tphone?: string;\n\temail?: string;\n\tcreatedAt?: string;\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedDeviceSelectionStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Device Selection Step (Step 1)\n *\n * Loads existing devices and allows user to select one or register a new device.\n */\nexport const UnifiedDeviceSelectionStep: React.FC<UnifiedDeviceSelectionStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering device selection step for:`, config.deviceType);\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [existingDevices, setExistingDevices] = useState<ExistingDevice[]>([]);\n\tconst [selectedDeviceId, setSelectedDeviceId] = useState<string | null>(null);\n\tconst [loadError, setLoadError] = useState<string | null>(null);\n\tconst [hasLoadedDevices, setHasLoadedDevices] = useState(false);\n\n\t// ========================================================================\n\t// EFFECTS\n\t// ========================================================================\n\n\t/**\n\t * Load existing devices on mount\n\t */\n\tuseEffect(() => {\n\t\tif (!hasLoadedDevices && credentials.environmentId && credentials.username) {\n\t\t\tloadExistingDevices();\n\t\t}\n\t}, [hasLoadedDevices, credentials.environmentId, credentials.username, loadExistingDevices]);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Load existing devices for the user\n\t */\n\tconst loadExistingDevices = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Loading existing devices for user:`, credentials.username);\n\n\t\tsetIsLoading(true);\n\t\tsetLoadError(null);\n\n\t\ttry {\n\t\t\t// Call controller to load existing devices\n\t\t\tconst devices = await controller.loadExistingDevices(credentials, mfaState, tokenStatus, nav);\n\n\t\t\tconsole.log(`${MODULE_TAG} Loaded ${devices.length} existing devices:`, devices);\n\n\t\t\tsetExistingDevices(devices);\n\t\t\tsetHasLoadedDevices(true);\n\n\t\t\t// If no devices, show info toast\n\t\t\tif (devices.length === 0) {\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t`No existing ${config.displayName} devices found. Register a new device to continue.`\n\t\t\t\t);\n\t\t\t}\n\t\t} catch (error: unknown) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to load existing devices:`, error);\n\n\t\t\tconst errorMessage =\n\t\t\t\terror instanceof Error ? error.message : 'Failed to load existing devices';\n\t\t\tsetLoadError(errorMessage);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [credentials, mfaState, tokenStatus, config, controller, nav, setIsLoading]);\n\n\t/**\n\t * Handle device selection\n\t */\n\tconst handleSelectDevice = useCallback((deviceId: string) => {\n\t\tconsole.log(`${MODULE_TAG} Device selected:`, deviceId);\n\t\tsetSelectedDeviceId(deviceId);\n\t}, []);\n\n\t/**\n\t * Handle \"Use Selected Device\" button click\n\t */\n\tconst handleUseSelectedDevice = useCallback(() => {\n\t\tif (!selectedDeviceId) {\n\t\t\ttoastV8.warning('Please select a device first');\n\t\t\treturn;\n\t\t}\n\n\t\tconst device = existingDevices.find((d) => d.id === selectedDeviceId);\n\t\tif (!device) {\n\t\t\ttoastV8.error('Selected device not found');\n\t\t\treturn;\n\t\t}\n\n\t\tconsole.log(`${MODULE_TAG} Using existing device:`, device);\n\n\t\t// Update MFA state with selected device\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: device.id,\n\t\t\tdeviceStatus: device.status,\n\t\t\texistingDevice: true,\n\t\t}));\n\n\t\t// Show success toast\n\t\ttoastV8.success(`Using existing ${config.displayName} device`);\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to authentication/activation step\n\t\t// Skip registration since device already exists\n\t\tnav.goToStep(3); // Jump to activation step\n\t}, [selectedDeviceId, existingDevices, config, setMfaState, nav]);\n\n\t/**\n\t * Handle \"Register New Device\" button click\n\t */\n\tconst handleRegisterNewDevice = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} User wants to register a new device`);\n\n\t\t// Clear any previously selected device\n\t\tsetSelectedDeviceId(null);\n\n\t\t// Update MFA state to indicate new registration\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: undefined,\n\t\t\tdeviceStatus: undefined,\n\t\t\texistingDevice: false,\n\t\t}));\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to registration step\n\t\tnav.goToNext();\n\t}, [setMfaState, nav]);\n\n\t/**\n\t * Get device icon based on type\n\t */\n\tconst getDeviceIcon = (deviceType: string): string => {\n\t\tswitch (deviceType.toUpperCase()) {\n\t\t\tcase 'SMS':\n\t\t\t\treturn 'üì±';\n\t\t\tcase 'EMAIL':\n\t\t\t\treturn 'üìß';\n\t\t\tcase 'TOTP':\n\t\t\t\treturn 'üîê';\n\t\t\tcase 'FIDO2':\n\t\t\t\treturn 'üîë';\n\t\t\tcase 'MOBILE':\n\t\t\t\treturn 'üì≤';\n\t\t\tcase 'WHATSAPP':\n\t\t\t\treturn 'üí¨';\n\t\t\tdefault:\n\t\t\t\treturn 'üìü';\n\t\t}\n\t};\n\n\t/**\n\t * Get device display text (name, phone, or email)\n\t */\n\tconst getDeviceDisplayText = (device: ExistingDevice): string => {\n\t\tif (device.name) {\n\t\t\treturn device.name;\n\t\t}\n\t\tif (device.phone) {\n\t\t\treturn device.phone;\n\t\t}\n\t\tif (device.email) {\n\t\t\treturn device.email;\n\t\t}\n\t\treturn `Device ${device.id.substring(0, 8)}`;\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-device-selection-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Select or Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">\n\t\t\t\t\tChoose an existing device or register a new one for multi-factor authentication.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Loading State */}\n\t\t\t{isLoading && !hasLoadedDevices && (\n\t\t\t\t<div className=\"loading-indicator\">\n\t\t\t\t\t<div className=\"spinner\" />\n\t\t\t\t\t<p>Loading existing devices...</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Load Error */}\n\t\t\t{loadError && (\n\t\t\t\t<div className=\"error-card\" role=\"alert\">\n\t\t\t\t\t<h3>Failed to Load Devices</h3>\n\t\t\t\t\t<p>{loadError}</p>\n\t\t\t\t\t<button type=\"button\" onClick={loadExistingDevices} className=\"button-secondary\">\n\t\t\t\t\t\tRetry\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Device List */}\n\t\t\t{hasLoadedDevices && !loadError && (\n\t\t\t\t<div className=\"device-selection-container\">\n\t\t\t\t\t{/* Existing Devices */}\n\t\t\t\t\t{existingDevices.length > 0 && (\n\t\t\t\t\t\t<div className=\"existing-devices-section\">\n\t\t\t\t\t\t\t<h3>Existing Devices</h3>\n\t\t\t\t\t\t\t<p className=\"section-description\">\n\t\t\t\t\t\t\t\tSelect an existing device to use for authentication:\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t<div className=\"device-list\">\n\t\t\t\t\t\t\t\t{existingDevices.map((device) => (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tkey={device.id}\n\t\t\t\t\t\t\t\t\t\tclassName={`device-card ${selectedDeviceId === device.id ? 'selected' : ''}`}\n\t\t\t\t\t\t\t\t\t\tonClick={() => handleSelectDevice(device.id)}\n\t\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\t\ttabIndex={0}\n\t\t\t\t\t\t\t\t\t\tonKeyPress={(e) => {\n\t\t\t\t\t\t\t\t\t\t\tif (e.key === 'Enter' || e.key === ' ') {\n\t\t\t\t\t\t\t\t\t\t\t\thandleSelectDevice(device.id);\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\taria-selected={selectedDeviceId === device.id}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<div className=\"device-icon\">{getDeviceIcon(device.type)}</div>\n\t\t\t\t\t\t\t\t\t\t<div className=\"device-info\">\n\t\t\t\t\t\t\t\t\t\t\t<h4 className=\"device-name\">{getDeviceDisplayText(device)}</h4>\n\t\t\t\t\t\t\t\t\t\t\t<p className=\"device-type\">{device.type}</p>\n\t\t\t\t\t\t\t\t\t\t\t<span className={`device-status status-${device.status.toLowerCase()}`}>\n\t\t\t\t\t\t\t\t\t\t\t\t{device.status}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t{device.createdAt && (\n\t\t\t\t\t\t\t\t\t\t\t\t<p className=\"device-created\">\n\t\t\t\t\t\t\t\t\t\t\t\t\tCreated: {new Date(device.createdAt).toLocaleDateString()}\n\t\t\t\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedDeviceId === device.id && <div className=\"selection-indicator\">‚úì</div>}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t<div className=\"selected-device-actions\">\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleUseSelectedDevice}\n\t\t\t\t\t\t\t\t\tdisabled={!selectedDeviceId || isLoading}\n\t\t\t\t\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tUse Selected Device\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* No Existing Devices */}\n\t\t\t\t\t{existingDevices.length === 0 && (\n\t\t\t\t\t\t<div className=\"no-devices-message\">\n\t\t\t\t\t\t\t<div className=\"info-icon\">‚ÑπÔ∏è</div>\n\t\t\t\t\t\t\t<h3>No Existing Devices</h3>\n\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\tYou don't have any {config.displayName} devices registered yet. Register a new\n\t\t\t\t\t\t\t\tdevice to continue.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* Register New Device Section */}\n\t\t\t\t\t<div className=\"register-new-section\">\n\t\t\t\t\t\t<div className=\"section-divider\">\n\t\t\t\t\t\t\t<span>OR</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<h3>Register New Device</h3>\n\t\t\t\t\t\t<p className=\"section-description\">\n\t\t\t\t\t\t\tSet up a new {config.displayName} device for multi-factor authentication.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleRegisterNewDevice}\n\t\t\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t\t\t\tclassName=\"button-primary register-new-button\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t+ Register New {config.displayName} Device\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Navigation Buttons */}\n\t\t\t<div className=\"step-actions\">\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => nav.goToPrevious()}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t\tclassName=\"button-secondary\"\n\t\t\t\t>\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\t\t\t</div>\n\n\t\t\t{/* Token Status Warning */}\n\t\t\t{!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\nexport default UnifiedDeviceSelectionStep;\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedRegistrationStep.tsx"},"span":[8502,8505],"sourceCode":"/**\n * @file UnifiedRegistrationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 2: Device Registration - Unified registration for all device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle device registration for all 6 device types using either:\n * - DynamicFormRenderer (for SMS, Email, WhatsApp)\n * - Custom components (for TOTP, FIDO2, Mobile)\n *\n * Flow:\n * 1. Render appropriate UI based on device type\n * 2. Collect and validate device-specific information\n * 3. Call controller.registerDevice()\n * 4. Update mfaState with registration result\n * 5. Navigate to activation step\n *\n * @example\n * <UnifiedRegistrationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n *   deviceFields={deviceFields}\n *   setDeviceFields={setDeviceFields}\n *   errors={errors}\n *   validate={validate}\n * />\n */\n\nimport React, { useCallback, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type DeviceComponentProps, DeviceComponentRegistry } from './DeviceComponentRegistry';\nimport { DynamicFormRenderer } from './DynamicFormRenderer';\n\nconst MODULE_TAG = '[üìù UNIFIED-REGISTRATION-STEP]';\n\n// Exported helper to determine final device status after registration\nexport function computeDeviceStatus(resultStatus: string | undefined, deviceType: string, tokenType: string) {\n\tconst status = resultStatus || '';\n\tif (deviceType === 'TOTP') {\n\t\t// User flows must require activation\n\t\tif (tokenType === 'user') return 'ACTIVATION_REQUIRED';\n\t\t// For admin/worker flows, prefer returned status, but default to ACTIVATION_REQUIRED\n\t\treturn status || 'ACTIVATION_REQUIRED';\n\t}\n\treturn status || 'ACTIVE';\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedRegistrationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device-specific form field values */\n\tdeviceFields: Record<string, string>;\n\n\t/** Update device fields */\n\tsetDeviceFields: (\n\t\tfields: Record<string, string> | ((prev: Record<string, string>) => Record<string, string>)\n\t) => void;\n\n\t/** Validation errors */\n\terrors: Record<string, string>;\n\n\t/** Validation function */\n\tvalidate: () => boolean;\n\n\t/** Touch field callback (for validation) */\n\ttouchField?: (field: string) => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Registration Step (Step 2)\n *\n * Handles device registration for all device types using configuration-driven\n * rendering (DynamicFormRenderer) or custom components (TOTP, FIDO2, Mobile).\n */\nexport const UnifiedRegistrationStep: React.FC<UnifiedRegistrationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n\tdeviceFields,\n\tsetDeviceFields,\n\terrors,\n\tvalidate,\n\ttouchField,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering registration step for:`, config.deviceType);\n\t\n\t// ========== DEBUG: FULL CONFIG CHECK ==========\n\tconsole.log('üîç [REG-STEP DEBUG] Full config:', {\n\t\tdeviceType: config.deviceType,\n\t\tdisplayName: config.displayName,\n\t\trequiresOTP: config.requiresOTP,\n\t\tconfigObject: config\n\t});\n\t// ==============================================\n\t\n\t// ========== DEBUG: COMPONENT MOUNT ==========\n\tReact.useEffect(() => {\n\t\tconsole.log('üîç [REG-STEP DEBUG] Component mounted/updated', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasDeviceFields: !!deviceFields,\n\t\t\tfieldCount: Object.keys(deviceFields || {}).length,\n\t\t\ttokenValid: tokenStatus.isValid,\n\t\t\tisLoading\n\t\t});\n\t}, [config.deviceType, deviceFields, tokenStatus.isValid, isLoading]);\n\t// ===========================================\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle field change\n\t */\n\tconst handleFieldChange = useCallback(\n\t\t(field: string, value: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Field changed:`, field, '=', value);\n\t\t\tsetDeviceFields((prev) => ({ ...prev, [field]: value }));\n\n\t\t\t// Clear error for this field\n\t\t\tif (errors[field]) {\n\t\t\t\tsetRegistrationError(null);\n\t\t\t}\n\t\t},\n\t\t[setDeviceFields, errors]\n\t);\n\n\t/**\n\t * Handle device registration\n\t */\n\tconst handleRegisterDevice = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting device registration`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceFields,\n\t\t});\n\t\t\n\t\t// ========== DEBUG: REGISTRATION ENTRY ==========\n\t\tconsole.log('üîç [REG DEBUG] handleRegisterDevice called', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tfields: deviceFields,\n\t\t\tcredentialsEnvId: credentials.environmentId,\n\t\t\ttokenIsValid: tokenStatus.isValid\n\t\t});\n\t\t// ===============================================\n\n\t\t// Clear previous errors\n\t\tsetRegistrationError(null);\n\n\t\t// Validate fields\n\t\tif (!validate()) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed`);\n\t\t\tconsole.log('üîç [REG DEBUG] Validation failed, errors:', errors);\n\t\t\tsetRegistrationError('Please fix the errors above before continuing');\n\t\t\tnav.setValidationErrors(['Please fix the form errors']);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconsole.log('üîç [REG DEBUG] Validation passed, proceeding with registration');\n\n\t\t// Set loading state\n\t\tsetIsLoading(true);\n\n\t\ttry {\n\t\t\t// Merge device fields into credentials\n\t\t\tconst updatedCredentials = {\n\t\t\t\t...credentials,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t\t...deviceFields,\n\t\t\t};\n\n\t\t\t// Update credentials\n\t\t\tsetCredentials(updatedCredentials);\n\n\t\t\tconsole.log(`${MODULE_TAG} Calling controller.registerDevice`);\n\n\t\t\t// Call controller to register device\n\t\t\tconst result = await controller.registerDevice(\n\t\t\t\tupdatedCredentials,\n\t\t\t\tmfaState,\n\t\t\t\ttokenStatus,\n\t\t\t\tnav\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Device registered successfully:`, result);\n\t\t\n\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\tif (config.deviceType === 'TOTP') {\n\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result:', {\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tqrCode: result.qrCode,\n\t\t\t\tqrCodeUrl: result.qrCodeUrl,\n\t\t\t\tsecret: result.secret,\n\t\t\t\ttotpSecret: result.totpSecret,\n\t\t\t\tfullResult: result\n\t\t\t});\n\t\t}\n\t\t// ===============================================\n\n\t\t// Update MFA state with registration result\n\t\tsetMfaState((prev) => {\n\t\t\tconst newState = {\n\t\t\t\t...prev,\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tdeviceStatus: computeDeviceStatus(result.status, config.deviceType, tokenStatus.type),\n\t\t\t\t// TOTP-specific data (preserve QR/secret for user to scan)\n\t\t\t\tqrCodeUrl: result.qrCode || result.qrCodeUrl,\n\t\t\t\ttotpSecret: result.secret || result.totpSecret,\n\t\t\t\t// If we have TOTP data, surface the QR/secret immediately\n\t\t\t\tshowQr: config.deviceType === 'TOTP' && (result.qrCode || result.secret || result.totpSecret),\n\t\t\t\t// FIDO2-specific data\n\t\t\t\tpublicKeyCredentialCreationOptions: result.publicKeyCredentialCreationOptions,\n\t\t\t\t// Mobile-specific data\n\t\t\t\tpairingKey: result.pairingKey,\n\t\t\t\t// Links for activation\n\t\t\t\tactivationLinks: result._links,\n\t\t\t};\n\t\t\t\n\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\tif (config.deviceType === 'TOTP') {\n\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\tfullState: newState\n\t\t\t\t});\n\t\t\t}\n\t\t\t// ================================================\n\t\t\t\n\t\t\treturn newState;\n\t\t});\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} device registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step (activation)\n\t\t\tnav.goToNext();\n\t\t} catch (error: any) {\n\t\t\tconsole.error(`${MODULE_TAG} Device registration failed:`, error);\n\n\t\t\tconst errorMessage = error.message || `Failed to register ${config.displayName} device`;\n\n\t\t\tsetRegistrationError(errorMessage);\n\t\t\tnav.setValidationErrors([errorMessage]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [\n\t\tconfig, \n\t\tdeviceFields, \n\t\tcredentials, \n\t\tsetCredentials, \n\t\tmfaState, \n\t\tsetMfaState, \n\t\ttokenStatus, \n\t\tnav, \n\t\tcontroller, \n\t\tvalidate, \n\t\tsetIsLoading, errors\n\t]);\n\n\t/**\n\t * Handle registration success (for custom components)\n\t */\n\tconst handleRegistrationSuccess = useCallback(\n\t\t(data: any) => {\n\t\t\tconsole.log(`${MODULE_TAG} Custom component registration success:`, data);\n\n\t\t\t// Update MFA state\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t...data,\n\t\t\t}));\n\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step\n\t\t\tnav.goToNext();\n\t\t},\n\t\t[config, setMfaState, nav]\n\t);\n\n\t/**\n\t * Handle registration error (for custom components)\n\t */\n\tconst handleRegistrationError = useCallback(\n\t\t(error: string) => {\n\t\t\tconsole.error(`${MODULE_TAG} Custom component registration error:`, error);\n\n\t\t\tsetRegistrationError(error);\n\t\t\tnav.setValidationErrors([error]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(error);\n\t\t},\n\t\t[nav]\n\t);\n\n\t// ========================================================================\n\t// RENDER UI LOGIC\n\t// ========================================================================\n\n\t/**\n\t * Render registration UI based on device type\n\t */\n\tconst renderRegistrationUI = () => {\n\t\t// Check if this device type has a custom component\n\t\tconst CustomComponent = DeviceComponentRegistry[config.deviceType];\n\t\t\n\t\t// ========== DEBUG: REGISTRATION UI PATH ==========\n\t\tconsole.log('üîç [REG-UI DEBUG] Rendering path:', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasCustomComponent: !!CustomComponent,\n\t\t\twillUseDynamicForm: !CustomComponent,\n\t\t\tregistryValue: CustomComponent\n\t\t});\n\t\t// ================================================\n\n\t\tif (CustomComponent) {\n\t\t\t// Use device-specific custom component (TOTP, FIDO2, Mobile)\n\t\t\tconsole.log(`${MODULE_TAG} Using custom component for:`, config.deviceType);\n\n\t\t\tconst customComponentProps: DeviceComponentProps = {\n\t\t\t\tcredentials,\n\t\t\t\tmfaState,\n\t\t\t\tsetMfaState,\n\t\t\t\tonSuccess: handleRegistrationSuccess,\n\t\t\t\tonError: handleRegistrationError,\n\t\t\t\tcontroller,\n\t\t\t\tconfig,\n\t\t\t};\n\n\t\t\treturn <CustomComponent {...customComponentProps} />;\n\t\t} else {\n\t\t\t// Use dynamic form renderer (SMS, Email, WhatsApp)\n\t\t\tconsole.log(`${MODULE_TAG} Using dynamic form renderer for:`, config.deviceType);\n\n\t\t\treturn (\n\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\tconfig={config}\n\t\t\t\t\tvalues={deviceFields || {}}\n\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\terrors={errors}\n\t\t\t\t\tonTouch={touchField}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t/>\n\t\t\t);\n\t\t}\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-registration-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">{config.description}</p>\n\t\t\t</div>\n\n\t\t\t{/* Registration UI (dynamic form or custom component) */}\n\t\t\t<div className=\"registration-ui\">{renderRegistrationUI()}</div>\n\n\t\t\t{/* Registration Error */}\n\t\t\t{registrationError && (\n\t\t\t\t<div className=\"registration-error\" role=\"alert\">\n\t\t\t\t\t<strong>Registration Failed:</strong> {registrationError}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Info */}\n\t\t\t<div style={{ \n\t\t\t\tpadding: '12px 16px', \n\t\t\t\tbackground: '#eff6ff', \n\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\tborderRadius: '6px',\n\t\t\t\tmarginBottom: '16px',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tcolor: '#1e40af'\n\t\t\t}}>\n\t\t\t{config.deviceType === 'FIDO2' ? (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will create your {config.displayName} device, then you'll complete biometric authentication.</>\n\t\t\t) : (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will register your {config.displayName} device and send the activation code.</>\n\t\t\t)}\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleRegisterDevice}\n\t\t\t\t\tdisabled={isLoading || !tokenStatus.isValid}\n\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Registering...' : 'Next Step ‚ñ∂'}\n\t\t\t\t</button>\n\t\t\t</div>!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)\n\t\t</div>\n\t);\n};\n\nexport default UnifiedRegistrationStep;\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedRegistrationStep.tsx"},"span":[9156,9159],"sourceCode":"/**\n * @file UnifiedRegistrationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 2: Device Registration - Unified registration for all device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle device registration for all 6 device types using either:\n * - DynamicFormRenderer (for SMS, Email, WhatsApp)\n * - Custom components (for TOTP, FIDO2, Mobile)\n *\n * Flow:\n * 1. Render appropriate UI based on device type\n * 2. Collect and validate device-specific information\n * 3. Call controller.registerDevice()\n * 4. Update mfaState with registration result\n * 5. Navigate to activation step\n *\n * @example\n * <UnifiedRegistrationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n *   deviceFields={deviceFields}\n *   setDeviceFields={setDeviceFields}\n *   errors={errors}\n *   validate={validate}\n * />\n */\n\nimport React, { useCallback, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type DeviceComponentProps, DeviceComponentRegistry } from './DeviceComponentRegistry';\nimport { DynamicFormRenderer } from './DynamicFormRenderer';\n\nconst MODULE_TAG = '[üìù UNIFIED-REGISTRATION-STEP]';\n\n// Exported helper to determine final device status after registration\nexport function computeDeviceStatus(resultStatus: string | undefined, deviceType: string, tokenType: string) {\n\tconst status = resultStatus || '';\n\tif (deviceType === 'TOTP') {\n\t\t// User flows must require activation\n\t\tif (tokenType === 'user') return 'ACTIVATION_REQUIRED';\n\t\t// For admin/worker flows, prefer returned status, but default to ACTIVATION_REQUIRED\n\t\treturn status || 'ACTIVATION_REQUIRED';\n\t}\n\treturn status || 'ACTIVE';\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedRegistrationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device-specific form field values */\n\tdeviceFields: Record<string, string>;\n\n\t/** Update device fields */\n\tsetDeviceFields: (\n\t\tfields: Record<string, string> | ((prev: Record<string, string>) => Record<string, string>)\n\t) => void;\n\n\t/** Validation errors */\n\terrors: Record<string, string>;\n\n\t/** Validation function */\n\tvalidate: () => boolean;\n\n\t/** Touch field callback (for validation) */\n\ttouchField?: (field: string) => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Registration Step (Step 2)\n *\n * Handles device registration for all device types using configuration-driven\n * rendering (DynamicFormRenderer) or custom components (TOTP, FIDO2, Mobile).\n */\nexport const UnifiedRegistrationStep: React.FC<UnifiedRegistrationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n\tdeviceFields,\n\tsetDeviceFields,\n\terrors,\n\tvalidate,\n\ttouchField,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering registration step for:`, config.deviceType);\n\t\n\t// ========== DEBUG: FULL CONFIG CHECK ==========\n\tconsole.log('üîç [REG-STEP DEBUG] Full config:', {\n\t\tdeviceType: config.deviceType,\n\t\tdisplayName: config.displayName,\n\t\trequiresOTP: config.requiresOTP,\n\t\tconfigObject: config\n\t});\n\t// ==============================================\n\t\n\t// ========== DEBUG: COMPONENT MOUNT ==========\n\tReact.useEffect(() => {\n\t\tconsole.log('üîç [REG-STEP DEBUG] Component mounted/updated', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasDeviceFields: !!deviceFields,\n\t\t\tfieldCount: Object.keys(deviceFields || {}).length,\n\t\t\ttokenValid: tokenStatus.isValid,\n\t\t\tisLoading\n\t\t});\n\t}, [config.deviceType, deviceFields, tokenStatus.isValid, isLoading]);\n\t// ===========================================\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle field change\n\t */\n\tconst handleFieldChange = useCallback(\n\t\t(field: string, value: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Field changed:`, field, '=', value);\n\t\t\tsetDeviceFields((prev) => ({ ...prev, [field]: value }));\n\n\t\t\t// Clear error for this field\n\t\t\tif (errors[field]) {\n\t\t\t\tsetRegistrationError(null);\n\t\t\t}\n\t\t},\n\t\t[setDeviceFields, errors]\n\t);\n\n\t/**\n\t * Handle device registration\n\t */\n\tconst handleRegisterDevice = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting device registration`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceFields,\n\t\t});\n\t\t\n\t\t// ========== DEBUG: REGISTRATION ENTRY ==========\n\t\tconsole.log('üîç [REG DEBUG] handleRegisterDevice called', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tfields: deviceFields,\n\t\t\tcredentialsEnvId: credentials.environmentId,\n\t\t\ttokenIsValid: tokenStatus.isValid\n\t\t});\n\t\t// ===============================================\n\n\t\t// Clear previous errors\n\t\tsetRegistrationError(null);\n\n\t\t// Validate fields\n\t\tif (!validate()) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed`);\n\t\t\tconsole.log('üîç [REG DEBUG] Validation failed, errors:', errors);\n\t\t\tsetRegistrationError('Please fix the errors above before continuing');\n\t\t\tnav.setValidationErrors(['Please fix the form errors']);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconsole.log('üîç [REG DEBUG] Validation passed, proceeding with registration');\n\n\t\t// Set loading state\n\t\tsetIsLoading(true);\n\n\t\ttry {\n\t\t\t// Merge device fields into credentials\n\t\t\tconst updatedCredentials = {\n\t\t\t\t...credentials,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t\t...deviceFields,\n\t\t\t};\n\n\t\t\t// Update credentials\n\t\t\tsetCredentials(updatedCredentials);\n\n\t\t\tconsole.log(`${MODULE_TAG} Calling controller.registerDevice`);\n\n\t\t\t// Call controller to register device\n\t\t\tconst result = await controller.registerDevice(\n\t\t\t\tupdatedCredentials,\n\t\t\t\tmfaState,\n\t\t\t\ttokenStatus,\n\t\t\t\tnav\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Device registered successfully:`, result);\n\t\t\n\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\tif (config.deviceType === 'TOTP') {\n\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result:', {\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tqrCode: result.qrCode,\n\t\t\t\tqrCodeUrl: result.qrCodeUrl,\n\t\t\t\tsecret: result.secret,\n\t\t\t\ttotpSecret: result.totpSecret,\n\t\t\t\tfullResult: result\n\t\t\t});\n\t\t}\n\t\t// ===============================================\n\n\t\t// Update MFA state with registration result\n\t\tsetMfaState((prev) => {\n\t\t\tconst newState = {\n\t\t\t\t...prev,\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tdeviceStatus: computeDeviceStatus(result.status, config.deviceType, tokenStatus.type),\n\t\t\t\t// TOTP-specific data (preserve QR/secret for user to scan)\n\t\t\t\tqrCodeUrl: result.qrCode || result.qrCodeUrl,\n\t\t\t\ttotpSecret: result.secret || result.totpSecret,\n\t\t\t\t// If we have TOTP data, surface the QR/secret immediately\n\t\t\t\tshowQr: config.deviceType === 'TOTP' && (result.qrCode || result.secret || result.totpSecret),\n\t\t\t\t// FIDO2-specific data\n\t\t\t\tpublicKeyCredentialCreationOptions: result.publicKeyCredentialCreationOptions,\n\t\t\t\t// Mobile-specific data\n\t\t\t\tpairingKey: result.pairingKey,\n\t\t\t\t// Links for activation\n\t\t\t\tactivationLinks: result._links,\n\t\t\t};\n\t\t\t\n\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\tif (config.deviceType === 'TOTP') {\n\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\tfullState: newState\n\t\t\t\t});\n\t\t\t}\n\t\t\t// ================================================\n\t\t\t\n\t\t\treturn newState;\n\t\t});\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} device registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step (activation)\n\t\t\tnav.goToNext();\n\t\t} catch (error: any) {\n\t\t\tconsole.error(`${MODULE_TAG} Device registration failed:`, error);\n\n\t\t\tconst errorMessage = error.message || `Failed to register ${config.displayName} device`;\n\n\t\t\tsetRegistrationError(errorMessage);\n\t\t\tnav.setValidationErrors([errorMessage]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [\n\t\tconfig, \n\t\tdeviceFields, \n\t\tcredentials, \n\t\tsetCredentials, \n\t\tmfaState, \n\t\tsetMfaState, \n\t\ttokenStatus, \n\t\tnav, \n\t\tcontroller, \n\t\tvalidate, \n\t\tsetIsLoading, errors\n\t]);\n\n\t/**\n\t * Handle registration success (for custom components)\n\t */\n\tconst handleRegistrationSuccess = useCallback(\n\t\t(data: any) => {\n\t\t\tconsole.log(`${MODULE_TAG} Custom component registration success:`, data);\n\n\t\t\t// Update MFA state\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t...data,\n\t\t\t}));\n\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step\n\t\t\tnav.goToNext();\n\t\t},\n\t\t[config, setMfaState, nav]\n\t);\n\n\t/**\n\t * Handle registration error (for custom components)\n\t */\n\tconst handleRegistrationError = useCallback(\n\t\t(error: string) => {\n\t\t\tconsole.error(`${MODULE_TAG} Custom component registration error:`, error);\n\n\t\t\tsetRegistrationError(error);\n\t\t\tnav.setValidationErrors([error]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(error);\n\t\t},\n\t\t[nav]\n\t);\n\n\t// ========================================================================\n\t// RENDER UI LOGIC\n\t// ========================================================================\n\n\t/**\n\t * Render registration UI based on device type\n\t */\n\tconst renderRegistrationUI = () => {\n\t\t// Check if this device type has a custom component\n\t\tconst CustomComponent = DeviceComponentRegistry[config.deviceType];\n\t\t\n\t\t// ========== DEBUG: REGISTRATION UI PATH ==========\n\t\tconsole.log('üîç [REG-UI DEBUG] Rendering path:', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasCustomComponent: !!CustomComponent,\n\t\t\twillUseDynamicForm: !CustomComponent,\n\t\t\tregistryValue: CustomComponent\n\t\t});\n\t\t// ================================================\n\n\t\tif (CustomComponent) {\n\t\t\t// Use device-specific custom component (TOTP, FIDO2, Mobile)\n\t\t\tconsole.log(`${MODULE_TAG} Using custom component for:`, config.deviceType);\n\n\t\t\tconst customComponentProps: DeviceComponentProps = {\n\t\t\t\tcredentials,\n\t\t\t\tmfaState,\n\t\t\t\tsetMfaState,\n\t\t\t\tonSuccess: handleRegistrationSuccess,\n\t\t\t\tonError: handleRegistrationError,\n\t\t\t\tcontroller,\n\t\t\t\tconfig,\n\t\t\t};\n\n\t\t\treturn <CustomComponent {...customComponentProps} />;\n\t\t} else {\n\t\t\t// Use dynamic form renderer (SMS, Email, WhatsApp)\n\t\t\tconsole.log(`${MODULE_TAG} Using dynamic form renderer for:`, config.deviceType);\n\n\t\t\treturn (\n\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\tconfig={config}\n\t\t\t\t\tvalues={deviceFields || {}}\n\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\terrors={errors}\n\t\t\t\t\tonTouch={touchField}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t/>\n\t\t\t);\n\t\t}\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-registration-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">{config.description}</p>\n\t\t\t</div>\n\n\t\t\t{/* Registration UI (dynamic form or custom component) */}\n\t\t\t<div className=\"registration-ui\">{renderRegistrationUI()}</div>\n\n\t\t\t{/* Registration Error */}\n\t\t\t{registrationError && (\n\t\t\t\t<div className=\"registration-error\" role=\"alert\">\n\t\t\t\t\t<strong>Registration Failed:</strong> {registrationError}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Info */}\n\t\t\t<div style={{ \n\t\t\t\tpadding: '12px 16px', \n\t\t\t\tbackground: '#eff6ff', \n\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\tborderRadius: '6px',\n\t\t\t\tmarginBottom: '16px',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tcolor: '#1e40af'\n\t\t\t}}>\n\t\t\t{config.deviceType === 'FIDO2' ? (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will create your {config.displayName} device, then you'll complete biometric authentication.</>\n\t\t\t) : (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will register your {config.displayName} device and send the activation code.</>\n\t\t\t)}\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleRegisterDevice}\n\t\t\t\t\tdisabled={isLoading || !tokenStatus.isValid}\n\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Registering...' : 'Next Step ‚ñ∂'}\n\t\t\t\t</button>\n\t\t\t</div>!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)\n\t\t</div>\n\t);\n};\n\nexport default UnifiedRegistrationStep;\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedSuccessStep.tsx"},"span":[2641,2644],"sourceCode":"/**\n * @file UnifiedSuccessStep.tsx\n * @module v8/flows/unified/components\n * @description Step 4: Success - Display registration success and device details\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Display success message after device registration and activation.\n * Shows device details, provides option to register another device.\n *\n * Flow:\n * 1. Display success message with device icon\n * 2. Show registered device details (ID, type, status, contact info)\n * 3. Provide \"Register Another Device\" button\n * 4. Call onSuccess callback if provided\n * 5. Log analytics event\n *\n * @example\n * <UnifiedSuccessStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   onComplete={handleComplete}\n * />\n */\n\nimport React, { useCallback, useEffect } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[‚úÖ UNIFIED-SUCCESS-STEP]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedSuccessStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Callback when user wants to register another device */\n\tonComplete?: () => void;\n\n\t/** Callback for registering another device */\n\tonRegisterAnother?: () => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Success Step (Step 4)\n *\n * Displays registration success message and device details with option\n * to register another device.\n */\nexport const UnifiedSuccessStep: React.FC<UnifiedSuccessStepProps> = ({\n\tcredentials,\n\tmfaState,\n\ttokenStatus,\n\tnav,\n\tconfig,\n\tonComplete,\n\tonRegisterAnother,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering success step for:`, config.deviceType);\n\n\t// ========================================================================\n\t// EFFECTS\n\t// ========================================================================\n\n\t/**\n\t * Mark step as complete on mount and log analytics\n\t */\n\tuseEffect(() => {\n\t\tconsole.log(`${MODULE_TAG} Device registration complete:`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceId: mfaState.deviceId,\n\t\t\tstatus: mfaState.deviceStatus,\n\t\t});\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Log analytics event\n\t\tif (typeof window !== 'undefined' && (window as any).gtag) {\n\t\t\t(window as any).gtag('event', 'mfa_registration_success', {\n\t\t\t\tdevice_type: config.deviceType,\n\t\t\t\tdevice_id: mfaState.deviceId,\n\t\t\t\tflow_version: 'v8-unified',\n\t\t\t});\n\t\t}\n\n\t\t// Call onComplete callback\n\t\tif (onComplete) {\n\t\t\tonComplete();\n\t\t}\n\t}, [\n\t\tconfig.deviceType,\n\t\tmfaState.deviceId,\n\t\tmfaState.deviceStatus, // Mark step as complete\n\t\tnav.markStepComplete,\n\t\tonComplete,\n\t]); // Only run once on mount\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle \"Register Another Device\" button click\n\t * Navigate back to main page like Restart Flow does\n\t */\n\tconst handleRegisterAnother = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} User wants to register another device`);\n\n\t\ttoastV8.info('Starting new device registration');\n\n\t\t// Call callback if provided\n\t\tif (onRegisterAnother) {\n\t\t\tonRegisterAnother();\n\t\t} else {\n\t\t\t// Navigate back to unified MFA main page\n\t\t\twindow.location.href = '/v8/unified-mfa';\n\t\t}\n\t}, [onRegisterAnother]);\n\n\t// ========================================================================\n\t// COMPUTED PROPERTIES\n\t// ========================================================================\n\n\t/**\n\t * Get device contact information based on device type\n\t */\n\tconst getDeviceContactInfo = (): string | null => {\n\t\tswitch (config.deviceType) {\n\t\t\tcase 'SMS':\n\t\t\t\treturn credentials.phoneNumber\n\t\t\t\t\t? `${credentials.countryCode} ${credentials.phoneNumber}`\n\t\t\t\t\t: null;\n\t\t\tcase 'EMAIL':\n\t\t\t\treturn credentials.email || null;\n\t\t\tcase 'WHATSAPP':\n\t\t\t\treturn credentials.phoneNumber\n\t\t\t\t\t? `${credentials.countryCode} ${credentials.phoneNumber}`\n\t\t\t\t\t: credentials.email || null;\n\t\t\tcase 'TOTP':\n\t\t\t\treturn 'Authenticator App';\n\t\t\tcase 'FIDO2':\n\t\t\t\treturn 'Security Key / Biometric';\n\t\t\tcase 'MOBILE':\n\t\t\t\treturn 'PingOne Mobile App';\n\t\t\tdefault:\n\t\t\t\treturn null;\n\t\t}\n\t};\n\n\tconst contactInfo = getDeviceContactInfo();\n\n\t/**\n\t * Get device nickname if available\n\t */\n\tconst deviceName = credentials.deviceName || credentials.nickname || `My ${config.displayName}`;\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-success-step\">\n\t\t\t{/* Success Header */}\n\t\t\t<div className=\"success-header\">\n\t\t\t\t<div className=\"success-icon\">\n\t\t\t\t\t<span className=\"icon-large\">{config.icon}</span>\n\t\t\t\t\t<span className=\"checkmark\">‚úì</span>\n\t\t\t\t</div>\n\t\t\t\t<h2 className=\"success-title\">Device Registered Successfully!</h2>\n\t\t\t\t<p className=\"success-subtitle\">\n\t\t\t\t\tYour {config.displayName} device is now active and ready to use for multi-factor\n\t\t\t\t\tauthentication.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Device Details Card */}\n\t\t\t<div className=\"device-details\">\n\t\t\t\t<h3>Device Details</h3>\n\n\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t<span className=\"detail-label\">Device Type:</span>\n\t\t\t\t\t<span className=\"detail-value\">\n\t\t\t\t\t\t{config.icon} {config.displayName}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\n\t\t\t\t{deviceName && (\n\t\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t\t<span className=\"detail-label\">Device Name:</span>\n\t\t\t\t\t\t<span className=\"detail-value\">{deviceName}</span>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{mfaState.deviceId && (\n\t\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t\t<span className=\"detail-label\">Device ID:</span>\n\t\t\t\t\t\t<span className=\"detail-value device-id\">{mfaState.deviceId}</span>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t<span className=\"detail-label\">Status:</span>\n\t\t\t\t\t<span\n\t\t\t\t\t\tclassName={`detail-value status-badge ${\n\t\t\t\t\t\t\tmfaState.deviceStatus === 'ACTIVE' ? 'status-active' : 'status-activation-required'\n\t\t\t\t\t\t}`}\n\t\t\t\t\t>\n\t\t\t\t\t\t{mfaState.deviceStatus || 'ACTIVE'}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\n\t\t\t\t{contactInfo && (\n\t\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t\t<span className=\"detail-label\">Contact:</span>\n\t\t\t\t\t\t<span className=\"detail-value\">{contactInfo}</span>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{credentials.environmentId && (\n\t\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t\t<span className=\"detail-label\">Environment:</span>\n\t\t\t\t\t\t<span className=\"detail-value environment-id\">{credentials.environmentId}</span>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{credentials.username && (\n\t\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t\t<span className=\"detail-label\">Username:</span>\n\t\t\t\t\t\t<span className=\"detail-value\">{credentials.username}</span>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\n\t\t\t{/* Next Steps Information */}\n\t\t\t<div className=\"next-steps-info\">\n\t\t\t\t<h4>What's Next?</h4>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>\n\t\t\t\t\t\tYour {config.displayName} device will be used for multi-factor authentication when you\n\t\t\t\t\t\tsign in.\n\t\t\t\t\t</li>\n\t\t\t\t\t{config.deviceType === 'SMS' && (\n\t\t\t\t\t\t<li>You'll receive a one-time code via SMS each time you need to authenticate.</li>\n\t\t\t\t\t)}\n\t\t\t\t\t{config.deviceType === 'EMAIL' && (\n\t\t\t\t\t\t<li>You'll receive a one-time code via email each time you need to authenticate.</li>\n\t\t\t\t\t)}\n\t\t\t\t\t{config.deviceType === 'WHATSAPP' && (\n\t\t\t\t\t\t<li>You'll receive a one-time code via WhatsApp each time you need to authenticate.</li>\n\t\t\t\t\t)}\n\t\t\t\t\t{config.deviceType === 'TOTP' && (\n\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\tOpen your authenticator app and enter the code shown when you need to authenticate.\n\t\t\t\t\t\t</li>\n\t\t\t\t\t)}\n\t\t\t\t\t{config.deviceType === 'FIDO2' && (\n\t\t\t\t\t\t<li>Use your security key or biometric when prompted during authentication.</li>\n\t\t\t\t\t)}\n\t\t\t\t\t{config.deviceType === 'MOBILE' && (\n\t\t\t\t\t\t<li>Approve authentication requests in the PingOne Mobile app when prompted.</li>\n\t\t\t\t\t)}\n\t\t\t\t\t<li>You can register additional devices for backup authentication methods.</li>\n\t\t\t\t</ul>\n\t\t\t</div>\n\n\t\t\t{/* Action Buttons */}\n\t\t\t<div className=\"action-buttons\">\n\t\t\t\t<button type=\"button\" onClick={handleRegisterAnother} className=\"btn-secondary\">\n\t\t\t\t\t‚Üê Register Another Device\n\t\t\t\t</button>\n\n\t\t\t\t<a\n\t\t\t\t\thref=\"https://apidocs.pingidentity.com/pingone/platform/v1/api/\"\n\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\tclassName=\"btn-secondary\"\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\ttextDecoration: 'none',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\tüìö View API Docs\n\t\t\t\t</a>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\tconsole.log(`${MODULE_TAG} User finished registration flow`);\n\t\t\t\t\t\ttoastV8.success('Registration complete!');\n\t\t\t\t\t}}\n\t\t\t\t\tclassName=\"btn-primary\"\n\t\t\t\t>\n\t\t\t\t\tFinish\n\t\t\t\t</button>\n\t\t\t</div>\n\n\t\t\t{/* Token Status Info */}\n\t\t\t{tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-info\" role=\"status\">\n\t\t\t\t\t<small>\n\t\t\t\t\t\t‚úì Worker token is valid and will expire{' '}\n\t\t\t\t\t\t{tokenStatus.expiresAt ? new Date(tokenStatus.expiresAt).toLocaleString() : 'soon'}\n\t\t\t\t\t</small>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\nexport default UnifiedSuccessStep;\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedSuccessStep.tsx"},"span":[2668,2671],"sourceCode":"/**\n * @file UnifiedSuccessStep.tsx\n * @module v8/flows/unified/components\n * @description Step 4: Success - Display registration success and device details\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Display success message after device registration and activation.\n * Shows device details, provides option to register another device.\n *\n * Flow:\n * 1. Display success message with device icon\n * 2. Show registered device details (ID, type, status, contact info)\n * 3. Provide \"Register Another Device\" button\n * 4. Call onSuccess callback if provided\n * 5. Log analytics event\n *\n * @example\n * <UnifiedSuccessStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   onComplete={handleComplete}\n * />\n */\n\nimport React, { useCallback, useEffect } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[‚úÖ UNIFIED-SUCCESS-STEP]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedSuccessStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Callback when user wants to register another device */\n\tonComplete?: () => void;\n\n\t/** Callback for registering another device */\n\tonRegisterAnother?: () => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Success Step (Step 4)\n *\n * Displays registration success message and device details with option\n * to register another device.\n */\nexport const UnifiedSuccessStep: React.FC<UnifiedSuccessStepProps> = ({\n\tcredentials,\n\tmfaState,\n\ttokenStatus,\n\tnav,\n\tconfig,\n\tonComplete,\n\tonRegisterAnother,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering success step for:`, config.deviceType);\n\n\t// ========================================================================\n\t// EFFECTS\n\t// ========================================================================\n\n\t/**\n\t * Mark step as complete on mount and log analytics\n\t */\n\tuseEffect(() => {\n\t\tconsole.log(`${MODULE_TAG} Device registration complete:`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceId: mfaState.deviceId,\n\t\t\tstatus: mfaState.deviceStatus,\n\t\t});\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Log analytics event\n\t\tif (typeof window !== 'undefined' && (window as any).gtag) {\n\t\t\t(window as any).gtag('event', 'mfa_registration_success', {\n\t\t\t\tdevice_type: config.deviceType,\n\t\t\t\tdevice_id: mfaState.deviceId,\n\t\t\t\tflow_version: 'v8-unified',\n\t\t\t});\n\t\t}\n\n\t\t// Call onComplete callback\n\t\tif (onComplete) {\n\t\t\tonComplete();\n\t\t}\n\t}, [\n\t\tconfig.deviceType,\n\t\tmfaState.deviceId,\n\t\tmfaState.deviceStatus, // Mark step as complete\n\t\tnav.markStepComplete,\n\t\tonComplete,\n\t]); // Only run once on mount\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle \"Register Another Device\" button click\n\t * Navigate back to main page like Restart Flow does\n\t */\n\tconst handleRegisterAnother = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} User wants to register another device`);\n\n\t\ttoastV8.info('Starting new device registration');\n\n\t\t// Call callback if provided\n\t\tif (onRegisterAnother) {\n\t\t\tonRegisterAnother();\n\t\t} else {\n\t\t\t// Navigate back to unified MFA main page\n\t\t\twindow.location.href = '/v8/unified-mfa';\n\t\t}\n\t}, [onRegisterAnother]);\n\n\t// ========================================================================\n\t// COMPUTED PROPERTIES\n\t// ========================================================================\n\n\t/**\n\t * Get device contact information based on device type\n\t */\n\tconst getDeviceContactInfo = (): string | null => {\n\t\tswitch (config.deviceType) {\n\t\t\tcase 'SMS':\n\t\t\t\treturn credentials.phoneNumber\n\t\t\t\t\t? `${credentials.countryCode} ${credentials.phoneNumber}`\n\t\t\t\t\t: null;\n\t\t\tcase 'EMAIL':\n\t\t\t\treturn credentials.email || null;\n\t\t\tcase 'WHATSAPP':\n\t\t\t\treturn credentials.phoneNumber\n\t\t\t\t\t? `${credentials.countryCode} ${credentials.phoneNumber}`\n\t\t\t\t\t: credentials.email || null;\n\t\t\tcase 'TOTP':\n\t\t\t\treturn 'Authenticator App';\n\t\t\tcase 'FIDO2':\n\t\t\t\treturn 'Security Key / Biometric';\n\t\t\tcase 'MOBILE':\n\t\t\t\treturn 'PingOne Mobile App';\n\t\t\tdefault:\n\t\t\t\treturn null;\n\t\t}\n\t};\n\n\tconst contactInfo = getDeviceContactInfo();\n\n\t/**\n\t * Get device nickname if available\n\t */\n\tconst deviceName = credentials.deviceName || credentials.nickname || `My ${config.displayName}`;\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-success-step\">\n\t\t\t{/* Success Header */}\n\t\t\t<div className=\"success-header\">\n\t\t\t\t<div className=\"success-icon\">\n\t\t\t\t\t<span className=\"icon-large\">{config.icon}</span>\n\t\t\t\t\t<span className=\"checkmark\">‚úì</span>\n\t\t\t\t</div>\n\t\t\t\t<h2 className=\"success-title\">Device Registered Successfully!</h2>\n\t\t\t\t<p className=\"success-subtitle\">\n\t\t\t\t\tYour {config.displayName} device is now active and ready to use for multi-factor\n\t\t\t\t\tauthentication.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Device Details Card */}\n\t\t\t<div className=\"device-details\">\n\t\t\t\t<h3>Device Details</h3>\n\n\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t<span className=\"detail-label\">Device Type:</span>\n\t\t\t\t\t<span className=\"detail-value\">\n\t\t\t\t\t\t{config.icon} {config.displayName}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\n\t\t\t\t{deviceName && (\n\t\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t\t<span className=\"detail-label\">Device Name:</span>\n\t\t\t\t\t\t<span className=\"detail-value\">{deviceName}</span>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{mfaState.deviceId && (\n\t\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t\t<span className=\"detail-label\">Device ID:</span>\n\t\t\t\t\t\t<span className=\"detail-value device-id\">{mfaState.deviceId}</span>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t<span className=\"detail-label\">Status:</span>\n\t\t\t\t\t<span\n\t\t\t\t\t\tclassName={`detail-value status-badge ${\n\t\t\t\t\t\t\tmfaState.deviceStatus === 'ACTIVE' ? 'status-active' : 'status-activation-required'\n\t\t\t\t\t\t}`}\n\t\t\t\t\t>\n\t\t\t\t\t\t{mfaState.deviceStatus || 'ACTIVE'}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\n\t\t\t\t{contactInfo && (\n\t\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t\t<span className=\"detail-label\">Contact:</span>\n\t\t\t\t\t\t<span className=\"detail-value\">{contactInfo}</span>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{credentials.environmentId && (\n\t\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t\t<span className=\"detail-label\">Environment:</span>\n\t\t\t\t\t\t<span className=\"detail-value environment-id\">{credentials.environmentId}</span>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{credentials.username && (\n\t\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t\t<span className=\"detail-label\">Username:</span>\n\t\t\t\t\t\t<span className=\"detail-value\">{credentials.username}</span>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\n\t\t\t{/* Next Steps Information */}\n\t\t\t<div className=\"next-steps-info\">\n\t\t\t\t<h4>What's Next?</h4>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>\n\t\t\t\t\t\tYour {config.displayName} device will be used for multi-factor authentication when you\n\t\t\t\t\t\tsign in.\n\t\t\t\t\t</li>\n\t\t\t\t\t{config.deviceType === 'SMS' && (\n\t\t\t\t\t\t<li>You'll receive a one-time code via SMS each time you need to authenticate.</li>\n\t\t\t\t\t)}\n\t\t\t\t\t{config.deviceType === 'EMAIL' && (\n\t\t\t\t\t\t<li>You'll receive a one-time code via email each time you need to authenticate.</li>\n\t\t\t\t\t)}\n\t\t\t\t\t{config.deviceType === 'WHATSAPP' && (\n\t\t\t\t\t\t<li>You'll receive a one-time code via WhatsApp each time you need to authenticate.</li>\n\t\t\t\t\t)}\n\t\t\t\t\t{config.deviceType === 'TOTP' && (\n\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\tOpen your authenticator app and enter the code shown when you need to authenticate.\n\t\t\t\t\t\t</li>\n\t\t\t\t\t)}\n\t\t\t\t\t{config.deviceType === 'FIDO2' && (\n\t\t\t\t\t\t<li>Use your security key or biometric when prompted during authentication.</li>\n\t\t\t\t\t)}\n\t\t\t\t\t{config.deviceType === 'MOBILE' && (\n\t\t\t\t\t\t<li>Approve authentication requests in the PingOne Mobile app when prompted.</li>\n\t\t\t\t\t)}\n\t\t\t\t\t<li>You can register additional devices for backup authentication methods.</li>\n\t\t\t\t</ul>\n\t\t\t</div>\n\n\t\t\t{/* Action Buttons */}\n\t\t\t<div className=\"action-buttons\">\n\t\t\t\t<button type=\"button\" onClick={handleRegisterAnother} className=\"btn-secondary\">\n\t\t\t\t\t‚Üê Register Another Device\n\t\t\t\t</button>\n\n\t\t\t\t<a\n\t\t\t\t\thref=\"https://apidocs.pingidentity.com/pingone/platform/v1/api/\"\n\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\tclassName=\"btn-secondary\"\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\ttextDecoration: 'none',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\tüìö View API Docs\n\t\t\t\t</a>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\tconsole.log(`${MODULE_TAG} User finished registration flow`);\n\t\t\t\t\t\ttoastV8.success('Registration complete!');\n\t\t\t\t\t}}\n\t\t\t\t\tclassName=\"btn-primary\"\n\t\t\t\t>\n\t\t\t\t\tFinish\n\t\t\t\t</button>\n\t\t\t</div>\n\n\t\t\t{/* Token Status Info */}\n\t\t\t{tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-info\" role=\"status\">\n\t\t\t\t\t<small>\n\t\t\t\t\t\t‚úì Worker token is valid and will expire{' '}\n\t\t\t\t\t\t{tokenStatus.expiresAt ? new Date(tokenStatus.expiresAt).toLocaleString() : 'soon'}\n\t\t\t\t\t</small>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\nexport default UnifiedSuccessStep;\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/services/unifiedFlowServiceIntegration.ts"},"span":[1924,1927],"sourceCode":"/**\n * @file unifiedFlowServiceIntegration.ts\n * @module v8/flows/unified/services\n * @description Service integration layer for Unified MFA Flow - Leverages existing V8 services\n * @version 9.2.0\n */\n\nimport type { DeviceConfigKey } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFACredentials } from '@/v8/flows/shared/MFATypes';\nimport { globalEnvironmentService } from '@/v8/services/globalEnvironmentService';\nimport { globalWorkerTokenService } from '@/v8/services/globalWorkerTokenService';\nimport { MFAServiceV8 } from '@/v8/services/mfaServiceV8';\n\n/**\n * Unified Flow Service Integration\n *\n * Integrates Unified MFA Flow with existing V8 services:\n * - Uses global Environment ID (no redundant inputs)\n * - Uses global Worker Token (automatic refresh)\n * - Leverages MFAServiceV8 (static methods for MFA operations)\n */\nexport class UnifiedFlowServiceIntegration {\n\t/**\n\t * Build MFA credentials from global services\n\t */\n\tprivate async buildCredentials(username: string, clientId?: string): Promise<MFACredentials> {\n\t\tconst environmentId = globalEnvironmentService.getEnvironmentId();\n\n\t\tif (!environmentId) {\n\t\t\tthrow new Error('Environment ID not configured. Please configure global settings first.');\n\t\t}\n\n\t\treturn {\n\t\t\tenvironmentId,\n\t\t\tclientId: clientId || '',\n\t\t\tusername,\n\t\t\ttokenType: 'worker',\n\t\t};\n\t}\n\n\t/**\n\t * Register a new MFA device\n\t */\n\tasync registerDevice(\n\t\tusername: string,\n\t\tdeviceType: DeviceConfigKey,\n\t\tdeviceData: {\n\t\t\tphoneNumber?: string;\n\t\t\temail?: string;\n\t\t\tname?: string;\n\t\t}\n\t): Promise<{\n\t\tdeviceId: string;\n\t\tstatus: string;\n\t\tqrCode?: string;\n\t}> {\n\t\tconsole.log('[UnifiedFlowServiceIntegration] Registering device:', {\n\t\t\tdeviceType,\n\t\t\tusername,\n\t\t\tdeviceData,\n\t\t});\n\n\t\tconst credentials = await this.buildCredentials(username);\n\n\t\t// Use MFAServiceV8.registerDevice\n\t\tconst result = await MFAServiceV8.registerDevice({\n\t\t\t...credentials,\n\t\t\ttype: deviceType as any,\n\t\t\tphoneNumber: deviceData.phoneNumber,\n\t\t\temail: deviceData.email,\n\t\t\tname: deviceData.name || `${deviceType} Device`,\n\t\t});\n\n\t\treturn {\n\t\t\tdeviceId: result.deviceId,\n\t\t\tstatus: result.status || 'PENDING',\n\t\t\tqrCode: result.qrCode,\n\t\t};\n\t}\n\n\t/**\n\t * Activate an MFA device with OTP code\n\t */\n\tasync activateDevice(\n\t\tusername: string,\n\t\tdeviceId: string,\n\t\totpCode: string\n\t): Promise<{\n\t\tsuccess: boolean;\n\t\tstatus: string;\n\t}> {\n\t\tconsole.log('[UnifiedFlowServiceIntegration] Activating device:', deviceId);\n\n\t\tconst credentials = await this.buildCredentials(username);\n\n\t\tconst result = await MFAServiceV8.activateDevice({\n\t\t\t...credentials,\n\t\t\tdeviceId,\n\t\t\totp: otpCode,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tstatus: (result as any).status || 'ACTIVE',\n\t\t};\n\t}\n\n\t/**\n\t * Get device details\n\t */\n\tasync getDevice(username: string, deviceId: string): Promise<Record<string, unknown>> {\n\t\tconst credentials = await this.buildCredentials(username);\n\t\treturn await MFAServiceV8.getDevice({ ...credentials, deviceId });\n\t}\n\n\t/**\n\t * Delete an MFA device\n\t */\n\tasync deleteDevice(username: string, deviceId: string): Promise<void> {\n\t\tconst credentials = await this.buildCredentials(username);\n\t\tawait MFAServiceV8.deleteDevice({ ...credentials, deviceId });\n\t}\n\n\t/**\n\t * List all MFA devices for a user\n\t */\n\tasync listDevices(username: string, filter?: string): Promise<Array<Record<string, unknown>>> {\n\t\tconst credentials = await this.buildCredentials(username);\n\t\treturn await MFAServiceV8.getAllDevices(credentials, filter);\n\t}\n\n\t/**\n\t * Check if global configuration is valid\n\t */\n\tasync validateConfiguration(): Promise<{\n\t\tvalid: boolean;\n\t\terrors: string[];\n\t}> {\n\t\tconst errors: string[] = [];\n\n\t\tconst environmentId = globalEnvironmentService.getEnvironmentId();\n\t\tif (!environmentId) {\n\t\t\terrors.push('Environment ID not configured');\n\t\t}\n\n\t\ttry {\n\t\t\tconst tokenStatus = await globalWorkerTokenService.getStatus();\n\t\t\tif (!tokenStatus.hasCredentials) {\n\t\t\t\terrors.push('Worker Token credentials not configured');\n\t\t\t}\n\t\t\tif (!tokenStatus.tokenValid) {\n\t\t\t\terrors.push('Worker Token is invalid or expired');\n\t\t\t}\n\t\t} catch (_error) {\n\t\t\terrors.push('Failed to validate Worker Token');\n\t\t}\n\n\t\treturn {\n\t\t\tvalid: errors.length === 0,\n\t\t\terrors,\n\t\t};\n\t}\n}\n\n// Export singleton instance\nexport const unifiedFlowServiceIntegration = new UnifiedFlowServiceIntegration();\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/services/unifiedFlowServiceIntegration.ts"},"span":[2663,2666],"sourceCode":"/**\n * @file unifiedFlowServiceIntegration.ts\n * @module v8/flows/unified/services\n * @description Service integration layer for Unified MFA Flow - Leverages existing V8 services\n * @version 9.2.0\n */\n\nimport type { DeviceConfigKey } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFACredentials } from '@/v8/flows/shared/MFATypes';\nimport { globalEnvironmentService } from '@/v8/services/globalEnvironmentService';\nimport { globalWorkerTokenService } from '@/v8/services/globalWorkerTokenService';\nimport { MFAServiceV8 } from '@/v8/services/mfaServiceV8';\n\n/**\n * Unified Flow Service Integration\n *\n * Integrates Unified MFA Flow with existing V8 services:\n * - Uses global Environment ID (no redundant inputs)\n * - Uses global Worker Token (automatic refresh)\n * - Leverages MFAServiceV8 (static methods for MFA operations)\n */\nexport class UnifiedFlowServiceIntegration {\n\t/**\n\t * Build MFA credentials from global services\n\t */\n\tprivate async buildCredentials(username: string, clientId?: string): Promise<MFACredentials> {\n\t\tconst environmentId = globalEnvironmentService.getEnvironmentId();\n\n\t\tif (!environmentId) {\n\t\t\tthrow new Error('Environment ID not configured. Please configure global settings first.');\n\t\t}\n\n\t\treturn {\n\t\t\tenvironmentId,\n\t\t\tclientId: clientId || '',\n\t\t\tusername,\n\t\t\ttokenType: 'worker',\n\t\t};\n\t}\n\n\t/**\n\t * Register a new MFA device\n\t */\n\tasync registerDevice(\n\t\tusername: string,\n\t\tdeviceType: DeviceConfigKey,\n\t\tdeviceData: {\n\t\t\tphoneNumber?: string;\n\t\t\temail?: string;\n\t\t\tname?: string;\n\t\t}\n\t): Promise<{\n\t\tdeviceId: string;\n\t\tstatus: string;\n\t\tqrCode?: string;\n\t}> {\n\t\tconsole.log('[UnifiedFlowServiceIntegration] Registering device:', {\n\t\t\tdeviceType,\n\t\t\tusername,\n\t\t\tdeviceData,\n\t\t});\n\n\t\tconst credentials = await this.buildCredentials(username);\n\n\t\t// Use MFAServiceV8.registerDevice\n\t\tconst result = await MFAServiceV8.registerDevice({\n\t\t\t...credentials,\n\t\t\ttype: deviceType as any,\n\t\t\tphoneNumber: deviceData.phoneNumber,\n\t\t\temail: deviceData.email,\n\t\t\tname: deviceData.name || `${deviceType} Device`,\n\t\t});\n\n\t\treturn {\n\t\t\tdeviceId: result.deviceId,\n\t\t\tstatus: result.status || 'PENDING',\n\t\t\tqrCode: result.qrCode,\n\t\t};\n\t}\n\n\t/**\n\t * Activate an MFA device with OTP code\n\t */\n\tasync activateDevice(\n\t\tusername: string,\n\t\tdeviceId: string,\n\t\totpCode: string\n\t): Promise<{\n\t\tsuccess: boolean;\n\t\tstatus: string;\n\t}> {\n\t\tconsole.log('[UnifiedFlowServiceIntegration] Activating device:', deviceId);\n\n\t\tconst credentials = await this.buildCredentials(username);\n\n\t\tconst result = await MFAServiceV8.activateDevice({\n\t\t\t...credentials,\n\t\t\tdeviceId,\n\t\t\totp: otpCode,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tstatus: (result as any).status || 'ACTIVE',\n\t\t};\n\t}\n\n\t/**\n\t * Get device details\n\t */\n\tasync getDevice(username: string, deviceId: string): Promise<Record<string, unknown>> {\n\t\tconst credentials = await this.buildCredentials(username);\n\t\treturn await MFAServiceV8.getDevice({ ...credentials, deviceId });\n\t}\n\n\t/**\n\t * Delete an MFA device\n\t */\n\tasync deleteDevice(username: string, deviceId: string): Promise<void> {\n\t\tconst credentials = await this.buildCredentials(username);\n\t\tawait MFAServiceV8.deleteDevice({ ...credentials, deviceId });\n\t}\n\n\t/**\n\t * List all MFA devices for a user\n\t */\n\tasync listDevices(username: string, filter?: string): Promise<Array<Record<string, unknown>>> {\n\t\tconst credentials = await this.buildCredentials(username);\n\t\treturn await MFAServiceV8.getAllDevices(credentials, filter);\n\t}\n\n\t/**\n\t * Check if global configuration is valid\n\t */\n\tasync validateConfiguration(): Promise<{\n\t\tvalid: boolean;\n\t\terrors: string[];\n\t}> {\n\t\tconst errors: string[] = [];\n\n\t\tconst environmentId = globalEnvironmentService.getEnvironmentId();\n\t\tif (!environmentId) {\n\t\t\terrors.push('Environment ID not configured');\n\t\t}\n\n\t\ttry {\n\t\t\tconst tokenStatus = await globalWorkerTokenService.getStatus();\n\t\t\tif (!tokenStatus.hasCredentials) {\n\t\t\t\terrors.push('Worker Token credentials not configured');\n\t\t\t}\n\t\t\tif (!tokenStatus.tokenValid) {\n\t\t\t\terrors.push('Worker Token is invalid or expired');\n\t\t\t}\n\t\t} catch (_error) {\n\t\t\terrors.push('Failed to validate Worker Token');\n\t\t}\n\n\t\treturn {\n\t\t\tvalid: errors.length === 0,\n\t\t\terrors,\n\t\t};\n\t}\n}\n\n// Export singleton instance\nexport const unifiedFlowServiceIntegration = new UnifiedFlowServiceIntegration();\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/utils/deviceFlowHelpers.ts"},"span":[2896,2899],"sourceCode":"/**\n * @file deviceFlowHelpers.ts\n * @module v8/flows/unified/utils\n * @description Helper utilities for unified device flow operations\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Provide common helper functions for device flow operations:\n * - Phone number formatting\n * - Step navigation logic\n * - Component type detection\n * - Device display formatting\n */\n\nimport type { DeviceConfigKey, DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFACredentials } from '@/v8/flows/shared/MFATypes';\nimport { validateAndNormalizePhone } from '@/v8/utils/phoneValidationV8';\n\nconst MODULE_TAG = '[üîß DEVICE-FLOW-HELPERS]';\n\n// ============================================================================\n// PHONE NUMBER HELPERS\n// ============================================================================\n\n/**\n * Get full phone number formatted for PingOne API\n * Format: +1.5125201234 (country code + dot + phone number)\n *\n * @param countryCode - Country code (e.g., \"+1\", \"1\", \"+44\")\n * @param phoneNumber - Phone number (with or without formatting)\n * @returns Formatted phone number for API\n *\n * @example\n * getFullPhoneNumber(\"+1\", \"512-520-1234\") // \"+1.5125201234\"\n * getFullPhoneNumber(\"1\", \"(512) 520-1234\") // \"+1.5125201234\"\n */\nexport function getFullPhoneNumber(countryCode: string, phoneNumber: string): string {\n\tconst phoneValidation = validateAndNormalizePhone(phoneNumber, countryCode);\n\n\t// If validation succeeded, use normalized format\n\tif (phoneValidation.isValid && phoneValidation.normalizedFullPhone) {\n\t\treturn phoneValidation.normalizedFullPhone;\n\t}\n\n\t// Fallback to old logic for backward compatibility\n\tconst cleanedPhone = phoneNumber.replace(/[^\\d]/g, '');\n\tconst cleanedCountryCode = countryCode.replace(/[^\\d+]/g, '');\n\treturn `${cleanedCountryCode}.${cleanedPhone}`;\n}\n\n/**\n * Get full phone number from credentials\n *\n * @param credentials - MFA credentials containing phone number and country code\n * @returns Formatted phone number for API\n */\nexport function getFullPhoneNumberFromCredentials(credentials: MFACredentials): string {\n\treturn getFullPhoneNumber(credentials.countryCode || '+1', credentials.phoneNumber || '');\n}\n\n// ============================================================================\n// NAVIGATION HELPERS\n// ============================================================================\n\n/**\n * Determine the next step after device registration based on device type and status\n *\n * @param config - Device flow configuration\n * @param registrationResult - Result from device registration API\n * @returns Next step index (0-4)\n *\n * Step indices:\n * - 0: Configuration\n * - 1: Device Selection\n * - 2: Registration\n * - 3: Activation\n * - 4: Success\n */\nexport function getNextStepAfterRegistration(\n\tconfig: DeviceFlowConfig,\n\tregistrationResult: { status?: string; deviceId?: string; [key: string]: any }\n): number {\n\tconsole.log(`${MODULE_TAG} Determining next step`, {\n\t\tdeviceType: config.deviceType,\n\t\tstatus: registrationResult.status,\n\t\trequiresOTP: config.requiresOTP,\n\t});\n\n\t// FIDO2: Registration includes activation (WebAuthn ceremony)\n\t// Go straight to success\n\tif (config.deviceType === 'FIDO2') {\n\t\tconsole.log(`${MODULE_TAG} FIDO2 device - skip to success`);\n\t\treturn 4; // Success step\n\t}\n\n\t// Mobile: Pairing happens via QR code scan\n\t// Go to activation to show pairing status\n\tif (config.deviceType === 'MOBILE') {\n\t\tconsole.log(`${MODULE_TAG} Mobile device - go to pairing status`);\n\t\treturn 3; // Activation step (shows pairing status)\n\t}\n\n\t// Check device status\n\tconst status = registrationResult.status?.toUpperCase();\n\n\t// If device is already ACTIVE, skip activation step\n\tif (status === 'ACTIVE') {\n\t\tconsole.log(`${MODULE_TAG} Device already active - skip to success`);\n\t\treturn 4; // Success step\n\t}\n\n\t// If device requires OTP activation\n\tif (config.requiresOTP && status === 'ACTIVATION_REQUIRED') {\n\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation`);\n\t\treturn 3; // Activation step\n\t}\n\n\t// Default: go to activation step\n\tconsole.log(`${MODULE_TAG} Default - go to activation`);\n\treturn 3; // Activation step\n}\n\n/**\n * Check if can proceed to next step based on current state\n *\n * @param currentStep - Current step index (0-4)\n * @param config - Device flow configuration\n * @param credentials - MFA credentials\n * @param mfaState - Current MFA state\n * @param tokenStatus - Token status information\n * @returns True if can proceed to next step\n */\nexport function canProceedToNextStep(\n\tcurrentStep: number,\n\t_config: DeviceFlowConfig,\n\tcredentials: MFACredentials,\n\tmfaState: { deviceId?: string; deviceStatus?: string; [key: string]: any },\n\ttokenStatus: { isValid: boolean; [key: string]: any }\n): boolean {\n\tconsole.log(`${MODULE_TAG} Checking if can proceed from step ${currentStep}`);\n\n\t// Step 0 (Configuration): Validate credentials and token\n\tif (currentStep === 0) {\n\t\tconst hasRequiredCredentials =\n\t\t\t!!credentials.environmentId &&\n\t\t\t!!credentials.username &&\n\t\t\t!!credentials.deviceAuthenticationPolicyId;\n\t\tconst hasValidToken = tokenStatus.isValid || !!credentials.userToken;\n\n\t\treturn hasRequiredCredentials && hasValidToken;\n\t}\n\n\t// Step 1 (Device Selection): Either selected existing device or ready to register new\n\tif (currentStep === 1) {\n\t\treturn true; // Always allow proceeding from device selection\n\t}\n\n\t// Step 2 (Registration): Must have device ID and valid status\n\tif (currentStep === 2) {\n\t\treturn !!mfaState.deviceId && !!mfaState.deviceStatus;\n\t}\n\n\t// Step 3 (Activation): Must have active device\n\tif (currentStep === 3) {\n\t\treturn mfaState.deviceStatus === 'ACTIVE';\n\t}\n\n\t// Step 4 (Success): Always allow (final step)\n\tif (currentStep === 4) {\n\t\treturn true;\n\t}\n\n\t// Unknown step\n\treturn false;\n}\n\n// ============================================================================\n// COMPONENT TYPE HELPERS\n// ============================================================================\n\n/**\n * Check if device type requires a custom component\n * (as opposed to using DynamicFormRenderer)\n *\n * @param deviceType - Device type to check\n * @returns True if device type has a custom component\n *\n * Custom components:\n * - TOTP: QR code display, manual entry\n * - FIDO2: WebAuthn ceremony\n * - MOBILE: QR code pairing\n *\n * Dynamic form renderer:\n * - SMS: Phone number input\n * - EMAIL: Email address input\n * - WHATSAPP: Phone number + email input\n */\nexport function requiresCustomComponent(deviceType: DeviceConfigKey): boolean {\n\tconst customComponentTypes: DeviceConfigKey[] = ['TOTP', 'FIDO2', 'MOBILE'];\n\treturn customComponentTypes.includes(deviceType);\n}\n\n/**\n * Check if device type requires OTP validation\n *\n * @param deviceType - Device type to check\n * @returns True if device type uses OTP\n */\nexport function requiresOTPValidation(deviceType: DeviceConfigKey): boolean {\n\tconst otpTypes: DeviceConfigKey[] = ['SMS', 'EMAIL', 'WHATSAPP', 'TOTP'];\n\treturn otpTypes.includes(deviceType);\n}\n\n// ============================================================================\n// DISPLAY FORMATTING HELPERS\n// ============================================================================\n\n/**\n * Format device display name for UI\n *\n * @param config - Device flow configuration\n * @param deviceData - Device data from API (optional)\n * @returns Formatted display name\n *\n * @example\n * formatDeviceDisplayName(smsConfig) // \"SMS Device\"\n * formatDeviceDisplayName(smsConfig, { nickname: \"My Phone\" }) // \"My Phone (SMS)\"\n * formatDeviceDisplayName(smsConfig, { phone: \"+1.5125201234\" }) // \"+1.5125201234 (SMS)\"\n */\nexport function formatDeviceDisplayName(\n\tconfig: DeviceFlowConfig,\n\tdeviceData?: {\n\t\tname?: string;\n\t\tnickname?: string;\n\t\tphone?: string;\n\t\temail?: string;\n\t\t[key: string]: any;\n\t}\n): string {\n\t// If no device data, return config display name\n\tif (!deviceData) {\n\t\treturn config.displayName;\n\t}\n\n\t// Prefer nickname, then name, then contact info\n\tconst displayName =\n\t\tdeviceData.nickname ||\n\t\tdeviceData.name ||\n\t\tdeviceData.phone ||\n\t\tdeviceData.email ||\n\t\tconfig.displayName;\n\n\t// Add device type in parentheses if using contact info\n\tif (deviceData.phone || deviceData.email) {\n\t\treturn `${displayName} (${config.displayName})`;\n\t}\n\n\treturn displayName;\n}\n\n/**\n * Format device contact information for display\n *\n * @param deviceType - Device type\n * @param deviceData - Device data from API\n * @returns Formatted contact information or null\n *\n * @example\n * formatDeviceContact('SMS', { phone: '+1.5125201234' }) // \"+1 (512) 520-1234\"\n * formatDeviceContact('EMAIL', { email: 'user@example.com' }) // \"user@example.com\"\n * formatDeviceContact('TOTP', {}) // null\n */\nexport function formatDeviceContact(\n\tdeviceType: DeviceConfigKey,\n\tdeviceData: { phone?: string; email?: string; [key: string]: any }\n): string | null {\n\tswitch (deviceType) {\n\t\tcase 'SMS':\n\t\tcase 'WHATSAPP':\n\t\t\tif (deviceData.phone) {\n\t\t\t\t// Format: +1.5125201234 -> +1 (512) 520-1234\n\t\t\t\tconst cleaned = deviceData.phone.replace(/[^\\d+.]/g, '');\n\t\t\t\tconst parts = cleaned.split('.');\n\t\t\t\tif (parts.length === 2) {\n\t\t\t\t\tconst countryCode = parts[0];\n\t\t\t\t\tconst number = parts[1];\n\t\t\t\t\t// Format US numbers as (XXX) XXX-XXXX\n\t\t\t\t\tif (number.length === 10) {\n\t\t\t\t\t\treturn `${countryCode} (${number.slice(0, 3)}) ${number.slice(3, 6)}-${number.slice(6)}`;\n\t\t\t\t\t}\n\t\t\t\t\treturn `${countryCode} ${number}`;\n\t\t\t\t}\n\t\t\t\treturn deviceData.phone;\n\t\t\t}\n\t\t\treturn null;\n\n\t\tcase 'EMAIL':\n\t\t\treturn deviceData.email || null;\n\n\t\tcase 'TOTP':\n\t\t\treturn 'Authenticator App';\n\n\t\tcase 'FIDO2':\n\t\t\treturn 'Security Key / Biometric';\n\n\t\tcase 'MOBILE':\n\t\t\treturn 'PingOne Mobile App';\n\n\t\tdefault:\n\t\t\treturn null;\n\t}\n}\n\n// ============================================================================\n// VALIDATION HELPERS\n// ============================================================================\n\n/**\n * Get validation error message for a field\n *\n * @param fieldName - Field name\n * @param value - Field value\n * @returns Error message or null if valid\n */\nexport function getFieldValidationError(fieldName: string, value: string): string | null {\n\tif (!value || !value.trim()) {\n\t\treturn `${fieldName} is required`;\n\t}\n\n\tswitch (fieldName) {\n\t\tcase 'email': {\n\t\t\tconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n\t\t\tif (!emailRegex.test(value)) {\n\t\t\t\treturn 'Invalid email address';\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'phoneNumber': {\n\t\t\tconst cleanedPhone = value.replace(/[^\\d]/g, '');\n\t\t\tif (cleanedPhone.length < 10) {\n\t\t\t\treturn 'Phone number must be at least 10 digits';\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'deviceName':\n\t\t\tif (value.length > 50) {\n\t\t\t\treturn 'Device name must be 50 characters or less';\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'nickname':\n\t\t\tif (value.length > 100) {\n\t\t\t\treturn 'Nickname must be 100 characters or less';\n\t\t\t}\n\t\t\tbreak;\n\t}\n\n\treturn null;\n}\n\n/**\n * Validate all required fields for a device type\n *\n * @param config - Device flow configuration\n * @param values - Field values\n * @returns Map of field name to error message\n */\nexport function validateDeviceFields(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): Record<string, string> {\n\tconst errors: Record<string, string> = {};\n\n\t// Validate required fields\n\tconfig.requiredFields.forEach((field) => {\n\t\tconst value = values[field];\n\t\tconst error = getFieldValidationError(field, value);\n\t\tif (error) {\n\t\t\terrors[field] = error;\n\t\t}\n\t});\n\n\t// Validate optional fields (only if they have a value)\n\tconfig.optionalFields.forEach((field) => {\n\t\tconst value = values[field];\n\t\tif (value?.trim()) {\n\t\t\tconst error = getFieldValidationError(field, value);\n\t\t\tif (error) {\n\t\t\t\terrors[field] = error;\n\t\t\t}\n\t\t}\n\t});\n\n\treturn errors;\n}\n\n/**\n * Check if all required fields are valid\n *\n * @param config - Device flow configuration\n * @param values - Field values\n * @returns True if all required fields are valid\n */\nexport function areRequiredFieldsValid(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): boolean {\n\tconst errors = validateDeviceFields(config, values);\n\tconst requiredFieldErrors = config.requiredFields.filter((field) => errors[field]);\n\treturn requiredFieldErrors.length === 0;\n}\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/utils/deviceFlowHelpers.ts"},"span":[4678,4681],"sourceCode":"/**\n * @file deviceFlowHelpers.ts\n * @module v8/flows/unified/utils\n * @description Helper utilities for unified device flow operations\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Provide common helper functions for device flow operations:\n * - Phone number formatting\n * - Step navigation logic\n * - Component type detection\n * - Device display formatting\n */\n\nimport type { DeviceConfigKey, DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFACredentials } from '@/v8/flows/shared/MFATypes';\nimport { validateAndNormalizePhone } from '@/v8/utils/phoneValidationV8';\n\nconst MODULE_TAG = '[üîß DEVICE-FLOW-HELPERS]';\n\n// ============================================================================\n// PHONE NUMBER HELPERS\n// ============================================================================\n\n/**\n * Get full phone number formatted for PingOne API\n * Format: +1.5125201234 (country code + dot + phone number)\n *\n * @param countryCode - Country code (e.g., \"+1\", \"1\", \"+44\")\n * @param phoneNumber - Phone number (with or without formatting)\n * @returns Formatted phone number for API\n *\n * @example\n * getFullPhoneNumber(\"+1\", \"512-520-1234\") // \"+1.5125201234\"\n * getFullPhoneNumber(\"1\", \"(512) 520-1234\") // \"+1.5125201234\"\n */\nexport function getFullPhoneNumber(countryCode: string, phoneNumber: string): string {\n\tconst phoneValidation = validateAndNormalizePhone(phoneNumber, countryCode);\n\n\t// If validation succeeded, use normalized format\n\tif (phoneValidation.isValid && phoneValidation.normalizedFullPhone) {\n\t\treturn phoneValidation.normalizedFullPhone;\n\t}\n\n\t// Fallback to old logic for backward compatibility\n\tconst cleanedPhone = phoneNumber.replace(/[^\\d]/g, '');\n\tconst cleanedCountryCode = countryCode.replace(/[^\\d+]/g, '');\n\treturn `${cleanedCountryCode}.${cleanedPhone}`;\n}\n\n/**\n * Get full phone number from credentials\n *\n * @param credentials - MFA credentials containing phone number and country code\n * @returns Formatted phone number for API\n */\nexport function getFullPhoneNumberFromCredentials(credentials: MFACredentials): string {\n\treturn getFullPhoneNumber(credentials.countryCode || '+1', credentials.phoneNumber || '');\n}\n\n// ============================================================================\n// NAVIGATION HELPERS\n// ============================================================================\n\n/**\n * Determine the next step after device registration based on device type and status\n *\n * @param config - Device flow configuration\n * @param registrationResult - Result from device registration API\n * @returns Next step index (0-4)\n *\n * Step indices:\n * - 0: Configuration\n * - 1: Device Selection\n * - 2: Registration\n * - 3: Activation\n * - 4: Success\n */\nexport function getNextStepAfterRegistration(\n\tconfig: DeviceFlowConfig,\n\tregistrationResult: { status?: string; deviceId?: string; [key: string]: any }\n): number {\n\tconsole.log(`${MODULE_TAG} Determining next step`, {\n\t\tdeviceType: config.deviceType,\n\t\tstatus: registrationResult.status,\n\t\trequiresOTP: config.requiresOTP,\n\t});\n\n\t// FIDO2: Registration includes activation (WebAuthn ceremony)\n\t// Go straight to success\n\tif (config.deviceType === 'FIDO2') {\n\t\tconsole.log(`${MODULE_TAG} FIDO2 device - skip to success`);\n\t\treturn 4; // Success step\n\t}\n\n\t// Mobile: Pairing happens via QR code scan\n\t// Go to activation to show pairing status\n\tif (config.deviceType === 'MOBILE') {\n\t\tconsole.log(`${MODULE_TAG} Mobile device - go to pairing status`);\n\t\treturn 3; // Activation step (shows pairing status)\n\t}\n\n\t// Check device status\n\tconst status = registrationResult.status?.toUpperCase();\n\n\t// If device is already ACTIVE, skip activation step\n\tif (status === 'ACTIVE') {\n\t\tconsole.log(`${MODULE_TAG} Device already active - skip to success`);\n\t\treturn 4; // Success step\n\t}\n\n\t// If device requires OTP activation\n\tif (config.requiresOTP && status === 'ACTIVATION_REQUIRED') {\n\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation`);\n\t\treturn 3; // Activation step\n\t}\n\n\t// Default: go to activation step\n\tconsole.log(`${MODULE_TAG} Default - go to activation`);\n\treturn 3; // Activation step\n}\n\n/**\n * Check if can proceed to next step based on current state\n *\n * @param currentStep - Current step index (0-4)\n * @param config - Device flow configuration\n * @param credentials - MFA credentials\n * @param mfaState - Current MFA state\n * @param tokenStatus - Token status information\n * @returns True if can proceed to next step\n */\nexport function canProceedToNextStep(\n\tcurrentStep: number,\n\t_config: DeviceFlowConfig,\n\tcredentials: MFACredentials,\n\tmfaState: { deviceId?: string; deviceStatus?: string; [key: string]: any },\n\ttokenStatus: { isValid: boolean; [key: string]: any }\n): boolean {\n\tconsole.log(`${MODULE_TAG} Checking if can proceed from step ${currentStep}`);\n\n\t// Step 0 (Configuration): Validate credentials and token\n\tif (currentStep === 0) {\n\t\tconst hasRequiredCredentials =\n\t\t\t!!credentials.environmentId &&\n\t\t\t!!credentials.username &&\n\t\t\t!!credentials.deviceAuthenticationPolicyId;\n\t\tconst hasValidToken = tokenStatus.isValid || !!credentials.userToken;\n\n\t\treturn hasRequiredCredentials && hasValidToken;\n\t}\n\n\t// Step 1 (Device Selection): Either selected existing device or ready to register new\n\tif (currentStep === 1) {\n\t\treturn true; // Always allow proceeding from device selection\n\t}\n\n\t// Step 2 (Registration): Must have device ID and valid status\n\tif (currentStep === 2) {\n\t\treturn !!mfaState.deviceId && !!mfaState.deviceStatus;\n\t}\n\n\t// Step 3 (Activation): Must have active device\n\tif (currentStep === 3) {\n\t\treturn mfaState.deviceStatus === 'ACTIVE';\n\t}\n\n\t// Step 4 (Success): Always allow (final step)\n\tif (currentStep === 4) {\n\t\treturn true;\n\t}\n\n\t// Unknown step\n\treturn false;\n}\n\n// ============================================================================\n// COMPONENT TYPE HELPERS\n// ============================================================================\n\n/**\n * Check if device type requires a custom component\n * (as opposed to using DynamicFormRenderer)\n *\n * @param deviceType - Device type to check\n * @returns True if device type has a custom component\n *\n * Custom components:\n * - TOTP: QR code display, manual entry\n * - FIDO2: WebAuthn ceremony\n * - MOBILE: QR code pairing\n *\n * Dynamic form renderer:\n * - SMS: Phone number input\n * - EMAIL: Email address input\n * - WHATSAPP: Phone number + email input\n */\nexport function requiresCustomComponent(deviceType: DeviceConfigKey): boolean {\n\tconst customComponentTypes: DeviceConfigKey[] = ['TOTP', 'FIDO2', 'MOBILE'];\n\treturn customComponentTypes.includes(deviceType);\n}\n\n/**\n * Check if device type requires OTP validation\n *\n * @param deviceType - Device type to check\n * @returns True if device type uses OTP\n */\nexport function requiresOTPValidation(deviceType: DeviceConfigKey): boolean {\n\tconst otpTypes: DeviceConfigKey[] = ['SMS', 'EMAIL', 'WHATSAPP', 'TOTP'];\n\treturn otpTypes.includes(deviceType);\n}\n\n// ============================================================================\n// DISPLAY FORMATTING HELPERS\n// ============================================================================\n\n/**\n * Format device display name for UI\n *\n * @param config - Device flow configuration\n * @param deviceData - Device data from API (optional)\n * @returns Formatted display name\n *\n * @example\n * formatDeviceDisplayName(smsConfig) // \"SMS Device\"\n * formatDeviceDisplayName(smsConfig, { nickname: \"My Phone\" }) // \"My Phone (SMS)\"\n * formatDeviceDisplayName(smsConfig, { phone: \"+1.5125201234\" }) // \"+1.5125201234 (SMS)\"\n */\nexport function formatDeviceDisplayName(\n\tconfig: DeviceFlowConfig,\n\tdeviceData?: {\n\t\tname?: string;\n\t\tnickname?: string;\n\t\tphone?: string;\n\t\temail?: string;\n\t\t[key: string]: any;\n\t}\n): string {\n\t// If no device data, return config display name\n\tif (!deviceData) {\n\t\treturn config.displayName;\n\t}\n\n\t// Prefer nickname, then name, then contact info\n\tconst displayName =\n\t\tdeviceData.nickname ||\n\t\tdeviceData.name ||\n\t\tdeviceData.phone ||\n\t\tdeviceData.email ||\n\t\tconfig.displayName;\n\n\t// Add device type in parentheses if using contact info\n\tif (deviceData.phone || deviceData.email) {\n\t\treturn `${displayName} (${config.displayName})`;\n\t}\n\n\treturn displayName;\n}\n\n/**\n * Format device contact information for display\n *\n * @param deviceType - Device type\n * @param deviceData - Device data from API\n * @returns Formatted contact information or null\n *\n * @example\n * formatDeviceContact('SMS', { phone: '+1.5125201234' }) // \"+1 (512) 520-1234\"\n * formatDeviceContact('EMAIL', { email: 'user@example.com' }) // \"user@example.com\"\n * formatDeviceContact('TOTP', {}) // null\n */\nexport function formatDeviceContact(\n\tdeviceType: DeviceConfigKey,\n\tdeviceData: { phone?: string; email?: string; [key: string]: any }\n): string | null {\n\tswitch (deviceType) {\n\t\tcase 'SMS':\n\t\tcase 'WHATSAPP':\n\t\t\tif (deviceData.phone) {\n\t\t\t\t// Format: +1.5125201234 -> +1 (512) 520-1234\n\t\t\t\tconst cleaned = deviceData.phone.replace(/[^\\d+.]/g, '');\n\t\t\t\tconst parts = cleaned.split('.');\n\t\t\t\tif (parts.length === 2) {\n\t\t\t\t\tconst countryCode = parts[0];\n\t\t\t\t\tconst number = parts[1];\n\t\t\t\t\t// Format US numbers as (XXX) XXX-XXXX\n\t\t\t\t\tif (number.length === 10) {\n\t\t\t\t\t\treturn `${countryCode} (${number.slice(0, 3)}) ${number.slice(3, 6)}-${number.slice(6)}`;\n\t\t\t\t\t}\n\t\t\t\t\treturn `${countryCode} ${number}`;\n\t\t\t\t}\n\t\t\t\treturn deviceData.phone;\n\t\t\t}\n\t\t\treturn null;\n\n\t\tcase 'EMAIL':\n\t\t\treturn deviceData.email || null;\n\n\t\tcase 'TOTP':\n\t\t\treturn 'Authenticator App';\n\n\t\tcase 'FIDO2':\n\t\t\treturn 'Security Key / Biometric';\n\n\t\tcase 'MOBILE':\n\t\t\treturn 'PingOne Mobile App';\n\n\t\tdefault:\n\t\t\treturn null;\n\t}\n}\n\n// ============================================================================\n// VALIDATION HELPERS\n// ============================================================================\n\n/**\n * Get validation error message for a field\n *\n * @param fieldName - Field name\n * @param value - Field value\n * @returns Error message or null if valid\n */\nexport function getFieldValidationError(fieldName: string, value: string): string | null {\n\tif (!value || !value.trim()) {\n\t\treturn `${fieldName} is required`;\n\t}\n\n\tswitch (fieldName) {\n\t\tcase 'email': {\n\t\t\tconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n\t\t\tif (!emailRegex.test(value)) {\n\t\t\t\treturn 'Invalid email address';\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'phoneNumber': {\n\t\t\tconst cleanedPhone = value.replace(/[^\\d]/g, '');\n\t\t\tif (cleanedPhone.length < 10) {\n\t\t\t\treturn 'Phone number must be at least 10 digits';\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'deviceName':\n\t\t\tif (value.length > 50) {\n\t\t\t\treturn 'Device name must be 50 characters or less';\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'nickname':\n\t\t\tif (value.length > 100) {\n\t\t\t\treturn 'Nickname must be 100 characters or less';\n\t\t\t}\n\t\t\tbreak;\n\t}\n\n\treturn null;\n}\n\n/**\n * Validate all required fields for a device type\n *\n * @param config - Device flow configuration\n * @param values - Field values\n * @returns Map of field name to error message\n */\nexport function validateDeviceFields(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): Record<string, string> {\n\tconst errors: Record<string, string> = {};\n\n\t// Validate required fields\n\tconfig.requiredFields.forEach((field) => {\n\t\tconst value = values[field];\n\t\tconst error = getFieldValidationError(field, value);\n\t\tif (error) {\n\t\t\terrors[field] = error;\n\t\t}\n\t});\n\n\t// Validate optional fields (only if they have a value)\n\tconfig.optionalFields.forEach((field) => {\n\t\tconst value = values[field];\n\t\tif (value?.trim()) {\n\t\t\tconst error = getFieldValidationError(field, value);\n\t\t\tif (error) {\n\t\t\t\terrors[field] = error;\n\t\t\t}\n\t\t}\n\t});\n\n\treturn errors;\n}\n\n/**\n * Check if all required fields are valid\n *\n * @param config - Device flow configuration\n * @param values - Field values\n * @returns True if all required fields are valid\n */\nexport function areRequiredFieldsValid(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): boolean {\n\tconst errors = validateDeviceFields(config, values);\n\tconst requiredFieldErrors = config.requiredFields.filter((field) => errors[field]);\n\treturn requiredFieldErrors.length === 0;\n}\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/utils/deviceFlowHelpers.ts"},"span":[4734,4737],"sourceCode":"/**\n * @file deviceFlowHelpers.ts\n * @module v8/flows/unified/utils\n * @description Helper utilities for unified device flow operations\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Provide common helper functions for device flow operations:\n * - Phone number formatting\n * - Step navigation logic\n * - Component type detection\n * - Device display formatting\n */\n\nimport type { DeviceConfigKey, DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFACredentials } from '@/v8/flows/shared/MFATypes';\nimport { validateAndNormalizePhone } from '@/v8/utils/phoneValidationV8';\n\nconst MODULE_TAG = '[üîß DEVICE-FLOW-HELPERS]';\n\n// ============================================================================\n// PHONE NUMBER HELPERS\n// ============================================================================\n\n/**\n * Get full phone number formatted for PingOne API\n * Format: +1.5125201234 (country code + dot + phone number)\n *\n * @param countryCode - Country code (e.g., \"+1\", \"1\", \"+44\")\n * @param phoneNumber - Phone number (with or without formatting)\n * @returns Formatted phone number for API\n *\n * @example\n * getFullPhoneNumber(\"+1\", \"512-520-1234\") // \"+1.5125201234\"\n * getFullPhoneNumber(\"1\", \"(512) 520-1234\") // \"+1.5125201234\"\n */\nexport function getFullPhoneNumber(countryCode: string, phoneNumber: string): string {\n\tconst phoneValidation = validateAndNormalizePhone(phoneNumber, countryCode);\n\n\t// If validation succeeded, use normalized format\n\tif (phoneValidation.isValid && phoneValidation.normalizedFullPhone) {\n\t\treturn phoneValidation.normalizedFullPhone;\n\t}\n\n\t// Fallback to old logic for backward compatibility\n\tconst cleanedPhone = phoneNumber.replace(/[^\\d]/g, '');\n\tconst cleanedCountryCode = countryCode.replace(/[^\\d+]/g, '');\n\treturn `${cleanedCountryCode}.${cleanedPhone}`;\n}\n\n/**\n * Get full phone number from credentials\n *\n * @param credentials - MFA credentials containing phone number and country code\n * @returns Formatted phone number for API\n */\nexport function getFullPhoneNumberFromCredentials(credentials: MFACredentials): string {\n\treturn getFullPhoneNumber(credentials.countryCode || '+1', credentials.phoneNumber || '');\n}\n\n// ============================================================================\n// NAVIGATION HELPERS\n// ============================================================================\n\n/**\n * Determine the next step after device registration based on device type and status\n *\n * @param config - Device flow configuration\n * @param registrationResult - Result from device registration API\n * @returns Next step index (0-4)\n *\n * Step indices:\n * - 0: Configuration\n * - 1: Device Selection\n * - 2: Registration\n * - 3: Activation\n * - 4: Success\n */\nexport function getNextStepAfterRegistration(\n\tconfig: DeviceFlowConfig,\n\tregistrationResult: { status?: string; deviceId?: string; [key: string]: any }\n): number {\n\tconsole.log(`${MODULE_TAG} Determining next step`, {\n\t\tdeviceType: config.deviceType,\n\t\tstatus: registrationResult.status,\n\t\trequiresOTP: config.requiresOTP,\n\t});\n\n\t// FIDO2: Registration includes activation (WebAuthn ceremony)\n\t// Go straight to success\n\tif (config.deviceType === 'FIDO2') {\n\t\tconsole.log(`${MODULE_TAG} FIDO2 device - skip to success`);\n\t\treturn 4; // Success step\n\t}\n\n\t// Mobile: Pairing happens via QR code scan\n\t// Go to activation to show pairing status\n\tif (config.deviceType === 'MOBILE') {\n\t\tconsole.log(`${MODULE_TAG} Mobile device - go to pairing status`);\n\t\treturn 3; // Activation step (shows pairing status)\n\t}\n\n\t// Check device status\n\tconst status = registrationResult.status?.toUpperCase();\n\n\t// If device is already ACTIVE, skip activation step\n\tif (status === 'ACTIVE') {\n\t\tconsole.log(`${MODULE_TAG} Device already active - skip to success`);\n\t\treturn 4; // Success step\n\t}\n\n\t// If device requires OTP activation\n\tif (config.requiresOTP && status === 'ACTIVATION_REQUIRED') {\n\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation`);\n\t\treturn 3; // Activation step\n\t}\n\n\t// Default: go to activation step\n\tconsole.log(`${MODULE_TAG} Default - go to activation`);\n\treturn 3; // Activation step\n}\n\n/**\n * Check if can proceed to next step based on current state\n *\n * @param currentStep - Current step index (0-4)\n * @param config - Device flow configuration\n * @param credentials - MFA credentials\n * @param mfaState - Current MFA state\n * @param tokenStatus - Token status information\n * @returns True if can proceed to next step\n */\nexport function canProceedToNextStep(\n\tcurrentStep: number,\n\t_config: DeviceFlowConfig,\n\tcredentials: MFACredentials,\n\tmfaState: { deviceId?: string; deviceStatus?: string; [key: string]: any },\n\ttokenStatus: { isValid: boolean; [key: string]: any }\n): boolean {\n\tconsole.log(`${MODULE_TAG} Checking if can proceed from step ${currentStep}`);\n\n\t// Step 0 (Configuration): Validate credentials and token\n\tif (currentStep === 0) {\n\t\tconst hasRequiredCredentials =\n\t\t\t!!credentials.environmentId &&\n\t\t\t!!credentials.username &&\n\t\t\t!!credentials.deviceAuthenticationPolicyId;\n\t\tconst hasValidToken = tokenStatus.isValid || !!credentials.userToken;\n\n\t\treturn hasRequiredCredentials && hasValidToken;\n\t}\n\n\t// Step 1 (Device Selection): Either selected existing device or ready to register new\n\tif (currentStep === 1) {\n\t\treturn true; // Always allow proceeding from device selection\n\t}\n\n\t// Step 2 (Registration): Must have device ID and valid status\n\tif (currentStep === 2) {\n\t\treturn !!mfaState.deviceId && !!mfaState.deviceStatus;\n\t}\n\n\t// Step 3 (Activation): Must have active device\n\tif (currentStep === 3) {\n\t\treturn mfaState.deviceStatus === 'ACTIVE';\n\t}\n\n\t// Step 4 (Success): Always allow (final step)\n\tif (currentStep === 4) {\n\t\treturn true;\n\t}\n\n\t// Unknown step\n\treturn false;\n}\n\n// ============================================================================\n// COMPONENT TYPE HELPERS\n// ============================================================================\n\n/**\n * Check if device type requires a custom component\n * (as opposed to using DynamicFormRenderer)\n *\n * @param deviceType - Device type to check\n * @returns True if device type has a custom component\n *\n * Custom components:\n * - TOTP: QR code display, manual entry\n * - FIDO2: WebAuthn ceremony\n * - MOBILE: QR code pairing\n *\n * Dynamic form renderer:\n * - SMS: Phone number input\n * - EMAIL: Email address input\n * - WHATSAPP: Phone number + email input\n */\nexport function requiresCustomComponent(deviceType: DeviceConfigKey): boolean {\n\tconst customComponentTypes: DeviceConfigKey[] = ['TOTP', 'FIDO2', 'MOBILE'];\n\treturn customComponentTypes.includes(deviceType);\n}\n\n/**\n * Check if device type requires OTP validation\n *\n * @param deviceType - Device type to check\n * @returns True if device type uses OTP\n */\nexport function requiresOTPValidation(deviceType: DeviceConfigKey): boolean {\n\tconst otpTypes: DeviceConfigKey[] = ['SMS', 'EMAIL', 'WHATSAPP', 'TOTP'];\n\treturn otpTypes.includes(deviceType);\n}\n\n// ============================================================================\n// DISPLAY FORMATTING HELPERS\n// ============================================================================\n\n/**\n * Format device display name for UI\n *\n * @param config - Device flow configuration\n * @param deviceData - Device data from API (optional)\n * @returns Formatted display name\n *\n * @example\n * formatDeviceDisplayName(smsConfig) // \"SMS Device\"\n * formatDeviceDisplayName(smsConfig, { nickname: \"My Phone\" }) // \"My Phone (SMS)\"\n * formatDeviceDisplayName(smsConfig, { phone: \"+1.5125201234\" }) // \"+1.5125201234 (SMS)\"\n */\nexport function formatDeviceDisplayName(\n\tconfig: DeviceFlowConfig,\n\tdeviceData?: {\n\t\tname?: string;\n\t\tnickname?: string;\n\t\tphone?: string;\n\t\temail?: string;\n\t\t[key: string]: any;\n\t}\n): string {\n\t// If no device data, return config display name\n\tif (!deviceData) {\n\t\treturn config.displayName;\n\t}\n\n\t// Prefer nickname, then name, then contact info\n\tconst displayName =\n\t\tdeviceData.nickname ||\n\t\tdeviceData.name ||\n\t\tdeviceData.phone ||\n\t\tdeviceData.email ||\n\t\tconfig.displayName;\n\n\t// Add device type in parentheses if using contact info\n\tif (deviceData.phone || deviceData.email) {\n\t\treturn `${displayName} (${config.displayName})`;\n\t}\n\n\treturn displayName;\n}\n\n/**\n * Format device contact information for display\n *\n * @param deviceType - Device type\n * @param deviceData - Device data from API\n * @returns Formatted contact information or null\n *\n * @example\n * formatDeviceContact('SMS', { phone: '+1.5125201234' }) // \"+1 (512) 520-1234\"\n * formatDeviceContact('EMAIL', { email: 'user@example.com' }) // \"user@example.com\"\n * formatDeviceContact('TOTP', {}) // null\n */\nexport function formatDeviceContact(\n\tdeviceType: DeviceConfigKey,\n\tdeviceData: { phone?: string; email?: string; [key: string]: any }\n): string | null {\n\tswitch (deviceType) {\n\t\tcase 'SMS':\n\t\tcase 'WHATSAPP':\n\t\t\tif (deviceData.phone) {\n\t\t\t\t// Format: +1.5125201234 -> +1 (512) 520-1234\n\t\t\t\tconst cleaned = deviceData.phone.replace(/[^\\d+.]/g, '');\n\t\t\t\tconst parts = cleaned.split('.');\n\t\t\t\tif (parts.length === 2) {\n\t\t\t\t\tconst countryCode = parts[0];\n\t\t\t\t\tconst number = parts[1];\n\t\t\t\t\t// Format US numbers as (XXX) XXX-XXXX\n\t\t\t\t\tif (number.length === 10) {\n\t\t\t\t\t\treturn `${countryCode} (${number.slice(0, 3)}) ${number.slice(3, 6)}-${number.slice(6)}`;\n\t\t\t\t\t}\n\t\t\t\t\treturn `${countryCode} ${number}`;\n\t\t\t\t}\n\t\t\t\treturn deviceData.phone;\n\t\t\t}\n\t\t\treturn null;\n\n\t\tcase 'EMAIL':\n\t\t\treturn deviceData.email || null;\n\n\t\tcase 'TOTP':\n\t\t\treturn 'Authenticator App';\n\n\t\tcase 'FIDO2':\n\t\t\treturn 'Security Key / Biometric';\n\n\t\tcase 'MOBILE':\n\t\t\treturn 'PingOne Mobile App';\n\n\t\tdefault:\n\t\t\treturn null;\n\t}\n}\n\n// ============================================================================\n// VALIDATION HELPERS\n// ============================================================================\n\n/**\n * Get validation error message for a field\n *\n * @param fieldName - Field name\n * @param value - Field value\n * @returns Error message or null if valid\n */\nexport function getFieldValidationError(fieldName: string, value: string): string | null {\n\tif (!value || !value.trim()) {\n\t\treturn `${fieldName} is required`;\n\t}\n\n\tswitch (fieldName) {\n\t\tcase 'email': {\n\t\t\tconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n\t\t\tif (!emailRegex.test(value)) {\n\t\t\t\treturn 'Invalid email address';\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'phoneNumber': {\n\t\t\tconst cleanedPhone = value.replace(/[^\\d]/g, '');\n\t\t\tif (cleanedPhone.length < 10) {\n\t\t\t\treturn 'Phone number must be at least 10 digits';\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'deviceName':\n\t\t\tif (value.length > 50) {\n\t\t\t\treturn 'Device name must be 50 characters or less';\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'nickname':\n\t\t\tif (value.length > 100) {\n\t\t\t\treturn 'Nickname must be 100 characters or less';\n\t\t\t}\n\t\t\tbreak;\n\t}\n\n\treturn null;\n}\n\n/**\n * Validate all required fields for a device type\n *\n * @param config - Device flow configuration\n * @param values - Field values\n * @returns Map of field name to error message\n */\nexport function validateDeviceFields(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): Record<string, string> {\n\tconst errors: Record<string, string> = {};\n\n\t// Validate required fields\n\tconfig.requiredFields.forEach((field) => {\n\t\tconst value = values[field];\n\t\tconst error = getFieldValidationError(field, value);\n\t\tif (error) {\n\t\t\terrors[field] = error;\n\t\t}\n\t});\n\n\t// Validate optional fields (only if they have a value)\n\tconfig.optionalFields.forEach((field) => {\n\t\tconst value = values[field];\n\t\tif (value?.trim()) {\n\t\t\tconst error = getFieldValidationError(field, value);\n\t\t\tif (error) {\n\t\t\t\terrors[field] = error;\n\t\t\t}\n\t\t}\n\t});\n\n\treturn errors;\n}\n\n/**\n * Check if all required fields are valid\n *\n * @param config - Device flow configuration\n * @param values - Field values\n * @returns True if all required fields are valid\n */\nexport function areRequiredFieldsValid(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): boolean {\n\tconst errors = validateDeviceFields(config, values);\n\tconst requiredFieldErrors = config.requiredFields.filter((field) => errors[field]);\n\treturn requiredFieldErrors.length === 0;\n}\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/utils/deviceFlowHelpers.ts"},"span":[7769,7772],"sourceCode":"/**\n * @file deviceFlowHelpers.ts\n * @module v8/flows/unified/utils\n * @description Helper utilities for unified device flow operations\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Provide common helper functions for device flow operations:\n * - Phone number formatting\n * - Step navigation logic\n * - Component type detection\n * - Device display formatting\n */\n\nimport type { DeviceConfigKey, DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFACredentials } from '@/v8/flows/shared/MFATypes';\nimport { validateAndNormalizePhone } from '@/v8/utils/phoneValidationV8';\n\nconst MODULE_TAG = '[üîß DEVICE-FLOW-HELPERS]';\n\n// ============================================================================\n// PHONE NUMBER HELPERS\n// ============================================================================\n\n/**\n * Get full phone number formatted for PingOne API\n * Format: +1.5125201234 (country code + dot + phone number)\n *\n * @param countryCode - Country code (e.g., \"+1\", \"1\", \"+44\")\n * @param phoneNumber - Phone number (with or without formatting)\n * @returns Formatted phone number for API\n *\n * @example\n * getFullPhoneNumber(\"+1\", \"512-520-1234\") // \"+1.5125201234\"\n * getFullPhoneNumber(\"1\", \"(512) 520-1234\") // \"+1.5125201234\"\n */\nexport function getFullPhoneNumber(countryCode: string, phoneNumber: string): string {\n\tconst phoneValidation = validateAndNormalizePhone(phoneNumber, countryCode);\n\n\t// If validation succeeded, use normalized format\n\tif (phoneValidation.isValid && phoneValidation.normalizedFullPhone) {\n\t\treturn phoneValidation.normalizedFullPhone;\n\t}\n\n\t// Fallback to old logic for backward compatibility\n\tconst cleanedPhone = phoneNumber.replace(/[^\\d]/g, '');\n\tconst cleanedCountryCode = countryCode.replace(/[^\\d+]/g, '');\n\treturn `${cleanedCountryCode}.${cleanedPhone}`;\n}\n\n/**\n * Get full phone number from credentials\n *\n * @param credentials - MFA credentials containing phone number and country code\n * @returns Formatted phone number for API\n */\nexport function getFullPhoneNumberFromCredentials(credentials: MFACredentials): string {\n\treturn getFullPhoneNumber(credentials.countryCode || '+1', credentials.phoneNumber || '');\n}\n\n// ============================================================================\n// NAVIGATION HELPERS\n// ============================================================================\n\n/**\n * Determine the next step after device registration based on device type and status\n *\n * @param config - Device flow configuration\n * @param registrationResult - Result from device registration API\n * @returns Next step index (0-4)\n *\n * Step indices:\n * - 0: Configuration\n * - 1: Device Selection\n * - 2: Registration\n * - 3: Activation\n * - 4: Success\n */\nexport function getNextStepAfterRegistration(\n\tconfig: DeviceFlowConfig,\n\tregistrationResult: { status?: string; deviceId?: string; [key: string]: any }\n): number {\n\tconsole.log(`${MODULE_TAG} Determining next step`, {\n\t\tdeviceType: config.deviceType,\n\t\tstatus: registrationResult.status,\n\t\trequiresOTP: config.requiresOTP,\n\t});\n\n\t// FIDO2: Registration includes activation (WebAuthn ceremony)\n\t// Go straight to success\n\tif (config.deviceType === 'FIDO2') {\n\t\tconsole.log(`${MODULE_TAG} FIDO2 device - skip to success`);\n\t\treturn 4; // Success step\n\t}\n\n\t// Mobile: Pairing happens via QR code scan\n\t// Go to activation to show pairing status\n\tif (config.deviceType === 'MOBILE') {\n\t\tconsole.log(`${MODULE_TAG} Mobile device - go to pairing status`);\n\t\treturn 3; // Activation step (shows pairing status)\n\t}\n\n\t// Check device status\n\tconst status = registrationResult.status?.toUpperCase();\n\n\t// If device is already ACTIVE, skip activation step\n\tif (status === 'ACTIVE') {\n\t\tconsole.log(`${MODULE_TAG} Device already active - skip to success`);\n\t\treturn 4; // Success step\n\t}\n\n\t// If device requires OTP activation\n\tif (config.requiresOTP && status === 'ACTIVATION_REQUIRED') {\n\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation`);\n\t\treturn 3; // Activation step\n\t}\n\n\t// Default: go to activation step\n\tconsole.log(`${MODULE_TAG} Default - go to activation`);\n\treturn 3; // Activation step\n}\n\n/**\n * Check if can proceed to next step based on current state\n *\n * @param currentStep - Current step index (0-4)\n * @param config - Device flow configuration\n * @param credentials - MFA credentials\n * @param mfaState - Current MFA state\n * @param tokenStatus - Token status information\n * @returns True if can proceed to next step\n */\nexport function canProceedToNextStep(\n\tcurrentStep: number,\n\t_config: DeviceFlowConfig,\n\tcredentials: MFACredentials,\n\tmfaState: { deviceId?: string; deviceStatus?: string; [key: string]: any },\n\ttokenStatus: { isValid: boolean; [key: string]: any }\n): boolean {\n\tconsole.log(`${MODULE_TAG} Checking if can proceed from step ${currentStep}`);\n\n\t// Step 0 (Configuration): Validate credentials and token\n\tif (currentStep === 0) {\n\t\tconst hasRequiredCredentials =\n\t\t\t!!credentials.environmentId &&\n\t\t\t!!credentials.username &&\n\t\t\t!!credentials.deviceAuthenticationPolicyId;\n\t\tconst hasValidToken = tokenStatus.isValid || !!credentials.userToken;\n\n\t\treturn hasRequiredCredentials && hasValidToken;\n\t}\n\n\t// Step 1 (Device Selection): Either selected existing device or ready to register new\n\tif (currentStep === 1) {\n\t\treturn true; // Always allow proceeding from device selection\n\t}\n\n\t// Step 2 (Registration): Must have device ID and valid status\n\tif (currentStep === 2) {\n\t\treturn !!mfaState.deviceId && !!mfaState.deviceStatus;\n\t}\n\n\t// Step 3 (Activation): Must have active device\n\tif (currentStep === 3) {\n\t\treturn mfaState.deviceStatus === 'ACTIVE';\n\t}\n\n\t// Step 4 (Success): Always allow (final step)\n\tif (currentStep === 4) {\n\t\treturn true;\n\t}\n\n\t// Unknown step\n\treturn false;\n}\n\n// ============================================================================\n// COMPONENT TYPE HELPERS\n// ============================================================================\n\n/**\n * Check if device type requires a custom component\n * (as opposed to using DynamicFormRenderer)\n *\n * @param deviceType - Device type to check\n * @returns True if device type has a custom component\n *\n * Custom components:\n * - TOTP: QR code display, manual entry\n * - FIDO2: WebAuthn ceremony\n * - MOBILE: QR code pairing\n *\n * Dynamic form renderer:\n * - SMS: Phone number input\n * - EMAIL: Email address input\n * - WHATSAPP: Phone number + email input\n */\nexport function requiresCustomComponent(deviceType: DeviceConfigKey): boolean {\n\tconst customComponentTypes: DeviceConfigKey[] = ['TOTP', 'FIDO2', 'MOBILE'];\n\treturn customComponentTypes.includes(deviceType);\n}\n\n/**\n * Check if device type requires OTP validation\n *\n * @param deviceType - Device type to check\n * @returns True if device type uses OTP\n */\nexport function requiresOTPValidation(deviceType: DeviceConfigKey): boolean {\n\tconst otpTypes: DeviceConfigKey[] = ['SMS', 'EMAIL', 'WHATSAPP', 'TOTP'];\n\treturn otpTypes.includes(deviceType);\n}\n\n// ============================================================================\n// DISPLAY FORMATTING HELPERS\n// ============================================================================\n\n/**\n * Format device display name for UI\n *\n * @param config - Device flow configuration\n * @param deviceData - Device data from API (optional)\n * @returns Formatted display name\n *\n * @example\n * formatDeviceDisplayName(smsConfig) // \"SMS Device\"\n * formatDeviceDisplayName(smsConfig, { nickname: \"My Phone\" }) // \"My Phone (SMS)\"\n * formatDeviceDisplayName(smsConfig, { phone: \"+1.5125201234\" }) // \"+1.5125201234 (SMS)\"\n */\nexport function formatDeviceDisplayName(\n\tconfig: DeviceFlowConfig,\n\tdeviceData?: {\n\t\tname?: string;\n\t\tnickname?: string;\n\t\tphone?: string;\n\t\temail?: string;\n\t\t[key: string]: any;\n\t}\n): string {\n\t// If no device data, return config display name\n\tif (!deviceData) {\n\t\treturn config.displayName;\n\t}\n\n\t// Prefer nickname, then name, then contact info\n\tconst displayName =\n\t\tdeviceData.nickname ||\n\t\tdeviceData.name ||\n\t\tdeviceData.phone ||\n\t\tdeviceData.email ||\n\t\tconfig.displayName;\n\n\t// Add device type in parentheses if using contact info\n\tif (deviceData.phone || deviceData.email) {\n\t\treturn `${displayName} (${config.displayName})`;\n\t}\n\n\treturn displayName;\n}\n\n/**\n * Format device contact information for display\n *\n * @param deviceType - Device type\n * @param deviceData - Device data from API\n * @returns Formatted contact information or null\n *\n * @example\n * formatDeviceContact('SMS', { phone: '+1.5125201234' }) // \"+1 (512) 520-1234\"\n * formatDeviceContact('EMAIL', { email: 'user@example.com' }) // \"user@example.com\"\n * formatDeviceContact('TOTP', {}) // null\n */\nexport function formatDeviceContact(\n\tdeviceType: DeviceConfigKey,\n\tdeviceData: { phone?: string; email?: string; [key: string]: any }\n): string | null {\n\tswitch (deviceType) {\n\t\tcase 'SMS':\n\t\tcase 'WHATSAPP':\n\t\t\tif (deviceData.phone) {\n\t\t\t\t// Format: +1.5125201234 -> +1 (512) 520-1234\n\t\t\t\tconst cleaned = deviceData.phone.replace(/[^\\d+.]/g, '');\n\t\t\t\tconst parts = cleaned.split('.');\n\t\t\t\tif (parts.length === 2) {\n\t\t\t\t\tconst countryCode = parts[0];\n\t\t\t\t\tconst number = parts[1];\n\t\t\t\t\t// Format US numbers as (XXX) XXX-XXXX\n\t\t\t\t\tif (number.length === 10) {\n\t\t\t\t\t\treturn `${countryCode} (${number.slice(0, 3)}) ${number.slice(3, 6)}-${number.slice(6)}`;\n\t\t\t\t\t}\n\t\t\t\t\treturn `${countryCode} ${number}`;\n\t\t\t\t}\n\t\t\t\treturn deviceData.phone;\n\t\t\t}\n\t\t\treturn null;\n\n\t\tcase 'EMAIL':\n\t\t\treturn deviceData.email || null;\n\n\t\tcase 'TOTP':\n\t\t\treturn 'Authenticator App';\n\n\t\tcase 'FIDO2':\n\t\t\treturn 'Security Key / Biometric';\n\n\t\tcase 'MOBILE':\n\t\t\treturn 'PingOne Mobile App';\n\n\t\tdefault:\n\t\t\treturn null;\n\t}\n}\n\n// ============================================================================\n// VALIDATION HELPERS\n// ============================================================================\n\n/**\n * Get validation error message for a field\n *\n * @param fieldName - Field name\n * @param value - Field value\n * @returns Error message or null if valid\n */\nexport function getFieldValidationError(fieldName: string, value: string): string | null {\n\tif (!value || !value.trim()) {\n\t\treturn `${fieldName} is required`;\n\t}\n\n\tswitch (fieldName) {\n\t\tcase 'email': {\n\t\t\tconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n\t\t\tif (!emailRegex.test(value)) {\n\t\t\t\treturn 'Invalid email address';\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'phoneNumber': {\n\t\t\tconst cleanedPhone = value.replace(/[^\\d]/g, '');\n\t\t\tif (cleanedPhone.length < 10) {\n\t\t\t\treturn 'Phone number must be at least 10 digits';\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'deviceName':\n\t\t\tif (value.length > 50) {\n\t\t\t\treturn 'Device name must be 50 characters or less';\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'nickname':\n\t\t\tif (value.length > 100) {\n\t\t\t\treturn 'Nickname must be 100 characters or less';\n\t\t\t}\n\t\t\tbreak;\n\t}\n\n\treturn null;\n}\n\n/**\n * Validate all required fields for a device type\n *\n * @param config - Device flow configuration\n * @param values - Field values\n * @returns Map of field name to error message\n */\nexport function validateDeviceFields(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): Record<string, string> {\n\tconst errors: Record<string, string> = {};\n\n\t// Validate required fields\n\tconfig.requiredFields.forEach((field) => {\n\t\tconst value = values[field];\n\t\tconst error = getFieldValidationError(field, value);\n\t\tif (error) {\n\t\t\terrors[field] = error;\n\t\t}\n\t});\n\n\t// Validate optional fields (only if they have a value)\n\tconfig.optionalFields.forEach((field) => {\n\t\tconst value = values[field];\n\t\tif (value?.trim()) {\n\t\t\tconst error = getFieldValidationError(field, value);\n\t\t\tif (error) {\n\t\t\t\terrors[field] = error;\n\t\t\t}\n\t\t}\n\t});\n\n\treturn errors;\n}\n\n/**\n * Check if all required fields are valid\n *\n * @param config - Device flow configuration\n * @param values - Field values\n * @returns True if all required fields are valid\n */\nexport function areRequiredFieldsValid(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): boolean {\n\tconst errors = validateDeviceFields(config, values);\n\tconst requiredFieldErrors = config.requiredFields.filter((field) => errors[field]);\n\treturn requiredFieldErrors.length === 0;\n}\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/utils/deviceFlowHelpers.ts"},"span":[8799,8802],"sourceCode":"/**\n * @file deviceFlowHelpers.ts\n * @module v8/flows/unified/utils\n * @description Helper utilities for unified device flow operations\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Provide common helper functions for device flow operations:\n * - Phone number formatting\n * - Step navigation logic\n * - Component type detection\n * - Device display formatting\n */\n\nimport type { DeviceConfigKey, DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFACredentials } from '@/v8/flows/shared/MFATypes';\nimport { validateAndNormalizePhone } from '@/v8/utils/phoneValidationV8';\n\nconst MODULE_TAG = '[üîß DEVICE-FLOW-HELPERS]';\n\n// ============================================================================\n// PHONE NUMBER HELPERS\n// ============================================================================\n\n/**\n * Get full phone number formatted for PingOne API\n * Format: +1.5125201234 (country code + dot + phone number)\n *\n * @param countryCode - Country code (e.g., \"+1\", \"1\", \"+44\")\n * @param phoneNumber - Phone number (with or without formatting)\n * @returns Formatted phone number for API\n *\n * @example\n * getFullPhoneNumber(\"+1\", \"512-520-1234\") // \"+1.5125201234\"\n * getFullPhoneNumber(\"1\", \"(512) 520-1234\") // \"+1.5125201234\"\n */\nexport function getFullPhoneNumber(countryCode: string, phoneNumber: string): string {\n\tconst phoneValidation = validateAndNormalizePhone(phoneNumber, countryCode);\n\n\t// If validation succeeded, use normalized format\n\tif (phoneValidation.isValid && phoneValidation.normalizedFullPhone) {\n\t\treturn phoneValidation.normalizedFullPhone;\n\t}\n\n\t// Fallback to old logic for backward compatibility\n\tconst cleanedPhone = phoneNumber.replace(/[^\\d]/g, '');\n\tconst cleanedCountryCode = countryCode.replace(/[^\\d+]/g, '');\n\treturn `${cleanedCountryCode}.${cleanedPhone}`;\n}\n\n/**\n * Get full phone number from credentials\n *\n * @param credentials - MFA credentials containing phone number and country code\n * @returns Formatted phone number for API\n */\nexport function getFullPhoneNumberFromCredentials(credentials: MFACredentials): string {\n\treturn getFullPhoneNumber(credentials.countryCode || '+1', credentials.phoneNumber || '');\n}\n\n// ============================================================================\n// NAVIGATION HELPERS\n// ============================================================================\n\n/**\n * Determine the next step after device registration based on device type and status\n *\n * @param config - Device flow configuration\n * @param registrationResult - Result from device registration API\n * @returns Next step index (0-4)\n *\n * Step indices:\n * - 0: Configuration\n * - 1: Device Selection\n * - 2: Registration\n * - 3: Activation\n * - 4: Success\n */\nexport function getNextStepAfterRegistration(\n\tconfig: DeviceFlowConfig,\n\tregistrationResult: { status?: string; deviceId?: string; [key: string]: any }\n): number {\n\tconsole.log(`${MODULE_TAG} Determining next step`, {\n\t\tdeviceType: config.deviceType,\n\t\tstatus: registrationResult.status,\n\t\trequiresOTP: config.requiresOTP,\n\t});\n\n\t// FIDO2: Registration includes activation (WebAuthn ceremony)\n\t// Go straight to success\n\tif (config.deviceType === 'FIDO2') {\n\t\tconsole.log(`${MODULE_TAG} FIDO2 device - skip to success`);\n\t\treturn 4; // Success step\n\t}\n\n\t// Mobile: Pairing happens via QR code scan\n\t// Go to activation to show pairing status\n\tif (config.deviceType === 'MOBILE') {\n\t\tconsole.log(`${MODULE_TAG} Mobile device - go to pairing status`);\n\t\treturn 3; // Activation step (shows pairing status)\n\t}\n\n\t// Check device status\n\tconst status = registrationResult.status?.toUpperCase();\n\n\t// If device is already ACTIVE, skip activation step\n\tif (status === 'ACTIVE') {\n\t\tconsole.log(`${MODULE_TAG} Device already active - skip to success`);\n\t\treturn 4; // Success step\n\t}\n\n\t// If device requires OTP activation\n\tif (config.requiresOTP && status === 'ACTIVATION_REQUIRED') {\n\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation`);\n\t\treturn 3; // Activation step\n\t}\n\n\t// Default: go to activation step\n\tconsole.log(`${MODULE_TAG} Default - go to activation`);\n\treturn 3; // Activation step\n}\n\n/**\n * Check if can proceed to next step based on current state\n *\n * @param currentStep - Current step index (0-4)\n * @param config - Device flow configuration\n * @param credentials - MFA credentials\n * @param mfaState - Current MFA state\n * @param tokenStatus - Token status information\n * @returns True if can proceed to next step\n */\nexport function canProceedToNextStep(\n\tcurrentStep: number,\n\t_config: DeviceFlowConfig,\n\tcredentials: MFACredentials,\n\tmfaState: { deviceId?: string; deviceStatus?: string; [key: string]: any },\n\ttokenStatus: { isValid: boolean; [key: string]: any }\n): boolean {\n\tconsole.log(`${MODULE_TAG} Checking if can proceed from step ${currentStep}`);\n\n\t// Step 0 (Configuration): Validate credentials and token\n\tif (currentStep === 0) {\n\t\tconst hasRequiredCredentials =\n\t\t\t!!credentials.environmentId &&\n\t\t\t!!credentials.username &&\n\t\t\t!!credentials.deviceAuthenticationPolicyId;\n\t\tconst hasValidToken = tokenStatus.isValid || !!credentials.userToken;\n\n\t\treturn hasRequiredCredentials && hasValidToken;\n\t}\n\n\t// Step 1 (Device Selection): Either selected existing device or ready to register new\n\tif (currentStep === 1) {\n\t\treturn true; // Always allow proceeding from device selection\n\t}\n\n\t// Step 2 (Registration): Must have device ID and valid status\n\tif (currentStep === 2) {\n\t\treturn !!mfaState.deviceId && !!mfaState.deviceStatus;\n\t}\n\n\t// Step 3 (Activation): Must have active device\n\tif (currentStep === 3) {\n\t\treturn mfaState.deviceStatus === 'ACTIVE';\n\t}\n\n\t// Step 4 (Success): Always allow (final step)\n\tif (currentStep === 4) {\n\t\treturn true;\n\t}\n\n\t// Unknown step\n\treturn false;\n}\n\n// ============================================================================\n// COMPONENT TYPE HELPERS\n// ============================================================================\n\n/**\n * Check if device type requires a custom component\n * (as opposed to using DynamicFormRenderer)\n *\n * @param deviceType - Device type to check\n * @returns True if device type has a custom component\n *\n * Custom components:\n * - TOTP: QR code display, manual entry\n * - FIDO2: WebAuthn ceremony\n * - MOBILE: QR code pairing\n *\n * Dynamic form renderer:\n * - SMS: Phone number input\n * - EMAIL: Email address input\n * - WHATSAPP: Phone number + email input\n */\nexport function requiresCustomComponent(deviceType: DeviceConfigKey): boolean {\n\tconst customComponentTypes: DeviceConfigKey[] = ['TOTP', 'FIDO2', 'MOBILE'];\n\treturn customComponentTypes.includes(deviceType);\n}\n\n/**\n * Check if device type requires OTP validation\n *\n * @param deviceType - Device type to check\n * @returns True if device type uses OTP\n */\nexport function requiresOTPValidation(deviceType: DeviceConfigKey): boolean {\n\tconst otpTypes: DeviceConfigKey[] = ['SMS', 'EMAIL', 'WHATSAPP', 'TOTP'];\n\treturn otpTypes.includes(deviceType);\n}\n\n// ============================================================================\n// DISPLAY FORMATTING HELPERS\n// ============================================================================\n\n/**\n * Format device display name for UI\n *\n * @param config - Device flow configuration\n * @param deviceData - Device data from API (optional)\n * @returns Formatted display name\n *\n * @example\n * formatDeviceDisplayName(smsConfig) // \"SMS Device\"\n * formatDeviceDisplayName(smsConfig, { nickname: \"My Phone\" }) // \"My Phone (SMS)\"\n * formatDeviceDisplayName(smsConfig, { phone: \"+1.5125201234\" }) // \"+1.5125201234 (SMS)\"\n */\nexport function formatDeviceDisplayName(\n\tconfig: DeviceFlowConfig,\n\tdeviceData?: {\n\t\tname?: string;\n\t\tnickname?: string;\n\t\tphone?: string;\n\t\temail?: string;\n\t\t[key: string]: any;\n\t}\n): string {\n\t// If no device data, return config display name\n\tif (!deviceData) {\n\t\treturn config.displayName;\n\t}\n\n\t// Prefer nickname, then name, then contact info\n\tconst displayName =\n\t\tdeviceData.nickname ||\n\t\tdeviceData.name ||\n\t\tdeviceData.phone ||\n\t\tdeviceData.email ||\n\t\tconfig.displayName;\n\n\t// Add device type in parentheses if using contact info\n\tif (deviceData.phone || deviceData.email) {\n\t\treturn `${displayName} (${config.displayName})`;\n\t}\n\n\treturn displayName;\n}\n\n/**\n * Format device contact information for display\n *\n * @param deviceType - Device type\n * @param deviceData - Device data from API\n * @returns Formatted contact information or null\n *\n * @example\n * formatDeviceContact('SMS', { phone: '+1.5125201234' }) // \"+1 (512) 520-1234\"\n * formatDeviceContact('EMAIL', { email: 'user@example.com' }) // \"user@example.com\"\n * formatDeviceContact('TOTP', {}) // null\n */\nexport function formatDeviceContact(\n\tdeviceType: DeviceConfigKey,\n\tdeviceData: { phone?: string; email?: string; [key: string]: any }\n): string | null {\n\tswitch (deviceType) {\n\t\tcase 'SMS':\n\t\tcase 'WHATSAPP':\n\t\t\tif (deviceData.phone) {\n\t\t\t\t// Format: +1.5125201234 -> +1 (512) 520-1234\n\t\t\t\tconst cleaned = deviceData.phone.replace(/[^\\d+.]/g, '');\n\t\t\t\tconst parts = cleaned.split('.');\n\t\t\t\tif (parts.length === 2) {\n\t\t\t\t\tconst countryCode = parts[0];\n\t\t\t\t\tconst number = parts[1];\n\t\t\t\t\t// Format US numbers as (XXX) XXX-XXXX\n\t\t\t\t\tif (number.length === 10) {\n\t\t\t\t\t\treturn `${countryCode} (${number.slice(0, 3)}) ${number.slice(3, 6)}-${number.slice(6)}`;\n\t\t\t\t\t}\n\t\t\t\t\treturn `${countryCode} ${number}`;\n\t\t\t\t}\n\t\t\t\treturn deviceData.phone;\n\t\t\t}\n\t\t\treturn null;\n\n\t\tcase 'EMAIL':\n\t\t\treturn deviceData.email || null;\n\n\t\tcase 'TOTP':\n\t\t\treturn 'Authenticator App';\n\n\t\tcase 'FIDO2':\n\t\t\treturn 'Security Key / Biometric';\n\n\t\tcase 'MOBILE':\n\t\t\treturn 'PingOne Mobile App';\n\n\t\tdefault:\n\t\t\treturn null;\n\t}\n}\n\n// ============================================================================\n// VALIDATION HELPERS\n// ============================================================================\n\n/**\n * Get validation error message for a field\n *\n * @param fieldName - Field name\n * @param value - Field value\n * @returns Error message or null if valid\n */\nexport function getFieldValidationError(fieldName: string, value: string): string | null {\n\tif (!value || !value.trim()) {\n\t\treturn `${fieldName} is required`;\n\t}\n\n\tswitch (fieldName) {\n\t\tcase 'email': {\n\t\t\tconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n\t\t\tif (!emailRegex.test(value)) {\n\t\t\t\treturn 'Invalid email address';\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'phoneNumber': {\n\t\t\tconst cleanedPhone = value.replace(/[^\\d]/g, '');\n\t\t\tif (cleanedPhone.length < 10) {\n\t\t\t\treturn 'Phone number must be at least 10 digits';\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'deviceName':\n\t\t\tif (value.length > 50) {\n\t\t\t\treturn 'Device name must be 50 characters or less';\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'nickname':\n\t\t\tif (value.length > 100) {\n\t\t\t\treturn 'Nickname must be 100 characters or less';\n\t\t\t}\n\t\t\tbreak;\n\t}\n\n\treturn null;\n}\n\n/**\n * Validate all required fields for a device type\n *\n * @param config - Device flow configuration\n * @param values - Field values\n * @returns Map of field name to error message\n */\nexport function validateDeviceFields(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): Record<string, string> {\n\tconst errors: Record<string, string> = {};\n\n\t// Validate required fields\n\tconfig.requiredFields.forEach((field) => {\n\t\tconst value = values[field];\n\t\tconst error = getFieldValidationError(field, value);\n\t\tif (error) {\n\t\t\terrors[field] = error;\n\t\t}\n\t});\n\n\t// Validate optional fields (only if they have a value)\n\tconfig.optionalFields.forEach((field) => {\n\t\tconst value = values[field];\n\t\tif (value?.trim()) {\n\t\t\tconst error = getFieldValidationError(field, value);\n\t\t\tif (error) {\n\t\t\t\terrors[field] = error;\n\t\t\t}\n\t\t}\n\t});\n\n\treturn errors;\n}\n\n/**\n * Check if all required fields are valid\n *\n * @param config - Device flow configuration\n * @param values - Field values\n * @returns True if all required fields are valid\n */\nexport function areRequiredFieldsValid(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): boolean {\n\tconst errors = validateDeviceFields(config, values);\n\tconst requiredFieldErrors = config.requiredFields.filter((field) => errors[field]);\n\treturn requiredFieldErrors.length === 0;\n}\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/utils/unifiedFlowValidation.ts"},"span":[7854,7857],"sourceCode":"/**\n * @file unifiedFlowValidation.ts\n * @module v8/flows/unified/utils\n * @description Validation utilities for unified MFA registration flow\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Centralized validation logic for the unified flow:\n * - Required field validation\n * - Config-driven validation rules\n * - Step-specific validation\n * - Cross-field validation\n */\n\nimport type { DeviceFlowConfig, ValidationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFACredentials } from '@/v8/flows/shared/MFATypes';\n\nconst MODULE_TAG = '[‚úÖ UNIFIED-FLOW-VALIDATION]';\n\n// ============================================================================\n// FIELD VALIDATION\n// ============================================================================\n\n/**\n * Validate all required fields are present and non-empty\n *\n * @param config - Device flow configuration\n * @param values - Current field values\n * @returns Validation result with errors by field name\n *\n * @example\n * const result = validateRequiredFields(smsConfig, { phoneNumber: '', countryCode: '+1' });\n * // result = { valid: false, errors: { phoneNumber: 'Phone number is required' } }\n */\nexport function validateRequiredFields(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): { valid: boolean; errors: Record<string, string> } {\n\tconsole.log(`${MODULE_TAG} Validating required fields for ${config.deviceType}`);\n\n\tconst errors: Record<string, string> = {};\n\n\t// Check each required field\n\tconfig.requiredFields.forEach((fieldName) => {\n\t\tconst value = values[fieldName];\n\n\t\tif (!value || !value.trim()) {\n\t\t\terrors[fieldName] = `${formatFieldName(fieldName)} is required`;\n\t\t}\n\t});\n\n\tconst valid = Object.keys(errors).length === 0;\n\n\tconsole.log(`${MODULE_TAG} Required fields validation:`, {\n\t\tvalid,\n\t\terrorCount: Object.keys(errors).length,\n\t});\n\n\treturn { valid, errors };\n}\n\n/**\n * Run all validation rules from config\n *\n * @param config - Device flow configuration\n * @param values - Current field values\n * @returns Map of field name to validation result\n *\n * @example\n * const results = runValidationRules(smsConfig, { phoneNumber: '123' });\n * // results = { phoneNumber: { valid: false, error: 'Phone number must be at least 10 digits' } }\n */\nexport function runValidationRules(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): Record<string, ValidationResult> {\n\tconsole.log(`${MODULE_TAG} Running validation rules for ${config.deviceType}`);\n\n\tconst results: Record<string, ValidationResult> = {};\n\n\t// Run validation rules for each field that has a validator\n\tObject.entries(config.validationRules).forEach(([fieldName, validator]) => {\n\t\tconst value = values[fieldName] || '';\n\t\tresults[fieldName] = validator(value);\n\t});\n\n\treturn results;\n}\n\n/**\n * Validate all fields using config-driven rules\n *\n * @param config - Device flow configuration\n * @param values - Current field values\n * @returns Combined validation result\n */\nexport function validateAllFields(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): { valid: boolean; errors: Record<string, string>; warnings: Record<string, string> } {\n\tconsole.log(`${MODULE_TAG} Validating all fields for ${config.deviceType}`);\n\n\tconst errors: Record<string, string> = {};\n\tconst warnings: Record<string, string> = {};\n\n\t// Run validation rules\n\tconst validationResults = runValidationRules(config, values);\n\n\t// Extract errors and warnings\n\tObject.entries(validationResults).forEach(([fieldName, result]) => {\n\t\tif (!result.valid && result.error) {\n\t\t\terrors[fieldName] = result.error;\n\t\t}\n\t\tif (result.warning) {\n\t\t\twarnings[fieldName] = result.warning;\n\t\t}\n\t});\n\n\tconst valid = Object.keys(errors).length === 0;\n\n\tconsole.log(`${MODULE_TAG} All fields validation:`, {\n\t\tvalid,\n\t\terrorCount: Object.keys(errors).length,\n\t\twarningCount: Object.keys(warnings).length,\n\t});\n\n\treturn { valid, errors, warnings };\n}\n\n// ============================================================================\n// STEP-SPECIFIC VALIDATION\n// ============================================================================\n\n/**\n * Validate Step 0 (Configuration) credentials\n *\n * @param credentials - MFA credentials\n * @param tokenStatus - Token status information\n * @returns Validation result\n */\nexport function validateConfigurationStep(\n\tcredentials: MFACredentials,\n\ttokenStatus: { isValid: boolean; [key: string]: any }\n): { valid: boolean; errors: string[] } {\n\tconsole.log(`${MODULE_TAG} Validating configuration step`);\n\n\tconst errors: string[] = [];\n\n\t// Environment ID\n\tif (!credentials.environmentId?.trim()) {\n\t\terrors.push('Environment ID is required');\n\t}\n\n\t// Username\n\tif (!credentials.username?.trim()) {\n\t\terrors.push('Username is required');\n\t}\n\n\t// Device Authentication Policy ID\n\tif (!credentials.deviceAuthenticationPolicyId?.trim()) {\n\t\terrors.push('Device Authentication Policy ID is required');\n\t}\n\n\t// Token validation based on token type\n\tconst tokenType = credentials.tokenType || 'worker';\n\tconst isTokenValid =\n\t\ttokenType === 'worker' ? tokenStatus.isValid : !!credentials.userToken?.trim();\n\n\tif (!isTokenValid) {\n\t\terrors.push(`${tokenType === 'worker' ? 'Worker' : 'User'} token is required`);\n\t}\n\n\tconst valid = errors.length === 0;\n\n\tconsole.log(`${MODULE_TAG} Configuration validation:`, { valid, errorCount: errors.length });\n\n\treturn { valid, errors };\n}\n\n/**\n * Validate Step 2 (Registration) device fields\n *\n * @param config - Device flow configuration\n * @param values - Field values\n * @returns Validation result\n */\nexport function validateRegistrationStep(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): { valid: boolean; errors: Record<string, string> } {\n\tconsole.log(`${MODULE_TAG} Validating registration step for ${config.deviceType}`);\n\n\t// Validate using config-driven rules\n\tconst { valid, errors } = validateAllFields(config, values);\n\n\treturn { valid, errors };\n}\n\n/**\n * Validate Step 3 (Activation) OTP code\n *\n * @param otp - OTP code to validate\n * @returns Validation result\n */\nexport function validateActivationOTP(otp: string): { valid: boolean; error?: string } {\n\tconsole.log(`${MODULE_TAG} Validating OTP code`);\n\n\t// OTP must be exactly 6 digits\n\tif (!otp || otp.length !== 6) {\n\t\treturn { valid: false, error: 'OTP must be 6 digits' };\n\t}\n\n\t// OTP must contain only digits\n\tif (!/^\\d{6}$/.test(otp)) {\n\t\treturn { valid: false, error: 'OTP must contain only numbers' };\n\t}\n\n\treturn { valid: true };\n}\n\n// ============================================================================\n// CROSS-FIELD VALIDATION\n// ============================================================================\n\n/**\n * Validate WhatsApp fields (requires either phone or email)\n *\n * @param values - Field values\n * @returns Validation result\n */\nexport function validateWhatsAppFields(values: Record<string, string>): {\n\tvalid: boolean;\n\terrors: Record<string, string>;\n} {\n\tconst errors: Record<string, string> = {};\n\n\tconst hasPhone = !!values.phoneNumber?.trim();\n\tconst hasEmail = !!values.email?.trim();\n\n\t// WhatsApp requires either phone or email (or both)\n\tif (!hasPhone && !hasEmail) {\n\t\terrors.phoneNumber = 'Phone number or email is required';\n\t\terrors.email = 'Phone number or email is required';\n\t}\n\n\treturn {\n\t\tvalid: Object.keys(errors).length === 0,\n\t\terrors,\n\t};\n}\n\n/**\n * Check if can proceed to next step\n *\n * @param currentStep - Current step index (0-4)\n * @param config - Device flow configuration\n * @param credentials - MFA credentials\n * @param mfaState - Current MFA state\n * @param tokenStatus - Token status\n * @returns True if can proceed\n */\nexport function canProceedToNextStep(\n\tcurrentStep: number,\n\t_config: DeviceFlowConfig,\n\tcredentials: MFACredentials,\n\tmfaState: { deviceId?: string; deviceStatus?: string; [key: string]: any },\n\ttokenStatus: { isValid: boolean; [key: string]: any }\n): boolean {\n\tconsole.log(`${MODULE_TAG} Checking if can proceed from step ${currentStep}`);\n\n\tswitch (currentStep) {\n\t\tcase 0: {\n\t\t\t// Configuration step\n\t\t\tconst { valid } = validateConfigurationStep(credentials, tokenStatus);\n\t\t\treturn valid;\n\t\t}\n\n\t\tcase 1: {\n\t\t\t// Device selection step - always allow\n\t\t\treturn true;\n\t\t}\n\n\t\tcase 2: {\n\t\t\t// Registration step - must have device ID\n\t\t\treturn !!mfaState.deviceId;\n\t\t}\n\n\t\tcase 3: {\n\t\t\t// Activation step - must have active device\n\t\t\treturn mfaState.deviceStatus === 'ACTIVE';\n\t\t}\n\n\t\tcase 4: {\n\t\t\t// Success step - final step\n\t\t\treturn true;\n\t\t}\n\n\t\tdefault: {\n\t\t\tconsole.warn(`${MODULE_TAG} Unknown step: ${currentStep}`);\n\t\t\treturn false;\n\t\t}\n\t}\n}\n\n// ============================================================================\n// HELPER FUNCTIONS\n// ============================================================================\n\n/**\n * Format field name for display in error messages\n *\n * @param fieldName - Field name (camelCase)\n * @returns Formatted field name (Title Case)\n *\n * @example\n * formatFieldName('phoneNumber') // \"Phone Number\"\n * formatFieldName('email') // \"Email\"\n */\nfunction formatFieldName(fieldName: string): string {\n\t// Special cases\n\tconst specialCases: Record<string, string> = {\n\t\tphoneNumber: 'Phone Number',\n\t\tcountryCode: 'Country Code',\n\t\tdeviceName: 'Device Name',\n\t\temail: 'Email Address',\n\t\tnickname: 'Nickname',\n\t};\n\n\tif (specialCases[fieldName]) {\n\t\treturn specialCases[fieldName];\n\t}\n\n\t// Convert camelCase to Title Case\n\treturn fieldName\n\t\t.replace(/([A-Z])/g, ' $1')\n\t\t.replace(/^./, (str) => str.toUpperCase())\n\t\t.trim();\n}\n\n/**\n * Combine multiple error objects into one\n *\n * @param errorObjects - Array of error objects\n * @returns Combined error object\n */\nexport function combineErrors(\n\t...errorObjects: Array<Record<string, string>>\n): Record<string, string> {\n\treturn errorObjects.reduce((combined, errors) => ({ ...combined, ...errors }), {});\n}\n\n/**\n * Convert error object to array of error messages\n *\n * @param errors - Error object (field name ‚Üí error message)\n * @returns Array of error messages\n */\nexport function errorsToArray(errors: Record<string, string>): string[] {\n\treturn Object.values(errors).filter((error) => !!error);\n}\n\n/**\n * Check if error object has any errors\n *\n * @param errors - Error object\n * @returns True if has errors\n */\nexport function hasErrors(errors: Record<string, string>): boolean {\n\treturn Object.keys(errors).length > 0;\n}\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/utils/unifiedFlowValidation.ts"},"span":[7798,7801],"sourceCode":"/**\n * @file unifiedFlowValidation.ts\n * @module v8/flows/unified/utils\n * @description Validation utilities for unified MFA registration flow\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Centralized validation logic for the unified flow:\n * - Required field validation\n * - Config-driven validation rules\n * - Step-specific validation\n * - Cross-field validation\n */\n\nimport type { DeviceFlowConfig, ValidationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFACredentials } from '@/v8/flows/shared/MFATypes';\n\nconst MODULE_TAG = '[‚úÖ UNIFIED-FLOW-VALIDATION]';\n\n// ============================================================================\n// FIELD VALIDATION\n// ============================================================================\n\n/**\n * Validate all required fields are present and non-empty\n *\n * @param config - Device flow configuration\n * @param values - Current field values\n * @returns Validation result with errors by field name\n *\n * @example\n * const result = validateRequiredFields(smsConfig, { phoneNumber: '', countryCode: '+1' });\n * // result = { valid: false, errors: { phoneNumber: 'Phone number is required' } }\n */\nexport function validateRequiredFields(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): { valid: boolean; errors: Record<string, string> } {\n\tconsole.log(`${MODULE_TAG} Validating required fields for ${config.deviceType}`);\n\n\tconst errors: Record<string, string> = {};\n\n\t// Check each required field\n\tconfig.requiredFields.forEach((fieldName) => {\n\t\tconst value = values[fieldName];\n\n\t\tif (!value || !value.trim()) {\n\t\t\terrors[fieldName] = `${formatFieldName(fieldName)} is required`;\n\t\t}\n\t});\n\n\tconst valid = Object.keys(errors).length === 0;\n\n\tconsole.log(`${MODULE_TAG} Required fields validation:`, {\n\t\tvalid,\n\t\terrorCount: Object.keys(errors).length,\n\t});\n\n\treturn { valid, errors };\n}\n\n/**\n * Run all validation rules from config\n *\n * @param config - Device flow configuration\n * @param values - Current field values\n * @returns Map of field name to validation result\n *\n * @example\n * const results = runValidationRules(smsConfig, { phoneNumber: '123' });\n * // results = { phoneNumber: { valid: false, error: 'Phone number must be at least 10 digits' } }\n */\nexport function runValidationRules(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): Record<string, ValidationResult> {\n\tconsole.log(`${MODULE_TAG} Running validation rules for ${config.deviceType}`);\n\n\tconst results: Record<string, ValidationResult> = {};\n\n\t// Run validation rules for each field that has a validator\n\tObject.entries(config.validationRules).forEach(([fieldName, validator]) => {\n\t\tconst value = values[fieldName] || '';\n\t\tresults[fieldName] = validator(value);\n\t});\n\n\treturn results;\n}\n\n/**\n * Validate all fields using config-driven rules\n *\n * @param config - Device flow configuration\n * @param values - Current field values\n * @returns Combined validation result\n */\nexport function validateAllFields(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): { valid: boolean; errors: Record<string, string>; warnings: Record<string, string> } {\n\tconsole.log(`${MODULE_TAG} Validating all fields for ${config.deviceType}`);\n\n\tconst errors: Record<string, string> = {};\n\tconst warnings: Record<string, string> = {};\n\n\t// Run validation rules\n\tconst validationResults = runValidationRules(config, values);\n\n\t// Extract errors and warnings\n\tObject.entries(validationResults).forEach(([fieldName, result]) => {\n\t\tif (!result.valid && result.error) {\n\t\t\terrors[fieldName] = result.error;\n\t\t}\n\t\tif (result.warning) {\n\t\t\twarnings[fieldName] = result.warning;\n\t\t}\n\t});\n\n\tconst valid = Object.keys(errors).length === 0;\n\n\tconsole.log(`${MODULE_TAG} All fields validation:`, {\n\t\tvalid,\n\t\terrorCount: Object.keys(errors).length,\n\t\twarningCount: Object.keys(warnings).length,\n\t});\n\n\treturn { valid, errors, warnings };\n}\n\n// ============================================================================\n// STEP-SPECIFIC VALIDATION\n// ============================================================================\n\n/**\n * Validate Step 0 (Configuration) credentials\n *\n * @param credentials - MFA credentials\n * @param tokenStatus - Token status information\n * @returns Validation result\n */\nexport function validateConfigurationStep(\n\tcredentials: MFACredentials,\n\ttokenStatus: { isValid: boolean; [key: string]: any }\n): { valid: boolean; errors: string[] } {\n\tconsole.log(`${MODULE_TAG} Validating configuration step`);\n\n\tconst errors: string[] = [];\n\n\t// Environment ID\n\tif (!credentials.environmentId?.trim()) {\n\t\terrors.push('Environment ID is required');\n\t}\n\n\t// Username\n\tif (!credentials.username?.trim()) {\n\t\terrors.push('Username is required');\n\t}\n\n\t// Device Authentication Policy ID\n\tif (!credentials.deviceAuthenticationPolicyId?.trim()) {\n\t\terrors.push('Device Authentication Policy ID is required');\n\t}\n\n\t// Token validation based on token type\n\tconst tokenType = credentials.tokenType || 'worker';\n\tconst isTokenValid =\n\t\ttokenType === 'worker' ? tokenStatus.isValid : !!credentials.userToken?.trim();\n\n\tif (!isTokenValid) {\n\t\terrors.push(`${tokenType === 'worker' ? 'Worker' : 'User'} token is required`);\n\t}\n\n\tconst valid = errors.length === 0;\n\n\tconsole.log(`${MODULE_TAG} Configuration validation:`, { valid, errorCount: errors.length });\n\n\treturn { valid, errors };\n}\n\n/**\n * Validate Step 2 (Registration) device fields\n *\n * @param config - Device flow configuration\n * @param values - Field values\n * @returns Validation result\n */\nexport function validateRegistrationStep(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): { valid: boolean; errors: Record<string, string> } {\n\tconsole.log(`${MODULE_TAG} Validating registration step for ${config.deviceType}`);\n\n\t// Validate using config-driven rules\n\tconst { valid, errors } = validateAllFields(config, values);\n\n\treturn { valid, errors };\n}\n\n/**\n * Validate Step 3 (Activation) OTP code\n *\n * @param otp - OTP code to validate\n * @returns Validation result\n */\nexport function validateActivationOTP(otp: string): { valid: boolean; error?: string } {\n\tconsole.log(`${MODULE_TAG} Validating OTP code`);\n\n\t// OTP must be exactly 6 digits\n\tif (!otp || otp.length !== 6) {\n\t\treturn { valid: false, error: 'OTP must be 6 digits' };\n\t}\n\n\t// OTP must contain only digits\n\tif (!/^\\d{6}$/.test(otp)) {\n\t\treturn { valid: false, error: 'OTP must contain only numbers' };\n\t}\n\n\treturn { valid: true };\n}\n\n// ============================================================================\n// CROSS-FIELD VALIDATION\n// ============================================================================\n\n/**\n * Validate WhatsApp fields (requires either phone or email)\n *\n * @param values - Field values\n * @returns Validation result\n */\nexport function validateWhatsAppFields(values: Record<string, string>): {\n\tvalid: boolean;\n\terrors: Record<string, string>;\n} {\n\tconst errors: Record<string, string> = {};\n\n\tconst hasPhone = !!values.phoneNumber?.trim();\n\tconst hasEmail = !!values.email?.trim();\n\n\t// WhatsApp requires either phone or email (or both)\n\tif (!hasPhone && !hasEmail) {\n\t\terrors.phoneNumber = 'Phone number or email is required';\n\t\terrors.email = 'Phone number or email is required';\n\t}\n\n\treturn {\n\t\tvalid: Object.keys(errors).length === 0,\n\t\terrors,\n\t};\n}\n\n/**\n * Check if can proceed to next step\n *\n * @param currentStep - Current step index (0-4)\n * @param config - Device flow configuration\n * @param credentials - MFA credentials\n * @param mfaState - Current MFA state\n * @param tokenStatus - Token status\n * @returns True if can proceed\n */\nexport function canProceedToNextStep(\n\tcurrentStep: number,\n\t_config: DeviceFlowConfig,\n\tcredentials: MFACredentials,\n\tmfaState: { deviceId?: string; deviceStatus?: string; [key: string]: any },\n\ttokenStatus: { isValid: boolean; [key: string]: any }\n): boolean {\n\tconsole.log(`${MODULE_TAG} Checking if can proceed from step ${currentStep}`);\n\n\tswitch (currentStep) {\n\t\tcase 0: {\n\t\t\t// Configuration step\n\t\t\tconst { valid } = validateConfigurationStep(credentials, tokenStatus);\n\t\t\treturn valid;\n\t\t}\n\n\t\tcase 1: {\n\t\t\t// Device selection step - always allow\n\t\t\treturn true;\n\t\t}\n\n\t\tcase 2: {\n\t\t\t// Registration step - must have device ID\n\t\t\treturn !!mfaState.deviceId;\n\t\t}\n\n\t\tcase 3: {\n\t\t\t// Activation step - must have active device\n\t\t\treturn mfaState.deviceStatus === 'ACTIVE';\n\t\t}\n\n\t\tcase 4: {\n\t\t\t// Success step - final step\n\t\t\treturn true;\n\t\t}\n\n\t\tdefault: {\n\t\t\tconsole.warn(`${MODULE_TAG} Unknown step: ${currentStep}`);\n\t\t\treturn false;\n\t\t}\n\t}\n}\n\n// ============================================================================\n// HELPER FUNCTIONS\n// ============================================================================\n\n/**\n * Format field name for display in error messages\n *\n * @param fieldName - Field name (camelCase)\n * @returns Formatted field name (Title Case)\n *\n * @example\n * formatFieldName('phoneNumber') // \"Phone Number\"\n * formatFieldName('email') // \"Email\"\n */\nfunction formatFieldName(fieldName: string): string {\n\t// Special cases\n\tconst specialCases: Record<string, string> = {\n\t\tphoneNumber: 'Phone Number',\n\t\tcountryCode: 'Country Code',\n\t\tdeviceName: 'Device Name',\n\t\temail: 'Email Address',\n\t\tnickname: 'Nickname',\n\t};\n\n\tif (specialCases[fieldName]) {\n\t\treturn specialCases[fieldName];\n\t}\n\n\t// Convert camelCase to Title Case\n\treturn fieldName\n\t\t.replace(/([A-Z])/g, ' $1')\n\t\t.replace(/^./, (str) => str.toUpperCase())\n\t\t.trim();\n}\n\n/**\n * Combine multiple error objects into one\n *\n * @param errorObjects - Array of error objects\n * @returns Combined error object\n */\nexport function combineErrors(\n\t...errorObjects: Array<Record<string, string>>\n): Record<string, string> {\n\treturn errorObjects.reduce((combined, errors) => ({ ...combined, ...errors }), {});\n}\n\n/**\n * Convert error object to array of error messages\n *\n * @param errors - Error object (field name ‚Üí error message)\n * @returns Array of error messages\n */\nexport function errorsToArray(errors: Record<string, string>): string[] {\n\treturn Object.values(errors).filter((error) => !!error);\n}\n\n/**\n * Check if error object has any errors\n *\n * @param errors - Error object\n * @returns True if has errors\n */\nexport function hasErrors(errors: Record<string, string>): boolean {\n\treturn Object.keys(errors).length > 0;\n}\n"},"tags":[],"source":null},{"category":"lint/suspicious/noExplicitAny","severity":"warning","description":"Unexpected any. Specify a different type.","message":[{"elements":[],"content":"Unexpected "},{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":". Specify a different type."}],"advices":{"advices":[{"log":["info",[{"elements":["Emphasis"],"content":"any"},{"elements":[],"content":" disables many type checking rules. Its use should be avoided."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/utils/unifiedFlowValidation.ts"},"span":[4395,4398],"sourceCode":"/**\n * @file unifiedFlowValidation.ts\n * @module v8/flows/unified/utils\n * @description Validation utilities for unified MFA registration flow\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Centralized validation logic for the unified flow:\n * - Required field validation\n * - Config-driven validation rules\n * - Step-specific validation\n * - Cross-field validation\n */\n\nimport type { DeviceFlowConfig, ValidationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFACredentials } from '@/v8/flows/shared/MFATypes';\n\nconst MODULE_TAG = '[‚úÖ UNIFIED-FLOW-VALIDATION]';\n\n// ============================================================================\n// FIELD VALIDATION\n// ============================================================================\n\n/**\n * Validate all required fields are present and non-empty\n *\n * @param config - Device flow configuration\n * @param values - Current field values\n * @returns Validation result with errors by field name\n *\n * @example\n * const result = validateRequiredFields(smsConfig, { phoneNumber: '', countryCode: '+1' });\n * // result = { valid: false, errors: { phoneNumber: 'Phone number is required' } }\n */\nexport function validateRequiredFields(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): { valid: boolean; errors: Record<string, string> } {\n\tconsole.log(`${MODULE_TAG} Validating required fields for ${config.deviceType}`);\n\n\tconst errors: Record<string, string> = {};\n\n\t// Check each required field\n\tconfig.requiredFields.forEach((fieldName) => {\n\t\tconst value = values[fieldName];\n\n\t\tif (!value || !value.trim()) {\n\t\t\terrors[fieldName] = `${formatFieldName(fieldName)} is required`;\n\t\t}\n\t});\n\n\tconst valid = Object.keys(errors).length === 0;\n\n\tconsole.log(`${MODULE_TAG} Required fields validation:`, {\n\t\tvalid,\n\t\terrorCount: Object.keys(errors).length,\n\t});\n\n\treturn { valid, errors };\n}\n\n/**\n * Run all validation rules from config\n *\n * @param config - Device flow configuration\n * @param values - Current field values\n * @returns Map of field name to validation result\n *\n * @example\n * const results = runValidationRules(smsConfig, { phoneNumber: '123' });\n * // results = { phoneNumber: { valid: false, error: 'Phone number must be at least 10 digits' } }\n */\nexport function runValidationRules(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): Record<string, ValidationResult> {\n\tconsole.log(`${MODULE_TAG} Running validation rules for ${config.deviceType}`);\n\n\tconst results: Record<string, ValidationResult> = {};\n\n\t// Run validation rules for each field that has a validator\n\tObject.entries(config.validationRules).forEach(([fieldName, validator]) => {\n\t\tconst value = values[fieldName] || '';\n\t\tresults[fieldName] = validator(value);\n\t});\n\n\treturn results;\n}\n\n/**\n * Validate all fields using config-driven rules\n *\n * @param config - Device flow configuration\n * @param values - Current field values\n * @returns Combined validation result\n */\nexport function validateAllFields(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): { valid: boolean; errors: Record<string, string>; warnings: Record<string, string> } {\n\tconsole.log(`${MODULE_TAG} Validating all fields for ${config.deviceType}`);\n\n\tconst errors: Record<string, string> = {};\n\tconst warnings: Record<string, string> = {};\n\n\t// Run validation rules\n\tconst validationResults = runValidationRules(config, values);\n\n\t// Extract errors and warnings\n\tObject.entries(validationResults).forEach(([fieldName, result]) => {\n\t\tif (!result.valid && result.error) {\n\t\t\terrors[fieldName] = result.error;\n\t\t}\n\t\tif (result.warning) {\n\t\t\twarnings[fieldName] = result.warning;\n\t\t}\n\t});\n\n\tconst valid = Object.keys(errors).length === 0;\n\n\tconsole.log(`${MODULE_TAG} All fields validation:`, {\n\t\tvalid,\n\t\terrorCount: Object.keys(errors).length,\n\t\twarningCount: Object.keys(warnings).length,\n\t});\n\n\treturn { valid, errors, warnings };\n}\n\n// ============================================================================\n// STEP-SPECIFIC VALIDATION\n// ============================================================================\n\n/**\n * Validate Step 0 (Configuration) credentials\n *\n * @param credentials - MFA credentials\n * @param tokenStatus - Token status information\n * @returns Validation result\n */\nexport function validateConfigurationStep(\n\tcredentials: MFACredentials,\n\ttokenStatus: { isValid: boolean; [key: string]: any }\n): { valid: boolean; errors: string[] } {\n\tconsole.log(`${MODULE_TAG} Validating configuration step`);\n\n\tconst errors: string[] = [];\n\n\t// Environment ID\n\tif (!credentials.environmentId?.trim()) {\n\t\terrors.push('Environment ID is required');\n\t}\n\n\t// Username\n\tif (!credentials.username?.trim()) {\n\t\terrors.push('Username is required');\n\t}\n\n\t// Device Authentication Policy ID\n\tif (!credentials.deviceAuthenticationPolicyId?.trim()) {\n\t\terrors.push('Device Authentication Policy ID is required');\n\t}\n\n\t// Token validation based on token type\n\tconst tokenType = credentials.tokenType || 'worker';\n\tconst isTokenValid =\n\t\ttokenType === 'worker' ? tokenStatus.isValid : !!credentials.userToken?.trim();\n\n\tif (!isTokenValid) {\n\t\terrors.push(`${tokenType === 'worker' ? 'Worker' : 'User'} token is required`);\n\t}\n\n\tconst valid = errors.length === 0;\n\n\tconsole.log(`${MODULE_TAG} Configuration validation:`, { valid, errorCount: errors.length });\n\n\treturn { valid, errors };\n}\n\n/**\n * Validate Step 2 (Registration) device fields\n *\n * @param config - Device flow configuration\n * @param values - Field values\n * @returns Validation result\n */\nexport function validateRegistrationStep(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): { valid: boolean; errors: Record<string, string> } {\n\tconsole.log(`${MODULE_TAG} Validating registration step for ${config.deviceType}`);\n\n\t// Validate using config-driven rules\n\tconst { valid, errors } = validateAllFields(config, values);\n\n\treturn { valid, errors };\n}\n\n/**\n * Validate Step 3 (Activation) OTP code\n *\n * @param otp - OTP code to validate\n * @returns Validation result\n */\nexport function validateActivationOTP(otp: string): { valid: boolean; error?: string } {\n\tconsole.log(`${MODULE_TAG} Validating OTP code`);\n\n\t// OTP must be exactly 6 digits\n\tif (!otp || otp.length !== 6) {\n\t\treturn { valid: false, error: 'OTP must be 6 digits' };\n\t}\n\n\t// OTP must contain only digits\n\tif (!/^\\d{6}$/.test(otp)) {\n\t\treturn { valid: false, error: 'OTP must contain only numbers' };\n\t}\n\n\treturn { valid: true };\n}\n\n// ============================================================================\n// CROSS-FIELD VALIDATION\n// ============================================================================\n\n/**\n * Validate WhatsApp fields (requires either phone or email)\n *\n * @param values - Field values\n * @returns Validation result\n */\nexport function validateWhatsAppFields(values: Record<string, string>): {\n\tvalid: boolean;\n\terrors: Record<string, string>;\n} {\n\tconst errors: Record<string, string> = {};\n\n\tconst hasPhone = !!values.phoneNumber?.trim();\n\tconst hasEmail = !!values.email?.trim();\n\n\t// WhatsApp requires either phone or email (or both)\n\tif (!hasPhone && !hasEmail) {\n\t\terrors.phoneNumber = 'Phone number or email is required';\n\t\terrors.email = 'Phone number or email is required';\n\t}\n\n\treturn {\n\t\tvalid: Object.keys(errors).length === 0,\n\t\terrors,\n\t};\n}\n\n/**\n * Check if can proceed to next step\n *\n * @param currentStep - Current step index (0-4)\n * @param config - Device flow configuration\n * @param credentials - MFA credentials\n * @param mfaState - Current MFA state\n * @param tokenStatus - Token status\n * @returns True if can proceed\n */\nexport function canProceedToNextStep(\n\tcurrentStep: number,\n\t_config: DeviceFlowConfig,\n\tcredentials: MFACredentials,\n\tmfaState: { deviceId?: string; deviceStatus?: string; [key: string]: any },\n\ttokenStatus: { isValid: boolean; [key: string]: any }\n): boolean {\n\tconsole.log(`${MODULE_TAG} Checking if can proceed from step ${currentStep}`);\n\n\tswitch (currentStep) {\n\t\tcase 0: {\n\t\t\t// Configuration step\n\t\t\tconst { valid } = validateConfigurationStep(credentials, tokenStatus);\n\t\t\treturn valid;\n\t\t}\n\n\t\tcase 1: {\n\t\t\t// Device selection step - always allow\n\t\t\treturn true;\n\t\t}\n\n\t\tcase 2: {\n\t\t\t// Registration step - must have device ID\n\t\t\treturn !!mfaState.deviceId;\n\t\t}\n\n\t\tcase 3: {\n\t\t\t// Activation step - must have active device\n\t\t\treturn mfaState.deviceStatus === 'ACTIVE';\n\t\t}\n\n\t\tcase 4: {\n\t\t\t// Success step - final step\n\t\t\treturn true;\n\t\t}\n\n\t\tdefault: {\n\t\t\tconsole.warn(`${MODULE_TAG} Unknown step: ${currentStep}`);\n\t\t\treturn false;\n\t\t}\n\t}\n}\n\n// ============================================================================\n// HELPER FUNCTIONS\n// ============================================================================\n\n/**\n * Format field name for display in error messages\n *\n * @param fieldName - Field name (camelCase)\n * @returns Formatted field name (Title Case)\n *\n * @example\n * formatFieldName('phoneNumber') // \"Phone Number\"\n * formatFieldName('email') // \"Email\"\n */\nfunction formatFieldName(fieldName: string): string {\n\t// Special cases\n\tconst specialCases: Record<string, string> = {\n\t\tphoneNumber: 'Phone Number',\n\t\tcountryCode: 'Country Code',\n\t\tdeviceName: 'Device Name',\n\t\temail: 'Email Address',\n\t\tnickname: 'Nickname',\n\t};\n\n\tif (specialCases[fieldName]) {\n\t\treturn specialCases[fieldName];\n\t}\n\n\t// Convert camelCase to Title Case\n\treturn fieldName\n\t\t.replace(/([A-Z])/g, ' $1')\n\t\t.replace(/^./, (str) => str.toUpperCase())\n\t\t.trim();\n}\n\n/**\n * Combine multiple error objects into one\n *\n * @param errorObjects - Array of error objects\n * @returns Combined error object\n */\nexport function combineErrors(\n\t...errorObjects: Array<Record<string, string>>\n): Record<string, string> {\n\treturn errorObjects.reduce((combined, errors) => ({ ...combined, ...errors }), {});\n}\n\n/**\n * Convert error object to array of error messages\n *\n * @param errors - Error object (field name ‚Üí error message)\n * @returns Array of error messages\n */\nexport function errorsToArray(errors: Record<string, string>): string[] {\n\treturn Object.values(errors).filter((error) => !!error);\n}\n\n/**\n * Check if error object has any errors\n *\n * @param errors - Error object\n * @returns True if has errors\n */\nexport function hasErrors(errors: Record<string, string>): boolean {\n\treturn Object.keys(errors).length > 0;\n}\n"},"tags":[],"source":null},{"category":"lint/performance/noAccumulatingSpread","severity":"warning","description":"Avoid the use of spread (`...`) syntax on accumulators.","message":[{"elements":[],"content":"Avoid the use of spread (`...`) syntax on accumulators."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Spread syntax should be avoided on accumulators (like those in `.reduce`) because it causes a time complexity of `O(n^2)`."}]]},{"log":["info",[{"elements":[],"content":"Consider methods such as .splice or .push instead."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/utils/unifiedFlowValidation.ts"},"span":[9775,9786],"sourceCode":"/**\n * @file unifiedFlowValidation.ts\n * @module v8/flows/unified/utils\n * @description Validation utilities for unified MFA registration flow\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Centralized validation logic for the unified flow:\n * - Required field validation\n * - Config-driven validation rules\n * - Step-specific validation\n * - Cross-field validation\n */\n\nimport type { DeviceFlowConfig, ValidationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFACredentials } from '@/v8/flows/shared/MFATypes';\n\nconst MODULE_TAG = '[‚úÖ UNIFIED-FLOW-VALIDATION]';\n\n// ============================================================================\n// FIELD VALIDATION\n// ============================================================================\n\n/**\n * Validate all required fields are present and non-empty\n *\n * @param config - Device flow configuration\n * @param values - Current field values\n * @returns Validation result with errors by field name\n *\n * @example\n * const result = validateRequiredFields(smsConfig, { phoneNumber: '', countryCode: '+1' });\n * // result = { valid: false, errors: { phoneNumber: 'Phone number is required' } }\n */\nexport function validateRequiredFields(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): { valid: boolean; errors: Record<string, string> } {\n\tconsole.log(`${MODULE_TAG} Validating required fields for ${config.deviceType}`);\n\n\tconst errors: Record<string, string> = {};\n\n\t// Check each required field\n\tconfig.requiredFields.forEach((fieldName) => {\n\t\tconst value = values[fieldName];\n\n\t\tif (!value || !value.trim()) {\n\t\t\terrors[fieldName] = `${formatFieldName(fieldName)} is required`;\n\t\t}\n\t});\n\n\tconst valid = Object.keys(errors).length === 0;\n\n\tconsole.log(`${MODULE_TAG} Required fields validation:`, {\n\t\tvalid,\n\t\terrorCount: Object.keys(errors).length,\n\t});\n\n\treturn { valid, errors };\n}\n\n/**\n * Run all validation rules from config\n *\n * @param config - Device flow configuration\n * @param values - Current field values\n * @returns Map of field name to validation result\n *\n * @example\n * const results = runValidationRules(smsConfig, { phoneNumber: '123' });\n * // results = { phoneNumber: { valid: false, error: 'Phone number must be at least 10 digits' } }\n */\nexport function runValidationRules(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): Record<string, ValidationResult> {\n\tconsole.log(`${MODULE_TAG} Running validation rules for ${config.deviceType}`);\n\n\tconst results: Record<string, ValidationResult> = {};\n\n\t// Run validation rules for each field that has a validator\n\tObject.entries(config.validationRules).forEach(([fieldName, validator]) => {\n\t\tconst value = values[fieldName] || '';\n\t\tresults[fieldName] = validator(value);\n\t});\n\n\treturn results;\n}\n\n/**\n * Validate all fields using config-driven rules\n *\n * @param config - Device flow configuration\n * @param values - Current field values\n * @returns Combined validation result\n */\nexport function validateAllFields(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): { valid: boolean; errors: Record<string, string>; warnings: Record<string, string> } {\n\tconsole.log(`${MODULE_TAG} Validating all fields for ${config.deviceType}`);\n\n\tconst errors: Record<string, string> = {};\n\tconst warnings: Record<string, string> = {};\n\n\t// Run validation rules\n\tconst validationResults = runValidationRules(config, values);\n\n\t// Extract errors and warnings\n\tObject.entries(validationResults).forEach(([fieldName, result]) => {\n\t\tif (!result.valid && result.error) {\n\t\t\terrors[fieldName] = result.error;\n\t\t}\n\t\tif (result.warning) {\n\t\t\twarnings[fieldName] = result.warning;\n\t\t}\n\t});\n\n\tconst valid = Object.keys(errors).length === 0;\n\n\tconsole.log(`${MODULE_TAG} All fields validation:`, {\n\t\tvalid,\n\t\terrorCount: Object.keys(errors).length,\n\t\twarningCount: Object.keys(warnings).length,\n\t});\n\n\treturn { valid, errors, warnings };\n}\n\n// ============================================================================\n// STEP-SPECIFIC VALIDATION\n// ============================================================================\n\n/**\n * Validate Step 0 (Configuration) credentials\n *\n * @param credentials - MFA credentials\n * @param tokenStatus - Token status information\n * @returns Validation result\n */\nexport function validateConfigurationStep(\n\tcredentials: MFACredentials,\n\ttokenStatus: { isValid: boolean; [key: string]: any }\n): { valid: boolean; errors: string[] } {\n\tconsole.log(`${MODULE_TAG} Validating configuration step`);\n\n\tconst errors: string[] = [];\n\n\t// Environment ID\n\tif (!credentials.environmentId?.trim()) {\n\t\terrors.push('Environment ID is required');\n\t}\n\n\t// Username\n\tif (!credentials.username?.trim()) {\n\t\terrors.push('Username is required');\n\t}\n\n\t// Device Authentication Policy ID\n\tif (!credentials.deviceAuthenticationPolicyId?.trim()) {\n\t\terrors.push('Device Authentication Policy ID is required');\n\t}\n\n\t// Token validation based on token type\n\tconst tokenType = credentials.tokenType || 'worker';\n\tconst isTokenValid =\n\t\ttokenType === 'worker' ? tokenStatus.isValid : !!credentials.userToken?.trim();\n\n\tif (!isTokenValid) {\n\t\terrors.push(`${tokenType === 'worker' ? 'Worker' : 'User'} token is required`);\n\t}\n\n\tconst valid = errors.length === 0;\n\n\tconsole.log(`${MODULE_TAG} Configuration validation:`, { valid, errorCount: errors.length });\n\n\treturn { valid, errors };\n}\n\n/**\n * Validate Step 2 (Registration) device fields\n *\n * @param config - Device flow configuration\n * @param values - Field values\n * @returns Validation result\n */\nexport function validateRegistrationStep(\n\tconfig: DeviceFlowConfig,\n\tvalues: Record<string, string>\n): { valid: boolean; errors: Record<string, string> } {\n\tconsole.log(`${MODULE_TAG} Validating registration step for ${config.deviceType}`);\n\n\t// Validate using config-driven rules\n\tconst { valid, errors } = validateAllFields(config, values);\n\n\treturn { valid, errors };\n}\n\n/**\n * Validate Step 3 (Activation) OTP code\n *\n * @param otp - OTP code to validate\n * @returns Validation result\n */\nexport function validateActivationOTP(otp: string): { valid: boolean; error?: string } {\n\tconsole.log(`${MODULE_TAG} Validating OTP code`);\n\n\t// OTP must be exactly 6 digits\n\tif (!otp || otp.length !== 6) {\n\t\treturn { valid: false, error: 'OTP must be 6 digits' };\n\t}\n\n\t// OTP must contain only digits\n\tif (!/^\\d{6}$/.test(otp)) {\n\t\treturn { valid: false, error: 'OTP must contain only numbers' };\n\t}\n\n\treturn { valid: true };\n}\n\n// ============================================================================\n// CROSS-FIELD VALIDATION\n// ============================================================================\n\n/**\n * Validate WhatsApp fields (requires either phone or email)\n *\n * @param values - Field values\n * @returns Validation result\n */\nexport function validateWhatsAppFields(values: Record<string, string>): {\n\tvalid: boolean;\n\terrors: Record<string, string>;\n} {\n\tconst errors: Record<string, string> = {};\n\n\tconst hasPhone = !!values.phoneNumber?.trim();\n\tconst hasEmail = !!values.email?.trim();\n\n\t// WhatsApp requires either phone or email (or both)\n\tif (!hasPhone && !hasEmail) {\n\t\terrors.phoneNumber = 'Phone number or email is required';\n\t\terrors.email = 'Phone number or email is required';\n\t}\n\n\treturn {\n\t\tvalid: Object.keys(errors).length === 0,\n\t\terrors,\n\t};\n}\n\n/**\n * Check if can proceed to next step\n *\n * @param currentStep - Current step index (0-4)\n * @param config - Device flow configuration\n * @param credentials - MFA credentials\n * @param mfaState - Current MFA state\n * @param tokenStatus - Token status\n * @returns True if can proceed\n */\nexport function canProceedToNextStep(\n\tcurrentStep: number,\n\t_config: DeviceFlowConfig,\n\tcredentials: MFACredentials,\n\tmfaState: { deviceId?: string; deviceStatus?: string; [key: string]: any },\n\ttokenStatus: { isValid: boolean; [key: string]: any }\n): boolean {\n\tconsole.log(`${MODULE_TAG} Checking if can proceed from step ${currentStep}`);\n\n\tswitch (currentStep) {\n\t\tcase 0: {\n\t\t\t// Configuration step\n\t\t\tconst { valid } = validateConfigurationStep(credentials, tokenStatus);\n\t\t\treturn valid;\n\t\t}\n\n\t\tcase 1: {\n\t\t\t// Device selection step - always allow\n\t\t\treturn true;\n\t\t}\n\n\t\tcase 2: {\n\t\t\t// Registration step - must have device ID\n\t\t\treturn !!mfaState.deviceId;\n\t\t}\n\n\t\tcase 3: {\n\t\t\t// Activation step - must have active device\n\t\t\treturn mfaState.deviceStatus === 'ACTIVE';\n\t\t}\n\n\t\tcase 4: {\n\t\t\t// Success step - final step\n\t\t\treturn true;\n\t\t}\n\n\t\tdefault: {\n\t\t\tconsole.warn(`${MODULE_TAG} Unknown step: ${currentStep}`);\n\t\t\treturn false;\n\t\t}\n\t}\n}\n\n// ============================================================================\n// HELPER FUNCTIONS\n// ============================================================================\n\n/**\n * Format field name for display in error messages\n *\n * @param fieldName - Field name (camelCase)\n * @returns Formatted field name (Title Case)\n *\n * @example\n * formatFieldName('phoneNumber') // \"Phone Number\"\n * formatFieldName('email') // \"Email\"\n */\nfunction formatFieldName(fieldName: string): string {\n\t// Special cases\n\tconst specialCases: Record<string, string> = {\n\t\tphoneNumber: 'Phone Number',\n\t\tcountryCode: 'Country Code',\n\t\tdeviceName: 'Device Name',\n\t\temail: 'Email Address',\n\t\tnickname: 'Nickname',\n\t};\n\n\tif (specialCases[fieldName]) {\n\t\treturn specialCases[fieldName];\n\t}\n\n\t// Convert camelCase to Title Case\n\treturn fieldName\n\t\t.replace(/([A-Z])/g, ' $1')\n\t\t.replace(/^./, (str) => str.toUpperCase())\n\t\t.trim();\n}\n\n/**\n * Combine multiple error objects into one\n *\n * @param errorObjects - Array of error objects\n * @returns Combined error object\n */\nexport function combineErrors(\n\t...errorObjects: Array<Record<string, string>>\n): Record<string, string> {\n\treturn errorObjects.reduce((combined, errors) => ({ ...combined, ...errors }), {});\n}\n\n/**\n * Convert error object to array of error messages\n *\n * @param errors - Error object (field name ‚Üí error message)\n * @returns Array of error messages\n */\nexport function errorsToArray(errors: Record<string, string>): string[] {\n\treturn Object.values(errors).filter((error) => !!error);\n}\n\n/**\n * Check if error object has any errors\n *\n * @param errors - Error object\n * @returns True if has errors\n */\nexport function hasErrors(errors: Record<string, string>): boolean {\n\treturn Object.keys(errors).length > 0;\n}\n"},"tags":[],"source":null},{"category":"assist/source/organizeImports","severity":"error","description":"The imports and exports are not sorted.","message":[{"elements":[],"content":"The imports and exports are not sorted."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Safe fix: Organize Imports (Biome)"}]]},{"diff":{"dictionary":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unifiedimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport type { TokenStatusInfo } from '@/v8/services/workerTokenStatusServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { ReturnTargetServiceV8UtoastV8 } from '@/v8uservicesutilsreturnTargetServiceV8UtoastNotificationsV8';\nimport { type MFAFlowBaseRenderProps, MFAFlowBaseV8 } from '../shared/MFAFlowBaseV8';\nimport type { DeviceAuthenticationPolicy, MFACredentials, MFAState } from '../shared/MFATypes';\nexport default UnifiedMFARegistrationFlowV8;\n","ops":[{"diffOp":{"equal":{"range":[0,73]}}},{"equalLines":{"line_count":48}},{"diffOp":{"equal":{"range":[73,307]}}},{"diffOp":{"equal":{"range":[307,317]}}},{"diffOp":{"delete":{"range":[317,339]}}},{"diffOp":{"insert":{"range":[339,346]}}},{"diffOp":{"equal":{"range":[346,357]}}},{"diffOp":{"delete":{"range":[357,360]}}},{"diffOp":{"insert":{"range":[357,359]}}},{"diffOp":{"equal":{"range":[0,1]}}},{"diffOp":{"delete":{"range":[360,368]}}},{"diffOp":{"insert":{"range":[368,373]}}},{"diffOp":{"equal":{"range":[0,1]}}},{"diffOp":{"delete":{"range":[373,395]}}},{"diffOp":{"insert":{"range":[395,415]}}},{"diffOp":{"equal":{"range":[415,417]}}},{"diffOp":{"equal":{"range":[307,317]}}},{"diffOp":{"delete":{"range":[339,346]}}},{"diffOp":{"insert":{"range":[317,339]}}},{"diffOp":{"equal":{"range":[346,357]}}},{"diffOp":{"delete":{"range":[357,359]}}},{"diffOp":{"insert":{"range":[357,360]}}},{"diffOp":{"equal":{"range":[0,1]}}},{"diffOp":{"delete":{"range":[368,373]}}},{"diffOp":{"insert":{"range":[360,368]}}},{"diffOp":{"equal":{"range":[0,1]}}},{"diffOp":{"delete":{"range":[395,415]}}},{"diffOp":{"insert":{"range":[373,395]}}},{"diffOp":{"equal":{"range":[415,417]}}},{"diffOp":{"equal":{"range":[417,599]}}},{"equalLines":{"line_count":2806}},{"diffOp":{"equal":{"range":[599,645]}}}]}}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/UnifiedMFARegistrationFlowV8_Legacy.tsx"},"span":[885,916],"sourceCode":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\n * @description Unified MFA Registration Flow - Single component for all 6 device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Replace 6 device-specific flow components (SMS, Email, Mobile, WhatsApp, TOTP, FIDO2)\n * with a single configurable component using deviceFlowConfigs for device-specific behavior.\n *\n * Architecture:\n * - Configuration-driven using deviceFlowConfigs.ts\n * - Dynamic form rendering for simple devices (SMS, Email, WhatsApp)\n * - Custom components for complex devices (TOTP, FIDO2, Mobile)\n * - Integrates with MFACredentialContext and useWorkerToken hook\n * - Uses existing MFAFlowBaseV8 for 5-step framework\n *\n * @example\n * <UnifiedMFARegistrationFlowV8\n *   deviceType=\"SMS\"\n *   onSuccess={(result) => console.log('Device registered:', result.deviceId)}\n * />\n */\n\nimport * as React from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { FiChevronDown, FiChevronUp } from 'react-icons/fi';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { MFAHeaderV8 } from '@/v8/components/MFAHeaderV8';\nimport type { SearchableDropdownOption } from '@/v8/components/SearchableDropdownV8';\nimport { SearchableDropdownV8 } from '@/v8/components/SearchableDropdownV8';\nimport { SQLiteStatsDisplayV8 } from '@/v8/components/SQLiteStatsDisplayV8';\nimport { SuperSimpleApiDisplayV8 } from '@/v8/components/SuperSimpleApiDisplayV8';\nimport { UserLoginModalV8 } from '@/v8/components/UserLoginModalV8';\nimport { getDeviceConfig } from '@/v8/config/deviceFlowConfigs';\nimport type { DeviceConfigKey, DeviceRegistrationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport { PING_IDENTITY_COLORS } from '@/v8/constants/pingIdentityColors';\nimport { GlobalMFAProvider } from '@/v8/contexts/GlobalMFAContext';\nimport { MFACredentialProvider } from '@/v8/contexts/MFACredentialContext';\nimport { APIDocsStepV8 } from '@/v8/flows/shared/APIDocsStepV8';\nimport { SuccessStepV8 } from '@/v8/flows/shared/SuccessStepV8';\nimport { UserLoginStepV8 } from '@/v8/flows/shared/UserLoginStepV8';\nimport { useMFAPolicies } from '@/v8/hooks/useMFAPolicies';\nimport { useStepNavigationV8 } from '@/v8/hooks/useStepNavigationV8';\nimport { useUserSearch } from '@/v8/hooks/useUserSearch';\nimport { useWorkerToken } from '@/v8/hooks/useWorkerToken';\nimport { CredentialsServiceV8 } from '@/v8/services/credentialsServiceV8';\nimport { globalEnvironmentService } from '@/v8/services/globalEnvironmentService';\nimport { MfaAuthenticationServiceV8 } from '@/v8/services/mfaAuthenticationServiceV8';\nimport { type MFAFeatureFlag, MFAFeatureFlagsV8 } from '@/v8/services/mfaFeatureFlagsV8';\nimport MFAServiceV8_Legacy, { type RegisterDeviceParams } from '@/v8/services/mfaServiceV8_Legacy';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport type { TokenStatusInfo } from '@/v8/services/workerTokenStatusServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { ReturnTargetServiceV8U } from '@/v8u/services/returnTargetServiceV8U';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type MFAFlowBaseRenderProps, MFAFlowBaseV8 } from '../shared/MFAFlowBaseV8';\nimport type { DeviceAuthenticationPolicy, MFACredentials, MFAState } from '../shared/MFATypes';\nimport { UnifiedActivationStep } from './components/UnifiedActivationStep';\nimport { UnifiedDeviceRegistrationForm } from './components/UnifiedDeviceRegistrationForm';\nimport { UnifiedDeviceSelectionModal } from './components/UnifiedDeviceSelectionModal';\nimport { UnifiedSuccessStep } from './components/UnifiedSuccessStep';\nimport './UnifiedMFAFlow.css';\n\nconst MODULE_TAG = '[üîÑ UNIFIED-MFA-FLOW-V8]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedMFARegistrationFlowV8Props {\n\t/** Device type to render (optional - can be provided via navigation state) */\n\tdeviceType?: DeviceConfigKey;\n\n\t/** Optional initial credentials (for pre-filled forms) */\n\tinitialCredentials?: Partial<MFACredentials>;\n\n\t/** Optional callback when registration succeeds */\n\tonSuccess?: (result: DeviceRegistrationResult) => void;\n\n\t/** Optional callback when user cancels flow */\n\tonCancel?: () => void;\n\n\t/** Optional initial step (defaults to 0) */\n\tinitialStep?: number;\n\n\t/** Optional: Skip configuration step if already configured */\n\tskipConfiguration?: boolean;\n\n\t/** Optional: Force specific registration flow type */\n\tregistrationFlowType?: 'admin-active' | 'admin-activation' | 'user';\n}\n\n// ============================================================================\n// MFA FLOW SELECTION SCREEN\n// ============================================================================\n\ntype FlowMode = 'registration' | 'authentication';\n\n/** Map device types to their feature flags */\nconst DEVICE_FLAG_MAP: Record<DeviceConfigKey, MFAFeatureFlag> = {\n\tSMS: 'mfa_unified_sms',\n\tEMAIL: 'mfa_unified_email',\n\tMOBILE: 'mfa_unified_mobile',\n\tWHATSAPP: 'mfa_unified_whatsapp',\n\tTOTP: 'mfa_unified_totp',\n\tFIDO2: 'mfa_unified_fido2',\n};\n\nconst DEVICE_TYPES: { key: DeviceConfigKey; icon: string; name: string; description: string }[] = [\n\t{ key: 'SMS', icon: 'üì±', name: 'SMS', description: 'Receive OTP codes via text message' },\n\t{ key: 'EMAIL', icon: '‚úâÔ∏è', name: 'Email', description: 'Receive OTP codes via email' },\n\t{\n\t\tkey: 'TOTP',\n\t\ticon: 'üîê',\n\t\tname: 'Authenticator App (TOTP)',\n\t\tdescription: 'Use Google Authenticator, Authy, or similar',\n\t},\n\t{\n\t\tkey: 'MOBILE',\n\t\ticon: 'üì≤',\n\t\tname: 'Mobile Push',\n\t\tdescription: 'Receive push notifications on your phone',\n\t},\n\t{ key: 'WHATSAPP', icon: 'üí¨', name: 'WhatsApp', description: 'Receive OTP codes via WhatsApp' },\n\t{\n\t\tkey: 'FIDO2',\n\t\ticon: 'üîë',\n\t\tname: 'Security Key (FIDO2)',\n\t\tdescription: 'Use a hardware security key or passkey',\n\t},\n];\n\n/** Check if a device type is enabled via feature flags */\nconst isDeviceEnabled = (deviceKey: DeviceConfigKey): boolean => {\n\tconst flag = DEVICE_FLAG_MAP[deviceKey];\n\treturn MFAFeatureFlagsV8.isEnabled(flag);\n};\n\ninterface DeviceTypeSelectionScreenProps {\n\tonSelectDeviceType: (deviceType: DeviceConfigKey) => void;\n\tuserToken?: string | null;\n\tsetUserToken: (token: string | null) => void;\n}\n\nconst DeviceTypeSelectionScreen: React.FC<DeviceTypeSelectionScreenProps> = ({\n\tonSelectDeviceType,\n\tuserToken,\n\tsetUserToken,\n}) => {\n\tconst [flowMode, setFlowMode] = useState<FlowMode | null>(null);\n\tconst [environmentId, setEnvironmentId] = useState('');\n\tconst [username, setUsername] = useState('');\n\tconst [showDeviceSelectionModal, setShowDeviceSelectionModal] = useState(false);\n\tconst [showOTPModal, setShowOTPModal] = useState(false);\n\tconst [otpCode, setOtpCode] = useState('');\n\tconst [authenticationId, setAuthenticationId] = useState<string | null>(null);\n\tconst [selectedAuthDevice, setSelectedAuthDevice] = useState<{\n\t\tid: string;\n\t\ttype: string;\n\t\tnickname?: string;\n\t} | null>(null);\n\tconst [customLogoUrl, setCustomLogoUrl] = useState<string>('');\n\tconst [showAuthLoginModal, setShowAuthLoginModal] = useState(false);\n\tconst authEnvIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Load uploaded logo from localStorage on mount\n\tuseEffect(() => {\n\t\ttry {\n\t\t\tconst savedUpload = localStorage.getItem('custom-logo-upload');\n\t\t\tif (savedUpload) {\n\t\t\t\tconst uploadData = JSON.parse(savedUpload);\n\t\t\t\t// Handle both old format (objectUrl) and new format (base64Url)\n\t\t\t\tif (uploadData.base64Url) {\n\t\t\t\t\tsetCustomLogoUrl(uploadData.base64Url);\n\t\t\t\t} else if (uploadData.objectUrl) {\n\t\t\t\t\t// Old format - try to convert if possible, otherwise clear it\n\t\t\t\t\tconsole.warn('Old logo format detected - please re-upload your logo');\n\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load uploaded logo from localStorage:', error);\n\t\t\t// Clear corrupted data\n\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t}\n\t}, []);\n\n\t// Use worker token hook for token management\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Extract environment ID from worker token when available\n\tuseEffect(() => {\n\t\tconst extractEnvironmentId = async () => {\n\t\t\ttry {\n\t\t\t\tconst token = await workerTokenServiceV8.getToken();\n\t\t\t\tif (token && !environmentId) {\n\t\t\t\t\tconst parts = token.split('.');\n\t\t\t\t\tif (parts.length === 3) {\n\t\t\t\t\t\tconst payload = JSON.parse(atob(parts[1]));\n\t\t\t\t\t\tif (payload.environmentId) {\n\t\t\t\t\t\t\tsetEnvironmentId(payload.environmentId);\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`${MODULE_TAG} Environment ID extracted from worker token:`,\n\t\t\t\t\t\t\t\tpayload.environmentId\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Failed to extract environment ID from worker token:`, error);\n\t\t\t}\n\t\t};\n\n\t\textractEnvironmentId();\n\t}, [environmentId]);\n\n\tconst hasWorkerToken = workerToken.tokenStatus.isValid;\n\n\t// Use user search hook for user fetching and search\n\tconst {\n\t\tusers,\n\t\tisLoading: isLoadingUsers,\n\t\tsetSearchQuery,\n\t} = useUserSearch({\n\t\tenvironmentId,\n\t\ttokenValid: workerToken.tokenStatus.isValid,\n\t\tmaxPages: 100,\n\t\tuseCache: true,\n\t});\n\tconst tokenStatus = workerToken.tokenStatus;\n\n\t// Debug: Log users type to understand the issue\n\tuseEffect(() => {\n\t\tconsole.log(`${MODULE_TAG} users type check:`, {\n\t\t\tusers,\n\t\t\tisArray: Array.isArray(users),\n\t\t\ttype: typeof users,\n\t\t\tconstructor: users?.constructor?.name,\n\t\t});\n\t}, [users]);\n\n\t// Load Environment ID and username from global services on mount\n\tuseEffect(() => {\n\t\t// Initialize the service first to load from localStorage\n\t\tglobalEnvironmentService.initialize();\n\t\tconst savedEnvId = globalEnvironmentService.getEnvironmentId();\n\t\tif (savedEnvId) {\n\t\t\tsetEnvironmentId(savedEnvId);\n\t\t}\n\n\t\t// Load username from localStorage\n\t\tconst savedUsername = localStorage.getItem('mfa_unified_username');\n\t\tif (savedUsername) {\n\t\t\tsetUsername(savedUsername);\n\t\t}\n\t}, []);\n\n\t// Use MFA policies hook\n\tconst {\n\t\tpolicies,\n\t\tselectedPolicy,\n\t\tisLoading: isPoliciesLoading,\n\t\terror: policiesError,\n\t\tselectPolicy,\n\t\tdefaultPolicy,\n\t} = useMFAPolicies({\n\t\tenvironmentId,\n\t\ttokenIsValid: tokenStatus.isValid,\n\t\tautoLoad: true,\n\t\tautoSelectSingle: true,\n\t});\n\n\tconst selectedPolicyRef = useRef<DeviceAuthenticationPolicy | null>(null);\n\tuseEffect(() => {\n\t\tselectedPolicyRef.current = selectedPolicy ?? null;\n\t}, [selectedPolicy]);\n\n\tconst isPolicyDeviceEnabled = useCallback(\n\t\t(policy: DeviceAuthenticationPolicy | null, key: string) => {\n\t\t\tconst deviceConfig = policy?.[key] as { enabled?: boolean } | undefined;\n\t\t\treturn !!deviceConfig?.enabled;\n\t\t},\n\t\t[]\n\t);\n\n\tconst policyOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tpolicies.map((policy) => ({\n\t\t\t\tvalue: policy.id,\n\t\t\t\tlabel: policy.name,\n\t\t\t\t...(policy.default ? { secondaryLabel: '(Default)' } : {}),\n\t\t\t})),\n\t\t[policies]\n\t);\n\n\tconst userOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tArray.from(\n\t\t\t\tnew Map(\n\t\t\t\t\t(Array.isArray(users) ? users : []).map((user) => [\n\t\t\t\t\t\tuser.username,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvalue: user.username,\n\t\t\t\t\t\t\tlabel: user.username,\n\t\t\t\t\t\t\t...(user.email ? { secondaryLabel: user.email } : {}),\n\t\t\t\t\t\t} as SearchableDropdownOption,\n\t\t\t\t\t])\n\t\t\t\t).values()\n\t\t\t),\n\t\t[users]\n\t);\n\n\t// Auto-select default policy when policies load\n\tuseEffect(() => {\n\t\tif (defaultPolicy && !selectedPolicy) {\n\t\t\tselectPolicy(defaultPolicy.id);\n\t\t}\n\t}, [defaultPolicy, selectedPolicy, selectPolicy]);\n\n\t// Sync environment ID to global service and CredentialsServiceV8 when it changes\n\tuseEffect(() => {\n\t\tif (environmentId) {\n\t\t\tglobalEnvironmentService.setEnvironmentId(environmentId);\n\t\t\tlocalStorage.setItem('mfa_environmentId', environmentId);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tenvironmentId,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId, username: currentCreds.username }\n\t\t\t}));\n\t\t}\n\t}, [environmentId]);\n\n\t// Save username to localStorage and CredentialsServiceV8 when it changes\n\t// This ensures MFAFlowBase can read the username from its expected storage location\n\tuseEffect(() => {\n\t\tif (username) {\n\t\t\tlocalStorage.setItem('mfa_unified_username', username);\n\t\t\tlocalStorage.setItem('mfa_username', username);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tusername,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId: currentCreds.environmentId, username }\n\t\t\t}));\n\t\t}\n\t}, [username]);\n\n\t// Handle device selection for authentication\n\tconst handleDeviceSelectForAuthentication = async (device: {\n\t\tid: string;\n\t\ttype: string;\n\t\tdeviceName?: string;\n\t\tnickname?: string;\n\t}) => {\n\t\tconsole.log(`${MODULE_TAG} Selected device for authentication:`, device);\n\t\tsetShowDeviceSelectionModal(false);\n\t\tsetSelectedAuthDevice(device);\n\n\t\tconst policyId = selectedPolicy?.id;\n\t\tif (!policyId) {\n\t\t\ttoastV8.error('Please select an MFA Policy first');\n\t\t\treturn;\n\t\t}\n\n\t\t// Determine flow type and token\n\t\t// Admin flows should use worker tokens, not require user tokens\n\t\tconst flowType = userToken ? 'user' : 'admin';\n\t\tconst effectiveUserToken = flowType === 'user' ? userToken : undefined;\n\n\t\t// For admin flow, check if we have a valid worker token before proceeding\n\t\tif (flowType === 'admin' && !hasWorkerToken) {\n\t\t\ttoastV8.error('Admin flow requires a valid worker token. Please generate a worker token first.');\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\t// Initialize authentication with appropriate token\n\t\t\tconst response = await MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\tenvironmentId,\n\t\t\t\tusername: username.trim(),\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t\tdeviceId: device.id,\n\t\t\t\tregion: 'na',\n\t\t\t\ttokenType: flowType,\n\t\t\t\t...(effectiveUserToken && { userToken: effectiveUserToken }),\n\t\t\t});\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth initialized - full response:`, response);\n\t\t\tsetAuthenticationId(response.id);\n\n\t\t\tconst status = (response.status || '').toUpperCase();\n\t\t\tconst nextStep = (response.nextStep || '').toUpperCase();\n\t\t\tconst links = response._links as Record<string, { href?: string }> | undefined;\n\t\t\tconst hasOtpLink = !!(\n\t\t\t\tlinks &&\n\t\t\t\t(links.otp || links['otp.check'] || (links as Record<string, unknown>)['checkOtp'])\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth status:`, {\n\t\t\t\tstatus,\n\t\t\t\tnextStep,\n\t\t\t\thasOtpLink,\n\t\t\t\tdeviceType: device.type,\n\t\t\t});\n\n\t\t\t// Show appropriate UI based on response (normalize status/nextStep for PingOne variants)\n\t\t\tif (status === 'OTP_REQUIRED' || nextStep === 'OTP_REQUIRED' || hasOtpLink) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Opening OTP modal for device:`, device.type);\n\t\t\t\tsetShowOTPModal(true);\n\t\t\t\ttoastV8.success(`Verification code sent to your ${device.type} device`);\n\t\t\t} else if (status === 'ASSERTION_REQUIRED' || nextStep === 'ASSERTION_REQUIRED') {\n\t\t\t\tconsole.log(`${MODULE_TAG} FIDO2 assertion required`);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'FIDO2 authentication required. Please use /v8/mfa-config for FIDO2 authentication.'\n\t\t\t\t);\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'PUSH_CONFIRMATION_REQUIRED' ||\n\t\t\t\tnextStep === 'PUSH_CONFIRMATION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Push confirmation required`);\n\t\t\t\ttoastV8.success('Push notification sent! Please approve on your mobile device.');\n\t\t\t\ttoastV8.info('Complete authentication at /v8/mfa-config for push polling.');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (status === 'COMPLETED') {\n\t\t\t\ttoastV8.success('Authentication completed successfully!');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'DEVICE_SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'DEVICE_SELECTION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Device selection required - showing modal again`);\n\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t} else {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Unexpected authentication status:`, {\n\t\t\t\t\tstatus,\n\t\t\t\t\tnextStep,\n\t\t\t\t\tresponse,\n\t\t\t\t});\n\t\t\t\ttoastV8.info(`Authentication status: ${status || nextStep || 'UNKNOWN'}`);\n\t\t\t\t// Stay in authentication flow so user can try another device\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to initialize authentication:`, error);\n\n\t\t\t// Enhanced error handling for NO_USABLE_DEVICES\n\t\t\tlet errorMessage = 'Authentication failed: ';\n\t\t\tif (error instanceof Error) {\n\t\t\t\tconst errorStr = error.message.toLowerCase();\n\n\t\t\t\t// Check for NO_USABLE_DEVICES or device availability errors\n\t\t\t\tif (\n\t\t\t\t\terrorStr.includes('no usable devices') ||\n\t\t\t\t\terrorStr.includes('too many') ||\n\t\t\t\t\terrorStr.includes('cooldown') ||\n\t\t\t\t\terrorStr.includes('blocked')\n\t\t\t\t) {\n\t\t\t\t\terrorMessage = '‚ö†Ô∏è Device Temporarily Unavailable\\n\\n';\n\n\t\t\t\t\tif (errorStr.includes('cooldown') || errorStr.includes('too many')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Too many notifications have been sent to this device. It is temporarily in cooldown. ';\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Please wait a few minutes and try again, or select a different device.';\n\t\t\t\t\t} else if (errorStr.includes('blocked')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'This device has been blocked. Please contact your administrator or use a different device.';\n\t\t\t\t\t} else {\n\t\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terrorMessage += 'Unknown error';\n\t\t\t}\n\n\t\t\ttoastV8.error(errorMessage, { duration: 8000 });\n\t\t\t// Do NOT set flowMode(null) - keep user in authentication flow so they can retry or select another device\n\t\t}\n\t};\n\n\t// Handle OTP verification\n\tconst handleVerifyOTP = async () => {\n\t\tif (!authenticationId || !selectedAuthDevice) {\n\t\t\ttoastV8.error('Authentication session not found');\n\t\t\treturn;\n\t\t}\n\n\t\tif (otpCode.length !== 6) {\n\t\t\ttoastV8.error('Please enter a 6-digit code');\n\t\t\treturn;\n\t\t}\n\n\t\t// Get worker token for API call\n\t\tconst workerTokenForOTP = await workerTokenServiceV8.getToken();\n\n\t\tconsole.log(`${MODULE_TAG} OTP verification debug:`, {\n\t\t\tenvironmentId,\n\t\t\tusername: username.trim(),\n\t\t\tauthenticationId,\n\t\t\totpCode,\n\t\t\thasEnvironmentId: !!environmentId,\n\t\t\tenvIdLength: environmentId?.length,\n\t\t\thasWorkerToken: !!workerTokenForOTP,\n\t\t\tworkerTokenLength: workerTokenForOTP?.length,\n\t\t});\n\n\t\ttry {\n\t\t\t// Use backend proxy to avoid CORS issues\n\t\t\tconst response = await fetch('/api/pingone/mfa/validate-otp-for-device', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tenvironmentId,\n\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\tdeviceAuthId: authenticationId,\n\t\t\t\t\totp: otpCode,\n\t\t\t\t\tregion: 'na',\n\t\t\t\t\tworkerToken: workerTokenForOTP,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\n\t\t\t\tthrow new Error(errorData.error || errorData.message || `HTTP ${response.status}`);\n\t\t\t}\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.status === 'COMPLETED' || result.status === 'completed') {\n\t\t\t\ttoastV8.success('‚úÖ Authentication completed successfully!');\n\t\t\t\tsetShowOTPModal(false);\n\t\t\t\tsetFlowMode(null);\n\t\t\t\tsetOtpCode('');\n\t\t\t} else {\n\t\t\t\ttoastV8.error('Invalid code. Please try again.');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} OTP verification failed:`, error);\n\t\t\ttoastV8.error(\n\t\t\t\t`Verification failed: ${error instanceof Error ? error.message : 'Unknown error'}`\n\t\t\t);\n\t\t}\n\t};\n\n\t// Step 1: Choose Registration or Authentication\n\tif (!flowMode) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '12px' }}>\n\t\t\t\t\t{/* Header */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tboxShadow: '0 4px 12px rgba(239, 68, 68, 0.2)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h1\n\t\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîê MFA Unified Flow\n\t\t\t\t\t\t</h1>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tChoose what you want to do with MFA devices.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Configuration Section */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 12px 0',\n\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfiguration\n\t\t\t\t\t\t</h2>\n\n\t\t\t\t\t\t{/* Custom Logo URL */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-url\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[800],\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüé® Custom Logo URL (Optional)\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tDisplay a custom logo in the OTP verification modal\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t{/* URL Input */}\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tid=\"custom-logo-url\"\n\t\t\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\t\t\tvalue={customLogoUrl}\n\t\t\t\t\t\t\t\tonChange={(e) => setCustomLogoUrl(e.target.value)}\n\t\t\t\t\t\t\t\tplaceholder=\"https://example.com/logo.png\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\tpadding: '10px 14px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[900],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = `0 0 0 3px ${PING_IDENTITY_COLORS.primary[200]}`;\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.neutral[300];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* File Upload Section */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '13px', color: PING_IDENTITY_COLORS.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\tOR\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"file\"\n\t\t\t\t\t\t\t\t\tid=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\taccept=\"image/*\"\n\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\tconst file = e.target.files?.[0];\n\t\t\t\t\t\t\t\t\t\tif (!file) return;\n\n\t\t\t\t\t\t\t\t\t\t// Validate file type (images only)\n\t\t\t\t\t\t\t\t\t\tif (!file.type.startsWith('image/')) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Please select a logo file (JPG, PNG, etc.)');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Validate file size (max 5MB)\n\t\t\t\t\t\t\t\t\t\tif (file.size > 5 * 1024 * 1024) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('File size must be less than 5MB');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Convert file to base64 for persistence\n\t\t\t\t\t\t\t\t\t\tconst reader = new FileReader();\n\t\t\t\t\t\t\t\t\t\treader.onload = (event) => {\n\t\t\t\t\t\t\t\t\t\t\tconst base64Url = event.target?.result as string;\n\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl(base64Url);\n\n\t\t\t\t\t\t\t\t\t\t\t// Store base64 data for persistence\n\t\t\t\t\t\t\t\t\t\t\tconst uploadData = {\n\t\t\t\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\t\t\t\tbase64Url: base64Url,\n\t\t\t\t\t\t\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\t\t\t// Save to localStorage for persistence\n\t\t\t\t\t\t\t\t\t\t\tlocalStorage.setItem('custom-logo-upload', JSON.stringify(uploadData));\n\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.success(`Logo uploaded: ${file.name}`);\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.onerror = () => {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to read uploaded file');\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.readAsDataURL(file);\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'none' }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.primary[500],\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.primary[600]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '500',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[700];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìÅ Upload Logo File\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[500],\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tJPG, PNG, GIF (max 5MB)\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{customLogoUrl && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.neutral[50],\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tLogo Preview:\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\talt=\"Custom logo\"\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonError={() => {\n\t\t\t\t\t\t\t\t\t\t\t// Handle broken image URLs\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Failed to load custom logo URL');\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl('');\n\t\t\t\t\t\t\t\t\t\t\t\t// Clear uploaded file from localStorage\n\t\t\t\t\t\t\t\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.accent.pingRed[500],\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.accent.pingRed[600]}`,\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[600];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[500];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRemove Logo\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Environment ID - Hide when worker token is available */}\n\t\t\t\t\t\t{!hasWorkerToken && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"env-id\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tEnvironment ID\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"env-id\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setEnvironmentId(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* SQLite Database Stats */}\n\t\t\t\t\t\t{environmentId && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<SQLiteStatsDisplayV8\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tcompact={false}\n\t\t\t\t\t\t\t\t\trefreshInterval={30}\n\t\t\t\t\t\t\t\t\tshowRefreshButton={true}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Username */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUsername\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{environmentId && tokenStatus.isValid ? (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\toptions={userOptions}\n\t\t\t\t\t\t\t\t\tonChange={setUsername}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Type to search across 16,000+ users...\"\n\t\t\t\t\t\t\t\t\tisLoading={isLoadingUsers}\n\t\t\t\t\t\t\t\t\tonSearchChange={setSearchQuery}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setUsername(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* MFA Policy Dropdown */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"mfa-policy\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tMFA Policy\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{isPoliciesLoading ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tLoading policies...\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policiesError ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#ef4444', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tError loading policies: {policiesError}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policies.length === 0 ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tNo MFA policies found. Please check your environment ID and worker token.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"mfa-policy\"\n\t\t\t\t\t\t\t\t\tvalue={selectedPolicy?.id || ''}\n\t\t\t\t\t\t\t\t\toptions={policyOptions}\n\t\t\t\t\t\t\t\t\tonChange={selectPolicy}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Select an MFA policy...\"\n\t\t\t\t\t\t\t\t\tisLoading={isPoliciesLoading}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tSelect the MFA policy to use for device registration\n\t\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t\t{/* Policy Summary - Collapsible */}\n\t\t\t\t\t\t\t{selectedPolicy && (\n\t\t\t\t\t\t\t\t<details\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<summary\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\tuserSelect: 'none',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüìã Policy Details\n\t\t\t\t\t\t\t\t\t</summary>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '12px', fontSize: '13px', color: '#4b5563' }}>\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Policy Name:</strong> {String(selectedPolicy.name)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedPolicy.default && (\n\t\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px', color: '#059669' }}>\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>‚úì Default Policy</strong>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Enabled Devices:</strong>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '6px' }}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'sms') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì± SMS\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'email') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t‚úâÔ∏è Email\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'totp') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîê TOTP\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'fido2') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîë FIDO2\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'mobile') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì≤ Mobile\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'voice') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüìû Voice\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</details>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Worker Token Status */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t\tpaddingRight: '16px',\n\t\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={setEnvironmentId}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* User Token Status */}\n\t\t\t\t\t\t\t{userToken && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\t'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05))',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #10b981',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '20px' }}>üë§</span>\n\t\t\t\t\t\t\t\t\t\t<strong style={{ color: '#047857', fontSize: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t\tUser Token Active\n\t\t\t\t\t\t\t\t\t\t</strong>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: '14px', color: '#059669', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t\t‚úì User authentication token available\n\t\t\t\t\t\t\t\t\t\t<br />‚úì Ready for User Flow device registration\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Flow Mode Selection */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',\n\t\t\t\t\t\t\tgap: '16px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Registration Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => setFlowMode('registration')}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>‚ûï</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#047857',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Registration\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tRegister a new MFA device for a user. Create SMS, Email, TOTP, Mobile Push,\n\t\t\t\t\t\t\t\t\t\tWhatsApp, or FIDO2 devices.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t{/* Authentication Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tif (!userToken) {\n\t\t\t\t\t\t\t\t\tsetShowAuthLoginModal(true);\n\t\t\t\t\t\t\t\t\ttoastV8.info('üîê Please complete user login before device authentication.', {\n\t\t\t\t\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-4px)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 8px 24px rgba(59, 130, 246, 0.2)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>üîì</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#1d4ed8',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Authentication\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tAuthenticate using an existing MFA device. Verify user identity with OTP, push\n\t\t\t\t\t\t\t\t\t\tnotification, or security key.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{showAuthLoginModal && (\n\t\t\t\t\t<UserLoginModalV8\n\t\t\t\t\t\tisOpen={showAuthLoginModal}\n\t\t\t\t\t\tonClose={() => setShowAuthLoginModal(false)}\n\t\t\t\t\t\tonTokenReceived={(token) => {\n\t\t\t\t\t\t\tsetUserToken(token);\n\t\t\t\t\t\t\tsetShowAuthLoginModal(false);\n\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tenvironmentId={authEnvIdForModal}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</>\n\t\t);\n\t}\n\n\t// Authentication flow - dedicated view (device selection + OTP modals only; no registration grid)\n\tif (flowMode === 'authentication') {\n\t\treturn (\n\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\tsetSelectedAuthDevice(null);\n\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t‚Üê Back\n\t\t\t\t\t</button>\n\t\t\t\t\t<h1\n\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t>\n\t\t\t\t\t\tüîì Device Authentication\n\t\t\t\t\t</h1>\n\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\t{selectedAuthDevice && !showOTPModal\n\t\t\t\t\t\t\t? `Authenticating with ${selectedAuthDevice.type} ‚Äî enter the code when prompted.`\n\t\t\t\t\t\t\t: `Select an MFA device to authenticate for ${username || 'the user'}`}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t\t{!showDeviceSelectionModal && !showOTPModal && (\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowDeviceSelectionModal(true)}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tSelect MFA device\n\t\t\t\t\t</button>\n\t\t\t\t)}\n\t\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\t\tonClose={() => {\n\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t// Keep flowMode so user stays in auth flow; only clear if they click Back\n\t\t\t\t\t}}\n\t\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\t\tusername={username}\n\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t/>\n\t\t\t\t{showOTPModal && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.6)',\n\t\t\t\t\t\t\tbackdropFilter: 'blur(4px)',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t\t\tanimation: 'fadeIn 0.2s ease-out',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t{`\n\t\t\t\t\t\t\t@keyframes fadeIn {\n\t\t\t\t\t\t\t\tfrom { opacity: 0; }\n\t\t\t\t\t\t\t\tto { opacity: 1; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes slideUp {\n\t\t\t\t\t\t\t\tfrom { \n\t\t\t\t\t\t\t\t\topacity: 0;\n\t\t\t\t\t\t\t\t\ttransform: translateY(20px); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tto { \n\t\t\t\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t\t\t\t\ttransform: translateY(0); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes pulse {\n\t\t\t\t\t\t\t\t0%, 100% { opacity: 1; }\n\t\t\t\t\t\t\t\t50% { opacity: 0.5; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`}\n\t\t\t\t\t\t</style>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\tborderRadius: '24px',\n\t\t\t\t\t\t\t\tpadding: '48px 40px',\n\t\t\t\t\t\t\t\tmaxWidth: '480px',\n\t\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\t\tboxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',\n\t\t\t\t\t\t\t\tanimation: 'slideUp 0.3s ease-out',\n\t\t\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Logo Area */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '32px' }}>\n\t\t\t\t\t\t\t\t{customLogoUrl ? (\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\t\talt=\"Organization logo\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '120px',\n\t\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonError={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\t// Fallback to default icon if image fails to load\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.display = 'none';\n\t\t\t\t\t\t\t\t\t\t\t\tconst fallback = document.createElement('div');\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.style.cssText = `\n\t\t\t\t\t\t\t\t\t\t\t\twidth: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\theight: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: 0 auto 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: center;\n\t\t\t\t\t\t\t\t\t\t\t\tjustifyContent: center;\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: 36px;\n\t\t\t\t\t\t\t\t\t\t\t\tboxShadow: 0 10px 25px rgba(102, 126, 234, 0.3);\n\t\t\t\t\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.textContent = 'üîê';\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.parentElement!.appendChild(fallback);\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\theight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto 20px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '20px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '36px',\n\t\t\t\t\t\t\t\t\t\t\tboxShadow: '0 10px 25px rgba(102, 126, 234, 0.3)',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüîê\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tVerification Code\n\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\tEnter the 6-digit code sent to your <strong>{selectedAuthDevice?.type}</strong>{' '}\n\t\t\t\t\t\t\t\t\tdevice\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* OTP Input */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\t\t\tplaceholder=\"‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢\"\n\t\t\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tletterSpacing: '12px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow: otpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{otpCode.length > 0 && otpCode.length < 6 && (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\t\tanimation: 'pulse 2s ease-in-out infinite',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{6 - otpCode.length} more digit{6 - otpCode.length !== 1 ? 's' : ''} needed\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Resend Code Button */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={async () => {\n\t\t\t\t\t\t\t\t\t\tif (!selectedAuthDevice || !authenticationId) return;\n\t\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.info('Resending verification code...');\n\t\t\t\t\t\t\t\t\t\t\t// Re-initialize authentication to resend code\n\t\t\t\t\t\t\t\t\t\t\tconst response =\n\t\t\t\t\t\t\t\t\t\t\t\tawait MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\t\t\t\t\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\t\t\t\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicy?.id || '',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceId: selectedAuthDevice.id,\n\t\t\t\t\t\t\t\t\t\t\t\t\tregion: 'na',\n\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tif (response.status?.toUpperCase() === 'OTP_REQUIRED') {\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('New code sent to your device!');\n\t\t\t\t\t\t\t\t\t\t\t\tsetAuthenticationId(response.id);\n\t\t\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to resend code');\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Resend error:', error);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tcolor: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'transparent';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚Üª Resend Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Action Buttons */}\n\t\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#d1d5db';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f9fafb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'white';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6\n\t\t\t\t\t\t\t\t\t\t\t\t? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '#d1d5db',\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (otpCode.length === 6) {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚úì Verify Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Help Text */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<strong style={{ color: '#111827' }}>Didn't receive the code?</strong>\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\tCheck your spam folder or click \"Resend Code\" above\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t);\n\t}\n\n\t// Registration flow - show device type selection cards\n\treturn (\n\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t{/* Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #10b981 0%, #047857 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => setFlowMode(null)}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t‚Üê Back\n\t\t\t\t</button>\n\t\t\t\t<h1 style={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}>\n\t\t\t\t\t‚ûï Register MFA Device\n\t\t\t\t</h1>\n\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\tSelect a device type to register for {username || 'the user'}\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Device Type Cards */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',\n\t\t\t\t\tgap: '16px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t{DEVICE_TYPES.map((device) => {\n\t\t\t\t\tconst enabled = isDeviceEnabled(device.key);\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tkey={device.key}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => enabled && onSelectDeviceType(device.key)}\n\t\t\t\t\t\t\tdisabled={!enabled}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tbackground: enabled ? '#ffffff' : '#f9fafb',\n\t\t\t\t\t\t\t\tborder: `2px solid ${enabled ? '#e5e7eb' : '#f3f4f6'}`,\n\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\tcursor: enabled ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\topacity: enabled ? 1 : 0.5,\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#10b981';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ecfdf5';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>{device.icon}</span>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{device.name}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280' }}>{device.description}</p>\n\t\t\t\t\t\t\t{!enabled && (\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '12px', color: '#9ca3af' }}>\n\t\t\t\t\t\t\t\t\t(Not enabled)\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</div>\n\n\t\t\t{/* Device Selection Modal for Authentication */}\n\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t}}\n\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\tusername={username}\n\t\t\t\tenvironmentId={environmentId}\n\t\t\t/>\n\n\t\t\t{/* OTP Modal for Authentication */}\n\t\t\t{showOTPModal && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '400px',\n\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\tboxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '600' }}>\n\t\t\t\t\t\t\tEnter Verification Code\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '0 0 20px 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tCheck your {selectedAuthDevice?.type} device for the code\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\tplaceholder=\"000000\"\n\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 16px',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\tletterSpacing: '8px',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tmarginBottom: '20px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: otpCode.length === 6 ? '#3b82f6' : '#9ca3af',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tVerify\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Wrapper Component\n *\n * Wraps the content with MFACredentialProvider to provide global credential state\n */\nexport const UnifiedMFARegistrationFlowV8: React.FC<UnifiedMFARegistrationFlowV8Props> = (\n\tprops\n) => {\n\tconst location = useLocation();\n\n\t// Get device type from props or location state (can be undefined)\n\tconst initialDeviceType =\n\t\tprops.deviceType || (location.state as { deviceType?: DeviceConfigKey })?.deviceType;\n\n\t// State for selected device type (allows user to select if not provided)\n\tconst [selectedDeviceType, setSelectedDeviceType] = useState<DeviceConfigKey | undefined>(\n\t\tinitialDeviceType\n\t);\n\n\t// User token state for OAuth authentication (User Flow)\n\tconst [userToken, setUserToken] = useState<string | null>(() => {\n\t\t// Check if we already have a user token from previous OAuth flow\n\t\tconst savedCreds = CredentialsServiceV8.loadCredentials('user-login-v8', {\n\t\t\tflowKey: 'user-login-v8',\n\t\t\tflowType: 'oauth',\n\t\t\tincludeClientSecret: false,\n\t\t\tincludeRedirectUri: false,\n\t\t\tincludeLogoutUri: false,\n\t\t\tincludeScopes: false,\n\t\t});\n\t\treturn savedCreds?.accessToken || null;\n\t});\n\n\t// If no device type selected, show device type selection screen\n\tif (!selectedDeviceType) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<MFAHeaderV8\n\t\t\t\t\ttitle=\"MFA Unified Flow\"\n\t\t\t\t\tdescription=\"Register or authenticate MFA devices\"\n\t\t\t\t\tversionTag=\"V8\"\n\t\t\t\t\tcurrentPage=\"registration\"\n\t\t\t\t\tshowBackToMain={true}\n\t\t\t\t\theaderColor=\"pingRed\"\n\t\t\t\t/>\n\t\t\t\t<GlobalMFAProvider>\n\t\t\t\t\t<MFACredentialProvider>\n\t\t\t\t\t\t<DeviceTypeSelectionScreen\n\t\t\t\t\t\t\tonSelectDeviceType={setSelectedDeviceType}\n\t\t\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</MFACredentialProvider>\n\t\t\t\t</GlobalMFAProvider>\n\t\t\t\t{/* API display (bottom of page) */}\n\t\t\t\t<div style={{ marginTop: '24px' }}>\n\t\t\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\t\t\t\t</div>\n\t\t\t</>\n\t\t);\n\t}\n\n\treturn (\n\t\t<GlobalMFAProvider>\n\t\t\t<MFACredentialProvider>\n\t\t\t\t<UnifiedMFARegistrationFlowContent\n\t\t\t\t\t{...props}\n\t\t\t\t\tdeviceType={selectedDeviceType}\n\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t/>\n\t\t\t</MFACredentialProvider>\n\t\t</GlobalMFAProvider>\n\t);\n};\n\n// ============================================================================\n// CONTENT COMPONENT (MAIN LOGIC)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Content Component\n *\n * Contains the actual flow logic and integrates with:\n * - MFACredentialContext (global credential state)\n * - useWorkerToken hook (token status and auto-refresh)\n * - deviceFlowConfigs (device-specific configuration)\n * - MFAFlowBaseV8 (5-step framework)\n */\nconst UnifiedMFARegistrationFlowContent: React.FC<\n\tRequired<Pick<UnifiedMFARegistrationFlowV8Props, 'deviceType'>> &\n\t\tOmit<UnifiedMFARegistrationFlowV8Props, 'deviceType'> & {\n\t\t\tuserToken: string | null;\n\t\t\tsetUserToken: (token: string | null) => void;\n\t\t}\n> = ({ deviceType, onCancel, userToken, setUserToken }) => {\n\t// ========================================================================\n\t// CONFIGURATION\n\t// ========================================================================\n\n\t// React Router navigation\n\tconst navigate = useNavigate();\n\n\t// Load device-specific configuration\n\tconst config = useMemo(() => {\n\t\treturn getDeviceConfig(deviceType);\n\t}, [deviceType]);\n\n\t// ========================================================================\n\t// USER FLOW OAUTH STATE\n\t// ========================================================================\n\n\t// State for User Login Modal (OAuth authentication for User Flow)\n\tconst [showUserLoginModal, setShowUserLoginModal] = useState(false);\n\tconst [showUserTokenSuccess, setShowUserTokenSuccess] = useState(false);\n\tconst [userTokenForDisplay, setUserTokenForDisplay] = useState<string>('');\n\tconst [usernameFromToken, setUsernameFromToken] = useState<string>('');\n\tconst [showUsernameDropdown, setShowUsernameDropdown] = useState(false);\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\tconst envIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Pending registration data while waiting for OAuth (use ref to avoid stale closure)\n\tconst pendingRegistrationRef = useRef<{\n\t\tdeviceType: DeviceConfigKey;\n\t\tfields: Record<string, string>;\n\t\tflowType: string;\n\t\tprops: MFAFlowBaseRenderProps;\n\t} | null>(null);\n\n\t// Worker token state for validation in registration flow\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Detect OAuth callback and re-open modal if needed\n\tuseEffect(() => {\n\t\tconst urlParams = new URLSearchParams(window.location.search);\n\t\tconst code = urlParams.get('code');\n\t\tconst hasStoredState = sessionStorage.getItem('user_login_state_v8');\n\n\t\t// If we have OAuth callback params and stored state, re-open the modal to process callback\n\t\t// But only if we don't already have a user token (to prevent reopening after silent auth)\n\t\tif (code && hasStoredState && !showUserLoginModal && !userToken) {\n\t\t\tconsole.log('[UNIFIED-FLOW] OAuth callback detected - re-opening modal to process');\n\t\t\tsetShowUserLoginModal(true);\n\t\t}\n\t}, [showUserLoginModal, userToken]);\n\n\t// ========================================================================\n\t// STEP VALIDATION\n\t// ========================================================================\n\n\t/**\n\t * Validate Step 0 (Configuration)\n\t */\n\tconst validateStep0 = useCallback(\n\t\t(\n\t\t\tcredentials: MFACredentials,\n\t\t\ttoken: TokenStatusInfo,\n\t\t\tnavigation: ReturnType<typeof useStepNavigationV8>\n\t\t) => {\n\t\t\t// Always check for valid worker token (required for MFA device operations)\n\t\t\tif (!token.isValid) {\n\t\t\t\tnavigation.setValidationErrors(['Invalid or expired worker token']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Check required configuration\n\t\t\tif (!credentials.environmentId || !credentials.username) {\n\t\t\t\tnavigation.setValidationErrors(['Environment ID and Username are required']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\t\t[]\n\t);\n\n\t// ========================================================================\n\t// STEP RENDERERS\n\t// ========================================================================\n\n\t/**\n\t * Perform device registration API call (with token already available)\n\t */\n\tconst performRegistrationWithToken = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string,\n\t\t\ttoken?: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== PERFORM REGISTRATION WITH TOKEN =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Token:', token ? `Present (${token.length} chars)` : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setIsLoading available:', typeof props.setIsLoading);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setCredentials available:', typeof props.setCredentials);\n\n\t\t\ttry {\n\t\t\t\tprops.setIsLoading(true);\n\n\t\t\t\t// Update credentials with device fields and user token if provided\n\t\t\t\tprops.setCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tflowType, // Store flowType so activation step knows if OTP is required\n\t\t\t\t\t...fields,\n\t\t\t\t\t...(flowType === 'user' && token\n\t\t\t\t\t\t? { userToken: token, tokenType: 'user' }\n\t\t\t\t\t\t: flowType !== 'user'\n\t\t\t\t\t\t\t? { tokenType: 'worker' }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t}));\n\n\t\t\t\t// Register the device using proper API call\n\t\t\t\t// CRITICAL: Flow-specific device status\n\t\t\t\t// - Admin flow: ACTIVE (no OTP sent, device ready immediately)\n\t\t\t\t// - Admin ACTIVATION_REQUIRED: ACTIVATION_REQUIRED (sends OTP for admin to activate)\n\t\t\t\t// - User flow: ACTIVATION_REQUIRED (sends OTP for user to activate)\n\t\t\t\t// - FIDO2: ACTIVE (WebAuthn verification happens during registration)\n\t\t\t\tlet deviceStatus: 'ACTIVE' | 'ACTIVATION_REQUIRED' | undefined;\n\n\t\t\t\t// Determine device status based on flow type (applies to all device types including FIDO2)\n\t\t\t\tif (flowType === 'admin-active') {\n\t\t\t\t\tdeviceStatus = 'ACTIVE';\n\t\t\t\t} else if (flowType === 'admin-activation') {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED';\n\t\t\t\t} else {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED'; // user flow\n\t\t\t\t}\n\n\t\t\t\t// Special note for FIDO2: WebAuthn verification proves device works,\n\t\t\t\t// but we still respect the flow type for status determination\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t'[UNIFIED-FLOW] FIDO2 device - status determined by flow type:',\n\t\t\t\t\t\tdeviceStatus\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device status determined:', {\n\t\t\t\t\tflowType,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tdeviceStatus,\n\t\t\t\t\totpWillBeSent: deviceStatus === 'ACTIVATION_REQUIRED',\n\t\t\t\t\treason:\n\t\t\t\t\t\tselectedDeviceType === 'FIDO2'\n\t\t\t\t\t\t\t? 'FIDO2 - ACTIVE after WebAuthn verification'\n\t\t\t\t\t\t\t: 'User flow - OTP required for activation',\n\t\t\t\t});\n\n\t\t\t\t// Use same parameter construction as working MFA flows\n\t\t\t\ttype RegisterDeviceParamsWithToken = RegisterDeviceParams & {\n\t\t\t\t\ttokenType?: 'worker' | 'user';\n\t\t\t\t\tuserToken?: string | undefined;\n\t\t\t\t};\n\t\t\t\tlet baseParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\tenvironmentId: props.credentials.environmentId,\n\t\t\t\t\tusername: props.credentials.username,\n\t\t\t\t\ttype: selectedDeviceType,\n\t\t\t\t};\n\t\t\t\t// Per rightTOTP.md: Pass token type and user token if available\n\t\t\t\tif (flowType === 'user' && token) {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'user',\n\t\t\t\t\t\tuserToken: token,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'worker',\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Always include status for all device types\n\t\t\t\t// FIDO2: Set to ACTIVE since WebAuthn verification proves device works\n\t\t\t\t// Other devices: Set based on flow type (admin-active = ACTIVE, others = ACTIVATION_REQUIRED)\n\t\t\t\tif (deviceStatus !== undefined) {\n\t\t\t\t\tbaseParams.status = deviceStatus;\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registration base params:', {\n\t\t\t\t\tenvironmentId: baseParams.environmentId,\n\t\t\t\t\tusername: baseParams.username,\n\t\t\t\t\ttype: baseParams.type,\n\t\t\t\t\ttokenType: baseParams.tokenType,\n\t\t\t\t\tstatus: baseParams.status,\n\t\t\t\t\tflowType,\n\t\t\t\t});\n\n\t\t\t\t// Map form field names to API field names\n\t\t\t\t// Form uses 'deviceName' but API expects 'nickname' or 'name'\n\t\t\t\tconst mappedFields: Record<string, string> = { ...fields };\n\t\t\t\tif (mappedFields.deviceName) {\n\t\t\t\t\tmappedFields.nickname = mappedFields.deviceName;\n\t\t\t\t\tmappedFields.name = mappedFields.deviceName;\n\t\t\t\t\tdelete mappedFields.deviceName;\n\t\t\t\t}\n\n\t\t\t\t// Format phone number for SMS/WhatsApp devices\n\t\t\t\t// Form sends: { phoneNumber: '9725231586', countryCode: '+1' }\n\t\t\t\t// API expects: { phone: '+1.9725231586' }\n\t\t\t\tif (mappedFields.phoneNumber && mappedFields.countryCode) {\n\t\t\t\t\tconst countryCode = mappedFields.countryCode.replace('+', ''); // Remove + for formatting\n\t\t\t\t\tconst phoneNumber = mappedFields.phoneNumber.replace(/\\D/g, ''); // Remove non-digits\n\t\t\t\t\tmappedFields.phone = `+${countryCode}.${phoneNumber}`;\n\t\t\t\t\tconsole.log('[UNIFIED-FLOW] Formatted phone:', mappedFields.phone);\n\t\t\t\t\tdelete mappedFields.phoneNumber;\n\t\t\t\t\tdelete mappedFields.countryCode;\n\t\t\t\t}\n\n\t\t\t\t// Include device-specific fields (phone, email, etc.)\n\t\t\t\tconst deviceParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\t...baseParams,\n\t\t\t\t\t...mappedFields,\n\t\t\t\t\t// Include policy for TOTP devices (required for secret and keyUri to be returned)\n\t\t\t\t\t...(selectedDeviceType === 'TOTP' && selectedPolicyRef.current\n\t\t\t\t\t\t? { policy: selectedPolicyRef.current.id }\n\t\t\t\t\t\t: {}),\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registering device with params:', deviceParams);\n\n\t\t\t\tconst result = await MFAServiceV8_Legacy.registerDevice(deviceParams);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device registered:', result);\n\n\t\t\t\t// Update MFA state with device info\n\t\t\t\tconst registrationResult = result as unknown as Record<string, unknown>;\n\n\t\t\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result for TOTP:', {\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\tqrCode: registrationResult.qrCode,\n\t\t\t\t\t\tqrCodeUrl: registrationResult.qrCodeUrl,\n\t\t\t\t\t\tsecret: registrationResult.secret,\n\t\t\t\t\t\ttotpSecret: registrationResult.totpSecret,\n\t\t\t\t\t\tfullResult: result,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// ===============================================\n\n\t\t\t\t// Clear stored registration data after successful use\n\t\t\t\tlocalStorage.removeItem('mfa_registration_flow_type');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_fields');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_device_type');\n\n\t\t\t\tprops.setMfaState((prev) => {\n\t\t\t\t\t// TOTP: QR code will be rendered by QRCodeSVG component in UnifiedActivationStep\n\t\t\t\t\t// No need to generate QR code data URL here - just pass the keyUri\n\t\t\t\t\tconst newState: MFAState = {\n\t\t\t\t\t\t...prev,\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tdeviceStatus: result.status,\n\t\t\t\t\t\t...(registrationResult.deviceActivateUri\n\t\t\t\t\t\t\t? { deviceActivateUri: String(registrationResult.deviceActivateUri) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'TOTP'\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\ttotpSecret: String(registrationResult.secret || ''),\n\t\t\t\t\t\t\t\t\tkeyUri: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tqrCodeUrl: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tshowQr: !!(registrationResult.secret || registrationResult.keyUri),\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'FIDO2' &&\n\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tpublicKeyCredentialCreationOptions:\n\t\t\t\t\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions,\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'MOBILE' && registrationResult.pairingKey\n\t\t\t\t\t\t\t? { pairingKey: String(registrationResult.pairingKey) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t};\n\n\t\t\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\t\t\tfullState: newState,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t// ================================================\n\n\t\t\t\t\treturn newState;\n\t\t\t\t});\n\n\t\t\t\t// FIDO2: Check if we already have credential data (from WebAuthn modal)\n\t\t\t\t// If credentialId and publicKey are present, registration is complete\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tif (fields.credentialId && fields.publicKey) {\n\t\t\t\t\t\t// WebAuthn already completed via modal - device fully registered\n\n\t\t\t\t\t\t// Admin Flow: Show QR but skip OTP validation - device ready immediately\n\t\t\t\t\t\t// Admin ACTIVATION_REQUIRED & User Flow: Show QR and require OTP validation\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tflowType === 'admin-active' ||\n\t\t\t\t\t\t\tflowType === 'admin-activation' ||\n\t\t\t\t\t\t\tresult.status === 'ACTIVE'\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t'[UNIFIED-FLOW] Admin flow or ACTIVE status - proceeding to show QR without OTP requirement'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered successfully!${flowType === 'admin-active' || flowType === 'admin-activation' ? ' Device is ready to use.' : ''}`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t// For Admin Flow, go to API docs page instead of OTP page\n\t\t\t\t\t\t\t// For User Flow, go to User Login step (Step 1)\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (result.status === 'ACTIVATION_REQUIRED') {\n\t\t\t\t\t\t\t// Device requires activation - PingOne automatically sends OTP\n\t\t\t\t\t\t\t// This applies to both admin_activation_required and user flow\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered! OTP has been sent automatically.`\n\t\t\t\t\t\t\t);\n  // DO NOT auto-advance for OTP-required devices\n\t\t\t\t\t\t\t// User should manually click Next after receiving OTP\n\t\t\t\t\t\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation - waiting for user to proceed manually`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Unknown status, proceed with flow-specific navigation\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} // End of FIDO2 section\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Registration failed:', error);\n\t\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Device registration failed';\n\n\t\t\t\t// Check if error is due to too many devices\n\t\t\t\tif (errorMessage.includes('Too many devices')) {\n\t\t\t\t\ttoastV8.error(\n\t\t\t\t\t\t`${errorMessage}\\n\\n‚ÑπÔ∏è You can manage your devices at:\\nhttps://localhost:3000/v8/delete-all-devices`,\n\t\t\t\t\t\t{ duration: 8000 }\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\ttoastV8.error(errorMessage);\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tprops.setIsLoading(false);\n\t\t\t}\n\t\t},\n\t\t[config.displayName, toastV8]\n\t);\n\n\t/**\n\t * Handle user token received from OAuth flow\n\t */\n\tconst handleUserTokenReceived = useCallback(\n\t\t(token: string) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== USER TOKEN RECEIVED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Token length:', token.length);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current pending registration:', pendingRegistrationRef.current);\n\n\t\t\tsetUserToken(token);\n\t\t\tsetUserTokenForDisplay(token);\n\n\t\t\t// Decode JWT to extract username\n\t\t\ttry {\n\t\t\t\tconst base64Url = token.split('.')[1];\n\t\t\t\tconst base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n\t\t\t\tconst jsonPayload = decodeURIComponent(\n\t\t\t\t\tatob(base64)\n\t\t\t\t\t\t.split('')\n\t\t\t\t\t\t.map((c) => `%${`00${c.charCodeAt(0).toString(16)}`.slice(-2)}`)\n\t\t\t\t\t\t.join('')\n\t\t\t\t);\n\t\t\t\tconst payload = JSON.parse(jsonPayload);\n\t\t\t\tconst username =\n\t\t\t\t\tpayload.username || payload.preferred_username || payload.sub || 'Unknown User';\n\t\t\t\tsetUsernameFromToken(username);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Extracted username:', username);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Failed to decode JWT:', error);\n\t\t\t\tsetUsernameFromToken('Unknown User');\n\t\t\t}\n\n\t\t\t// If we have pending registration, show success page first\n\t\t\tconst pending = pendingRegistrationRef.current;\n\t\t\tif (pending) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Found pending registration, showing success page first...');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending data:', {\n\t\t\t\t\tdeviceType: pending.deviceType,\n\t\t\t\t\tflowType: pending.flowType,\n\t\t\t\t\thasProps: !!pending.props,\n\t\t\t\t\thasFields: !!pending.fields,\n\t\t\t\t});\n\n\t\t\t\ttoastV8.success('‚úÖ Authentication successful! Your user token is ready.', {\n\t\t\t\t\tduration: 4000,\n\t\t\t\t});\n\n\t\t\t\t// Close login modal and show success page\n\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\tsetShowUserTokenSuccess(true);\n\t\t\t} else {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] WARNING: No pending registration found after OAuth!');\n\t\t\t}\n\t\t},\n\t\t[setUserToken]\n\t);\n\n\t/**\n\t * Handle continue from user token success page\n\t */\n\tconst handleContinueAfterUserLogin = useCallback(() => {\n\t\tconsole.log(\n\t\t\t'[UNIFIED-FLOW] User clicked continue after login, proceeding with registration...'\n\t\t);\n\n\t\tconst pending = pendingRegistrationRef.current;\n\t\tif (pending && userToken) {\n\t\t\tconst { deviceType: pendingDeviceType, fields, flowType, props } = pending;\n\t\t\tpendingRegistrationRef.current = null;\n\n\t\t\t// Hide success page\n\t\t\tsetShowUserTokenSuccess(false);\n\n\t\t\t// Continue with registration\n\t\t\tsetTimeout(() => {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Now executing performRegistrationWithToken...');\n\t\t\t\tperformRegistrationWithToken(props, pendingDeviceType, fields, flowType, userToken);\n\t\t\t}, 100);\n\t\t}\n\t}, [userToken, performRegistrationWithToken]);\n\n\t/**\n\t * Perform device registration API call\n\t * Checks if User Flow needs OAuth first, otherwise proceeds with registration\n\t */\n\tconst performRegistration = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== DEVICE REGISTRATION SUBMITTED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current userToken:', userToken ? 'Present' : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\n\t\t\t// CRITICAL: Validate worker token before allowing any registration\n\t\t\tif (!workerToken.tokenStatus.isValid) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Cannot proceed - no valid worker token');\n\t\t\t\ttoastV8.error(\n\t\t\t\t\t'‚ùå Worker token required for device registration. Please configure worker token credentials first.',\n\t\t\t\t\t{\n\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// For User Flow, check if we need OAuth authentication first\n\t\t\tif (flowType === 'user' && !userToken) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] User flow selected but no token - showing OAuth modal');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Storing pending registration...');\n\n\t\t\t\t// Store pending registration data\n\t\t\t\tpendingRegistrationRef.current = {\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tfields,\n\t\t\t\t\tflowType,\n\t\t\t\t\tprops,\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending registration stored:', pendingRegistrationRef.current);\n\n\t\t\t\t// Set return target for device registration flow\n\t\t\t\tReturnTargetServiceV8U.setReturnTarget(\n\t\t\t\t\t'mfa_device_registration',\n\t\t\t\t\t'/v8/unified-mfa',  // Return to unified MFA flow\n\t\t\t\t\t2  // Step 2: Device Selection\n\t\t\t\t);\n\n\t\t\t\t// Show the user login modal\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'üîê User Flow requires PingOne authentication. Please complete the login to continue with device registration.',\n\t\t\t\t\t{ duration: 6000 }\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t'[UNIFIED-FLOW] Proceeding directly with registration (token exists or admin flow)'\n\t\t\t);\n\t\t\t// Proceed with registration (using existing token for user flow)\n\t\t\tawait performRegistrationWithToken(\n\t\t\t\tprops,\n\t\t\t\tselectedDeviceType,\n\t\t\t\tfields,\n\t\t\t\tflowType,\n\t\t\t\tuserToken || undefined\n\t\t\t);\n\t\t},\n\t\t[workerToken.tokenStatus.isValid, userToken]\n\t);\n\n\t/**\n\t * Render Step 0: Configuration (environment, user, policy)\n\t */\n\tconst renderStep0 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn (\n\t\t\t\t<UnifiedDeviceRegistrationForm\n\t\t\t\t\tinitialDeviceType={deviceType}\n\t\t\t\t\tonSubmit={async (selectedDeviceType, fields, flowType) => {\n\t\t\t\t\t\tawait performRegistration(props, selectedDeviceType, fields, flowType);\n\t\t\t\t\t}}\n\t\t\t\t\tonCancel={() => {\n\t\t\t\t\t\tif (onCancel) onCancel();\n\t\t\t\t\t}}\n\t\t\t\t\ttokenStatus={props.tokenStatus}\n\t\t\t\t\tusername={props.credentials.username}\n\t\t\t\t/>\n\t\t\t);\n\t\t},\n\t\t[deviceType, onCancel, performRegistration]\n\t);\n\n\t/**\n\t * Render Step 1: User Login using Authorization Code Flow with PKCE\n\t */\n\tconst renderStep1 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <UserLoginStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 2: Device Selection (option to call registration if want new device, or have no devices)\n\t */\n\tconst renderStep2 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 3: Device-Specific Actions (OTP/QR Generation, FIDO, Mobile Push)\n\t */\n\tconst renderStep3 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific based on the device type\n\t\t\t// For now, return the activation step which handles device-specific logic\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 4: OTP Validation / Confirmation\n\t */\n\tconst renderStep4 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific validation\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 5: API Documentation\n\t */\n\tconst renderStep5 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <APIDocsStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 6: Success screen with all user data and other valuable options\n\t */\n\tconst renderStep6 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <SuccessStepV8 renderProps={props} />;\n\t}, []);\n\n\t// Step labels for device authentication flow\n\tconst stepLabels = useMemo(() => {\n\t\tif (deviceType === 'FIDO2') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Start FIDO in Browser',\n\t\t\t\t'Passkey confirmation',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else if (deviceType === 'MOBILE') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Push to Mobile App',\n\t\t\t\t'User Confirms on Mobile',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else {\n\t\t\t// SMS, Email, TOTP, WhatsApp\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Generate OTP/QR',\n\t\t\t\t'Validate OTP',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t}\n\t}, [deviceType]);\n\n\tconst shouldHideNextButton = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\tif (props.nav.currentStep === 0) {\n\t\t\treturn true; // Hide Next button on configuration step, use form submit\n\t\t}\n\t\tif (props.nav.currentStep === 1) {\n\t\t\treturn true; // Hide Next button on user login step, use authentication button\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\treturn (\n\t\t<>\n\t\t\t<MFAFlowBaseV8\n\t\t\t\tdeviceType={deviceType}\n\t\t\t\trenderStep0={renderStep0}\n\t\t\t\trenderStep1={renderStep1}\n\t\t\t\trenderStep2={renderStep2}\n\t\t\t\trenderStep3={renderStep3}\n\t\t\t\trenderStep4={renderStep4}\n\t\t\t\trenderStep5={renderStep5}\n\t\t\t\trenderStep6={renderStep6}\n\t\t\t\tvalidateStep0={validateStep0}\n\t\t\t\tstepLabels={stepLabels}\n\t\t\t\tshouldHideNextButton={shouldHideNextButton}\n\t\t\t\tflowType=\"device-auth\"\n\t\t\t/>\n\t\t\t<div style={{ height: '300px' }} />\n\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\n\t\t\t{/* User Login Modal for User Flow OAuth */}\n\t\t\t<UserLoginModalV8\n\t\t\t\tisOpen={showUserLoginModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\t\tpendingRegistrationRef.current = null;\n\t\t\t\t}}\n\t\t\t\tonTokenReceived={handleUserTokenReceived}\n\t\t\t\tenvironmentId={envIdForModal}\n\t\t\t/>\n\n\t\t\t{/* User Token Success Page - Show token after OAuth login */}\n\t\t\t{showUserTokenSuccess && userTokenForDisplay && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 10000,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\t\t\tboxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Success Header */}\n\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\twidth: '64px',\n\t\t\t\t\t\t\t\t\theight: '64px',\n\t\t\t\t\t\t\t\t\tborderRadius: '50%',\n\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>‚úÖ</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<h2 style={{ margin: '0 0 8px 0', fontSize: '24px', color: '#1f2937' }}>\n\t\t\t\t\t\t\t\tAuthentication Successful!\n\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\tYour user token has been obtained and is ready to use.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Username Dropdown */}\n\t\t\t\t\t\t{usernameFromToken && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUsernameDropdown(!showUsernameDropdown)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tpadding: 0,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: showUsernameDropdown ? '12px' : 0,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '16px', color: '#374151' }}>Username</h3>\n\t\t\t\t\t\t\t\t\t{showUsernameDropdown ? (\n\t\t\t\t\t\t\t\t\t\t<FiChevronUp size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t<FiChevronDown size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{showUsernameDropdown && (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{usernameFromToken}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(usernameFromToken);\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('Username copied to clipboard!');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüìã Copy Username\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Token Display */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<h3 style={{ margin: '0 0 12px 0', fontSize: '16px', color: '#374151' }}>\n\t\t\t\t\t\t\t\tUser Access Token\n\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{userTokenForDisplay}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(userTokenForDisplay);\n\t\t\t\t\t\t\t\t\ttoastV8.success('Token copied to clipboard!');\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüìã Copy Token\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Next Steps Info */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#eff6ff',\n\t\t\t\t\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#1e40af', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t<strong>Next:</strong> Click \"Continue with Registration\" to proceed with your{' '}\n\t\t\t\t\t\t\t\t{config.displayName} device registration using this user token.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Continue Button */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleContinueAfterUserLogin}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\tbackground: '#10b981',\n\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tboxShadow: '0 2px 8px rgba(16, 185, 129, 0.3)',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tContinue with Registration ‚Üí\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</>\n\t);\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default UnifiedMFARegistrationFlowV8;\n"},"tags":["fixable"],"source":null},{"category":"format","severity":"error","description":"Formatter would have printed the following content:","message":[{"elements":[],"content":"Formatter would have printed the following content:"}],"advices":{"advices":[{"diff":{"dictionary":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\t\t\t\tenvironmentId,\n\t\t\t});\n\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(\n\t\t\t\tnew CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId, username: currentCreds.username },}));\n\t\t}\n\t}, [environmentId]);\t\t\t\tusername,\n\t\t\t});\ndetail: { environmentId: currentCreds.environmentId, username });\n\t\t}\n\t}, [username]);\t\t// For admin flow, check if we have a valid worker token before proceeding\n\t\tif (flowType === 'admin' && !hasWorkerToken) {\n\t\t\ttoastV8.error('Admin flow requires a valid worker token. Please generate a worker token first.');\n\t\t\treturn;\n\t\t}\t\t\t\t\t\t\t\t`${config.displayName} device registered! OTP has been sent automatically.`\n\t\t\t\t\t\t\t);\n  // DO NOT auto-advance for OTP-required devices\n\t\t\t\t\t\t\t// User should manually click Next after receiving OTP\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`${MODULE_TAG} Device requires OTP activation - waiting for user to proceed manually`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Unknown status, proceed with flow-specific navigation\t\t\t\tReturnTargetServiceV8U.setReturnTarget(\n\t\t\t\t\t'mfa_device_registration',\n\t\t\t\t\t'/v8/unified-mfa',// Return to unified MFA flow\n\t\t\t\t\t2// Step 2: Device Selection\n\t\t\t\t);\n\nexport default UnifiedMFARegistrationFlowV8;\n","ops":[{"diffOp":{"equal":{"range":[0,73]}}},{"equalLines":{"line_count":336}},{"diffOp":{"equal":{"range":[73,99]}}},{"diffOp":{"delete":{"range":[73,76]}}},{"diffOp":{"equal":{"range":[99,209]}}},{"diffOp":{"insert":{"range":[209,214]}}},{"diffOp":{"equal":{"range":[214,261]}}},{"diffOp":{"insert":{"range":[73,74]}}},{"diffOp":{"equal":{"range":[261,319]}}},{"diffOp":{"insert":{"range":[319,320]}}},{"diffOp":{"equal":{"range":[99,103]}}},{"diffOp":{"insert":{"range":[73,74]}}},{"diffOp":{"equal":{"range":[320,322]}}},{"diffOp":{"insert":{"range":[99,103]}}},{"diffOp":{"equal":{"range":[322,350]}}},{"equalLines":{"line_count":18}},{"diffOp":{"equal":{"range":[350,371]}}},{"diffOp":{"delete":{"range":[350,353]}}},{"diffOp":{"equal":{"range":[99,209]}}},{"diffOp":{"insert":{"range":[209,214]}}},{"diffOp":{"equal":{"range":[214,261]}}},{"diffOp":{"insert":{"range":[350,351]}}},{"diffOp":{"equal":{"range":[371,434]}}},{"diffOp":{"insert":{"range":[319,320]}}},{"diffOp":{"equal":{"range":[99,103]}}},{"diffOp":{"insert":{"range":[350,351]}}},{"diffOp":{"equal":{"range":[320,322]}}},{"diffOp":{"insert":{"range":[99,103]}}},{"diffOp":{"equal":{"range":[434,457]}}},{"equalLines":{"line_count":23}},{"diffOp":{"equal":{"range":[457,600]}}},{"diffOp":{"insert":{"range":[209,214]}}},{"diffOp":{"equal":{"range":[600,681]}}},{"diffOp":{"insert":{"range":[99,103]}}},{"diffOp":{"equal":{"range":[681,698]}}},{"equalLines":{"line_count":1898}},{"diffOp":{"equal":{"range":[698,792]}}},{"diffOp":{"delete":{"range":[792,794]}}},{"diffOp":{"insert":{"range":[698,705]}}},{"diffOp":{"equal":{"range":[794,923]}}},{"diffOp":{"insert":{"range":[923,932]}}},{"diffOp":{"equal":{"range":[932,1017]}}},{"diffOp":{"insert":{"range":[923,931]}}},{"diffOp":{"equal":{"range":[1017,1098]}}},{"equalLines":{"line_count":156}},{"diffOp":{"equal":{"range":[1098,1197]}}},{"diffOp":{"delete":{"range":[792,794]}}},{"diffOp":{"insert":{"range":[792,793]}}},{"diffOp":{"equal":{"range":[1197,1233]}}},{"diffOp":{"delete":{"range":[792,794]}}},{"diffOp":{"insert":{"range":[792,793]}}},{"diffOp":{"equal":{"range":[1233,1268]}}},{"equalLines":{"line_count":394}},{"diffOp":{"equal":{"range":[1268,1314]}}}]}}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/UnifiedMFARegistrationFlowV8_Legacy.tsx"},"span":null,"sourceCode":"/**\n * @file UnifiedMFARegistrationFlowV8.tsx\n * @module v8/flows/unified\n * @description Unified MFA Registration Flow - Single component for all 6 device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Replace 6 device-specific flow components (SMS, Email, Mobile, WhatsApp, TOTP, FIDO2)\n * with a single configurable component using deviceFlowConfigs for device-specific behavior.\n *\n * Architecture:\n * - Configuration-driven using deviceFlowConfigs.ts\n * - Dynamic form rendering for simple devices (SMS, Email, WhatsApp)\n * - Custom components for complex devices (TOTP, FIDO2, Mobile)\n * - Integrates with MFACredentialContext and useWorkerToken hook\n * - Uses existing MFAFlowBaseV8 for 5-step framework\n *\n * @example\n * <UnifiedMFARegistrationFlowV8\n *   deviceType=\"SMS\"\n *   onSuccess={(result) => console.log('Device registered:', result.deviceId)}\n * />\n */\n\nimport * as React from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { FiChevronDown, FiChevronUp } from 'react-icons/fi';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { MFAHeaderV8 } from '@/v8/components/MFAHeaderV8';\nimport type { SearchableDropdownOption } from '@/v8/components/SearchableDropdownV8';\nimport { SearchableDropdownV8 } from '@/v8/components/SearchableDropdownV8';\nimport { SQLiteStatsDisplayV8 } from '@/v8/components/SQLiteStatsDisplayV8';\nimport { SuperSimpleApiDisplayV8 } from '@/v8/components/SuperSimpleApiDisplayV8';\nimport { UserLoginModalV8 } from '@/v8/components/UserLoginModalV8';\nimport { getDeviceConfig } from '@/v8/config/deviceFlowConfigs';\nimport type { DeviceConfigKey, DeviceRegistrationResult } from '@/v8/config/deviceFlowConfigTypes';\nimport { PING_IDENTITY_COLORS } from '@/v8/constants/pingIdentityColors';\nimport { GlobalMFAProvider } from '@/v8/contexts/GlobalMFAContext';\nimport { MFACredentialProvider } from '@/v8/contexts/MFACredentialContext';\nimport { APIDocsStepV8 } from '@/v8/flows/shared/APIDocsStepV8';\nimport { SuccessStepV8 } from '@/v8/flows/shared/SuccessStepV8';\nimport { UserLoginStepV8 } from '@/v8/flows/shared/UserLoginStepV8';\nimport { useMFAPolicies } from '@/v8/hooks/useMFAPolicies';\nimport { useStepNavigationV8 } from '@/v8/hooks/useStepNavigationV8';\nimport { useUserSearch } from '@/v8/hooks/useUserSearch';\nimport { useWorkerToken } from '@/v8/hooks/useWorkerToken';\nimport { CredentialsServiceV8 } from '@/v8/services/credentialsServiceV8';\nimport { globalEnvironmentService } from '@/v8/services/globalEnvironmentService';\nimport { MfaAuthenticationServiceV8 } from '@/v8/services/mfaAuthenticationServiceV8';\nimport { type MFAFeatureFlag, MFAFeatureFlagsV8 } from '@/v8/services/mfaFeatureFlagsV8';\nimport MFAServiceV8_Legacy, { type RegisterDeviceParams } from '@/v8/services/mfaServiceV8_Legacy';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport type { TokenStatusInfo } from '@/v8/services/workerTokenStatusServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { ReturnTargetServiceV8U } from '@/v8u/services/returnTargetServiceV8U';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type MFAFlowBaseRenderProps, MFAFlowBaseV8 } from '../shared/MFAFlowBaseV8';\nimport type { DeviceAuthenticationPolicy, MFACredentials, MFAState } from '../shared/MFATypes';\nimport { UnifiedActivationStep } from './components/UnifiedActivationStep';\nimport { UnifiedDeviceRegistrationForm } from './components/UnifiedDeviceRegistrationForm';\nimport { UnifiedDeviceSelectionModal } from './components/UnifiedDeviceSelectionModal';\nimport { UnifiedSuccessStep } from './components/UnifiedSuccessStep';\nimport './UnifiedMFAFlow.css';\n\nconst MODULE_TAG = '[üîÑ UNIFIED-MFA-FLOW-V8]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedMFARegistrationFlowV8Props {\n\t/** Device type to render (optional - can be provided via navigation state) */\n\tdeviceType?: DeviceConfigKey;\n\n\t/** Optional initial credentials (for pre-filled forms) */\n\tinitialCredentials?: Partial<MFACredentials>;\n\n\t/** Optional callback when registration succeeds */\n\tonSuccess?: (result: DeviceRegistrationResult) => void;\n\n\t/** Optional callback when user cancels flow */\n\tonCancel?: () => void;\n\n\t/** Optional initial step (defaults to 0) */\n\tinitialStep?: number;\n\n\t/** Optional: Skip configuration step if already configured */\n\tskipConfiguration?: boolean;\n\n\t/** Optional: Force specific registration flow type */\n\tregistrationFlowType?: 'admin-active' | 'admin-activation' | 'user';\n}\n\n// ============================================================================\n// MFA FLOW SELECTION SCREEN\n// ============================================================================\n\ntype FlowMode = 'registration' | 'authentication';\n\n/** Map device types to their feature flags */\nconst DEVICE_FLAG_MAP: Record<DeviceConfigKey, MFAFeatureFlag> = {\n\tSMS: 'mfa_unified_sms',\n\tEMAIL: 'mfa_unified_email',\n\tMOBILE: 'mfa_unified_mobile',\n\tWHATSAPP: 'mfa_unified_whatsapp',\n\tTOTP: 'mfa_unified_totp',\n\tFIDO2: 'mfa_unified_fido2',\n};\n\nconst DEVICE_TYPES: { key: DeviceConfigKey; icon: string; name: string; description: string }[] = [\n\t{ key: 'SMS', icon: 'üì±', name: 'SMS', description: 'Receive OTP codes via text message' },\n\t{ key: 'EMAIL', icon: '‚úâÔ∏è', name: 'Email', description: 'Receive OTP codes via email' },\n\t{\n\t\tkey: 'TOTP',\n\t\ticon: 'üîê',\n\t\tname: 'Authenticator App (TOTP)',\n\t\tdescription: 'Use Google Authenticator, Authy, or similar',\n\t},\n\t{\n\t\tkey: 'MOBILE',\n\t\ticon: 'üì≤',\n\t\tname: 'Mobile Push',\n\t\tdescription: 'Receive push notifications on your phone',\n\t},\n\t{ key: 'WHATSAPP', icon: 'üí¨', name: 'WhatsApp', description: 'Receive OTP codes via WhatsApp' },\n\t{\n\t\tkey: 'FIDO2',\n\t\ticon: 'üîë',\n\t\tname: 'Security Key (FIDO2)',\n\t\tdescription: 'Use a hardware security key or passkey',\n\t},\n];\n\n/** Check if a device type is enabled via feature flags */\nconst isDeviceEnabled = (deviceKey: DeviceConfigKey): boolean => {\n\tconst flag = DEVICE_FLAG_MAP[deviceKey];\n\treturn MFAFeatureFlagsV8.isEnabled(flag);\n};\n\ninterface DeviceTypeSelectionScreenProps {\n\tonSelectDeviceType: (deviceType: DeviceConfigKey) => void;\n\tuserToken?: string | null;\n\tsetUserToken: (token: string | null) => void;\n}\n\nconst DeviceTypeSelectionScreen: React.FC<DeviceTypeSelectionScreenProps> = ({\n\tonSelectDeviceType,\n\tuserToken,\n\tsetUserToken,\n}) => {\n\tconst [flowMode, setFlowMode] = useState<FlowMode | null>(null);\n\tconst [environmentId, setEnvironmentId] = useState('');\n\tconst [username, setUsername] = useState('');\n\tconst [showDeviceSelectionModal, setShowDeviceSelectionModal] = useState(false);\n\tconst [showOTPModal, setShowOTPModal] = useState(false);\n\tconst [otpCode, setOtpCode] = useState('');\n\tconst [authenticationId, setAuthenticationId] = useState<string | null>(null);\n\tconst [selectedAuthDevice, setSelectedAuthDevice] = useState<{\n\t\tid: string;\n\t\ttype: string;\n\t\tnickname?: string;\n\t} | null>(null);\n\tconst [customLogoUrl, setCustomLogoUrl] = useState<string>('');\n\tconst [showAuthLoginModal, setShowAuthLoginModal] = useState(false);\n\tconst authEnvIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Load uploaded logo from localStorage on mount\n\tuseEffect(() => {\n\t\ttry {\n\t\t\tconst savedUpload = localStorage.getItem('custom-logo-upload');\n\t\t\tif (savedUpload) {\n\t\t\t\tconst uploadData = JSON.parse(savedUpload);\n\t\t\t\t// Handle both old format (objectUrl) and new format (base64Url)\n\t\t\t\tif (uploadData.base64Url) {\n\t\t\t\t\tsetCustomLogoUrl(uploadData.base64Url);\n\t\t\t\t} else if (uploadData.objectUrl) {\n\t\t\t\t\t// Old format - try to convert if possible, otherwise clear it\n\t\t\t\t\tconsole.warn('Old logo format detected - please re-upload your logo');\n\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load uploaded logo from localStorage:', error);\n\t\t\t// Clear corrupted data\n\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t}\n\t}, []);\n\n\t// Use worker token hook for token management\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Extract environment ID from worker token when available\n\tuseEffect(() => {\n\t\tconst extractEnvironmentId = async () => {\n\t\t\ttry {\n\t\t\t\tconst token = await workerTokenServiceV8.getToken();\n\t\t\t\tif (token && !environmentId) {\n\t\t\t\t\tconst parts = token.split('.');\n\t\t\t\t\tif (parts.length === 3) {\n\t\t\t\t\t\tconst payload = JSON.parse(atob(parts[1]));\n\t\t\t\t\t\tif (payload.environmentId) {\n\t\t\t\t\t\t\tsetEnvironmentId(payload.environmentId);\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`${MODULE_TAG} Environment ID extracted from worker token:`,\n\t\t\t\t\t\t\t\tpayload.environmentId\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Failed to extract environment ID from worker token:`, error);\n\t\t\t}\n\t\t};\n\n\t\textractEnvironmentId();\n\t}, [environmentId]);\n\n\tconst hasWorkerToken = workerToken.tokenStatus.isValid;\n\n\t// Use user search hook for user fetching and search\n\tconst {\n\t\tusers,\n\t\tisLoading: isLoadingUsers,\n\t\tsetSearchQuery,\n\t} = useUserSearch({\n\t\tenvironmentId,\n\t\ttokenValid: workerToken.tokenStatus.isValid,\n\t\tmaxPages: 100,\n\t\tuseCache: true,\n\t});\n\tconst tokenStatus = workerToken.tokenStatus;\n\n\t// Debug: Log users type to understand the issue\n\tuseEffect(() => {\n\t\tconsole.log(`${MODULE_TAG} users type check:`, {\n\t\t\tusers,\n\t\t\tisArray: Array.isArray(users),\n\t\t\ttype: typeof users,\n\t\t\tconstructor: users?.constructor?.name,\n\t\t});\n\t}, [users]);\n\n\t// Load Environment ID and username from global services on mount\n\tuseEffect(() => {\n\t\t// Initialize the service first to load from localStorage\n\t\tglobalEnvironmentService.initialize();\n\t\tconst savedEnvId = globalEnvironmentService.getEnvironmentId();\n\t\tif (savedEnvId) {\n\t\t\tsetEnvironmentId(savedEnvId);\n\t\t}\n\n\t\t// Load username from localStorage\n\t\tconst savedUsername = localStorage.getItem('mfa_unified_username');\n\t\tif (savedUsername) {\n\t\t\tsetUsername(savedUsername);\n\t\t}\n\t}, []);\n\n\t// Use MFA policies hook\n\tconst {\n\t\tpolicies,\n\t\tselectedPolicy,\n\t\tisLoading: isPoliciesLoading,\n\t\terror: policiesError,\n\t\tselectPolicy,\n\t\tdefaultPolicy,\n\t} = useMFAPolicies({\n\t\tenvironmentId,\n\t\ttokenIsValid: tokenStatus.isValid,\n\t\tautoLoad: true,\n\t\tautoSelectSingle: true,\n\t});\n\n\tconst selectedPolicyRef = useRef<DeviceAuthenticationPolicy | null>(null);\n\tuseEffect(() => {\n\t\tselectedPolicyRef.current = selectedPolicy ?? null;\n\t}, [selectedPolicy]);\n\n\tconst isPolicyDeviceEnabled = useCallback(\n\t\t(policy: DeviceAuthenticationPolicy | null, key: string) => {\n\t\t\tconst deviceConfig = policy?.[key] as { enabled?: boolean } | undefined;\n\t\t\treturn !!deviceConfig?.enabled;\n\t\t},\n\t\t[]\n\t);\n\n\tconst policyOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tpolicies.map((policy) => ({\n\t\t\t\tvalue: policy.id,\n\t\t\t\tlabel: policy.name,\n\t\t\t\t...(policy.default ? { secondaryLabel: '(Default)' } : {}),\n\t\t\t})),\n\t\t[policies]\n\t);\n\n\tconst userOptions: SearchableDropdownOption[] = useMemo(\n\t\t() =>\n\t\t\tArray.from(\n\t\t\t\tnew Map(\n\t\t\t\t\t(Array.isArray(users) ? users : []).map((user) => [\n\t\t\t\t\t\tuser.username,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvalue: user.username,\n\t\t\t\t\t\t\tlabel: user.username,\n\t\t\t\t\t\t\t...(user.email ? { secondaryLabel: user.email } : {}),\n\t\t\t\t\t\t} as SearchableDropdownOption,\n\t\t\t\t\t])\n\t\t\t\t).values()\n\t\t\t),\n\t\t[users]\n\t);\n\n\t// Auto-select default policy when policies load\n\tuseEffect(() => {\n\t\tif (defaultPolicy && !selectedPolicy) {\n\t\t\tselectPolicy(defaultPolicy.id);\n\t\t}\n\t}, [defaultPolicy, selectedPolicy, selectPolicy]);\n\n\t// Sync environment ID to global service and CredentialsServiceV8 when it changes\n\tuseEffect(() => {\n\t\tif (environmentId) {\n\t\t\tglobalEnvironmentService.setEnvironmentId(environmentId);\n\t\t\tlocalStorage.setItem('mfa_environmentId', environmentId);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tenvironmentId,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId, username: currentCreds.username }\n\t\t\t}));\n\t\t}\n\t}, [environmentId]);\n\n\t// Save username to localStorage and CredentialsServiceV8 when it changes\n\t// This ensures MFAFlowBase can read the username from its expected storage location\n\tuseEffect(() => {\n\t\tif (username) {\n\t\t\tlocalStorage.setItem('mfa_unified_username', username);\n\t\t\tlocalStorage.setItem('mfa_username', username);\n\t\t\t// Also save to CredentialsServiceV8 for MFAFlowBase to read\n\t\t\tconst currentCreds = CredentialsServiceV8.loadCredentials('mfa-flow-v8', {\n\t\t\t\tflowKey: 'mfa-flow-v8',\n\t\t\t\tflowType: 'oidc',\n\t\t\t\tincludeClientSecret: false,\n\t\t\t\tincludeRedirectUri: false,\n\t\t\t\tincludeLogoutUri: false,\n\t\t\t\tincludeScopes: false,\n\t\t\t});\n\t\t\tCredentialsServiceV8.saveCredentials('mfa-flow-v8', {\n\t\t\t\t...currentCreds,\n\t\t\t\tusername,\n\t\t\t});\n\t\t\t\n\t\t\t// Dispatch credential update event for other components (like device management)\n\t\t\twindow.dispatchEvent(new CustomEvent('mfaCredentialsUpdated', {\n\t\t\t\tdetail: { environmentId: currentCreds.environmentId, username }\n\t\t\t}));\n\t\t}\n\t}, [username]);\n\n\t// Handle device selection for authentication\n\tconst handleDeviceSelectForAuthentication = async (device: {\n\t\tid: string;\n\t\ttype: string;\n\t\tdeviceName?: string;\n\t\tnickname?: string;\n\t}) => {\n\t\tconsole.log(`${MODULE_TAG} Selected device for authentication:`, device);\n\t\tsetShowDeviceSelectionModal(false);\n\t\tsetSelectedAuthDevice(device);\n\n\t\tconst policyId = selectedPolicy?.id;\n\t\tif (!policyId) {\n\t\t\ttoastV8.error('Please select an MFA Policy first');\n\t\t\treturn;\n\t\t}\n\n\t\t// Determine flow type and token\n\t\t// Admin flows should use worker tokens, not require user tokens\n\t\tconst flowType = userToken ? 'user' : 'admin';\n\t\tconst effectiveUserToken = flowType === 'user' ? userToken : undefined;\n\n\t\t// For admin flow, check if we have a valid worker token before proceeding\n\t\tif (flowType === 'admin' && !hasWorkerToken) {\n\t\t\ttoastV8.error('Admin flow requires a valid worker token. Please generate a worker token first.');\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\t// Initialize authentication with appropriate token\n\t\t\tconst response = await MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\tenvironmentId,\n\t\t\t\tusername: username.trim(),\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t\tdeviceId: device.id,\n\t\t\t\tregion: 'na',\n\t\t\t\ttokenType: flowType,\n\t\t\t\t...(effectiveUserToken && { userToken: effectiveUserToken }),\n\t\t\t});\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth initialized - full response:`, response);\n\t\t\tsetAuthenticationId(response.id);\n\n\t\t\tconst status = (response.status || '').toUpperCase();\n\t\t\tconst nextStep = (response.nextStep || '').toUpperCase();\n\t\t\tconst links = response._links as Record<string, { href?: string }> | undefined;\n\t\t\tconst hasOtpLink = !!(\n\t\t\t\tlinks &&\n\t\t\t\t(links.otp || links['otp.check'] || (links as Record<string, unknown>)['checkOtp'])\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Auth status:`, {\n\t\t\t\tstatus,\n\t\t\t\tnextStep,\n\t\t\t\thasOtpLink,\n\t\t\t\tdeviceType: device.type,\n\t\t\t});\n\n\t\t\t// Show appropriate UI based on response (normalize status/nextStep for PingOne variants)\n\t\t\tif (status === 'OTP_REQUIRED' || nextStep === 'OTP_REQUIRED' || hasOtpLink) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Opening OTP modal for device:`, device.type);\n\t\t\t\tsetShowOTPModal(true);\n\t\t\t\ttoastV8.success(`Verification code sent to your ${device.type} device`);\n\t\t\t} else if (status === 'ASSERTION_REQUIRED' || nextStep === 'ASSERTION_REQUIRED') {\n\t\t\t\tconsole.log(`${MODULE_TAG} FIDO2 assertion required`);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'FIDO2 authentication required. Please use /v8/mfa-config for FIDO2 authentication.'\n\t\t\t\t);\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'PUSH_CONFIRMATION_REQUIRED' ||\n\t\t\t\tnextStep === 'PUSH_CONFIRMATION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Push confirmation required`);\n\t\t\t\ttoastV8.success('Push notification sent! Please approve on your mobile device.');\n\t\t\t\ttoastV8.info('Complete authentication at /v8/mfa-config for push polling.');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (status === 'COMPLETED') {\n\t\t\t\ttoastV8.success('Authentication completed successfully!');\n\t\t\t\tsetFlowMode(null);\n\t\t\t} else if (\n\t\t\t\tstatus === 'DEVICE_SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'SELECTION_REQUIRED' ||\n\t\t\t\tnextStep === 'DEVICE_SELECTION_REQUIRED'\n\t\t\t) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Device selection required - showing modal again`);\n\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t} else {\n\t\t\t\tconsole.warn(`${MODULE_TAG} Unexpected authentication status:`, {\n\t\t\t\t\tstatus,\n\t\t\t\t\tnextStep,\n\t\t\t\t\tresponse,\n\t\t\t\t});\n\t\t\t\ttoastV8.info(`Authentication status: ${status || nextStep || 'UNKNOWN'}`);\n\t\t\t\t// Stay in authentication flow so user can try another device\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to initialize authentication:`, error);\n\n\t\t\t// Enhanced error handling for NO_USABLE_DEVICES\n\t\t\tlet errorMessage = 'Authentication failed: ';\n\t\t\tif (error instanceof Error) {\n\t\t\t\tconst errorStr = error.message.toLowerCase();\n\n\t\t\t\t// Check for NO_USABLE_DEVICES or device availability errors\n\t\t\t\tif (\n\t\t\t\t\terrorStr.includes('no usable devices') ||\n\t\t\t\t\terrorStr.includes('too many') ||\n\t\t\t\t\terrorStr.includes('cooldown') ||\n\t\t\t\t\terrorStr.includes('blocked')\n\t\t\t\t) {\n\t\t\t\t\terrorMessage = '‚ö†Ô∏è Device Temporarily Unavailable\\n\\n';\n\n\t\t\t\t\tif (errorStr.includes('cooldown') || errorStr.includes('too many')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Too many notifications have been sent to this device. It is temporarily in cooldown. ';\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'Please wait a few minutes and try again, or select a different device.';\n\t\t\t\t\t} else if (errorStr.includes('blocked')) {\n\t\t\t\t\t\terrorMessage +=\n\t\t\t\t\t\t\t'This device has been blocked. Please contact your administrator or use a different device.';\n\t\t\t\t\t} else {\n\t\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\terrorMessage += error.message;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terrorMessage += 'Unknown error';\n\t\t\t}\n\n\t\t\ttoastV8.error(errorMessage, { duration: 8000 });\n\t\t\t// Do NOT set flowMode(null) - keep user in authentication flow so they can retry or select another device\n\t\t}\n\t};\n\n\t// Handle OTP verification\n\tconst handleVerifyOTP = async () => {\n\t\tif (!authenticationId || !selectedAuthDevice) {\n\t\t\ttoastV8.error('Authentication session not found');\n\t\t\treturn;\n\t\t}\n\n\t\tif (otpCode.length !== 6) {\n\t\t\ttoastV8.error('Please enter a 6-digit code');\n\t\t\treturn;\n\t\t}\n\n\t\t// Get worker token for API call\n\t\tconst workerTokenForOTP = await workerTokenServiceV8.getToken();\n\n\t\tconsole.log(`${MODULE_TAG} OTP verification debug:`, {\n\t\t\tenvironmentId,\n\t\t\tusername: username.trim(),\n\t\t\tauthenticationId,\n\t\t\totpCode,\n\t\t\thasEnvironmentId: !!environmentId,\n\t\t\tenvIdLength: environmentId?.length,\n\t\t\thasWorkerToken: !!workerTokenForOTP,\n\t\t\tworkerTokenLength: workerTokenForOTP?.length,\n\t\t});\n\n\t\ttry {\n\t\t\t// Use backend proxy to avoid CORS issues\n\t\t\tconst response = await fetch('/api/pingone/mfa/validate-otp-for-device', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tenvironmentId,\n\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\tdeviceAuthId: authenticationId,\n\t\t\t\t\totp: otpCode,\n\t\t\t\t\tregion: 'na',\n\t\t\t\t\tworkerToken: workerTokenForOTP,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\n\t\t\t\tthrow new Error(errorData.error || errorData.message || `HTTP ${response.status}`);\n\t\t\t}\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.status === 'COMPLETED' || result.status === 'completed') {\n\t\t\t\ttoastV8.success('‚úÖ Authentication completed successfully!');\n\t\t\t\tsetShowOTPModal(false);\n\t\t\t\tsetFlowMode(null);\n\t\t\t\tsetOtpCode('');\n\t\t\t} else {\n\t\t\t\ttoastV8.error('Invalid code. Please try again.');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} OTP verification failed:`, error);\n\t\t\ttoastV8.error(\n\t\t\t\t`Verification failed: ${error instanceof Error ? error.message : 'Unknown error'}`\n\t\t\t);\n\t\t}\n\t};\n\n\t// Step 1: Choose Registration or Authentication\n\tif (!flowMode) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '12px' }}>\n\t\t\t\t\t{/* Header */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tboxShadow: '0 4px 12px rgba(239, 68, 68, 0.2)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h1\n\t\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîê MFA Unified Flow\n\t\t\t\t\t\t</h1>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tChoose what you want to do with MFA devices.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Configuration Section */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 12px 0',\n\t\t\t\t\t\t\t\tfontSize: '18px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfiguration\n\t\t\t\t\t\t</h2>\n\n\t\t\t\t\t\t{/* Custom Logo URL */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-url\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[800],\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüé® Custom Logo URL (Optional)\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tDisplay a custom logo in the OTP verification modal\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t{/* URL Input */}\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tid=\"custom-logo-url\"\n\t\t\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\t\t\tvalue={customLogoUrl}\n\t\t\t\t\t\t\t\tonChange={(e) => setCustomLogoUrl(e.target.value)}\n\t\t\t\t\t\t\t\tplaceholder=\"https://example.com/logo.png\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\tpadding: '10px 14px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[900],\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = `0 0 0 3px ${PING_IDENTITY_COLORS.primary[200]}`;\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.neutral[300];\n\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* File Upload Section */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '13px', color: PING_IDENTITY_COLORS.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\tOR\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"file\"\n\t\t\t\t\t\t\t\t\tid=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\taccept=\"image/*\"\n\t\t\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\t\t\tconst file = e.target.files?.[0];\n\t\t\t\t\t\t\t\t\t\tif (!file) return;\n\n\t\t\t\t\t\t\t\t\t\t// Validate file type (images only)\n\t\t\t\t\t\t\t\t\t\tif (!file.type.startsWith('image/')) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Please select a logo file (JPG, PNG, etc.)');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Validate file size (max 5MB)\n\t\t\t\t\t\t\t\t\t\tif (file.size > 5 * 1024 * 1024) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('File size must be less than 5MB');\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// Convert file to base64 for persistence\n\t\t\t\t\t\t\t\t\t\tconst reader = new FileReader();\n\t\t\t\t\t\t\t\t\t\treader.onload = (event) => {\n\t\t\t\t\t\t\t\t\t\t\tconst base64Url = event.target?.result as string;\n\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl(base64Url);\n\n\t\t\t\t\t\t\t\t\t\t\t// Store base64 data for persistence\n\t\t\t\t\t\t\t\t\t\t\tconst uploadData = {\n\t\t\t\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\t\t\t\tbase64Url: base64Url,\n\t\t\t\t\t\t\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\t\t\t// Save to localStorage for persistence\n\t\t\t\t\t\t\t\t\t\t\tlocalStorage.setItem('custom-logo-upload', JSON.stringify(uploadData));\n\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.success(`Logo uploaded: ${file.name}`);\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.onerror = () => {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to read uploaded file');\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\treader.readAsDataURL(file);\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{ display: 'none' }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"custom-logo-upload\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.primary[500],\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.primary[600]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '500',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[700];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.primary[500];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = PING_IDENTITY_COLORS.primary[600];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìÅ Upload Logo File\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[500],\n\t\t\t\t\t\t\t\t\t\tmarginLeft: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tJPG, PNG, GIF (max 5MB)\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{customLogoUrl && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.neutral[50],\n\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: PING_IDENTITY_COLORS.neutral[600],\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tLogo Preview:\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\talt=\"Custom logo\"\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.neutral[200]}`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonError={() => {\n\t\t\t\t\t\t\t\t\t\t\t// Handle broken image URLs\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Failed to load custom logo URL');\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tsetCustomLogoUrl('');\n\t\t\t\t\t\t\t\t\t\t\t\t// Clear uploaded file from localStorage\n\t\t\t\t\t\t\t\t\t\t\t\tlocalStorage.removeItem('custom-logo-upload');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: PING_IDENTITY_COLORS.accent.pingRed[500],\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: `1px solid ${PING_IDENTITY_COLORS.accent.pingRed[600]}`,\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[600];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = PING_IDENTITY_COLORS.accent.pingRed[500];\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRemove Logo\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Environment ID - Hide when worker token is available */}\n\t\t\t\t\t\t{!hasWorkerToken && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\thtmlFor=\"env-id\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tEnvironment ID\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"env-id\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setEnvironmentId(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* SQLite Database Stats */}\n\t\t\t\t\t\t{environmentId && (\n\t\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t\t<SQLiteStatsDisplayV8\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tcompact={false}\n\t\t\t\t\t\t\t\t\trefreshInterval={30}\n\t\t\t\t\t\t\t\t\tshowRefreshButton={true}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Username */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUsername\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{environmentId && tokenStatus.isValid ? (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\toptions={userOptions}\n\t\t\t\t\t\t\t\t\tonChange={setUsername}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Type to search across 16,000+ users...\"\n\t\t\t\t\t\t\t\t\tisLoading={isLoadingUsers}\n\t\t\t\t\t\t\t\t\tonSearchChange={setSearchQuery}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setUsername(e.target.value)}\n\t\t\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '10px 12px',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* MFA Policy Dropdown */}\n\t\t\t\t\t\t<div style={{ marginBottom: '12px' }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\thtmlFor=\"mfa-policy\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tMFA Policy\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{isPoliciesLoading ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tLoading policies...\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policiesError ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#ef4444', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tError loading policies: {policiesError}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : policies.length === 0 ? (\n\t\t\t\t\t\t\t\t<div style={{ padding: '10px', color: '#6b7280', fontSize: '14px' }}>\n\t\t\t\t\t\t\t\t\tNo MFA policies found. Please check your environment ID and worker token.\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<SearchableDropdownV8\n\t\t\t\t\t\t\t\t\tid=\"mfa-policy\"\n\t\t\t\t\t\t\t\t\tvalue={selectedPolicy?.id || ''}\n\t\t\t\t\t\t\t\t\toptions={policyOptions}\n\t\t\t\t\t\t\t\t\tonChange={selectPolicy}\n\t\t\t\t\t\t\t\t\tplaceholder=\"Select an MFA policy...\"\n\t\t\t\t\t\t\t\t\tisLoading={isPoliciesLoading}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tSelect the MFA policy to use for device registration\n\t\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t\t{/* Policy Summary - Collapsible */}\n\t\t\t\t\t\t\t{selectedPolicy && (\n\t\t\t\t\t\t\t\t<details\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<summary\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\tuserSelect: 'none',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüìã Policy Details\n\t\t\t\t\t\t\t\t\t</summary>\n\t\t\t\t\t\t\t\t\t<div style={{ marginTop: '12px', fontSize: '13px', color: '#4b5563' }}>\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Policy Name:</strong> {String(selectedPolicy.name)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedPolicy.default && (\n\t\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px', color: '#059669' }}>\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>‚úì Default Policy</strong>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '8px' }}>\n\t\t\t\t\t\t\t\t\t\t\t<strong>Enabled Devices:</strong>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '6px' }}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'sms') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì± SMS\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'email') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t‚úâÔ∏è Email\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'totp') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîê TOTP\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'fido2') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüîë FIDO2\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'mobile') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüì≤ Mobile\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t{isPolicyDeviceEnabled(selectedPolicy, 'voice') && (\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#dbeafe',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#1e40af',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tüìû Voice\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</details>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Worker Token Status */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t\tpaddingRight: '16px',\n\t\t\t\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={setEnvironmentId}\n\t\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t\t{/* User Token Status */}\n\t\t\t\t\t\t\t{userToken && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\t'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05))',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #10b981',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<span style={{ fontSize: '20px' }}>üë§</span>\n\t\t\t\t\t\t\t\t\t\t<strong style={{ color: '#047857', fontSize: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t\tUser Token Active\n\t\t\t\t\t\t\t\t\t\t</strong>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: '14px', color: '#059669', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t\t‚úì User authentication token available\n\t\t\t\t\t\t\t\t\t\t<br />‚úì Ready for User Flow device registration\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Flow Mode Selection */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',\n\t\t\t\t\t\t\tgap: '16px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Registration Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => setFlowMode('registration')}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>‚ûï</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#047857',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Registration\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tRegister a new MFA device for a user. Create SMS, Email, TOTP, Mobile Push,\n\t\t\t\t\t\t\t\t\t\tWhatsApp, or FIDO2 devices.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t{/* Authentication Option */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tif (!userToken) {\n\t\t\t\t\t\t\t\t\tsetShowAuthLoginModal(true);\n\t\t\t\t\t\t\t\t\ttoastV8.info('üîê Please complete user login before device authentication.', {\n\t\t\t\t\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '20px 16px',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-4px)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 8px 24px rgba(59, 130, 246, 0.2)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '48px', lineHeight: 1 }}>üîì</span>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '20px',\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#1d4ed8',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tDevice Authentication\n\t\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t\t\tAuthenticate using an existing MFA device. Verify user identity with OTP, push\n\t\t\t\t\t\t\t\t\t\tnotification, or security key.\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{showAuthLoginModal && (\n\t\t\t\t\t<UserLoginModalV8\n\t\t\t\t\t\tisOpen={showAuthLoginModal}\n\t\t\t\t\t\tonClose={() => setShowAuthLoginModal(false)}\n\t\t\t\t\t\tonTokenReceived={(token) => {\n\t\t\t\t\t\t\tsetUserToken(token);\n\t\t\t\t\t\t\tsetShowAuthLoginModal(false);\n\t\t\t\t\t\t\tsetFlowMode('authentication');\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(true);\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tenvironmentId={authEnvIdForModal}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</>\n\t\t);\n\t}\n\n\t// Authentication flow - dedicated view (device selection + OTP modals only; no registration grid)\n\tif (flowMode === 'authentication') {\n\t\treturn (\n\t\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',\n\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\tsetSelectedAuthDevice(null);\n\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t‚Üê Back\n\t\t\t\t\t</button>\n\t\t\t\t\t<h1\n\t\t\t\t\t\tstyle={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}\n\t\t\t\t\t>\n\t\t\t\t\t\tüîì Device Authentication\n\t\t\t\t\t</h1>\n\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\t{selectedAuthDevice && !showOTPModal\n\t\t\t\t\t\t\t? `Authenticating with ${selectedAuthDevice.type} ‚Äî enter the code when prompted.`\n\t\t\t\t\t\t\t: `Select an MFA device to authenticate for ${username || 'the user'}`}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t\t{!showDeviceSelectionModal && !showOTPModal && (\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowDeviceSelectionModal(true)}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tSelect MFA device\n\t\t\t\t\t</button>\n\t\t\t\t)}\n\t\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\t\tonClose={() => {\n\t\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\t\t// Keep flowMode so user stays in auth flow; only clear if they click Back\n\t\t\t\t\t}}\n\t\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\t\tusername={username}\n\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t/>\n\t\t\t\t{showOTPModal && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.6)',\n\t\t\t\t\t\t\tbackdropFilter: 'blur(4px)',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t\t\tanimation: 'fadeIn 0.2s ease-out',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t{`\n\t\t\t\t\t\t\t@keyframes fadeIn {\n\t\t\t\t\t\t\t\tfrom { opacity: 0; }\n\t\t\t\t\t\t\t\tto { opacity: 1; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes slideUp {\n\t\t\t\t\t\t\t\tfrom { \n\t\t\t\t\t\t\t\t\topacity: 0;\n\t\t\t\t\t\t\t\t\ttransform: translateY(20px); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tto { \n\t\t\t\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t\t\t\t\ttransform: translateY(0); \n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t@keyframes pulse {\n\t\t\t\t\t\t\t\t0%, 100% { opacity: 1; }\n\t\t\t\t\t\t\t\t50% { opacity: 0.5; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`}\n\t\t\t\t\t\t</style>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\tborderRadius: '24px',\n\t\t\t\t\t\t\t\tpadding: '48px 40px',\n\t\t\t\t\t\t\t\tmaxWidth: '480px',\n\t\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\t\tboxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',\n\t\t\t\t\t\t\t\tanimation: 'slideUp 0.3s ease-out',\n\t\t\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Logo Area */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '32px' }}>\n\t\t\t\t\t\t\t\t{customLogoUrl ? (\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\t\tsrc={customLogoUrl}\n\t\t\t\t\t\t\t\t\t\t\talt=\"Organization logo\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmaxWidth: '120px',\n\t\t\t\t\t\t\t\t\t\t\t\tmaxHeight: '80px',\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tobjectFit: 'contain',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonError={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\t// Fallback to default icon if image fails to load\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.display = 'none';\n\t\t\t\t\t\t\t\t\t\t\t\tconst fallback = document.createElement('div');\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.style.cssText = `\n\t\t\t\t\t\t\t\t\t\t\t\twidth: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\theight: 80px;\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: 0 auto 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: 20px;\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: center;\n\t\t\t\t\t\t\t\t\t\t\t\tjustifyContent: center;\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: 36px;\n\t\t\t\t\t\t\t\t\t\t\t\tboxShadow: 0 10px 25px rgba(102, 126, 234, 0.3);\n\t\t\t\t\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t\t\t\t\t\t\tfallback.textContent = 'üîê';\n\t\t\t\t\t\t\t\t\t\t\t\te.currentTarget.parentElement!.appendChild(fallback);\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '80px',\n\t\t\t\t\t\t\t\t\t\t\theight: '80px',\n\t\t\t\t\t\t\t\t\t\t\tmargin: '0 auto 20px',\n\t\t\t\t\t\t\t\t\t\t\tbackground: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '20px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '36px',\n\t\t\t\t\t\t\t\t\t\t\tboxShadow: '0 10px 25px rgba(102, 126, 234, 0.3)',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\tüîê\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t<h2\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tVerification Code\n\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\tEnter the 6-digit code sent to your <strong>{selectedAuthDevice?.type}</strong>{' '}\n\t\t\t\t\t\t\t\t\tdevice\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* OTP Input */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\t\t\tplaceholder=\"‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢\"\n\t\t\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\tletterSpacing: '12px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\t\t\t\t\t\toutline: 'none',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow: otpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#3b82f6';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length > 0 ? '0 0 0 3px rgba(59, 130, 246, 0.1)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{otpCode.length > 0 && otpCode.length < 6 && (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '12px',\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\t\t\tanimation: 'pulse 2s ease-in-out infinite',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{6 - otpCode.length} more digit{6 - otpCode.length !== 1 ? 's' : ''} needed\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Resend Code Button */}\n\t\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={async () => {\n\t\t\t\t\t\t\t\t\t\tif (!selectedAuthDevice || !authenticationId) return;\n\t\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.info('Resending verification code...');\n\t\t\t\t\t\t\t\t\t\t\t// Re-initialize authentication to resend code\n\t\t\t\t\t\t\t\t\t\t\tconst response =\n\t\t\t\t\t\t\t\t\t\t\t\tawait MfaAuthenticationServiceV8.initializeDeviceAuthentication({\n\t\t\t\t\t\t\t\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\t\t\t\t\t\t\t\tusername: username.trim(),\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicy?.id || '',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdeviceId: selectedAuthDevice.id,\n\t\t\t\t\t\t\t\t\t\t\t\t\tregion: 'na',\n\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tif (response.status?.toUpperCase() === 'OTP_REQUIRED') {\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('New code sent to your device!');\n\t\t\t\t\t\t\t\t\t\t\t\tsetAuthenticationId(response.id);\n\t\t\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\t\t\t\ttoastV8.error('Failed to resend code');\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('Resend error:', error);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tcolor: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#eff6ff';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'transparent';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚Üª Resend Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Action Buttons */}\n\t\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#d1d5db';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f9fafb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = 'white';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6\n\t\t\t\t\t\t\t\t\t\t\t\t? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '#d1d5db',\n\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (otpCode.length === 6) {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow =\n\t\t\t\t\t\t\t\t\t\t\totpCode.length === 6 ? '0 4px 12px rgba(102, 126, 234, 0.4)' : 'none';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t‚úì Verify Code\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Help Text */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<strong style={{ color: '#111827' }}>Didn't receive the code?</strong>\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\tCheck your spam folder or click \"Resend Code\" above\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t);\n\t}\n\n\t// Registration flow - show device type selection cards\n\treturn (\n\t\t<div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>\n\t\t\t{/* Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #10b981 0%, #047857 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => setFlowMode(null)}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'rgba(255,255,255,0.2)',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\tpadding: '6px 12px',\n\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t‚Üê Back\n\t\t\t\t</button>\n\t\t\t\t<h1 style={{ margin: '0 0 8px 0', fontSize: '26px', fontWeight: '700', color: '#ffffff' }}>\n\t\t\t\t\t‚ûï Register MFA Device\n\t\t\t\t</h1>\n\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\tSelect a device type to register for {username || 'the user'}\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Device Type Cards */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'grid',\n\t\t\t\t\tgridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',\n\t\t\t\t\tgap: '16px',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t{DEVICE_TYPES.map((device) => {\n\t\t\t\t\tconst enabled = isDeviceEnabled(device.key);\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tkey={device.key}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={() => enabled && onSelectDeviceType(device.key)}\n\t\t\t\t\t\t\tdisabled={!enabled}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tbackground: enabled ? '#ffffff' : '#f9fafb',\n\t\t\t\t\t\t\t\tborder: `2px solid ${enabled ? '#e5e7eb' : '#f3f4f6'}`,\n\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\tcursor: enabled ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\topacity: enabled ? 1 : 0.5,\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#10b981';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ecfdf5';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-2px)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\tif (enabled) {\n\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>{device.icon}</span>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{device.name}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#6b7280' }}>{device.description}</p>\n\t\t\t\t\t\t\t{!enabled && (\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '12px', color: '#9ca3af' }}>\n\t\t\t\t\t\t\t\t\t(Not enabled)\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</div>\n\n\t\t\t{/* Device Selection Modal for Authentication */}\n\t\t\t<UnifiedDeviceSelectionModal\n\t\t\t\tisOpen={showDeviceSelectionModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowDeviceSelectionModal(false);\n\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t}}\n\t\t\t\tonDeviceSelect={handleDeviceSelectForAuthentication}\n\t\t\t\tusername={username}\n\t\t\t\tenvironmentId={environmentId}\n\t\t\t/>\n\n\t\t\t{/* OTP Modal for Authentication */}\n\t\t\t{showOTPModal && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 9999,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '400px',\n\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\tboxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '600' }}>\n\t\t\t\t\t\t\tEnter Verification Code\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '0 0 20px 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tCheck your {selectedAuthDevice?.type} device for the code\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={otpCode}\n\t\t\t\t\t\t\tonChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n\t\t\t\t\t\t\tplaceholder=\"000000\"\n\t\t\t\t\t\t\tmaxLength={6}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 16px',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t\t\tletterSpacing: '8px',\n\t\t\t\t\t\t\t\tborder: '2px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tmarginBottom: '20px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div style={{ display: 'flex', gap: '12px' }}>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tsetShowOTPModal(false);\n\t\t\t\t\t\t\t\t\tsetOtpCode('');\n\t\t\t\t\t\t\t\t\tsetFlowMode(null);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #d1d5db',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tCancel\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={handleVerifyOTP}\n\t\t\t\t\t\t\t\tdisabled={otpCode.length !== 6}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tbackground: otpCode.length === 6 ? '#3b82f6' : '#9ca3af',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\tcursor: otpCode.length === 6 ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tVerify\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n// ============================================================================\n// MAIN COMPONENT (WRAPPER)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Wrapper Component\n *\n * Wraps the content with MFACredentialProvider to provide global credential state\n */\nexport const UnifiedMFARegistrationFlowV8: React.FC<UnifiedMFARegistrationFlowV8Props> = (\n\tprops\n) => {\n\tconst location = useLocation();\n\n\t// Get device type from props or location state (can be undefined)\n\tconst initialDeviceType =\n\t\tprops.deviceType || (location.state as { deviceType?: DeviceConfigKey })?.deviceType;\n\n\t// State for selected device type (allows user to select if not provided)\n\tconst [selectedDeviceType, setSelectedDeviceType] = useState<DeviceConfigKey | undefined>(\n\t\tinitialDeviceType\n\t);\n\n\t// User token state for OAuth authentication (User Flow)\n\tconst [userToken, setUserToken] = useState<string | null>(() => {\n\t\t// Check if we already have a user token from previous OAuth flow\n\t\tconst savedCreds = CredentialsServiceV8.loadCredentials('user-login-v8', {\n\t\t\tflowKey: 'user-login-v8',\n\t\t\tflowType: 'oauth',\n\t\t\tincludeClientSecret: false,\n\t\t\tincludeRedirectUri: false,\n\t\t\tincludeLogoutUri: false,\n\t\t\tincludeScopes: false,\n\t\t});\n\t\treturn savedCreds?.accessToken || null;\n\t});\n\n\t// If no device type selected, show device type selection screen\n\tif (!selectedDeviceType) {\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<MFAHeaderV8\n\t\t\t\t\ttitle=\"MFA Unified Flow\"\n\t\t\t\t\tdescription=\"Register or authenticate MFA devices\"\n\t\t\t\t\tversionTag=\"V8\"\n\t\t\t\t\tcurrentPage=\"registration\"\n\t\t\t\t\tshowBackToMain={true}\n\t\t\t\t\theaderColor=\"pingRed\"\n\t\t\t\t/>\n\t\t\t\t<GlobalMFAProvider>\n\t\t\t\t\t<MFACredentialProvider>\n\t\t\t\t\t\t<DeviceTypeSelectionScreen\n\t\t\t\t\t\t\tonSelectDeviceType={setSelectedDeviceType}\n\t\t\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</MFACredentialProvider>\n\t\t\t\t</GlobalMFAProvider>\n\t\t\t\t{/* API display (bottom of page) */}\n\t\t\t\t<div style={{ marginTop: '24px' }}>\n\t\t\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\t\t\t\t</div>\n\t\t\t</>\n\t\t);\n\t}\n\n\treturn (\n\t\t<GlobalMFAProvider>\n\t\t\t<MFACredentialProvider>\n\t\t\t\t<UnifiedMFARegistrationFlowContent\n\t\t\t\t\t{...props}\n\t\t\t\t\tdeviceType={selectedDeviceType}\n\t\t\t\t\tuserToken={userToken}\n\t\t\t\t\tsetUserToken={setUserToken}\n\t\t\t\t/>\n\t\t\t</MFACredentialProvider>\n\t\t</GlobalMFAProvider>\n\t);\n};\n\n// ============================================================================\n// CONTENT COMPONENT (MAIN LOGIC)\n// ============================================================================\n\n/**\n * Unified MFA Registration Flow - Content Component\n *\n * Contains the actual flow logic and integrates with:\n * - MFACredentialContext (global credential state)\n * - useWorkerToken hook (token status and auto-refresh)\n * - deviceFlowConfigs (device-specific configuration)\n * - MFAFlowBaseV8 (5-step framework)\n */\nconst UnifiedMFARegistrationFlowContent: React.FC<\n\tRequired<Pick<UnifiedMFARegistrationFlowV8Props, 'deviceType'>> &\n\t\tOmit<UnifiedMFARegistrationFlowV8Props, 'deviceType'> & {\n\t\t\tuserToken: string | null;\n\t\t\tsetUserToken: (token: string | null) => void;\n\t\t}\n> = ({ deviceType, onCancel, userToken, setUserToken }) => {\n\t// ========================================================================\n\t// CONFIGURATION\n\t// ========================================================================\n\n\t// React Router navigation\n\tconst navigate = useNavigate();\n\n\t// Load device-specific configuration\n\tconst config = useMemo(() => {\n\t\treturn getDeviceConfig(deviceType);\n\t}, [deviceType]);\n\n\t// ========================================================================\n\t// USER FLOW OAUTH STATE\n\t// ========================================================================\n\n\t// State for User Login Modal (OAuth authentication for User Flow)\n\tconst [showUserLoginModal, setShowUserLoginModal] = useState(false);\n\tconst [showUserTokenSuccess, setShowUserTokenSuccess] = useState(false);\n\tconst [userTokenForDisplay, setUserTokenForDisplay] = useState<string>('');\n\tconst [usernameFromToken, setUsernameFromToken] = useState<string>('');\n\tconst [showUsernameDropdown, setShowUsernameDropdown] = useState(false);\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\tconst envIdForModal = useMemo(() => globalEnvironmentService.getEnvironmentId() || '', []);\n\n\t// Pending registration data while waiting for OAuth (use ref to avoid stale closure)\n\tconst pendingRegistrationRef = useRef<{\n\t\tdeviceType: DeviceConfigKey;\n\t\tfields: Record<string, string>;\n\t\tflowType: string;\n\t\tprops: MFAFlowBaseRenderProps;\n\t} | null>(null);\n\n\t// Worker token state for validation in registration flow\n\tconst workerToken = useWorkerToken({\n\t\trefreshInterval: 5000,\n\t\tenableAutoRefresh: true,\n\t});\n\n\t// Detect OAuth callback and re-open modal if needed\n\tuseEffect(() => {\n\t\tconst urlParams = new URLSearchParams(window.location.search);\n\t\tconst code = urlParams.get('code');\n\t\tconst hasStoredState = sessionStorage.getItem('user_login_state_v8');\n\n\t\t// If we have OAuth callback params and stored state, re-open the modal to process callback\n\t\t// But only if we don't already have a user token (to prevent reopening after silent auth)\n\t\tif (code && hasStoredState && !showUserLoginModal && !userToken) {\n\t\t\tconsole.log('[UNIFIED-FLOW] OAuth callback detected - re-opening modal to process');\n\t\t\tsetShowUserLoginModal(true);\n\t\t}\n\t}, [showUserLoginModal, userToken]);\n\n\t// ========================================================================\n\t// STEP VALIDATION\n\t// ========================================================================\n\n\t/**\n\t * Validate Step 0 (Configuration)\n\t */\n\tconst validateStep0 = useCallback(\n\t\t(\n\t\t\tcredentials: MFACredentials,\n\t\t\ttoken: TokenStatusInfo,\n\t\t\tnavigation: ReturnType<typeof useStepNavigationV8>\n\t\t) => {\n\t\t\t// Always check for valid worker token (required for MFA device operations)\n\t\t\tif (!token.isValid) {\n\t\t\t\tnavigation.setValidationErrors(['Invalid or expired worker token']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Check required configuration\n\t\t\tif (!credentials.environmentId || !credentials.username) {\n\t\t\t\tnavigation.setValidationErrors(['Environment ID and Username are required']);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\t\t[]\n\t);\n\n\t// ========================================================================\n\t// STEP RENDERERS\n\t// ========================================================================\n\n\t/**\n\t * Perform device registration API call (with token already available)\n\t */\n\tconst performRegistrationWithToken = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string,\n\t\t\ttoken?: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== PERFORM REGISTRATION WITH TOKEN =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Token:', token ? `Present (${token.length} chars)` : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setIsLoading available:', typeof props.setIsLoading);\n\t\t\tconsole.log('[UNIFIED-FLOW] Props.setCredentials available:', typeof props.setCredentials);\n\n\t\t\ttry {\n\t\t\t\tprops.setIsLoading(true);\n\n\t\t\t\t// Update credentials with device fields and user token if provided\n\t\t\t\tprops.setCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tflowType, // Store flowType so activation step knows if OTP is required\n\t\t\t\t\t...fields,\n\t\t\t\t\t...(flowType === 'user' && token\n\t\t\t\t\t\t? { userToken: token, tokenType: 'user' }\n\t\t\t\t\t\t: flowType !== 'user'\n\t\t\t\t\t\t\t? { tokenType: 'worker' }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t}));\n\n\t\t\t\t// Register the device using proper API call\n\t\t\t\t// CRITICAL: Flow-specific device status\n\t\t\t\t// - Admin flow: ACTIVE (no OTP sent, device ready immediately)\n\t\t\t\t// - Admin ACTIVATION_REQUIRED: ACTIVATION_REQUIRED (sends OTP for admin to activate)\n\t\t\t\t// - User flow: ACTIVATION_REQUIRED (sends OTP for user to activate)\n\t\t\t\t// - FIDO2: ACTIVE (WebAuthn verification happens during registration)\n\t\t\t\tlet deviceStatus: 'ACTIVE' | 'ACTIVATION_REQUIRED' | undefined;\n\n\t\t\t\t// Determine device status based on flow type (applies to all device types including FIDO2)\n\t\t\t\tif (flowType === 'admin-active') {\n\t\t\t\t\tdeviceStatus = 'ACTIVE';\n\t\t\t\t} else if (flowType === 'admin-activation') {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED';\n\t\t\t\t} else {\n\t\t\t\t\tdeviceStatus = 'ACTIVATION_REQUIRED'; // user flow\n\t\t\t\t}\n\n\t\t\t\t// Special note for FIDO2: WebAuthn verification proves device works,\n\t\t\t\t// but we still respect the flow type for status determination\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t'[UNIFIED-FLOW] FIDO2 device - status determined by flow type:',\n\t\t\t\t\t\tdeviceStatus\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device status determined:', {\n\t\t\t\t\tflowType,\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tdeviceStatus,\n\t\t\t\t\totpWillBeSent: deviceStatus === 'ACTIVATION_REQUIRED',\n\t\t\t\t\treason:\n\t\t\t\t\t\tselectedDeviceType === 'FIDO2'\n\t\t\t\t\t\t\t? 'FIDO2 - ACTIVE after WebAuthn verification'\n\t\t\t\t\t\t\t: 'User flow - OTP required for activation',\n\t\t\t\t});\n\n\t\t\t\t// Use same parameter construction as working MFA flows\n\t\t\t\ttype RegisterDeviceParamsWithToken = RegisterDeviceParams & {\n\t\t\t\t\ttokenType?: 'worker' | 'user';\n\t\t\t\t\tuserToken?: string | undefined;\n\t\t\t\t};\n\t\t\t\tlet baseParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\tenvironmentId: props.credentials.environmentId,\n\t\t\t\t\tusername: props.credentials.username,\n\t\t\t\t\ttype: selectedDeviceType,\n\t\t\t\t};\n\t\t\t\t// Per rightTOTP.md: Pass token type and user token if available\n\t\t\t\tif (flowType === 'user' && token) {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'user',\n\t\t\t\t\t\tuserToken: token,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tbaseParams = {\n\t\t\t\t\t\t...baseParams,\n\t\t\t\t\t\ttokenType: 'worker',\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Always include status for all device types\n\t\t\t\t// FIDO2: Set to ACTIVE since WebAuthn verification proves device works\n\t\t\t\t// Other devices: Set based on flow type (admin-active = ACTIVE, others = ACTIVATION_REQUIRED)\n\t\t\t\tif (deviceStatus !== undefined) {\n\t\t\t\t\tbaseParams.status = deviceStatus;\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registration base params:', {\n\t\t\t\t\tenvironmentId: baseParams.environmentId,\n\t\t\t\t\tusername: baseParams.username,\n\t\t\t\t\ttype: baseParams.type,\n\t\t\t\t\ttokenType: baseParams.tokenType,\n\t\t\t\t\tstatus: baseParams.status,\n\t\t\t\t\tflowType,\n\t\t\t\t});\n\n\t\t\t\t// Map form field names to API field names\n\t\t\t\t// Form uses 'deviceName' but API expects 'nickname' or 'name'\n\t\t\t\tconst mappedFields: Record<string, string> = { ...fields };\n\t\t\t\tif (mappedFields.deviceName) {\n\t\t\t\t\tmappedFields.nickname = mappedFields.deviceName;\n\t\t\t\t\tmappedFields.name = mappedFields.deviceName;\n\t\t\t\t\tdelete mappedFields.deviceName;\n\t\t\t\t}\n\n\t\t\t\t// Format phone number for SMS/WhatsApp devices\n\t\t\t\t// Form sends: { phoneNumber: '9725231586', countryCode: '+1' }\n\t\t\t\t// API expects: { phone: '+1.9725231586' }\n\t\t\t\tif (mappedFields.phoneNumber && mappedFields.countryCode) {\n\t\t\t\t\tconst countryCode = mappedFields.countryCode.replace('+', ''); // Remove + for formatting\n\t\t\t\t\tconst phoneNumber = mappedFields.phoneNumber.replace(/\\D/g, ''); // Remove non-digits\n\t\t\t\t\tmappedFields.phone = `+${countryCode}.${phoneNumber}`;\n\t\t\t\t\tconsole.log('[UNIFIED-FLOW] Formatted phone:', mappedFields.phone);\n\t\t\t\t\tdelete mappedFields.phoneNumber;\n\t\t\t\t\tdelete mappedFields.countryCode;\n\t\t\t\t}\n\n\t\t\t\t// Include device-specific fields (phone, email, etc.)\n\t\t\t\tconst deviceParams: RegisterDeviceParamsWithToken = {\n\t\t\t\t\t...baseParams,\n\t\t\t\t\t...mappedFields,\n\t\t\t\t\t// Include policy for TOTP devices (required for secret and keyUri to be returned)\n\t\t\t\t\t...(selectedDeviceType === 'TOTP' && selectedPolicyRef.current\n\t\t\t\t\t\t? { policy: selectedPolicyRef.current.id }\n\t\t\t\t\t\t: {}),\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Registering device with params:', deviceParams);\n\n\t\t\t\tconst result = await MFAServiceV8_Legacy.registerDevice(deviceParams);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Device registered:', result);\n\n\t\t\t\t// Update MFA state with device info\n\t\t\t\tconst registrationResult = result as unknown as Record<string, unknown>;\n\n\t\t\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result for TOTP:', {\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\tqrCode: registrationResult.qrCode,\n\t\t\t\t\t\tqrCodeUrl: registrationResult.qrCodeUrl,\n\t\t\t\t\t\tsecret: registrationResult.secret,\n\t\t\t\t\t\ttotpSecret: registrationResult.totpSecret,\n\t\t\t\t\t\tfullResult: result,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// ===============================================\n\n\t\t\t\t// Clear stored registration data after successful use\n\t\t\t\tlocalStorage.removeItem('mfa_registration_flow_type');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_fields');\n\t\t\t\tlocalStorage.removeItem('mfa_registration_device_type');\n\n\t\t\t\tprops.setMfaState((prev) => {\n\t\t\t\t\t// TOTP: QR code will be rendered by QRCodeSVG component in UnifiedActivationStep\n\t\t\t\t\t// No need to generate QR code data URL here - just pass the keyUri\n\t\t\t\t\tconst newState: MFAState = {\n\t\t\t\t\t\t...prev,\n\t\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\t\tdeviceStatus: result.status,\n\t\t\t\t\t\t...(registrationResult.deviceActivateUri\n\t\t\t\t\t\t\t? { deviceActivateUri: String(registrationResult.deviceActivateUri) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'TOTP'\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\ttotpSecret: String(registrationResult.secret || ''),\n\t\t\t\t\t\t\t\t\tkeyUri: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tqrCodeUrl: String(registrationResult.keyUri || ''),\n\t\t\t\t\t\t\t\t\tshowQr: !!(registrationResult.secret || registrationResult.keyUri),\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'FIDO2' &&\n\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tpublicKeyCredentialCreationOptions:\n\t\t\t\t\t\t\t\t\t\tregistrationResult.publicKeyCredentialCreationOptions,\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t...(selectedDeviceType === 'MOBILE' && registrationResult.pairingKey\n\t\t\t\t\t\t\t? { pairingKey: String(registrationResult.pairingKey) }\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t};\n\n\t\t\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\t\t\tif (selectedDeviceType === 'TOTP') {\n\t\t\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\t\t\tfullState: newState,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t// ================================================\n\n\t\t\t\t\treturn newState;\n\t\t\t\t});\n\n\t\t\t\t// FIDO2: Check if we already have credential data (from WebAuthn modal)\n\t\t\t\t// If credentialId and publicKey are present, registration is complete\n\t\t\t\tif (selectedDeviceType === 'FIDO2') {\n\t\t\t\t\tif (fields.credentialId && fields.publicKey) {\n\t\t\t\t\t\t// WebAuthn already completed via modal - device fully registered\n\n\t\t\t\t\t\t// Admin Flow: Show QR but skip OTP validation - device ready immediately\n\t\t\t\t\t\t// Admin ACTIVATION_REQUIRED & User Flow: Show QR and require OTP validation\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tflowType === 'admin-active' ||\n\t\t\t\t\t\t\tflowType === 'admin-activation' ||\n\t\t\t\t\t\t\tresult.status === 'ACTIVE'\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t'[UNIFIED-FLOW] Admin flow or ACTIVE status - proceeding to show QR without OTP requirement'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered successfully!${flowType === 'admin-active' || flowType === 'admin-activation' ? ' Device is ready to use.' : ''}`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t// For Admin Flow, go to API docs page instead of OTP page\n\t\t\t\t\t\t\t// For User Flow, go to User Login step (Step 1)\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (result.status === 'ACTIVATION_REQUIRED') {\n\t\t\t\t\t\t\t// Device requires activation - PingOne automatically sends OTP\n\t\t\t\t\t\t\t// This applies to both admin_activation_required and user flow\n\t\t\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t\t\t`${config.displayName} device registered! OTP has been sent automatically.`\n\t\t\t\t\t\t\t);\n  // DO NOT auto-advance for OTP-required devices\n\t\t\t\t\t\t\t// User should manually click Next after receiving OTP\n\t\t\t\t\t\t\tconsole.log(`${MODULE_TAG} Device requires OTP activation - waiting for user to proceed manually`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Unknown status, proceed with flow-specific navigation\n\t\t\t\t\t\t\tif (flowType === 'admin-active' || flowType === 'admin-activation') {\n\t\t\t\t\t\t\t\t// Navigate to device-specific API docs page\n\t\t\t\t\t\t\t\tconst docsPath = `/v8/mfa/register/${config.deviceType}/docs`;\n\t\t\t\t\t\t\t\twindow.location.href = docsPath;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprops.nav.goToNext(); // User Flow - go to User Login\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} // End of FIDO2 section\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Registration failed:', error);\n\t\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Device registration failed';\n\n\t\t\t\t// Check if error is due to too many devices\n\t\t\t\tif (errorMessage.includes('Too many devices')) {\n\t\t\t\t\ttoastV8.error(\n\t\t\t\t\t\t`${errorMessage}\\n\\n‚ÑπÔ∏è You can manage your devices at:\\nhttps://localhost:3000/v8/delete-all-devices`,\n\t\t\t\t\t\t{ duration: 8000 }\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\ttoastV8.error(errorMessage);\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tprops.setIsLoading(false);\n\t\t\t}\n\t\t},\n\t\t[config.displayName, toastV8]\n\t);\n\n\t/**\n\t * Handle user token received from OAuth flow\n\t */\n\tconst handleUserTokenReceived = useCallback(\n\t\t(token: string) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== USER TOKEN RECEIVED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Token length:', token.length);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current pending registration:', pendingRegistrationRef.current);\n\n\t\t\tsetUserToken(token);\n\t\t\tsetUserTokenForDisplay(token);\n\n\t\t\t// Decode JWT to extract username\n\t\t\ttry {\n\t\t\t\tconst base64Url = token.split('.')[1];\n\t\t\t\tconst base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n\t\t\t\tconst jsonPayload = decodeURIComponent(\n\t\t\t\t\tatob(base64)\n\t\t\t\t\t\t.split('')\n\t\t\t\t\t\t.map((c) => `%${`00${c.charCodeAt(0).toString(16)}`.slice(-2)}`)\n\t\t\t\t\t\t.join('')\n\t\t\t\t);\n\t\t\t\tconst payload = JSON.parse(jsonPayload);\n\t\t\t\tconst username =\n\t\t\t\t\tpayload.username || payload.preferred_username || payload.sub || 'Unknown User';\n\t\t\t\tsetUsernameFromToken(username);\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Extracted username:', username);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Failed to decode JWT:', error);\n\t\t\t\tsetUsernameFromToken('Unknown User');\n\t\t\t}\n\n\t\t\t// If we have pending registration, show success page first\n\t\t\tconst pending = pendingRegistrationRef.current;\n\t\t\tif (pending) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Found pending registration, showing success page first...');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending data:', {\n\t\t\t\t\tdeviceType: pending.deviceType,\n\t\t\t\t\tflowType: pending.flowType,\n\t\t\t\t\thasProps: !!pending.props,\n\t\t\t\t\thasFields: !!pending.fields,\n\t\t\t\t});\n\n\t\t\t\ttoastV8.success('‚úÖ Authentication successful! Your user token is ready.', {\n\t\t\t\t\tduration: 4000,\n\t\t\t\t});\n\n\t\t\t\t// Close login modal and show success page\n\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\tsetShowUserTokenSuccess(true);\n\t\t\t} else {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] WARNING: No pending registration found after OAuth!');\n\t\t\t}\n\t\t},\n\t\t[setUserToken]\n\t);\n\n\t/**\n\t * Handle continue from user token success page\n\t */\n\tconst handleContinueAfterUserLogin = useCallback(() => {\n\t\tconsole.log(\n\t\t\t'[UNIFIED-FLOW] User clicked continue after login, proceeding with registration...'\n\t\t);\n\n\t\tconst pending = pendingRegistrationRef.current;\n\t\tif (pending && userToken) {\n\t\t\tconst { deviceType: pendingDeviceType, fields, flowType, props } = pending;\n\t\t\tpendingRegistrationRef.current = null;\n\n\t\t\t// Hide success page\n\t\t\tsetShowUserTokenSuccess(false);\n\n\t\t\t// Continue with registration\n\t\t\tsetTimeout(() => {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Now executing performRegistrationWithToken...');\n\t\t\t\tperformRegistrationWithToken(props, pendingDeviceType, fields, flowType, userToken);\n\t\t\t}, 100);\n\t\t}\n\t}, [userToken, performRegistrationWithToken]);\n\n\t/**\n\t * Perform device registration API call\n\t * Checks if User Flow needs OAuth first, otherwise proceeds with registration\n\t */\n\tconst performRegistration = useCallback(\n\t\tasync (\n\t\t\tprops: MFAFlowBaseRenderProps,\n\t\t\tselectedDeviceType: DeviceConfigKey,\n\t\t\tfields: Record<string, string>,\n\t\t\tflowType: string\n\t\t) => {\n\t\t\tconsole.log('[UNIFIED-FLOW] ===== DEVICE REGISTRATION SUBMITTED =====');\n\t\t\tconsole.log('[UNIFIED-FLOW] Device:', selectedDeviceType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Flow type:', flowType);\n\t\t\tconsole.log('[UNIFIED-FLOW] Current userToken:', userToken ? 'Present' : 'Missing');\n\t\t\tconsole.log('[UNIFIED-FLOW] Fields:', fields);\n\n\t\t\t// CRITICAL: Validate worker token before allowing any registration\n\t\t\tif (!workerToken.tokenStatus.isValid) {\n\t\t\t\tconsole.error('[UNIFIED-FLOW] Cannot proceed - no valid worker token');\n\t\t\t\ttoastV8.error(\n\t\t\t\t\t'‚ùå Worker token required for device registration. Please configure worker token credentials first.',\n\t\t\t\t\t{\n\t\t\t\t\t\tduration: 5000,\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// For User Flow, check if we need OAuth authentication first\n\t\t\tif (flowType === 'user' && !userToken) {\n\t\t\t\tconsole.log('[UNIFIED-FLOW] User flow selected but no token - showing OAuth modal');\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Storing pending registration...');\n\n\t\t\t\t// Store pending registration data\n\t\t\t\tpendingRegistrationRef.current = {\n\t\t\t\t\tdeviceType: selectedDeviceType,\n\t\t\t\t\tfields,\n\t\t\t\t\tflowType,\n\t\t\t\t\tprops,\n\t\t\t\t};\n\n\t\t\t\tconsole.log('[UNIFIED-FLOW] Pending registration stored:', pendingRegistrationRef.current);\n\n\t\t\t\t// Set return target for device registration flow\n\t\t\t\tReturnTargetServiceV8U.setReturnTarget(\n\t\t\t\t\t'mfa_device_registration',\n\t\t\t\t\t'/v8/unified-mfa',  // Return to unified MFA flow\n\t\t\t\t\t2  // Step 2: Device Selection\n\t\t\t\t);\n\n\t\t\t\t// Show the user login modal\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t'üîê User Flow requires PingOne authentication. Please complete the login to continue with device registration.',\n\t\t\t\t\t{ duration: 6000 }\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t'[UNIFIED-FLOW] Proceeding directly with registration (token exists or admin flow)'\n\t\t\t);\n\t\t\t// Proceed with registration (using existing token for user flow)\n\t\t\tawait performRegistrationWithToken(\n\t\t\t\tprops,\n\t\t\t\tselectedDeviceType,\n\t\t\t\tfields,\n\t\t\t\tflowType,\n\t\t\t\tuserToken || undefined\n\t\t\t);\n\t\t},\n\t\t[workerToken.tokenStatus.isValid, userToken]\n\t);\n\n\t/**\n\t * Render Step 0: Configuration (environment, user, policy)\n\t */\n\tconst renderStep0 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn (\n\t\t\t\t<UnifiedDeviceRegistrationForm\n\t\t\t\t\tinitialDeviceType={deviceType}\n\t\t\t\t\tonSubmit={async (selectedDeviceType, fields, flowType) => {\n\t\t\t\t\t\tawait performRegistration(props, selectedDeviceType, fields, flowType);\n\t\t\t\t\t}}\n\t\t\t\t\tonCancel={() => {\n\t\t\t\t\t\tif (onCancel) onCancel();\n\t\t\t\t\t}}\n\t\t\t\t\ttokenStatus={props.tokenStatus}\n\t\t\t\t\tusername={props.credentials.username}\n\t\t\t\t/>\n\t\t\t);\n\t\t},\n\t\t[deviceType, onCancel, performRegistration]\n\t);\n\n\t/**\n\t * Render Step 1: User Login using Authorization Code Flow with PKCE\n\t */\n\tconst renderStep1 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <UserLoginStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 2: Device Selection (option to call registration if want new device, or have no devices)\n\t */\n\tconst renderStep2 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 3: Device-Specific Actions (OTP/QR Generation, FIDO, Mobile Push)\n\t */\n\tconst renderStep3 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific based on the device type\n\t\t\t// For now, return the activation step which handles device-specific logic\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 4: OTP Validation / Confirmation\n\t */\n\tconst renderStep4 = useCallback(\n\t\t(props: MFAFlowBaseRenderProps) => {\n\t\t\t// This will be device-specific validation\n\t\t\treturn <UnifiedActivationStep {...props} config={config} />;\n\t\t},\n\t\t[config]\n\t);\n\n\t/**\n\t * Render Step 5: API Documentation\n\t */\n\tconst renderStep5 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <APIDocsStepV8 renderProps={props} />;\n\t}, []);\n\n\t/**\n\t * Render Step 6: Success screen with all user data and other valuable options\n\t */\n\tconst renderStep6 = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\treturn <SuccessStepV8 renderProps={props} />;\n\t}, []);\n\n\t// Step labels for device authentication flow\n\tconst stepLabels = useMemo(() => {\n\t\tif (deviceType === 'FIDO2') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Start FIDO in Browser',\n\t\t\t\t'Passkey confirmation',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else if (deviceType === 'MOBILE') {\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Push to Mobile App',\n\t\t\t\t'User Confirms on Mobile',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t} else {\n\t\t\t// SMS, Email, TOTP, WhatsApp\n\t\t\treturn [\n\t\t\t\t'Configure',\n\t\t\t\t'User Login',\n\t\t\t\t'Device Selection',\n\t\t\t\t'Generate OTP/QR',\n\t\t\t\t'Validate OTP',\n\t\t\t\t'API Docs',\n\t\t\t\t'Success',\n\t\t\t];\n\t\t}\n\t}, [deviceType]);\n\n\tconst shouldHideNextButton = useCallback((props: MFAFlowBaseRenderProps) => {\n\t\tif (props.nav.currentStep === 0) {\n\t\t\treturn true; // Hide Next button on configuration step, use form submit\n\t\t}\n\t\tif (props.nav.currentStep === 1) {\n\t\t\treturn true; // Hide Next button on user login step, use authentication button\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\treturn (\n\t\t<>\n\t\t\t<MFAFlowBaseV8\n\t\t\t\tdeviceType={deviceType}\n\t\t\t\trenderStep0={renderStep0}\n\t\t\t\trenderStep1={renderStep1}\n\t\t\t\trenderStep2={renderStep2}\n\t\t\t\trenderStep3={renderStep3}\n\t\t\t\trenderStep4={renderStep4}\n\t\t\t\trenderStep5={renderStep5}\n\t\t\t\trenderStep6={renderStep6}\n\t\t\t\tvalidateStep0={validateStep0}\n\t\t\t\tstepLabels={stepLabels}\n\t\t\t\tshouldHideNextButton={shouldHideNextButton}\n\t\t\t\tflowType=\"device-auth\"\n\t\t\t/>\n\t\t\t<div style={{ height: '300px' }} />\n\t\t\t<SuperSimpleApiDisplayV8 flowFilter=\"mfa\" reserveSpace />\n\n\t\t\t{/* User Login Modal for User Flow OAuth */}\n\t\t\t<UserLoginModalV8\n\t\t\t\tisOpen={showUserLoginModal}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tsetShowUserLoginModal(false);\n\t\t\t\t\tpendingRegistrationRef.current = null;\n\t\t\t\t}}\n\t\t\t\tonTokenReceived={handleUserTokenReceived}\n\t\t\t\tenvironmentId={envIdForModal}\n\t\t\t/>\n\n\t\t\t{/* User Token Success Page - Show token after OAuth login */}\n\t\t\t{showUserTokenSuccess && userTokenForDisplay && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\tzIndex: 10000,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\tpadding: '32px',\n\t\t\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\t\t\twidth: '90%',\n\t\t\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\t\t\tboxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{/* Success Header */}\n\t\t\t\t\t\t<div style={{ textAlign: 'center', marginBottom: '24px' }}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\twidth: '64px',\n\t\t\t\t\t\t\t\t\theight: '64px',\n\t\t\t\t\t\t\t\t\tborderRadius: '50%',\n\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span style={{ fontSize: '32px' }}>‚úÖ</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<h2 style={{ margin: '0 0 8px 0', fontSize: '24px', color: '#1f2937' }}>\n\t\t\t\t\t\t\t\tAuthentication Successful!\n\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '15px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\tYour user token has been obtained and is ready to use.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Username Dropdown */}\n\t\t\t\t\t\t{usernameFromToken && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\t\tmarginBottom: '16px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUsernameDropdown(!showUsernameDropdown)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\t\t\t\tbackground: 'transparent',\n\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\tpadding: 0,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\tmarginBottom: showUsernameDropdown ? '12px' : 0,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '16px', color: '#374151' }}>Username</h3>\n\t\t\t\t\t\t\t\t\t{showUsernameDropdown ? (\n\t\t\t\t\t\t\t\t\t\t<FiChevronUp size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t<FiChevronDown size={20} color=\"#6b7280\" />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{showUsernameDropdown && (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{usernameFromToken}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(usernameFromToken);\n\t\t\t\t\t\t\t\t\t\t\t\ttoastV8.success('Username copied to clipboard!');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüìã Copy Username\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{/* Token Display */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<h3 style={{ margin: '0 0 12px 0', fontSize: '16px', color: '#374151' }}>\n\t\t\t\t\t\t\t\tUser Access Token\n\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackground: '#1f2937',\n\t\t\t\t\t\t\t\t\tcolor: '#f3f4f6',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontFamily: 'monospace',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\twordBreak: 'break-all',\n\t\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{userTokenForDisplay}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tnavigator.clipboard.writeText(userTokenForDisplay);\n\t\t\t\t\t\t\t\t\ttoastV8.success('Token copied to clipboard!');\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '8px 16px',\n\t\t\t\t\t\t\t\t\tbackground: '#3b82f6',\n\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tüìã Copy Token\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Next Steps Info */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: '#eff6ff',\n\t\t\t\t\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tpadding: '16px',\n\t\t\t\t\t\t\t\tmarginBottom: '24px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '14px', color: '#1e40af', lineHeight: '1.6' }}>\n\t\t\t\t\t\t\t\t<strong>Next:</strong> Click \"Continue with Registration\" to proceed with your{' '}\n\t\t\t\t\t\t\t\t{config.displayName} device registration using this user token.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{/* Continue Button */}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleContinueAfterUserLogin}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '14px 24px',\n\t\t\t\t\t\t\t\tbackground: '#10b981',\n\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tboxShadow: '0 2px 8px rgba(16, 185, 129, 0.3)',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tContinue with Registration ‚Üí\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</>\n\t);\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default UnifiedMFARegistrationFlowV8;\n"},"tags":[],"source":null},{"category":"lint/a11y/noStaticElementInteractions","severity":"error","description":"Static Elements should not be interactive.","message":[{"elements":[],"content":"Static Elements should not be interactive."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"To add interactivity such as a mouse or key event listener to a static element, give the element an appropriate role value."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/APIComparisonModal.tsx"},"span":[3459,3766],"sourceCode":"/**\n * @file APIComparisonModal.tsx\n * @module v8/flows/unified/components\n * @description Modal showing API differences between Admin, Admin Activation Required, and User flows\n * @version 8.0.0\n */\n\nimport React from 'react';\n\ninterface APIComparisonModalProps {\n\tisOpen: boolean;\n\tonClose: () => void;\n}\n\nexport const APIComparisonModal: React.FC<APIComparisonModalProps> = ({ isOpen, onClose }) => {\n\tif (!isOpen) return null;\n\n\tconst apiEndpoints = {\n\t\tadmin: {\n\t\t\tname: 'Admin Flow',\n\t\t\tdescription: 'Uses Worker Token, creates device with ACTIVE status',\n\t\t\tmethod: 'POST',\n\t\t\turl: '/api/pingone/mfa/register-device',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\tAuthorization: 'Bearer WORKER_TOKEN',\n\t\t\t},\n\t\t\tbody: {\n\t\t\t\tenvironmentId: 'env-123456',\n\t\t\t\tusername: 'admin@example.com',\n\t\t\t\ttype: 'SMS',\n\t\t\t\ttokenType: 'worker',\n\t\t\t\tstatus: 'ACTIVE',\n\t\t\t\tphoneNumber: '+1234567890',\n\t\t\t\tcountryCode: '+1',\n\t\t\t},\n\t\t\tresponse: {\n\t\t\t\tdeviceId: 'dev-123456',\n\t\t\t\tstatus: 'ACTIVE',\n\t\t\t\ttype: 'SMS',\n\t\t\t\tcreatedAt: '2026-01-30T00:00:00Z',\n\t\t\t},\n\t\t\tnotes: 'Device is immediately active and ready to use. No OTP required.',\n\t\t},\n\t\tadminActivationRequired: {\n\t\t\tname: 'Admin Activation Required Flow',\n\t\t\tdescription: 'Uses Worker Token, creates device with ACTIVATION_REQUIRED status',\n\t\t\tmethod: 'POST',\n\t\t\turl: '/api/pingone/mfa/register-device',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\tAuthorization: 'Bearer WORKER_TOKEN',\n\t\t\t},\n\t\t\tbody: {\n\t\t\t\tenvironmentId: 'env-123456',\n\t\t\t\tusername: 'admin@example.com',\n\t\t\t\ttype: 'SMS',\n\t\t\t\ttokenType: 'worker',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\tphoneNumber: '+1234567890',\n\t\t\t\tcountryCode: '+1',\n\t\t\t},\n\t\t\tresponse: {\n\t\t\t\tdeviceId: 'dev-123456',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\ttype: 'SMS',\n\t\t\t\tdeviceActivateUri: '/api/pingone/mfa/devices/dev-123456/activate',\n\t\t\t\tcreatedAt: '2026-01-30T00:00:00Z',\n\t\t\t},\n\t\t\tnotes: 'PingOne automatically sends OTP. User must validate OTP to activate device.',\n\t\t},\n\t\tuser: {\n\t\t\tname: 'User Flow',\n\t\t\tdescription:\n\t\t\t\t'Uses User Token (from OAuth login), creates device with ACTIVATION_REQUIRED status',\n\t\t\tmethod: 'POST',\n\t\t\turl: '/api/pingone/mfa/register-device',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\tAuthorization: 'Bearer USER_TOKEN',\n\t\t\t},\n\t\t\tbody: {\n\t\t\t\tenvironmentId: 'env-123456',\n\t\t\t\tusername: 'user@example.com',\n\t\t\t\ttype: 'SMS',\n\t\t\t\ttokenType: 'user',\n\t\t\t\tuserToken: 'oauth-user-token-123',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\tphoneNumber: '+1234567890',\n\t\t\t\tcountryCode: '+1',\n\t\t\t},\n\t\t\tresponse: {\n\t\t\t\tdeviceId: 'dev-123456',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\ttype: 'SMS',\n\t\t\t\tdeviceActivateUri: '/api/pingone/mfa/devices/dev-123456/activate',\n\t\t\t\tcreatedAt: '2026-01-30T00:00:00Z',\n\t\t\t},\n\t\t\tnotes:\n\t\t\t\t'User must be logged into PingOne first. PingOne automatically sends OTP for activation.',\n\t\t},\n\t};\n\n\tconst renderCodeBlock = (code: object) => (\n\t\t<pre\n\t\t\tstyle={{\n\t\t\t\tbackground: '#1e293b',\n\t\t\t\tcolor: '#e2e8f0',\n\t\t\t\tpadding: '16px',\n\t\t\t\tborderRadius: '8px',\n\t\t\t\toverflow: 'auto',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tfontFamily: 'Monaco, Consolas, monospace',\n\t\t\t}}\n\t\t>\n\t\t\t<code>{JSON.stringify(code, null, 2)}</code>\n\t\t</pre>\n\t);\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tposition: 'fixed',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\tdisplay: 'flex',\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tzIndex: 1000,\n\t\t\t}}\n\t\t\tonClick={onClose}\n\t\t>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'white',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tmaxWidth: '1200px',\n\t\t\t\t\twidth: '90%',\n\t\t\t\t\tmaxHeight: '90vh',\n\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\tboxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',\n\t\t\t\t}}\n\t\t\t\tonClick={(e) => e.stopPropagation()}\n\t\t\t>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\tborderBottom: '1px solid #e5e7eb',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h2 style={{ margin: 0, fontSize: '24px', fontWeight: '700', color: '#111827' }}>\n\t\t\t\t\t\t\tMFA Flow API Comparison\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tAPI calls and parameters for Admin, Admin Activation Required, and User flows\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t\t<button\n\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'none',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t√ó\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Content */}\n\t\t\t\t<div style={{ padding: '24px' }}>\n\t\t\t\t\t{Object.entries(apiEndpoints).map(([key, flow]) => (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tkey={key}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginBottom: '32px',\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\tkey === 'admin'\n\t\t\t\t\t\t\t\t\t\t? '#f0fdf4'\n\t\t\t\t\t\t\t\t\t\t: key === 'adminActivationRequired'\n\t\t\t\t\t\t\t\t\t\t\t? '#fef3c7'\n\t\t\t\t\t\t\t\t\t\t\t: '#dbeafe',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Flow Header */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{flow.name}\n\t\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\t\t{flow.description}\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* API Details */}\n\t\t\t\t\t\t\t<div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>\n\t\t\t\t\t\t\t\t{/* Left Column */}\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t{/* URL and Method */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tEndpoint\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: flow.method === 'POST' ? '#10b981' : '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{flow.method}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t<code\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{flow.url}\n\t\t\t\t\t\t\t\t\t\t\t</code>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Headers */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tHeaders\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t{renderCodeBlock(flow.headers)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t{/* Right Column */}\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t{/* Request Body */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRequest Body\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t{renderCodeBlock(flow.body)}\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Response */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tResponse\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t{renderCodeBlock(flow.response)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Notes */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìù Notes\n\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '13px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t{flow.notes}\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t))}\n\n\t\t\t\t\t{/* Key Differences Summary */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '20px',\n\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h3\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 16px 0',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîë Key Differences\n\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t<ul\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tpaddingLeft: '20px',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>Token Type:</strong> Admin flows use <code>tokenType: 'worker'</code>, User\n\t\t\t\t\t\t\t\tflow uses <code>tokenType: 'user'</code>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>Authentication:</strong> Admin flows use Worker Token, User flow requires\n\t\t\t\t\t\t\t\tUser Token from OAuth login\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>Device Status:</strong> Admin flow can choose <code>'ACTIVE'</code> or{' '}\n\t\t\t\t\t\t\t\t<code>'ACTIVATION_REQUIRED'</code>, User flow always uses{' '}\n\t\t\t\t\t\t\t\t<code>'ACTIVATION_REQUIRED'</code>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>OTP Requirement:</strong> Only flows with <code>'ACTIVATION_REQUIRED'</code>{' '}\n\t\t\t\t\t\t\t\tstatus trigger OTP automatically\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>User Token:</strong> User flow includes <code>userToken</code> field from\n\t\t\t\t\t\t\t\tOAuth login\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n"},"tags":[],"source":null},{"category":"lint/a11y/useKeyWithClickEvents","severity":"error","description":"Enforce to have the onClick mouse event with the onKeyUp, the onKeyDown, or the onKeyPress keyboard event.","message":[{"elements":[],"content":"Enforce to have the "},{"elements":["Emphasis"],"content":"onClick"},{"elements":[],"content":" mouse event with the "},{"elements":["Emphasis"],"content":"onKeyUp"},{"elements":[],"content":", the "},{"elements":["Emphasis"],"content":"onKeyDown"},{"elements":[],"content":", or the "},{"elements":["Emphasis"],"content":"onKeyPress"},{"elements":[],"content":" keyboard event."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Actions triggered using mouse events should have corresponding keyboard events to account for keyboard-only navigation."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/APIComparisonModal.tsx"},"span":[3459,3766],"sourceCode":"/**\n * @file APIComparisonModal.tsx\n * @module v8/flows/unified/components\n * @description Modal showing API differences between Admin, Admin Activation Required, and User flows\n * @version 8.0.0\n */\n\nimport React from 'react';\n\ninterface APIComparisonModalProps {\n\tisOpen: boolean;\n\tonClose: () => void;\n}\n\nexport const APIComparisonModal: React.FC<APIComparisonModalProps> = ({ isOpen, onClose }) => {\n\tif (!isOpen) return null;\n\n\tconst apiEndpoints = {\n\t\tadmin: {\n\t\t\tname: 'Admin Flow',\n\t\t\tdescription: 'Uses Worker Token, creates device with ACTIVE status',\n\t\t\tmethod: 'POST',\n\t\t\turl: '/api/pingone/mfa/register-device',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\tAuthorization: 'Bearer WORKER_TOKEN',\n\t\t\t},\n\t\t\tbody: {\n\t\t\t\tenvironmentId: 'env-123456',\n\t\t\t\tusername: 'admin@example.com',\n\t\t\t\ttype: 'SMS',\n\t\t\t\ttokenType: 'worker',\n\t\t\t\tstatus: 'ACTIVE',\n\t\t\t\tphoneNumber: '+1234567890',\n\t\t\t\tcountryCode: '+1',\n\t\t\t},\n\t\t\tresponse: {\n\t\t\t\tdeviceId: 'dev-123456',\n\t\t\t\tstatus: 'ACTIVE',\n\t\t\t\ttype: 'SMS',\n\t\t\t\tcreatedAt: '2026-01-30T00:00:00Z',\n\t\t\t},\n\t\t\tnotes: 'Device is immediately active and ready to use. No OTP required.',\n\t\t},\n\t\tadminActivationRequired: {\n\t\t\tname: 'Admin Activation Required Flow',\n\t\t\tdescription: 'Uses Worker Token, creates device with ACTIVATION_REQUIRED status',\n\t\t\tmethod: 'POST',\n\t\t\turl: '/api/pingone/mfa/register-device',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\tAuthorization: 'Bearer WORKER_TOKEN',\n\t\t\t},\n\t\t\tbody: {\n\t\t\t\tenvironmentId: 'env-123456',\n\t\t\t\tusername: 'admin@example.com',\n\t\t\t\ttype: 'SMS',\n\t\t\t\ttokenType: 'worker',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\tphoneNumber: '+1234567890',\n\t\t\t\tcountryCode: '+1',\n\t\t\t},\n\t\t\tresponse: {\n\t\t\t\tdeviceId: 'dev-123456',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\ttype: 'SMS',\n\t\t\t\tdeviceActivateUri: '/api/pingone/mfa/devices/dev-123456/activate',\n\t\t\t\tcreatedAt: '2026-01-30T00:00:00Z',\n\t\t\t},\n\t\t\tnotes: 'PingOne automatically sends OTP. User must validate OTP to activate device.',\n\t\t},\n\t\tuser: {\n\t\t\tname: 'User Flow',\n\t\t\tdescription:\n\t\t\t\t'Uses User Token (from OAuth login), creates device with ACTIVATION_REQUIRED status',\n\t\t\tmethod: 'POST',\n\t\t\turl: '/api/pingone/mfa/register-device',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\tAuthorization: 'Bearer USER_TOKEN',\n\t\t\t},\n\t\t\tbody: {\n\t\t\t\tenvironmentId: 'env-123456',\n\t\t\t\tusername: 'user@example.com',\n\t\t\t\ttype: 'SMS',\n\t\t\t\ttokenType: 'user',\n\t\t\t\tuserToken: 'oauth-user-token-123',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\tphoneNumber: '+1234567890',\n\t\t\t\tcountryCode: '+1',\n\t\t\t},\n\t\t\tresponse: {\n\t\t\t\tdeviceId: 'dev-123456',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\ttype: 'SMS',\n\t\t\t\tdeviceActivateUri: '/api/pingone/mfa/devices/dev-123456/activate',\n\t\t\t\tcreatedAt: '2026-01-30T00:00:00Z',\n\t\t\t},\n\t\t\tnotes:\n\t\t\t\t'User must be logged into PingOne first. PingOne automatically sends OTP for activation.',\n\t\t},\n\t};\n\n\tconst renderCodeBlock = (code: object) => (\n\t\t<pre\n\t\t\tstyle={{\n\t\t\t\tbackground: '#1e293b',\n\t\t\t\tcolor: '#e2e8f0',\n\t\t\t\tpadding: '16px',\n\t\t\t\tborderRadius: '8px',\n\t\t\t\toverflow: 'auto',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tfontFamily: 'Monaco, Consolas, monospace',\n\t\t\t}}\n\t\t>\n\t\t\t<code>{JSON.stringify(code, null, 2)}</code>\n\t\t</pre>\n\t);\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tposition: 'fixed',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\tdisplay: 'flex',\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tzIndex: 1000,\n\t\t\t}}\n\t\t\tonClick={onClose}\n\t\t>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'white',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tmaxWidth: '1200px',\n\t\t\t\t\twidth: '90%',\n\t\t\t\t\tmaxHeight: '90vh',\n\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\tboxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',\n\t\t\t\t}}\n\t\t\t\tonClick={(e) => e.stopPropagation()}\n\t\t\t>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\tborderBottom: '1px solid #e5e7eb',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h2 style={{ margin: 0, fontSize: '24px', fontWeight: '700', color: '#111827' }}>\n\t\t\t\t\t\t\tMFA Flow API Comparison\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tAPI calls and parameters for Admin, Admin Activation Required, and User flows\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t\t<button\n\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'none',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t√ó\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Content */}\n\t\t\t\t<div style={{ padding: '24px' }}>\n\t\t\t\t\t{Object.entries(apiEndpoints).map(([key, flow]) => (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tkey={key}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginBottom: '32px',\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\tkey === 'admin'\n\t\t\t\t\t\t\t\t\t\t? '#f0fdf4'\n\t\t\t\t\t\t\t\t\t\t: key === 'adminActivationRequired'\n\t\t\t\t\t\t\t\t\t\t\t? '#fef3c7'\n\t\t\t\t\t\t\t\t\t\t\t: '#dbeafe',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Flow Header */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{flow.name}\n\t\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\t\t{flow.description}\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* API Details */}\n\t\t\t\t\t\t\t<div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>\n\t\t\t\t\t\t\t\t{/* Left Column */}\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t{/* URL and Method */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tEndpoint\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: flow.method === 'POST' ? '#10b981' : '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{flow.method}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t<code\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{flow.url}\n\t\t\t\t\t\t\t\t\t\t\t</code>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Headers */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tHeaders\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t{renderCodeBlock(flow.headers)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t{/* Right Column */}\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t{/* Request Body */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRequest Body\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t{renderCodeBlock(flow.body)}\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Response */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tResponse\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t{renderCodeBlock(flow.response)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Notes */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìù Notes\n\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '13px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t{flow.notes}\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t))}\n\n\t\t\t\t\t{/* Key Differences Summary */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '20px',\n\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h3\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 16px 0',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîë Key Differences\n\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t<ul\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tpaddingLeft: '20px',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>Token Type:</strong> Admin flows use <code>tokenType: 'worker'</code>, User\n\t\t\t\t\t\t\t\tflow uses <code>tokenType: 'user'</code>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>Authentication:</strong> Admin flows use Worker Token, User flow requires\n\t\t\t\t\t\t\t\tUser Token from OAuth login\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>Device Status:</strong> Admin flow can choose <code>'ACTIVE'</code> or{' '}\n\t\t\t\t\t\t\t\t<code>'ACTIVATION_REQUIRED'</code>, User flow always uses{' '}\n\t\t\t\t\t\t\t\t<code>'ACTIVATION_REQUIRED'</code>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>OTP Requirement:</strong> Only flows with <code>'ACTIVATION_REQUIRED'</code>{' '}\n\t\t\t\t\t\t\t\tstatus trigger OTP automatically\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>User Token:</strong> User flow includes <code>userToken</code> field from\n\t\t\t\t\t\t\t\tOAuth login\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n"},"tags":[],"source":null},{"category":"lint/a11y/noStaticElementInteractions","severity":"error","description":"Static Elements should not be interactive.","message":[{"elements":[],"content":"Static Elements should not be interactive."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"To add interactivity such as a mouse or key event listener to a static element, give the element an appropriate role value."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/APIComparisonModal.tsx"},"span":[3198,3455],"sourceCode":"/**\n * @file APIComparisonModal.tsx\n * @module v8/flows/unified/components\n * @description Modal showing API differences between Admin, Admin Activation Required, and User flows\n * @version 8.0.0\n */\n\nimport React from 'react';\n\ninterface APIComparisonModalProps {\n\tisOpen: boolean;\n\tonClose: () => void;\n}\n\nexport const APIComparisonModal: React.FC<APIComparisonModalProps> = ({ isOpen, onClose }) => {\n\tif (!isOpen) return null;\n\n\tconst apiEndpoints = {\n\t\tadmin: {\n\t\t\tname: 'Admin Flow',\n\t\t\tdescription: 'Uses Worker Token, creates device with ACTIVE status',\n\t\t\tmethod: 'POST',\n\t\t\turl: '/api/pingone/mfa/register-device',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\tAuthorization: 'Bearer WORKER_TOKEN',\n\t\t\t},\n\t\t\tbody: {\n\t\t\t\tenvironmentId: 'env-123456',\n\t\t\t\tusername: 'admin@example.com',\n\t\t\t\ttype: 'SMS',\n\t\t\t\ttokenType: 'worker',\n\t\t\t\tstatus: 'ACTIVE',\n\t\t\t\tphoneNumber: '+1234567890',\n\t\t\t\tcountryCode: '+1',\n\t\t\t},\n\t\t\tresponse: {\n\t\t\t\tdeviceId: 'dev-123456',\n\t\t\t\tstatus: 'ACTIVE',\n\t\t\t\ttype: 'SMS',\n\t\t\t\tcreatedAt: '2026-01-30T00:00:00Z',\n\t\t\t},\n\t\t\tnotes: 'Device is immediately active and ready to use. No OTP required.',\n\t\t},\n\t\tadminActivationRequired: {\n\t\t\tname: 'Admin Activation Required Flow',\n\t\t\tdescription: 'Uses Worker Token, creates device with ACTIVATION_REQUIRED status',\n\t\t\tmethod: 'POST',\n\t\t\turl: '/api/pingone/mfa/register-device',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\tAuthorization: 'Bearer WORKER_TOKEN',\n\t\t\t},\n\t\t\tbody: {\n\t\t\t\tenvironmentId: 'env-123456',\n\t\t\t\tusername: 'admin@example.com',\n\t\t\t\ttype: 'SMS',\n\t\t\t\ttokenType: 'worker',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\tphoneNumber: '+1234567890',\n\t\t\t\tcountryCode: '+1',\n\t\t\t},\n\t\t\tresponse: {\n\t\t\t\tdeviceId: 'dev-123456',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\ttype: 'SMS',\n\t\t\t\tdeviceActivateUri: '/api/pingone/mfa/devices/dev-123456/activate',\n\t\t\t\tcreatedAt: '2026-01-30T00:00:00Z',\n\t\t\t},\n\t\t\tnotes: 'PingOne automatically sends OTP. User must validate OTP to activate device.',\n\t\t},\n\t\tuser: {\n\t\t\tname: 'User Flow',\n\t\t\tdescription:\n\t\t\t\t'Uses User Token (from OAuth login), creates device with ACTIVATION_REQUIRED status',\n\t\t\tmethod: 'POST',\n\t\t\turl: '/api/pingone/mfa/register-device',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\tAuthorization: 'Bearer USER_TOKEN',\n\t\t\t},\n\t\t\tbody: {\n\t\t\t\tenvironmentId: 'env-123456',\n\t\t\t\tusername: 'user@example.com',\n\t\t\t\ttype: 'SMS',\n\t\t\t\ttokenType: 'user',\n\t\t\t\tuserToken: 'oauth-user-token-123',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\tphoneNumber: '+1234567890',\n\t\t\t\tcountryCode: '+1',\n\t\t\t},\n\t\t\tresponse: {\n\t\t\t\tdeviceId: 'dev-123456',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\ttype: 'SMS',\n\t\t\t\tdeviceActivateUri: '/api/pingone/mfa/devices/dev-123456/activate',\n\t\t\t\tcreatedAt: '2026-01-30T00:00:00Z',\n\t\t\t},\n\t\t\tnotes:\n\t\t\t\t'User must be logged into PingOne first. PingOne automatically sends OTP for activation.',\n\t\t},\n\t};\n\n\tconst renderCodeBlock = (code: object) => (\n\t\t<pre\n\t\t\tstyle={{\n\t\t\t\tbackground: '#1e293b',\n\t\t\t\tcolor: '#e2e8f0',\n\t\t\t\tpadding: '16px',\n\t\t\t\tborderRadius: '8px',\n\t\t\t\toverflow: 'auto',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tfontFamily: 'Monaco, Consolas, monospace',\n\t\t\t}}\n\t\t>\n\t\t\t<code>{JSON.stringify(code, null, 2)}</code>\n\t\t</pre>\n\t);\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tposition: 'fixed',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\tdisplay: 'flex',\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tzIndex: 1000,\n\t\t\t}}\n\t\t\tonClick={onClose}\n\t\t>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'white',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tmaxWidth: '1200px',\n\t\t\t\t\twidth: '90%',\n\t\t\t\t\tmaxHeight: '90vh',\n\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\tboxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',\n\t\t\t\t}}\n\t\t\t\tonClick={(e) => e.stopPropagation()}\n\t\t\t>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\tborderBottom: '1px solid #e5e7eb',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h2 style={{ margin: 0, fontSize: '24px', fontWeight: '700', color: '#111827' }}>\n\t\t\t\t\t\t\tMFA Flow API Comparison\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tAPI calls and parameters for Admin, Admin Activation Required, and User flows\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t\t<button\n\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'none',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t√ó\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Content */}\n\t\t\t\t<div style={{ padding: '24px' }}>\n\t\t\t\t\t{Object.entries(apiEndpoints).map(([key, flow]) => (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tkey={key}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginBottom: '32px',\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\tkey === 'admin'\n\t\t\t\t\t\t\t\t\t\t? '#f0fdf4'\n\t\t\t\t\t\t\t\t\t\t: key === 'adminActivationRequired'\n\t\t\t\t\t\t\t\t\t\t\t? '#fef3c7'\n\t\t\t\t\t\t\t\t\t\t\t: '#dbeafe',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Flow Header */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{flow.name}\n\t\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\t\t{flow.description}\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* API Details */}\n\t\t\t\t\t\t\t<div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>\n\t\t\t\t\t\t\t\t{/* Left Column */}\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t{/* URL and Method */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tEndpoint\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: flow.method === 'POST' ? '#10b981' : '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{flow.method}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t<code\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{flow.url}\n\t\t\t\t\t\t\t\t\t\t\t</code>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Headers */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tHeaders\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t{renderCodeBlock(flow.headers)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t{/* Right Column */}\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t{/* Request Body */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRequest Body\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t{renderCodeBlock(flow.body)}\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Response */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tResponse\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t{renderCodeBlock(flow.response)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Notes */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìù Notes\n\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '13px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t{flow.notes}\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t))}\n\n\t\t\t\t\t{/* Key Differences Summary */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '20px',\n\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h3\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 16px 0',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîë Key Differences\n\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t<ul\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tpaddingLeft: '20px',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>Token Type:</strong> Admin flows use <code>tokenType: 'worker'</code>, User\n\t\t\t\t\t\t\t\tflow uses <code>tokenType: 'user'</code>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>Authentication:</strong> Admin flows use Worker Token, User flow requires\n\t\t\t\t\t\t\t\tUser Token from OAuth login\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>Device Status:</strong> Admin flow can choose <code>'ACTIVE'</code> or{' '}\n\t\t\t\t\t\t\t\t<code>'ACTIVATION_REQUIRED'</code>, User flow always uses{' '}\n\t\t\t\t\t\t\t\t<code>'ACTIVATION_REQUIRED'</code>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>OTP Requirement:</strong> Only flows with <code>'ACTIVATION_REQUIRED'</code>{' '}\n\t\t\t\t\t\t\t\tstatus trigger OTP automatically\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>User Token:</strong> User flow includes <code>userToken</code> field from\n\t\t\t\t\t\t\t\tOAuth login\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n"},"tags":[],"source":null},{"category":"lint/a11y/useButtonType","severity":"error","description":"Provide an explicit type prop for the button element.","message":[{"elements":[],"content":"Provide an explicit "},{"elements":["Emphasis"],"content":"type"},{"elements":[],"content":" prop for the "},{"elements":["Emphasis"],"content":"button"},{"elements":[],"content":" element."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"The default "},{"elements":["Emphasis"],"content":"type"},{"elements":[],"content":" of a button is "},{"elements":["Emphasis"],"content":"submit"},{"elements":[],"content":", which causes the submission of a form when placed inside a `form` element. This is likely not the behaviour that you want inside a React application."}]]},{"log":["info",[{"elements":[],"content":"Allowed button types are: "},{"elements":["Emphasis"],"content":"submit"},{"elements":[],"content":", "},{"elements":["Emphasis"],"content":"button"},{"elements":[],"content":" or "},{"elements":["Emphasis"],"content":"reset"},{"elements":[],"content":""}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/APIComparisonModal.tsx"},"span":[4310,4521],"sourceCode":"/**\n * @file APIComparisonModal.tsx\n * @module v8/flows/unified/components\n * @description Modal showing API differences between Admin, Admin Activation Required, and User flows\n * @version 8.0.0\n */\n\nimport React from 'react';\n\ninterface APIComparisonModalProps {\n\tisOpen: boolean;\n\tonClose: () => void;\n}\n\nexport const APIComparisonModal: React.FC<APIComparisonModalProps> = ({ isOpen, onClose }) => {\n\tif (!isOpen) return null;\n\n\tconst apiEndpoints = {\n\t\tadmin: {\n\t\t\tname: 'Admin Flow',\n\t\t\tdescription: 'Uses Worker Token, creates device with ACTIVE status',\n\t\t\tmethod: 'POST',\n\t\t\turl: '/api/pingone/mfa/register-device',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\tAuthorization: 'Bearer WORKER_TOKEN',\n\t\t\t},\n\t\t\tbody: {\n\t\t\t\tenvironmentId: 'env-123456',\n\t\t\t\tusername: 'admin@example.com',\n\t\t\t\ttype: 'SMS',\n\t\t\t\ttokenType: 'worker',\n\t\t\t\tstatus: 'ACTIVE',\n\t\t\t\tphoneNumber: '+1234567890',\n\t\t\t\tcountryCode: '+1',\n\t\t\t},\n\t\t\tresponse: {\n\t\t\t\tdeviceId: 'dev-123456',\n\t\t\t\tstatus: 'ACTIVE',\n\t\t\t\ttype: 'SMS',\n\t\t\t\tcreatedAt: '2026-01-30T00:00:00Z',\n\t\t\t},\n\t\t\tnotes: 'Device is immediately active and ready to use. No OTP required.',\n\t\t},\n\t\tadminActivationRequired: {\n\t\t\tname: 'Admin Activation Required Flow',\n\t\t\tdescription: 'Uses Worker Token, creates device with ACTIVATION_REQUIRED status',\n\t\t\tmethod: 'POST',\n\t\t\turl: '/api/pingone/mfa/register-device',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\tAuthorization: 'Bearer WORKER_TOKEN',\n\t\t\t},\n\t\t\tbody: {\n\t\t\t\tenvironmentId: 'env-123456',\n\t\t\t\tusername: 'admin@example.com',\n\t\t\t\ttype: 'SMS',\n\t\t\t\ttokenType: 'worker',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\tphoneNumber: '+1234567890',\n\t\t\t\tcountryCode: '+1',\n\t\t\t},\n\t\t\tresponse: {\n\t\t\t\tdeviceId: 'dev-123456',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\ttype: 'SMS',\n\t\t\t\tdeviceActivateUri: '/api/pingone/mfa/devices/dev-123456/activate',\n\t\t\t\tcreatedAt: '2026-01-30T00:00:00Z',\n\t\t\t},\n\t\t\tnotes: 'PingOne automatically sends OTP. User must validate OTP to activate device.',\n\t\t},\n\t\tuser: {\n\t\t\tname: 'User Flow',\n\t\t\tdescription:\n\t\t\t\t'Uses User Token (from OAuth login), creates device with ACTIVATION_REQUIRED status',\n\t\t\tmethod: 'POST',\n\t\t\turl: '/api/pingone/mfa/register-device',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\tAuthorization: 'Bearer USER_TOKEN',\n\t\t\t},\n\t\t\tbody: {\n\t\t\t\tenvironmentId: 'env-123456',\n\t\t\t\tusername: 'user@example.com',\n\t\t\t\ttype: 'SMS',\n\t\t\t\ttokenType: 'user',\n\t\t\t\tuserToken: 'oauth-user-token-123',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\tphoneNumber: '+1234567890',\n\t\t\t\tcountryCode: '+1',\n\t\t\t},\n\t\t\tresponse: {\n\t\t\t\tdeviceId: 'dev-123456',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\ttype: 'SMS',\n\t\t\t\tdeviceActivateUri: '/api/pingone/mfa/devices/dev-123456/activate',\n\t\t\t\tcreatedAt: '2026-01-30T00:00:00Z',\n\t\t\t},\n\t\t\tnotes:\n\t\t\t\t'User must be logged into PingOne first. PingOne automatically sends OTP for activation.',\n\t\t},\n\t};\n\n\tconst renderCodeBlock = (code: object) => (\n\t\t<pre\n\t\t\tstyle={{\n\t\t\t\tbackground: '#1e293b',\n\t\t\t\tcolor: '#e2e8f0',\n\t\t\t\tpadding: '16px',\n\t\t\t\tborderRadius: '8px',\n\t\t\t\toverflow: 'auto',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tfontFamily: 'Monaco, Consolas, monospace',\n\t\t\t}}\n\t\t>\n\t\t\t<code>{JSON.stringify(code, null, 2)}</code>\n\t\t</pre>\n\t);\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tposition: 'fixed',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\tdisplay: 'flex',\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tzIndex: 1000,\n\t\t\t}}\n\t\t\tonClick={onClose}\n\t\t>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'white',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tmaxWidth: '1200px',\n\t\t\t\t\twidth: '90%',\n\t\t\t\t\tmaxHeight: '90vh',\n\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\tboxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',\n\t\t\t\t}}\n\t\t\t\tonClick={(e) => e.stopPropagation()}\n\t\t\t>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\tborderBottom: '1px solid #e5e7eb',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h2 style={{ margin: 0, fontSize: '24px', fontWeight: '700', color: '#111827' }}>\n\t\t\t\t\t\t\tMFA Flow API Comparison\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tAPI calls and parameters for Admin, Admin Activation Required, and User flows\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t\t<button\n\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'none',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t√ó\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Content */}\n\t\t\t\t<div style={{ padding: '24px' }}>\n\t\t\t\t\t{Object.entries(apiEndpoints).map(([key, flow]) => (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tkey={key}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginBottom: '32px',\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\tkey === 'admin'\n\t\t\t\t\t\t\t\t\t\t? '#f0fdf4'\n\t\t\t\t\t\t\t\t\t\t: key === 'adminActivationRequired'\n\t\t\t\t\t\t\t\t\t\t\t? '#fef3c7'\n\t\t\t\t\t\t\t\t\t\t\t: '#dbeafe',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Flow Header */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{flow.name}\n\t\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\t\t{flow.description}\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* API Details */}\n\t\t\t\t\t\t\t<div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>\n\t\t\t\t\t\t\t\t{/* Left Column */}\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t{/* URL and Method */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tEndpoint\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: flow.method === 'POST' ? '#10b981' : '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{flow.method}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t<code\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{flow.url}\n\t\t\t\t\t\t\t\t\t\t\t</code>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Headers */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tHeaders\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t{renderCodeBlock(flow.headers)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t{/* Right Column */}\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t{/* Request Body */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRequest Body\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t{renderCodeBlock(flow.body)}\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Response */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tResponse\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t{renderCodeBlock(flow.response)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Notes */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìù Notes\n\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '13px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t{flow.notes}\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t))}\n\n\t\t\t\t\t{/* Key Differences Summary */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '20px',\n\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h3\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 16px 0',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîë Key Differences\n\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t<ul\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tpaddingLeft: '20px',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>Token Type:</strong> Admin flows use <code>tokenType: 'worker'</code>, User\n\t\t\t\t\t\t\t\tflow uses <code>tokenType: 'user'</code>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>Authentication:</strong> Admin flows use Worker Token, User flow requires\n\t\t\t\t\t\t\t\tUser Token from OAuth login\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>Device Status:</strong> Admin flow can choose <code>'ACTIVE'</code> or{' '}\n\t\t\t\t\t\t\t\t<code>'ACTIVATION_REQUIRED'</code>, User flow always uses{' '}\n\t\t\t\t\t\t\t\t<code>'ACTIVATION_REQUIRED'</code>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>OTP Requirement:</strong> Only flows with <code>'ACTIVATION_REQUIRED'</code>{' '}\n\t\t\t\t\t\t\t\tstatus trigger OTP automatically\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>User Token:</strong> User flow includes <code>userToken</code> field from\n\t\t\t\t\t\t\t\tOAuth login\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n"},"tags":[],"source":null},{"category":"lint/a11y/useKeyWithClickEvents","severity":"error","description":"Enforce to have the onClick mouse event with the onKeyUp, the onKeyDown, or the onKeyPress keyboard event.","message":[{"elements":[],"content":"Enforce to have the "},{"elements":["Emphasis"],"content":"onClick"},{"elements":[],"content":" mouse event with the "},{"elements":["Emphasis"],"content":"onKeyUp"},{"elements":[],"content":", the "},{"elements":["Emphasis"],"content":"onKeyDown"},{"elements":[],"content":", or the "},{"elements":["Emphasis"],"content":"onKeyPress"},{"elements":[],"content":" keyboard event."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Actions triggered using mouse events should have corresponding keyboard events to account for keyboard-only navigation."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/APIComparisonModal.tsx"},"span":[3198,3455],"sourceCode":"/**\n * @file APIComparisonModal.tsx\n * @module v8/flows/unified/components\n * @description Modal showing API differences between Admin, Admin Activation Required, and User flows\n * @version 8.0.0\n */\n\nimport React from 'react';\n\ninterface APIComparisonModalProps {\n\tisOpen: boolean;\n\tonClose: () => void;\n}\n\nexport const APIComparisonModal: React.FC<APIComparisonModalProps> = ({ isOpen, onClose }) => {\n\tif (!isOpen) return null;\n\n\tconst apiEndpoints = {\n\t\tadmin: {\n\t\t\tname: 'Admin Flow',\n\t\t\tdescription: 'Uses Worker Token, creates device with ACTIVE status',\n\t\t\tmethod: 'POST',\n\t\t\turl: '/api/pingone/mfa/register-device',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\tAuthorization: 'Bearer WORKER_TOKEN',\n\t\t\t},\n\t\t\tbody: {\n\t\t\t\tenvironmentId: 'env-123456',\n\t\t\t\tusername: 'admin@example.com',\n\t\t\t\ttype: 'SMS',\n\t\t\t\ttokenType: 'worker',\n\t\t\t\tstatus: 'ACTIVE',\n\t\t\t\tphoneNumber: '+1234567890',\n\t\t\t\tcountryCode: '+1',\n\t\t\t},\n\t\t\tresponse: {\n\t\t\t\tdeviceId: 'dev-123456',\n\t\t\t\tstatus: 'ACTIVE',\n\t\t\t\ttype: 'SMS',\n\t\t\t\tcreatedAt: '2026-01-30T00:00:00Z',\n\t\t\t},\n\t\t\tnotes: 'Device is immediately active and ready to use. No OTP required.',\n\t\t},\n\t\tadminActivationRequired: {\n\t\t\tname: 'Admin Activation Required Flow',\n\t\t\tdescription: 'Uses Worker Token, creates device with ACTIVATION_REQUIRED status',\n\t\t\tmethod: 'POST',\n\t\t\turl: '/api/pingone/mfa/register-device',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\tAuthorization: 'Bearer WORKER_TOKEN',\n\t\t\t},\n\t\t\tbody: {\n\t\t\t\tenvironmentId: 'env-123456',\n\t\t\t\tusername: 'admin@example.com',\n\t\t\t\ttype: 'SMS',\n\t\t\t\ttokenType: 'worker',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\tphoneNumber: '+1234567890',\n\t\t\t\tcountryCode: '+1',\n\t\t\t},\n\t\t\tresponse: {\n\t\t\t\tdeviceId: 'dev-123456',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\ttype: 'SMS',\n\t\t\t\tdeviceActivateUri: '/api/pingone/mfa/devices/dev-123456/activate',\n\t\t\t\tcreatedAt: '2026-01-30T00:00:00Z',\n\t\t\t},\n\t\t\tnotes: 'PingOne automatically sends OTP. User must validate OTP to activate device.',\n\t\t},\n\t\tuser: {\n\t\t\tname: 'User Flow',\n\t\t\tdescription:\n\t\t\t\t'Uses User Token (from OAuth login), creates device with ACTIVATION_REQUIRED status',\n\t\t\tmethod: 'POST',\n\t\t\turl: '/api/pingone/mfa/register-device',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\tAuthorization: 'Bearer USER_TOKEN',\n\t\t\t},\n\t\t\tbody: {\n\t\t\t\tenvironmentId: 'env-123456',\n\t\t\t\tusername: 'user@example.com',\n\t\t\t\ttype: 'SMS',\n\t\t\t\ttokenType: 'user',\n\t\t\t\tuserToken: 'oauth-user-token-123',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\tphoneNumber: '+1234567890',\n\t\t\t\tcountryCode: '+1',\n\t\t\t},\n\t\t\tresponse: {\n\t\t\t\tdeviceId: 'dev-123456',\n\t\t\t\tstatus: 'ACTIVATION_REQUIRED',\n\t\t\t\ttype: 'SMS',\n\t\t\t\tdeviceActivateUri: '/api/pingone/mfa/devices/dev-123456/activate',\n\t\t\t\tcreatedAt: '2026-01-30T00:00:00Z',\n\t\t\t},\n\t\t\tnotes:\n\t\t\t\t'User must be logged into PingOne first. PingOne automatically sends OTP for activation.',\n\t\t},\n\t};\n\n\tconst renderCodeBlock = (code: object) => (\n\t\t<pre\n\t\t\tstyle={{\n\t\t\t\tbackground: '#1e293b',\n\t\t\t\tcolor: '#e2e8f0',\n\t\t\t\tpadding: '16px',\n\t\t\t\tborderRadius: '8px',\n\t\t\t\toverflow: 'auto',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tfontFamily: 'Monaco, Consolas, monospace',\n\t\t\t}}\n\t\t>\n\t\t\t<code>{JSON.stringify(code, null, 2)}</code>\n\t\t</pre>\n\t);\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tposition: 'fixed',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\tdisplay: 'flex',\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tzIndex: 1000,\n\t\t\t}}\n\t\t\tonClick={onClose}\n\t\t>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'white',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tmaxWidth: '1200px',\n\t\t\t\t\twidth: '90%',\n\t\t\t\t\tmaxHeight: '90vh',\n\t\t\t\t\toverflow: 'auto',\n\t\t\t\t\tboxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',\n\t\t\t\t}}\n\t\t\t\tonClick={(e) => e.stopPropagation()}\n\t\t\t>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\tborderBottom: '1px solid #e5e7eb',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h2 style={{ margin: 0, fontSize: '24px', fontWeight: '700', color: '#111827' }}>\n\t\t\t\t\t\t\tMFA Flow API Comparison\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\tAPI calls and parameters for Admin, Admin Activation Required, and User flows\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t\t<button\n\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: 'none',\n\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\tpadding: '4px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t√ó\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Content */}\n\t\t\t\t<div style={{ padding: '24px' }}>\n\t\t\t\t\t{Object.entries(apiEndpoints).map(([key, flow]) => (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tkey={key}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginBottom: '32px',\n\t\t\t\t\t\t\t\tpadding: '24px',\n\t\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\tkey === 'admin'\n\t\t\t\t\t\t\t\t\t\t? '#f0fdf4'\n\t\t\t\t\t\t\t\t\t\t: key === 'adminActivationRequired'\n\t\t\t\t\t\t\t\t\t\t\t? '#fef3c7'\n\t\t\t\t\t\t\t\t\t\t\t: '#dbeafe',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Flow Header */}\n\t\t\t\t\t\t\t<div style={{ marginBottom: '20px' }}>\n\t\t\t\t\t\t\t\t<h3 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: '#111827' }}>\n\t\t\t\t\t\t\t\t\t{flow.name}\n\t\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t\t<p style={{ margin: '8px 0 0 0', fontSize: '14px', color: '#6b7280' }}>\n\t\t\t\t\t\t\t\t\t{flow.description}\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* API Details */}\n\t\t\t\t\t\t\t<div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>\n\t\t\t\t\t\t\t\t{/* Left Column */}\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t{/* URL and Method */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tEndpoint\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: flow.method === 'POST' ? '#10b981' : '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{flow.method}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t<code\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#f3f4f6',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '4px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{flow.url}\n\t\t\t\t\t\t\t\t\t\t\t</code>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Headers */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tHeaders\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t{renderCodeBlock(flow.headers)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t{/* Right Column */}\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t{/* Request Body */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tRequest Body\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t{renderCodeBlock(flow.body)}\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Response */}\n\t\t\t\t\t\t\t\t\t<div style={{ marginBottom: '16px' }}>\n\t\t\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tResponse\n\t\t\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t\t\t{renderCodeBlock(flow.response)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{/* Notes */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tmarginTop: '16px',\n\t\t\t\t\t\t\t\t\tpadding: '12px',\n\t\t\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<h4\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tüìù Notes\n\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t\t<p style={{ margin: 0, fontSize: '13px', color: '#6b7280', lineHeight: '1.5' }}>\n\t\t\t\t\t\t\t\t\t{flow.notes}\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t))}\n\n\t\t\t\t\t{/* Key Differences Summary */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: '20px',\n\t\t\t\t\t\t\tbackground: '#f9fafb',\n\t\t\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\tmarginTop: '24px',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h3\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: '0 0 16px 0',\n\t\t\t\t\t\t\t\tfontSize: '16px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tüîë Key Differences\n\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t<ul\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\t\t\tpaddingLeft: '20px',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tlineHeight: '1.6',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>Token Type:</strong> Admin flows use <code>tokenType: 'worker'</code>, User\n\t\t\t\t\t\t\t\tflow uses <code>tokenType: 'user'</code>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>Authentication:</strong> Admin flows use Worker Token, User flow requires\n\t\t\t\t\t\t\t\tUser Token from OAuth login\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>Device Status:</strong> Admin flow can choose <code>'ACTIVE'</code> or{' '}\n\t\t\t\t\t\t\t\t<code>'ACTIVATION_REQUIRED'</code>, User flow always uses{' '}\n\t\t\t\t\t\t\t\t<code>'ACTIVATION_REQUIRED'</code>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>OTP Requirement:</strong> Only flows with <code>'ACTIVATION_REQUIRED'</code>{' '}\n\t\t\t\t\t\t\t\tstatus trigger OTP automatically\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<strong>User Token:</strong> User flow includes <code>userToken</code> field from\n\t\t\t\t\t\t\t\tOAuth login\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n"},"tags":[],"source":null},{"category":"lint/security/noDangerouslySetInnerHtml","severity":"error","description":"Avoid passing content using the dangerouslySetInnerHTML prop.","message":[{"elements":[],"content":"Avoid passing content using the "},{"elements":["Emphasis"],"content":"dangerouslySetInnerHTML"},{"elements":[],"content":" prop."}],"advices":{"advices":[{"log":["warn",[{"elements":[],"content":"Setting content using code can expose users to cross-site scripting (XSS) attacks"}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/DeviceComponentRegistry.tsx"},"span":[12197,12220],"sourceCode":"/**\n * @file DeviceComponentRegistry.tsx\n * @module v8/flows/unified/components\n * @description Registry of device-specific custom components for complex flows\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle the 20% of device flows that are too complex for dynamic forms.\n * TOTP needs QR code display, FIDO2 needs WebAuthn, Mobile needs app pairing.\n *\n * Architecture:\n * - Each component receives standard props (credentials, mfaState, callbacks)\n * - Components manage their own device-specific UI\n * - Registry maps device types to components (null = use DynamicFormRenderer)\n *\n * @example\n * const CustomComponent = DeviceComponentRegistry[deviceType];\n * if (CustomComponent) {\n *   return <CustomComponent {...props} />;\n * } else {\n *   return <DynamicFormRenderer {...props} />;\n * }\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport type { DeviceConfigKey, DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFACredentials, MFAState } from '@/v8/flows/shared/MFATypes';\n\nconst MODULE_TAG = '[üé® DEVICE-COMPONENT-REGISTRY]';\n\n// ============================================================================\n// SHARED PROPS INTERFACE\n// ============================================================================\n\n/**\n * Props passed to device-specific custom components\n */\nexport interface DeviceComponentProps {\n\t/** MFA credentials */\n\tcredentials: MFACredentials;\n\n\t/** MFA state (contains device-specific data like QR codes) */\n\tmfaState: MFAState;\n\n\t/** Update MFA state */\n\tsetMfaState: (state: MFAState | ((prev: MFAState) => MFAState)) => void;\n\n\t/** Success callback */\n\tonSuccess: (data: Record<string, unknown>) => void;\n\n\t/** Error callback */\n\tonError: (error: string) => void;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device configuration */\n\tconfig: DeviceFlowConfig;\n}\n\n// ============================================================================\n// TOTP REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * TOTP Registration Component\n *\n * Displays QR code and secret key for authenticator app setup.\n * Used for Google Authenticator, Authy, Microsoft Authenticator, etc.\n */\nexport const TOTPRegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tmfaState,\n\tconfig,\n\tonSuccess,\n\tonError,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering TOTP registration component`, {\n\t\thasQRCode: !!mfaState.qrCodeUrl,\n\t\thasSecret: !!mfaState.totpSecret,\n\t});\n\n\tconst [showSecret, setShowSecret] = useState(false);\n\tconst [copied, setCopied] = useState(false);\n\n\t// Handle copy secret to clipboard\n\tconst handleCopySecret = useCallback(() => {\n\t\tif (mfaState.totpSecret) {\n\t\t\tnavigator.clipboard\n\t\t\t\t.writeText(mfaState.totpSecret)\n\t\t\t\t.then(() => {\n\t\t\t\t\tconsole.log(`${MODULE_TAG} Secret copied to clipboard`);\n\t\t\t\t\tsetCopied(true);\n\t\t\t\t\tsetTimeout(() => setCopied(false), 2000);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tconsole.error(`${MODULE_TAG} Failed to copy secret:`, err);\n\t\t\t\t\tonError('Failed to copy secret to clipboard');\n\t\t\t\t});\n\t\t}\n\t}, [mfaState.totpSecret, onError]);\n\n\treturn (\n\t\t<div className=\"totp-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"totp-header\">\n\t\t\t\t<h3>{config.icon} Set Up Authenticator App</h3>\n\t\t\t\t<p className=\"totp-description\">\n\t\t\t\t\tScan the QR code below with your authenticator app, or enter the secret key manually.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* QR Code Display */}\n\t\t\t{mfaState.qrCodeUrl && (\n\t\t\t\t<div className=\"qr-code-section\">\n\t\t\t\t\t<div className=\"qr-code-container\">\n\t\t\t\t\t\t<img src={mfaState.qrCodeUrl} alt=\"TOTP QR Code\" className=\"qr-code-image\" />\n\t\t\t\t\t</div>\n\t\t\t\t\t<p className=\"qr-instruction\">Scan this QR code with your authenticator app</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Manual Entry Section */}\n\t\t\t{mfaState.totpSecret && (\n\t\t\t\t<div className=\"manual-entry-section\">\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowSecret(!showSecret)}\n\t\t\t\t\t\tclassName=\"toggle-secret-button\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{showSecret ? 'Hide' : 'Show'} Manual Entry Key\n\t\t\t\t\t</button>\n\n\t\t\t\t\t{showSecret && (\n\t\t\t\t\t\t<div className=\"secret-display\">\n\t\t\t\t\t\t\t<label htmlFor=\"totp-secret\">Secret Key:</label>\n\t\t\t\t\t\t\t<div className=\"secret-input-group\">\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"totp-secret\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={mfaState.totpSecret}\n\t\t\t\t\t\t\t\t\treadOnly\n\t\t\t\t\t\t\t\t\tclassName=\"secret-input\"\n\t\t\t\t\t\t\t\t\tonClick={(e) => e.currentTarget.select()}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleCopySecret}\n\t\t\t\t\t\t\t\t\tclassName=\"copy-button\"\n\t\t\t\t\t\t\t\t\taria-label=\"Copy secret to clipboard\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{copied ? '‚úì Copied' : 'üìã Copy'}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p className=\"secret-hint\">\n\t\t\t\t\t\t\t\tEnter this key manually in your authenticator app if you can't scan the QR code.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Supported Apps */}\n\t\t\t<details className=\"supported-apps\">\n\t\t\t\t<summary>Supported Authenticator Apps</summary>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>Google Authenticator</li>\n\t\t\t\t\t<li>Microsoft Authenticator</li>\n\t\t\t\t\t<li>Authy</li>\n\t\t\t\t\t<li>1Password</li>\n\t\t\t\t\t<li>LastPass Authenticator</li>\n\t\t\t\t\t<li>Any TOTP-compatible app</li>\n\t\t\t\t</ul>\n\t\t\t</details>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"totp-education\">\n\t\t\t\t\t<summary>Learn more about TOTP</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\n\t\t\t{/* No QR Code Warning */}\n\t\t\t{!mfaState.qrCodeUrl && !mfaState.totpSecret && (\n\t\t\t\t<div className=\"no-data-warning\">\n\t\t\t\t\t<p>‚ö†Ô∏è QR code and secret not available yet.</p>\n\t\t\t\t\t<p>Please complete device registration first.</p>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// FIDO2 REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * FIDO2 Registration Component\n *\n * Triggers WebAuthn credential registration for security keys and biometrics.\n * Used for YubiKey, Windows Hello, Touch ID, Face ID, etc.\n */\nexport const FIDO2RegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tcredentials,\n\tmfaState,\n\tsetMfaState,\n\tonSuccess,\n\tonError,\n\tcontroller,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering FIDO2 registration component`, {\n\t\thasOptions: !!mfaState.publicKeyCredentialCreationOptions,\n\t});\n\n\tconst [isRegistering, setIsRegistering] = useState(false);\n\tconst [browserSupported, setBrowserSupported] = useState(true);\n\n\t// Check browser support on mount\n\tuseEffect(() => {\n\t\tconst supported =\n\t\t\twindow.PublicKeyCredential !== undefined && navigator.credentials !== undefined;\n\n\t\tconsole.log(`${MODULE_TAG} WebAuthn support:`, supported);\n\t\tsetBrowserSupported(supported);\n\n\t\tif (!supported) {\n\t\t\tonError(\n\t\t\t\t'Your browser does not support FIDO2/WebAuthn. Please use a modern browser like Chrome, Firefox, Safari, or Edge.'\n\t\t\t);\n\t\t}\n\t}, [onError]);\n\n\t/**\n\t * Handle WebAuthn registration\n\t * Calls the FIDO2FlowController to complete the full registration flow:\n\t * 1. Call navigator.credentials.create() with PingOne options\n\t * 2. Send attestation back to PingOne to activate device\n\t */\n\tconst handleWebAuthnRegistration = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting WebAuthn registration`);\n\t\tsetIsRegistering(true);\n\n\t\ttry {\n\t\t\t// Check if we have device ID and credential creation options\n\t\t\tif (!mfaState.deviceId) {\n\t\t\t\tthrow new Error('Device ID is missing. Please try registering again.');\n\t\t\t}\n\n\t\t\tconst options = mfaState.publicKeyCredentialCreationOptions;\n\n\t\t\tif (!options) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t'Missing WebAuthn credential creation options. Please complete device registration first.'\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t`${MODULE_TAG} Calling controller.registerFIDO2Device with deviceId:`,\n\t\t\t\tmfaState.deviceId\n\t\t\t);\n\n\t\t\t// Import FIDO2FlowController\n\t\t\tconst { FIDO2FlowController } = await import('@/v8/flows/controllers/FIDO2FlowController');\n\n\t\t\t// Check if controller is FIDO2FlowController instance, otherwise create one\n\t\t\tconst fido2Controller =\n\t\t\t\tcontroller instanceof FIDO2FlowController\n\t\t\t\t\t? controller\n\t\t\t\t\t: new FIDO2FlowController({\n\t\t\t\t\t\t\tonUpdate: (state: any) => setMfaState((prev) => ({ ...prev, ...state })),\n\t\t\t\t\t\t\tonError: (error: string) => console.error('FIDO2 Controller Error:', error),\n\t\t\t\t\t\t});\n\n\t\t\t// Call the full FIDO2 registration flow (WebAuthn + activation)\n\t\t\tconst result = await (fido2Controller as any).registerFIDO2Device(\n\t\t\t\tcredentials,\n\t\t\t\tmfaState.deviceId,\n\t\t\t\tJSON.stringify(options)\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} FIDO2 registration complete:`, result);\n\n\t\t\t// Update state with final device status\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceStatus: result.status,\n\t\t\t\tcredentialId: result.credentialId,\n\t\t\t}));\n\n\t\t\t// Call success callback - this will trigger navigation to next step\n\t\t\tonSuccess({\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tcredentialId: result.credentialId,\n\t\t\t});\n\t\t} catch (error: unknown) {\n\t\t\tconsole.error(`${MODULE_TAG} WebAuthn registration failed:`, error);\n\n\t\t\t// Handle common errors\n\t\t\tlet errorMessage = 'Biometric registration failed';\n\n\t\t\tif (error instanceof Error) {\n\t\t\t\terrorMessage = error.message;\n\t\t\t}\n\n\t\t\tonError(errorMessage);\n\t\t} finally {\n\t\t\tsetIsRegistering(false);\n\t\t}\n\t}, [mfaState, setMfaState, onSuccess, onError, controller, credentials]);\n\n\treturn (\n\t\t<div className=\"fido2-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"fido2-header\">\n\t\t\t\t<h3>{config.icon} Register Security Key or Biometric</h3>\n\t\t\t\t<p className=\"fido2-description\">\n\t\t\t\t\tUse a hardware security key or your device's biometric authentication (fingerprint, facial\n\t\t\t\t\trecognition).\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Browser Support Check */}\n\t\t\t{!browserSupported && (\n\t\t\t\t<div className=\"browser-not-supported\">\n\t\t\t\t\t<p>‚ùå Your browser does not support FIDO2/WebAuthn</p>\n\t\t\t\t\t<p>Please use Chrome, Firefox, Safari, or Edge</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Button */}\n\t\t\t{browserSupported && (\n\t\t\t\t<div className=\"fido2-registration-section\">\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={handleWebAuthnRegistration}\n\t\t\t\t\t\tdisabled={\n\t\t\t\t\t\t\tisRegistering || !mfaState.publicKeyCredentialCreationOptions || !mfaState.deviceId\n\t\t\t\t\t\t}\n\t\t\t\t\t\tclassName=\"webauthn-register-button\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{isRegistering ? 'üîê Authenticating...' : 'üîê Complete Biometric Registration'}\n\t\t\t\t\t</button>\n\n\t\t\t\t\t{isRegistering && (\n\t\t\t\t\t\t<p className=\"registration-hint\">\n\t\t\t\t\t\t\tüîê Follow the prompts from your browser to use your security key or biometric\n\t\t\t\t\t\t\t(TouchID/FaceID)...\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{!mfaState.publicKeyCredentialCreationOptions && (\n\t\t\t\t\t\t<p className=\"no-options-warning\">\n\t\t\t\t\t\t\t‚ö†Ô∏è Waiting for device creation... Click \"Next Step\" above to create the device first.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{mfaState.publicKeyCredentialCreationOptions && !isRegistering && (\n\t\t\t\t\t\t<p className=\"registration-ready\">\n\t\t\t\t\t\t\t‚úÖ Device created. Click the button above to complete biometric registration.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Supported Authenticators */}\n\t\t\t<details className=\"supported-authenticators\">\n\t\t\t\t<summary>Supported Authenticators</summary>\n\t\t\t\t<div className=\"authenticator-lists\">\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h4>Hardware Security Keys</h4>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>YubiKey (5 Series, Security Key)</li>\n\t\t\t\t\t\t\t<li>Google Titan Security Key</li>\n\t\t\t\t\t\t\t<li>Feitian ePass FIDO2</li>\n\t\t\t\t\t\t\t<li>Thetis FIDO2 Security Key</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h4>Platform Authenticators</h4>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>Windows Hello (fingerprint, facial recognition)</li>\n\t\t\t\t\t\t\t<li>Touch ID (MacBook, iMac)</li>\n\t\t\t\t\t\t\t<li>Face ID (iPhone, iPad)</li>\n\t\t\t\t\t\t\t<li>Android Biometrics</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</details>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"fido2-education\">\n\t\t\t\t\t<summary>Learn more about FIDO2</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MOBILE REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * Mobile Registration Component\n *\n * Displays QR code for PingOne Mobile app pairing.\n * Used for mobile push notifications.\n */\nexport const MobileRegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tmfaState,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering Mobile registration component`, {\n\t\thasQRCode: !!mfaState.qrCodeUrl,\n\t\thasPairingKey: !!mfaState.pairingKey,\n\t});\n\n\tconst [copied, setCopied] = useState(false);\n\n\t// Handle copy pairing key to clipboard\n\tconst handleCopyPairingKey = useCallback(() => {\n\t\tif (mfaState.pairingKey) {\n\t\t\tnavigator.clipboard\n\t\t\t\t.writeText(mfaState.pairingKey)\n\t\t\t\t.then(() => {\n\t\t\t\t\tconsole.log(`${MODULE_TAG} Pairing key copied to clipboard`);\n\t\t\t\t\tsetCopied(true);\n\t\t\t\t\tsetTimeout(() => setCopied(false), 2000);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tconsole.error(`${MODULE_TAG} Failed to copy pairing key:`, err);\n\t\t\t\t});\n\t\t}\n\t}, [mfaState.pairingKey]);\n\n\treturn (\n\t\t<div className=\"mobile-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"mobile-header\">\n\t\t\t\t<h3>{config.icon} Pair PingOne Mobile App</h3>\n\t\t\t\t<p className=\"mobile-description\">\n\t\t\t\t\tScan the QR code below with the PingOne Mobile app to pair your device.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* QR Code Display */}\n\t\t\t{mfaState.qrCodeUrl && (\n\t\t\t\t<div className=\"pairing-qr-section\">\n\t\t\t\t\t<div className=\"pairing-qr-container\">\n\t\t\t\t\t\t<img\n\t\t\t\t\t\t\tsrc={mfaState.qrCodeUrl}\n\t\t\t\t\t\t\talt=\"Mobile Pairing QR Code\"\n\t\t\t\t\t\t\tclassName=\"pairing-qr-image\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<p className=\"qr-instruction\">Open PingOne Mobile app and scan this QR code</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Manual Pairing Key */}\n\t\t\t{mfaState.pairingKey && (\n\t\t\t\t<div className=\"pairing-key-section\">\n\t\t\t\t\t<h4>Manual Pairing</h4>\n\t\t\t\t\t<p>If you can't scan the QR code, enter this pairing key manually:</p>\n\n\t\t\t\t\t<div className=\"pairing-key-display\">\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={mfaState.pairingKey}\n\t\t\t\t\t\t\treadOnly\n\t\t\t\t\t\t\tclassName=\"pairing-key-input\"\n\t\t\t\t\t\t\tonClick={(e) => e.currentTarget.select()}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleCopyPairingKey}\n\t\t\t\t\t\t\tclassName=\"copy-button\"\n\t\t\t\t\t\t\taria-label=\"Copy pairing key to clipboard\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{copied ? '‚úì Copied' : 'üìã Copy'}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* App Download Instructions */}\n\t\t\t<div className=\"app-download-section\">\n\t\t\t\t<h4>Don't have the app?</h4>\n\t\t\t\t<p>Download PingOne Mobile from your app store:</p>\n\t\t\t\t<div className=\"app-store-buttons\">\n\t\t\t\t\t<a\n\t\t\t\t\t\thref=\"https://apps.apple.com/app/pingone/id1063305932\"\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\t\tclassName=\"app-store-link\"\n\t\t\t\t\t>\n\t\t\t\t\t\tüì± Download for iOS\n\t\t\t\t\t</a>\n\t\t\t\t\t<a\n\t\t\t\t\t\thref=\"https://play.google.com/store/apps/details?id=com.pingidentity.pingone\"\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\t\tclassName=\"app-store-link\"\n\t\t\t\t\t>\n\t\t\t\t\t\tü§ñ Download for Android\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"mobile-education\">\n\t\t\t\t\t<summary>Learn more about Mobile Push</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\n\t\t\t{/* No QR Code Warning */}\n\t\t\t{!mfaState.qrCodeUrl && !mfaState.pairingKey && (\n\t\t\t\t<div className=\"no-data-warning\">\n\t\t\t\t\t<p>‚ö†Ô∏è Pairing QR code and key not available yet.</p>\n\t\t\t\t\t<p>Please complete device registration first.</p>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// DEVICE COMPONENT REGISTRY\n// ============================================================================\n\n/**\n * Device Component Registry\n *\n * Maps device types to custom components.\n * - null = use DynamicFormRenderer (SMS, Email, WhatsApp)\n * - Component = use custom component (TOTP, FIDO2, Mobile)\n */\nexport const DeviceComponentRegistry: Record<\n\tDeviceConfigKey,\n\tReact.FC<DeviceComponentProps> | null\n> = {\n\tSMS: null, // Use DynamicFormRenderer\n\tEMAIL: null, // Use DynamicFormRenderer\n\tWHATSAPP: null, // Use DynamicFormRenderer\n\tTOTP: null, // Use DynamicFormRenderer - Registration happens first, QR shown in activation step\n\tFIDO2: FIDO2RegistrationComponent,\n\tMOBILE: MobileRegistrationComponent,\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default DeviceComponentRegistry;\n"},"tags":[],"source":null},{"category":"lint/security/noDangerouslySetInnerHtml","severity":"error","description":"Avoid passing content using the dangerouslySetInnerHTML prop.","message":[{"elements":[],"content":"Avoid passing content using the "},{"elements":["Emphasis"],"content":"dangerouslySetInnerHTML"},{"elements":[],"content":" prop."}],"advices":{"advices":[{"log":["warn",[{"elements":[],"content":"Setting content using code can expose users to cross-site scripting (XSS) attacks"}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/DeviceComponentRegistry.tsx"},"span":[15648,15671],"sourceCode":"/**\n * @file DeviceComponentRegistry.tsx\n * @module v8/flows/unified/components\n * @description Registry of device-specific custom components for complex flows\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle the 20% of device flows that are too complex for dynamic forms.\n * TOTP needs QR code display, FIDO2 needs WebAuthn, Mobile needs app pairing.\n *\n * Architecture:\n * - Each component receives standard props (credentials, mfaState, callbacks)\n * - Components manage their own device-specific UI\n * - Registry maps device types to components (null = use DynamicFormRenderer)\n *\n * @example\n * const CustomComponent = DeviceComponentRegistry[deviceType];\n * if (CustomComponent) {\n *   return <CustomComponent {...props} />;\n * } else {\n *   return <DynamicFormRenderer {...props} />;\n * }\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport type { DeviceConfigKey, DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFACredentials, MFAState } from '@/v8/flows/shared/MFATypes';\n\nconst MODULE_TAG = '[üé® DEVICE-COMPONENT-REGISTRY]';\n\n// ============================================================================\n// SHARED PROPS INTERFACE\n// ============================================================================\n\n/**\n * Props passed to device-specific custom components\n */\nexport interface DeviceComponentProps {\n\t/** MFA credentials */\n\tcredentials: MFACredentials;\n\n\t/** MFA state (contains device-specific data like QR codes) */\n\tmfaState: MFAState;\n\n\t/** Update MFA state */\n\tsetMfaState: (state: MFAState | ((prev: MFAState) => MFAState)) => void;\n\n\t/** Success callback */\n\tonSuccess: (data: Record<string, unknown>) => void;\n\n\t/** Error callback */\n\tonError: (error: string) => void;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device configuration */\n\tconfig: DeviceFlowConfig;\n}\n\n// ============================================================================\n// TOTP REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * TOTP Registration Component\n *\n * Displays QR code and secret key for authenticator app setup.\n * Used for Google Authenticator, Authy, Microsoft Authenticator, etc.\n */\nexport const TOTPRegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tmfaState,\n\tconfig,\n\tonSuccess,\n\tonError,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering TOTP registration component`, {\n\t\thasQRCode: !!mfaState.qrCodeUrl,\n\t\thasSecret: !!mfaState.totpSecret,\n\t});\n\n\tconst [showSecret, setShowSecret] = useState(false);\n\tconst [copied, setCopied] = useState(false);\n\n\t// Handle copy secret to clipboard\n\tconst handleCopySecret = useCallback(() => {\n\t\tif (mfaState.totpSecret) {\n\t\t\tnavigator.clipboard\n\t\t\t\t.writeText(mfaState.totpSecret)\n\t\t\t\t.then(() => {\n\t\t\t\t\tconsole.log(`${MODULE_TAG} Secret copied to clipboard`);\n\t\t\t\t\tsetCopied(true);\n\t\t\t\t\tsetTimeout(() => setCopied(false), 2000);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tconsole.error(`${MODULE_TAG} Failed to copy secret:`, err);\n\t\t\t\t\tonError('Failed to copy secret to clipboard');\n\t\t\t\t});\n\t\t}\n\t}, [mfaState.totpSecret, onError]);\n\n\treturn (\n\t\t<div className=\"totp-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"totp-header\">\n\t\t\t\t<h3>{config.icon} Set Up Authenticator App</h3>\n\t\t\t\t<p className=\"totp-description\">\n\t\t\t\t\tScan the QR code below with your authenticator app, or enter the secret key manually.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* QR Code Display */}\n\t\t\t{mfaState.qrCodeUrl && (\n\t\t\t\t<div className=\"qr-code-section\">\n\t\t\t\t\t<div className=\"qr-code-container\">\n\t\t\t\t\t\t<img src={mfaState.qrCodeUrl} alt=\"TOTP QR Code\" className=\"qr-code-image\" />\n\t\t\t\t\t</div>\n\t\t\t\t\t<p className=\"qr-instruction\">Scan this QR code with your authenticator app</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Manual Entry Section */}\n\t\t\t{mfaState.totpSecret && (\n\t\t\t\t<div className=\"manual-entry-section\">\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowSecret(!showSecret)}\n\t\t\t\t\t\tclassName=\"toggle-secret-button\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{showSecret ? 'Hide' : 'Show'} Manual Entry Key\n\t\t\t\t\t</button>\n\n\t\t\t\t\t{showSecret && (\n\t\t\t\t\t\t<div className=\"secret-display\">\n\t\t\t\t\t\t\t<label htmlFor=\"totp-secret\">Secret Key:</label>\n\t\t\t\t\t\t\t<div className=\"secret-input-group\">\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"totp-secret\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={mfaState.totpSecret}\n\t\t\t\t\t\t\t\t\treadOnly\n\t\t\t\t\t\t\t\t\tclassName=\"secret-input\"\n\t\t\t\t\t\t\t\t\tonClick={(e) => e.currentTarget.select()}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleCopySecret}\n\t\t\t\t\t\t\t\t\tclassName=\"copy-button\"\n\t\t\t\t\t\t\t\t\taria-label=\"Copy secret to clipboard\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{copied ? '‚úì Copied' : 'üìã Copy'}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p className=\"secret-hint\">\n\t\t\t\t\t\t\t\tEnter this key manually in your authenticator app if you can't scan the QR code.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Supported Apps */}\n\t\t\t<details className=\"supported-apps\">\n\t\t\t\t<summary>Supported Authenticator Apps</summary>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>Google Authenticator</li>\n\t\t\t\t\t<li>Microsoft Authenticator</li>\n\t\t\t\t\t<li>Authy</li>\n\t\t\t\t\t<li>1Password</li>\n\t\t\t\t\t<li>LastPass Authenticator</li>\n\t\t\t\t\t<li>Any TOTP-compatible app</li>\n\t\t\t\t</ul>\n\t\t\t</details>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"totp-education\">\n\t\t\t\t\t<summary>Learn more about TOTP</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\n\t\t\t{/* No QR Code Warning */}\n\t\t\t{!mfaState.qrCodeUrl && !mfaState.totpSecret && (\n\t\t\t\t<div className=\"no-data-warning\">\n\t\t\t\t\t<p>‚ö†Ô∏è QR code and secret not available yet.</p>\n\t\t\t\t\t<p>Please complete device registration first.</p>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// FIDO2 REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * FIDO2 Registration Component\n *\n * Triggers WebAuthn credential registration for security keys and biometrics.\n * Used for YubiKey, Windows Hello, Touch ID, Face ID, etc.\n */\nexport const FIDO2RegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tcredentials,\n\tmfaState,\n\tsetMfaState,\n\tonSuccess,\n\tonError,\n\tcontroller,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering FIDO2 registration component`, {\n\t\thasOptions: !!mfaState.publicKeyCredentialCreationOptions,\n\t});\n\n\tconst [isRegistering, setIsRegistering] = useState(false);\n\tconst [browserSupported, setBrowserSupported] = useState(true);\n\n\t// Check browser support on mount\n\tuseEffect(() => {\n\t\tconst supported =\n\t\t\twindow.PublicKeyCredential !== undefined && navigator.credentials !== undefined;\n\n\t\tconsole.log(`${MODULE_TAG} WebAuthn support:`, supported);\n\t\tsetBrowserSupported(supported);\n\n\t\tif (!supported) {\n\t\t\tonError(\n\t\t\t\t'Your browser does not support FIDO2/WebAuthn. Please use a modern browser like Chrome, Firefox, Safari, or Edge.'\n\t\t\t);\n\t\t}\n\t}, [onError]);\n\n\t/**\n\t * Handle WebAuthn registration\n\t * Calls the FIDO2FlowController to complete the full registration flow:\n\t * 1. Call navigator.credentials.create() with PingOne options\n\t * 2. Send attestation back to PingOne to activate device\n\t */\n\tconst handleWebAuthnRegistration = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting WebAuthn registration`);\n\t\tsetIsRegistering(true);\n\n\t\ttry {\n\t\t\t// Check if we have device ID and credential creation options\n\t\t\tif (!mfaState.deviceId) {\n\t\t\t\tthrow new Error('Device ID is missing. Please try registering again.');\n\t\t\t}\n\n\t\t\tconst options = mfaState.publicKeyCredentialCreationOptions;\n\n\t\t\tif (!options) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t'Missing WebAuthn credential creation options. Please complete device registration first.'\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t`${MODULE_TAG} Calling controller.registerFIDO2Device with deviceId:`,\n\t\t\t\tmfaState.deviceId\n\t\t\t);\n\n\t\t\t// Import FIDO2FlowController\n\t\t\tconst { FIDO2FlowController } = await import('@/v8/flows/controllers/FIDO2FlowController');\n\n\t\t\t// Check if controller is FIDO2FlowController instance, otherwise create one\n\t\t\tconst fido2Controller =\n\t\t\t\tcontroller instanceof FIDO2FlowController\n\t\t\t\t\t? controller\n\t\t\t\t\t: new FIDO2FlowController({\n\t\t\t\t\t\t\tonUpdate: (state: any) => setMfaState((prev) => ({ ...prev, ...state })),\n\t\t\t\t\t\t\tonError: (error: string) => console.error('FIDO2 Controller Error:', error),\n\t\t\t\t\t\t});\n\n\t\t\t// Call the full FIDO2 registration flow (WebAuthn + activation)\n\t\t\tconst result = await (fido2Controller as any).registerFIDO2Device(\n\t\t\t\tcredentials,\n\t\t\t\tmfaState.deviceId,\n\t\t\t\tJSON.stringify(options)\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} FIDO2 registration complete:`, result);\n\n\t\t\t// Update state with final device status\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceStatus: result.status,\n\t\t\t\tcredentialId: result.credentialId,\n\t\t\t}));\n\n\t\t\t// Call success callback - this will trigger navigation to next step\n\t\t\tonSuccess({\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tcredentialId: result.credentialId,\n\t\t\t});\n\t\t} catch (error: unknown) {\n\t\t\tconsole.error(`${MODULE_TAG} WebAuthn registration failed:`, error);\n\n\t\t\t// Handle common errors\n\t\t\tlet errorMessage = 'Biometric registration failed';\n\n\t\t\tif (error instanceof Error) {\n\t\t\t\terrorMessage = error.message;\n\t\t\t}\n\n\t\t\tonError(errorMessage);\n\t\t} finally {\n\t\t\tsetIsRegistering(false);\n\t\t}\n\t}, [mfaState, setMfaState, onSuccess, onError, controller, credentials]);\n\n\treturn (\n\t\t<div className=\"fido2-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"fido2-header\">\n\t\t\t\t<h3>{config.icon} Register Security Key or Biometric</h3>\n\t\t\t\t<p className=\"fido2-description\">\n\t\t\t\t\tUse a hardware security key or your device's biometric authentication (fingerprint, facial\n\t\t\t\t\trecognition).\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Browser Support Check */}\n\t\t\t{!browserSupported && (\n\t\t\t\t<div className=\"browser-not-supported\">\n\t\t\t\t\t<p>‚ùå Your browser does not support FIDO2/WebAuthn</p>\n\t\t\t\t\t<p>Please use Chrome, Firefox, Safari, or Edge</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Button */}\n\t\t\t{browserSupported && (\n\t\t\t\t<div className=\"fido2-registration-section\">\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={handleWebAuthnRegistration}\n\t\t\t\t\t\tdisabled={\n\t\t\t\t\t\t\tisRegistering || !mfaState.publicKeyCredentialCreationOptions || !mfaState.deviceId\n\t\t\t\t\t\t}\n\t\t\t\t\t\tclassName=\"webauthn-register-button\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{isRegistering ? 'üîê Authenticating...' : 'üîê Complete Biometric Registration'}\n\t\t\t\t\t</button>\n\n\t\t\t\t\t{isRegistering && (\n\t\t\t\t\t\t<p className=\"registration-hint\">\n\t\t\t\t\t\t\tüîê Follow the prompts from your browser to use your security key or biometric\n\t\t\t\t\t\t\t(TouchID/FaceID)...\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{!mfaState.publicKeyCredentialCreationOptions && (\n\t\t\t\t\t\t<p className=\"no-options-warning\">\n\t\t\t\t\t\t\t‚ö†Ô∏è Waiting for device creation... Click \"Next Step\" above to create the device first.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{mfaState.publicKeyCredentialCreationOptions && !isRegistering && (\n\t\t\t\t\t\t<p className=\"registration-ready\">\n\t\t\t\t\t\t\t‚úÖ Device created. Click the button above to complete biometric registration.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Supported Authenticators */}\n\t\t\t<details className=\"supported-authenticators\">\n\t\t\t\t<summary>Supported Authenticators</summary>\n\t\t\t\t<div className=\"authenticator-lists\">\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h4>Hardware Security Keys</h4>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>YubiKey (5 Series, Security Key)</li>\n\t\t\t\t\t\t\t<li>Google Titan Security Key</li>\n\t\t\t\t\t\t\t<li>Feitian ePass FIDO2</li>\n\t\t\t\t\t\t\t<li>Thetis FIDO2 Security Key</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h4>Platform Authenticators</h4>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>Windows Hello (fingerprint, facial recognition)</li>\n\t\t\t\t\t\t\t<li>Touch ID (MacBook, iMac)</li>\n\t\t\t\t\t\t\t<li>Face ID (iPhone, iPad)</li>\n\t\t\t\t\t\t\t<li>Android Biometrics</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</details>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"fido2-education\">\n\t\t\t\t\t<summary>Learn more about FIDO2</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MOBILE REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * Mobile Registration Component\n *\n * Displays QR code for PingOne Mobile app pairing.\n * Used for mobile push notifications.\n */\nexport const MobileRegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tmfaState,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering Mobile registration component`, {\n\t\thasQRCode: !!mfaState.qrCodeUrl,\n\t\thasPairingKey: !!mfaState.pairingKey,\n\t});\n\n\tconst [copied, setCopied] = useState(false);\n\n\t// Handle copy pairing key to clipboard\n\tconst handleCopyPairingKey = useCallback(() => {\n\t\tif (mfaState.pairingKey) {\n\t\t\tnavigator.clipboard\n\t\t\t\t.writeText(mfaState.pairingKey)\n\t\t\t\t.then(() => {\n\t\t\t\t\tconsole.log(`${MODULE_TAG} Pairing key copied to clipboard`);\n\t\t\t\t\tsetCopied(true);\n\t\t\t\t\tsetTimeout(() => setCopied(false), 2000);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tconsole.error(`${MODULE_TAG} Failed to copy pairing key:`, err);\n\t\t\t\t});\n\t\t}\n\t}, [mfaState.pairingKey]);\n\n\treturn (\n\t\t<div className=\"mobile-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"mobile-header\">\n\t\t\t\t<h3>{config.icon} Pair PingOne Mobile App</h3>\n\t\t\t\t<p className=\"mobile-description\">\n\t\t\t\t\tScan the QR code below with the PingOne Mobile app to pair your device.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* QR Code Display */}\n\t\t\t{mfaState.qrCodeUrl && (\n\t\t\t\t<div className=\"pairing-qr-section\">\n\t\t\t\t\t<div className=\"pairing-qr-container\">\n\t\t\t\t\t\t<img\n\t\t\t\t\t\t\tsrc={mfaState.qrCodeUrl}\n\t\t\t\t\t\t\talt=\"Mobile Pairing QR Code\"\n\t\t\t\t\t\t\tclassName=\"pairing-qr-image\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<p className=\"qr-instruction\">Open PingOne Mobile app and scan this QR code</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Manual Pairing Key */}\n\t\t\t{mfaState.pairingKey && (\n\t\t\t\t<div className=\"pairing-key-section\">\n\t\t\t\t\t<h4>Manual Pairing</h4>\n\t\t\t\t\t<p>If you can't scan the QR code, enter this pairing key manually:</p>\n\n\t\t\t\t\t<div className=\"pairing-key-display\">\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={mfaState.pairingKey}\n\t\t\t\t\t\t\treadOnly\n\t\t\t\t\t\t\tclassName=\"pairing-key-input\"\n\t\t\t\t\t\t\tonClick={(e) => e.currentTarget.select()}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleCopyPairingKey}\n\t\t\t\t\t\t\tclassName=\"copy-button\"\n\t\t\t\t\t\t\taria-label=\"Copy pairing key to clipboard\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{copied ? '‚úì Copied' : 'üìã Copy'}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* App Download Instructions */}\n\t\t\t<div className=\"app-download-section\">\n\t\t\t\t<h4>Don't have the app?</h4>\n\t\t\t\t<p>Download PingOne Mobile from your app store:</p>\n\t\t\t\t<div className=\"app-store-buttons\">\n\t\t\t\t\t<a\n\t\t\t\t\t\thref=\"https://apps.apple.com/app/pingone/id1063305932\"\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\t\tclassName=\"app-store-link\"\n\t\t\t\t\t>\n\t\t\t\t\t\tüì± Download for iOS\n\t\t\t\t\t</a>\n\t\t\t\t\t<a\n\t\t\t\t\t\thref=\"https://play.google.com/store/apps/details?id=com.pingidentity.pingone\"\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\t\tclassName=\"app-store-link\"\n\t\t\t\t\t>\n\t\t\t\t\t\tü§ñ Download for Android\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"mobile-education\">\n\t\t\t\t\t<summary>Learn more about Mobile Push</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\n\t\t\t{/* No QR Code Warning */}\n\t\t\t{!mfaState.qrCodeUrl && !mfaState.pairingKey && (\n\t\t\t\t<div className=\"no-data-warning\">\n\t\t\t\t\t<p>‚ö†Ô∏è Pairing QR code and key not available yet.</p>\n\t\t\t\t\t<p>Please complete device registration first.</p>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// DEVICE COMPONENT REGISTRY\n// ============================================================================\n\n/**\n * Device Component Registry\n *\n * Maps device types to custom components.\n * - null = use DynamicFormRenderer (SMS, Email, WhatsApp)\n * - Component = use custom component (TOTP, FIDO2, Mobile)\n */\nexport const DeviceComponentRegistry: Record<\n\tDeviceConfigKey,\n\tReact.FC<DeviceComponentProps> | null\n> = {\n\tSMS: null, // Use DynamicFormRenderer\n\tEMAIL: null, // Use DynamicFormRenderer\n\tWHATSAPP: null, // Use DynamicFormRenderer\n\tTOTP: null, // Use DynamicFormRenderer - Registration happens first, QR shown in activation step\n\tFIDO2: FIDO2RegistrationComponent,\n\tMOBILE: MobileRegistrationComponent,\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default DeviceComponentRegistry;\n"},"tags":[],"source":null},{"category":"lint/security/noDangerouslySetInnerHtml","severity":"error","description":"Avoid passing content using the dangerouslySetInnerHTML prop.","message":[{"elements":[],"content":"Avoid passing content using the "},{"elements":["Emphasis"],"content":"dangerouslySetInnerHTML"},{"elements":[],"content":" prop."}],"advices":{"advices":[{"log":["warn",[{"elements":[],"content":"Setting content using code can expose users to cross-site scripting (XSS) attacks"}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/DeviceComponentRegistry.tsx"},"span":[5515,5538],"sourceCode":"/**\n * @file DeviceComponentRegistry.tsx\n * @module v8/flows/unified/components\n * @description Registry of device-specific custom components for complex flows\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle the 20% of device flows that are too complex for dynamic forms.\n * TOTP needs QR code display, FIDO2 needs WebAuthn, Mobile needs app pairing.\n *\n * Architecture:\n * - Each component receives standard props (credentials, mfaState, callbacks)\n * - Components manage their own device-specific UI\n * - Registry maps device types to components (null = use DynamicFormRenderer)\n *\n * @example\n * const CustomComponent = DeviceComponentRegistry[deviceType];\n * if (CustomComponent) {\n *   return <CustomComponent {...props} />;\n * } else {\n *   return <DynamicFormRenderer {...props} />;\n * }\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport type { DeviceConfigKey, DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFACredentials, MFAState } from '@/v8/flows/shared/MFATypes';\n\nconst MODULE_TAG = '[üé® DEVICE-COMPONENT-REGISTRY]';\n\n// ============================================================================\n// SHARED PROPS INTERFACE\n// ============================================================================\n\n/**\n * Props passed to device-specific custom components\n */\nexport interface DeviceComponentProps {\n\t/** MFA credentials */\n\tcredentials: MFACredentials;\n\n\t/** MFA state (contains device-specific data like QR codes) */\n\tmfaState: MFAState;\n\n\t/** Update MFA state */\n\tsetMfaState: (state: MFAState | ((prev: MFAState) => MFAState)) => void;\n\n\t/** Success callback */\n\tonSuccess: (data: Record<string, unknown>) => void;\n\n\t/** Error callback */\n\tonError: (error: string) => void;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device configuration */\n\tconfig: DeviceFlowConfig;\n}\n\n// ============================================================================\n// TOTP REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * TOTP Registration Component\n *\n * Displays QR code and secret key for authenticator app setup.\n * Used for Google Authenticator, Authy, Microsoft Authenticator, etc.\n */\nexport const TOTPRegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tmfaState,\n\tconfig,\n\tonSuccess,\n\tonError,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering TOTP registration component`, {\n\t\thasQRCode: !!mfaState.qrCodeUrl,\n\t\thasSecret: !!mfaState.totpSecret,\n\t});\n\n\tconst [showSecret, setShowSecret] = useState(false);\n\tconst [copied, setCopied] = useState(false);\n\n\t// Handle copy secret to clipboard\n\tconst handleCopySecret = useCallback(() => {\n\t\tif (mfaState.totpSecret) {\n\t\t\tnavigator.clipboard\n\t\t\t\t.writeText(mfaState.totpSecret)\n\t\t\t\t.then(() => {\n\t\t\t\t\tconsole.log(`${MODULE_TAG} Secret copied to clipboard`);\n\t\t\t\t\tsetCopied(true);\n\t\t\t\t\tsetTimeout(() => setCopied(false), 2000);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tconsole.error(`${MODULE_TAG} Failed to copy secret:`, err);\n\t\t\t\t\tonError('Failed to copy secret to clipboard');\n\t\t\t\t});\n\t\t}\n\t}, [mfaState.totpSecret, onError]);\n\n\treturn (\n\t\t<div className=\"totp-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"totp-header\">\n\t\t\t\t<h3>{config.icon} Set Up Authenticator App</h3>\n\t\t\t\t<p className=\"totp-description\">\n\t\t\t\t\tScan the QR code below with your authenticator app, or enter the secret key manually.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* QR Code Display */}\n\t\t\t{mfaState.qrCodeUrl && (\n\t\t\t\t<div className=\"qr-code-section\">\n\t\t\t\t\t<div className=\"qr-code-container\">\n\t\t\t\t\t\t<img src={mfaState.qrCodeUrl} alt=\"TOTP QR Code\" className=\"qr-code-image\" />\n\t\t\t\t\t</div>\n\t\t\t\t\t<p className=\"qr-instruction\">Scan this QR code with your authenticator app</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Manual Entry Section */}\n\t\t\t{mfaState.totpSecret && (\n\t\t\t\t<div className=\"manual-entry-section\">\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={() => setShowSecret(!showSecret)}\n\t\t\t\t\t\tclassName=\"toggle-secret-button\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{showSecret ? 'Hide' : 'Show'} Manual Entry Key\n\t\t\t\t\t</button>\n\n\t\t\t\t\t{showSecret && (\n\t\t\t\t\t\t<div className=\"secret-display\">\n\t\t\t\t\t\t\t<label htmlFor=\"totp-secret\">Secret Key:</label>\n\t\t\t\t\t\t\t<div className=\"secret-input-group\">\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tid=\"totp-secret\"\n\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\tvalue={mfaState.totpSecret}\n\t\t\t\t\t\t\t\t\treadOnly\n\t\t\t\t\t\t\t\t\tclassName=\"secret-input\"\n\t\t\t\t\t\t\t\t\tonClick={(e) => e.currentTarget.select()}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleCopySecret}\n\t\t\t\t\t\t\t\t\tclassName=\"copy-button\"\n\t\t\t\t\t\t\t\t\taria-label=\"Copy secret to clipboard\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{copied ? '‚úì Copied' : 'üìã Copy'}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p className=\"secret-hint\">\n\t\t\t\t\t\t\t\tEnter this key manually in your authenticator app if you can't scan the QR code.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Supported Apps */}\n\t\t\t<details className=\"supported-apps\">\n\t\t\t\t<summary>Supported Authenticator Apps</summary>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>Google Authenticator</li>\n\t\t\t\t\t<li>Microsoft Authenticator</li>\n\t\t\t\t\t<li>Authy</li>\n\t\t\t\t\t<li>1Password</li>\n\t\t\t\t\t<li>LastPass Authenticator</li>\n\t\t\t\t\t<li>Any TOTP-compatible app</li>\n\t\t\t\t</ul>\n\t\t\t</details>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"totp-education\">\n\t\t\t\t\t<summary>Learn more about TOTP</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\n\t\t\t{/* No QR Code Warning */}\n\t\t\t{!mfaState.qrCodeUrl && !mfaState.totpSecret && (\n\t\t\t\t<div className=\"no-data-warning\">\n\t\t\t\t\t<p>‚ö†Ô∏è QR code and secret not available yet.</p>\n\t\t\t\t\t<p>Please complete device registration first.</p>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// FIDO2 REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * FIDO2 Registration Component\n *\n * Triggers WebAuthn credential registration for security keys and biometrics.\n * Used for YubiKey, Windows Hello, Touch ID, Face ID, etc.\n */\nexport const FIDO2RegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tcredentials,\n\tmfaState,\n\tsetMfaState,\n\tonSuccess,\n\tonError,\n\tcontroller,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering FIDO2 registration component`, {\n\t\thasOptions: !!mfaState.publicKeyCredentialCreationOptions,\n\t});\n\n\tconst [isRegistering, setIsRegistering] = useState(false);\n\tconst [browserSupported, setBrowserSupported] = useState(true);\n\n\t// Check browser support on mount\n\tuseEffect(() => {\n\t\tconst supported =\n\t\t\twindow.PublicKeyCredential !== undefined && navigator.credentials !== undefined;\n\n\t\tconsole.log(`${MODULE_TAG} WebAuthn support:`, supported);\n\t\tsetBrowserSupported(supported);\n\n\t\tif (!supported) {\n\t\t\tonError(\n\t\t\t\t'Your browser does not support FIDO2/WebAuthn. Please use a modern browser like Chrome, Firefox, Safari, or Edge.'\n\t\t\t);\n\t\t}\n\t}, [onError]);\n\n\t/**\n\t * Handle WebAuthn registration\n\t * Calls the FIDO2FlowController to complete the full registration flow:\n\t * 1. Call navigator.credentials.create() with PingOne options\n\t * 2. Send attestation back to PingOne to activate device\n\t */\n\tconst handleWebAuthnRegistration = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting WebAuthn registration`);\n\t\tsetIsRegistering(true);\n\n\t\ttry {\n\t\t\t// Check if we have device ID and credential creation options\n\t\t\tif (!mfaState.deviceId) {\n\t\t\t\tthrow new Error('Device ID is missing. Please try registering again.');\n\t\t\t}\n\n\t\t\tconst options = mfaState.publicKeyCredentialCreationOptions;\n\n\t\t\tif (!options) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t'Missing WebAuthn credential creation options. Please complete device registration first.'\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconsole.log(\n\t\t\t\t`${MODULE_TAG} Calling controller.registerFIDO2Device with deviceId:`,\n\t\t\t\tmfaState.deviceId\n\t\t\t);\n\n\t\t\t// Import FIDO2FlowController\n\t\t\tconst { FIDO2FlowController } = await import('@/v8/flows/controllers/FIDO2FlowController');\n\n\t\t\t// Check if controller is FIDO2FlowController instance, otherwise create one\n\t\t\tconst fido2Controller =\n\t\t\t\tcontroller instanceof FIDO2FlowController\n\t\t\t\t\t? controller\n\t\t\t\t\t: new FIDO2FlowController({\n\t\t\t\t\t\t\tonUpdate: (state: any) => setMfaState((prev) => ({ ...prev, ...state })),\n\t\t\t\t\t\t\tonError: (error: string) => console.error('FIDO2 Controller Error:', error),\n\t\t\t\t\t\t});\n\n\t\t\t// Call the full FIDO2 registration flow (WebAuthn + activation)\n\t\t\tconst result = await (fido2Controller as any).registerFIDO2Device(\n\t\t\t\tcredentials,\n\t\t\t\tmfaState.deviceId,\n\t\t\t\tJSON.stringify(options)\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} FIDO2 registration complete:`, result);\n\n\t\t\t// Update state with final device status\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceStatus: result.status,\n\t\t\t\tcredentialId: result.credentialId,\n\t\t\t}));\n\n\t\t\t// Call success callback - this will trigger navigation to next step\n\t\t\tonSuccess({\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tcredentialId: result.credentialId,\n\t\t\t});\n\t\t} catch (error: unknown) {\n\t\t\tconsole.error(`${MODULE_TAG} WebAuthn registration failed:`, error);\n\n\t\t\t// Handle common errors\n\t\t\tlet errorMessage = 'Biometric registration failed';\n\n\t\t\tif (error instanceof Error) {\n\t\t\t\terrorMessage = error.message;\n\t\t\t}\n\n\t\t\tonError(errorMessage);\n\t\t} finally {\n\t\t\tsetIsRegistering(false);\n\t\t}\n\t}, [mfaState, setMfaState, onSuccess, onError, controller, credentials]);\n\n\treturn (\n\t\t<div className=\"fido2-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"fido2-header\">\n\t\t\t\t<h3>{config.icon} Register Security Key or Biometric</h3>\n\t\t\t\t<p className=\"fido2-description\">\n\t\t\t\t\tUse a hardware security key or your device's biometric authentication (fingerprint, facial\n\t\t\t\t\trecognition).\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Browser Support Check */}\n\t\t\t{!browserSupported && (\n\t\t\t\t<div className=\"browser-not-supported\">\n\t\t\t\t\t<p>‚ùå Your browser does not support FIDO2/WebAuthn</p>\n\t\t\t\t\t<p>Please use Chrome, Firefox, Safari, or Edge</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Button */}\n\t\t\t{browserSupported && (\n\t\t\t\t<div className=\"fido2-registration-section\">\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={handleWebAuthnRegistration}\n\t\t\t\t\t\tdisabled={\n\t\t\t\t\t\t\tisRegistering || !mfaState.publicKeyCredentialCreationOptions || !mfaState.deviceId\n\t\t\t\t\t\t}\n\t\t\t\t\t\tclassName=\"webauthn-register-button\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{isRegistering ? 'üîê Authenticating...' : 'üîê Complete Biometric Registration'}\n\t\t\t\t\t</button>\n\n\t\t\t\t\t{isRegistering && (\n\t\t\t\t\t\t<p className=\"registration-hint\">\n\t\t\t\t\t\t\tüîê Follow the prompts from your browser to use your security key or biometric\n\t\t\t\t\t\t\t(TouchID/FaceID)...\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{!mfaState.publicKeyCredentialCreationOptions && (\n\t\t\t\t\t\t<p className=\"no-options-warning\">\n\t\t\t\t\t\t\t‚ö†Ô∏è Waiting for device creation... Click \"Next Step\" above to create the device first.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{mfaState.publicKeyCredentialCreationOptions && !isRegistering && (\n\t\t\t\t\t\t<p className=\"registration-ready\">\n\t\t\t\t\t\t\t‚úÖ Device created. Click the button above to complete biometric registration.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Supported Authenticators */}\n\t\t\t<details className=\"supported-authenticators\">\n\t\t\t\t<summary>Supported Authenticators</summary>\n\t\t\t\t<div className=\"authenticator-lists\">\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h4>Hardware Security Keys</h4>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>YubiKey (5 Series, Security Key)</li>\n\t\t\t\t\t\t\t<li>Google Titan Security Key</li>\n\t\t\t\t\t\t\t<li>Feitian ePass FIDO2</li>\n\t\t\t\t\t\t\t<li>Thetis FIDO2 Security Key</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h4>Platform Authenticators</h4>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>Windows Hello (fingerprint, facial recognition)</li>\n\t\t\t\t\t\t\t<li>Touch ID (MacBook, iMac)</li>\n\t\t\t\t\t\t\t<li>Face ID (iPhone, iPad)</li>\n\t\t\t\t\t\t\t<li>Android Biometrics</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</details>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"fido2-education\">\n\t\t\t\t\t<summary>Learn more about FIDO2</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// MOBILE REGISTRATION COMPONENT\n// ============================================================================\n\n/**\n * Mobile Registration Component\n *\n * Displays QR code for PingOne Mobile app pairing.\n * Used for mobile push notifications.\n */\nexport const MobileRegistrationComponent: React.FC<DeviceComponentProps> = ({\n\tmfaState,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering Mobile registration component`, {\n\t\thasQRCode: !!mfaState.qrCodeUrl,\n\t\thasPairingKey: !!mfaState.pairingKey,\n\t});\n\n\tconst [copied, setCopied] = useState(false);\n\n\t// Handle copy pairing key to clipboard\n\tconst handleCopyPairingKey = useCallback(() => {\n\t\tif (mfaState.pairingKey) {\n\t\t\tnavigator.clipboard\n\t\t\t\t.writeText(mfaState.pairingKey)\n\t\t\t\t.then(() => {\n\t\t\t\t\tconsole.log(`${MODULE_TAG} Pairing key copied to clipboard`);\n\t\t\t\t\tsetCopied(true);\n\t\t\t\t\tsetTimeout(() => setCopied(false), 2000);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tconsole.error(`${MODULE_TAG} Failed to copy pairing key:`, err);\n\t\t\t\t});\n\t\t}\n\t}, [mfaState.pairingKey]);\n\n\treturn (\n\t\t<div className=\"mobile-registration-component\">\n\t\t\t{/* Header */}\n\t\t\t<div className=\"mobile-header\">\n\t\t\t\t<h3>{config.icon} Pair PingOne Mobile App</h3>\n\t\t\t\t<p className=\"mobile-description\">\n\t\t\t\t\tScan the QR code below with the PingOne Mobile app to pair your device.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* QR Code Display */}\n\t\t\t{mfaState.qrCodeUrl && (\n\t\t\t\t<div className=\"pairing-qr-section\">\n\t\t\t\t\t<div className=\"pairing-qr-container\">\n\t\t\t\t\t\t<img\n\t\t\t\t\t\t\tsrc={mfaState.qrCodeUrl}\n\t\t\t\t\t\t\talt=\"Mobile Pairing QR Code\"\n\t\t\t\t\t\t\tclassName=\"pairing-qr-image\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<p className=\"qr-instruction\">Open PingOne Mobile app and scan this QR code</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Manual Pairing Key */}\n\t\t\t{mfaState.pairingKey && (\n\t\t\t\t<div className=\"pairing-key-section\">\n\t\t\t\t\t<h4>Manual Pairing</h4>\n\t\t\t\t\t<p>If you can't scan the QR code, enter this pairing key manually:</p>\n\n\t\t\t\t\t<div className=\"pairing-key-display\">\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={mfaState.pairingKey}\n\t\t\t\t\t\t\treadOnly\n\t\t\t\t\t\t\tclassName=\"pairing-key-input\"\n\t\t\t\t\t\t\tonClick={(e) => e.currentTarget.select()}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleCopyPairingKey}\n\t\t\t\t\t\t\tclassName=\"copy-button\"\n\t\t\t\t\t\t\taria-label=\"Copy pairing key to clipboard\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{copied ? '‚úì Copied' : 'üìã Copy'}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* App Download Instructions */}\n\t\t\t<div className=\"app-download-section\">\n\t\t\t\t<h4>Don't have the app?</h4>\n\t\t\t\t<p>Download PingOne Mobile from your app store:</p>\n\t\t\t\t<div className=\"app-store-buttons\">\n\t\t\t\t\t<a\n\t\t\t\t\t\thref=\"https://apps.apple.com/app/pingone/id1063305932\"\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\t\tclassName=\"app-store-link\"\n\t\t\t\t\t>\n\t\t\t\t\t\tüì± Download for iOS\n\t\t\t\t\t</a>\n\t\t\t\t\t<a\n\t\t\t\t\t\thref=\"https://play.google.com/store/apps/details?id=com.pingidentity.pingone\"\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\t\tclassName=\"app-store-link\"\n\t\t\t\t\t>\n\t\t\t\t\t\tü§ñ Download for Android\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{/* Educational Content */}\n\t\t\t{config.educationalContent && (\n\t\t\t\t<details className=\"mobile-education\">\n\t\t\t\t\t<summary>Learn more about Mobile Push</summary>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"education-content\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: config.educationalContent }}\n\t\t\t\t\t/>\n\t\t\t\t</details>\n\t\t\t)}\n\n\t\t\t{/* No QR Code Warning */}\n\t\t\t{!mfaState.qrCodeUrl && !mfaState.pairingKey && (\n\t\t\t\t<div className=\"no-data-warning\">\n\t\t\t\t\t<p>‚ö†Ô∏è Pairing QR code and key not available yet.</p>\n\t\t\t\t\t<p>Please complete device registration first.</p>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\n// ============================================================================\n// DEVICE COMPONENT REGISTRY\n// ============================================================================\n\n/**\n * Device Component Registry\n *\n * Maps device types to custom components.\n * - null = use DynamicFormRenderer (SMS, Email, WhatsApp)\n * - Component = use custom component (TOTP, FIDO2, Mobile)\n */\nexport const DeviceComponentRegistry: Record<\n\tDeviceConfigKey,\n\tReact.FC<DeviceComponentProps> | null\n> = {\n\tSMS: null, // Use DynamicFormRenderer\n\tEMAIL: null, // Use DynamicFormRenderer\n\tWHATSAPP: null, // Use DynamicFormRenderer\n\tTOTP: null, // Use DynamicFormRenderer - Registration happens first, QR shown in activation step\n\tFIDO2: FIDO2RegistrationComponent,\n\tMOBILE: MobileRegistrationComponent,\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default DeviceComponentRegistry;\n"},"tags":[],"source":null},{"category":"lint/a11y/noLabelWithoutControl","severity":"error","description":"A form label must be associated with an input.","message":[{"elements":[],"content":"A form label must be associated with an input."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Consider adding a `for` or `htmlFor` attribute to the label element or moving the input element to inside the label element."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedConfigurationStep.modern.tsx"},"span":[12323,12598],"sourceCode":"/**\n * @file UnifiedConfigurationStep.modern.tsx\n * @module v8/flows/unified/components\n * @description MODERNIZED Step 0: Configuration - Uses global services, no redundant inputs\n * @version 9.2.0\n * @since 2026-01-29\n *\n * Key Changes:\n * - Uses GlobalMFAContext (no redundant Environment ID/Worker Token inputs)\n * - Modern UI with design system components\n * - All buttons functional with proper states\n * - Simplified configuration flow\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport { FiAlertCircle, FiArrowRight, FiCheck } from 'react-icons/fi';\nimport { Button } from '@/v8/components/Button';\nimport { FormInput } from '@/v8/components/FormInput';\nimport { LoadingSpinner } from '@/v8/components/LoadingSpinner';\nimport { PageTransition } from '@/v8/components/PageTransition';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport { useGlobalMFA } from '@/v8/contexts/GlobalMFAContext';\nimport { borderRadius, colors, spacing, typography } from '@/v8/design/tokens';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { useFormValidation } from '@/v8/hooks/useFormValidation';\nimport { MFAServiceV8 } from '@/v8/services/mfaServiceV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[‚öôÔ∏è UNIFIED-CONFIG-MODERN]';\n\nexport interface UnifiedConfigurationStepProps extends MFAFlowBaseRenderProps {\n\tconfig: DeviceFlowConfig;\n\tdeviceType: string;\n\tregistrationFlowType?: 'admin' | 'user';\n}\n\nexport const UnifiedConfigurationStepModern: React.FC<UnifiedConfigurationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tnav,\n\tconfig,\n\tdeviceType,\n\tregistrationFlowType = 'admin',\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering for:`, deviceType, 'Flow type:', registrationFlowType);\n\n\t// Global MFA state\n\tconst {\n\t\tenvironmentId,\n\t\tworkerTokenStatus,\n\t\tisConfigured,\n\t\tisLoading: globalLoading,\n\t} = useGlobalMFA();\n\n\t// Debug logging\n\tconsole.log(`${MODULE_TAG} Global state:`, {\n\t\tenvironmentId,\n\t\tworkerTokenStatus,\n\t\tisConfigured,\n\t\tglobalLoading,\n\t});\n\n\t// Form validation - initialize with credentials.username\n\tconst { values, errors, touched, handleChange, handleBlur, validateAll, setValues } =\n\t\tuseFormValidation(\n\t\t\t{\n\t\t\t\tusername: credentials.username || '',\n\t\t\t\tflowType: registrationFlowType === 'user' ? 'user' : 'admin-activation',\n\t\t\t},\n\t\t\t{\n\t\t\t\tusername: {\n\t\t\t\t\trequired: true,\n\t\t\t\t\tminLength: 3,\n\t\t\t\t},\n\t\t\t}\n\t\t);\n\n\tconst [isSubmitting, setIsSubmitting] = useState(false);\n\tconst [selectedFlowType, setSelectedFlowType] = useState<\n\t\t'admin-active' | 'admin-activation' | 'user'\n\t>(registrationFlowType === 'user' ? 'user' : 'admin-activation');\n\n\t// Update form when credentials change\n\tuseEffect(() => {\n\t\tif (credentials.username && values.username !== credentials.username) {\n\t\t\tsetValues({ username: credentials.username });\n\t\t}\n\t}, [credentials.username, values.username, setValues]);\n\n\t// Auto-populate credentials from global state\n\tuseEffect(() => {\n\t\tif (environmentId && !credentials.environmentId) {\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tenvironmentId,\n\t\t\t}));\n\t\t}\n\t}, [environmentId, credentials.environmentId, setCredentials]);\n\n\t// Handle continue\n\tconst handleContinue = useCallback(async () => {\n\t\tconsole.log(\n\t\t\t`${MODULE_TAG} Continuing for device type:`,\n\t\t\tdeviceType,\n\t\t\t'Flow type:',\n\t\t\tselectedFlowType\n\t\t);\n\n\t\t// Validate form\n\t\tif (!validateAll()) {\n\t\t\ttoastV8.error('Please fix the validation errors');\n\t\t\treturn;\n\t\t}\n\n\t\t// Check global configuration\n\t\tif (!isConfigured) {\n\t\t\ttoastV8.error('Please configure Environment ID and Worker Token first');\n\t\t\tnav.setValidationErrors(['Global configuration incomplete']);\n\t\t\treturn;\n\t\t}\n\n\t\tsetIsSubmitting(true);\n\n\t\ttry {\n\t\t\t// Update credentials\n\t\t\tconst updatedCredentials = {\n\t\t\t\t...credentials,\n\t\t\t\tenvironmentId: environmentId!,\n\t\t\t\tusername: values.username.trim(),\n\t\t\t\ttokenType: 'worker' as const,\n\t\t\t\tdeviceType,\n\t\t\t};\n\n\t\t\tsetCredentials(updatedCredentials);\n\n\t\t\t/**\n\t\t\t * CRITICAL: MFA OTP and TOTP devices MUST always register directly\n\t\t\t *\n\t\t\t * Flow Types:\n\t\t\t * 1. Admin Active (admin-active): Register ‚Üí Skip activation ‚Üí Success\n\t\t\t * 2. Admin Activation Required (admin-activation): Register ‚Üí OTP activation ‚Üí Success\n\t\t\t * 3. User Flow (user): Register ‚Üí PingOne login ‚Üí OTP activation ‚Üí Success\n\t\t\t *\n\t\t\t * NEVER skip activation for ACTIVATION_REQUIRED or user flow!\n\t\t\t */\n\t\t\tconst DIRECT_REGISTRATION_DEVICES = ['EMAIL', 'SMS', 'WHATSAPP', 'TOTP'];\n\n\t\t\tif (DIRECT_REGISTRATION_DEVICES.includes(deviceType)) {\n\t\t\t\tconsole.log(\n\t\t\t\t\t`${MODULE_TAG} Registering ${deviceType} device directly with flow type: ${selectedFlowType}`\n\t\t\t\t);\n\n\t\t\t\t// Map device type to field name\n\t\t\t\tconst fieldMap: Record<string, string> = {\n\t\t\t\t\tEMAIL: 'email',\n\t\t\t\t\tSMS: 'phone',\n\t\t\t\t\tWHATSAPP: 'phone',\n\t\t\t\t\tTOTP: 'deviceName', // TOTP doesn't need contact field\n\t\t\t\t};\n\n\t\t\t\tconst fieldName = fieldMap[deviceType];\n\t\t\t\tconst fieldValue = deviceType === 'TOTP' ? deviceType : values.username.trim();\n\n\t\t\t\t// Determine device status based on flow type\n\t\t\t\t// CRITICAL: Only admin-active flow creates ACTIVE devices\n\t\t\t\tconst deviceStatus = selectedFlowType === 'admin-active' ? 'ACTIVE' : 'ACTIVATION_REQUIRED';\n\n\t\t\t\t// Prepare registration parameters\n\t\t\t\tconst registrationParams: Record<string, any> = {\n\t\t\t\t\tenvironmentId: environmentId!,\n\t\t\t\t\tusername: values.username.trim(),\n\t\t\t\t\tdeviceType,\n\t\t\t\t\t[fieldName]: fieldValue,\n\t\t\t\t\tdeviceName: deviceType,\n\t\t\t\t\tnickname: 'MyKnickName',\n\t\t\t\t\ttokenType: 'worker' as const,\n\t\t\t\t\t// Only admin flows set status, user flow doesn't include it\n\t\t\t\t\t...(selectedFlowType !== 'user' && { status: deviceStatus }),\n\t\t\t\t};\n\n\t\t\t\tconsole.log(`${MODULE_TAG} Registration params:`, registrationParams);\n\n\t\t\t\t// Call MFA Service to register device\n\t\t\t\tconst result = await MFAServiceV8.registerDevice(registrationParams);\n\t\t\t\tconsole.log(`${MODULE_TAG} Device registered with status:`, result.status);\n\n\t\t\t\t// CRITICAL VALIDATION: Ensure activation flow is followed correctly\n\t\t\t\tif (result.status === 'ACTIVATION_REQUIRED' && selectedFlowType === 'admin-active') {\n\t\t\t\t\tconsole.error(`${MODULE_TAG} ERROR: Expected ACTIVE but got ACTIVATION_REQUIRED`);\n\t\t\t\t\tthrow new Error('Device registration flow mismatch - expected ACTIVE device');\n\t\t\t\t}\n\n\t\t\t\t// Update credentials with device info\n\t\t\t\tsetCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\t\tdeviceStatus: result.status,\n\t\t\t\t}));\n\n\t\t\t\t// Mark step complete\n\t\t\t\tnav.markStepComplete();\n\n\t\t\t\t/**\n\t\t\t\t * ROUTING LOGIC - CRITICAL:\n\t\t\t\t * - ACTIVE devices: Skip activation ‚Üí Go to success (Step 2)\n\t\t\t\t * - ACTIVATION_REQUIRED: MUST go to activation step (Step 1) for OTP entry\n\t\t\t\t * - User flow: MUST go to activation (Step 1) even if device shows as ACTIVE\n\t\t\t\t */\n\t\t\t\tif (result.status === 'ACTIVE' && selectedFlowType === 'admin-active') {\n\t\t\t\t\tconsole.log(`${MODULE_TAG} Admin Active flow: Skipping activation, going to success`);\n\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t`${config.displayName} device registered successfully! Device is ready to use.`\n\t\t\t\t\t);\n\t\t\t\t\tnav.goToStep(2); // Skip activation, go to success\n\t\t\t\t} else {\n\t\t\t\t\t// ACTIVATION_REQUIRED or User Flow - MUST go through activation\n\t\t\t\t\tconsole.log(`${MODULE_TAG} Activation required: Going to activation step`);\n\t\t\t\t\ttoastV8.success(\n\t\t\t\t\t\t`${config.displayName} device registered! ${result.status === 'ACTIVATION_REQUIRED' ? 'OTP has been sent automatically.' : 'Please complete activation.'}`\n\t\t\t\t\t);\n\t\t\t\t\tnav.goToNext(); // Go to activation step\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// For FIDO2, MOBILE - go to device selection/registration form\n\t\t\t\tconsole.log(`${MODULE_TAG} Navigating to device selection for ${deviceType}`);\n\n\t\t\t\t// Mark step complete\n\t\t\t\tnav.markStepComplete();\n\n\t\t\t\t// Navigate to next step (device selection/registration form)\n\t\t\t\tnav.goToNext();\n\n\t\t\t\ttoastV8.success('Configuration saved');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(`${MODULE_TAG} Error:`, error);\n\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Failed to process request';\n\t\t\ttoastV8.error(errorMessage);\n\t\t\tnav.setValidationErrors([errorMessage]);\n\t\t} finally {\n\t\t\tsetIsSubmitting(false);\n\t\t}\n\t}, [\n\t\tvalidateAll,\n\t\tisConfigured,\n\t\tenvironmentId,\n\t\tvalues,\n\t\tdeviceType,\n\t\tselectedFlowType,\n\t\tcredentials,\n\t\tsetCredentials,\n\t\tnav,\n\t\tconfig,\n\t]);\n\n\t// Loading state\n\tif (globalLoading) {\n\t\treturn (\n\t\t\t<div style={{ padding: spacing['3xl'], textAlign: 'center' }}>\n\t\t\t\t<LoadingSpinner size=\"large\" text=\"Loading global configuration...\" />\n\t\t\t</div>\n\t\t);\n\t}\n\n\t// Not configured - show prompt\n\tif (!isConfigured) {\n\t\treturn (\n\t\t\t<PageTransition>\n\t\t\t\t<div style={{ maxWidth: '600px', margin: '0 auto', padding: spacing.xl }}>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: colors.warning[50],\n\t\t\t\t\t\t\tborder: `2px solid ${colors.warning[500]}`,\n\t\t\t\t\t\t\tborderRadius: borderRadius.lg,\n\t\t\t\t\t\t\tpadding: spacing.xl,\n\t\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<FiAlertCircle\n\t\t\t\t\t\t\tsize={48}\n\t\t\t\t\t\t\tcolor={colors.warning[500]}\n\t\t\t\t\t\t\tstyle={{ marginBottom: spacing.md }}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<h2 style={{ margin: `0 0 ${spacing.md} 0`, color: colors.warning[900] }}>\n\t\t\t\t\t\t\tGlobal Configuration Required\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<p style={{ margin: `0 0 ${spacing.lg} 0`, color: colors.warning[700] }}>\n\t\t\t\t\t\t\tPlease configure your Environment ID and Worker Token before proceeding.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t\t\tsize=\"lg\"\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t// Navigate to settings or show configuration modal\n\t\t\t\t\t\t\t\ttoastV8.info('Please configure global settings in the admin panel');\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tConfigure Settings\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</PageTransition>\n\t\t);\n\t}\n\n\t// Configured - show simplified form\n\treturn (\n\t\t<PageTransition>\n\t\t\t<div style={{ maxWidth: '800px', margin: '0 auto', padding: spacing.xl }}>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: `linear-gradient(135deg, ${colors.primary[500]} 0%, ${colors.primary[700]} 100%)`,\n\t\t\t\t\t\tborderRadius: borderRadius.xl,\n\t\t\t\t\t\tpadding: spacing.xl,\n\t\t\t\t\t\tmarginBottom: spacing.xl,\n\t\t\t\t\t\tboxShadow: `0 4px 12px ${colors.primary[500]}33`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<h2\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tmargin: `0 0 ${spacing.sm} 0`,\n\t\t\t\t\t\t\tfontSize: typography.fontSize['3xl'],\n\t\t\t\t\t\t\tfontWeight: typography.fontWeight.bold,\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tgap: spacing.md,\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{config.icon} Configure {config.displayName}\n\t\t\t\t\t</h2>\n\t\t\t\t\t<p style={{ margin: 0, color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\tEnter user details to begin registration\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Global Config Status */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: colors.success[50],\n\t\t\t\t\t\tborder: `1px solid ${colors.success[500]}`,\n\t\t\t\t\t\tborderRadius: borderRadius.lg,\n\t\t\t\t\t\tpadding: spacing.lg,\n\t\t\t\t\t\tmarginBottom: spacing.xl,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'center', gap: spacing.md }}>\n\t\t\t\t\t\t<FiCheck size={24} color={colors.success[500]} />\n\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t<h3 style={{ margin: `0 0 ${spacing.xs} 0`, color: colors.success[900] }}>\n\t\t\t\t\t\t\t\tGlobal Configuration Active\n\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\tstyle={{ margin: 0, fontSize: typography.fontSize.sm, color: colors.success[700] }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tEnvironment ID: <strong>{environmentId}</strong>\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\tWorker Token: <strong>{workerTokenStatus?.tokenValid ? 'Valid' : 'Invalid'}</strong>\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* User Configuration Form */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\tborderRadius: borderRadius.xl,\n\t\t\t\t\t\tpadding: spacing.xl,\n\t\t\t\t\t\tboxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',\n\t\t\t\t\t\tborder: `1px solid ${colors.neutral[200]}`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<h3 style={{ margin: `0 0 ${spacing.lg} 0`, color: colors.neutral[900] }}>\n\t\t\t\t\t\tUser Details\n\t\t\t\t\t</h3>\n\n\t\t\t\t\t<FormInput\n\t\t\t\t\t\tlabel=\"Username\"\n\t\t\t\t\t\tname=\"username\"\n\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\tvalue={values.username}\n\t\t\t\t\t\terror={errors.username}\n\t\t\t\t\t\ttouched={touched.username}\n\t\t\t\t\t\tonChange={handleChange}\n\t\t\t\t\t\tonBlur={handleBlur}\n\t\t\t\t\t\trequired\n\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\thelpText=\"The user who will register this MFA device\"\n\t\t\t\t\t/>\n\n\t\t\t\t\t{/* Flow Type Selection */}\n\t\t\t\t\t<div style={{ marginTop: spacing.lg }}>\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\tmarginBottom: spacing.sm,\n\t\t\t\t\t\t\t\tfontWeight: typography.fontWeight.semibold,\n\t\t\t\t\t\t\t\tcolor: colors.neutral[700],\n\t\t\t\t\t\t\t\tfontSize: typography.fontSize.sm,\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tRegistration Flow Type\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<div style={{ display: 'flex', flexDirection: 'column', gap: spacing.sm }}>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tpadding: spacing.md,\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${selectedFlowType === 'admin-active' ? colors.primary[500] : colors.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: borderRadius.md,\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\tbackground: selectedFlowType === 'admin-active' ? colors.primary[50] : 'white',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\tvalue=\"admin-active\"\n\t\t\t\t\t\t\t\t\tchecked={selectedFlowType === 'admin-active'}\n\t\t\t\t\t\t\t\t\tonChange={() => setSelectedFlowType('admin-active')}\n\t\t\t\t\t\t\t\t\tstyle={{ marginRight: spacing.sm }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<strong>Admin - Active</strong>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: typography.fontSize.sm, color: colors.neutral[600] }}>\n\t\t\t\t\t\t\t\t\t\tDevice ready immediately (no activation required)\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tpadding: spacing.md,\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${selectedFlowType === 'admin-activation' ? colors.primary[500] : colors.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: borderRadius.md,\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\tselectedFlowType === 'admin-activation' ? colors.primary[50] : 'white',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\tvalue=\"admin-activation\"\n\t\t\t\t\t\t\t\t\tchecked={selectedFlowType === 'admin-activation'}\n\t\t\t\t\t\t\t\t\tonChange={() => setSelectedFlowType('admin-activation')}\n\t\t\t\t\t\t\t\t\tstyle={{ marginRight: spacing.sm }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<strong>Admin - Activation Required</strong>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: typography.fontSize.sm, color: colors.neutral[600] }}>\n\t\t\t\t\t\t\t\t\t\tRequires OTP activation after registration\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\tpadding: spacing.md,\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${selectedFlowType === 'user' ? colors.primary[500] : colors.neutral[300]}`,\n\t\t\t\t\t\t\t\t\tborderRadius: borderRadius.md,\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\tbackground: selectedFlowType === 'user' ? colors.primary[50] : 'white',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\tvalue=\"user\"\n\t\t\t\t\t\t\t\t\tchecked={selectedFlowType === 'user'}\n\t\t\t\t\t\t\t\t\tonChange={() => setSelectedFlowType('user')}\n\t\t\t\t\t\t\t\t\tstyle={{ marginRight: spacing.sm }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<strong>User Flow</strong>\n\t\t\t\t\t\t\t\t\t<div style={{ fontSize: typography.fontSize.sm, color: colors.neutral[600] }}>\n\t\t\t\t\t\t\t\t\t\tRequires PingOne login + OTP activation\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Action Buttons */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tjustifyContent: 'flex-end',\n\t\t\t\t\t\tgap: spacing.md,\n\t\t\t\t\t\tmarginTop: spacing.xl,\n\t\t\t\t\t\tpaddingTop: spacing.lg,\n\t\t\t\t\t\tborderTop: `1px solid ${colors.neutral[200]}`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<Button\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t\tsize=\"lg\"\n\t\t\t\t\t\tonClick={handleContinue}\n\t\t\t\t\t\tloading={isSubmitting}\n\t\t\t\t\t\tdisabled={isSubmitting || !values.username.trim()}\n\t\t\t\t\t\trightIcon={<FiArrowRight />}\n\t\t\t\t\t\tfullWidth\n\t\t\t\t\t>\n\t\t\t\t\t\t{['EMAIL', 'SMS', 'WHATSAPP', 'TOTP'].includes(deviceType)\n\t\t\t\t\t\t\t? `Register ${config.displayName} ‚Üí`\n\t\t\t\t\t\t\t: 'Continue to Device Selection ‚Üí'}\n\t\t\t\t\t</Button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</PageTransition>\n\t);\n};\n\nexport default UnifiedConfigurationStepModern;\n"},"tags":[],"source":null},{"category":"lint/a11y/noLabelWithoutControl","severity":"error","description":"A form label must be associated with an input.","message":[{"elements":[],"content":"A form label must be associated with an input."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Consider adding a `for` or `htmlFor` attribute to the label element or moving the input element to inside the label element."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedConfigurationStep.tsx"},"span":[15552,15937],"sourceCode":"/**\n * @file UnifiedConfigurationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 0: Configuration - Environment and credential setup\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Configure environment, credentials, and token type before device registration\n *\n * Flow:\n * 1. Enter environment ID, username\n * 2. Select token type (Worker or User)\n * 3. Select device authentication policy (optional)\n * 4. Validate configuration\n * 5. Navigate to device selection step\n *\n * @example\n * <UnifiedConfigurationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   registrationFlowType=\"admin\"\n * />\n */\n\nimport React, { useCallback, useEffect, useRef, useState } from 'react';\nimport { MFAInfoButtonV8 } from '@/v8/components/MFAInfoButtonV8';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport type { TokenType } from '@/v8/flows/shared/MFATypes';\nimport { workerTokenServiceV8 } from '@/v8/services/workerTokenServiceV8';\nimport { WorkerTokenUIServiceV8 } from '@/v8/services/workerTokenUIServiceV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[‚öôÔ∏è UNIFIED-CONFIGURATION-STEP]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedConfigurationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Registration flow type (admin uses worker token, user uses user token) */\n\tregistrationFlowType?: 'admin' | 'user';\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Configuration Step (Step 0)\n *\n * Handles environment and credential configuration for unified MFA flow.\n */\nexport const UnifiedConfigurationStep: React.FC<UnifiedConfigurationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\ttokenStatus,\n\tdeviceAuthPolicies,\n\tisLoadingPolicies,\n\tpoliciesError,\n\trefreshDeviceAuthPolicies,\n\tshowWorkerTokenModal,\n\tsetShowWorkerTokenModal,\n\tshowUserLoginModal,\n\tsetShowUserLoginModal,\n\tshowSettingsModal,\n\tsetShowSettingsModal,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tregistrationFlowType = 'admin',\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering configuration step for:`, config.deviceType);\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\t// Load saved username from localStorage\n\tconst getSavedUsername = () => {\n\t\ttry {\n\t\t\treturn localStorage.getItem('mfa_unified_username') || credentials.username || '';\n\t\t} catch {\n\t\t\treturn credentials.username || '';\n\t\t}\n\t};\n\n\tconst [environmentId, setEnvironmentId] = useState(credentials.environmentId || '');\n\tconst [username, setUsername] = useState(getSavedUsername);\n\n\t// Registration flow type: 'admin-active', 'admin-activation', or 'user'\n\tconst [flowType, setFlowType] = useState<'admin-active' | 'admin-activation' | 'user'>(\n\t\tregistrationFlowType === 'user' ? 'user' : 'admin-active'\n\t);\n\n\t// Derived token type from flow type\n\tconst tokenType: TokenType = flowType === 'user' ? 'user' : 'worker';\n\n\t// Device status for admin flows\n\tconst adminDeviceStatus = flowType === 'admin-active' ? 'ACTIVE' : 'ACTIVATION_REQUIRED';\n\n\tconst [selectedPolicyId, setSelectedPolicyId] = useState(\n\t\tcredentials.deviceAuthenticationPolicyId || ''\n\t);\n\n\t// Validation errors\n\tconst [errors, setErrors] = useState<Record<string, string>>({});\n\n\t// ========================================================================\n\t// EFFECTS\n\t// ========================================================================\n\n\t/**\n\t * Auto-populate environment ID from worker token if available\n\t */\n\tuseEffect(() => {\n\t\tif (!environmentId && tokenStatus.isValid) {\n\t\t\tconst workerCreds = workerTokenServiceV8.loadCredentialsSync();\n\t\t\tif (workerCreds?.environmentId) {\n\t\t\t\tconsole.log(`${MODULE_TAG} Auto-populating environment ID:`, workerCreds.environmentId);\n\t\t\t\tsetEnvironmentId(workerCreds.environmentId);\n\t\t\t\tsetCredentials((prev) => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\tenvironmentId: workerCreds.environmentId,\n\t\t\t\t\tregion: workerCreds.region || prev.region || 'us',\n\t\t\t\t\tcustomDomain: workerCreds.customDomain || prev.customDomain,\n\t\t\t\t}));\n\t\t\t}\n\t\t}\n\t}, [tokenStatus.isValid, environmentId, setCredentials]);\n\n\t/**\n\t * Save username to localStorage when it changes\n\t */\n\tuseEffect(() => {\n\t\tif (username.trim()) {\n\t\t\ttry {\n\t\t\t\tlocalStorage.setItem('mfa_unified_username', username.trim());\n\t\t\t\tconsole.log(`${MODULE_TAG} Saved username to localStorage`);\n\t\t\t} catch {\n\t\t\t\t// Ignore localStorage errors\n\t\t\t}\n\t\t}\n\t}, [username]);\n\n\t/**\n\t * Auto-select first device authentication policy when loaded\n\t */\n\tuseEffect(() => {\n\t\tif (deviceAuthPolicies.length > 0 && !selectedPolicyId) {\n\t\t\tconst firstPolicy = deviceAuthPolicies[0];\n\t\t\tconsole.log(`${MODULE_TAG} Auto-selecting first policy:`, firstPolicy.name);\n\t\t\tsetSelectedPolicyId(firstPolicy.id);\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceAuthenticationPolicyId: firstPolicy.id,\n\t\t\t}));\n\t\t}\n\t}, [deviceAuthPolicies, selectedPolicyId, setCredentials]);\n\n\t/**\n\t * Sync flow type when registration flow type prop changes\n\t */\n\tuseEffect(() => {\n\t\tif (registrationFlowType === 'user' && flowType !== 'user') {\n\t\t\tconsole.log(`${MODULE_TAG} User registration flow - switching to user flow type`);\n\t\t\tsetFlowType('user');\n\t\t}\n\t}, [registrationFlowType, flowType]);\n\n\t/**\n\t * Track if we've already auto-advanced to prevent loops\n\t */\n\tconst hasAutoAdvanced = useRef(false);\n\n\t/**\n\t * Auto-advance after successful OAuth login for User Flow\n\t * When user returns from OAuth with a token, automatically proceed to next step\n\t */\n\tuseEffect(() => {\n\t\t// Only auto-advance for user flow when we have a user token\n\t\tif (\n\t\t\tflowType === 'user' &&\n\t\t\tcredentials.userToken &&\n\t\t\tenvironmentId.trim() &&\n\t\t\tusername.trim() &&\n\t\t\t!hasAutoAdvanced.current\n\t\t) {\n\t\t\tconsole.log(`${MODULE_TAG} Auto-advancing after OAuth login`);\n\t\t\thasAutoAdvanced.current = true;\n\n\t\t\t// Update credentials with final values\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tenvironmentId: environmentId.trim(),\n\t\t\t\tusername: username.trim(),\n\t\t\t\ttokenType: 'user',\n\t\t\t\tdeviceAuthenticationPolicyId: selectedPolicyId,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t}));\n\n\t\t\t// Small delay to ensure state updates propagate\n\t\t\tsetTimeout(() => {\n\t\t\t\ttoastV8.success('Authentication successful! Proceeding to next step...');\n\t\t\t\tnav.markStepComplete();\n\t\t\t\tnav.goToNext();\n\t\t\t}, 300);\n\t\t}\n\t}, [\n\t\tcredentials.userToken,\n\t\tflowType,\n\t\tenvironmentId,\n\t\tusername,\n\t\tselectedPolicyId,\n\t\tconfig.deviceType,\n\t\tsetCredentials,\n\t\tnav,\n\t]);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Validate configuration fields\n\t */\n\tconst validateConfiguration = useCallback((): boolean => {\n\t\tconst newErrors: Record<string, string> = {};\n\n\t\t// Validate environment ID\n\t\tif (!environmentId.trim()) {\n\t\t\tnewErrors.environmentId = 'Environment ID is required';\n\t\t}\n\n\t\t// Validate username\n\t\tif (!username.trim()) {\n\t\t\tnewErrors.username = 'Username is required';\n\t\t}\n\n\t\t// Validate token based on token type\n\t\tif (tokenType === 'worker') {\n\t\t\tif (!tokenStatus.isValid) {\n\t\t\t\tnewErrors.token = 'Valid worker token is required';\n\t\t\t}\n\t\t} else if (tokenType === 'user') {\n\t\t\tif (!credentials.userToken) {\n\t\t\t\tnewErrors.token = 'User token is required. Please log in.';\n\t\t\t}\n\t\t}\n\n\t\tsetErrors(newErrors);\n\n\t\tif (Object.keys(newErrors).length > 0) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed:`, newErrors);\n\t\t\tnav.setValidationErrors(Object.values(newErrors));\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}, [environmentId, username, tokenType, tokenStatus, credentials, nav]);\n\n\t/**\n\t * Handle continue button click\n\t */\n\tconst handleContinue = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} Continuing to device selection`);\n\n\t\t// Validate configuration\n\t\tif (!validateConfiguration()) {\n\t\t\ttoastV8.error('Please fix the configuration errors');\n\t\t\treturn;\n\t\t}\n\n\t\t// Update credentials with final values\n\t\tsetCredentials((prev) => ({\n\t\t\t...prev,\n\t\t\tenvironmentId: environmentId.trim(),\n\t\t\tusername: username.trim(),\n\t\t\ttokenType,\n\t\t\tdeviceAuthenticationPolicyId: selectedPolicyId,\n\t\t\tdeviceType: config.deviceType,\n\t\t\t// Store device status for admin flows (ACTIVE or ACTIVATION_REQUIRED)\n\t\t\tdeviceStatus: flowType !== 'user' ? adminDeviceStatus : undefined,\n\t\t}));\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to next step (device selection)\n\t\tnav.goToNext();\n\t}, [\n\t\tenvironmentId,\n\t\tusername,\n\t\ttokenType,\n\t\tselectedPolicyId,\n\t\tconfig,\n\t\tvalidateConfiguration,\n\t\tsetCredentials,\n\t\tnav,\n\t\tadminDeviceStatus,\n\t\tflowType,\n\t]);\n\n\t/**\n\t * Handle environment ID change\n\t */\n\tconst handleEnvironmentIdChange = useCallback((value: string) => {\n\t\tsetEnvironmentId(value);\n\t\tsetErrors((prev) => {\n\t\t\tconst { environmentId, ...rest } = prev;\n\t\t\treturn rest;\n\t\t});\n\t}, []);\n\n\t/**\n\t * Handle username change\n\t */\n\tconst handleUsernameChange = useCallback((value: string) => {\n\t\tsetUsername(value);\n\t\tsetErrors((prev) => {\n\t\t\tconst { username, ...rest } = prev;\n\t\t\treturn rest;\n\t\t});\n\t}, []);\n\n\t/**\n\t * Handle flow type change\n\t */\n\tconst handleFlowTypeChange = useCallback(\n\t\t(type: 'admin-active' | 'admin-activation' | 'user') => {\n\t\t\tconsole.log(`${MODULE_TAG} Flow type changed to:`, type);\n\t\t\tsetFlowType(type);\n\t\t\tsetErrors((prev) => {\n\t\t\t\tconst { token, ...rest } = prev;\n\t\t\t\treturn rest;\n\t\t\t});\n\n\t\t\t// Open user login modal when user flow is selected\n\t\t\tif (type === 'user' && !credentials.userToken) {\n\t\t\t\tsetShowUserLoginModal(true);\n\t\t\t}\n\t\t},\n\t\t[credentials.userToken, setShowUserLoginModal]\n\t);\n\n\t/**\n\t * Handle policy selection change\n\t */\n\tconst handlePolicyChange = useCallback(\n\t\t(policyId: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Policy changed to:`, policyId);\n\t\t\tsetSelectedPolicyId(policyId);\n\t\t\tsetCredentials((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tdeviceAuthenticationPolicyId: policyId,\n\t\t\t}));\n\t\t},\n\t\t[setCredentials]\n\t);\n\n\t// ========================================================================\n\t// COMPUTED PROPERTIES\n\t// ========================================================================\n\n\tconst selectedPolicy = deviceAuthPolicies.find((p) => p.id === selectedPolicyId);\n\tconst canProceed =\n\t\tenvironmentId.trim() &&\n\t\tusername.trim() &&\n\t\t(tokenType === 'worker' ? tokenStatus.isValid : !!credentials.userToken);\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div\n\t\t\tclassName=\"unified-configuration-step\"\n\t\t\tstyle={{\n\t\t\t\tmaxWidth: '900px',\n\t\t\t\tmargin: '0 auto',\n\t\t\t\tpadding: '24px',\n\t\t\t}}\n\t\t>\n\t\t\t{/* Step Header */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px 32px',\n\t\t\t\t\tmarginBottom: '28px',\n\t\t\t\t\tboxShadow: '0 4px 12px rgba(139, 92, 246, 0.2)',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<h2\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: '0 0 8px 0',\n\t\t\t\t\t\tfontSize: '26px',\n\t\t\t\t\t\tfontWeight: '700',\n\t\t\t\t\t\tcolor: '#ffffff',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '12px',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{config.icon} Configure {config.displayName} Registration\n\t\t\t\t</h2>\n\t\t\t\t<p\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: 0,\n\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\tcolor: 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\tEnter your environment and user credentials to begin the registration process.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Configuration Form */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\tpadding: '28px',\n\t\t\t\t\tboxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',\n\t\t\t\t\tborder: '1px solid #e5e7eb',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>\n\t\t\t\t\t{/* Environment ID */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\thtmlFor=\"environmentId\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tEnvironment ID <span style={{ color: '#dc2626' }}>*</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tid=\"environmentId\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={environmentId}\n\t\t\t\t\t\t\tonChange={(e) => handleEnvironmentIdChange(e.target.value)}\n\t\t\t\t\t\t\tplaceholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 14px',\n\t\t\t\t\t\t\t\tborder: `1px solid ${errors.environmentId ? '#dc2626' : '#d1d5db'}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#8b5cf6';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(139, 92, 246, 0.1)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = errors.environmentId ? '#dc2626' : '#d1d5db';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\taria-invalid={!!errors.environmentId}\n\t\t\t\t\t\t\taria-describedby={errors.environmentId ? 'environmentId-error' : undefined}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{errors.environmentId && (\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tid=\"environmentId-error\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#dc2626',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{errors.environmentId}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Username */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\thtmlFor=\"username\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '8px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tUsername <span style={{ color: '#dc2626' }}>*</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tid=\"username\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tvalue={username}\n\t\t\t\t\t\t\tonChange={(e) => handleUsernameChange(e.target.value)}\n\t\t\t\t\t\t\tplaceholder=\"user@example.com\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: '12px 14px',\n\t\t\t\t\t\t\t\tborder: `1px solid ${errors.username ? '#dc2626' : '#d1d5db'}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tcolor: '#111827',\n\t\t\t\t\t\t\t\tbackground: '#ffffff',\n\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonFocus={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#8b5cf6';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 0 0 3px rgba(139, 92, 246, 0.1)';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonBlur={(e) => {\n\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = errors.username ? '#dc2626' : '#d1d5db';\n\t\t\t\t\t\t\t\te.currentTarget.style.boxShadow = 'none';\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\taria-invalid={!!errors.username}\n\t\t\t\t\t\t\taria-describedby={errors.username ? 'username-error' : undefined}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{errors.username && (\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tid=\"username-error\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t\t\t\t\tmarginTop: '6px',\n\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\tcolor: '#dc2626',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{errors.username}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Registration Flow Type Selection */}\n\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t<label\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\tcolor: '#374151',\n\t\t\t\t\t\t\t\tmarginBottom: '12px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tRegistration Flow <span className=\"required\">*</span>\n\t\t\t\t\t\t\t<MFAInfoButtonV8 contentKey=\"mfa.registrationFlowType\" displayMode=\"modal\" />\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t\t\t\t\tgap: '12px',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Admin Flow (ACTIVE) Option */}\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-active' ? '#10b981' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\tbackground: flowType === 'admin-active' ? '#ecfdf5' : '#ffffff',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\tflowType === 'admin-active'\n\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(16, 185, 129, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-active') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#6ee7b7';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#f0fdf4';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-active') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"admin-active\"\n\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'admin-active'}\n\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('admin-active')}\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\taccentColor: '#10b981',\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'admin-active' ? '#047857' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüîë Admin Flow (ACTIVE)\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#d1fae5',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#065f46',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tInstant Activation\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tDevice is created and immediately active. No OTP verification required. Uses\n\t\t\t\t\t\t\t\t\t\t\tWorker Token.\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t\t{/* Admin Flow (ACTIVATION_REQUIRED) Option - Hidden for FIDO2 */}\n\t\t\t\t\t\t\t{config.deviceType !== 'FIDO2' && (\n\t\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'admin-activation' ? '#f59e0b' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\t\tbackground: flowType === 'admin-activation' ? '#fffbeb' : '#ffffff',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\t\tflowType === 'admin-activation'\n\t\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(245, 158, 11, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-activation') {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#fcd34d';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#fefce8';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (flowType !== 'admin-activation') {\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\t\tvalue=\"admin-activation\"\n\t\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'admin-activation'}\n\t\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('admin-activation')}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\t\taccentColor: '#f59e0b',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'admin-activation' ? '#b45309' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tüîê Admin Flow (ACTIVATION_REQUIRED)\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#fef3c7',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#92400e',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\tOTP Required\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tDevice is created pending activation. User must verify with OTP before\n\t\t\t\t\t\t\t\t\t\t\t\tdevice becomes active. Uses Worker Token.\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t\t{/* User Flow Option */}\n\t\t\t\t\t\t\t<label\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tpadding: '16px 20px',\n\t\t\t\t\t\t\t\t\tborder: `2px solid ${flowType === 'user' ? '#8b5cf6' : '#e5e7eb'}`,\n\t\t\t\t\t\t\t\t\tborderRadius: '10px',\n\t\t\t\t\t\t\t\t\tbackground: flowType === 'user' ? '#f5f3ff' : '#ffffff',\n\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\tboxShadow:\n\t\t\t\t\t\t\t\t\t\tflowType === 'user'\n\t\t\t\t\t\t\t\t\t\t\t? '0 4px 12px rgba(139, 92, 246, 0.15)'\n\t\t\t\t\t\t\t\t\t\t\t: '0 1px 3px rgba(0, 0, 0, 0.05)',\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'user') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#c4b5fd';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#faf5ff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\tif (flowType !== 'user') {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = '#e5e7eb';\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.background = '#ffffff';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"radio\"\n\t\t\t\t\t\t\t\t\t\tname=\"flowType\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"user\"\n\t\t\t\t\t\t\t\t\t\tchecked={flowType === 'user'}\n\t\t\t\t\t\t\t\t\t\tonChange={() => handleFlowTypeChange('user')}\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: '20px',\n\t\t\t\t\t\t\t\t\t\t\theight: '20px',\n\t\t\t\t\t\t\t\t\t\t\taccentColor: '#8b5cf6',\n\t\t\t\t\t\t\t\t\t\t\tmarginTop: '2px',\n\t\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: flowType === 'user' ? '#6d28d9' : '#1f2937',\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tüë§ User Flow\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '11px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 8px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: '#ede9fe',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#5b21b6',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\tOAuth Login\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '13px',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: '#6b7280',\n\t\t\t\t\t\t\t\t\t\t\t\tlineHeight: '1.5',\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tUser authenticates via OAuth and registers their own device. Requires user\n\t\t\t\t\t\t\t\t\t\t\tlogin.\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Token Status Display */}\n\t\t\t\t\t<div className=\"token-status-section\">\n\t\t\t\t\t\t{tokenType === 'worker' && (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<WorkerTokenUIServiceV8\n\t\t\t\t\t\t\t\t\tmode=\"detailed\"\n\t\t\t\t\t\t\t\t\tshowRefresh={true}\n\t\t\t\t\t\t\t\t\tshowStatusDisplay={true}\n\t\t\t\t\t\t\t\t\tstatusSize=\"large\"\n\t\t\t\t\t\t\t\t\tcontext=\"mfa\"\n\t\t\t\t\t\t\t\t\tenvironmentId={environmentId}\n\t\t\t\t\t\t\t\t\tonEnvironmentIdUpdate={handleEnvironmentIdChange}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{errors.token && (\n\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\tclassName=\"error-message\"\n\t\t\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t\t\t\tstyle={{ marginTop: '12px', display: 'block' }}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{errors.token}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{tokenType === 'user' && (\n\t\t\t\t\t\t\t<div className=\"token-status-card\">\n\t\t\t\t\t\t\t\t<h4>User Token Status</h4>\n\t\t\t\t\t\t\t\t<div className={`status-indicator ${credentials.userToken ? 'valid' : 'invalid'}`}>\n\t\t\t\t\t\t\t\t\t{credentials.userToken ? '‚úì Logged In' : '‚úó Not Logged In'}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={() => setShowUserLoginModal(true)}\n\t\t\t\t\t\t\t\t\tclassName=\"button-link\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{credentials.userToken ? 'Re-authenticate' : 'Login via OAuth'}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{errors.token && (\n\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\tclassName=\"error-message\"\n\t\t\t\t\t\t\t\t\t\trole=\"alert\"\n\t\t\t\t\t\t\t\t\t\tstyle={{ marginTop: '12px', display: 'block' }}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{errors.token}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Device Authentication Policy */}\n\t\t\t\t\t{deviceAuthPolicies.length > 0 && (\n\t\t\t\t\t\t<div className=\"form-field\">\n\t\t\t\t\t\t\t<label htmlFor=\"deviceAuthPolicy\">\n\t\t\t\t\t\t\t\tDevice Authentication Policy\n\t\t\t\t\t\t\t\t<MFAInfoButtonV8 contentKey=\"device.authentication.policy\" displayMode=\"modal\" />\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t<select\n\t\t\t\t\t\t\t\tid=\"deviceAuthPolicy\"\n\t\t\t\t\t\t\t\tvalue={selectedPolicyId}\n\t\t\t\t\t\t\t\tonChange={(e) => handlePolicyChange(e.target.value)}\n\t\t\t\t\t\t\t\tdisabled={isLoadingPolicies}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{deviceAuthPolicies.map((policy) => (\n\t\t\t\t\t\t\t\t\t<option key={policy.id} value={policy.id}>\n\t\t\t\t\t\t\t\t\t\t{policy.name}\n\t\t\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t{selectedPolicy?.description && (\n\t\t\t\t\t\t\t\t<p className=\"field-hint\">{selectedPolicy.description}</p>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* Policy Loading/Error States */}\n\t\t\t\t\t{isLoadingPolicies && (\n\t\t\t\t\t\t<div className=\"loading-indicator\">Loading device authentication policies...</div>\n\t\t\t\t\t)}\n\t\t\t\t\t{policiesError && (\n\t\t\t\t\t\t<div className=\"error-message\" role=\"alert\">\n\t\t\t\t\t\t\t{policiesError}\n\t\t\t\t\t\t\t<button type=\"button\" onClick={refreshDeviceAuthPolicies} className=\"button-link\">\n\t\t\t\t\t\t\t\tRetry\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{/* Action Buttons */}\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\tjustifyContent: 'flex-end',\n\t\t\t\t\talignItems: 'center',\n\t\t\t\t\tmarginTop: '32px',\n\t\t\t\t\tpaddingTop: '24px',\n\t\t\t\t\tborderTop: '1px solid #e5e7eb',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleContinue}\n\t\t\t\t\tdisabled={!canProceed || isLoading}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: '14px 28px',\n\t\t\t\t\t\tbackground: canProceed && !isLoading ? '#8b5cf6' : '#d1d5db',\n\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\tfontSize: '15px',\n\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\tcolor: canProceed && !isLoading ? '#ffffff' : '#9ca3af',\n\t\t\t\t\t\tcursor: canProceed && !isLoading ? 'pointer' : 'not-allowed',\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\tboxShadow: canProceed && !isLoading ? '0 4px 12px rgba(139, 92, 246, 0.3)' : 'none',\n\t\t\t\t\t}}\n\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\tif (canProceed && !isLoading) {\n\t\t\t\t\t\t\te.currentTarget.style.background = '#7c3aed';\n\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(-1px)';\n\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 6px 16px rgba(139, 92, 246, 0.4)';\n\t\t\t\t\t\t}\n\t\t\t\t\t}}\n\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\tif (canProceed && !isLoading) {\n\t\t\t\t\t\t\te.currentTarget.style.background = '#8b5cf6';\n\t\t\t\t\t\t\te.currentTarget.style.transform = 'translateY(0)';\n\t\t\t\t\t\t\te.currentTarget.style.boxShadow = '0 4px 12px rgba(139, 92, 246, 0.3)';\n\t\t\t\t\t\t}\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Loading...' : 'Next Step ‚Üí'}\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n\nexport default UnifiedConfigurationStep;\n"},"tags":[],"source":null},{"category":"lint/a11y/noStaticElementInteractions","severity":"error","description":"Static Elements should not be interactive.","message":[{"elements":[],"content":"Static Elements should not be interactive."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"To add interactivity such as a mouse or key event listener to a static element, give the element an appropriate role value."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedDeviceSelectionModal.tsx"},"span":[4220,4580],"sourceCode":"/**\n * @file UnifiedDeviceSelectionModal.tsx\n * @module v8/flows/unified/components\n * @description Modern device selection modal for MFA authentication\n * @version 9.2.2\n * @since 2026-01-30\n *\n * Purpose: Allow users to select which MFA device to authenticate with\n * Shows all registered devices with their types and status\n */\n\nimport React, { useEffect, useState } from 'react';\nimport { MFAServiceV8 } from '@/v8/services/mfaServiceV8';\nimport { colors, spacing } from '@/v8/styles/designTokens';\n\ninterface Device {\n\tid: string;\n\ttype: 'SMS' | 'EMAIL' | 'TOTP' | 'VOICE' | 'FIDO2' | 'MOBILE' | 'WHATSAPP';\n\tdeviceName?: string;\n\tnickname?: string;\n\tstatus:\n\t\t| 'ACTIVE'\n\t\t| 'ACTIVATION_REQUIRED'\n\t\t| 'DISABLED'\n\t\t| 'BLOCKED'\n\t\t| 'LOCKED'\n\t\t| 'PENDING'\n\t\t| 'SUSPENDED'\n\t\t| 'EXPIRED';\n}\n\ninterface UnifiedDeviceSelectionModalProps {\n\tisOpen: boolean;\n\tonClose: () => void;\n\tonDeviceSelect: (device: Device) => void;\n\tusername: string;\n\tenvironmentId: string;\n\tloading?: boolean;\n\terror?: string;\n}\n\nconst DEVICE_ICONS = {\n\tSMS: 'üì±',\n\tEMAIL: 'üìß',\n\tTOTP: 'üîê',\n\tVOICE: 'üìû',\n\tFIDO2: 'üîë',\n\tMOBILE: 'üì≤',\n\tWHATSAPP: 'üí¨',\n};\n\nconst DEVICE_COLORS = {\n\tSMS: colors.primary[600],\n\tEMAIL: colors.success[600],\n\tTOTP: colors.purple[600],\n\tVOICE: colors.warning[600],\n\tFIDO2: colors.info[600],\n\tMOBILE: colors.primary[500],\n\tWHATSAPP: colors.success[500],\n};\n\nconst STATUS_BADGES = {\n\tACTIVE: { text: 'Active', color: colors.success[600], bg: colors.success[50] },\n\tACTIVATION_REQUIRED: {\n\t\ttext: 'Activation Required',\n\t\tcolor: colors.warning[600],\n\t\tbg: colors.warning[50],\n\t},\n\tDISABLED: { text: 'Disabled', color: colors.gray[600], bg: colors.gray[50] },\n};\n\nexport const UnifiedDeviceSelectionModal: React.FC<UnifiedDeviceSelectionModalProps> = ({\n\tisOpen,\n\tonClose,\n\tonDeviceSelect,\n\tusername,\n\tenvironmentId,\n\tloading = false,\n\terror = null,\n}) => {\n\tconst [devices, setDevices] = useState<Device[]>([]);\n\tconst [searchQuery, setSearchQuery] = useState('');\n\tconst [isLoading, setIsLoading] = useState(false);\n\tconst [errorMsg, setErrorMsg] = useState<string | null>(null);\n\n\t// Fetch real devices from API\n\tuseEffect(() => {\n\t\tif (isOpen && username && environmentId) {\n\t\t\tconst fetchDevices = async () => {\n\t\t\t\tsetIsLoading(true);\n\t\t\t\tsetErrorMsg(null);\n\t\t\t\ttry {\n\t\t\t\t\tconst allDevices = await MFAServiceV8.getAllDevices({\n\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\tusername,\n\t\t\t\t\t});\n\n\t\t\t\t\t// Filter out devices with ACTIVATION_REQUIRED status\n\t\t\t\t\t// Only show ACTIVE devices for authentication\n\t\t\t\t\tconst activeDevices = allDevices\n\t\t\t\t\t\t.filter((device: any) => device.status === 'ACTIVE')\n\t\t\t\t\t\t.map((device: any) => ({\n\t\t\t\t\t\t\tid: device.id,\n\t\t\t\t\t\t\ttype: device.type,\n\t\t\t\t\t\t\tdeviceName: device.name || device.phone?.number || device.email?.address,\n\t\t\t\t\t\t\tnickname: device.nickname,\n\t\t\t\t\t\t\tstatus: device.status,\n\t\t\t\t\t\t}));\n\n\t\t\t\t\tconsole.log('[DEVICE-SELECTION] Loaded devices:', activeDevices.length, 'active devices');\n\t\t\t\t\tsetDevices(activeDevices);\n\t\t\t\t} catch (err) {\n\t\t\t\t\tconsole.error('[DEVICE-SELECTION] Error loading devices:', err);\n\t\t\t\t\tsetErrorMsg(err instanceof Error ? err.message : 'Failed to load devices');\n\t\t\t\t} finally {\n\t\t\t\t\tsetIsLoading(false);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tfetchDevices();\n\t\t}\n\t}, [isOpen, username, environmentId]);\n\n\t// Filter devices based on search query\n\tconst filteredDevices = devices.filter(\n\t\t(device) =>\n\t\t\tdevice.deviceName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n\t\t\tdevice.nickname?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n\t\t\tdevice.type.toLowerCase().includes(searchQuery.toLowerCase())\n\t);\n\n\t// Only show active devices for authentication\n\tconst availableDevices = filteredDevices.filter((device) => device.status === 'ACTIVE');\n\n\tconst handleDeviceSelect = (device: Device) => {\n\t\tonDeviceSelect(device);\n\t\tonClose();\n\t};\n\n\tif (!isOpen) return null;\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tposition: 'fixed',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\tdisplay: 'flex',\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tzIndex: 1000,\n\t\t\t}}\n\t\t\tonClick={onClose}\n\t\t\tonKeyDown={(e) => {\n\t\t\t\tif (e.key === 'Escape') {\n\t\t\t\t\tonClose();\n\t\t\t\t}\n\t\t\t}}\n\t\t\trole=\"dialog\"\n\t\t\taria-modal=\"true\"\n\t\t>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'white',\n\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\tboxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',\n\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\twidth: '90%',\n\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t}}\n\t\t\t\tonClick={(e) => e.stopPropagation()}\n\t\t\t>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\tborderBottom: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tmarginBottom: spacing[4],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: 0, fontSize: '20px', fontWeight: '700', color: colors.gray[900] }}>\n\t\t\t\t\t\t\tüîì Select Authentication Device\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'none',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\tcolor: colors.gray[400],\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tpadding: '0',\n\t\t\t\t\t\t\t\tlineHeight: 1,\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t√ó\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style={{ fontSize: '14px', color: colors.gray[600], lineHeight: 1.5 }}>\n\t\t\t\t\t\tChoose which MFA device to authenticate with for <strong>{username}</strong>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Search */}\n\t\t\t\t\t<div style={{ marginTop: spacing[4] }}>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tplaceholder=\"Search devices...\"\n\t\t\t\t\t\t\tvalue={searchQuery}\n\t\t\t\t\t\t\tonChange={(e) => setSearchQuery(e.target.value)}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: spacing[3],\n\t\t\t\t\t\t\t\tborder: `1px solid ${colors.gray[300]}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Content */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\toverflowY: 'auto',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4] }}>‚è≥</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.gray[600] }}>Loading your devices...</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : errorMsg ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4], color: colors.error[500] }}>\n\t\t\t\t\t\t\t\t‚ö†Ô∏è\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.error[600] }}>{errorMsg}</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : availableDevices.length === 0 ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4] }}>üì±</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.gray[600] }}>\n\t\t\t\t\t\t\t\tNo active MFA devices found. Please register a device first.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : (\n\t\t\t\t\t\t<div style={{ display: 'grid', gap: spacing[4] }}>\n\t\t\t\t\t\t\t{availableDevices.map((device) => (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tkey={device.id}\n\t\t\t\t\t\t\t\t\tonClick={() => handleDeviceSelect(device)}\n\t\t\t\t\t\t\t\t\tonKeyDown={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (e.key === 'Enter' || e.key === ' ') {\n\t\t\t\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t\t\t\thandleDeviceSelect(device);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: spacing[4],\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${colors.gray[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: spacing[4],\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = DEVICE_COLORS[device.type];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.backgroundColor = colors.gray[50];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = colors.gray[200];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.backgroundColor = 'white';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\ttabIndex={0}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{/* Device Icon */}\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\t\twidth: '48px',\n\t\t\t\t\t\t\t\t\t\t\theight: '48px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tbackground: `${DEVICE_COLORS[device.type]}15`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{DEVICE_ICONS[device.type]}\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Device Info */}\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[900],\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: spacing[1],\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{device.nickname || device.deviceName || `${device.type} Device`}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'center', gap: spacing[2] }}>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[600],\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: `${DEVICE_COLORS[device.type]}15`,\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 6px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{device.type}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 6px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: STATUS_BADGES[device.status].bg,\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: STATUS_BADGES[device.status].color,\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{STATUS_BADGES[device.status].text}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Arrow */}\n\t\t\t\t\t\t\t\t\t<div style={{ color: colors.gray[400] }}>‚Üí</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\n\t\t\t\t{/* Footer */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\tborderTop: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div style={{ fontSize: '12px', color: colors.gray[500] }}>\n\t\t\t\t\t\t{availableDevices.length} device{availableDevices.length !== 1 ? 's' : ''} available\n\t\t\t\t\t</div>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: `${spacing[2]} ${spacing[4]}`,\n\t\t\t\t\t\t\tbackground: colors.gray[100],\n\t\t\t\t\t\t\tborder: `1px solid ${colors.gray[300]}`,\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcolor: colors.gray[700],\n\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tCancel\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n"},"tags":[],"source":null},{"category":"lint/a11y/useKeyWithClickEvents","severity":"error","description":"Enforce to have the onClick mouse event with the onKeyUp, the onKeyDown, or the onKeyPress keyboard event.","message":[{"elements":[],"content":"Enforce to have the "},{"elements":["Emphasis"],"content":"onClick"},{"elements":[],"content":" mouse event with the "},{"elements":["Emphasis"],"content":"onKeyUp"},{"elements":[],"content":", the "},{"elements":["Emphasis"],"content":"onKeyDown"},{"elements":[],"content":", or the "},{"elements":["Emphasis"],"content":"onKeyPress"},{"elements":[],"content":" keyboard event."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Actions triggered using mouse events should have corresponding keyboard events to account for keyboard-only navigation."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedDeviceSelectionModal.tsx"},"span":[4220,4580],"sourceCode":"/**\n * @file UnifiedDeviceSelectionModal.tsx\n * @module v8/flows/unified/components\n * @description Modern device selection modal for MFA authentication\n * @version 9.2.2\n * @since 2026-01-30\n *\n * Purpose: Allow users to select which MFA device to authenticate with\n * Shows all registered devices with their types and status\n */\n\nimport React, { useEffect, useState } from 'react';\nimport { MFAServiceV8 } from '@/v8/services/mfaServiceV8';\nimport { colors, spacing } from '@/v8/styles/designTokens';\n\ninterface Device {\n\tid: string;\n\ttype: 'SMS' | 'EMAIL' | 'TOTP' | 'VOICE' | 'FIDO2' | 'MOBILE' | 'WHATSAPP';\n\tdeviceName?: string;\n\tnickname?: string;\n\tstatus:\n\t\t| 'ACTIVE'\n\t\t| 'ACTIVATION_REQUIRED'\n\t\t| 'DISABLED'\n\t\t| 'BLOCKED'\n\t\t| 'LOCKED'\n\t\t| 'PENDING'\n\t\t| 'SUSPENDED'\n\t\t| 'EXPIRED';\n}\n\ninterface UnifiedDeviceSelectionModalProps {\n\tisOpen: boolean;\n\tonClose: () => void;\n\tonDeviceSelect: (device: Device) => void;\n\tusername: string;\n\tenvironmentId: string;\n\tloading?: boolean;\n\terror?: string;\n}\n\nconst DEVICE_ICONS = {\n\tSMS: 'üì±',\n\tEMAIL: 'üìß',\n\tTOTP: 'üîê',\n\tVOICE: 'üìû',\n\tFIDO2: 'üîë',\n\tMOBILE: 'üì≤',\n\tWHATSAPP: 'üí¨',\n};\n\nconst DEVICE_COLORS = {\n\tSMS: colors.primary[600],\n\tEMAIL: colors.success[600],\n\tTOTP: colors.purple[600],\n\tVOICE: colors.warning[600],\n\tFIDO2: colors.info[600],\n\tMOBILE: colors.primary[500],\n\tWHATSAPP: colors.success[500],\n};\n\nconst STATUS_BADGES = {\n\tACTIVE: { text: 'Active', color: colors.success[600], bg: colors.success[50] },\n\tACTIVATION_REQUIRED: {\n\t\ttext: 'Activation Required',\n\t\tcolor: colors.warning[600],\n\t\tbg: colors.warning[50],\n\t},\n\tDISABLED: { text: 'Disabled', color: colors.gray[600], bg: colors.gray[50] },\n};\n\nexport const UnifiedDeviceSelectionModal: React.FC<UnifiedDeviceSelectionModalProps> = ({\n\tisOpen,\n\tonClose,\n\tonDeviceSelect,\n\tusername,\n\tenvironmentId,\n\tloading = false,\n\terror = null,\n}) => {\n\tconst [devices, setDevices] = useState<Device[]>([]);\n\tconst [searchQuery, setSearchQuery] = useState('');\n\tconst [isLoading, setIsLoading] = useState(false);\n\tconst [errorMsg, setErrorMsg] = useState<string | null>(null);\n\n\t// Fetch real devices from API\n\tuseEffect(() => {\n\t\tif (isOpen && username && environmentId) {\n\t\t\tconst fetchDevices = async () => {\n\t\t\t\tsetIsLoading(true);\n\t\t\t\tsetErrorMsg(null);\n\t\t\t\ttry {\n\t\t\t\t\tconst allDevices = await MFAServiceV8.getAllDevices({\n\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\tusername,\n\t\t\t\t\t});\n\n\t\t\t\t\t// Filter out devices with ACTIVATION_REQUIRED status\n\t\t\t\t\t// Only show ACTIVE devices for authentication\n\t\t\t\t\tconst activeDevices = allDevices\n\t\t\t\t\t\t.filter((device: any) => device.status === 'ACTIVE')\n\t\t\t\t\t\t.map((device: any) => ({\n\t\t\t\t\t\t\tid: device.id,\n\t\t\t\t\t\t\ttype: device.type,\n\t\t\t\t\t\t\tdeviceName: device.name || device.phone?.number || device.email?.address,\n\t\t\t\t\t\t\tnickname: device.nickname,\n\t\t\t\t\t\t\tstatus: device.status,\n\t\t\t\t\t\t}));\n\n\t\t\t\t\tconsole.log('[DEVICE-SELECTION] Loaded devices:', activeDevices.length, 'active devices');\n\t\t\t\t\tsetDevices(activeDevices);\n\t\t\t\t} catch (err) {\n\t\t\t\t\tconsole.error('[DEVICE-SELECTION] Error loading devices:', err);\n\t\t\t\t\tsetErrorMsg(err instanceof Error ? err.message : 'Failed to load devices');\n\t\t\t\t} finally {\n\t\t\t\t\tsetIsLoading(false);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tfetchDevices();\n\t\t}\n\t}, [isOpen, username, environmentId]);\n\n\t// Filter devices based on search query\n\tconst filteredDevices = devices.filter(\n\t\t(device) =>\n\t\t\tdevice.deviceName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n\t\t\tdevice.nickname?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n\t\t\tdevice.type.toLowerCase().includes(searchQuery.toLowerCase())\n\t);\n\n\t// Only show active devices for authentication\n\tconst availableDevices = filteredDevices.filter((device) => device.status === 'ACTIVE');\n\n\tconst handleDeviceSelect = (device: Device) => {\n\t\tonDeviceSelect(device);\n\t\tonClose();\n\t};\n\n\tif (!isOpen) return null;\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tposition: 'fixed',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\tdisplay: 'flex',\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tzIndex: 1000,\n\t\t\t}}\n\t\t\tonClick={onClose}\n\t\t\tonKeyDown={(e) => {\n\t\t\t\tif (e.key === 'Escape') {\n\t\t\t\t\tonClose();\n\t\t\t\t}\n\t\t\t}}\n\t\t\trole=\"dialog\"\n\t\t\taria-modal=\"true\"\n\t\t>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'white',\n\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\tboxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',\n\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\twidth: '90%',\n\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t}}\n\t\t\t\tonClick={(e) => e.stopPropagation()}\n\t\t\t>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\tborderBottom: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tmarginBottom: spacing[4],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: 0, fontSize: '20px', fontWeight: '700', color: colors.gray[900] }}>\n\t\t\t\t\t\t\tüîì Select Authentication Device\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'none',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\tcolor: colors.gray[400],\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tpadding: '0',\n\t\t\t\t\t\t\t\tlineHeight: 1,\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t√ó\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style={{ fontSize: '14px', color: colors.gray[600], lineHeight: 1.5 }}>\n\t\t\t\t\t\tChoose which MFA device to authenticate with for <strong>{username}</strong>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Search */}\n\t\t\t\t\t<div style={{ marginTop: spacing[4] }}>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tplaceholder=\"Search devices...\"\n\t\t\t\t\t\t\tvalue={searchQuery}\n\t\t\t\t\t\t\tonChange={(e) => setSearchQuery(e.target.value)}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: spacing[3],\n\t\t\t\t\t\t\t\tborder: `1px solid ${colors.gray[300]}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Content */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\toverflowY: 'auto',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4] }}>‚è≥</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.gray[600] }}>Loading your devices...</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : errorMsg ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4], color: colors.error[500] }}>\n\t\t\t\t\t\t\t\t‚ö†Ô∏è\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.error[600] }}>{errorMsg}</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : availableDevices.length === 0 ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4] }}>üì±</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.gray[600] }}>\n\t\t\t\t\t\t\t\tNo active MFA devices found. Please register a device first.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : (\n\t\t\t\t\t\t<div style={{ display: 'grid', gap: spacing[4] }}>\n\t\t\t\t\t\t\t{availableDevices.map((device) => (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tkey={device.id}\n\t\t\t\t\t\t\t\t\tonClick={() => handleDeviceSelect(device)}\n\t\t\t\t\t\t\t\t\tonKeyDown={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (e.key === 'Enter' || e.key === ' ') {\n\t\t\t\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t\t\t\thandleDeviceSelect(device);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: spacing[4],\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${colors.gray[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: spacing[4],\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = DEVICE_COLORS[device.type];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.backgroundColor = colors.gray[50];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = colors.gray[200];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.backgroundColor = 'white';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\ttabIndex={0}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{/* Device Icon */}\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\t\twidth: '48px',\n\t\t\t\t\t\t\t\t\t\t\theight: '48px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tbackground: `${DEVICE_COLORS[device.type]}15`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{DEVICE_ICONS[device.type]}\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Device Info */}\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[900],\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: spacing[1],\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{device.nickname || device.deviceName || `${device.type} Device`}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'center', gap: spacing[2] }}>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[600],\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: `${DEVICE_COLORS[device.type]}15`,\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 6px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{device.type}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 6px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: STATUS_BADGES[device.status].bg,\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: STATUS_BADGES[device.status].color,\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{STATUS_BADGES[device.status].text}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Arrow */}\n\t\t\t\t\t\t\t\t\t<div style={{ color: colors.gray[400] }}>‚Üí</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\n\t\t\t\t{/* Footer */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\tborderTop: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div style={{ fontSize: '12px', color: colors.gray[500] }}>\n\t\t\t\t\t\t{availableDevices.length} device{availableDevices.length !== 1 ? 's' : ''} available\n\t\t\t\t\t</div>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: `${spacing[2]} ${spacing[4]}`,\n\t\t\t\t\t\t\tbackground: colors.gray[100],\n\t\t\t\t\t\t\tborder: `1px solid ${colors.gray[300]}`,\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcolor: colors.gray[700],\n\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tCancel\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n"},"tags":[],"source":null},{"category":"lint/a11y/useSemanticElements","severity":"error","description":"The elements with this role can be changed to the following elements:\n<button>","message":[{"elements":[],"content":"The elements with this role can be changed to the following elements:\n<button>"}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"For examples and more information, see "},{"elements":[{"Hyperlink":{"href":"https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/Roles"}}],"content":"WAI-ARIA Roles"}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedDeviceSelectionModal.tsx"},"span":[8013,8026],"sourceCode":"/**\n * @file UnifiedDeviceSelectionModal.tsx\n * @module v8/flows/unified/components\n * @description Modern device selection modal for MFA authentication\n * @version 9.2.2\n * @since 2026-01-30\n *\n * Purpose: Allow users to select which MFA device to authenticate with\n * Shows all registered devices with their types and status\n */\n\nimport React, { useEffect, useState } from 'react';\nimport { MFAServiceV8 } from '@/v8/services/mfaServiceV8';\nimport { colors, spacing } from '@/v8/styles/designTokens';\n\ninterface Device {\n\tid: string;\n\ttype: 'SMS' | 'EMAIL' | 'TOTP' | 'VOICE' | 'FIDO2' | 'MOBILE' | 'WHATSAPP';\n\tdeviceName?: string;\n\tnickname?: string;\n\tstatus:\n\t\t| 'ACTIVE'\n\t\t| 'ACTIVATION_REQUIRED'\n\t\t| 'DISABLED'\n\t\t| 'BLOCKED'\n\t\t| 'LOCKED'\n\t\t| 'PENDING'\n\t\t| 'SUSPENDED'\n\t\t| 'EXPIRED';\n}\n\ninterface UnifiedDeviceSelectionModalProps {\n\tisOpen: boolean;\n\tonClose: () => void;\n\tonDeviceSelect: (device: Device) => void;\n\tusername: string;\n\tenvironmentId: string;\n\tloading?: boolean;\n\terror?: string;\n}\n\nconst DEVICE_ICONS = {\n\tSMS: 'üì±',\n\tEMAIL: 'üìß',\n\tTOTP: 'üîê',\n\tVOICE: 'üìû',\n\tFIDO2: 'üîë',\n\tMOBILE: 'üì≤',\n\tWHATSAPP: 'üí¨',\n};\n\nconst DEVICE_COLORS = {\n\tSMS: colors.primary[600],\n\tEMAIL: colors.success[600],\n\tTOTP: colors.purple[600],\n\tVOICE: colors.warning[600],\n\tFIDO2: colors.info[600],\n\tMOBILE: colors.primary[500],\n\tWHATSAPP: colors.success[500],\n};\n\nconst STATUS_BADGES = {\n\tACTIVE: { text: 'Active', color: colors.success[600], bg: colors.success[50] },\n\tACTIVATION_REQUIRED: {\n\t\ttext: 'Activation Required',\n\t\tcolor: colors.warning[600],\n\t\tbg: colors.warning[50],\n\t},\n\tDISABLED: { text: 'Disabled', color: colors.gray[600], bg: colors.gray[50] },\n};\n\nexport const UnifiedDeviceSelectionModal: React.FC<UnifiedDeviceSelectionModalProps> = ({\n\tisOpen,\n\tonClose,\n\tonDeviceSelect,\n\tusername,\n\tenvironmentId,\n\tloading = false,\n\terror = null,\n}) => {\n\tconst [devices, setDevices] = useState<Device[]>([]);\n\tconst [searchQuery, setSearchQuery] = useState('');\n\tconst [isLoading, setIsLoading] = useState(false);\n\tconst [errorMsg, setErrorMsg] = useState<string | null>(null);\n\n\t// Fetch real devices from API\n\tuseEffect(() => {\n\t\tif (isOpen && username && environmentId) {\n\t\t\tconst fetchDevices = async () => {\n\t\t\t\tsetIsLoading(true);\n\t\t\t\tsetErrorMsg(null);\n\t\t\t\ttry {\n\t\t\t\t\tconst allDevices = await MFAServiceV8.getAllDevices({\n\t\t\t\t\t\tenvironmentId,\n\t\t\t\t\t\tusername,\n\t\t\t\t\t});\n\n\t\t\t\t\t// Filter out devices with ACTIVATION_REQUIRED status\n\t\t\t\t\t// Only show ACTIVE devices for authentication\n\t\t\t\t\tconst activeDevices = allDevices\n\t\t\t\t\t\t.filter((device: any) => device.status === 'ACTIVE')\n\t\t\t\t\t\t.map((device: any) => ({\n\t\t\t\t\t\t\tid: device.id,\n\t\t\t\t\t\t\ttype: device.type,\n\t\t\t\t\t\t\tdeviceName: device.name || device.phone?.number || device.email?.address,\n\t\t\t\t\t\t\tnickname: device.nickname,\n\t\t\t\t\t\t\tstatus: device.status,\n\t\t\t\t\t\t}));\n\n\t\t\t\t\tconsole.log('[DEVICE-SELECTION] Loaded devices:', activeDevices.length, 'active devices');\n\t\t\t\t\tsetDevices(activeDevices);\n\t\t\t\t} catch (err) {\n\t\t\t\t\tconsole.error('[DEVICE-SELECTION] Error loading devices:', err);\n\t\t\t\t\tsetErrorMsg(err instanceof Error ? err.message : 'Failed to load devices');\n\t\t\t\t} finally {\n\t\t\t\t\tsetIsLoading(false);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tfetchDevices();\n\t\t}\n\t}, [isOpen, username, environmentId]);\n\n\t// Filter devices based on search query\n\tconst filteredDevices = devices.filter(\n\t\t(device) =>\n\t\t\tdevice.deviceName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n\t\t\tdevice.nickname?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n\t\t\tdevice.type.toLowerCase().includes(searchQuery.toLowerCase())\n\t);\n\n\t// Only show active devices for authentication\n\tconst availableDevices = filteredDevices.filter((device) => device.status === 'ACTIVE');\n\n\tconst handleDeviceSelect = (device: Device) => {\n\t\tonDeviceSelect(device);\n\t\tonClose();\n\t};\n\n\tif (!isOpen) return null;\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tposition: 'fixed',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\tdisplay: 'flex',\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tzIndex: 1000,\n\t\t\t}}\n\t\t\tonClick={onClose}\n\t\t\tonKeyDown={(e) => {\n\t\t\t\tif (e.key === 'Escape') {\n\t\t\t\t\tonClose();\n\t\t\t\t}\n\t\t\t}}\n\t\t\trole=\"dialog\"\n\t\t\taria-modal=\"true\"\n\t\t>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackground: 'white',\n\t\t\t\t\tborderRadius: '16px',\n\t\t\t\t\tboxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',\n\t\t\t\t\tmaxWidth: '600px',\n\t\t\t\t\twidth: '90%',\n\t\t\t\t\tmaxHeight: '80vh',\n\t\t\t\t\toverflow: 'hidden',\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t}}\n\t\t\t\tonClick={(e) => e.stopPropagation()}\n\t\t\t>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\tborderBottom: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tmarginBottom: spacing[4],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<h2 style={{ margin: 0, fontSize: '20px', fontWeight: '700', color: colors.gray[900] }}>\n\t\t\t\t\t\t\tüîì Select Authentication Device\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackground: 'none',\n\t\t\t\t\t\t\t\tborder: 'none',\n\t\t\t\t\t\t\t\tfontSize: '24px',\n\t\t\t\t\t\t\t\tcolor: colors.gray[400],\n\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\tpadding: '0',\n\t\t\t\t\t\t\t\tlineHeight: 1,\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t√ó\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style={{ fontSize: '14px', color: colors.gray[600], lineHeight: 1.5 }}>\n\t\t\t\t\t\tChoose which MFA device to authenticate with for <strong>{username}</strong>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Search */}\n\t\t\t\t\t<div style={{ marginTop: spacing[4] }}>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tplaceholder=\"Search devices...\"\n\t\t\t\t\t\t\tvalue={searchQuery}\n\t\t\t\t\t\t\tonChange={(e) => setSearchQuery(e.target.value)}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\twidth: '100%',\n\t\t\t\t\t\t\t\tpadding: spacing[3],\n\t\t\t\t\t\t\t\tborder: `1px solid ${colors.gray[300]}`,\n\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\t\tboxSizing: 'border-box',\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Content */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\toverflowY: 'auto',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4] }}>‚è≥</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.gray[600] }}>Loading your devices...</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : errorMsg ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4], color: colors.error[500] }}>\n\t\t\t\t\t\t\t\t‚ö†Ô∏è\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.error[600] }}>{errorMsg}</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : availableDevices.length === 0 ? (\n\t\t\t\t\t\t<div style={{ textAlign: 'center', padding: spacing[8] }}>\n\t\t\t\t\t\t\t<div style={{ fontSize: '32px', marginBottom: spacing[4] }}>üì±</div>\n\t\t\t\t\t\t\t<p style={{ color: colors.gray[600] }}>\n\t\t\t\t\t\t\t\tNo active MFA devices found. Please register a device first.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : (\n\t\t\t\t\t\t<div style={{ display: 'grid', gap: spacing[4] }}>\n\t\t\t\t\t\t\t{availableDevices.map((device) => (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tkey={device.id}\n\t\t\t\t\t\t\t\t\tonClick={() => handleDeviceSelect(device)}\n\t\t\t\t\t\t\t\t\tonKeyDown={(e) => {\n\t\t\t\t\t\t\t\t\t\tif (e.key === 'Enter' || e.key === ' ') {\n\t\t\t\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t\t\t\thandleDeviceSelect(device);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: spacing[4],\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${colors.gray[200]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: '12px',\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s ease',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: spacing[4],\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseEnter={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = DEVICE_COLORS[device.type];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.backgroundColor = colors.gray[50];\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonMouseLeave={(e) => {\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.borderColor = colors.gray[200];\n\t\t\t\t\t\t\t\t\t\te.currentTarget.style.backgroundColor = 'white';\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\ttabIndex={0}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{/* Device Icon */}\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tfontSize: '32px',\n\t\t\t\t\t\t\t\t\t\t\twidth: '48px',\n\t\t\t\t\t\t\t\t\t\t\theight: '48px',\n\t\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\t\t\t\t\t\t\tbackground: `${DEVICE_COLORS[device.type]}15`,\n\t\t\t\t\t\t\t\t\t\t\tborderRadius: '8px',\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{DEVICE_ICONS[device.type]}\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Device Info */}\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: '600',\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[900],\n\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: spacing[1],\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{device.nickname || device.deviceName || `${device.type} Device`}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div style={{ display: 'flex', alignItems: 'center', gap: spacing[2] }}>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.gray[600],\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: `${DEVICE_COLORS[device.type]}15`,\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 6px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{device.type}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: '12px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: '2px 6px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: '4px',\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackground: STATUS_BADGES[device.status].bg,\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: STATUS_BADGES[device.status].color,\n\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t{STATUS_BADGES[device.status].text}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t{/* Arrow */}\n\t\t\t\t\t\t\t\t\t<div style={{ color: colors.gray[400] }}>‚Üí</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\n\t\t\t\t{/* Footer */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tpadding: spacing[6],\n\t\t\t\t\t\tborderTop: `1px solid ${colors.gray[200]}`,\n\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\tjustifyContent: 'space-between',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div style={{ fontSize: '12px', color: colors.gray[500] }}>\n\t\t\t\t\t\t{availableDevices.length} device{availableDevices.length !== 1 ? 's' : ''} available\n\t\t\t\t\t</div>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: `${spacing[2]} ${spacing[4]}`,\n\t\t\t\t\t\t\tbackground: colors.gray[100],\n\t\t\t\t\t\t\tborder: `1px solid ${colors.gray[300]}`,\n\t\t\t\t\t\t\tborderRadius: '6px',\n\t\t\t\t\t\t\tcolor: colors.gray[700],\n\t\t\t\t\t\t\tfontSize: '14px',\n\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\tCancel\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n"},"tags":[],"source":null},{"category":"lint/correctness/noInvalidUseBeforeDeclaration","severity":"error","description":"This variable is used before its declaration.","message":[{"elements":[],"content":"This variable is used before its declaration."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"The variable is declared here:"}]]},{"frame":{"path":null,"span":[2108,2119],"sourceCode":"/**\n * @file UnifiedDeviceSelectionStep.modern.tsx\n * @module v8/flows/unified/components\n * @description MODERNIZED Step 1: Device Selection - Modern card-based UI\n * @version 9.2.0\n * @since 2026-01-29\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport { FiArrowRight, FiCheck, FiKey, FiMail, FiPlus, FiSmartphone } from 'react-icons/fi';\nimport { Button } from '@/v8/components/Button';\nimport { EmptyState } from '@/v8/components/EmptyState';\nimport { LoadingSpinner } from '@/v8/components/LoadingSpinner';\nimport { PageTransition } from '@/v8/components/PageTransition';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport { useGlobalMFA } from '@/v8/contexts/GlobalMFAContext';\nimport { borderRadius, colors, spacing, typography } from '@/v8/design/tokens';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { unifiedFlowServiceIntegration } from '@/v8/flows/unified/services/unifiedFlowServiceIntegration';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[üîç DEVICE-SELECTION-MODERN]';\n\ninterface ExistingDevice {\n\tid: string;\n\ttype: string;\n\tname?: string;\n\tstatus: string;\n\tphone?: string;\n\temail?: string;\n\tcreatedAt?: string;\n}\n\nexport interface UnifiedDeviceSelectionStepProps extends MFAFlowBaseRenderProps {\n\tconfig: DeviceFlowConfig;\n\tdeviceType: string;\n}\n\nexport const UnifiedDeviceSelectionStepModern: React.FC<UnifiedDeviceSelectionStepProps> = ({\n\tcredentials,\n\tsetMfaState,\n\tnav,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering for:`, config.deviceType);\n\n\tconst { isConfigured } = useGlobalMFA();\n\tconst [existingDevices, setExistingDevices] = useState<ExistingDevice[]>([]);\n\tconst [selectedDeviceId, setSelectedDeviceId] = useState<string | null>(null);\n\tconst [isLoading, setIsLoading] = useState(false);\n\tconst [loadError, setLoadError] = useState<string | null>(null);\n\n\t// Load existing devices\n\tuseEffect(() => {\n\t\tif (isConfigured && credentials.username) {\n\t\t\tloadDevices();\n\t\t}\n\t}, [isConfigured, credentials.username, loadDevices]);\n\n\tconst loadDevices = async () => {\n\t\tsetIsLoading(true);\n\t\tsetLoadError(null);\n\n\t\ttry {\n\t\t\tconst devices = await unifiedFlowServiceIntegration.listDevices(\n\t\t\t\tcredentials.username,\n\t\t\t\t`type eq \"${config.deviceType}\"`\n\t\t\t);\n\n\t\t\tsetExistingDevices(devices as unknown as ExistingDevice[]);\n\n\t\t\tif (devices.length === 0) {\n\t\t\t\ttoastV8.info(`No existing ${config.displayName} devices found`);\n\t\t\t}\n\t\t} catch (error: unknown) {\n\t\t\tconst errorMsg = error instanceof Error ? error.message : 'Failed to load devices';\n\t\t\tsetLoadError(errorMsg);\n\t\t\ttoastV8.error(errorMsg);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t};\n\n\tconst handleUseDevice = useCallback(() => {\n\t\tif (!selectedDeviceId) {\n\t\t\ttoastV8.warning('Please select a device');\n\t\t\treturn;\n\t\t}\n\n\t\tconst device = existingDevices.find((d) => d.id === selectedDeviceId);\n\t\tif (!device) return;\n\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: device.id,\n\t\t\tdeviceStatus: device.status,\n\t\t}));\n\n\t\tnav.markStepComplete();\n\t\tnav.goToStep(3); // Skip to activation\n\t\ttoastV8.success(`Using ${device.name || config.displayName}`);\n\t}, [selectedDeviceId, existingDevices, config, setMfaState, nav]);\n\n\tconst handleRegisterNew = useCallback(() => {\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: '',\n\t\t\tdeviceStatus: '',\n\t\t}));\n\n\t\tnav.markStepComplete();\n\t\tnav.goToNext();\n\t}, [setMfaState, nav]);\n\n\tconst getDeviceIcon = (type: string) => {\n\t\tswitch (type.toUpperCase()) {\n\t\t\tcase 'SMS':\n\t\t\tcase 'MOBILE':\n\t\t\t\treturn <FiSmartphone size={32} />;\n\t\t\tcase 'EMAIL':\n\t\t\t\treturn <FiMail size={32} />;\n\t\t\tcase 'TOTP':\n\t\t\tcase 'FIDO2':\n\t\t\t\treturn <FiKey size={32} />;\n\t\t\tdefault:\n\t\t\t\treturn <FiSmartphone size={32} />;\n\t\t}\n\t};\n\n\tif (isLoading) {\n\t\treturn (\n\t\t\t<div style={{ padding: spacing['3xl'], textAlign: 'center' }}>\n\t\t\t\t<LoadingSpinner size=\"large\" text=\"Loading devices...\" />\n\t\t\t</div>\n\t\t);\n\t}\n\n\treturn (\n\t\t<PageTransition>\n\t\t\t<div style={{ maxWidth: '900px', margin: '0 auto', padding: spacing.xl }}>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: `linear-gradient(135deg, ${colors.primary[500]} 0%, ${colors.primary[700]} 100%)`,\n\t\t\t\t\t\tborderRadius: borderRadius.xl,\n\t\t\t\t\t\tpadding: spacing.xl,\n\t\t\t\t\t\tmarginBottom: spacing.xl,\n\t\t\t\t\t\tboxShadow: `0 4px 12px ${colors.primary[500]}33`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<h2\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tmargin: `0 0 ${spacing.sm} 0`,\n\t\t\t\t\t\t\tfontSize: typography.fontSize['3xl'],\n\t\t\t\t\t\t\tfontWeight: typography.fontWeight.bold,\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tgap: spacing.md,\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{config.icon} Select {config.displayName} Device\n\t\t\t\t\t</h2>\n\t\t\t\t\t<p style={{ margin: 0, color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\tChoose an existing device or register a new one\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Error State */}\n\t\t\t\t{loadError && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: colors.error[50],\n\t\t\t\t\t\t\tborder: `1px solid ${colors.error[500]}`,\n\t\t\t\t\t\t\tborderRadius: borderRadius.lg,\n\t\t\t\t\t\t\tpadding: spacing.lg,\n\t\t\t\t\t\t\tmarginBottom: spacing.xl,\n\t\t\t\t\t\t\tcolor: colors.error[900],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{loadError}\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tvariant=\"outline\"\n\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\tonClick={loadDevices}\n\t\t\t\t\t\t\tstyle={{ marginLeft: spacing.md }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tRetry\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{/* Existing Devices */}\n\t\t\t\t{existingDevices.length > 0 && (\n\t\t\t\t\t<div style={{ marginBottom: spacing.xl }}>\n\t\t\t\t\t\t<h3 style={{ margin: `0 0 ${spacing.lg} 0`, color: colors.neutral[900] }}>\n\t\t\t\t\t\t\tExisting Devices\n\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t<div style={{ display: 'grid', gap: spacing.md }}>\n\t\t\t\t\t\t\t{existingDevices.map((device) => (\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\tkey={device.id}\n\t\t\t\t\t\t\t\t\tonClick={() => setSelectedDeviceId(device.id)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: spacing.lg,\n\t\t\t\t\t\t\t\t\t\tbackground: selectedDeviceId === device.id ? colors.primary[50] : 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${selectedDeviceId === device.id ? colors.primary[500] : colors.neutral[300]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: borderRadius.lg,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: spacing.lg,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcolor:\n\t\t\t\t\t\t\t\t\t\t\t\tselectedDeviceId === device.id ? colors.primary[500] : colors.neutral[400],\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{getDeviceIcon(device.type)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: typography.fontWeight.semibold,\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.neutral[900],\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{device.name || `${device.type} Device`}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div style={{ fontSize: typography.fontSize.sm, color: colors.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\t\t{device.phone || device.email || device.id}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: typography.fontSize.xs,\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.neutral[400],\n\t\t\t\t\t\t\t\t\t\t\t\tmarginTop: spacing.xs,\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tStatus: {device.status}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t{selectedDeviceId === device.id && (\n\t\t\t\t\t\t\t\t\t\t<FiCheck size={24} color={colors.primary[500]} />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style={{ marginTop: spacing.lg }}>\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t\t\t\tsize=\"lg\"\n\t\t\t\t\t\t\t\tonClick={handleUseDevice}\n\t\t\t\t\t\t\t\tdisabled={!selectedDeviceId}\n\t\t\t\t\t\t\t\trightIcon={<FiArrowRight />}\n\t\t\t\t\t\t\t\tfullWidth\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUse Selected Device\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{/* Empty State */}\n\t\t\t\t{existingDevices.length === 0 && !loadError && (\n\t\t\t\t\t<EmptyState\n\t\t\t\t\t\ticon={getDeviceIcon(config.deviceType)}\n\t\t\t\t\t\ttitle={`No ${config.displayName} Devices`}\n\t\t\t\t\t\tdescription={`You haven't registered any ${config.displayName} devices yet. Register a new device to get started.`}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\n\t\t\t\t{/* Register New Device */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\tborderRadius: borderRadius.xl,\n\t\t\t\t\t\tpadding: spacing.xl,\n\t\t\t\t\t\tborder: `2px dashed ${colors.neutral[300]}`,\n\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<h3 style={{ margin: `0 0 ${spacing.md} 0`, color: colors.neutral[900] }}>\n\t\t\t\t\t\tRegister New Device\n\t\t\t\t\t</h3>\n\t\t\t\t\t<p style={{ margin: `0 0 ${spacing.lg} 0`, color: colors.neutral[600] }}>\n\t\t\t\t\t\tAdd a new {config.displayName} device to your account\n\t\t\t\t\t</p>\n\t\t\t\t\t<Button variant=\"primary\" size=\"lg\" onClick={handleRegisterNew} leftIcon={<FiPlus />}>\n\t\t\t\t\t\tRegister New {config.displayName}\n\t\t\t\t\t</Button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</PageTransition>\n\t);\n};\n\nexport default UnifiedDeviceSelectionStepModern;\n"}}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedDeviceSelectionStep.modern.tsx"},"span":[2085,2096],"sourceCode":"/**\n * @file UnifiedDeviceSelectionStep.modern.tsx\n * @module v8/flows/unified/components\n * @description MODERNIZED Step 1: Device Selection - Modern card-based UI\n * @version 9.2.0\n * @since 2026-01-29\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport { FiArrowRight, FiCheck, FiKey, FiMail, FiPlus, FiSmartphone } from 'react-icons/fi';\nimport { Button } from '@/v8/components/Button';\nimport { EmptyState } from '@/v8/components/EmptyState';\nimport { LoadingSpinner } from '@/v8/components/LoadingSpinner';\nimport { PageTransition } from '@/v8/components/PageTransition';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport { useGlobalMFA } from '@/v8/contexts/GlobalMFAContext';\nimport { borderRadius, colors, spacing, typography } from '@/v8/design/tokens';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { unifiedFlowServiceIntegration } from '@/v8/flows/unified/services/unifiedFlowServiceIntegration';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[üîç DEVICE-SELECTION-MODERN]';\n\ninterface ExistingDevice {\n\tid: string;\n\ttype: string;\n\tname?: string;\n\tstatus: string;\n\tphone?: string;\n\temail?: string;\n\tcreatedAt?: string;\n}\n\nexport interface UnifiedDeviceSelectionStepProps extends MFAFlowBaseRenderProps {\n\tconfig: DeviceFlowConfig;\n\tdeviceType: string;\n}\n\nexport const UnifiedDeviceSelectionStepModern: React.FC<UnifiedDeviceSelectionStepProps> = ({\n\tcredentials,\n\tsetMfaState,\n\tnav,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering for:`, config.deviceType);\n\n\tconst { isConfigured } = useGlobalMFA();\n\tconst [existingDevices, setExistingDevices] = useState<ExistingDevice[]>([]);\n\tconst [selectedDeviceId, setSelectedDeviceId] = useState<string | null>(null);\n\tconst [isLoading, setIsLoading] = useState(false);\n\tconst [loadError, setLoadError] = useState<string | null>(null);\n\n\t// Load existing devices\n\tuseEffect(() => {\n\t\tif (isConfigured && credentials.username) {\n\t\t\tloadDevices();\n\t\t}\n\t}, [isConfigured, credentials.username, loadDevices]);\n\n\tconst loadDevices = async () => {\n\t\tsetIsLoading(true);\n\t\tsetLoadError(null);\n\n\t\ttry {\n\t\t\tconst devices = await unifiedFlowServiceIntegration.listDevices(\n\t\t\t\tcredentials.username,\n\t\t\t\t`type eq \"${config.deviceType}\"`\n\t\t\t);\n\n\t\t\tsetExistingDevices(devices as unknown as ExistingDevice[]);\n\n\t\t\tif (devices.length === 0) {\n\t\t\t\ttoastV8.info(`No existing ${config.displayName} devices found`);\n\t\t\t}\n\t\t} catch (error: unknown) {\n\t\t\tconst errorMsg = error instanceof Error ? error.message : 'Failed to load devices';\n\t\t\tsetLoadError(errorMsg);\n\t\t\ttoastV8.error(errorMsg);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t};\n\n\tconst handleUseDevice = useCallback(() => {\n\t\tif (!selectedDeviceId) {\n\t\t\ttoastV8.warning('Please select a device');\n\t\t\treturn;\n\t\t}\n\n\t\tconst device = existingDevices.find((d) => d.id === selectedDeviceId);\n\t\tif (!device) return;\n\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: device.id,\n\t\t\tdeviceStatus: device.status,\n\t\t}));\n\n\t\tnav.markStepComplete();\n\t\tnav.goToStep(3); // Skip to activation\n\t\ttoastV8.success(`Using ${device.name || config.displayName}`);\n\t}, [selectedDeviceId, existingDevices, config, setMfaState, nav]);\n\n\tconst handleRegisterNew = useCallback(() => {\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: '',\n\t\t\tdeviceStatus: '',\n\t\t}));\n\n\t\tnav.markStepComplete();\n\t\tnav.goToNext();\n\t}, [setMfaState, nav]);\n\n\tconst getDeviceIcon = (type: string) => {\n\t\tswitch (type.toUpperCase()) {\n\t\t\tcase 'SMS':\n\t\t\tcase 'MOBILE':\n\t\t\t\treturn <FiSmartphone size={32} />;\n\t\t\tcase 'EMAIL':\n\t\t\t\treturn <FiMail size={32} />;\n\t\t\tcase 'TOTP':\n\t\t\tcase 'FIDO2':\n\t\t\t\treturn <FiKey size={32} />;\n\t\t\tdefault:\n\t\t\t\treturn <FiSmartphone size={32} />;\n\t\t}\n\t};\n\n\tif (isLoading) {\n\t\treturn (\n\t\t\t<div style={{ padding: spacing['3xl'], textAlign: 'center' }}>\n\t\t\t\t<LoadingSpinner size=\"large\" text=\"Loading devices...\" />\n\t\t\t</div>\n\t\t);\n\t}\n\n\treturn (\n\t\t<PageTransition>\n\t\t\t<div style={{ maxWidth: '900px', margin: '0 auto', padding: spacing.xl }}>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: `linear-gradient(135deg, ${colors.primary[500]} 0%, ${colors.primary[700]} 100%)`,\n\t\t\t\t\t\tborderRadius: borderRadius.xl,\n\t\t\t\t\t\tpadding: spacing.xl,\n\t\t\t\t\t\tmarginBottom: spacing.xl,\n\t\t\t\t\t\tboxShadow: `0 4px 12px ${colors.primary[500]}33`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<h2\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tmargin: `0 0 ${spacing.sm} 0`,\n\t\t\t\t\t\t\tfontSize: typography.fontSize['3xl'],\n\t\t\t\t\t\t\tfontWeight: typography.fontWeight.bold,\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tgap: spacing.md,\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{config.icon} Select {config.displayName} Device\n\t\t\t\t\t</h2>\n\t\t\t\t\t<p style={{ margin: 0, color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\tChoose an existing device or register a new one\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Error State */}\n\t\t\t\t{loadError && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: colors.error[50],\n\t\t\t\t\t\t\tborder: `1px solid ${colors.error[500]}`,\n\t\t\t\t\t\t\tborderRadius: borderRadius.lg,\n\t\t\t\t\t\t\tpadding: spacing.lg,\n\t\t\t\t\t\t\tmarginBottom: spacing.xl,\n\t\t\t\t\t\t\tcolor: colors.error[900],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{loadError}\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tvariant=\"outline\"\n\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\tonClick={loadDevices}\n\t\t\t\t\t\t\tstyle={{ marginLeft: spacing.md }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tRetry\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{/* Existing Devices */}\n\t\t\t\t{existingDevices.length > 0 && (\n\t\t\t\t\t<div style={{ marginBottom: spacing.xl }}>\n\t\t\t\t\t\t<h3 style={{ margin: `0 0 ${spacing.lg} 0`, color: colors.neutral[900] }}>\n\t\t\t\t\t\t\tExisting Devices\n\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t<div style={{ display: 'grid', gap: spacing.md }}>\n\t\t\t\t\t\t\t{existingDevices.map((device) => (\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\tkey={device.id}\n\t\t\t\t\t\t\t\t\tonClick={() => setSelectedDeviceId(device.id)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: spacing.lg,\n\t\t\t\t\t\t\t\t\t\tbackground: selectedDeviceId === device.id ? colors.primary[50] : 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${selectedDeviceId === device.id ? colors.primary[500] : colors.neutral[300]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: borderRadius.lg,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: spacing.lg,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcolor:\n\t\t\t\t\t\t\t\t\t\t\t\tselectedDeviceId === device.id ? colors.primary[500] : colors.neutral[400],\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{getDeviceIcon(device.type)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: typography.fontWeight.semibold,\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.neutral[900],\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{device.name || `${device.type} Device`}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div style={{ fontSize: typography.fontSize.sm, color: colors.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\t\t{device.phone || device.email || device.id}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: typography.fontSize.xs,\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.neutral[400],\n\t\t\t\t\t\t\t\t\t\t\t\tmarginTop: spacing.xs,\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tStatus: {device.status}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t{selectedDeviceId === device.id && (\n\t\t\t\t\t\t\t\t\t\t<FiCheck size={24} color={colors.primary[500]} />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style={{ marginTop: spacing.lg }}>\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t\t\t\tsize=\"lg\"\n\t\t\t\t\t\t\t\tonClick={handleUseDevice}\n\t\t\t\t\t\t\t\tdisabled={!selectedDeviceId}\n\t\t\t\t\t\t\t\trightIcon={<FiArrowRight />}\n\t\t\t\t\t\t\t\tfullWidth\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUse Selected Device\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{/* Empty State */}\n\t\t\t\t{existingDevices.length === 0 && !loadError && (\n\t\t\t\t\t<EmptyState\n\t\t\t\t\t\ticon={getDeviceIcon(config.deviceType)}\n\t\t\t\t\t\ttitle={`No ${config.displayName} Devices`}\n\t\t\t\t\t\tdescription={`You haven't registered any ${config.displayName} devices yet. Register a new device to get started.`}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\n\t\t\t\t{/* Register New Device */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\tborderRadius: borderRadius.xl,\n\t\t\t\t\t\tpadding: spacing.xl,\n\t\t\t\t\t\tborder: `2px dashed ${colors.neutral[300]}`,\n\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<h3 style={{ margin: `0 0 ${spacing.md} 0`, color: colors.neutral[900] }}>\n\t\t\t\t\t\tRegister New Device\n\t\t\t\t\t</h3>\n\t\t\t\t\t<p style={{ margin: `0 0 ${spacing.lg} 0`, color: colors.neutral[600] }}>\n\t\t\t\t\t\tAdd a new {config.displayName} device to your account\n\t\t\t\t\t</p>\n\t\t\t\t\t<Button variant=\"primary\" size=\"lg\" onClick={handleRegisterNew} leftIcon={<FiPlus />}>\n\t\t\t\t\t\tRegister New {config.displayName}\n\t\t\t\t\t</Button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</PageTransition>\n\t);\n};\n\nexport default UnifiedDeviceSelectionStepModern;\n"},"tags":[],"source":null},{"category":"lint/a11y/useButtonType","severity":"error","description":"Provide an explicit type prop for the button element.","message":[{"elements":[],"content":"Provide an explicit "},{"elements":["Emphasis"],"content":"type"},{"elements":[],"content":" prop for the "},{"elements":["Emphasis"],"content":"button"},{"elements":[],"content":" element."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"The default "},{"elements":["Emphasis"],"content":"type"},{"elements":[],"content":" of a button is "},{"elements":["Emphasis"],"content":"submit"},{"elements":[],"content":", which causes the submission of a form when placed inside a `form` element. This is likely not the behaviour that you want inside a React application."}]]},{"log":["info",[{"elements":[],"content":"Allowed button types are: "},{"elements":["Emphasis"],"content":"submit"},{"elements":[],"content":", "},{"elements":["Emphasis"],"content":"button"},{"elements":[],"content":" or "},{"elements":["Emphasis"],"content":"reset"},{"elements":[],"content":""}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedDeviceSelectionStep.modern.tsx"},"span":[5686,6258],"sourceCode":"/**\n * @file UnifiedDeviceSelectionStep.modern.tsx\n * @module v8/flows/unified/components\n * @description MODERNIZED Step 1: Device Selection - Modern card-based UI\n * @version 9.2.0\n * @since 2026-01-29\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport { FiArrowRight, FiCheck, FiKey, FiMail, FiPlus, FiSmartphone } from 'react-icons/fi';\nimport { Button } from '@/v8/components/Button';\nimport { EmptyState } from '@/v8/components/EmptyState';\nimport { LoadingSpinner } from '@/v8/components/LoadingSpinner';\nimport { PageTransition } from '@/v8/components/PageTransition';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport { useGlobalMFA } from '@/v8/contexts/GlobalMFAContext';\nimport { borderRadius, colors, spacing, typography } from '@/v8/design/tokens';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { unifiedFlowServiceIntegration } from '@/v8/flows/unified/services/unifiedFlowServiceIntegration';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[üîç DEVICE-SELECTION-MODERN]';\n\ninterface ExistingDevice {\n\tid: string;\n\ttype: string;\n\tname?: string;\n\tstatus: string;\n\tphone?: string;\n\temail?: string;\n\tcreatedAt?: string;\n}\n\nexport interface UnifiedDeviceSelectionStepProps extends MFAFlowBaseRenderProps {\n\tconfig: DeviceFlowConfig;\n\tdeviceType: string;\n}\n\nexport const UnifiedDeviceSelectionStepModern: React.FC<UnifiedDeviceSelectionStepProps> = ({\n\tcredentials,\n\tsetMfaState,\n\tnav,\n\tconfig,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering for:`, config.deviceType);\n\n\tconst { isConfigured } = useGlobalMFA();\n\tconst [existingDevices, setExistingDevices] = useState<ExistingDevice[]>([]);\n\tconst [selectedDeviceId, setSelectedDeviceId] = useState<string | null>(null);\n\tconst [isLoading, setIsLoading] = useState(false);\n\tconst [loadError, setLoadError] = useState<string | null>(null);\n\n\t// Load existing devices\n\tuseEffect(() => {\n\t\tif (isConfigured && credentials.username) {\n\t\t\tloadDevices();\n\t\t}\n\t}, [isConfigured, credentials.username, loadDevices]);\n\n\tconst loadDevices = async () => {\n\t\tsetIsLoading(true);\n\t\tsetLoadError(null);\n\n\t\ttry {\n\t\t\tconst devices = await unifiedFlowServiceIntegration.listDevices(\n\t\t\t\tcredentials.username,\n\t\t\t\t`type eq \"${config.deviceType}\"`\n\t\t\t);\n\n\t\t\tsetExistingDevices(devices as unknown as ExistingDevice[]);\n\n\t\t\tif (devices.length === 0) {\n\t\t\t\ttoastV8.info(`No existing ${config.displayName} devices found`);\n\t\t\t}\n\t\t} catch (error: unknown) {\n\t\t\tconst errorMsg = error instanceof Error ? error.message : 'Failed to load devices';\n\t\t\tsetLoadError(errorMsg);\n\t\t\ttoastV8.error(errorMsg);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t};\n\n\tconst handleUseDevice = useCallback(() => {\n\t\tif (!selectedDeviceId) {\n\t\t\ttoastV8.warning('Please select a device');\n\t\t\treturn;\n\t\t}\n\n\t\tconst device = existingDevices.find((d) => d.id === selectedDeviceId);\n\t\tif (!device) return;\n\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: device.id,\n\t\t\tdeviceStatus: device.status,\n\t\t}));\n\n\t\tnav.markStepComplete();\n\t\tnav.goToStep(3); // Skip to activation\n\t\ttoastV8.success(`Using ${device.name || config.displayName}`);\n\t}, [selectedDeviceId, existingDevices, config, setMfaState, nav]);\n\n\tconst handleRegisterNew = useCallback(() => {\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: '',\n\t\t\tdeviceStatus: '',\n\t\t}));\n\n\t\tnav.markStepComplete();\n\t\tnav.goToNext();\n\t}, [setMfaState, nav]);\n\n\tconst getDeviceIcon = (type: string) => {\n\t\tswitch (type.toUpperCase()) {\n\t\t\tcase 'SMS':\n\t\t\tcase 'MOBILE':\n\t\t\t\treturn <FiSmartphone size={32} />;\n\t\t\tcase 'EMAIL':\n\t\t\t\treturn <FiMail size={32} />;\n\t\t\tcase 'TOTP':\n\t\t\tcase 'FIDO2':\n\t\t\t\treturn <FiKey size={32} />;\n\t\t\tdefault:\n\t\t\t\treturn <FiSmartphone size={32} />;\n\t\t}\n\t};\n\n\tif (isLoading) {\n\t\treturn (\n\t\t\t<div style={{ padding: spacing['3xl'], textAlign: 'center' }}>\n\t\t\t\t<LoadingSpinner size=\"large\" text=\"Loading devices...\" />\n\t\t\t</div>\n\t\t);\n\t}\n\n\treturn (\n\t\t<PageTransition>\n\t\t\t<div style={{ maxWidth: '900px', margin: '0 auto', padding: spacing.xl }}>\n\t\t\t\t{/* Header */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: `linear-gradient(135deg, ${colors.primary[500]} 0%, ${colors.primary[700]} 100%)`,\n\t\t\t\t\t\tborderRadius: borderRadius.xl,\n\t\t\t\t\t\tpadding: spacing.xl,\n\t\t\t\t\t\tmarginBottom: spacing.xl,\n\t\t\t\t\t\tboxShadow: `0 4px 12px ${colors.primary[500]}33`,\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<h2\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tmargin: `0 0 ${spacing.sm} 0`,\n\t\t\t\t\t\t\tfontSize: typography.fontSize['3xl'],\n\t\t\t\t\t\t\tfontWeight: typography.fontWeight.bold,\n\t\t\t\t\t\t\tcolor: 'white',\n\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\tgap: spacing.md,\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{config.icon} Select {config.displayName} Device\n\t\t\t\t\t</h2>\n\t\t\t\t\t<p style={{ margin: 0, color: 'rgba(255, 255, 255, 0.9)' }}>\n\t\t\t\t\t\tChoose an existing device or register a new one\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Error State */}\n\t\t\t\t{loadError && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tbackground: colors.error[50],\n\t\t\t\t\t\t\tborder: `1px solid ${colors.error[500]}`,\n\t\t\t\t\t\t\tborderRadius: borderRadius.lg,\n\t\t\t\t\t\t\tpadding: spacing.lg,\n\t\t\t\t\t\t\tmarginBottom: spacing.xl,\n\t\t\t\t\t\t\tcolor: colors.error[900],\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{loadError}\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tvariant=\"outline\"\n\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\tonClick={loadDevices}\n\t\t\t\t\t\t\tstyle={{ marginLeft: spacing.md }}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tRetry\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{/* Existing Devices */}\n\t\t\t\t{existingDevices.length > 0 && (\n\t\t\t\t\t<div style={{ marginBottom: spacing.xl }}>\n\t\t\t\t\t\t<h3 style={{ margin: `0 0 ${spacing.lg} 0`, color: colors.neutral[900] }}>\n\t\t\t\t\t\t\tExisting Devices\n\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t<div style={{ display: 'grid', gap: spacing.md }}>\n\t\t\t\t\t\t\t{existingDevices.map((device) => (\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\tkey={device.id}\n\t\t\t\t\t\t\t\t\tonClick={() => setSelectedDeviceId(device.id)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tpadding: spacing.lg,\n\t\t\t\t\t\t\t\t\t\tbackground: selectedDeviceId === device.id ? colors.primary[50] : 'white',\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${selectedDeviceId === device.id ? colors.primary[500] : colors.neutral[300]}`,\n\t\t\t\t\t\t\t\t\t\tborderRadius: borderRadius.lg,\n\t\t\t\t\t\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\t\t\t\t\t\ttransition: 'all 0.2s',\n\t\t\t\t\t\t\t\t\t\ttextAlign: 'left',\n\t\t\t\t\t\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\t\t\t\t\tgap: spacing.lg,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcolor:\n\t\t\t\t\t\t\t\t\t\t\t\tselectedDeviceId === device.id ? colors.primary[500] : colors.neutral[400],\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{getDeviceIcon(device.type)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div style={{ flex: 1 }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: typography.fontWeight.semibold,\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.neutral[900],\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{device.name || `${device.type} Device`}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div style={{ fontSize: typography.fontSize.sm, color: colors.neutral[500] }}>\n\t\t\t\t\t\t\t\t\t\t\t{device.phone || device.email || device.id}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: typography.fontSize.xs,\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: colors.neutral[400],\n\t\t\t\t\t\t\t\t\t\t\t\tmarginTop: spacing.xs,\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\tStatus: {device.status}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t{selectedDeviceId === device.id && (\n\t\t\t\t\t\t\t\t\t\t<FiCheck size={24} color={colors.primary[500]} />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style={{ marginTop: spacing.lg }}>\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t\t\t\tsize=\"lg\"\n\t\t\t\t\t\t\t\tonClick={handleUseDevice}\n\t\t\t\t\t\t\t\tdisabled={!selectedDeviceId}\n\t\t\t\t\t\t\t\trightIcon={<FiArrowRight />}\n\t\t\t\t\t\t\t\tfullWidth\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tUse Selected Device\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{/* Empty State */}\n\t\t\t\t{existingDevices.length === 0 && !loadError && (\n\t\t\t\t\t<EmptyState\n\t\t\t\t\t\ticon={getDeviceIcon(config.deviceType)}\n\t\t\t\t\t\ttitle={`No ${config.displayName} Devices`}\n\t\t\t\t\t\tdescription={`You haven't registered any ${config.displayName} devices yet. Register a new device to get started.`}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\n\t\t\t\t{/* Register New Device */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\tborderRadius: borderRadius.xl,\n\t\t\t\t\t\tpadding: spacing.xl,\n\t\t\t\t\t\tborder: `2px dashed ${colors.neutral[300]}`,\n\t\t\t\t\t\ttextAlign: 'center',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<h3 style={{ margin: `0 0 ${spacing.md} 0`, color: colors.neutral[900] }}>\n\t\t\t\t\t\tRegister New Device\n\t\t\t\t\t</h3>\n\t\t\t\t\t<p style={{ margin: `0 0 ${spacing.lg} 0`, color: colors.neutral[600] }}>\n\t\t\t\t\t\tAdd a new {config.displayName} device to your account\n\t\t\t\t\t</p>\n\t\t\t\t\t<Button variant=\"primary\" size=\"lg\" onClick={handleRegisterNew} leftIcon={<FiPlus />}>\n\t\t\t\t\t\tRegister New {config.displayName}\n\t\t\t\t\t</Button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</PageTransition>\n\t);\n};\n\nexport default UnifiedDeviceSelectionStepModern;\n"},"tags":[],"source":null},{"category":"lint/a11y/useAriaPropsSupportedByRole","severity":"error","description":"The ARIA attribute 'aria-selected' is not supported by this element.","message":[{"elements":[],"content":"The ARIA attribute 'aria-selected' is not supported by this element."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Ensure that ARIA attributes are valid for the role of the element."}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedDeviceSelectionStep.tsx"},"span":[8520,8962],"sourceCode":"/**\n * @file UnifiedDeviceSelectionStep.tsx\n * @module v8/flows/unified/components\n * @description Step 1: Device Selection - Load and select existing devices or register new\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Allow users to select an existing device for authentication or register a new device\n *\n * Flow:\n * 1. Load existing devices from API\n * 2. Display device list (if any)\n * 3. Allow selection of existing device\n * 4. Provide \"Register New Device\" button\n * 5. Navigate to registration or authentication step based on selection\n *\n * @example\n * <UnifiedDeviceSelectionStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n * />\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[üîç UNIFIED-DEVICE-SELECTION-STEP]';\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\ninterface ExistingDevice {\n\tid: string;\n\ttype: string;\n\tname?: string;\n\tstatus: string;\n\tphone?: string;\n\temail?: string;\n\tcreatedAt?: string;\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedDeviceSelectionStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Device Selection Step (Step 1)\n *\n * Loads existing devices and allows user to select one or register a new device.\n */\nexport const UnifiedDeviceSelectionStep: React.FC<UnifiedDeviceSelectionStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering device selection step for:`, config.deviceType);\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [existingDevices, setExistingDevices] = useState<ExistingDevice[]>([]);\n\tconst [selectedDeviceId, setSelectedDeviceId] = useState<string | null>(null);\n\tconst [loadError, setLoadError] = useState<string | null>(null);\n\tconst [hasLoadedDevices, setHasLoadedDevices] = useState(false);\n\n\t// ========================================================================\n\t// EFFECTS\n\t// ========================================================================\n\n\t/**\n\t * Load existing devices on mount\n\t */\n\tuseEffect(() => {\n\t\tif (!hasLoadedDevices && credentials.environmentId && credentials.username) {\n\t\t\tloadExistingDevices();\n\t\t}\n\t}, [hasLoadedDevices, credentials.environmentId, credentials.username, loadExistingDevices]);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Load existing devices for the user\n\t */\n\tconst loadExistingDevices = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Loading existing devices for user:`, credentials.username);\n\n\t\tsetIsLoading(true);\n\t\tsetLoadError(null);\n\n\t\ttry {\n\t\t\t// Call controller to load existing devices\n\t\t\tconst devices = await controller.loadExistingDevices(credentials, mfaState, tokenStatus, nav);\n\n\t\t\tconsole.log(`${MODULE_TAG} Loaded ${devices.length} existing devices:`, devices);\n\n\t\t\tsetExistingDevices(devices);\n\t\t\tsetHasLoadedDevices(true);\n\n\t\t\t// If no devices, show info toast\n\t\t\tif (devices.length === 0) {\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t`No existing ${config.displayName} devices found. Register a new device to continue.`\n\t\t\t\t);\n\t\t\t}\n\t\t} catch (error: unknown) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to load existing devices:`, error);\n\n\t\t\tconst errorMessage =\n\t\t\t\terror instanceof Error ? error.message : 'Failed to load existing devices';\n\t\t\tsetLoadError(errorMessage);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [credentials, mfaState, tokenStatus, config, controller, nav, setIsLoading]);\n\n\t/**\n\t * Handle device selection\n\t */\n\tconst handleSelectDevice = useCallback((deviceId: string) => {\n\t\tconsole.log(`${MODULE_TAG} Device selected:`, deviceId);\n\t\tsetSelectedDeviceId(deviceId);\n\t}, []);\n\n\t/**\n\t * Handle \"Use Selected Device\" button click\n\t */\n\tconst handleUseSelectedDevice = useCallback(() => {\n\t\tif (!selectedDeviceId) {\n\t\t\ttoastV8.warning('Please select a device first');\n\t\t\treturn;\n\t\t}\n\n\t\tconst device = existingDevices.find((d) => d.id === selectedDeviceId);\n\t\tif (!device) {\n\t\t\ttoastV8.error('Selected device not found');\n\t\t\treturn;\n\t\t}\n\n\t\tconsole.log(`${MODULE_TAG} Using existing device:`, device);\n\n\t\t// Update MFA state with selected device\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: device.id,\n\t\t\tdeviceStatus: device.status,\n\t\t\texistingDevice: true,\n\t\t}));\n\n\t\t// Show success toast\n\t\ttoastV8.success(`Using existing ${config.displayName} device`);\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to authentication/activation step\n\t\t// Skip registration since device already exists\n\t\tnav.goToStep(3); // Jump to activation step\n\t}, [selectedDeviceId, existingDevices, config, setMfaState, nav]);\n\n\t/**\n\t * Handle \"Register New Device\" button click\n\t */\n\tconst handleRegisterNewDevice = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} User wants to register a new device`);\n\n\t\t// Clear any previously selected device\n\t\tsetSelectedDeviceId(null);\n\n\t\t// Update MFA state to indicate new registration\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: undefined,\n\t\t\tdeviceStatus: undefined,\n\t\t\texistingDevice: false,\n\t\t}));\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to registration step\n\t\tnav.goToNext();\n\t}, [setMfaState, nav]);\n\n\t/**\n\t * Get device icon based on type\n\t */\n\tconst getDeviceIcon = (deviceType: string): string => {\n\t\tswitch (deviceType.toUpperCase()) {\n\t\t\tcase 'SMS':\n\t\t\t\treturn 'üì±';\n\t\t\tcase 'EMAIL':\n\t\t\t\treturn 'üìß';\n\t\t\tcase 'TOTP':\n\t\t\t\treturn 'üîê';\n\t\t\tcase 'FIDO2':\n\t\t\t\treturn 'üîë';\n\t\t\tcase 'MOBILE':\n\t\t\t\treturn 'üì≤';\n\t\t\tcase 'WHATSAPP':\n\t\t\t\treturn 'üí¨';\n\t\t\tdefault:\n\t\t\t\treturn 'üìü';\n\t\t}\n\t};\n\n\t/**\n\t * Get device display text (name, phone, or email)\n\t */\n\tconst getDeviceDisplayText = (device: ExistingDevice): string => {\n\t\tif (device.name) {\n\t\t\treturn device.name;\n\t\t}\n\t\tif (device.phone) {\n\t\t\treturn device.phone;\n\t\t}\n\t\tif (device.email) {\n\t\t\treturn device.email;\n\t\t}\n\t\treturn `Device ${device.id.substring(0, 8)}`;\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-device-selection-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Select or Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">\n\t\t\t\t\tChoose an existing device or register a new one for multi-factor authentication.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Loading State */}\n\t\t\t{isLoading && !hasLoadedDevices && (\n\t\t\t\t<div className=\"loading-indicator\">\n\t\t\t\t\t<div className=\"spinner\" />\n\t\t\t\t\t<p>Loading existing devices...</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Load Error */}\n\t\t\t{loadError && (\n\t\t\t\t<div className=\"error-card\" role=\"alert\">\n\t\t\t\t\t<h3>Failed to Load Devices</h3>\n\t\t\t\t\t<p>{loadError}</p>\n\t\t\t\t\t<button type=\"button\" onClick={loadExistingDevices} className=\"button-secondary\">\n\t\t\t\t\t\tRetry\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Device List */}\n\t\t\t{hasLoadedDevices && !loadError && (\n\t\t\t\t<div className=\"device-selection-container\">\n\t\t\t\t\t{/* Existing Devices */}\n\t\t\t\t\t{existingDevices.length > 0 && (\n\t\t\t\t\t\t<div className=\"existing-devices-section\">\n\t\t\t\t\t\t\t<h3>Existing Devices</h3>\n\t\t\t\t\t\t\t<p className=\"section-description\">\n\t\t\t\t\t\t\t\tSelect an existing device to use for authentication:\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t<div className=\"device-list\">\n\t\t\t\t\t\t\t\t{existingDevices.map((device) => (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tkey={device.id}\n\t\t\t\t\t\t\t\t\t\tclassName={`device-card ${selectedDeviceId === device.id ? 'selected' : ''}`}\n\t\t\t\t\t\t\t\t\t\tonClick={() => handleSelectDevice(device.id)}\n\t\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\t\ttabIndex={0}\n\t\t\t\t\t\t\t\t\t\tonKeyPress={(e) => {\n\t\t\t\t\t\t\t\t\t\t\tif (e.key === 'Enter' || e.key === ' ') {\n\t\t\t\t\t\t\t\t\t\t\t\thandleSelectDevice(device.id);\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\taria-selected={selectedDeviceId === device.id}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<div className=\"device-icon\">{getDeviceIcon(device.type)}</div>\n\t\t\t\t\t\t\t\t\t\t<div className=\"device-info\">\n\t\t\t\t\t\t\t\t\t\t\t<h4 className=\"device-name\">{getDeviceDisplayText(device)}</h4>\n\t\t\t\t\t\t\t\t\t\t\t<p className=\"device-type\">{device.type}</p>\n\t\t\t\t\t\t\t\t\t\t\t<span className={`device-status status-${device.status.toLowerCase()}`}>\n\t\t\t\t\t\t\t\t\t\t\t\t{device.status}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t{device.createdAt && (\n\t\t\t\t\t\t\t\t\t\t\t\t<p className=\"device-created\">\n\t\t\t\t\t\t\t\t\t\t\t\t\tCreated: {new Date(device.createdAt).toLocaleDateString()}\n\t\t\t\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedDeviceId === device.id && <div className=\"selection-indicator\">‚úì</div>}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t<div className=\"selected-device-actions\">\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleUseSelectedDevice}\n\t\t\t\t\t\t\t\t\tdisabled={!selectedDeviceId || isLoading}\n\t\t\t\t\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tUse Selected Device\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* No Existing Devices */}\n\t\t\t\t\t{existingDevices.length === 0 && (\n\t\t\t\t\t\t<div className=\"no-devices-message\">\n\t\t\t\t\t\t\t<div className=\"info-icon\">‚ÑπÔ∏è</div>\n\t\t\t\t\t\t\t<h3>No Existing Devices</h3>\n\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\tYou don't have any {config.displayName} devices registered yet. Register a new\n\t\t\t\t\t\t\t\tdevice to continue.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* Register New Device Section */}\n\t\t\t\t\t<div className=\"register-new-section\">\n\t\t\t\t\t\t<div className=\"section-divider\">\n\t\t\t\t\t\t\t<span>OR</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<h3>Register New Device</h3>\n\t\t\t\t\t\t<p className=\"section-description\">\n\t\t\t\t\t\t\tSet up a new {config.displayName} device for multi-factor authentication.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleRegisterNewDevice}\n\t\t\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t\t\t\tclassName=\"button-primary register-new-button\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t+ Register New {config.displayName} Device\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Navigation Buttons */}\n\t\t\t<div className=\"step-actions\">\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => nav.goToPrevious()}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t\tclassName=\"button-secondary\"\n\t\t\t\t>\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\t\t\t</div>\n\n\t\t\t{/* Token Status Warning */}\n\t\t\t{!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\nexport default UnifiedDeviceSelectionStep;\n"},"tags":[],"source":null},{"category":"lint/a11y/useSemanticElements","severity":"error","description":"The elements with this role can be changed to the following elements:\n<button>","message":[{"elements":[],"content":"The elements with this role can be changed to the following elements:\n<button>"}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"For examples and more information, see "},{"elements":[{"Hyperlink":{"href":"https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/Roles"}}],"content":"WAI-ARIA Roles"}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedDeviceSelectionStep.tsx"},"span":[8705,8718],"sourceCode":"/**\n * @file UnifiedDeviceSelectionStep.tsx\n * @module v8/flows/unified/components\n * @description Step 1: Device Selection - Load and select existing devices or register new\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Allow users to select an existing device for authentication or register a new device\n *\n * Flow:\n * 1. Load existing devices from API\n * 2. Display device list (if any)\n * 3. Allow selection of existing device\n * 4. Provide \"Register New Device\" button\n * 5. Navigate to registration or authentication step based on selection\n *\n * @example\n * <UnifiedDeviceSelectionStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n * />\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[üîç UNIFIED-DEVICE-SELECTION-STEP]';\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\ninterface ExistingDevice {\n\tid: string;\n\ttype: string;\n\tname?: string;\n\tstatus: string;\n\tphone?: string;\n\temail?: string;\n\tcreatedAt?: string;\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedDeviceSelectionStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Device Selection Step (Step 1)\n *\n * Loads existing devices and allows user to select one or register a new device.\n */\nexport const UnifiedDeviceSelectionStep: React.FC<UnifiedDeviceSelectionStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering device selection step for:`, config.deviceType);\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [existingDevices, setExistingDevices] = useState<ExistingDevice[]>([]);\n\tconst [selectedDeviceId, setSelectedDeviceId] = useState<string | null>(null);\n\tconst [loadError, setLoadError] = useState<string | null>(null);\n\tconst [hasLoadedDevices, setHasLoadedDevices] = useState(false);\n\n\t// ========================================================================\n\t// EFFECTS\n\t// ========================================================================\n\n\t/**\n\t * Load existing devices on mount\n\t */\n\tuseEffect(() => {\n\t\tif (!hasLoadedDevices && credentials.environmentId && credentials.username) {\n\t\t\tloadExistingDevices();\n\t\t}\n\t}, [hasLoadedDevices, credentials.environmentId, credentials.username, loadExistingDevices]);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Load existing devices for the user\n\t */\n\tconst loadExistingDevices = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Loading existing devices for user:`, credentials.username);\n\n\t\tsetIsLoading(true);\n\t\tsetLoadError(null);\n\n\t\ttry {\n\t\t\t// Call controller to load existing devices\n\t\t\tconst devices = await controller.loadExistingDevices(credentials, mfaState, tokenStatus, nav);\n\n\t\t\tconsole.log(`${MODULE_TAG} Loaded ${devices.length} existing devices:`, devices);\n\n\t\t\tsetExistingDevices(devices);\n\t\t\tsetHasLoadedDevices(true);\n\n\t\t\t// If no devices, show info toast\n\t\t\tif (devices.length === 0) {\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t`No existing ${config.displayName} devices found. Register a new device to continue.`\n\t\t\t\t);\n\t\t\t}\n\t\t} catch (error: unknown) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to load existing devices:`, error);\n\n\t\t\tconst errorMessage =\n\t\t\t\terror instanceof Error ? error.message : 'Failed to load existing devices';\n\t\t\tsetLoadError(errorMessage);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [credentials, mfaState, tokenStatus, config, controller, nav, setIsLoading]);\n\n\t/**\n\t * Handle device selection\n\t */\n\tconst handleSelectDevice = useCallback((deviceId: string) => {\n\t\tconsole.log(`${MODULE_TAG} Device selected:`, deviceId);\n\t\tsetSelectedDeviceId(deviceId);\n\t}, []);\n\n\t/**\n\t * Handle \"Use Selected Device\" button click\n\t */\n\tconst handleUseSelectedDevice = useCallback(() => {\n\t\tif (!selectedDeviceId) {\n\t\t\ttoastV8.warning('Please select a device first');\n\t\t\treturn;\n\t\t}\n\n\t\tconst device = existingDevices.find((d) => d.id === selectedDeviceId);\n\t\tif (!device) {\n\t\t\ttoastV8.error('Selected device not found');\n\t\t\treturn;\n\t\t}\n\n\t\tconsole.log(`${MODULE_TAG} Using existing device:`, device);\n\n\t\t// Update MFA state with selected device\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: device.id,\n\t\t\tdeviceStatus: device.status,\n\t\t\texistingDevice: true,\n\t\t}));\n\n\t\t// Show success toast\n\t\ttoastV8.success(`Using existing ${config.displayName} device`);\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to authentication/activation step\n\t\t// Skip registration since device already exists\n\t\tnav.goToStep(3); // Jump to activation step\n\t}, [selectedDeviceId, existingDevices, config, setMfaState, nav]);\n\n\t/**\n\t * Handle \"Register New Device\" button click\n\t */\n\tconst handleRegisterNewDevice = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} User wants to register a new device`);\n\n\t\t// Clear any previously selected device\n\t\tsetSelectedDeviceId(null);\n\n\t\t// Update MFA state to indicate new registration\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: undefined,\n\t\t\tdeviceStatus: undefined,\n\t\t\texistingDevice: false,\n\t\t}));\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to registration step\n\t\tnav.goToNext();\n\t}, [setMfaState, nav]);\n\n\t/**\n\t * Get device icon based on type\n\t */\n\tconst getDeviceIcon = (deviceType: string): string => {\n\t\tswitch (deviceType.toUpperCase()) {\n\t\t\tcase 'SMS':\n\t\t\t\treturn 'üì±';\n\t\t\tcase 'EMAIL':\n\t\t\t\treturn 'üìß';\n\t\t\tcase 'TOTP':\n\t\t\t\treturn 'üîê';\n\t\t\tcase 'FIDO2':\n\t\t\t\treturn 'üîë';\n\t\t\tcase 'MOBILE':\n\t\t\t\treturn 'üì≤';\n\t\t\tcase 'WHATSAPP':\n\t\t\t\treturn 'üí¨';\n\t\t\tdefault:\n\t\t\t\treturn 'üìü';\n\t\t}\n\t};\n\n\t/**\n\t * Get device display text (name, phone, or email)\n\t */\n\tconst getDeviceDisplayText = (device: ExistingDevice): string => {\n\t\tif (device.name) {\n\t\t\treturn device.name;\n\t\t}\n\t\tif (device.phone) {\n\t\t\treturn device.phone;\n\t\t}\n\t\tif (device.email) {\n\t\t\treturn device.email;\n\t\t}\n\t\treturn `Device ${device.id.substring(0, 8)}`;\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-device-selection-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Select or Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">\n\t\t\t\t\tChoose an existing device or register a new one for multi-factor authentication.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Loading State */}\n\t\t\t{isLoading && !hasLoadedDevices && (\n\t\t\t\t<div className=\"loading-indicator\">\n\t\t\t\t\t<div className=\"spinner\" />\n\t\t\t\t\t<p>Loading existing devices...</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Load Error */}\n\t\t\t{loadError && (\n\t\t\t\t<div className=\"error-card\" role=\"alert\">\n\t\t\t\t\t<h3>Failed to Load Devices</h3>\n\t\t\t\t\t<p>{loadError}</p>\n\t\t\t\t\t<button type=\"button\" onClick={loadExistingDevices} className=\"button-secondary\">\n\t\t\t\t\t\tRetry\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Device List */}\n\t\t\t{hasLoadedDevices && !loadError && (\n\t\t\t\t<div className=\"device-selection-container\">\n\t\t\t\t\t{/* Existing Devices */}\n\t\t\t\t\t{existingDevices.length > 0 && (\n\t\t\t\t\t\t<div className=\"existing-devices-section\">\n\t\t\t\t\t\t\t<h3>Existing Devices</h3>\n\t\t\t\t\t\t\t<p className=\"section-description\">\n\t\t\t\t\t\t\t\tSelect an existing device to use for authentication:\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t<div className=\"device-list\">\n\t\t\t\t\t\t\t\t{existingDevices.map((device) => (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tkey={device.id}\n\t\t\t\t\t\t\t\t\t\tclassName={`device-card ${selectedDeviceId === device.id ? 'selected' : ''}`}\n\t\t\t\t\t\t\t\t\t\tonClick={() => handleSelectDevice(device.id)}\n\t\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\t\ttabIndex={0}\n\t\t\t\t\t\t\t\t\t\tonKeyPress={(e) => {\n\t\t\t\t\t\t\t\t\t\t\tif (e.key === 'Enter' || e.key === ' ') {\n\t\t\t\t\t\t\t\t\t\t\t\thandleSelectDevice(device.id);\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\taria-selected={selectedDeviceId === device.id}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<div className=\"device-icon\">{getDeviceIcon(device.type)}</div>\n\t\t\t\t\t\t\t\t\t\t<div className=\"device-info\">\n\t\t\t\t\t\t\t\t\t\t\t<h4 className=\"device-name\">{getDeviceDisplayText(device)}</h4>\n\t\t\t\t\t\t\t\t\t\t\t<p className=\"device-type\">{device.type}</p>\n\t\t\t\t\t\t\t\t\t\t\t<span className={`device-status status-${device.status.toLowerCase()}`}>\n\t\t\t\t\t\t\t\t\t\t\t\t{device.status}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t{device.createdAt && (\n\t\t\t\t\t\t\t\t\t\t\t\t<p className=\"device-created\">\n\t\t\t\t\t\t\t\t\t\t\t\t\tCreated: {new Date(device.createdAt).toLocaleDateString()}\n\t\t\t\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedDeviceId === device.id && <div className=\"selection-indicator\">‚úì</div>}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t<div className=\"selected-device-actions\">\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleUseSelectedDevice}\n\t\t\t\t\t\t\t\t\tdisabled={!selectedDeviceId || isLoading}\n\t\t\t\t\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tUse Selected Device\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* No Existing Devices */}\n\t\t\t\t\t{existingDevices.length === 0 && (\n\t\t\t\t\t\t<div className=\"no-devices-message\">\n\t\t\t\t\t\t\t<div className=\"info-icon\">‚ÑπÔ∏è</div>\n\t\t\t\t\t\t\t<h3>No Existing Devices</h3>\n\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\tYou don't have any {config.displayName} devices registered yet. Register a new\n\t\t\t\t\t\t\t\tdevice to continue.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* Register New Device Section */}\n\t\t\t\t\t<div className=\"register-new-section\">\n\t\t\t\t\t\t<div className=\"section-divider\">\n\t\t\t\t\t\t\t<span>OR</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<h3>Register New Device</h3>\n\t\t\t\t\t\t<p className=\"section-description\">\n\t\t\t\t\t\t\tSet up a new {config.displayName} device for multi-factor authentication.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleRegisterNewDevice}\n\t\t\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t\t\t\tclassName=\"button-primary register-new-button\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t+ Register New {config.displayName} Device\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Navigation Buttons */}\n\t\t\t<div className=\"step-actions\">\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => nav.goToPrevious()}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t\tclassName=\"button-secondary\"\n\t\t\t\t>\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\t\t\t</div>\n\n\t\t\t{/* Token Status Warning */}\n\t\t\t{!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\nexport default UnifiedDeviceSelectionStep;\n"},"tags":[],"source":null},{"category":"lint/correctness/noInvalidUseBeforeDeclaration","severity":"error","description":"This variable is used before its declaration.","message":[{"elements":[],"content":"This variable is used before its declaration."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"The variable is declared here:"}]]},{"frame":{"path":null,"span":[3554,3573],"sourceCode":"/**\n * @file UnifiedDeviceSelectionStep.tsx\n * @module v8/flows/unified/components\n * @description Step 1: Device Selection - Load and select existing devices or register new\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Allow users to select an existing device for authentication or register a new device\n *\n * Flow:\n * 1. Load existing devices from API\n * 2. Display device list (if any)\n * 3. Allow selection of existing device\n * 4. Provide \"Register New Device\" button\n * 5. Navigate to registration or authentication step based on selection\n *\n * @example\n * <UnifiedDeviceSelectionStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n * />\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[üîç UNIFIED-DEVICE-SELECTION-STEP]';\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\ninterface ExistingDevice {\n\tid: string;\n\ttype: string;\n\tname?: string;\n\tstatus: string;\n\tphone?: string;\n\temail?: string;\n\tcreatedAt?: string;\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedDeviceSelectionStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Device Selection Step (Step 1)\n *\n * Loads existing devices and allows user to select one or register a new device.\n */\nexport const UnifiedDeviceSelectionStep: React.FC<UnifiedDeviceSelectionStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering device selection step for:`, config.deviceType);\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [existingDevices, setExistingDevices] = useState<ExistingDevice[]>([]);\n\tconst [selectedDeviceId, setSelectedDeviceId] = useState<string | null>(null);\n\tconst [loadError, setLoadError] = useState<string | null>(null);\n\tconst [hasLoadedDevices, setHasLoadedDevices] = useState(false);\n\n\t// ========================================================================\n\t// EFFECTS\n\t// ========================================================================\n\n\t/**\n\t * Load existing devices on mount\n\t */\n\tuseEffect(() => {\n\t\tif (!hasLoadedDevices && credentials.environmentId && credentials.username) {\n\t\t\tloadExistingDevices();\n\t\t}\n\t}, [hasLoadedDevices, credentials.environmentId, credentials.username, loadExistingDevices]);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Load existing devices for the user\n\t */\n\tconst loadExistingDevices = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Loading existing devices for user:`, credentials.username);\n\n\t\tsetIsLoading(true);\n\t\tsetLoadError(null);\n\n\t\ttry {\n\t\t\t// Call controller to load existing devices\n\t\t\tconst devices = await controller.loadExistingDevices(credentials, mfaState, tokenStatus, nav);\n\n\t\t\tconsole.log(`${MODULE_TAG} Loaded ${devices.length} existing devices:`, devices);\n\n\t\t\tsetExistingDevices(devices);\n\t\t\tsetHasLoadedDevices(true);\n\n\t\t\t// If no devices, show info toast\n\t\t\tif (devices.length === 0) {\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t`No existing ${config.displayName} devices found. Register a new device to continue.`\n\t\t\t\t);\n\t\t\t}\n\t\t} catch (error: unknown) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to load existing devices:`, error);\n\n\t\t\tconst errorMessage =\n\t\t\t\terror instanceof Error ? error.message : 'Failed to load existing devices';\n\t\t\tsetLoadError(errorMessage);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [credentials, mfaState, tokenStatus, config, controller, nav, setIsLoading]);\n\n\t/**\n\t * Handle device selection\n\t */\n\tconst handleSelectDevice = useCallback((deviceId: string) => {\n\t\tconsole.log(`${MODULE_TAG} Device selected:`, deviceId);\n\t\tsetSelectedDeviceId(deviceId);\n\t}, []);\n\n\t/**\n\t * Handle \"Use Selected Device\" button click\n\t */\n\tconst handleUseSelectedDevice = useCallback(() => {\n\t\tif (!selectedDeviceId) {\n\t\t\ttoastV8.warning('Please select a device first');\n\t\t\treturn;\n\t\t}\n\n\t\tconst device = existingDevices.find((d) => d.id === selectedDeviceId);\n\t\tif (!device) {\n\t\t\ttoastV8.error('Selected device not found');\n\t\t\treturn;\n\t\t}\n\n\t\tconsole.log(`${MODULE_TAG} Using existing device:`, device);\n\n\t\t// Update MFA state with selected device\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: device.id,\n\t\t\tdeviceStatus: device.status,\n\t\t\texistingDevice: true,\n\t\t}));\n\n\t\t// Show success toast\n\t\ttoastV8.success(`Using existing ${config.displayName} device`);\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to authentication/activation step\n\t\t// Skip registration since device already exists\n\t\tnav.goToStep(3); // Jump to activation step\n\t}, [selectedDeviceId, existingDevices, config, setMfaState, nav]);\n\n\t/**\n\t * Handle \"Register New Device\" button click\n\t */\n\tconst handleRegisterNewDevice = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} User wants to register a new device`);\n\n\t\t// Clear any previously selected device\n\t\tsetSelectedDeviceId(null);\n\n\t\t// Update MFA state to indicate new registration\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: undefined,\n\t\t\tdeviceStatus: undefined,\n\t\t\texistingDevice: false,\n\t\t}));\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to registration step\n\t\tnav.goToNext();\n\t}, [setMfaState, nav]);\n\n\t/**\n\t * Get device icon based on type\n\t */\n\tconst getDeviceIcon = (deviceType: string): string => {\n\t\tswitch (deviceType.toUpperCase()) {\n\t\t\tcase 'SMS':\n\t\t\t\treturn 'üì±';\n\t\t\tcase 'EMAIL':\n\t\t\t\treturn 'üìß';\n\t\t\tcase 'TOTP':\n\t\t\t\treturn 'üîê';\n\t\t\tcase 'FIDO2':\n\t\t\t\treturn 'üîë';\n\t\t\tcase 'MOBILE':\n\t\t\t\treturn 'üì≤';\n\t\t\tcase 'WHATSAPP':\n\t\t\t\treturn 'üí¨';\n\t\t\tdefault:\n\t\t\t\treturn 'üìü';\n\t\t}\n\t};\n\n\t/**\n\t * Get device display text (name, phone, or email)\n\t */\n\tconst getDeviceDisplayText = (device: ExistingDevice): string => {\n\t\tif (device.name) {\n\t\t\treturn device.name;\n\t\t}\n\t\tif (device.phone) {\n\t\t\treturn device.phone;\n\t\t}\n\t\tif (device.email) {\n\t\t\treturn device.email;\n\t\t}\n\t\treturn `Device ${device.id.substring(0, 8)}`;\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-device-selection-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Select or Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">\n\t\t\t\t\tChoose an existing device or register a new one for multi-factor authentication.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Loading State */}\n\t\t\t{isLoading && !hasLoadedDevices && (\n\t\t\t\t<div className=\"loading-indicator\">\n\t\t\t\t\t<div className=\"spinner\" />\n\t\t\t\t\t<p>Loading existing devices...</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Load Error */}\n\t\t\t{loadError && (\n\t\t\t\t<div className=\"error-card\" role=\"alert\">\n\t\t\t\t\t<h3>Failed to Load Devices</h3>\n\t\t\t\t\t<p>{loadError}</p>\n\t\t\t\t\t<button type=\"button\" onClick={loadExistingDevices} className=\"button-secondary\">\n\t\t\t\t\t\tRetry\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Device List */}\n\t\t\t{hasLoadedDevices && !loadError && (\n\t\t\t\t<div className=\"device-selection-container\">\n\t\t\t\t\t{/* Existing Devices */}\n\t\t\t\t\t{existingDevices.length > 0 && (\n\t\t\t\t\t\t<div className=\"existing-devices-section\">\n\t\t\t\t\t\t\t<h3>Existing Devices</h3>\n\t\t\t\t\t\t\t<p className=\"section-description\">\n\t\t\t\t\t\t\t\tSelect an existing device to use for authentication:\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t<div className=\"device-list\">\n\t\t\t\t\t\t\t\t{existingDevices.map((device) => (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tkey={device.id}\n\t\t\t\t\t\t\t\t\t\tclassName={`device-card ${selectedDeviceId === device.id ? 'selected' : ''}`}\n\t\t\t\t\t\t\t\t\t\tonClick={() => handleSelectDevice(device.id)}\n\t\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\t\ttabIndex={0}\n\t\t\t\t\t\t\t\t\t\tonKeyPress={(e) => {\n\t\t\t\t\t\t\t\t\t\t\tif (e.key === 'Enter' || e.key === ' ') {\n\t\t\t\t\t\t\t\t\t\t\t\thandleSelectDevice(device.id);\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\taria-selected={selectedDeviceId === device.id}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<div className=\"device-icon\">{getDeviceIcon(device.type)}</div>\n\t\t\t\t\t\t\t\t\t\t<div className=\"device-info\">\n\t\t\t\t\t\t\t\t\t\t\t<h4 className=\"device-name\">{getDeviceDisplayText(device)}</h4>\n\t\t\t\t\t\t\t\t\t\t\t<p className=\"device-type\">{device.type}</p>\n\t\t\t\t\t\t\t\t\t\t\t<span className={`device-status status-${device.status.toLowerCase()}`}>\n\t\t\t\t\t\t\t\t\t\t\t\t{device.status}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t{device.createdAt && (\n\t\t\t\t\t\t\t\t\t\t\t\t<p className=\"device-created\">\n\t\t\t\t\t\t\t\t\t\t\t\t\tCreated: {new Date(device.createdAt).toLocaleDateString()}\n\t\t\t\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedDeviceId === device.id && <div className=\"selection-indicator\">‚úì</div>}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t<div className=\"selected-device-actions\">\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleUseSelectedDevice}\n\t\t\t\t\t\t\t\t\tdisabled={!selectedDeviceId || isLoading}\n\t\t\t\t\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tUse Selected Device\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* No Existing Devices */}\n\t\t\t\t\t{existingDevices.length === 0 && (\n\t\t\t\t\t\t<div className=\"no-devices-message\">\n\t\t\t\t\t\t\t<div className=\"info-icon\">‚ÑπÔ∏è</div>\n\t\t\t\t\t\t\t<h3>No Existing Devices</h3>\n\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\tYou don't have any {config.displayName} devices registered yet. Register a new\n\t\t\t\t\t\t\t\tdevice to continue.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* Register New Device Section */}\n\t\t\t\t\t<div className=\"register-new-section\">\n\t\t\t\t\t\t<div className=\"section-divider\">\n\t\t\t\t\t\t\t<span>OR</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<h3>Register New Device</h3>\n\t\t\t\t\t\t<p className=\"section-description\">\n\t\t\t\t\t\t\tSet up a new {config.displayName} device for multi-factor authentication.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleRegisterNewDevice}\n\t\t\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t\t\t\tclassName=\"button-primary register-new-button\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t+ Register New {config.displayName} Device\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Navigation Buttons */}\n\t\t\t<div className=\"step-actions\">\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => nav.goToPrevious()}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t\tclassName=\"button-secondary\"\n\t\t\t\t>\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\t\t\t</div>\n\n\t\t\t{/* Token Status Warning */}\n\t\t\t{!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\nexport default UnifiedDeviceSelectionStep;\n"}}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedDeviceSelectionStep.tsx"},"span":[3306,3325],"sourceCode":"/**\n * @file UnifiedDeviceSelectionStep.tsx\n * @module v8/flows/unified/components\n * @description Step 1: Device Selection - Load and select existing devices or register new\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Allow users to select an existing device for authentication or register a new device\n *\n * Flow:\n * 1. Load existing devices from API\n * 2. Display device list (if any)\n * 3. Allow selection of existing device\n * 4. Provide \"Register New Device\" button\n * 5. Navigate to registration or authentication step based on selection\n *\n * @example\n * <UnifiedDeviceSelectionStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n * />\n */\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[üîç UNIFIED-DEVICE-SELECTION-STEP]';\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\ninterface ExistingDevice {\n\tid: string;\n\ttype: string;\n\tname?: string;\n\tstatus: string;\n\tphone?: string;\n\temail?: string;\n\tcreatedAt?: string;\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedDeviceSelectionStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Device Selection Step (Step 1)\n *\n * Loads existing devices and allows user to select one or register a new device.\n */\nexport const UnifiedDeviceSelectionStep: React.FC<UnifiedDeviceSelectionStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering device selection step for:`, config.deviceType);\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [existingDevices, setExistingDevices] = useState<ExistingDevice[]>([]);\n\tconst [selectedDeviceId, setSelectedDeviceId] = useState<string | null>(null);\n\tconst [loadError, setLoadError] = useState<string | null>(null);\n\tconst [hasLoadedDevices, setHasLoadedDevices] = useState(false);\n\n\t// ========================================================================\n\t// EFFECTS\n\t// ========================================================================\n\n\t/**\n\t * Load existing devices on mount\n\t */\n\tuseEffect(() => {\n\t\tif (!hasLoadedDevices && credentials.environmentId && credentials.username) {\n\t\t\tloadExistingDevices();\n\t\t}\n\t}, [hasLoadedDevices, credentials.environmentId, credentials.username, loadExistingDevices]);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Load existing devices for the user\n\t */\n\tconst loadExistingDevices = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Loading existing devices for user:`, credentials.username);\n\n\t\tsetIsLoading(true);\n\t\tsetLoadError(null);\n\n\t\ttry {\n\t\t\t// Call controller to load existing devices\n\t\t\tconst devices = await controller.loadExistingDevices(credentials, mfaState, tokenStatus, nav);\n\n\t\t\tconsole.log(`${MODULE_TAG} Loaded ${devices.length} existing devices:`, devices);\n\n\t\t\tsetExistingDevices(devices);\n\t\t\tsetHasLoadedDevices(true);\n\n\t\t\t// If no devices, show info toast\n\t\t\tif (devices.length === 0) {\n\t\t\t\ttoastV8.info(\n\t\t\t\t\t`No existing ${config.displayName} devices found. Register a new device to continue.`\n\t\t\t\t);\n\t\t\t}\n\t\t} catch (error: unknown) {\n\t\t\tconsole.error(`${MODULE_TAG} Failed to load existing devices:`, error);\n\n\t\t\tconst errorMessage =\n\t\t\t\terror instanceof Error ? error.message : 'Failed to load existing devices';\n\t\t\tsetLoadError(errorMessage);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [credentials, mfaState, tokenStatus, config, controller, nav, setIsLoading]);\n\n\t/**\n\t * Handle device selection\n\t */\n\tconst handleSelectDevice = useCallback((deviceId: string) => {\n\t\tconsole.log(`${MODULE_TAG} Device selected:`, deviceId);\n\t\tsetSelectedDeviceId(deviceId);\n\t}, []);\n\n\t/**\n\t * Handle \"Use Selected Device\" button click\n\t */\n\tconst handleUseSelectedDevice = useCallback(() => {\n\t\tif (!selectedDeviceId) {\n\t\t\ttoastV8.warning('Please select a device first');\n\t\t\treturn;\n\t\t}\n\n\t\tconst device = existingDevices.find((d) => d.id === selectedDeviceId);\n\t\tif (!device) {\n\t\t\ttoastV8.error('Selected device not found');\n\t\t\treturn;\n\t\t}\n\n\t\tconsole.log(`${MODULE_TAG} Using existing device:`, device);\n\n\t\t// Update MFA state with selected device\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: device.id,\n\t\t\tdeviceStatus: device.status,\n\t\t\texistingDevice: true,\n\t\t}));\n\n\t\t// Show success toast\n\t\ttoastV8.success(`Using existing ${config.displayName} device`);\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to authentication/activation step\n\t\t// Skip registration since device already exists\n\t\tnav.goToStep(3); // Jump to activation step\n\t}, [selectedDeviceId, existingDevices, config, setMfaState, nav]);\n\n\t/**\n\t * Handle \"Register New Device\" button click\n\t */\n\tconst handleRegisterNewDevice = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} User wants to register a new device`);\n\n\t\t// Clear any previously selected device\n\t\tsetSelectedDeviceId(null);\n\n\t\t// Update MFA state to indicate new registration\n\t\tsetMfaState((prev) => ({\n\t\t\t...prev,\n\t\t\tdeviceId: undefined,\n\t\t\tdeviceStatus: undefined,\n\t\t\texistingDevice: false,\n\t\t}));\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Navigate to registration step\n\t\tnav.goToNext();\n\t}, [setMfaState, nav]);\n\n\t/**\n\t * Get device icon based on type\n\t */\n\tconst getDeviceIcon = (deviceType: string): string => {\n\t\tswitch (deviceType.toUpperCase()) {\n\t\t\tcase 'SMS':\n\t\t\t\treturn 'üì±';\n\t\t\tcase 'EMAIL':\n\t\t\t\treturn 'üìß';\n\t\t\tcase 'TOTP':\n\t\t\t\treturn 'üîê';\n\t\t\tcase 'FIDO2':\n\t\t\t\treturn 'üîë';\n\t\t\tcase 'MOBILE':\n\t\t\t\treturn 'üì≤';\n\t\t\tcase 'WHATSAPP':\n\t\t\t\treturn 'üí¨';\n\t\t\tdefault:\n\t\t\t\treturn 'üìü';\n\t\t}\n\t};\n\n\t/**\n\t * Get device display text (name, phone, or email)\n\t */\n\tconst getDeviceDisplayText = (device: ExistingDevice): string => {\n\t\tif (device.name) {\n\t\t\treturn device.name;\n\t\t}\n\t\tif (device.phone) {\n\t\t\treturn device.phone;\n\t\t}\n\t\tif (device.email) {\n\t\t\treturn device.email;\n\t\t}\n\t\treturn `Device ${device.id.substring(0, 8)}`;\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-device-selection-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Select or Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">\n\t\t\t\t\tChoose an existing device or register a new one for multi-factor authentication.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Loading State */}\n\t\t\t{isLoading && !hasLoadedDevices && (\n\t\t\t\t<div className=\"loading-indicator\">\n\t\t\t\t\t<div className=\"spinner\" />\n\t\t\t\t\t<p>Loading existing devices...</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Load Error */}\n\t\t\t{loadError && (\n\t\t\t\t<div className=\"error-card\" role=\"alert\">\n\t\t\t\t\t<h3>Failed to Load Devices</h3>\n\t\t\t\t\t<p>{loadError}</p>\n\t\t\t\t\t<button type=\"button\" onClick={loadExistingDevices} className=\"button-secondary\">\n\t\t\t\t\t\tRetry\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Device List */}\n\t\t\t{hasLoadedDevices && !loadError && (\n\t\t\t\t<div className=\"device-selection-container\">\n\t\t\t\t\t{/* Existing Devices */}\n\t\t\t\t\t{existingDevices.length > 0 && (\n\t\t\t\t\t\t<div className=\"existing-devices-section\">\n\t\t\t\t\t\t\t<h3>Existing Devices</h3>\n\t\t\t\t\t\t\t<p className=\"section-description\">\n\t\t\t\t\t\t\t\tSelect an existing device to use for authentication:\n\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t<div className=\"device-list\">\n\t\t\t\t\t\t\t\t{existingDevices.map((device) => (\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tkey={device.id}\n\t\t\t\t\t\t\t\t\t\tclassName={`device-card ${selectedDeviceId === device.id ? 'selected' : ''}`}\n\t\t\t\t\t\t\t\t\t\tonClick={() => handleSelectDevice(device.id)}\n\t\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\t\ttabIndex={0}\n\t\t\t\t\t\t\t\t\t\tonKeyPress={(e) => {\n\t\t\t\t\t\t\t\t\t\t\tif (e.key === 'Enter' || e.key === ' ') {\n\t\t\t\t\t\t\t\t\t\t\t\thandleSelectDevice(device.id);\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\taria-selected={selectedDeviceId === device.id}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<div className=\"device-icon\">{getDeviceIcon(device.type)}</div>\n\t\t\t\t\t\t\t\t\t\t<div className=\"device-info\">\n\t\t\t\t\t\t\t\t\t\t\t<h4 className=\"device-name\">{getDeviceDisplayText(device)}</h4>\n\t\t\t\t\t\t\t\t\t\t\t<p className=\"device-type\">{device.type}</p>\n\t\t\t\t\t\t\t\t\t\t\t<span className={`device-status status-${device.status.toLowerCase()}`}>\n\t\t\t\t\t\t\t\t\t\t\t\t{device.status}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t{device.createdAt && (\n\t\t\t\t\t\t\t\t\t\t\t\t<p className=\"device-created\">\n\t\t\t\t\t\t\t\t\t\t\t\t\tCreated: {new Date(device.createdAt).toLocaleDateString()}\n\t\t\t\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{selectedDeviceId === device.id && <div className=\"selection-indicator\">‚úì</div>}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t<div className=\"selected-device-actions\">\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\tonClick={handleUseSelectedDevice}\n\t\t\t\t\t\t\t\t\tdisabled={!selectedDeviceId || isLoading}\n\t\t\t\t\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\tUse Selected Device\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* No Existing Devices */}\n\t\t\t\t\t{existingDevices.length === 0 && (\n\t\t\t\t\t\t<div className=\"no-devices-message\">\n\t\t\t\t\t\t\t<div className=\"info-icon\">‚ÑπÔ∏è</div>\n\t\t\t\t\t\t\t<h3>No Existing Devices</h3>\n\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\tYou don't have any {config.displayName} devices registered yet. Register a new\n\t\t\t\t\t\t\t\tdevice to continue.\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\n\t\t\t\t\t{/* Register New Device Section */}\n\t\t\t\t\t<div className=\"register-new-section\">\n\t\t\t\t\t\t<div className=\"section-divider\">\n\t\t\t\t\t\t\t<span>OR</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<h3>Register New Device</h3>\n\t\t\t\t\t\t<p className=\"section-description\">\n\t\t\t\t\t\t\tSet up a new {config.displayName} device for multi-factor authentication.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={handleRegisterNewDevice}\n\t\t\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t\t\t\tclassName=\"button-primary register-new-button\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t+ Register New {config.displayName} Device\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Navigation Buttons */}\n\t\t\t<div className=\"step-actions\">\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => nav.goToPrevious()}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t\tclassName=\"button-secondary\"\n\t\t\t\t>\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\t\t\t</div>\n\n\t\t\t{/* Token Status Warning */}\n\t\t\t{!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\nexport default UnifiedDeviceSelectionStep;\n"},"tags":[],"source":null},{"category":"parse","severity":"error","description":"Expected corresponding JSX closing tag for 'div'.","message":[{"elements":[],"content":"Expected corresponding JSX closing tag for 'div'."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Opening tag"}]]},{"frame":{"path":null,"span":[12210,12413],"sourceCode":"/**\n * @file UnifiedRegistrationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 2: Device Registration - Unified registration for all device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle device registration for all 6 device types using either:\n * - DynamicFormRenderer (for SMS, Email, WhatsApp)\n * - Custom components (for TOTP, FIDO2, Mobile)\n *\n * Flow:\n * 1. Render appropriate UI based on device type\n * 2. Collect and validate device-specific information\n * 3. Call controller.registerDevice()\n * 4. Update mfaState with registration result\n * 5. Navigate to activation step\n *\n * @example\n * <UnifiedRegistrationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n *   deviceFields={deviceFields}\n *   setDeviceFields={setDeviceFields}\n *   errors={errors}\n *   validate={validate}\n * />\n */\n\nimport React, { useCallback, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type DeviceComponentProps, DeviceComponentRegistry } from './DeviceComponentRegistry';\nimport { DynamicFormRenderer } from './DynamicFormRenderer';\n\nconst MODULE_TAG = '[üìù UNIFIED-REGISTRATION-STEP]';\n\n// Exported helper to determine final device status after registration\nexport function computeDeviceStatus(resultStatus: string | undefined, deviceType: string, tokenType: string) {\n\tconst status = resultStatus || '';\n\tif (deviceType === 'TOTP') {\n\t\t// User flows must require activation\n\t\tif (tokenType === 'user') return 'ACTIVATION_REQUIRED';\n\t\t// For admin/worker flows, prefer returned status, but default to ACTIVATION_REQUIRED\n\t\treturn status || 'ACTIVATION_REQUIRED';\n\t}\n\treturn status || 'ACTIVE';\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedRegistrationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device-specific form field values */\n\tdeviceFields: Record<string, string>;\n\n\t/** Update device fields */\n\tsetDeviceFields: (\n\t\tfields: Record<string, string> | ((prev: Record<string, string>) => Record<string, string>)\n\t) => void;\n\n\t/** Validation errors */\n\terrors: Record<string, string>;\n\n\t/** Validation function */\n\tvalidate: () => boolean;\n\n\t/** Touch field callback (for validation) */\n\ttouchField?: (field: string) => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Registration Step (Step 2)\n *\n * Handles device registration for all device types using configuration-driven\n * rendering (DynamicFormRenderer) or custom components (TOTP, FIDO2, Mobile).\n */\nexport const UnifiedRegistrationStep: React.FC<UnifiedRegistrationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n\tdeviceFields,\n\tsetDeviceFields,\n\terrors,\n\tvalidate,\n\ttouchField,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering registration step for:`, config.deviceType);\n\t\n\t// ========== DEBUG: FULL CONFIG CHECK ==========\n\tconsole.log('üîç [REG-STEP DEBUG] Full config:', {\n\t\tdeviceType: config.deviceType,\n\t\tdisplayName: config.displayName,\n\t\trequiresOTP: config.requiresOTP,\n\t\tconfigObject: config\n\t});\n\t// ==============================================\n\t\n\t// ========== DEBUG: COMPONENT MOUNT ==========\n\tReact.useEffect(() => {\n\t\tconsole.log('üîç [REG-STEP DEBUG] Component mounted/updated', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasDeviceFields: !!deviceFields,\n\t\t\tfieldCount: Object.keys(deviceFields || {}).length,\n\t\t\ttokenValid: tokenStatus.isValid,\n\t\t\tisLoading\n\t\t});\n\t}, [config.deviceType, deviceFields, tokenStatus.isValid, isLoading]);\n\t// ===========================================\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle field change\n\t */\n\tconst handleFieldChange = useCallback(\n\t\t(field: string, value: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Field changed:`, field, '=', value);\n\t\t\tsetDeviceFields((prev) => ({ ...prev, [field]: value }));\n\n\t\t\t// Clear error for this field\n\t\t\tif (errors[field]) {\n\t\t\t\tsetRegistrationError(null);\n\t\t\t}\n\t\t},\n\t\t[setDeviceFields, errors]\n\t);\n\n\t/**\n\t * Handle device registration\n\t */\n\tconst handleRegisterDevice = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting device registration`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceFields,\n\t\t});\n\t\t\n\t\t// ========== DEBUG: REGISTRATION ENTRY ==========\n\t\tconsole.log('üîç [REG DEBUG] handleRegisterDevice called', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tfields: deviceFields,\n\t\t\tcredentialsEnvId: credentials.environmentId,\n\t\t\ttokenIsValid: tokenStatus.isValid\n\t\t});\n\t\t// ===============================================\n\n\t\t// Clear previous errors\n\t\tsetRegistrationError(null);\n\n\t\t// Validate fields\n\t\tif (!validate()) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed`);\n\t\t\tconsole.log('üîç [REG DEBUG] Validation failed, errors:', errors);\n\t\t\tsetRegistrationError('Please fix the errors above before continuing');\n\t\t\tnav.setValidationErrors(['Please fix the form errors']);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconsole.log('üîç [REG DEBUG] Validation passed, proceeding with registration');\n\n\t\t// Set loading state\n\t\tsetIsLoading(true);\n\n\t\ttry {\n\t\t\t// Merge device fields into credentials\n\t\t\tconst updatedCredentials = {\n\t\t\t\t...credentials,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t\t...deviceFields,\n\t\t\t};\n\n\t\t\t// Update credentials\n\t\t\tsetCredentials(updatedCredentials);\n\n\t\t\tconsole.log(`${MODULE_TAG} Calling controller.registerDevice`);\n\n\t\t\t// Call controller to register device\n\t\t\tconst result = await controller.registerDevice(\n\t\t\t\tupdatedCredentials,\n\t\t\t\tmfaState,\n\t\t\t\ttokenStatus,\n\t\t\t\tnav\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Device registered successfully:`, result);\n\t\t\n\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\tif (config.deviceType === 'TOTP') {\n\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result:', {\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tqrCode: result.qrCode,\n\t\t\t\tqrCodeUrl: result.qrCodeUrl,\n\t\t\t\tsecret: result.secret,\n\t\t\t\ttotpSecret: result.totpSecret,\n\t\t\t\tfullResult: result\n\t\t\t});\n\t\t}\n\t\t// ===============================================\n\n\t\t// Update MFA state with registration result\n\t\tsetMfaState((prev) => {\n\t\t\tconst newState = {\n\t\t\t\t...prev,\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tdeviceStatus: computeDeviceStatus(result.status, config.deviceType, tokenStatus.type),\n\t\t\t\t// TOTP-specific data (preserve QR/secret for user to scan)\n\t\t\t\tqrCodeUrl: result.qrCode || result.qrCodeUrl,\n\t\t\t\ttotpSecret: result.secret || result.totpSecret,\n\t\t\t\t// If we have TOTP data, surface the QR/secret immediately\n\t\t\t\tshowQr: config.deviceType === 'TOTP' && (result.qrCode || result.secret || result.totpSecret),\n\t\t\t\t// FIDO2-specific data\n\t\t\t\tpublicKeyCredentialCreationOptions: result.publicKeyCredentialCreationOptions,\n\t\t\t\t// Mobile-specific data\n\t\t\t\tpairingKey: result.pairingKey,\n\t\t\t\t// Links for activation\n\t\t\t\tactivationLinks: result._links,\n\t\t\t};\n\t\t\t\n\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\tif (config.deviceType === 'TOTP') {\n\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\tfullState: newState\n\t\t\t\t});\n\t\t\t}\n\t\t\t// ================================================\n\t\t\t\n\t\t\treturn newState;\n\t\t});\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} device registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step (activation)\n\t\t\tnav.goToNext();\n\t\t} catch (error: any) {\n\t\t\tconsole.error(`${MODULE_TAG} Device registration failed:`, error);\n\n\t\t\tconst errorMessage = error.message || `Failed to register ${config.displayName} device`;\n\n\t\t\tsetRegistrationError(errorMessage);\n\t\t\tnav.setValidationErrors([errorMessage]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [\n\t\tconfig, \n\t\tdeviceFields, \n\t\tcredentials, \n\t\tsetCredentials, \n\t\tmfaState, \n\t\tsetMfaState, \n\t\ttokenStatus, \n\t\tnav, \n\t\tcontroller, \n\t\tvalidate, \n\t\tsetIsLoading, errors\n\t]);\n\n\t/**\n\t * Handle registration success (for custom components)\n\t */\n\tconst handleRegistrationSuccess = useCallback(\n\t\t(data: any) => {\n\t\t\tconsole.log(`${MODULE_TAG} Custom component registration success:`, data);\n\n\t\t\t// Update MFA state\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t...data,\n\t\t\t}));\n\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step\n\t\t\tnav.goToNext();\n\t\t},\n\t\t[config, setMfaState, nav]\n\t);\n\n\t/**\n\t * Handle registration error (for custom components)\n\t */\n\tconst handleRegistrationError = useCallback(\n\t\t(error: string) => {\n\t\t\tconsole.error(`${MODULE_TAG} Custom component registration error:`, error);\n\n\t\t\tsetRegistrationError(error);\n\t\t\tnav.setValidationErrors([error]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(error);\n\t\t},\n\t\t[nav]\n\t);\n\n\t// ========================================================================\n\t// RENDER UI LOGIC\n\t// ========================================================================\n\n\t/**\n\t * Render registration UI based on device type\n\t */\n\tconst renderRegistrationUI = () => {\n\t\t// Check if this device type has a custom component\n\t\tconst CustomComponent = DeviceComponentRegistry[config.deviceType];\n\t\t\n\t\t// ========== DEBUG: REGISTRATION UI PATH ==========\n\t\tconsole.log('üîç [REG-UI DEBUG] Rendering path:', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasCustomComponent: !!CustomComponent,\n\t\t\twillUseDynamicForm: !CustomComponent,\n\t\t\tregistryValue: CustomComponent\n\t\t});\n\t\t// ================================================\n\n\t\tif (CustomComponent) {\n\t\t\t// Use device-specific custom component (TOTP, FIDO2, Mobile)\n\t\t\tconsole.log(`${MODULE_TAG} Using custom component for:`, config.deviceType);\n\n\t\t\tconst customComponentProps: DeviceComponentProps = {\n\t\t\t\tcredentials,\n\t\t\t\tmfaState,\n\t\t\t\tsetMfaState,\n\t\t\t\tonSuccess: handleRegistrationSuccess,\n\t\t\t\tonError: handleRegistrationError,\n\t\t\t\tcontroller,\n\t\t\t\tconfig,\n\t\t\t};\n\n\t\t\treturn <CustomComponent {...customComponentProps} />;\n\t\t} else {\n\t\t\t// Use dynamic form renderer (SMS, Email, WhatsApp)\n\t\t\tconsole.log(`${MODULE_TAG} Using dynamic form renderer for:`, config.deviceType);\n\n\t\t\treturn (\n\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\tconfig={config}\n\t\t\t\t\tvalues={deviceFields || {}}\n\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\terrors={errors}\n\t\t\t\t\tonTouch={touchField}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t/>\n\t\t\t);\n\t\t}\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-registration-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">{config.description}</p>\n\t\t\t</div>\n\n\t\t\t{/* Registration UI (dynamic form or custom component) */}\n\t\t\t<div className=\"registration-ui\">{renderRegistrationUI()}</div>\n\n\t\t\t{/* Registration Error */}\n\t\t\t{registrationError && (\n\t\t\t\t<div className=\"registration-error\" role=\"alert\">\n\t\t\t\t\t<strong>Registration Failed:</strong> {registrationError}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Info */}\n\t\t\t<div style={{ \n\t\t\t\tpadding: '12px 16px', \n\t\t\t\tbackground: '#eff6ff', \n\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\tborderRadius: '6px',\n\t\t\t\tmarginBottom: '16px',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tcolor: '#1e40af'\n\t\t\t}}>\n\t\t\t{config.deviceType === 'FIDO2' ? (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will create your {config.displayName} device, then you'll complete biometric authentication.</>\n\t\t\t) : (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will register your {config.displayName} device and send the activation code.</>\n\t\t\t)}\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleRegisterDevice}\n\t\t\t\t\tdisabled={isLoading || !tokenStatus.isValid}\n\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Registering...' : 'Next Step ‚ñ∂'}\n\t\t\t\t</button>\n\t\t\t</div>!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)\n\t\t</div>\n\t);\n};\n\nexport default UnifiedRegistrationStep;\n"}},{"log":["info",[{"elements":[],"content":"closing tag"}]]},{"frame":{"path":null,"span":[12733,12742],"sourceCode":"/**\n * @file UnifiedRegistrationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 2: Device Registration - Unified registration for all device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle device registration for all 6 device types using either:\n * - DynamicFormRenderer (for SMS, Email, WhatsApp)\n * - Custom components (for TOTP, FIDO2, Mobile)\n *\n * Flow:\n * 1. Render appropriate UI based on device type\n * 2. Collect and validate device-specific information\n * 3. Call controller.registerDevice()\n * 4. Update mfaState with registration result\n * 5. Navigate to activation step\n *\n * @example\n * <UnifiedRegistrationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n *   deviceFields={deviceFields}\n *   setDeviceFields={setDeviceFields}\n *   errors={errors}\n *   validate={validate}\n * />\n */\n\nimport React, { useCallback, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type DeviceComponentProps, DeviceComponentRegistry } from './DeviceComponentRegistry';\nimport { DynamicFormRenderer } from './DynamicFormRenderer';\n\nconst MODULE_TAG = '[üìù UNIFIED-REGISTRATION-STEP]';\n\n// Exported helper to determine final device status after registration\nexport function computeDeviceStatus(resultStatus: string | undefined, deviceType: string, tokenType: string) {\n\tconst status = resultStatus || '';\n\tif (deviceType === 'TOTP') {\n\t\t// User flows must require activation\n\t\tif (tokenType === 'user') return 'ACTIVATION_REQUIRED';\n\t\t// For admin/worker flows, prefer returned status, but default to ACTIVATION_REQUIRED\n\t\treturn status || 'ACTIVATION_REQUIRED';\n\t}\n\treturn status || 'ACTIVE';\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedRegistrationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device-specific form field values */\n\tdeviceFields: Record<string, string>;\n\n\t/** Update device fields */\n\tsetDeviceFields: (\n\t\tfields: Record<string, string> | ((prev: Record<string, string>) => Record<string, string>)\n\t) => void;\n\n\t/** Validation errors */\n\terrors: Record<string, string>;\n\n\t/** Validation function */\n\tvalidate: () => boolean;\n\n\t/** Touch field callback (for validation) */\n\ttouchField?: (field: string) => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Registration Step (Step 2)\n *\n * Handles device registration for all device types using configuration-driven\n * rendering (DynamicFormRenderer) or custom components (TOTP, FIDO2, Mobile).\n */\nexport const UnifiedRegistrationStep: React.FC<UnifiedRegistrationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n\tdeviceFields,\n\tsetDeviceFields,\n\terrors,\n\tvalidate,\n\ttouchField,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering registration step for:`, config.deviceType);\n\t\n\t// ========== DEBUG: FULL CONFIG CHECK ==========\n\tconsole.log('üîç [REG-STEP DEBUG] Full config:', {\n\t\tdeviceType: config.deviceType,\n\t\tdisplayName: config.displayName,\n\t\trequiresOTP: config.requiresOTP,\n\t\tconfigObject: config\n\t});\n\t// ==============================================\n\t\n\t// ========== DEBUG: COMPONENT MOUNT ==========\n\tReact.useEffect(() => {\n\t\tconsole.log('üîç [REG-STEP DEBUG] Component mounted/updated', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasDeviceFields: !!deviceFields,\n\t\t\tfieldCount: Object.keys(deviceFields || {}).length,\n\t\t\ttokenValid: tokenStatus.isValid,\n\t\t\tisLoading\n\t\t});\n\t}, [config.deviceType, deviceFields, tokenStatus.isValid, isLoading]);\n\t// ===========================================\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle field change\n\t */\n\tconst handleFieldChange = useCallback(\n\t\t(field: string, value: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Field changed:`, field, '=', value);\n\t\t\tsetDeviceFields((prev) => ({ ...prev, [field]: value }));\n\n\t\t\t// Clear error for this field\n\t\t\tif (errors[field]) {\n\t\t\t\tsetRegistrationError(null);\n\t\t\t}\n\t\t},\n\t\t[setDeviceFields, errors]\n\t);\n\n\t/**\n\t * Handle device registration\n\t */\n\tconst handleRegisterDevice = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting device registration`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceFields,\n\t\t});\n\t\t\n\t\t// ========== DEBUG: REGISTRATION ENTRY ==========\n\t\tconsole.log('üîç [REG DEBUG] handleRegisterDevice called', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tfields: deviceFields,\n\t\t\tcredentialsEnvId: credentials.environmentId,\n\t\t\ttokenIsValid: tokenStatus.isValid\n\t\t});\n\t\t// ===============================================\n\n\t\t// Clear previous errors\n\t\tsetRegistrationError(null);\n\n\t\t// Validate fields\n\t\tif (!validate()) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed`);\n\t\t\tconsole.log('üîç [REG DEBUG] Validation failed, errors:', errors);\n\t\t\tsetRegistrationError('Please fix the errors above before continuing');\n\t\t\tnav.setValidationErrors(['Please fix the form errors']);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconsole.log('üîç [REG DEBUG] Validation passed, proceeding with registration');\n\n\t\t// Set loading state\n\t\tsetIsLoading(true);\n\n\t\ttry {\n\t\t\t// Merge device fields into credentials\n\t\t\tconst updatedCredentials = {\n\t\t\t\t...credentials,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t\t...deviceFields,\n\t\t\t};\n\n\t\t\t// Update credentials\n\t\t\tsetCredentials(updatedCredentials);\n\n\t\t\tconsole.log(`${MODULE_TAG} Calling controller.registerDevice`);\n\n\t\t\t// Call controller to register device\n\t\t\tconst result = await controller.registerDevice(\n\t\t\t\tupdatedCredentials,\n\t\t\t\tmfaState,\n\t\t\t\ttokenStatus,\n\t\t\t\tnav\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Device registered successfully:`, result);\n\t\t\n\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\tif (config.deviceType === 'TOTP') {\n\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result:', {\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tqrCode: result.qrCode,\n\t\t\t\tqrCodeUrl: result.qrCodeUrl,\n\t\t\t\tsecret: result.secret,\n\t\t\t\ttotpSecret: result.totpSecret,\n\t\t\t\tfullResult: result\n\t\t\t});\n\t\t}\n\t\t// ===============================================\n\n\t\t// Update MFA state with registration result\n\t\tsetMfaState((prev) => {\n\t\t\tconst newState = {\n\t\t\t\t...prev,\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tdeviceStatus: computeDeviceStatus(result.status, config.deviceType, tokenStatus.type),\n\t\t\t\t// TOTP-specific data (preserve QR/secret for user to scan)\n\t\t\t\tqrCodeUrl: result.qrCode || result.qrCodeUrl,\n\t\t\t\ttotpSecret: result.secret || result.totpSecret,\n\t\t\t\t// If we have TOTP data, surface the QR/secret immediately\n\t\t\t\tshowQr: config.deviceType === 'TOTP' && (result.qrCode || result.secret || result.totpSecret),\n\t\t\t\t// FIDO2-specific data\n\t\t\t\tpublicKeyCredentialCreationOptions: result.publicKeyCredentialCreationOptions,\n\t\t\t\t// Mobile-specific data\n\t\t\t\tpairingKey: result.pairingKey,\n\t\t\t\t// Links for activation\n\t\t\t\tactivationLinks: result._links,\n\t\t\t};\n\t\t\t\n\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\tif (config.deviceType === 'TOTP') {\n\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\tfullState: newState\n\t\t\t\t});\n\t\t\t}\n\t\t\t// ================================================\n\t\t\t\n\t\t\treturn newState;\n\t\t});\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} device registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step (activation)\n\t\t\tnav.goToNext();\n\t\t} catch (error: any) {\n\t\t\tconsole.error(`${MODULE_TAG} Device registration failed:`, error);\n\n\t\t\tconst errorMessage = error.message || `Failed to register ${config.displayName} device`;\n\n\t\t\tsetRegistrationError(errorMessage);\n\t\t\tnav.setValidationErrors([errorMessage]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [\n\t\tconfig, \n\t\tdeviceFields, \n\t\tcredentials, \n\t\tsetCredentials, \n\t\tmfaState, \n\t\tsetMfaState, \n\t\ttokenStatus, \n\t\tnav, \n\t\tcontroller, \n\t\tvalidate, \n\t\tsetIsLoading, errors\n\t]);\n\n\t/**\n\t * Handle registration success (for custom components)\n\t */\n\tconst handleRegistrationSuccess = useCallback(\n\t\t(data: any) => {\n\t\t\tconsole.log(`${MODULE_TAG} Custom component registration success:`, data);\n\n\t\t\t// Update MFA state\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t...data,\n\t\t\t}));\n\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step\n\t\t\tnav.goToNext();\n\t\t},\n\t\t[config, setMfaState, nav]\n\t);\n\n\t/**\n\t * Handle registration error (for custom components)\n\t */\n\tconst handleRegistrationError = useCallback(\n\t\t(error: string) => {\n\t\t\tconsole.error(`${MODULE_TAG} Custom component registration error:`, error);\n\n\t\t\tsetRegistrationError(error);\n\t\t\tnav.setValidationErrors([error]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(error);\n\t\t},\n\t\t[nav]\n\t);\n\n\t// ========================================================================\n\t// RENDER UI LOGIC\n\t// ========================================================================\n\n\t/**\n\t * Render registration UI based on device type\n\t */\n\tconst renderRegistrationUI = () => {\n\t\t// Check if this device type has a custom component\n\t\tconst CustomComponent = DeviceComponentRegistry[config.deviceType];\n\t\t\n\t\t// ========== DEBUG: REGISTRATION UI PATH ==========\n\t\tconsole.log('üîç [REG-UI DEBUG] Rendering path:', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasCustomComponent: !!CustomComponent,\n\t\t\twillUseDynamicForm: !CustomComponent,\n\t\t\tregistryValue: CustomComponent\n\t\t});\n\t\t// ================================================\n\n\t\tif (CustomComponent) {\n\t\t\t// Use device-specific custom component (TOTP, FIDO2, Mobile)\n\t\t\tconsole.log(`${MODULE_TAG} Using custom component for:`, config.deviceType);\n\n\t\t\tconst customComponentProps: DeviceComponentProps = {\n\t\t\t\tcredentials,\n\t\t\t\tmfaState,\n\t\t\t\tsetMfaState,\n\t\t\t\tonSuccess: handleRegistrationSuccess,\n\t\t\t\tonError: handleRegistrationError,\n\t\t\t\tcontroller,\n\t\t\t\tconfig,\n\t\t\t};\n\n\t\t\treturn <CustomComponent {...customComponentProps} />;\n\t\t} else {\n\t\t\t// Use dynamic form renderer (SMS, Email, WhatsApp)\n\t\t\tconsole.log(`${MODULE_TAG} Using dynamic form renderer for:`, config.deviceType);\n\n\t\t\treturn (\n\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\tconfig={config}\n\t\t\t\t\tvalues={deviceFields || {}}\n\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\terrors={errors}\n\t\t\t\t\tonTouch={touchField}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t/>\n\t\t\t);\n\t\t}\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-registration-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">{config.description}</p>\n\t\t\t</div>\n\n\t\t\t{/* Registration UI (dynamic form or custom component) */}\n\t\t\t<div className=\"registration-ui\">{renderRegistrationUI()}</div>\n\n\t\t\t{/* Registration Error */}\n\t\t\t{registrationError && (\n\t\t\t\t<div className=\"registration-error\" role=\"alert\">\n\t\t\t\t\t<strong>Registration Failed:</strong> {registrationError}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Info */}\n\t\t\t<div style={{ \n\t\t\t\tpadding: '12px 16px', \n\t\t\t\tbackground: '#eff6ff', \n\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\tborderRadius: '6px',\n\t\t\t\tmarginBottom: '16px',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tcolor: '#1e40af'\n\t\t\t}}>\n\t\t\t{config.deviceType === 'FIDO2' ? (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will create your {config.displayName} device, then you'll complete biometric authentication.</>\n\t\t\t) : (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will register your {config.displayName} device and send the activation code.</>\n\t\t\t)}\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleRegisterDevice}\n\t\t\t\t\tdisabled={isLoading || !tokenStatus.isValid}\n\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Registering...' : 'Next Step ‚ñ∂'}\n\t\t\t\t</button>\n\t\t\t</div>!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)\n\t\t</div>\n\t);\n};\n\nexport default UnifiedRegistrationStep;\n"}}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedRegistrationStep.tsx"},"span":[12210,12413],"sourceCode":"/**\n * @file UnifiedRegistrationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 2: Device Registration - Unified registration for all device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle device registration for all 6 device types using either:\n * - DynamicFormRenderer (for SMS, Email, WhatsApp)\n * - Custom components (for TOTP, FIDO2, Mobile)\n *\n * Flow:\n * 1. Render appropriate UI based on device type\n * 2. Collect and validate device-specific information\n * 3. Call controller.registerDevice()\n * 4. Update mfaState with registration result\n * 5. Navigate to activation step\n *\n * @example\n * <UnifiedRegistrationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n *   deviceFields={deviceFields}\n *   setDeviceFields={setDeviceFields}\n *   errors={errors}\n *   validate={validate}\n * />\n */\n\nimport React, { useCallback, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type DeviceComponentProps, DeviceComponentRegistry } from './DeviceComponentRegistry';\nimport { DynamicFormRenderer } from './DynamicFormRenderer';\n\nconst MODULE_TAG = '[üìù UNIFIED-REGISTRATION-STEP]';\n\n// Exported helper to determine final device status after registration\nexport function computeDeviceStatus(resultStatus: string | undefined, deviceType: string, tokenType: string) {\n\tconst status = resultStatus || '';\n\tif (deviceType === 'TOTP') {\n\t\t// User flows must require activation\n\t\tif (tokenType === 'user') return 'ACTIVATION_REQUIRED';\n\t\t// For admin/worker flows, prefer returned status, but default to ACTIVATION_REQUIRED\n\t\treturn status || 'ACTIVATION_REQUIRED';\n\t}\n\treturn status || 'ACTIVE';\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedRegistrationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device-specific form field values */\n\tdeviceFields: Record<string, string>;\n\n\t/** Update device fields */\n\tsetDeviceFields: (\n\t\tfields: Record<string, string> | ((prev: Record<string, string>) => Record<string, string>)\n\t) => void;\n\n\t/** Validation errors */\n\terrors: Record<string, string>;\n\n\t/** Validation function */\n\tvalidate: () => boolean;\n\n\t/** Touch field callback (for validation) */\n\ttouchField?: (field: string) => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Registration Step (Step 2)\n *\n * Handles device registration for all device types using configuration-driven\n * rendering (DynamicFormRenderer) or custom components (TOTP, FIDO2, Mobile).\n */\nexport const UnifiedRegistrationStep: React.FC<UnifiedRegistrationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n\tdeviceFields,\n\tsetDeviceFields,\n\terrors,\n\tvalidate,\n\ttouchField,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering registration step for:`, config.deviceType);\n\t\n\t// ========== DEBUG: FULL CONFIG CHECK ==========\n\tconsole.log('üîç [REG-STEP DEBUG] Full config:', {\n\t\tdeviceType: config.deviceType,\n\t\tdisplayName: config.displayName,\n\t\trequiresOTP: config.requiresOTP,\n\t\tconfigObject: config\n\t});\n\t// ==============================================\n\t\n\t// ========== DEBUG: COMPONENT MOUNT ==========\n\tReact.useEffect(() => {\n\t\tconsole.log('üîç [REG-STEP DEBUG] Component mounted/updated', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasDeviceFields: !!deviceFields,\n\t\t\tfieldCount: Object.keys(deviceFields || {}).length,\n\t\t\ttokenValid: tokenStatus.isValid,\n\t\t\tisLoading\n\t\t});\n\t}, [config.deviceType, deviceFields, tokenStatus.isValid, isLoading]);\n\t// ===========================================\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle field change\n\t */\n\tconst handleFieldChange = useCallback(\n\t\t(field: string, value: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Field changed:`, field, '=', value);\n\t\t\tsetDeviceFields((prev) => ({ ...prev, [field]: value }));\n\n\t\t\t// Clear error for this field\n\t\t\tif (errors[field]) {\n\t\t\t\tsetRegistrationError(null);\n\t\t\t}\n\t\t},\n\t\t[setDeviceFields, errors]\n\t);\n\n\t/**\n\t * Handle device registration\n\t */\n\tconst handleRegisterDevice = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting device registration`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceFields,\n\t\t});\n\t\t\n\t\t// ========== DEBUG: REGISTRATION ENTRY ==========\n\t\tconsole.log('üîç [REG DEBUG] handleRegisterDevice called', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tfields: deviceFields,\n\t\t\tcredentialsEnvId: credentials.environmentId,\n\t\t\ttokenIsValid: tokenStatus.isValid\n\t\t});\n\t\t// ===============================================\n\n\t\t// Clear previous errors\n\t\tsetRegistrationError(null);\n\n\t\t// Validate fields\n\t\tif (!validate()) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed`);\n\t\t\tconsole.log('üîç [REG DEBUG] Validation failed, errors:', errors);\n\t\t\tsetRegistrationError('Please fix the errors above before continuing');\n\t\t\tnav.setValidationErrors(['Please fix the form errors']);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconsole.log('üîç [REG DEBUG] Validation passed, proceeding with registration');\n\n\t\t// Set loading state\n\t\tsetIsLoading(true);\n\n\t\ttry {\n\t\t\t// Merge device fields into credentials\n\t\t\tconst updatedCredentials = {\n\t\t\t\t...credentials,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t\t...deviceFields,\n\t\t\t};\n\n\t\t\t// Update credentials\n\t\t\tsetCredentials(updatedCredentials);\n\n\t\t\tconsole.log(`${MODULE_TAG} Calling controller.registerDevice`);\n\n\t\t\t// Call controller to register device\n\t\t\tconst result = await controller.registerDevice(\n\t\t\t\tupdatedCredentials,\n\t\t\t\tmfaState,\n\t\t\t\ttokenStatus,\n\t\t\t\tnav\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Device registered successfully:`, result);\n\t\t\n\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\tif (config.deviceType === 'TOTP') {\n\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result:', {\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tqrCode: result.qrCode,\n\t\t\t\tqrCodeUrl: result.qrCodeUrl,\n\t\t\t\tsecret: result.secret,\n\t\t\t\ttotpSecret: result.totpSecret,\n\t\t\t\tfullResult: result\n\t\t\t});\n\t\t}\n\t\t// ===============================================\n\n\t\t// Update MFA state with registration result\n\t\tsetMfaState((prev) => {\n\t\t\tconst newState = {\n\t\t\t\t...prev,\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tdeviceStatus: computeDeviceStatus(result.status, config.deviceType, tokenStatus.type),\n\t\t\t\t// TOTP-specific data (preserve QR/secret for user to scan)\n\t\t\t\tqrCodeUrl: result.qrCode || result.qrCodeUrl,\n\t\t\t\ttotpSecret: result.secret || result.totpSecret,\n\t\t\t\t// If we have TOTP data, surface the QR/secret immediately\n\t\t\t\tshowQr: config.deviceType === 'TOTP' && (result.qrCode || result.secret || result.totpSecret),\n\t\t\t\t// FIDO2-specific data\n\t\t\t\tpublicKeyCredentialCreationOptions: result.publicKeyCredentialCreationOptions,\n\t\t\t\t// Mobile-specific data\n\t\t\t\tpairingKey: result.pairingKey,\n\t\t\t\t// Links for activation\n\t\t\t\tactivationLinks: result._links,\n\t\t\t};\n\t\t\t\n\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\tif (config.deviceType === 'TOTP') {\n\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\tfullState: newState\n\t\t\t\t});\n\t\t\t}\n\t\t\t// ================================================\n\t\t\t\n\t\t\treturn newState;\n\t\t});\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} device registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step (activation)\n\t\t\tnav.goToNext();\n\t\t} catch (error: any) {\n\t\t\tconsole.error(`${MODULE_TAG} Device registration failed:`, error);\n\n\t\t\tconst errorMessage = error.message || `Failed to register ${config.displayName} device`;\n\n\t\t\tsetRegistrationError(errorMessage);\n\t\t\tnav.setValidationErrors([errorMessage]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [\n\t\tconfig, \n\t\tdeviceFields, \n\t\tcredentials, \n\t\tsetCredentials, \n\t\tmfaState, \n\t\tsetMfaState, \n\t\ttokenStatus, \n\t\tnav, \n\t\tcontroller, \n\t\tvalidate, \n\t\tsetIsLoading, errors\n\t]);\n\n\t/**\n\t * Handle registration success (for custom components)\n\t */\n\tconst handleRegistrationSuccess = useCallback(\n\t\t(data: any) => {\n\t\t\tconsole.log(`${MODULE_TAG} Custom component registration success:`, data);\n\n\t\t\t// Update MFA state\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t...data,\n\t\t\t}));\n\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step\n\t\t\tnav.goToNext();\n\t\t},\n\t\t[config, setMfaState, nav]\n\t);\n\n\t/**\n\t * Handle registration error (for custom components)\n\t */\n\tconst handleRegistrationError = useCallback(\n\t\t(error: string) => {\n\t\t\tconsole.error(`${MODULE_TAG} Custom component registration error:`, error);\n\n\t\t\tsetRegistrationError(error);\n\t\t\tnav.setValidationErrors([error]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(error);\n\t\t},\n\t\t[nav]\n\t);\n\n\t// ========================================================================\n\t// RENDER UI LOGIC\n\t// ========================================================================\n\n\t/**\n\t * Render registration UI based on device type\n\t */\n\tconst renderRegistrationUI = () => {\n\t\t// Check if this device type has a custom component\n\t\tconst CustomComponent = DeviceComponentRegistry[config.deviceType];\n\t\t\n\t\t// ========== DEBUG: REGISTRATION UI PATH ==========\n\t\tconsole.log('üîç [REG-UI DEBUG] Rendering path:', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasCustomComponent: !!CustomComponent,\n\t\t\twillUseDynamicForm: !CustomComponent,\n\t\t\tregistryValue: CustomComponent\n\t\t});\n\t\t// ================================================\n\n\t\tif (CustomComponent) {\n\t\t\t// Use device-specific custom component (TOTP, FIDO2, Mobile)\n\t\t\tconsole.log(`${MODULE_TAG} Using custom component for:`, config.deviceType);\n\n\t\t\tconst customComponentProps: DeviceComponentProps = {\n\t\t\t\tcredentials,\n\t\t\t\tmfaState,\n\t\t\t\tsetMfaState,\n\t\t\t\tonSuccess: handleRegistrationSuccess,\n\t\t\t\tonError: handleRegistrationError,\n\t\t\t\tcontroller,\n\t\t\t\tconfig,\n\t\t\t};\n\n\t\t\treturn <CustomComponent {...customComponentProps} />;\n\t\t} else {\n\t\t\t// Use dynamic form renderer (SMS, Email, WhatsApp)\n\t\t\tconsole.log(`${MODULE_TAG} Using dynamic form renderer for:`, config.deviceType);\n\n\t\t\treturn (\n\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\tconfig={config}\n\t\t\t\t\tvalues={deviceFields || {}}\n\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\terrors={errors}\n\t\t\t\t\tonTouch={touchField}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t/>\n\t\t\t);\n\t\t}\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-registration-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">{config.description}</p>\n\t\t\t</div>\n\n\t\t\t{/* Registration UI (dynamic form or custom component) */}\n\t\t\t<div className=\"registration-ui\">{renderRegistrationUI()}</div>\n\n\t\t\t{/* Registration Error */}\n\t\t\t{registrationError && (\n\t\t\t\t<div className=\"registration-error\" role=\"alert\">\n\t\t\t\t\t<strong>Registration Failed:</strong> {registrationError}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Info */}\n\t\t\t<div style={{ \n\t\t\t\tpadding: '12px 16px', \n\t\t\t\tbackground: '#eff6ff', \n\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\tborderRadius: '6px',\n\t\t\t\tmarginBottom: '16px',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tcolor: '#1e40af'\n\t\t\t}}>\n\t\t\t{config.deviceType === 'FIDO2' ? (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will create your {config.displayName} device, then you'll complete biometric authentication.</>\n\t\t\t) : (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will register your {config.displayName} device and send the activation code.</>\n\t\t\t)}\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleRegisterDevice}\n\t\t\t\t\tdisabled={isLoading || !tokenStatus.isValid}\n\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Registering...' : 'Next Step ‚ñ∂'}\n\t\t\t\t</button>\n\t\t\t</div>!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)\n\t\t</div>\n\t);\n};\n\nexport default UnifiedRegistrationStep;\n"},"tags":[],"source":null},{"category":"parse","severity":"error","description":"expected `)` but instead found `tokenStatus`","message":[{"elements":[],"content":"expected `)` but instead found `tokenStatus`"}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Remove tokenStatus"}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedRegistrationStep.tsx"},"span":[12977,12988],"sourceCode":"/**\n * @file UnifiedRegistrationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 2: Device Registration - Unified registration for all device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle device registration for all 6 device types using either:\n * - DynamicFormRenderer (for SMS, Email, WhatsApp)\n * - Custom components (for TOTP, FIDO2, Mobile)\n *\n * Flow:\n * 1. Render appropriate UI based on device type\n * 2. Collect and validate device-specific information\n * 3. Call controller.registerDevice()\n * 4. Update mfaState with registration result\n * 5. Navigate to activation step\n *\n * @example\n * <UnifiedRegistrationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n *   deviceFields={deviceFields}\n *   setDeviceFields={setDeviceFields}\n *   errors={errors}\n *   validate={validate}\n * />\n */\n\nimport React, { useCallback, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type DeviceComponentProps, DeviceComponentRegistry } from './DeviceComponentRegistry';\nimport { DynamicFormRenderer } from './DynamicFormRenderer';\n\nconst MODULE_TAG = '[üìù UNIFIED-REGISTRATION-STEP]';\n\n// Exported helper to determine final device status after registration\nexport function computeDeviceStatus(resultStatus: string | undefined, deviceType: string, tokenType: string) {\n\tconst status = resultStatus || '';\n\tif (deviceType === 'TOTP') {\n\t\t// User flows must require activation\n\t\tif (tokenType === 'user') return 'ACTIVATION_REQUIRED';\n\t\t// For admin/worker flows, prefer returned status, but default to ACTIVATION_REQUIRED\n\t\treturn status || 'ACTIVATION_REQUIRED';\n\t}\n\treturn status || 'ACTIVE';\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedRegistrationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device-specific form field values */\n\tdeviceFields: Record<string, string>;\n\n\t/** Update device fields */\n\tsetDeviceFields: (\n\t\tfields: Record<string, string> | ((prev: Record<string, string>) => Record<string, string>)\n\t) => void;\n\n\t/** Validation errors */\n\terrors: Record<string, string>;\n\n\t/** Validation function */\n\tvalidate: () => boolean;\n\n\t/** Touch field callback (for validation) */\n\ttouchField?: (field: string) => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Registration Step (Step 2)\n *\n * Handles device registration for all device types using configuration-driven\n * rendering (DynamicFormRenderer) or custom components (TOTP, FIDO2, Mobile).\n */\nexport const UnifiedRegistrationStep: React.FC<UnifiedRegistrationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n\tdeviceFields,\n\tsetDeviceFields,\n\terrors,\n\tvalidate,\n\ttouchField,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering registration step for:`, config.deviceType);\n\t\n\t// ========== DEBUG: FULL CONFIG CHECK ==========\n\tconsole.log('üîç [REG-STEP DEBUG] Full config:', {\n\t\tdeviceType: config.deviceType,\n\t\tdisplayName: config.displayName,\n\t\trequiresOTP: config.requiresOTP,\n\t\tconfigObject: config\n\t});\n\t// ==============================================\n\t\n\t// ========== DEBUG: COMPONENT MOUNT ==========\n\tReact.useEffect(() => {\n\t\tconsole.log('üîç [REG-STEP DEBUG] Component mounted/updated', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasDeviceFields: !!deviceFields,\n\t\t\tfieldCount: Object.keys(deviceFields || {}).length,\n\t\t\ttokenValid: tokenStatus.isValid,\n\t\t\tisLoading\n\t\t});\n\t}, [config.deviceType, deviceFields, tokenStatus.isValid, isLoading]);\n\t// ===========================================\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle field change\n\t */\n\tconst handleFieldChange = useCallback(\n\t\t(field: string, value: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Field changed:`, field, '=', value);\n\t\t\tsetDeviceFields((prev) => ({ ...prev, [field]: value }));\n\n\t\t\t// Clear error for this field\n\t\t\tif (errors[field]) {\n\t\t\t\tsetRegistrationError(null);\n\t\t\t}\n\t\t},\n\t\t[setDeviceFields, errors]\n\t);\n\n\t/**\n\t * Handle device registration\n\t */\n\tconst handleRegisterDevice = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting device registration`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceFields,\n\t\t});\n\t\t\n\t\t// ========== DEBUG: REGISTRATION ENTRY ==========\n\t\tconsole.log('üîç [REG DEBUG] handleRegisterDevice called', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tfields: deviceFields,\n\t\t\tcredentialsEnvId: credentials.environmentId,\n\t\t\ttokenIsValid: tokenStatus.isValid\n\t\t});\n\t\t// ===============================================\n\n\t\t// Clear previous errors\n\t\tsetRegistrationError(null);\n\n\t\t// Validate fields\n\t\tif (!validate()) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed`);\n\t\t\tconsole.log('üîç [REG DEBUG] Validation failed, errors:', errors);\n\t\t\tsetRegistrationError('Please fix the errors above before continuing');\n\t\t\tnav.setValidationErrors(['Please fix the form errors']);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconsole.log('üîç [REG DEBUG] Validation passed, proceeding with registration');\n\n\t\t// Set loading state\n\t\tsetIsLoading(true);\n\n\t\ttry {\n\t\t\t// Merge device fields into credentials\n\t\t\tconst updatedCredentials = {\n\t\t\t\t...credentials,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t\t...deviceFields,\n\t\t\t};\n\n\t\t\t// Update credentials\n\t\t\tsetCredentials(updatedCredentials);\n\n\t\t\tconsole.log(`${MODULE_TAG} Calling controller.registerDevice`);\n\n\t\t\t// Call controller to register device\n\t\t\tconst result = await controller.registerDevice(\n\t\t\t\tupdatedCredentials,\n\t\t\t\tmfaState,\n\t\t\t\ttokenStatus,\n\t\t\t\tnav\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Device registered successfully:`, result);\n\t\t\n\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\tif (config.deviceType === 'TOTP') {\n\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result:', {\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tqrCode: result.qrCode,\n\t\t\t\tqrCodeUrl: result.qrCodeUrl,\n\t\t\t\tsecret: result.secret,\n\t\t\t\ttotpSecret: result.totpSecret,\n\t\t\t\tfullResult: result\n\t\t\t});\n\t\t}\n\t\t// ===============================================\n\n\t\t// Update MFA state with registration result\n\t\tsetMfaState((prev) => {\n\t\t\tconst newState = {\n\t\t\t\t...prev,\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tdeviceStatus: computeDeviceStatus(result.status, config.deviceType, tokenStatus.type),\n\t\t\t\t// TOTP-specific data (preserve QR/secret for user to scan)\n\t\t\t\tqrCodeUrl: result.qrCode || result.qrCodeUrl,\n\t\t\t\ttotpSecret: result.secret || result.totpSecret,\n\t\t\t\t// If we have TOTP data, surface the QR/secret immediately\n\t\t\t\tshowQr: config.deviceType === 'TOTP' && (result.qrCode || result.secret || result.totpSecret),\n\t\t\t\t// FIDO2-specific data\n\t\t\t\tpublicKeyCredentialCreationOptions: result.publicKeyCredentialCreationOptions,\n\t\t\t\t// Mobile-specific data\n\t\t\t\tpairingKey: result.pairingKey,\n\t\t\t\t// Links for activation\n\t\t\t\tactivationLinks: result._links,\n\t\t\t};\n\t\t\t\n\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\tif (config.deviceType === 'TOTP') {\n\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\tfullState: newState\n\t\t\t\t});\n\t\t\t}\n\t\t\t// ================================================\n\t\t\t\n\t\t\treturn newState;\n\t\t});\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} device registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step (activation)\n\t\t\tnav.goToNext();\n\t\t} catch (error: any) {\n\t\t\tconsole.error(`${MODULE_TAG} Device registration failed:`, error);\n\n\t\t\tconst errorMessage = error.message || `Failed to register ${config.displayName} device`;\n\n\t\t\tsetRegistrationError(errorMessage);\n\t\t\tnav.setValidationErrors([errorMessage]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [\n\t\tconfig, \n\t\tdeviceFields, \n\t\tcredentials, \n\t\tsetCredentials, \n\t\tmfaState, \n\t\tsetMfaState, \n\t\ttokenStatus, \n\t\tnav, \n\t\tcontroller, \n\t\tvalidate, \n\t\tsetIsLoading, errors\n\t]);\n\n\t/**\n\t * Handle registration success (for custom components)\n\t */\n\tconst handleRegistrationSuccess = useCallback(\n\t\t(data: any) => {\n\t\t\tconsole.log(`${MODULE_TAG} Custom component registration success:`, data);\n\n\t\t\t// Update MFA state\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t...data,\n\t\t\t}));\n\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step\n\t\t\tnav.goToNext();\n\t\t},\n\t\t[config, setMfaState, nav]\n\t);\n\n\t/**\n\t * Handle registration error (for custom components)\n\t */\n\tconst handleRegistrationError = useCallback(\n\t\t(error: string) => {\n\t\t\tconsole.error(`${MODULE_TAG} Custom component registration error:`, error);\n\n\t\t\tsetRegistrationError(error);\n\t\t\tnav.setValidationErrors([error]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(error);\n\t\t},\n\t\t[nav]\n\t);\n\n\t// ========================================================================\n\t// RENDER UI LOGIC\n\t// ========================================================================\n\n\t/**\n\t * Render registration UI based on device type\n\t */\n\tconst renderRegistrationUI = () => {\n\t\t// Check if this device type has a custom component\n\t\tconst CustomComponent = DeviceComponentRegistry[config.deviceType];\n\t\t\n\t\t// ========== DEBUG: REGISTRATION UI PATH ==========\n\t\tconsole.log('üîç [REG-UI DEBUG] Rendering path:', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasCustomComponent: !!CustomComponent,\n\t\t\twillUseDynamicForm: !CustomComponent,\n\t\t\tregistryValue: CustomComponent\n\t\t});\n\t\t// ================================================\n\n\t\tif (CustomComponent) {\n\t\t\t// Use device-specific custom component (TOTP, FIDO2, Mobile)\n\t\t\tconsole.log(`${MODULE_TAG} Using custom component for:`, config.deviceType);\n\n\t\t\tconst customComponentProps: DeviceComponentProps = {\n\t\t\t\tcredentials,\n\t\t\t\tmfaState,\n\t\t\t\tsetMfaState,\n\t\t\t\tonSuccess: handleRegistrationSuccess,\n\t\t\t\tonError: handleRegistrationError,\n\t\t\t\tcontroller,\n\t\t\t\tconfig,\n\t\t\t};\n\n\t\t\treturn <CustomComponent {...customComponentProps} />;\n\t\t} else {\n\t\t\t// Use dynamic form renderer (SMS, Email, WhatsApp)\n\t\t\tconsole.log(`${MODULE_TAG} Using dynamic form renderer for:`, config.deviceType);\n\n\t\t\treturn (\n\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\tconfig={config}\n\t\t\t\t\tvalues={deviceFields || {}}\n\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\terrors={errors}\n\t\t\t\t\tonTouch={touchField}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t/>\n\t\t\t);\n\t\t}\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-registration-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">{config.description}</p>\n\t\t\t</div>\n\n\t\t\t{/* Registration UI (dynamic form or custom component) */}\n\t\t\t<div className=\"registration-ui\">{renderRegistrationUI()}</div>\n\n\t\t\t{/* Registration Error */}\n\t\t\t{registrationError && (\n\t\t\t\t<div className=\"registration-error\" role=\"alert\">\n\t\t\t\t\t<strong>Registration Failed:</strong> {registrationError}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Info */}\n\t\t\t<div style={{ \n\t\t\t\tpadding: '12px 16px', \n\t\t\t\tbackground: '#eff6ff', \n\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\tborderRadius: '6px',\n\t\t\t\tmarginBottom: '16px',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tcolor: '#1e40af'\n\t\t\t}}>\n\t\t\t{config.deviceType === 'FIDO2' ? (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will create your {config.displayName} device, then you'll complete biometric authentication.</>\n\t\t\t) : (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will register your {config.displayName} device and send the activation code.</>\n\t\t\t)}\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleRegisterDevice}\n\t\t\t\t\tdisabled={isLoading || !tokenStatus.isValid}\n\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Registering...' : 'Next Step ‚ñ∂'}\n\t\t\t\t</button>\n\t\t\t</div>!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)\n\t\t</div>\n\t);\n};\n\nexport default UnifiedRegistrationStep;\n"},"tags":[],"source":null},{"category":"parse","severity":"error","description":"Expected an expression but instead found '<'.","message":[{"elements":[],"content":"Expected an expression but instead found '<'."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Expected an expression here."}]]},{"frame":{"path":null,"span":[13162,13163],"sourceCode":"/**\n * @file UnifiedRegistrationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 2: Device Registration - Unified registration for all device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle device registration for all 6 device types using either:\n * - DynamicFormRenderer (for SMS, Email, WhatsApp)\n * - Custom components (for TOTP, FIDO2, Mobile)\n *\n * Flow:\n * 1. Render appropriate UI based on device type\n * 2. Collect and validate device-specific information\n * 3. Call controller.registerDevice()\n * 4. Update mfaState with registration result\n * 5. Navigate to activation step\n *\n * @example\n * <UnifiedRegistrationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n *   deviceFields={deviceFields}\n *   setDeviceFields={setDeviceFields}\n *   errors={errors}\n *   validate={validate}\n * />\n */\n\nimport React, { useCallback, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type DeviceComponentProps, DeviceComponentRegistry } from './DeviceComponentRegistry';\nimport { DynamicFormRenderer } from './DynamicFormRenderer';\n\nconst MODULE_TAG = '[üìù UNIFIED-REGISTRATION-STEP]';\n\n// Exported helper to determine final device status after registration\nexport function computeDeviceStatus(resultStatus: string | undefined, deviceType: string, tokenType: string) {\n\tconst status = resultStatus || '';\n\tif (deviceType === 'TOTP') {\n\t\t// User flows must require activation\n\t\tif (tokenType === 'user') return 'ACTIVATION_REQUIRED';\n\t\t// For admin/worker flows, prefer returned status, but default to ACTIVATION_REQUIRED\n\t\treturn status || 'ACTIVATION_REQUIRED';\n\t}\n\treturn status || 'ACTIVE';\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedRegistrationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device-specific form field values */\n\tdeviceFields: Record<string, string>;\n\n\t/** Update device fields */\n\tsetDeviceFields: (\n\t\tfields: Record<string, string> | ((prev: Record<string, string>) => Record<string, string>)\n\t) => void;\n\n\t/** Validation errors */\n\terrors: Record<string, string>;\n\n\t/** Validation function */\n\tvalidate: () => boolean;\n\n\t/** Touch field callback (for validation) */\n\ttouchField?: (field: string) => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Registration Step (Step 2)\n *\n * Handles device registration for all device types using configuration-driven\n * rendering (DynamicFormRenderer) or custom components (TOTP, FIDO2, Mobile).\n */\nexport const UnifiedRegistrationStep: React.FC<UnifiedRegistrationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n\tdeviceFields,\n\tsetDeviceFields,\n\terrors,\n\tvalidate,\n\ttouchField,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering registration step for:`, config.deviceType);\n\t\n\t// ========== DEBUG: FULL CONFIG CHECK ==========\n\tconsole.log('üîç [REG-STEP DEBUG] Full config:', {\n\t\tdeviceType: config.deviceType,\n\t\tdisplayName: config.displayName,\n\t\trequiresOTP: config.requiresOTP,\n\t\tconfigObject: config\n\t});\n\t// ==============================================\n\t\n\t// ========== DEBUG: COMPONENT MOUNT ==========\n\tReact.useEffect(() => {\n\t\tconsole.log('üîç [REG-STEP DEBUG] Component mounted/updated', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasDeviceFields: !!deviceFields,\n\t\t\tfieldCount: Object.keys(deviceFields || {}).length,\n\t\t\ttokenValid: tokenStatus.isValid,\n\t\t\tisLoading\n\t\t});\n\t}, [config.deviceType, deviceFields, tokenStatus.isValid, isLoading]);\n\t// ===========================================\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle field change\n\t */\n\tconst handleFieldChange = useCallback(\n\t\t(field: string, value: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Field changed:`, field, '=', value);\n\t\t\tsetDeviceFields((prev) => ({ ...prev, [field]: value }));\n\n\t\t\t// Clear error for this field\n\t\t\tif (errors[field]) {\n\t\t\t\tsetRegistrationError(null);\n\t\t\t}\n\t\t},\n\t\t[setDeviceFields, errors]\n\t);\n\n\t/**\n\t * Handle device registration\n\t */\n\tconst handleRegisterDevice = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting device registration`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceFields,\n\t\t});\n\t\t\n\t\t// ========== DEBUG: REGISTRATION ENTRY ==========\n\t\tconsole.log('üîç [REG DEBUG] handleRegisterDevice called', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tfields: deviceFields,\n\t\t\tcredentialsEnvId: credentials.environmentId,\n\t\t\ttokenIsValid: tokenStatus.isValid\n\t\t});\n\t\t// ===============================================\n\n\t\t// Clear previous errors\n\t\tsetRegistrationError(null);\n\n\t\t// Validate fields\n\t\tif (!validate()) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed`);\n\t\t\tconsole.log('üîç [REG DEBUG] Validation failed, errors:', errors);\n\t\t\tsetRegistrationError('Please fix the errors above before continuing');\n\t\t\tnav.setValidationErrors(['Please fix the form errors']);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconsole.log('üîç [REG DEBUG] Validation passed, proceeding with registration');\n\n\t\t// Set loading state\n\t\tsetIsLoading(true);\n\n\t\ttry {\n\t\t\t// Merge device fields into credentials\n\t\t\tconst updatedCredentials = {\n\t\t\t\t...credentials,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t\t...deviceFields,\n\t\t\t};\n\n\t\t\t// Update credentials\n\t\t\tsetCredentials(updatedCredentials);\n\n\t\t\tconsole.log(`${MODULE_TAG} Calling controller.registerDevice`);\n\n\t\t\t// Call controller to register device\n\t\t\tconst result = await controller.registerDevice(\n\t\t\t\tupdatedCredentials,\n\t\t\t\tmfaState,\n\t\t\t\ttokenStatus,\n\t\t\t\tnav\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Device registered successfully:`, result);\n\t\t\n\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\tif (config.deviceType === 'TOTP') {\n\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result:', {\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tqrCode: result.qrCode,\n\t\t\t\tqrCodeUrl: result.qrCodeUrl,\n\t\t\t\tsecret: result.secret,\n\t\t\t\ttotpSecret: result.totpSecret,\n\t\t\t\tfullResult: result\n\t\t\t});\n\t\t}\n\t\t// ===============================================\n\n\t\t// Update MFA state with registration result\n\t\tsetMfaState((prev) => {\n\t\t\tconst newState = {\n\t\t\t\t...prev,\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tdeviceStatus: computeDeviceStatus(result.status, config.deviceType, tokenStatus.type),\n\t\t\t\t// TOTP-specific data (preserve QR/secret for user to scan)\n\t\t\t\tqrCodeUrl: result.qrCode || result.qrCodeUrl,\n\t\t\t\ttotpSecret: result.secret || result.totpSecret,\n\t\t\t\t// If we have TOTP data, surface the QR/secret immediately\n\t\t\t\tshowQr: config.deviceType === 'TOTP' && (result.qrCode || result.secret || result.totpSecret),\n\t\t\t\t// FIDO2-specific data\n\t\t\t\tpublicKeyCredentialCreationOptions: result.publicKeyCredentialCreationOptions,\n\t\t\t\t// Mobile-specific data\n\t\t\t\tpairingKey: result.pairingKey,\n\t\t\t\t// Links for activation\n\t\t\t\tactivationLinks: result._links,\n\t\t\t};\n\t\t\t\n\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\tif (config.deviceType === 'TOTP') {\n\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\tfullState: newState\n\t\t\t\t});\n\t\t\t}\n\t\t\t// ================================================\n\t\t\t\n\t\t\treturn newState;\n\t\t});\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} device registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step (activation)\n\t\t\tnav.goToNext();\n\t\t} catch (error: any) {\n\t\t\tconsole.error(`${MODULE_TAG} Device registration failed:`, error);\n\n\t\t\tconst errorMessage = error.message || `Failed to register ${config.displayName} device`;\n\n\t\t\tsetRegistrationError(errorMessage);\n\t\t\tnav.setValidationErrors([errorMessage]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [\n\t\tconfig, \n\t\tdeviceFields, \n\t\tcredentials, \n\t\tsetCredentials, \n\t\tmfaState, \n\t\tsetMfaState, \n\t\ttokenStatus, \n\t\tnav, \n\t\tcontroller, \n\t\tvalidate, \n\t\tsetIsLoading, errors\n\t]);\n\n\t/**\n\t * Handle registration success (for custom components)\n\t */\n\tconst handleRegistrationSuccess = useCallback(\n\t\t(data: any) => {\n\t\t\tconsole.log(`${MODULE_TAG} Custom component registration success:`, data);\n\n\t\t\t// Update MFA state\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t...data,\n\t\t\t}));\n\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step\n\t\t\tnav.goToNext();\n\t\t},\n\t\t[config, setMfaState, nav]\n\t);\n\n\t/**\n\t * Handle registration error (for custom components)\n\t */\n\tconst handleRegistrationError = useCallback(\n\t\t(error: string) => {\n\t\t\tconsole.error(`${MODULE_TAG} Custom component registration error:`, error);\n\n\t\t\tsetRegistrationError(error);\n\t\t\tnav.setValidationErrors([error]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(error);\n\t\t},\n\t\t[nav]\n\t);\n\n\t// ========================================================================\n\t// RENDER UI LOGIC\n\t// ========================================================================\n\n\t/**\n\t * Render registration UI based on device type\n\t */\n\tconst renderRegistrationUI = () => {\n\t\t// Check if this device type has a custom component\n\t\tconst CustomComponent = DeviceComponentRegistry[config.deviceType];\n\t\t\n\t\t// ========== DEBUG: REGISTRATION UI PATH ==========\n\t\tconsole.log('üîç [REG-UI DEBUG] Rendering path:', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasCustomComponent: !!CustomComponent,\n\t\t\twillUseDynamicForm: !CustomComponent,\n\t\t\tregistryValue: CustomComponent\n\t\t});\n\t\t// ================================================\n\n\t\tif (CustomComponent) {\n\t\t\t// Use device-specific custom component (TOTP, FIDO2, Mobile)\n\t\t\tconsole.log(`${MODULE_TAG} Using custom component for:`, config.deviceType);\n\n\t\t\tconst customComponentProps: DeviceComponentProps = {\n\t\t\t\tcredentials,\n\t\t\t\tmfaState,\n\t\t\t\tsetMfaState,\n\t\t\t\tonSuccess: handleRegistrationSuccess,\n\t\t\t\tonError: handleRegistrationError,\n\t\t\t\tcontroller,\n\t\t\t\tconfig,\n\t\t\t};\n\n\t\t\treturn <CustomComponent {...customComponentProps} />;\n\t\t} else {\n\t\t\t// Use dynamic form renderer (SMS, Email, WhatsApp)\n\t\t\tconsole.log(`${MODULE_TAG} Using dynamic form renderer for:`, config.deviceType);\n\n\t\t\treturn (\n\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\tconfig={config}\n\t\t\t\t\tvalues={deviceFields || {}}\n\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\terrors={errors}\n\t\t\t\t\tonTouch={touchField}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t/>\n\t\t\t);\n\t\t}\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-registration-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">{config.description}</p>\n\t\t\t</div>\n\n\t\t\t{/* Registration UI (dynamic form or custom component) */}\n\t\t\t<div className=\"registration-ui\">{renderRegistrationUI()}</div>\n\n\t\t\t{/* Registration Error */}\n\t\t\t{registrationError && (\n\t\t\t\t<div className=\"registration-error\" role=\"alert\">\n\t\t\t\t\t<strong>Registration Failed:</strong> {registrationError}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Info */}\n\t\t\t<div style={{ \n\t\t\t\tpadding: '12px 16px', \n\t\t\t\tbackground: '#eff6ff', \n\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\tborderRadius: '6px',\n\t\t\t\tmarginBottom: '16px',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tcolor: '#1e40af'\n\t\t\t}}>\n\t\t\t{config.deviceType === 'FIDO2' ? (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will create your {config.displayName} device, then you'll complete biometric authentication.</>\n\t\t\t) : (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will register your {config.displayName} device and send the activation code.</>\n\t\t\t)}\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleRegisterDevice}\n\t\t\t\t\tdisabled={isLoading || !tokenStatus.isValid}\n\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Registering...' : 'Next Step ‚ñ∂'}\n\t\t\t\t</button>\n\t\t\t</div>!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)\n\t\t</div>\n\t);\n};\n\nexport default UnifiedRegistrationStep;\n"}}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedRegistrationStep.tsx"},"span":[13162,13163],"sourceCode":"/**\n * @file UnifiedRegistrationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 2: Device Registration - Unified registration for all device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle device registration for all 6 device types using either:\n * - DynamicFormRenderer (for SMS, Email, WhatsApp)\n * - Custom components (for TOTP, FIDO2, Mobile)\n *\n * Flow:\n * 1. Render appropriate UI based on device type\n * 2. Collect and validate device-specific information\n * 3. Call controller.registerDevice()\n * 4. Update mfaState with registration result\n * 5. Navigate to activation step\n *\n * @example\n * <UnifiedRegistrationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n *   deviceFields={deviceFields}\n *   setDeviceFields={setDeviceFields}\n *   errors={errors}\n *   validate={validate}\n * />\n */\n\nimport React, { useCallback, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type DeviceComponentProps, DeviceComponentRegistry } from './DeviceComponentRegistry';\nimport { DynamicFormRenderer } from './DynamicFormRenderer';\n\nconst MODULE_TAG = '[üìù UNIFIED-REGISTRATION-STEP]';\n\n// Exported helper to determine final device status after registration\nexport function computeDeviceStatus(resultStatus: string | undefined, deviceType: string, tokenType: string) {\n\tconst status = resultStatus || '';\n\tif (deviceType === 'TOTP') {\n\t\t// User flows must require activation\n\t\tif (tokenType === 'user') return 'ACTIVATION_REQUIRED';\n\t\t// For admin/worker flows, prefer returned status, but default to ACTIVATION_REQUIRED\n\t\treturn status || 'ACTIVATION_REQUIRED';\n\t}\n\treturn status || 'ACTIVE';\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedRegistrationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device-specific form field values */\n\tdeviceFields: Record<string, string>;\n\n\t/** Update device fields */\n\tsetDeviceFields: (\n\t\tfields: Record<string, string> | ((prev: Record<string, string>) => Record<string, string>)\n\t) => void;\n\n\t/** Validation errors */\n\terrors: Record<string, string>;\n\n\t/** Validation function */\n\tvalidate: () => boolean;\n\n\t/** Touch field callback (for validation) */\n\ttouchField?: (field: string) => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Registration Step (Step 2)\n *\n * Handles device registration for all device types using configuration-driven\n * rendering (DynamicFormRenderer) or custom components (TOTP, FIDO2, Mobile).\n */\nexport const UnifiedRegistrationStep: React.FC<UnifiedRegistrationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n\tdeviceFields,\n\tsetDeviceFields,\n\terrors,\n\tvalidate,\n\ttouchField,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering registration step for:`, config.deviceType);\n\t\n\t// ========== DEBUG: FULL CONFIG CHECK ==========\n\tconsole.log('üîç [REG-STEP DEBUG] Full config:', {\n\t\tdeviceType: config.deviceType,\n\t\tdisplayName: config.displayName,\n\t\trequiresOTP: config.requiresOTP,\n\t\tconfigObject: config\n\t});\n\t// ==============================================\n\t\n\t// ========== DEBUG: COMPONENT MOUNT ==========\n\tReact.useEffect(() => {\n\t\tconsole.log('üîç [REG-STEP DEBUG] Component mounted/updated', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasDeviceFields: !!deviceFields,\n\t\t\tfieldCount: Object.keys(deviceFields || {}).length,\n\t\t\ttokenValid: tokenStatus.isValid,\n\t\t\tisLoading\n\t\t});\n\t}, [config.deviceType, deviceFields, tokenStatus.isValid, isLoading]);\n\t// ===========================================\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle field change\n\t */\n\tconst handleFieldChange = useCallback(\n\t\t(field: string, value: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Field changed:`, field, '=', value);\n\t\t\tsetDeviceFields((prev) => ({ ...prev, [field]: value }));\n\n\t\t\t// Clear error for this field\n\t\t\tif (errors[field]) {\n\t\t\t\tsetRegistrationError(null);\n\t\t\t}\n\t\t},\n\t\t[setDeviceFields, errors]\n\t);\n\n\t/**\n\t * Handle device registration\n\t */\n\tconst handleRegisterDevice = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting device registration`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceFields,\n\t\t});\n\t\t\n\t\t// ========== DEBUG: REGISTRATION ENTRY ==========\n\t\tconsole.log('üîç [REG DEBUG] handleRegisterDevice called', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tfields: deviceFields,\n\t\t\tcredentialsEnvId: credentials.environmentId,\n\t\t\ttokenIsValid: tokenStatus.isValid\n\t\t});\n\t\t// ===============================================\n\n\t\t// Clear previous errors\n\t\tsetRegistrationError(null);\n\n\t\t// Validate fields\n\t\tif (!validate()) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed`);\n\t\t\tconsole.log('üîç [REG DEBUG] Validation failed, errors:', errors);\n\t\t\tsetRegistrationError('Please fix the errors above before continuing');\n\t\t\tnav.setValidationErrors(['Please fix the form errors']);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconsole.log('üîç [REG DEBUG] Validation passed, proceeding with registration');\n\n\t\t// Set loading state\n\t\tsetIsLoading(true);\n\n\t\ttry {\n\t\t\t// Merge device fields into credentials\n\t\t\tconst updatedCredentials = {\n\t\t\t\t...credentials,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t\t...deviceFields,\n\t\t\t};\n\n\t\t\t// Update credentials\n\t\t\tsetCredentials(updatedCredentials);\n\n\t\t\tconsole.log(`${MODULE_TAG} Calling controller.registerDevice`);\n\n\t\t\t// Call controller to register device\n\t\t\tconst result = await controller.registerDevice(\n\t\t\t\tupdatedCredentials,\n\t\t\t\tmfaState,\n\t\t\t\ttokenStatus,\n\t\t\t\tnav\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Device registered successfully:`, result);\n\t\t\n\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\tif (config.deviceType === 'TOTP') {\n\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result:', {\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tqrCode: result.qrCode,\n\t\t\t\tqrCodeUrl: result.qrCodeUrl,\n\t\t\t\tsecret: result.secret,\n\t\t\t\ttotpSecret: result.totpSecret,\n\t\t\t\tfullResult: result\n\t\t\t});\n\t\t}\n\t\t// ===============================================\n\n\t\t// Update MFA state with registration result\n\t\tsetMfaState((prev) => {\n\t\t\tconst newState = {\n\t\t\t\t...prev,\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tdeviceStatus: computeDeviceStatus(result.status, config.deviceType, tokenStatus.type),\n\t\t\t\t// TOTP-specific data (preserve QR/secret for user to scan)\n\t\t\t\tqrCodeUrl: result.qrCode || result.qrCodeUrl,\n\t\t\t\ttotpSecret: result.secret || result.totpSecret,\n\t\t\t\t// If we have TOTP data, surface the QR/secret immediately\n\t\t\t\tshowQr: config.deviceType === 'TOTP' && (result.qrCode || result.secret || result.totpSecret),\n\t\t\t\t// FIDO2-specific data\n\t\t\t\tpublicKeyCredentialCreationOptions: result.publicKeyCredentialCreationOptions,\n\t\t\t\t// Mobile-specific data\n\t\t\t\tpairingKey: result.pairingKey,\n\t\t\t\t// Links for activation\n\t\t\t\tactivationLinks: result._links,\n\t\t\t};\n\t\t\t\n\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\tif (config.deviceType === 'TOTP') {\n\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\tfullState: newState\n\t\t\t\t});\n\t\t\t}\n\t\t\t// ================================================\n\t\t\t\n\t\t\treturn newState;\n\t\t});\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} device registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step (activation)\n\t\t\tnav.goToNext();\n\t\t} catch (error: any) {\n\t\t\tconsole.error(`${MODULE_TAG} Device registration failed:`, error);\n\n\t\t\tconst errorMessage = error.message || `Failed to register ${config.displayName} device`;\n\n\t\t\tsetRegistrationError(errorMessage);\n\t\t\tnav.setValidationErrors([errorMessage]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [\n\t\tconfig, \n\t\tdeviceFields, \n\t\tcredentials, \n\t\tsetCredentials, \n\t\tmfaState, \n\t\tsetMfaState, \n\t\ttokenStatus, \n\t\tnav, \n\t\tcontroller, \n\t\tvalidate, \n\t\tsetIsLoading, errors\n\t]);\n\n\t/**\n\t * Handle registration success (for custom components)\n\t */\n\tconst handleRegistrationSuccess = useCallback(\n\t\t(data: any) => {\n\t\t\tconsole.log(`${MODULE_TAG} Custom component registration success:`, data);\n\n\t\t\t// Update MFA state\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t...data,\n\t\t\t}));\n\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step\n\t\t\tnav.goToNext();\n\t\t},\n\t\t[config, setMfaState, nav]\n\t);\n\n\t/**\n\t * Handle registration error (for custom components)\n\t */\n\tconst handleRegistrationError = useCallback(\n\t\t(error: string) => {\n\t\t\tconsole.error(`${MODULE_TAG} Custom component registration error:`, error);\n\n\t\t\tsetRegistrationError(error);\n\t\t\tnav.setValidationErrors([error]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(error);\n\t\t},\n\t\t[nav]\n\t);\n\n\t// ========================================================================\n\t// RENDER UI LOGIC\n\t// ========================================================================\n\n\t/**\n\t * Render registration UI based on device type\n\t */\n\tconst renderRegistrationUI = () => {\n\t\t// Check if this device type has a custom component\n\t\tconst CustomComponent = DeviceComponentRegistry[config.deviceType];\n\t\t\n\t\t// ========== DEBUG: REGISTRATION UI PATH ==========\n\t\tconsole.log('üîç [REG-UI DEBUG] Rendering path:', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasCustomComponent: !!CustomComponent,\n\t\t\twillUseDynamicForm: !CustomComponent,\n\t\t\tregistryValue: CustomComponent\n\t\t});\n\t\t// ================================================\n\n\t\tif (CustomComponent) {\n\t\t\t// Use device-specific custom component (TOTP, FIDO2, Mobile)\n\t\t\tconsole.log(`${MODULE_TAG} Using custom component for:`, config.deviceType);\n\n\t\t\tconst customComponentProps: DeviceComponentProps = {\n\t\t\t\tcredentials,\n\t\t\t\tmfaState,\n\t\t\t\tsetMfaState,\n\t\t\t\tonSuccess: handleRegistrationSuccess,\n\t\t\t\tonError: handleRegistrationError,\n\t\t\t\tcontroller,\n\t\t\t\tconfig,\n\t\t\t};\n\n\t\t\treturn <CustomComponent {...customComponentProps} />;\n\t\t} else {\n\t\t\t// Use dynamic form renderer (SMS, Email, WhatsApp)\n\t\t\tconsole.log(`${MODULE_TAG} Using dynamic form renderer for:`, config.deviceType);\n\n\t\t\treturn (\n\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\tconfig={config}\n\t\t\t\t\tvalues={deviceFields || {}}\n\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\terrors={errors}\n\t\t\t\t\tonTouch={touchField}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t/>\n\t\t\t);\n\t\t}\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-registration-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">{config.description}</p>\n\t\t\t</div>\n\n\t\t\t{/* Registration UI (dynamic form or custom component) */}\n\t\t\t<div className=\"registration-ui\">{renderRegistrationUI()}</div>\n\n\t\t\t{/* Registration Error */}\n\t\t\t{registrationError && (\n\t\t\t\t<div className=\"registration-error\" role=\"alert\">\n\t\t\t\t\t<strong>Registration Failed:</strong> {registrationError}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Info */}\n\t\t\t<div style={{ \n\t\t\t\tpadding: '12px 16px', \n\t\t\t\tbackground: '#eff6ff', \n\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\tborderRadius: '6px',\n\t\t\t\tmarginBottom: '16px',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tcolor: '#1e40af'\n\t\t\t}}>\n\t\t\t{config.deviceType === 'FIDO2' ? (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will create your {config.displayName} device, then you'll complete biometric authentication.</>\n\t\t\t) : (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will register your {config.displayName} device and send the activation code.</>\n\t\t\t)}\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleRegisterDevice}\n\t\t\t\t\tdisabled={isLoading || !tokenStatus.isValid}\n\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Registering...' : 'Next Step ‚ñ∂'}\n\t\t\t\t</button>\n\t\t\t</div>!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)\n\t\t</div>\n\t);\n};\n\nexport default UnifiedRegistrationStep;\n"},"tags":[],"source":null},{"category":"parse","severity":"error","description":"Expected corresponding JSX closing tag for 'div'.","message":[{"elements":[],"content":"Expected corresponding JSX closing tag for 'div'."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Opening tag"}]]},{"frame":{"path":null,"span":[12210,12413],"sourceCode":"/**\n * @file UnifiedRegistrationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 2: Device Registration - Unified registration for all device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle device registration for all 6 device types using either:\n * - DynamicFormRenderer (for SMS, Email, WhatsApp)\n * - Custom components (for TOTP, FIDO2, Mobile)\n *\n * Flow:\n * 1. Render appropriate UI based on device type\n * 2. Collect and validate device-specific information\n * 3. Call controller.registerDevice()\n * 4. Update mfaState with registration result\n * 5. Navigate to activation step\n *\n * @example\n * <UnifiedRegistrationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n *   deviceFields={deviceFields}\n *   setDeviceFields={setDeviceFields}\n *   errors={errors}\n *   validate={validate}\n * />\n */\n\nimport React, { useCallback, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type DeviceComponentProps, DeviceComponentRegistry } from './DeviceComponentRegistry';\nimport { DynamicFormRenderer } from './DynamicFormRenderer';\n\nconst MODULE_TAG = '[üìù UNIFIED-REGISTRATION-STEP]';\n\n// Exported helper to determine final device status after registration\nexport function computeDeviceStatus(resultStatus: string | undefined, deviceType: string, tokenType: string) {\n\tconst status = resultStatus || '';\n\tif (deviceType === 'TOTP') {\n\t\t// User flows must require activation\n\t\tif (tokenType === 'user') return 'ACTIVATION_REQUIRED';\n\t\t// For admin/worker flows, prefer returned status, but default to ACTIVATION_REQUIRED\n\t\treturn status || 'ACTIVATION_REQUIRED';\n\t}\n\treturn status || 'ACTIVE';\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedRegistrationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device-specific form field values */\n\tdeviceFields: Record<string, string>;\n\n\t/** Update device fields */\n\tsetDeviceFields: (\n\t\tfields: Record<string, string> | ((prev: Record<string, string>) => Record<string, string>)\n\t) => void;\n\n\t/** Validation errors */\n\terrors: Record<string, string>;\n\n\t/** Validation function */\n\tvalidate: () => boolean;\n\n\t/** Touch field callback (for validation) */\n\ttouchField?: (field: string) => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Registration Step (Step 2)\n *\n * Handles device registration for all device types using configuration-driven\n * rendering (DynamicFormRenderer) or custom components (TOTP, FIDO2, Mobile).\n */\nexport const UnifiedRegistrationStep: React.FC<UnifiedRegistrationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n\tdeviceFields,\n\tsetDeviceFields,\n\terrors,\n\tvalidate,\n\ttouchField,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering registration step for:`, config.deviceType);\n\t\n\t// ========== DEBUG: FULL CONFIG CHECK ==========\n\tconsole.log('üîç [REG-STEP DEBUG] Full config:', {\n\t\tdeviceType: config.deviceType,\n\t\tdisplayName: config.displayName,\n\t\trequiresOTP: config.requiresOTP,\n\t\tconfigObject: config\n\t});\n\t// ==============================================\n\t\n\t// ========== DEBUG: COMPONENT MOUNT ==========\n\tReact.useEffect(() => {\n\t\tconsole.log('üîç [REG-STEP DEBUG] Component mounted/updated', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasDeviceFields: !!deviceFields,\n\t\t\tfieldCount: Object.keys(deviceFields || {}).length,\n\t\t\ttokenValid: tokenStatus.isValid,\n\t\t\tisLoading\n\t\t});\n\t}, [config.deviceType, deviceFields, tokenStatus.isValid, isLoading]);\n\t// ===========================================\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle field change\n\t */\n\tconst handleFieldChange = useCallback(\n\t\t(field: string, value: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Field changed:`, field, '=', value);\n\t\t\tsetDeviceFields((prev) => ({ ...prev, [field]: value }));\n\n\t\t\t// Clear error for this field\n\t\t\tif (errors[field]) {\n\t\t\t\tsetRegistrationError(null);\n\t\t\t}\n\t\t},\n\t\t[setDeviceFields, errors]\n\t);\n\n\t/**\n\t * Handle device registration\n\t */\n\tconst handleRegisterDevice = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting device registration`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceFields,\n\t\t});\n\t\t\n\t\t// ========== DEBUG: REGISTRATION ENTRY ==========\n\t\tconsole.log('üîç [REG DEBUG] handleRegisterDevice called', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tfields: deviceFields,\n\t\t\tcredentialsEnvId: credentials.environmentId,\n\t\t\ttokenIsValid: tokenStatus.isValid\n\t\t});\n\t\t// ===============================================\n\n\t\t// Clear previous errors\n\t\tsetRegistrationError(null);\n\n\t\t// Validate fields\n\t\tif (!validate()) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed`);\n\t\t\tconsole.log('üîç [REG DEBUG] Validation failed, errors:', errors);\n\t\t\tsetRegistrationError('Please fix the errors above before continuing');\n\t\t\tnav.setValidationErrors(['Please fix the form errors']);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconsole.log('üîç [REG DEBUG] Validation passed, proceeding with registration');\n\n\t\t// Set loading state\n\t\tsetIsLoading(true);\n\n\t\ttry {\n\t\t\t// Merge device fields into credentials\n\t\t\tconst updatedCredentials = {\n\t\t\t\t...credentials,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t\t...deviceFields,\n\t\t\t};\n\n\t\t\t// Update credentials\n\t\t\tsetCredentials(updatedCredentials);\n\n\t\t\tconsole.log(`${MODULE_TAG} Calling controller.registerDevice`);\n\n\t\t\t// Call controller to register device\n\t\t\tconst result = await controller.registerDevice(\n\t\t\t\tupdatedCredentials,\n\t\t\t\tmfaState,\n\t\t\t\ttokenStatus,\n\t\t\t\tnav\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Device registered successfully:`, result);\n\t\t\n\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\tif (config.deviceType === 'TOTP') {\n\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result:', {\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tqrCode: result.qrCode,\n\t\t\t\tqrCodeUrl: result.qrCodeUrl,\n\t\t\t\tsecret: result.secret,\n\t\t\t\ttotpSecret: result.totpSecret,\n\t\t\t\tfullResult: result\n\t\t\t});\n\t\t}\n\t\t// ===============================================\n\n\t\t// Update MFA state with registration result\n\t\tsetMfaState((prev) => {\n\t\t\tconst newState = {\n\t\t\t\t...prev,\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tdeviceStatus: computeDeviceStatus(result.status, config.deviceType, tokenStatus.type),\n\t\t\t\t// TOTP-specific data (preserve QR/secret for user to scan)\n\t\t\t\tqrCodeUrl: result.qrCode || result.qrCodeUrl,\n\t\t\t\ttotpSecret: result.secret || result.totpSecret,\n\t\t\t\t// If we have TOTP data, surface the QR/secret immediately\n\t\t\t\tshowQr: config.deviceType === 'TOTP' && (result.qrCode || result.secret || result.totpSecret),\n\t\t\t\t// FIDO2-specific data\n\t\t\t\tpublicKeyCredentialCreationOptions: result.publicKeyCredentialCreationOptions,\n\t\t\t\t// Mobile-specific data\n\t\t\t\tpairingKey: result.pairingKey,\n\t\t\t\t// Links for activation\n\t\t\t\tactivationLinks: result._links,\n\t\t\t};\n\t\t\t\n\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\tif (config.deviceType === 'TOTP') {\n\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\tfullState: newState\n\t\t\t\t});\n\t\t\t}\n\t\t\t// ================================================\n\t\t\t\n\t\t\treturn newState;\n\t\t});\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} device registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step (activation)\n\t\t\tnav.goToNext();\n\t\t} catch (error: any) {\n\t\t\tconsole.error(`${MODULE_TAG} Device registration failed:`, error);\n\n\t\t\tconst errorMessage = error.message || `Failed to register ${config.displayName} device`;\n\n\t\t\tsetRegistrationError(errorMessage);\n\t\t\tnav.setValidationErrors([errorMessage]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [\n\t\tconfig, \n\t\tdeviceFields, \n\t\tcredentials, \n\t\tsetCredentials, \n\t\tmfaState, \n\t\tsetMfaState, \n\t\ttokenStatus, \n\t\tnav, \n\t\tcontroller, \n\t\tvalidate, \n\t\tsetIsLoading, errors\n\t]);\n\n\t/**\n\t * Handle registration success (for custom components)\n\t */\n\tconst handleRegistrationSuccess = useCallback(\n\t\t(data: any) => {\n\t\t\tconsole.log(`${MODULE_TAG} Custom component registration success:`, data);\n\n\t\t\t// Update MFA state\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t...data,\n\t\t\t}));\n\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step\n\t\t\tnav.goToNext();\n\t\t},\n\t\t[config, setMfaState, nav]\n\t);\n\n\t/**\n\t * Handle registration error (for custom components)\n\t */\n\tconst handleRegistrationError = useCallback(\n\t\t(error: string) => {\n\t\t\tconsole.error(`${MODULE_TAG} Custom component registration error:`, error);\n\n\t\t\tsetRegistrationError(error);\n\t\t\tnav.setValidationErrors([error]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(error);\n\t\t},\n\t\t[nav]\n\t);\n\n\t// ========================================================================\n\t// RENDER UI LOGIC\n\t// ========================================================================\n\n\t/**\n\t * Render registration UI based on device type\n\t */\n\tconst renderRegistrationUI = () => {\n\t\t// Check if this device type has a custom component\n\t\tconst CustomComponent = DeviceComponentRegistry[config.deviceType];\n\t\t\n\t\t// ========== DEBUG: REGISTRATION UI PATH ==========\n\t\tconsole.log('üîç [REG-UI DEBUG] Rendering path:', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasCustomComponent: !!CustomComponent,\n\t\t\twillUseDynamicForm: !CustomComponent,\n\t\t\tregistryValue: CustomComponent\n\t\t});\n\t\t// ================================================\n\n\t\tif (CustomComponent) {\n\t\t\t// Use device-specific custom component (TOTP, FIDO2, Mobile)\n\t\t\tconsole.log(`${MODULE_TAG} Using custom component for:`, config.deviceType);\n\n\t\t\tconst customComponentProps: DeviceComponentProps = {\n\t\t\t\tcredentials,\n\t\t\t\tmfaState,\n\t\t\t\tsetMfaState,\n\t\t\t\tonSuccess: handleRegistrationSuccess,\n\t\t\t\tonError: handleRegistrationError,\n\t\t\t\tcontroller,\n\t\t\t\tconfig,\n\t\t\t};\n\n\t\t\treturn <CustomComponent {...customComponentProps} />;\n\t\t} else {\n\t\t\t// Use dynamic form renderer (SMS, Email, WhatsApp)\n\t\t\tconsole.log(`${MODULE_TAG} Using dynamic form renderer for:`, config.deviceType);\n\n\t\t\treturn (\n\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\tconfig={config}\n\t\t\t\t\tvalues={deviceFields || {}}\n\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\terrors={errors}\n\t\t\t\t\tonTouch={touchField}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t/>\n\t\t\t);\n\t\t}\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-registration-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">{config.description}</p>\n\t\t\t</div>\n\n\t\t\t{/* Registration UI (dynamic form or custom component) */}\n\t\t\t<div className=\"registration-ui\">{renderRegistrationUI()}</div>\n\n\t\t\t{/* Registration Error */}\n\t\t\t{registrationError && (\n\t\t\t\t<div className=\"registration-error\" role=\"alert\">\n\t\t\t\t\t<strong>Registration Failed:</strong> {registrationError}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Info */}\n\t\t\t<div style={{ \n\t\t\t\tpadding: '12px 16px', \n\t\t\t\tbackground: '#eff6ff', \n\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\tborderRadius: '6px',\n\t\t\t\tmarginBottom: '16px',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tcolor: '#1e40af'\n\t\t\t}}>\n\t\t\t{config.deviceType === 'FIDO2' ? (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will create your {config.displayName} device, then you'll complete biometric authentication.</>\n\t\t\t) : (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will register your {config.displayName} device and send the activation code.</>\n\t\t\t)}\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleRegisterDevice}\n\t\t\t\t\tdisabled={isLoading || !tokenStatus.isValid}\n\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Registering...' : 'Next Step ‚ñ∂'}\n\t\t\t\t</button>\n\t\t\t</div>!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)\n\t\t</div>\n\t);\n};\n\nexport default UnifiedRegistrationStep;\n"}},{"log":["info",[{"elements":[],"content":"closing tag"}]]},{"frame":{"path":null,"span":[12733,12742],"sourceCode":"/**\n * @file UnifiedRegistrationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 2: Device Registration - Unified registration for all device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle device registration for all 6 device types using either:\n * - DynamicFormRenderer (for SMS, Email, WhatsApp)\n * - Custom components (for TOTP, FIDO2, Mobile)\n *\n * Flow:\n * 1. Render appropriate UI based on device type\n * 2. Collect and validate device-specific information\n * 3. Call controller.registerDevice()\n * 4. Update mfaState with registration result\n * 5. Navigate to activation step\n *\n * @example\n * <UnifiedRegistrationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n *   deviceFields={deviceFields}\n *   setDeviceFields={setDeviceFields}\n *   errors={errors}\n *   validate={validate}\n * />\n */\n\nimport React, { useCallback, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type DeviceComponentProps, DeviceComponentRegistry } from './DeviceComponentRegistry';\nimport { DynamicFormRenderer } from './DynamicFormRenderer';\n\nconst MODULE_TAG = '[üìù UNIFIED-REGISTRATION-STEP]';\n\n// Exported helper to determine final device status after registration\nexport function computeDeviceStatus(resultStatus: string | undefined, deviceType: string, tokenType: string) {\n\tconst status = resultStatus || '';\n\tif (deviceType === 'TOTP') {\n\t\t// User flows must require activation\n\t\tif (tokenType === 'user') return 'ACTIVATION_REQUIRED';\n\t\t// For admin/worker flows, prefer returned status, but default to ACTIVATION_REQUIRED\n\t\treturn status || 'ACTIVATION_REQUIRED';\n\t}\n\treturn status || 'ACTIVE';\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedRegistrationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device-specific form field values */\n\tdeviceFields: Record<string, string>;\n\n\t/** Update device fields */\n\tsetDeviceFields: (\n\t\tfields: Record<string, string> | ((prev: Record<string, string>) => Record<string, string>)\n\t) => void;\n\n\t/** Validation errors */\n\terrors: Record<string, string>;\n\n\t/** Validation function */\n\tvalidate: () => boolean;\n\n\t/** Touch field callback (for validation) */\n\ttouchField?: (field: string) => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Registration Step (Step 2)\n *\n * Handles device registration for all device types using configuration-driven\n * rendering (DynamicFormRenderer) or custom components (TOTP, FIDO2, Mobile).\n */\nexport const UnifiedRegistrationStep: React.FC<UnifiedRegistrationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n\tdeviceFields,\n\tsetDeviceFields,\n\terrors,\n\tvalidate,\n\ttouchField,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering registration step for:`, config.deviceType);\n\t\n\t// ========== DEBUG: FULL CONFIG CHECK ==========\n\tconsole.log('üîç [REG-STEP DEBUG] Full config:', {\n\t\tdeviceType: config.deviceType,\n\t\tdisplayName: config.displayName,\n\t\trequiresOTP: config.requiresOTP,\n\t\tconfigObject: config\n\t});\n\t// ==============================================\n\t\n\t// ========== DEBUG: COMPONENT MOUNT ==========\n\tReact.useEffect(() => {\n\t\tconsole.log('üîç [REG-STEP DEBUG] Component mounted/updated', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasDeviceFields: !!deviceFields,\n\t\t\tfieldCount: Object.keys(deviceFields || {}).length,\n\t\t\ttokenValid: tokenStatus.isValid,\n\t\t\tisLoading\n\t\t});\n\t}, [config.deviceType, deviceFields, tokenStatus.isValid, isLoading]);\n\t// ===========================================\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle field change\n\t */\n\tconst handleFieldChange = useCallback(\n\t\t(field: string, value: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Field changed:`, field, '=', value);\n\t\t\tsetDeviceFields((prev) => ({ ...prev, [field]: value }));\n\n\t\t\t// Clear error for this field\n\t\t\tif (errors[field]) {\n\t\t\t\tsetRegistrationError(null);\n\t\t\t}\n\t\t},\n\t\t[setDeviceFields, errors]\n\t);\n\n\t/**\n\t * Handle device registration\n\t */\n\tconst handleRegisterDevice = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting device registration`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceFields,\n\t\t});\n\t\t\n\t\t// ========== DEBUG: REGISTRATION ENTRY ==========\n\t\tconsole.log('üîç [REG DEBUG] handleRegisterDevice called', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tfields: deviceFields,\n\t\t\tcredentialsEnvId: credentials.environmentId,\n\t\t\ttokenIsValid: tokenStatus.isValid\n\t\t});\n\t\t// ===============================================\n\n\t\t// Clear previous errors\n\t\tsetRegistrationError(null);\n\n\t\t// Validate fields\n\t\tif (!validate()) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed`);\n\t\t\tconsole.log('üîç [REG DEBUG] Validation failed, errors:', errors);\n\t\t\tsetRegistrationError('Please fix the errors above before continuing');\n\t\t\tnav.setValidationErrors(['Please fix the form errors']);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconsole.log('üîç [REG DEBUG] Validation passed, proceeding with registration');\n\n\t\t// Set loading state\n\t\tsetIsLoading(true);\n\n\t\ttry {\n\t\t\t// Merge device fields into credentials\n\t\t\tconst updatedCredentials = {\n\t\t\t\t...credentials,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t\t...deviceFields,\n\t\t\t};\n\n\t\t\t// Update credentials\n\t\t\tsetCredentials(updatedCredentials);\n\n\t\t\tconsole.log(`${MODULE_TAG} Calling controller.registerDevice`);\n\n\t\t\t// Call controller to register device\n\t\t\tconst result = await controller.registerDevice(\n\t\t\t\tupdatedCredentials,\n\t\t\t\tmfaState,\n\t\t\t\ttokenStatus,\n\t\t\t\tnav\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Device registered successfully:`, result);\n\t\t\n\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\tif (config.deviceType === 'TOTP') {\n\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result:', {\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tqrCode: result.qrCode,\n\t\t\t\tqrCodeUrl: result.qrCodeUrl,\n\t\t\t\tsecret: result.secret,\n\t\t\t\ttotpSecret: result.totpSecret,\n\t\t\t\tfullResult: result\n\t\t\t});\n\t\t}\n\t\t// ===============================================\n\n\t\t// Update MFA state with registration result\n\t\tsetMfaState((prev) => {\n\t\t\tconst newState = {\n\t\t\t\t...prev,\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tdeviceStatus: computeDeviceStatus(result.status, config.deviceType, tokenStatus.type),\n\t\t\t\t// TOTP-specific data (preserve QR/secret for user to scan)\n\t\t\t\tqrCodeUrl: result.qrCode || result.qrCodeUrl,\n\t\t\t\ttotpSecret: result.secret || result.totpSecret,\n\t\t\t\t// If we have TOTP data, surface the QR/secret immediately\n\t\t\t\tshowQr: config.deviceType === 'TOTP' && (result.qrCode || result.secret || result.totpSecret),\n\t\t\t\t// FIDO2-specific data\n\t\t\t\tpublicKeyCredentialCreationOptions: result.publicKeyCredentialCreationOptions,\n\t\t\t\t// Mobile-specific data\n\t\t\t\tpairingKey: result.pairingKey,\n\t\t\t\t// Links for activation\n\t\t\t\tactivationLinks: result._links,\n\t\t\t};\n\t\t\t\n\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\tif (config.deviceType === 'TOTP') {\n\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\tfullState: newState\n\t\t\t\t});\n\t\t\t}\n\t\t\t// ================================================\n\t\t\t\n\t\t\treturn newState;\n\t\t});\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} device registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step (activation)\n\t\t\tnav.goToNext();\n\t\t} catch (error: any) {\n\t\t\tconsole.error(`${MODULE_TAG} Device registration failed:`, error);\n\n\t\t\tconst errorMessage = error.message || `Failed to register ${config.displayName} device`;\n\n\t\t\tsetRegistrationError(errorMessage);\n\t\t\tnav.setValidationErrors([errorMessage]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [\n\t\tconfig, \n\t\tdeviceFields, \n\t\tcredentials, \n\t\tsetCredentials, \n\t\tmfaState, \n\t\tsetMfaState, \n\t\ttokenStatus, \n\t\tnav, \n\t\tcontroller, \n\t\tvalidate, \n\t\tsetIsLoading, errors\n\t]);\n\n\t/**\n\t * Handle registration success (for custom components)\n\t */\n\tconst handleRegistrationSuccess = useCallback(\n\t\t(data: any) => {\n\t\t\tconsole.log(`${MODULE_TAG} Custom component registration success:`, data);\n\n\t\t\t// Update MFA state\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t...data,\n\t\t\t}));\n\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step\n\t\t\tnav.goToNext();\n\t\t},\n\t\t[config, setMfaState, nav]\n\t);\n\n\t/**\n\t * Handle registration error (for custom components)\n\t */\n\tconst handleRegistrationError = useCallback(\n\t\t(error: string) => {\n\t\t\tconsole.error(`${MODULE_TAG} Custom component registration error:`, error);\n\n\t\t\tsetRegistrationError(error);\n\t\t\tnav.setValidationErrors([error]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(error);\n\t\t},\n\t\t[nav]\n\t);\n\n\t// ========================================================================\n\t// RENDER UI LOGIC\n\t// ========================================================================\n\n\t/**\n\t * Render registration UI based on device type\n\t */\n\tconst renderRegistrationUI = () => {\n\t\t// Check if this device type has a custom component\n\t\tconst CustomComponent = DeviceComponentRegistry[config.deviceType];\n\t\t\n\t\t// ========== DEBUG: REGISTRATION UI PATH ==========\n\t\tconsole.log('üîç [REG-UI DEBUG] Rendering path:', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasCustomComponent: !!CustomComponent,\n\t\t\twillUseDynamicForm: !CustomComponent,\n\t\t\tregistryValue: CustomComponent\n\t\t});\n\t\t// ================================================\n\n\t\tif (CustomComponent) {\n\t\t\t// Use device-specific custom component (TOTP, FIDO2, Mobile)\n\t\t\tconsole.log(`${MODULE_TAG} Using custom component for:`, config.deviceType);\n\n\t\t\tconst customComponentProps: DeviceComponentProps = {\n\t\t\t\tcredentials,\n\t\t\t\tmfaState,\n\t\t\t\tsetMfaState,\n\t\t\t\tonSuccess: handleRegistrationSuccess,\n\t\t\t\tonError: handleRegistrationError,\n\t\t\t\tcontroller,\n\t\t\t\tconfig,\n\t\t\t};\n\n\t\t\treturn <CustomComponent {...customComponentProps} />;\n\t\t} else {\n\t\t\t// Use dynamic form renderer (SMS, Email, WhatsApp)\n\t\t\tconsole.log(`${MODULE_TAG} Using dynamic form renderer for:`, config.deviceType);\n\n\t\t\treturn (\n\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\tconfig={config}\n\t\t\t\t\tvalues={deviceFields || {}}\n\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\terrors={errors}\n\t\t\t\t\tonTouch={touchField}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t/>\n\t\t\t);\n\t\t}\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-registration-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">{config.description}</p>\n\t\t\t</div>\n\n\t\t\t{/* Registration UI (dynamic form or custom component) */}\n\t\t\t<div className=\"registration-ui\">{renderRegistrationUI()}</div>\n\n\t\t\t{/* Registration Error */}\n\t\t\t{registrationError && (\n\t\t\t\t<div className=\"registration-error\" role=\"alert\">\n\t\t\t\t\t<strong>Registration Failed:</strong> {registrationError}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Info */}\n\t\t\t<div style={{ \n\t\t\t\tpadding: '12px 16px', \n\t\t\t\tbackground: '#eff6ff', \n\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\tborderRadius: '6px',\n\t\t\t\tmarginBottom: '16px',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tcolor: '#1e40af'\n\t\t\t}}>\n\t\t\t{config.deviceType === 'FIDO2' ? (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will create your {config.displayName} device, then you'll complete biometric authentication.</>\n\t\t\t) : (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will register your {config.displayName} device and send the activation code.</>\n\t\t\t)}\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleRegisterDevice}\n\t\t\t\t\tdisabled={isLoading || !tokenStatus.isValid}\n\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Registering...' : 'Next Step ‚ñ∂'}\n\t\t\t\t</button>\n\t\t\t</div>!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)\n\t\t</div>\n\t);\n};\n\nexport default UnifiedRegistrationStep;\n"}}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedRegistrationStep.tsx"},"span":[12210,12413],"sourceCode":"/**\n * @file UnifiedRegistrationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 2: Device Registration - Unified registration for all device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle device registration for all 6 device types using either:\n * - DynamicFormRenderer (for SMS, Email, WhatsApp)\n * - Custom components (for TOTP, FIDO2, Mobile)\n *\n * Flow:\n * 1. Render appropriate UI based on device type\n * 2. Collect and validate device-specific information\n * 3. Call controller.registerDevice()\n * 4. Update mfaState with registration result\n * 5. Navigate to activation step\n *\n * @example\n * <UnifiedRegistrationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n *   deviceFields={deviceFields}\n *   setDeviceFields={setDeviceFields}\n *   errors={errors}\n *   validate={validate}\n * />\n */\n\nimport React, { useCallback, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type DeviceComponentProps, DeviceComponentRegistry } from './DeviceComponentRegistry';\nimport { DynamicFormRenderer } from './DynamicFormRenderer';\n\nconst MODULE_TAG = '[üìù UNIFIED-REGISTRATION-STEP]';\n\n// Exported helper to determine final device status after registration\nexport function computeDeviceStatus(resultStatus: string | undefined, deviceType: string, tokenType: string) {\n\tconst status = resultStatus || '';\n\tif (deviceType === 'TOTP') {\n\t\t// User flows must require activation\n\t\tif (tokenType === 'user') return 'ACTIVATION_REQUIRED';\n\t\t// For admin/worker flows, prefer returned status, but default to ACTIVATION_REQUIRED\n\t\treturn status || 'ACTIVATION_REQUIRED';\n\t}\n\treturn status || 'ACTIVE';\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedRegistrationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device-specific form field values */\n\tdeviceFields: Record<string, string>;\n\n\t/** Update device fields */\n\tsetDeviceFields: (\n\t\tfields: Record<string, string> | ((prev: Record<string, string>) => Record<string, string>)\n\t) => void;\n\n\t/** Validation errors */\n\terrors: Record<string, string>;\n\n\t/** Validation function */\n\tvalidate: () => boolean;\n\n\t/** Touch field callback (for validation) */\n\ttouchField?: (field: string) => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Registration Step (Step 2)\n *\n * Handles device registration for all device types using configuration-driven\n * rendering (DynamicFormRenderer) or custom components (TOTP, FIDO2, Mobile).\n */\nexport const UnifiedRegistrationStep: React.FC<UnifiedRegistrationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n\tdeviceFields,\n\tsetDeviceFields,\n\terrors,\n\tvalidate,\n\ttouchField,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering registration step for:`, config.deviceType);\n\t\n\t// ========== DEBUG: FULL CONFIG CHECK ==========\n\tconsole.log('üîç [REG-STEP DEBUG] Full config:', {\n\t\tdeviceType: config.deviceType,\n\t\tdisplayName: config.displayName,\n\t\trequiresOTP: config.requiresOTP,\n\t\tconfigObject: config\n\t});\n\t// ==============================================\n\t\n\t// ========== DEBUG: COMPONENT MOUNT ==========\n\tReact.useEffect(() => {\n\t\tconsole.log('üîç [REG-STEP DEBUG] Component mounted/updated', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasDeviceFields: !!deviceFields,\n\t\t\tfieldCount: Object.keys(deviceFields || {}).length,\n\t\t\ttokenValid: tokenStatus.isValid,\n\t\t\tisLoading\n\t\t});\n\t}, [config.deviceType, deviceFields, tokenStatus.isValid, isLoading]);\n\t// ===========================================\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle field change\n\t */\n\tconst handleFieldChange = useCallback(\n\t\t(field: string, value: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Field changed:`, field, '=', value);\n\t\t\tsetDeviceFields((prev) => ({ ...prev, [field]: value }));\n\n\t\t\t// Clear error for this field\n\t\t\tif (errors[field]) {\n\t\t\t\tsetRegistrationError(null);\n\t\t\t}\n\t\t},\n\t\t[setDeviceFields, errors]\n\t);\n\n\t/**\n\t * Handle device registration\n\t */\n\tconst handleRegisterDevice = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting device registration`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceFields,\n\t\t});\n\t\t\n\t\t// ========== DEBUG: REGISTRATION ENTRY ==========\n\t\tconsole.log('üîç [REG DEBUG] handleRegisterDevice called', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tfields: deviceFields,\n\t\t\tcredentialsEnvId: credentials.environmentId,\n\t\t\ttokenIsValid: tokenStatus.isValid\n\t\t});\n\t\t// ===============================================\n\n\t\t// Clear previous errors\n\t\tsetRegistrationError(null);\n\n\t\t// Validate fields\n\t\tif (!validate()) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed`);\n\t\t\tconsole.log('üîç [REG DEBUG] Validation failed, errors:', errors);\n\t\t\tsetRegistrationError('Please fix the errors above before continuing');\n\t\t\tnav.setValidationErrors(['Please fix the form errors']);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconsole.log('üîç [REG DEBUG] Validation passed, proceeding with registration');\n\n\t\t// Set loading state\n\t\tsetIsLoading(true);\n\n\t\ttry {\n\t\t\t// Merge device fields into credentials\n\t\t\tconst updatedCredentials = {\n\t\t\t\t...credentials,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t\t...deviceFields,\n\t\t\t};\n\n\t\t\t// Update credentials\n\t\t\tsetCredentials(updatedCredentials);\n\n\t\t\tconsole.log(`${MODULE_TAG} Calling controller.registerDevice`);\n\n\t\t\t// Call controller to register device\n\t\t\tconst result = await controller.registerDevice(\n\t\t\t\tupdatedCredentials,\n\t\t\t\tmfaState,\n\t\t\t\ttokenStatus,\n\t\t\t\tnav\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Device registered successfully:`, result);\n\t\t\n\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\tif (config.deviceType === 'TOTP') {\n\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result:', {\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tqrCode: result.qrCode,\n\t\t\t\tqrCodeUrl: result.qrCodeUrl,\n\t\t\t\tsecret: result.secret,\n\t\t\t\ttotpSecret: result.totpSecret,\n\t\t\t\tfullResult: result\n\t\t\t});\n\t\t}\n\t\t// ===============================================\n\n\t\t// Update MFA state with registration result\n\t\tsetMfaState((prev) => {\n\t\t\tconst newState = {\n\t\t\t\t...prev,\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tdeviceStatus: computeDeviceStatus(result.status, config.deviceType, tokenStatus.type),\n\t\t\t\t// TOTP-specific data (preserve QR/secret for user to scan)\n\t\t\t\tqrCodeUrl: result.qrCode || result.qrCodeUrl,\n\t\t\t\ttotpSecret: result.secret || result.totpSecret,\n\t\t\t\t// If we have TOTP data, surface the QR/secret immediately\n\t\t\t\tshowQr: config.deviceType === 'TOTP' && (result.qrCode || result.secret || result.totpSecret),\n\t\t\t\t// FIDO2-specific data\n\t\t\t\tpublicKeyCredentialCreationOptions: result.publicKeyCredentialCreationOptions,\n\t\t\t\t// Mobile-specific data\n\t\t\t\tpairingKey: result.pairingKey,\n\t\t\t\t// Links for activation\n\t\t\t\tactivationLinks: result._links,\n\t\t\t};\n\t\t\t\n\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\tif (config.deviceType === 'TOTP') {\n\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\tfullState: newState\n\t\t\t\t});\n\t\t\t}\n\t\t\t// ================================================\n\t\t\t\n\t\t\treturn newState;\n\t\t});\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} device registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step (activation)\n\t\t\tnav.goToNext();\n\t\t} catch (error: any) {\n\t\t\tconsole.error(`${MODULE_TAG} Device registration failed:`, error);\n\n\t\t\tconst errorMessage = error.message || `Failed to register ${config.displayName} device`;\n\n\t\t\tsetRegistrationError(errorMessage);\n\t\t\tnav.setValidationErrors([errorMessage]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [\n\t\tconfig, \n\t\tdeviceFields, \n\t\tcredentials, \n\t\tsetCredentials, \n\t\tmfaState, \n\t\tsetMfaState, \n\t\ttokenStatus, \n\t\tnav, \n\t\tcontroller, \n\t\tvalidate, \n\t\tsetIsLoading, errors\n\t]);\n\n\t/**\n\t * Handle registration success (for custom components)\n\t */\n\tconst handleRegistrationSuccess = useCallback(\n\t\t(data: any) => {\n\t\t\tconsole.log(`${MODULE_TAG} Custom component registration success:`, data);\n\n\t\t\t// Update MFA state\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t...data,\n\t\t\t}));\n\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step\n\t\t\tnav.goToNext();\n\t\t},\n\t\t[config, setMfaState, nav]\n\t);\n\n\t/**\n\t * Handle registration error (for custom components)\n\t */\n\tconst handleRegistrationError = useCallback(\n\t\t(error: string) => {\n\t\t\tconsole.error(`${MODULE_TAG} Custom component registration error:`, error);\n\n\t\t\tsetRegistrationError(error);\n\t\t\tnav.setValidationErrors([error]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(error);\n\t\t},\n\t\t[nav]\n\t);\n\n\t// ========================================================================\n\t// RENDER UI LOGIC\n\t// ========================================================================\n\n\t/**\n\t * Render registration UI based on device type\n\t */\n\tconst renderRegistrationUI = () => {\n\t\t// Check if this device type has a custom component\n\t\tconst CustomComponent = DeviceComponentRegistry[config.deviceType];\n\t\t\n\t\t// ========== DEBUG: REGISTRATION UI PATH ==========\n\t\tconsole.log('üîç [REG-UI DEBUG] Rendering path:', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasCustomComponent: !!CustomComponent,\n\t\t\twillUseDynamicForm: !CustomComponent,\n\t\t\tregistryValue: CustomComponent\n\t\t});\n\t\t// ================================================\n\n\t\tif (CustomComponent) {\n\t\t\t// Use device-specific custom component (TOTP, FIDO2, Mobile)\n\t\t\tconsole.log(`${MODULE_TAG} Using custom component for:`, config.deviceType);\n\n\t\t\tconst customComponentProps: DeviceComponentProps = {\n\t\t\t\tcredentials,\n\t\t\t\tmfaState,\n\t\t\t\tsetMfaState,\n\t\t\t\tonSuccess: handleRegistrationSuccess,\n\t\t\t\tonError: handleRegistrationError,\n\t\t\t\tcontroller,\n\t\t\t\tconfig,\n\t\t\t};\n\n\t\t\treturn <CustomComponent {...customComponentProps} />;\n\t\t} else {\n\t\t\t// Use dynamic form renderer (SMS, Email, WhatsApp)\n\t\t\tconsole.log(`${MODULE_TAG} Using dynamic form renderer for:`, config.deviceType);\n\n\t\t\treturn (\n\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\tconfig={config}\n\t\t\t\t\tvalues={deviceFields || {}}\n\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\terrors={errors}\n\t\t\t\t\tonTouch={touchField}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t/>\n\t\t\t);\n\t\t}\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-registration-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">{config.description}</p>\n\t\t\t</div>\n\n\t\t\t{/* Registration UI (dynamic form or custom component) */}\n\t\t\t<div className=\"registration-ui\">{renderRegistrationUI()}</div>\n\n\t\t\t{/* Registration Error */}\n\t\t\t{registrationError && (\n\t\t\t\t<div className=\"registration-error\" role=\"alert\">\n\t\t\t\t\t<strong>Registration Failed:</strong> {registrationError}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Info */}\n\t\t\t<div style={{ \n\t\t\t\tpadding: '12px 16px', \n\t\t\t\tbackground: '#eff6ff', \n\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\tborderRadius: '6px',\n\t\t\t\tmarginBottom: '16px',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tcolor: '#1e40af'\n\t\t\t}}>\n\t\t\t{config.deviceType === 'FIDO2' ? (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will create your {config.displayName} device, then you'll complete biometric authentication.</>\n\t\t\t) : (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will register your {config.displayName} device and send the activation code.</>\n\t\t\t)}\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleRegisterDevice}\n\t\t\t\t\tdisabled={isLoading || !tokenStatus.isValid}\n\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Registering...' : 'Next Step ‚ñ∂'}\n\t\t\t\t</button>\n\t\t\t</div>!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)\n\t\t</div>\n\t);\n};\n\nexport default UnifiedRegistrationStep;\n"},"tags":[],"source":null},{"category":"parse","severity":"error","description":"expected `)` but instead found `tokenStatus`","message":[{"elements":[],"content":"expected `)` but instead found `tokenStatus`"}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Remove tokenStatus"}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedRegistrationStep.tsx"},"span":[12977,12988],"sourceCode":"/**\n * @file UnifiedRegistrationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 2: Device Registration - Unified registration for all device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle device registration for all 6 device types using either:\n * - DynamicFormRenderer (for SMS, Email, WhatsApp)\n * - Custom components (for TOTP, FIDO2, Mobile)\n *\n * Flow:\n * 1. Render appropriate UI based on device type\n * 2. Collect and validate device-specific information\n * 3. Call controller.registerDevice()\n * 4. Update mfaState with registration result\n * 5. Navigate to activation step\n *\n * @example\n * <UnifiedRegistrationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n *   deviceFields={deviceFields}\n *   setDeviceFields={setDeviceFields}\n *   errors={errors}\n *   validate={validate}\n * />\n */\n\nimport React, { useCallback, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type DeviceComponentProps, DeviceComponentRegistry } from './DeviceComponentRegistry';\nimport { DynamicFormRenderer } from './DynamicFormRenderer';\n\nconst MODULE_TAG = '[üìù UNIFIED-REGISTRATION-STEP]';\n\n// Exported helper to determine final device status after registration\nexport function computeDeviceStatus(resultStatus: string | undefined, deviceType: string, tokenType: string) {\n\tconst status = resultStatus || '';\n\tif (deviceType === 'TOTP') {\n\t\t// User flows must require activation\n\t\tif (tokenType === 'user') return 'ACTIVATION_REQUIRED';\n\t\t// For admin/worker flows, prefer returned status, but default to ACTIVATION_REQUIRED\n\t\treturn status || 'ACTIVATION_REQUIRED';\n\t}\n\treturn status || 'ACTIVE';\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedRegistrationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device-specific form field values */\n\tdeviceFields: Record<string, string>;\n\n\t/** Update device fields */\n\tsetDeviceFields: (\n\t\tfields: Record<string, string> | ((prev: Record<string, string>) => Record<string, string>)\n\t) => void;\n\n\t/** Validation errors */\n\terrors: Record<string, string>;\n\n\t/** Validation function */\n\tvalidate: () => boolean;\n\n\t/** Touch field callback (for validation) */\n\ttouchField?: (field: string) => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Registration Step (Step 2)\n *\n * Handles device registration for all device types using configuration-driven\n * rendering (DynamicFormRenderer) or custom components (TOTP, FIDO2, Mobile).\n */\nexport const UnifiedRegistrationStep: React.FC<UnifiedRegistrationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n\tdeviceFields,\n\tsetDeviceFields,\n\terrors,\n\tvalidate,\n\ttouchField,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering registration step for:`, config.deviceType);\n\t\n\t// ========== DEBUG: FULL CONFIG CHECK ==========\n\tconsole.log('üîç [REG-STEP DEBUG] Full config:', {\n\t\tdeviceType: config.deviceType,\n\t\tdisplayName: config.displayName,\n\t\trequiresOTP: config.requiresOTP,\n\t\tconfigObject: config\n\t});\n\t// ==============================================\n\t\n\t// ========== DEBUG: COMPONENT MOUNT ==========\n\tReact.useEffect(() => {\n\t\tconsole.log('üîç [REG-STEP DEBUG] Component mounted/updated', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasDeviceFields: !!deviceFields,\n\t\t\tfieldCount: Object.keys(deviceFields || {}).length,\n\t\t\ttokenValid: tokenStatus.isValid,\n\t\t\tisLoading\n\t\t});\n\t}, [config.deviceType, deviceFields, tokenStatus.isValid, isLoading]);\n\t// ===========================================\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle field change\n\t */\n\tconst handleFieldChange = useCallback(\n\t\t(field: string, value: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Field changed:`, field, '=', value);\n\t\t\tsetDeviceFields((prev) => ({ ...prev, [field]: value }));\n\n\t\t\t// Clear error for this field\n\t\t\tif (errors[field]) {\n\t\t\t\tsetRegistrationError(null);\n\t\t\t}\n\t\t},\n\t\t[setDeviceFields, errors]\n\t);\n\n\t/**\n\t * Handle device registration\n\t */\n\tconst handleRegisterDevice = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting device registration`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceFields,\n\t\t});\n\t\t\n\t\t// ========== DEBUG: REGISTRATION ENTRY ==========\n\t\tconsole.log('üîç [REG DEBUG] handleRegisterDevice called', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tfields: deviceFields,\n\t\t\tcredentialsEnvId: credentials.environmentId,\n\t\t\ttokenIsValid: tokenStatus.isValid\n\t\t});\n\t\t// ===============================================\n\n\t\t// Clear previous errors\n\t\tsetRegistrationError(null);\n\n\t\t// Validate fields\n\t\tif (!validate()) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed`);\n\t\t\tconsole.log('üîç [REG DEBUG] Validation failed, errors:', errors);\n\t\t\tsetRegistrationError('Please fix the errors above before continuing');\n\t\t\tnav.setValidationErrors(['Please fix the form errors']);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconsole.log('üîç [REG DEBUG] Validation passed, proceeding with registration');\n\n\t\t// Set loading state\n\t\tsetIsLoading(true);\n\n\t\ttry {\n\t\t\t// Merge device fields into credentials\n\t\t\tconst updatedCredentials = {\n\t\t\t\t...credentials,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t\t...deviceFields,\n\t\t\t};\n\n\t\t\t// Update credentials\n\t\t\tsetCredentials(updatedCredentials);\n\n\t\t\tconsole.log(`${MODULE_TAG} Calling controller.registerDevice`);\n\n\t\t\t// Call controller to register device\n\t\t\tconst result = await controller.registerDevice(\n\t\t\t\tupdatedCredentials,\n\t\t\t\tmfaState,\n\t\t\t\ttokenStatus,\n\t\t\t\tnav\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Device registered successfully:`, result);\n\t\t\n\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\tif (config.deviceType === 'TOTP') {\n\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result:', {\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tqrCode: result.qrCode,\n\t\t\t\tqrCodeUrl: result.qrCodeUrl,\n\t\t\t\tsecret: result.secret,\n\t\t\t\ttotpSecret: result.totpSecret,\n\t\t\t\tfullResult: result\n\t\t\t});\n\t\t}\n\t\t// ===============================================\n\n\t\t// Update MFA state with registration result\n\t\tsetMfaState((prev) => {\n\t\t\tconst newState = {\n\t\t\t\t...prev,\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tdeviceStatus: computeDeviceStatus(result.status, config.deviceType, tokenStatus.type),\n\t\t\t\t// TOTP-specific data (preserve QR/secret for user to scan)\n\t\t\t\tqrCodeUrl: result.qrCode || result.qrCodeUrl,\n\t\t\t\ttotpSecret: result.secret || result.totpSecret,\n\t\t\t\t// If we have TOTP data, surface the QR/secret immediately\n\t\t\t\tshowQr: config.deviceType === 'TOTP' && (result.qrCode || result.secret || result.totpSecret),\n\t\t\t\t// FIDO2-specific data\n\t\t\t\tpublicKeyCredentialCreationOptions: result.publicKeyCredentialCreationOptions,\n\t\t\t\t// Mobile-specific data\n\t\t\t\tpairingKey: result.pairingKey,\n\t\t\t\t// Links for activation\n\t\t\t\tactivationLinks: result._links,\n\t\t\t};\n\t\t\t\n\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\tif (config.deviceType === 'TOTP') {\n\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\tfullState: newState\n\t\t\t\t});\n\t\t\t}\n\t\t\t// ================================================\n\t\t\t\n\t\t\treturn newState;\n\t\t});\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} device registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step (activation)\n\t\t\tnav.goToNext();\n\t\t} catch (error: any) {\n\t\t\tconsole.error(`${MODULE_TAG} Device registration failed:`, error);\n\n\t\t\tconst errorMessage = error.message || `Failed to register ${config.displayName} device`;\n\n\t\t\tsetRegistrationError(errorMessage);\n\t\t\tnav.setValidationErrors([errorMessage]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [\n\t\tconfig, \n\t\tdeviceFields, \n\t\tcredentials, \n\t\tsetCredentials, \n\t\tmfaState, \n\t\tsetMfaState, \n\t\ttokenStatus, \n\t\tnav, \n\t\tcontroller, \n\t\tvalidate, \n\t\tsetIsLoading, errors\n\t]);\n\n\t/**\n\t * Handle registration success (for custom components)\n\t */\n\tconst handleRegistrationSuccess = useCallback(\n\t\t(data: any) => {\n\t\t\tconsole.log(`${MODULE_TAG} Custom component registration success:`, data);\n\n\t\t\t// Update MFA state\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t...data,\n\t\t\t}));\n\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step\n\t\t\tnav.goToNext();\n\t\t},\n\t\t[config, setMfaState, nav]\n\t);\n\n\t/**\n\t * Handle registration error (for custom components)\n\t */\n\tconst handleRegistrationError = useCallback(\n\t\t(error: string) => {\n\t\t\tconsole.error(`${MODULE_TAG} Custom component registration error:`, error);\n\n\t\t\tsetRegistrationError(error);\n\t\t\tnav.setValidationErrors([error]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(error);\n\t\t},\n\t\t[nav]\n\t);\n\n\t// ========================================================================\n\t// RENDER UI LOGIC\n\t// ========================================================================\n\n\t/**\n\t * Render registration UI based on device type\n\t */\n\tconst renderRegistrationUI = () => {\n\t\t// Check if this device type has a custom component\n\t\tconst CustomComponent = DeviceComponentRegistry[config.deviceType];\n\t\t\n\t\t// ========== DEBUG: REGISTRATION UI PATH ==========\n\t\tconsole.log('üîç [REG-UI DEBUG] Rendering path:', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasCustomComponent: !!CustomComponent,\n\t\t\twillUseDynamicForm: !CustomComponent,\n\t\t\tregistryValue: CustomComponent\n\t\t});\n\t\t// ================================================\n\n\t\tif (CustomComponent) {\n\t\t\t// Use device-specific custom component (TOTP, FIDO2, Mobile)\n\t\t\tconsole.log(`${MODULE_TAG} Using custom component for:`, config.deviceType);\n\n\t\t\tconst customComponentProps: DeviceComponentProps = {\n\t\t\t\tcredentials,\n\t\t\t\tmfaState,\n\t\t\t\tsetMfaState,\n\t\t\t\tonSuccess: handleRegistrationSuccess,\n\t\t\t\tonError: handleRegistrationError,\n\t\t\t\tcontroller,\n\t\t\t\tconfig,\n\t\t\t};\n\n\t\t\treturn <CustomComponent {...customComponentProps} />;\n\t\t} else {\n\t\t\t// Use dynamic form renderer (SMS, Email, WhatsApp)\n\t\t\tconsole.log(`${MODULE_TAG} Using dynamic form renderer for:`, config.deviceType);\n\n\t\t\treturn (\n\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\tconfig={config}\n\t\t\t\t\tvalues={deviceFields || {}}\n\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\terrors={errors}\n\t\t\t\t\tonTouch={touchField}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t/>\n\t\t\t);\n\t\t}\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-registration-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">{config.description}</p>\n\t\t\t</div>\n\n\t\t\t{/* Registration UI (dynamic form or custom component) */}\n\t\t\t<div className=\"registration-ui\">{renderRegistrationUI()}</div>\n\n\t\t\t{/* Registration Error */}\n\t\t\t{registrationError && (\n\t\t\t\t<div className=\"registration-error\" role=\"alert\">\n\t\t\t\t\t<strong>Registration Failed:</strong> {registrationError}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Info */}\n\t\t\t<div style={{ \n\t\t\t\tpadding: '12px 16px', \n\t\t\t\tbackground: '#eff6ff', \n\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\tborderRadius: '6px',\n\t\t\t\tmarginBottom: '16px',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tcolor: '#1e40af'\n\t\t\t}}>\n\t\t\t{config.deviceType === 'FIDO2' ? (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will create your {config.displayName} device, then you'll complete biometric authentication.</>\n\t\t\t) : (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will register your {config.displayName} device and send the activation code.</>\n\t\t\t)}\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleRegisterDevice}\n\t\t\t\t\tdisabled={isLoading || !tokenStatus.isValid}\n\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Registering...' : 'Next Step ‚ñ∂'}\n\t\t\t\t</button>\n\t\t\t</div>!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)\n\t\t</div>\n\t);\n};\n\nexport default UnifiedRegistrationStep;\n"},"tags":[],"source":null},{"category":"parse","severity":"error","description":"Expected an expression but instead found '<'.","message":[{"elements":[],"content":"Expected an expression but instead found '<'."}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"Expected an expression here."}]]},{"frame":{"path":null,"span":[13162,13163],"sourceCode":"/**\n * @file UnifiedRegistrationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 2: Device Registration - Unified registration for all device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle device registration for all 6 device types using either:\n * - DynamicFormRenderer (for SMS, Email, WhatsApp)\n * - Custom components (for TOTP, FIDO2, Mobile)\n *\n * Flow:\n * 1. Render appropriate UI based on device type\n * 2. Collect and validate device-specific information\n * 3. Call controller.registerDevice()\n * 4. Update mfaState with registration result\n * 5. Navigate to activation step\n *\n * @example\n * <UnifiedRegistrationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n *   deviceFields={deviceFields}\n *   setDeviceFields={setDeviceFields}\n *   errors={errors}\n *   validate={validate}\n * />\n */\n\nimport React, { useCallback, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type DeviceComponentProps, DeviceComponentRegistry } from './DeviceComponentRegistry';\nimport { DynamicFormRenderer } from './DynamicFormRenderer';\n\nconst MODULE_TAG = '[üìù UNIFIED-REGISTRATION-STEP]';\n\n// Exported helper to determine final device status after registration\nexport function computeDeviceStatus(resultStatus: string | undefined, deviceType: string, tokenType: string) {\n\tconst status = resultStatus || '';\n\tif (deviceType === 'TOTP') {\n\t\t// User flows must require activation\n\t\tif (tokenType === 'user') return 'ACTIVATION_REQUIRED';\n\t\t// For admin/worker flows, prefer returned status, but default to ACTIVATION_REQUIRED\n\t\treturn status || 'ACTIVATION_REQUIRED';\n\t}\n\treturn status || 'ACTIVE';\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedRegistrationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device-specific form field values */\n\tdeviceFields: Record<string, string>;\n\n\t/** Update device fields */\n\tsetDeviceFields: (\n\t\tfields: Record<string, string> | ((prev: Record<string, string>) => Record<string, string>)\n\t) => void;\n\n\t/** Validation errors */\n\terrors: Record<string, string>;\n\n\t/** Validation function */\n\tvalidate: () => boolean;\n\n\t/** Touch field callback (for validation) */\n\ttouchField?: (field: string) => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Registration Step (Step 2)\n *\n * Handles device registration for all device types using configuration-driven\n * rendering (DynamicFormRenderer) or custom components (TOTP, FIDO2, Mobile).\n */\nexport const UnifiedRegistrationStep: React.FC<UnifiedRegistrationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n\tdeviceFields,\n\tsetDeviceFields,\n\terrors,\n\tvalidate,\n\ttouchField,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering registration step for:`, config.deviceType);\n\t\n\t// ========== DEBUG: FULL CONFIG CHECK ==========\n\tconsole.log('üîç [REG-STEP DEBUG] Full config:', {\n\t\tdeviceType: config.deviceType,\n\t\tdisplayName: config.displayName,\n\t\trequiresOTP: config.requiresOTP,\n\t\tconfigObject: config\n\t});\n\t// ==============================================\n\t\n\t// ========== DEBUG: COMPONENT MOUNT ==========\n\tReact.useEffect(() => {\n\t\tconsole.log('üîç [REG-STEP DEBUG] Component mounted/updated', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasDeviceFields: !!deviceFields,\n\t\t\tfieldCount: Object.keys(deviceFields || {}).length,\n\t\t\ttokenValid: tokenStatus.isValid,\n\t\t\tisLoading\n\t\t});\n\t}, [config.deviceType, deviceFields, tokenStatus.isValid, isLoading]);\n\t// ===========================================\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle field change\n\t */\n\tconst handleFieldChange = useCallback(\n\t\t(field: string, value: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Field changed:`, field, '=', value);\n\t\t\tsetDeviceFields((prev) => ({ ...prev, [field]: value }));\n\n\t\t\t// Clear error for this field\n\t\t\tif (errors[field]) {\n\t\t\t\tsetRegistrationError(null);\n\t\t\t}\n\t\t},\n\t\t[setDeviceFields, errors]\n\t);\n\n\t/**\n\t * Handle device registration\n\t */\n\tconst handleRegisterDevice = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting device registration`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceFields,\n\t\t});\n\t\t\n\t\t// ========== DEBUG: REGISTRATION ENTRY ==========\n\t\tconsole.log('üîç [REG DEBUG] handleRegisterDevice called', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tfields: deviceFields,\n\t\t\tcredentialsEnvId: credentials.environmentId,\n\t\t\ttokenIsValid: tokenStatus.isValid\n\t\t});\n\t\t// ===============================================\n\n\t\t// Clear previous errors\n\t\tsetRegistrationError(null);\n\n\t\t// Validate fields\n\t\tif (!validate()) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed`);\n\t\t\tconsole.log('üîç [REG DEBUG] Validation failed, errors:', errors);\n\t\t\tsetRegistrationError('Please fix the errors above before continuing');\n\t\t\tnav.setValidationErrors(['Please fix the form errors']);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconsole.log('üîç [REG DEBUG] Validation passed, proceeding with registration');\n\n\t\t// Set loading state\n\t\tsetIsLoading(true);\n\n\t\ttry {\n\t\t\t// Merge device fields into credentials\n\t\t\tconst updatedCredentials = {\n\t\t\t\t...credentials,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t\t...deviceFields,\n\t\t\t};\n\n\t\t\t// Update credentials\n\t\t\tsetCredentials(updatedCredentials);\n\n\t\t\tconsole.log(`${MODULE_TAG} Calling controller.registerDevice`);\n\n\t\t\t// Call controller to register device\n\t\t\tconst result = await controller.registerDevice(\n\t\t\t\tupdatedCredentials,\n\t\t\t\tmfaState,\n\t\t\t\ttokenStatus,\n\t\t\t\tnav\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Device registered successfully:`, result);\n\t\t\n\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\tif (config.deviceType === 'TOTP') {\n\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result:', {\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tqrCode: result.qrCode,\n\t\t\t\tqrCodeUrl: result.qrCodeUrl,\n\t\t\t\tsecret: result.secret,\n\t\t\t\ttotpSecret: result.totpSecret,\n\t\t\t\tfullResult: result\n\t\t\t});\n\t\t}\n\t\t// ===============================================\n\n\t\t// Update MFA state with registration result\n\t\tsetMfaState((prev) => {\n\t\t\tconst newState = {\n\t\t\t\t...prev,\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tdeviceStatus: computeDeviceStatus(result.status, config.deviceType, tokenStatus.type),\n\t\t\t\t// TOTP-specific data (preserve QR/secret for user to scan)\n\t\t\t\tqrCodeUrl: result.qrCode || result.qrCodeUrl,\n\t\t\t\ttotpSecret: result.secret || result.totpSecret,\n\t\t\t\t// If we have TOTP data, surface the QR/secret immediately\n\t\t\t\tshowQr: config.deviceType === 'TOTP' && (result.qrCode || result.secret || result.totpSecret),\n\t\t\t\t// FIDO2-specific data\n\t\t\t\tpublicKeyCredentialCreationOptions: result.publicKeyCredentialCreationOptions,\n\t\t\t\t// Mobile-specific data\n\t\t\t\tpairingKey: result.pairingKey,\n\t\t\t\t// Links for activation\n\t\t\t\tactivationLinks: result._links,\n\t\t\t};\n\t\t\t\n\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\tif (config.deviceType === 'TOTP') {\n\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\tfullState: newState\n\t\t\t\t});\n\t\t\t}\n\t\t\t// ================================================\n\t\t\t\n\t\t\treturn newState;\n\t\t});\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} device registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step (activation)\n\t\t\tnav.goToNext();\n\t\t} catch (error: any) {\n\t\t\tconsole.error(`${MODULE_TAG} Device registration failed:`, error);\n\n\t\t\tconst errorMessage = error.message || `Failed to register ${config.displayName} device`;\n\n\t\t\tsetRegistrationError(errorMessage);\n\t\t\tnav.setValidationErrors([errorMessage]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [\n\t\tconfig, \n\t\tdeviceFields, \n\t\tcredentials, \n\t\tsetCredentials, \n\t\tmfaState, \n\t\tsetMfaState, \n\t\ttokenStatus, \n\t\tnav, \n\t\tcontroller, \n\t\tvalidate, \n\t\tsetIsLoading, errors\n\t]);\n\n\t/**\n\t * Handle registration success (for custom components)\n\t */\n\tconst handleRegistrationSuccess = useCallback(\n\t\t(data: any) => {\n\t\t\tconsole.log(`${MODULE_TAG} Custom component registration success:`, data);\n\n\t\t\t// Update MFA state\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t...data,\n\t\t\t}));\n\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step\n\t\t\tnav.goToNext();\n\t\t},\n\t\t[config, setMfaState, nav]\n\t);\n\n\t/**\n\t * Handle registration error (for custom components)\n\t */\n\tconst handleRegistrationError = useCallback(\n\t\t(error: string) => {\n\t\t\tconsole.error(`${MODULE_TAG} Custom component registration error:`, error);\n\n\t\t\tsetRegistrationError(error);\n\t\t\tnav.setValidationErrors([error]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(error);\n\t\t},\n\t\t[nav]\n\t);\n\n\t// ========================================================================\n\t// RENDER UI LOGIC\n\t// ========================================================================\n\n\t/**\n\t * Render registration UI based on device type\n\t */\n\tconst renderRegistrationUI = () => {\n\t\t// Check if this device type has a custom component\n\t\tconst CustomComponent = DeviceComponentRegistry[config.deviceType];\n\t\t\n\t\t// ========== DEBUG: REGISTRATION UI PATH ==========\n\t\tconsole.log('üîç [REG-UI DEBUG] Rendering path:', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasCustomComponent: !!CustomComponent,\n\t\t\twillUseDynamicForm: !CustomComponent,\n\t\t\tregistryValue: CustomComponent\n\t\t});\n\t\t// ================================================\n\n\t\tif (CustomComponent) {\n\t\t\t// Use device-specific custom component (TOTP, FIDO2, Mobile)\n\t\t\tconsole.log(`${MODULE_TAG} Using custom component for:`, config.deviceType);\n\n\t\t\tconst customComponentProps: DeviceComponentProps = {\n\t\t\t\tcredentials,\n\t\t\t\tmfaState,\n\t\t\t\tsetMfaState,\n\t\t\t\tonSuccess: handleRegistrationSuccess,\n\t\t\t\tonError: handleRegistrationError,\n\t\t\t\tcontroller,\n\t\t\t\tconfig,\n\t\t\t};\n\n\t\t\treturn <CustomComponent {...customComponentProps} />;\n\t\t} else {\n\t\t\t// Use dynamic form renderer (SMS, Email, WhatsApp)\n\t\t\tconsole.log(`${MODULE_TAG} Using dynamic form renderer for:`, config.deviceType);\n\n\t\t\treturn (\n\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\tconfig={config}\n\t\t\t\t\tvalues={deviceFields || {}}\n\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\terrors={errors}\n\t\t\t\t\tonTouch={touchField}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t/>\n\t\t\t);\n\t\t}\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-registration-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">{config.description}</p>\n\t\t\t</div>\n\n\t\t\t{/* Registration UI (dynamic form or custom component) */}\n\t\t\t<div className=\"registration-ui\">{renderRegistrationUI()}</div>\n\n\t\t\t{/* Registration Error */}\n\t\t\t{registrationError && (\n\t\t\t\t<div className=\"registration-error\" role=\"alert\">\n\t\t\t\t\t<strong>Registration Failed:</strong> {registrationError}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Info */}\n\t\t\t<div style={{ \n\t\t\t\tpadding: '12px 16px', \n\t\t\t\tbackground: '#eff6ff', \n\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\tborderRadius: '6px',\n\t\t\t\tmarginBottom: '16px',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tcolor: '#1e40af'\n\t\t\t}}>\n\t\t\t{config.deviceType === 'FIDO2' ? (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will create your {config.displayName} device, then you'll complete biometric authentication.</>\n\t\t\t) : (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will register your {config.displayName} device and send the activation code.</>\n\t\t\t)}\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleRegisterDevice}\n\t\t\t\t\tdisabled={isLoading || !tokenStatus.isValid}\n\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Registering...' : 'Next Step ‚ñ∂'}\n\t\t\t\t</button>\n\t\t\t</div>!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)\n\t\t</div>\n\t);\n};\n\nexport default UnifiedRegistrationStep;\n"}}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedRegistrationStep.tsx"},"span":[13162,13163],"sourceCode":"/**\n * @file UnifiedRegistrationStep.tsx\n * @module v8/flows/unified/components\n * @description Step 2: Device Registration - Unified registration for all device types\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Handle device registration for all 6 device types using either:\n * - DynamicFormRenderer (for SMS, Email, WhatsApp)\n * - Custom components (for TOTP, FIDO2, Mobile)\n *\n * Flow:\n * 1. Render appropriate UI based on device type\n * 2. Collect and validate device-specific information\n * 3. Call controller.registerDevice()\n * 4. Update mfaState with registration result\n * 5. Navigate to activation step\n *\n * @example\n * <UnifiedRegistrationStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   controller={controller}\n *   deviceFields={deviceFields}\n *   setDeviceFields={setDeviceFields}\n *   errors={errors}\n *   validate={validate}\n * />\n */\n\nimport React, { useCallback, useState } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowController } from '@/v8/flows/controllers/MFAFlowController';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\nimport { type DeviceComponentProps, DeviceComponentRegistry } from './DeviceComponentRegistry';\nimport { DynamicFormRenderer } from './DynamicFormRenderer';\n\nconst MODULE_TAG = '[üìù UNIFIED-REGISTRATION-STEP]';\n\n// Exported helper to determine final device status after registration\nexport function computeDeviceStatus(resultStatus: string | undefined, deviceType: string, tokenType: string) {\n\tconst status = resultStatus || '';\n\tif (deviceType === 'TOTP') {\n\t\t// User flows must require activation\n\t\tif (tokenType === 'user') return 'ACTIVATION_REQUIRED';\n\t\t// For admin/worker flows, prefer returned status, but default to ACTIVATION_REQUIRED\n\t\treturn status || 'ACTIVATION_REQUIRED';\n\t}\n\treturn status || 'ACTIVE';\n}\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedRegistrationStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Device controller */\n\tcontroller: MFAFlowController;\n\n\t/** Device-specific form field values */\n\tdeviceFields: Record<string, string>;\n\n\t/** Update device fields */\n\tsetDeviceFields: (\n\t\tfields: Record<string, string> | ((prev: Record<string, string>) => Record<string, string>)\n\t) => void;\n\n\t/** Validation errors */\n\terrors: Record<string, string>;\n\n\t/** Validation function */\n\tvalidate: () => boolean;\n\n\t/** Touch field callback (for validation) */\n\ttouchField?: (field: string) => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Registration Step (Step 2)\n *\n * Handles device registration for all device types using configuration-driven\n * rendering (DynamicFormRenderer) or custom components (TOTP, FIDO2, Mobile).\n */\nexport const UnifiedRegistrationStep: React.FC<UnifiedRegistrationStepProps> = ({\n\tcredentials,\n\tsetCredentials,\n\tmfaState,\n\tsetMfaState,\n\ttokenStatus,\n\tisLoading,\n\tsetIsLoading,\n\tnav,\n\tconfig,\n\tcontroller,\n\tdeviceFields,\n\tsetDeviceFields,\n\terrors,\n\tvalidate,\n\ttouchField,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering registration step for:`, config.deviceType);\n\t\n\t// ========== DEBUG: FULL CONFIG CHECK ==========\n\tconsole.log('üîç [REG-STEP DEBUG] Full config:', {\n\t\tdeviceType: config.deviceType,\n\t\tdisplayName: config.displayName,\n\t\trequiresOTP: config.requiresOTP,\n\t\tconfigObject: config\n\t});\n\t// ==============================================\n\t\n\t// ========== DEBUG: COMPONENT MOUNT ==========\n\tReact.useEffect(() => {\n\t\tconsole.log('üîç [REG-STEP DEBUG] Component mounted/updated', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasDeviceFields: !!deviceFields,\n\t\t\tfieldCount: Object.keys(deviceFields || {}).length,\n\t\t\ttokenValid: tokenStatus.isValid,\n\t\t\tisLoading\n\t\t});\n\t}, [config.deviceType, deviceFields, tokenStatus.isValid, isLoading]);\n\t// ===========================================\n\n\t// ========================================================================\n\t// LOCAL STATE\n\t// ========================================================================\n\n\tconst [registrationError, setRegistrationError] = useState<string | null>(null);\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle field change\n\t */\n\tconst handleFieldChange = useCallback(\n\t\t(field: string, value: string) => {\n\t\t\tconsole.log(`${MODULE_TAG} Field changed:`, field, '=', value);\n\t\t\tsetDeviceFields((prev) => ({ ...prev, [field]: value }));\n\n\t\t\t// Clear error for this field\n\t\t\tif (errors[field]) {\n\t\t\t\tsetRegistrationError(null);\n\t\t\t}\n\t\t},\n\t\t[setDeviceFields, errors]\n\t);\n\n\t/**\n\t * Handle device registration\n\t */\n\tconst handleRegisterDevice = useCallback(async () => {\n\t\tconsole.log(`${MODULE_TAG} Starting device registration`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceFields,\n\t\t});\n\t\t\n\t\t// ========== DEBUG: REGISTRATION ENTRY ==========\n\t\tconsole.log('üîç [REG DEBUG] handleRegisterDevice called', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tfields: deviceFields,\n\t\t\tcredentialsEnvId: credentials.environmentId,\n\t\t\ttokenIsValid: tokenStatus.isValid\n\t\t});\n\t\t// ===============================================\n\n\t\t// Clear previous errors\n\t\tsetRegistrationError(null);\n\n\t\t// Validate fields\n\t\tif (!validate()) {\n\t\t\tconsole.error(`${MODULE_TAG} Validation failed`);\n\t\t\tconsole.log('üîç [REG DEBUG] Validation failed, errors:', errors);\n\t\t\tsetRegistrationError('Please fix the errors above before continuing');\n\t\t\tnav.setValidationErrors(['Please fix the form errors']);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconsole.log('üîç [REG DEBUG] Validation passed, proceeding with registration');\n\n\t\t// Set loading state\n\t\tsetIsLoading(true);\n\n\t\ttry {\n\t\t\t// Merge device fields into credentials\n\t\t\tconst updatedCredentials = {\n\t\t\t\t...credentials,\n\t\t\t\tdeviceType: config.deviceType,\n\t\t\t\t...deviceFields,\n\t\t\t};\n\n\t\t\t// Update credentials\n\t\t\tsetCredentials(updatedCredentials);\n\n\t\t\tconsole.log(`${MODULE_TAG} Calling controller.registerDevice`);\n\n\t\t\t// Call controller to register device\n\t\t\tconst result = await controller.registerDevice(\n\t\t\t\tupdatedCredentials,\n\t\t\t\tmfaState,\n\t\t\t\ttokenStatus,\n\t\t\t\tnav\n\t\t\t);\n\n\t\t\tconsole.log(`${MODULE_TAG} Device registered successfully:`, result);\n\t\t\n\t\t// ========== DEBUG: TOTP QR CODE DATA ==========\n\t\tif (config.deviceType === 'TOTP') {\n\t\t\tconsole.log('üîç [TOTP DEBUG] Registration result:', {\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tstatus: result.status,\n\t\t\t\tqrCode: result.qrCode,\n\t\t\t\tqrCodeUrl: result.qrCodeUrl,\n\t\t\t\tsecret: result.secret,\n\t\t\t\ttotpSecret: result.totpSecret,\n\t\t\t\tfullResult: result\n\t\t\t});\n\t\t}\n\t\t// ===============================================\n\n\t\t// Update MFA state with registration result\n\t\tsetMfaState((prev) => {\n\t\t\tconst newState = {\n\t\t\t\t...prev,\n\t\t\t\tdeviceId: result.deviceId,\n\t\t\t\tdeviceStatus: computeDeviceStatus(result.status, config.deviceType, tokenStatus.type),\n\t\t\t\t// TOTP-specific data (preserve QR/secret for user to scan)\n\t\t\t\tqrCodeUrl: result.qrCode || result.qrCodeUrl,\n\t\t\t\ttotpSecret: result.secret || result.totpSecret,\n\t\t\t\t// If we have TOTP data, surface the QR/secret immediately\n\t\t\t\tshowQr: config.deviceType === 'TOTP' && (result.qrCode || result.secret || result.totpSecret),\n\t\t\t\t// FIDO2-specific data\n\t\t\t\tpublicKeyCredentialCreationOptions: result.publicKeyCredentialCreationOptions,\n\t\t\t\t// Mobile-specific data\n\t\t\t\tpairingKey: result.pairingKey,\n\t\t\t\t// Links for activation\n\t\t\t\tactivationLinks: result._links,\n\t\t\t};\n\t\t\t\n\t\t\t// ========== DEBUG: TOTP MFA STATE UPDATE ==========\n\t\t\tif (config.deviceType === 'TOTP') {\n\t\t\t\tconsole.log('üîç [TOTP DEBUG] Updated mfaState:', {\n\t\t\t\t\tqrCodeUrl: newState.qrCodeUrl,\n\t\t\t\t\ttotpSecret: newState.totpSecret,\n\t\t\t\t\tshowQr: newState.showQr,\n\t\t\t\t\tdeviceStatus: newState.deviceStatus,\n\t\t\t\t\tfullState: newState\n\t\t\t\t});\n\t\t\t}\n\t\t\t// ================================================\n\t\t\t\n\t\t\treturn newState;\n\t\t});\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} device registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step (activation)\n\t\t\tnav.goToNext();\n\t\t} catch (error: any) {\n\t\t\tconsole.error(`${MODULE_TAG} Device registration failed:`, error);\n\n\t\t\tconst errorMessage = error.message || `Failed to register ${config.displayName} device`;\n\n\t\t\tsetRegistrationError(errorMessage);\n\t\t\tnav.setValidationErrors([errorMessage]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(errorMessage);\n\t\t} finally {\n\t\t\tsetIsLoading(false);\n\t\t}\n\t}, [\n\t\tconfig, \n\t\tdeviceFields, \n\t\tcredentials, \n\t\tsetCredentials, \n\t\tmfaState, \n\t\tsetMfaState, \n\t\ttokenStatus, \n\t\tnav, \n\t\tcontroller, \n\t\tvalidate, \n\t\tsetIsLoading, errors\n\t]);\n\n\t/**\n\t * Handle registration success (for custom components)\n\t */\n\tconst handleRegistrationSuccess = useCallback(\n\t\t(data: any) => {\n\t\t\tconsole.log(`${MODULE_TAG} Custom component registration success:`, data);\n\n\t\t\t// Update MFA state\n\t\t\tsetMfaState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t...data,\n\t\t\t}));\n\n\t\t\t// Show success toast\n\t\t\ttoastV8.success(`${config.displayName} registered successfully`);\n\n\t\t\t// Mark step as complete\n\t\t\tnav.markStepComplete();\n\n\t\t\t// Navigate to next step\n\t\t\tnav.goToNext();\n\t\t},\n\t\t[config, setMfaState, nav]\n\t);\n\n\t/**\n\t * Handle registration error (for custom components)\n\t */\n\tconst handleRegistrationError = useCallback(\n\t\t(error: string) => {\n\t\t\tconsole.error(`${MODULE_TAG} Custom component registration error:`, error);\n\n\t\t\tsetRegistrationError(error);\n\t\t\tnav.setValidationErrors([error]);\n\n\t\t\t// Show error toast\n\t\t\ttoastV8.error(error);\n\t\t},\n\t\t[nav]\n\t);\n\n\t// ========================================================================\n\t// RENDER UI LOGIC\n\t// ========================================================================\n\n\t/**\n\t * Render registration UI based on device type\n\t */\n\tconst renderRegistrationUI = () => {\n\t\t// Check if this device type has a custom component\n\t\tconst CustomComponent = DeviceComponentRegistry[config.deviceType];\n\t\t\n\t\t// ========== DEBUG: REGISTRATION UI PATH ==========\n\t\tconsole.log('üîç [REG-UI DEBUG] Rendering path:', {\n\t\t\tdeviceType: config.deviceType,\n\t\t\thasCustomComponent: !!CustomComponent,\n\t\t\twillUseDynamicForm: !CustomComponent,\n\t\t\tregistryValue: CustomComponent\n\t\t});\n\t\t// ================================================\n\n\t\tif (CustomComponent) {\n\t\t\t// Use device-specific custom component (TOTP, FIDO2, Mobile)\n\t\t\tconsole.log(`${MODULE_TAG} Using custom component for:`, config.deviceType);\n\n\t\t\tconst customComponentProps: DeviceComponentProps = {\n\t\t\t\tcredentials,\n\t\t\t\tmfaState,\n\t\t\t\tsetMfaState,\n\t\t\t\tonSuccess: handleRegistrationSuccess,\n\t\t\t\tonError: handleRegistrationError,\n\t\t\t\tcontroller,\n\t\t\t\tconfig,\n\t\t\t};\n\n\t\t\treturn <CustomComponent {...customComponentProps} />;\n\t\t} else {\n\t\t\t// Use dynamic form renderer (SMS, Email, WhatsApp)\n\t\t\tconsole.log(`${MODULE_TAG} Using dynamic form renderer for:`, config.deviceType);\n\n\t\t\treturn (\n\t\t\t\t<DynamicFormRenderer\n\t\t\t\t\tconfig={config}\n\t\t\t\t\tvalues={deviceFields || {}}\n\t\t\t\t\tonChange={handleFieldChange}\n\t\t\t\t\terrors={errors}\n\t\t\t\t\tonTouch={touchField}\n\t\t\t\t\tdisabled={isLoading}\n\t\t\t\t/>\n\t\t\t);\n\t\t}\n\t};\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-registration-step\">\n\t\t\t{/* Step Header */}\n\t\t\t<div className=\"step-header\">\n\t\t\t\t<h2>Register {config.displayName} Device</h2>\n\t\t\t\t<p className=\"step-description\">{config.description}</p>\n\t\t\t</div>\n\n\t\t\t{/* Registration UI (dynamic form or custom component) */}\n\t\t\t<div className=\"registration-ui\">{renderRegistrationUI()}</div>\n\n\t\t\t{/* Registration Error */}\n\t\t\t{registrationError && (\n\t\t\t\t<div className=\"registration-error\" role=\"alert\">\n\t\t\t\t\t<strong>Registration Failed:</strong> {registrationError}\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Registration Info */}\n\t\t\t<div style={{ \n\t\t\t\tpadding: '12px 16px', \n\t\t\t\tbackground: '#eff6ff', \n\t\t\t\tborder: '1px solid #bfdbfe',\n\t\t\t\tborderRadius: '6px',\n\t\t\t\tmarginBottom: '16px',\n\t\t\t\tfontSize: '14px',\n\t\t\t\tcolor: '#1e40af'\n\t\t\t}}>\n\t\t\t{config.deviceType === 'FIDO2' ? (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will create your {config.displayName} device, then you'll complete biometric authentication.</>\n\t\t\t) : (\n\t\t\t\t<>‚ÑπÔ∏è Clicking \"Next Step\" will register your {config.displayName} device and send the activation code.</>\n\t\t\t)}\n\t\t\t\t\t‚Üê Previous\n\t\t\t\t</button>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={handleRegisterDevice}\n\t\t\t\t\tdisabled={isLoading || !tokenStatus.isValid}\n\t\t\t\t\tclassName=\"button-primary\"\n\t\t\t\t>\n\t\t\t\t\t{isLoading ? 'Registering...' : 'Next Step ‚ñ∂'}\n\t\t\t\t</button>\n\t\t\t</div>!tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-warning\" role=\"alert\">\n\t\t\t\t\t‚ö†Ô∏è Worker token is invalid or expired. Please refresh your token before continuing.\n\t\t\t\t</div>\n\t\t\t)\n\t\t</div>\n\t);\n};\n\nexport default UnifiedRegistrationStep;\n"},"tags":[],"source":null},{"category":"format","severity":"error","description":"Code formatting aborted due to parsing errors. To format code with errors, enable the 'formatter.formatWithErrors' option.","message":[{"elements":[],"content":"Code formatting aborted due to parsing errors. To format code with errors, enable the 'formatter.formatWithErrors' option."}],"advices":{"advices":[]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedRegistrationStep.tsx"},"span":null,"sourceCode":null},"tags":[],"source":null},{"category":"lint/a11y/useSemanticElements","severity":"error","description":"The elements with this role can be changed to the following elements:\n<output>","message":[{"elements":[],"content":"The elements with this role can be changed to the following elements:\n<output>"}],"advices":{"advices":[{"log":["info",[{"elements":[],"content":"For examples and more information, see "},{"elements":[{"Hyperlink":{"href":"https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/Roles"}}],"content":"WAI-ARIA Roles"}]]}]},"verboseAdvices":{"advices":[]},"location":{"path":{"file":"src/v8/flows/unified/components/UnifiedSuccessStep.tsx"},"span":[9154,9167],"sourceCode":"/**\n * @file UnifiedSuccessStep.tsx\n * @module v8/flows/unified/components\n * @description Step 4: Success - Display registration success and device details\n * @version 8.0.0\n * @since 2026-01-29\n *\n * Purpose: Display success message after device registration and activation.\n * Shows device details, provides option to register another device.\n *\n * Flow:\n * 1. Display success message with device icon\n * 2. Show registered device details (ID, type, status, contact info)\n * 3. Provide \"Register Another Device\" button\n * 4. Call onSuccess callback if provided\n * 5. Log analytics event\n *\n * @example\n * <UnifiedSuccessStep\n *   {...mfaFlowBaseProps}\n *   config={config}\n *   onComplete={handleComplete}\n * />\n */\n\nimport React, { useCallback, useEffect } from 'react';\nimport type { DeviceFlowConfig } from '@/v8/config/deviceFlowConfigTypes';\nimport type { MFAFlowBaseRenderProps } from '@/v8/flows/shared/MFAFlowBaseV8';\nimport { toastV8 } from '@/v8/utils/toastNotificationsV8';\n\nconst MODULE_TAG = '[‚úÖ UNIFIED-SUCCESS-STEP]';\n\n// ============================================================================\n// PROPS INTERFACE\n// ============================================================================\n\nexport interface UnifiedSuccessStepProps extends MFAFlowBaseRenderProps {\n\t/** Device flow configuration */\n\tconfig: DeviceFlowConfig;\n\n\t/** Callback when user wants to register another device */\n\tonComplete?: () => void;\n\n\t/** Callback for registering another device */\n\tonRegisterAnother?: () => void;\n}\n\n// ============================================================================\n// COMPONENT\n// ============================================================================\n\n/**\n * Unified Success Step (Step 4)\n *\n * Displays registration success message and device details with option\n * to register another device.\n */\nexport const UnifiedSuccessStep: React.FC<UnifiedSuccessStepProps> = ({\n\tcredentials,\n\tmfaState,\n\ttokenStatus,\n\tnav,\n\tconfig,\n\tonComplete,\n\tonRegisterAnother,\n}) => {\n\tconsole.log(`${MODULE_TAG} Rendering success step for:`, config.deviceType);\n\n\t// ========================================================================\n\t// EFFECTS\n\t// ========================================================================\n\n\t/**\n\t * Mark step as complete on mount and log analytics\n\t */\n\tuseEffect(() => {\n\t\tconsole.log(`${MODULE_TAG} Device registration complete:`, {\n\t\t\tdeviceType: config.deviceType,\n\t\t\tdeviceId: mfaState.deviceId,\n\t\t\tstatus: mfaState.deviceStatus,\n\t\t});\n\n\t\t// Mark step as complete\n\t\tnav.markStepComplete();\n\n\t\t// Log analytics event\n\t\tif (typeof window !== 'undefined' && (window as any).gtag) {\n\t\t\t(window as any).gtag('event', 'mfa_registration_success', {\n\t\t\t\tdevice_type: config.deviceType,\n\t\t\t\tdevice_id: mfaState.deviceId,\n\t\t\t\tflow_version: 'v8-unified',\n\t\t\t});\n\t\t}\n\n\t\t// Call onComplete callback\n\t\tif (onComplete) {\n\t\t\tonComplete();\n\t\t}\n\t}, [\n\t\tconfig.deviceType,\n\t\tmfaState.deviceId,\n\t\tmfaState.deviceStatus, // Mark step as complete\n\t\tnav.markStepComplete,\n\t\tonComplete,\n\t]); // Only run once on mount\n\n\t// ========================================================================\n\t// HANDLERS\n\t// ========================================================================\n\n\t/**\n\t * Handle \"Register Another Device\" button click\n\t * Navigate back to main page like Restart Flow does\n\t */\n\tconst handleRegisterAnother = useCallback(() => {\n\t\tconsole.log(`${MODULE_TAG} User wants to register another device`);\n\n\t\ttoastV8.info('Starting new device registration');\n\n\t\t// Call callback if provided\n\t\tif (onRegisterAnother) {\n\t\t\tonRegisterAnother();\n\t\t} else {\n\t\t\t// Navigate back to unified MFA main page\n\t\t\twindow.location.href = '/v8/unified-mfa';\n\t\t}\n\t}, [onRegisterAnother]);\n\n\t// ========================================================================\n\t// COMPUTED PROPERTIES\n\t// ========================================================================\n\n\t/**\n\t * Get device contact information based on device type\n\t */\n\tconst getDeviceContactInfo = (): string | null => {\n\t\tswitch (config.deviceType) {\n\t\t\tcase 'SMS':\n\t\t\t\treturn credentials.phoneNumber\n\t\t\t\t\t? `${credentials.countryCode} ${credentials.phoneNumber}`\n\t\t\t\t\t: null;\n\t\t\tcase 'EMAIL':\n\t\t\t\treturn credentials.email || null;\n\t\t\tcase 'WHATSAPP':\n\t\t\t\treturn credentials.phoneNumber\n\t\t\t\t\t? `${credentials.countryCode} ${credentials.phoneNumber}`\n\t\t\t\t\t: credentials.email || null;\n\t\t\tcase 'TOTP':\n\t\t\t\treturn 'Authenticator App';\n\t\t\tcase 'FIDO2':\n\t\t\t\treturn 'Security Key / Biometric';\n\t\t\tcase 'MOBILE':\n\t\t\t\treturn 'PingOne Mobile App';\n\t\t\tdefault:\n\t\t\t\treturn null;\n\t\t}\n\t};\n\n\tconst contactInfo = getDeviceContactInfo();\n\n\t/**\n\t * Get device nickname if available\n\t */\n\tconst deviceName = credentials.deviceName || credentials.nickname || `My ${config.displayName}`;\n\n\t// ========================================================================\n\t// RENDER\n\t// ========================================================================\n\n\treturn (\n\t\t<div className=\"unified-success-step\">\n\t\t\t{/* Success Header */}\n\t\t\t<div className=\"success-header\">\n\t\t\t\t<div className=\"success-icon\">\n\t\t\t\t\t<span className=\"icon-large\">{config.icon}</span>\n\t\t\t\t\t<span className=\"checkmark\">‚úì</span>\n\t\t\t\t</div>\n\t\t\t\t<h2 className=\"success-title\">Device Registered Successfully!</h2>\n\t\t\t\t<p className=\"success-subtitle\">\n\t\t\t\t\tYour {config.displayName} device is now active and ready to use for multi-factor\n\t\t\t\t\tauthentication.\n\t\t\t\t</p>\n\t\t\t</div>\n\n\t\t\t{/* Device Details Card */}\n\t\t\t<div className=\"device-details\">\n\t\t\t\t<h3>Device Details</h3>\n\n\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t<span className=\"detail-label\">Device Type:</span>\n\t\t\t\t\t<span className=\"detail-value\">\n\t\t\t\t\t\t{config.icon} {config.displayName}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\n\t\t\t\t{deviceName && (\n\t\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t\t<span className=\"detail-label\">Device Name:</span>\n\t\t\t\t\t\t<span className=\"detail-value\">{deviceName}</span>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{mfaState.deviceId && (\n\t\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t\t<span className=\"detail-label\">Device ID:</span>\n\t\t\t\t\t\t<span className=\"detail-value device-id\">{mfaState.deviceId}</span>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t<span className=\"detail-label\">Status:</span>\n\t\t\t\t\t<span\n\t\t\t\t\t\tclassName={`detail-value status-badge ${\n\t\t\t\t\t\t\tmfaState.deviceStatus === 'ACTIVE' ? 'status-active' : 'status-activation-required'\n\t\t\t\t\t\t}`}\n\t\t\t\t\t>\n\t\t\t\t\t\t{mfaState.deviceStatus || 'ACTIVE'}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\n\t\t\t\t{contactInfo && (\n\t\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t\t<span className=\"detail-label\">Contact:</span>\n\t\t\t\t\t\t<span className=\"detail-value\">{contactInfo}</span>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{credentials.environmentId && (\n\t\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t\t<span className=\"detail-label\">Environment:</span>\n\t\t\t\t\t\t<span className=\"detail-value environment-id\">{credentials.environmentId}</span>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{credentials.username && (\n\t\t\t\t\t<div className=\"detail-row\">\n\t\t\t\t\t\t<span className=\"detail-label\">Username:</span>\n\t\t\t\t\t\t<span className=\"detail-value\">{credentials.username}</span>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\n\t\t\t{/* Next Steps Information */}\n\t\t\t<div className=\"next-steps-info\">\n\t\t\t\t<h4>What's Next?</h4>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>\n\t\t\t\t\t\tYour {config.displayName} device will be used for multi-factor authentication when you\n\t\t\t\t\t\tsign in.\n\t\t\t\t\t</li>\n\t\t\t\t\t{config.deviceType === 'SMS' && (\n\t\t\t\t\t\t<li>You'll receive a one-time code via SMS each time you need to authenticate.</li>\n\t\t\t\t\t)}\n\t\t\t\t\t{config.deviceType === 'EMAIL' && (\n\t\t\t\t\t\t<li>You'll receive a one-time code via email each time you need to authenticate.</li>\n\t\t\t\t\t)}\n\t\t\t\t\t{config.deviceType === 'WHATSAPP' && (\n\t\t\t\t\t\t<li>You'll receive a one-time code via WhatsApp each time you need to authenticate.</li>\n\t\t\t\t\t)}\n\t\t\t\t\t{config.deviceType === 'TOTP' && (\n\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\tOpen your authenticator app and enter the code shown when you need to authenticate.\n\t\t\t\t\t\t</li>\n\t\t\t\t\t)}\n\t\t\t\t\t{config.deviceType === 'FIDO2' && (\n\t\t\t\t\t\t<li>Use your security key or biometric when prompted during authentication.</li>\n\t\t\t\t\t)}\n\t\t\t\t\t{config.deviceType === 'MOBILE' && (\n\t\t\t\t\t\t<li>Approve authentication requests in the PingOne Mobile app when prompted.</li>\n\t\t\t\t\t)}\n\t\t\t\t\t<li>You can register additional devices for backup authentication methods.</li>\n\t\t\t\t</ul>\n\t\t\t</div>\n\n\t\t\t{/* Action Buttons */}\n\t\t\t<div className=\"action-buttons\">\n\t\t\t\t<button type=\"button\" onClick={handleRegisterAnother} className=\"btn-secondary\">\n\t\t\t\t\t‚Üê Register Another Device\n\t\t\t\t</button>\n\n\t\t\t\t<a\n\t\t\t\t\thref=\"https://apidocs.pingidentity.com/pingone/platform/v1/api/\"\n\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\tclassName=\"btn-secondary\"\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tdisplay: 'inline-flex',\n\t\t\t\t\t\talignItems: 'center',\n\t\t\t\t\t\tgap: '8px',\n\t\t\t\t\t\ttextDecoration: 'none',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\tüìö View API Docs\n\t\t\t\t</a>\n\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\tconsole.log(`${MODULE_TAG} User finished registration flow`);\n\t\t\t\t\t\ttoastV8.success('Registration complete!');\n\t\t\t\t\t}}\n\t\t\t\t\tclassName=\"btn-primary\"\n\t\t\t\t>\n\t\t\t\t\tFinish\n\t\t\t\t</button>\n\t\t\t</div>\n\n\t\t\t{/* Token Status Info */}\n\t\t\t{tokenStatus.isValid && (\n\t\t\t\t<div className=\"token-info\" role=\"status\">\n\t\t\t\t\t<small>\n\t\t\t\t\t\t‚úì Worker token is valid and will expire{' '}\n\t\t\t\t\t\t{tokenStatus.expiresAt ? new Date(tokenStatus.expiresAt).toLocaleString() : 'soon'}\n\t\t\t\t\t</small>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n\nexport default UnifiedSuccessStep;\n"},"tags":[],"source":null}],"command":"check"}
