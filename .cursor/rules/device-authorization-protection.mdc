# üõ°Ô∏è Device Authorization Flow Protection

**Status:** CRITICAL - MUST NOT BE BROKEN
**Last Verified:** Current session
**Protection Level:** MAXIMUM

---

## üö® CRITICAL PROTECTION RULES

### File Protection
**DO NOT MODIFY** these files without explicit approval:
- `src/hooks/useDeviceAuthorizationFlow.ts` - Core polling logic and state management
- `src/services/deviceFlowService.tsx` - Device flow service logic
- `src/pages/flows/DeviceAuthorizationFlowV7.tsx` - Main flow component
- `src/components/*DeviceFlow.tsx` - All device display components (Smart TV, Printer, POS, etc.)

### Component Protection
**DO NOT MODIFY** these components without explicit approval:
- `DynamicDeviceFlow` component
- Any `*DeviceFlow.tsx` components
- Token display implementations in device flows
- QR code generation and display

### Service Protection
**DO NOT MODIFY** these services without versioning:
- `deviceFlowService` - Device flow logic
- `deviceTypeService` - Device type configurations
- `UnifiedTokenDisplayService` as used in device flows

---

## ‚úÖ CRITICAL FEATURES THAT MUST WORK

### 1. **Polling Logic** (useDeviceAuthorizationFlow.ts)
- ‚úÖ Polling must stop after 3 consecutive 400 errors
- ‚úÖ Error handling for expired device codes
- ‚úÖ Status transitions: pending ‚Üí polling ‚Üí authorized
- ‚úÖ NO INFINITE LOOPS

### 2. **Device Display Components**
- ‚úÖ All devices must load immediately with realistic appearance
- ‚úÖ QR code must be separate and not greyed out during authorization
- ‚úÖ Device should be greyed out until authorization completes
- ‚úÖ Success message should turn green and be compact after authorization
- ‚úÖ Token display should be independent and full-width

### 3. **Token Display**
- ‚úÖ Use UnifiedTokenDisplayService with proper props
- ‚úÖ Header and payload displayed separately when decoded
- ‚úÖ Independent width (not constrained by device size)
- ‚úÖ In-place decode (replace token with JSON, not add below)

### 4. **RFC 8628 Compliance**
- ‚úÖ Device code format and expiration handling
- ‚úÖ Verification URI and verification URI complete
- ‚úÖ Polling intervals (slow_down handling)
- ‚úÖ Scope and audience validation

---

## üîí CHANGE PROTOCOL

### Allowed Changes
‚úÖ Bug fixes that do not alter existing behavior
‚úÖ UI improvements that maintain functionality
‚úÖ Educational content updates
‚úÖ Styling changes (colors, sizes, layout)
‚úÖ Adding new device types
‚úÖ Documentation improvements

### Prohibited Changes
‚ùå Modifying polling logic without testing all devices
‚ùå Changing error handling behavior
‚ùå Removing or altering safety mechanisms (400 error limits, etc.)
‚ùå Modifying token display without testing all flows
‚ùå Breaking device display initialization
‚ùå Changing device layout structure

### Required Process
1. **Test on ALL device types** before committing
   - Airport Kiosk
   - Smart TV
   - Smart Printer
   - POS Terminal
   - Smart Speaker
   - Gaming Console
   - Fitness Tracker
   - Gas Pump
   - AI Agent
   - MCP Server
   - Mobile Phone
2. **Run through complete flow** (QR code scan ‚Üí authorization ‚Üí tokens)
3. **Verify no regression** in token decoding
4. **Confirm RFC 8628 compliance** maintained

---

## üß™ VERIFICATION CHECKLIST

Before marking any change complete:
- [ ] Can start polling with valid device code
- [ ] Polling stops after 3 consecutive 400 errors
- [ ] All device displays load immediately with realistic appearance
- [ ] QR code is visible and separate from device
- [ ] Device greys out until authorization
- [ ] Success message turns green and is compact
- [ ] Tokens display correctly with independent width
- [ ] Token decode shows header and payload separately
- [ ] "Open on this Device" works for mobile flows
- [ ] Token Management can decode all tokens

---

## ‚ö†Ô∏è EMERGENCY ROLLBACK

If device authorization is broken:
1. Immediately revert changes to protected files
2. Restore from git history
3. Document what broke and why
4. Re-implement with proper testing

---

**Last Approved Change:** Token display improvements (current session)
**Status:** WORKING AS EXPECTED
**Next Review:** Any change request affecting device authorization
